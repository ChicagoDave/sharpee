"use strict";var SharpeeGame=(()=>{var lK=Object.create;var Bb=Object.defineProperty;var uK=Object.getOwnPropertyDescriptor;var mK=Object.getOwnPropertyNames;var pK=Object.getPrototypeOf,fK=Object.prototype.hasOwnProperty;var gK=(t,e,r)=>e in t?Bb(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var p=(t,e)=>()=>(e||t((e={exports:{}}).exports,e),e.exports);var hK=(t,e,r,n)=>{if(e&&typeof e=="object"||typeof e=="function")for(let i of mK(e))!fK.call(t,i)&&i!==r&&Bb(t,i,{get:()=>e[i],enumerable:!(n=uK(e,i))||n.enumerable});return t};var _=(t,e,r)=>(r=t!=null?lK(pK(t)):{},hK(e||!t||!t.__esModule?Bb(r,"default",{value:t,enumerable:!0}):r,t));var l=(t,e,r)=>gK(t,typeof e!="symbol"?e+"":e,r);var mM=p(uM=>{"use strict";Object.defineProperty(uM,"__esModule",{value:!0})});var pM=p(Rd=>{"use strict";Object.defineProperty(Rd,"__esModule",{value:!0});Rd.DEFAULT_NARRATIVE_SETTINGS=void 0;Rd.buildNarrativeSettings=yK;Rd.DEFAULT_NARRATIVE_SETTINGS={perspective:"2nd",tense:"present"};function yK(t){return{...Rd.DEFAULT_NARRATIVE_SETTINGS,...t||{},perspective:t?.perspective||"2nd"}}});var xb=p(Cd=>{"use strict";Object.defineProperty(Cd,"__esModule",{value:!0});Cd.buildNarrativeSettings=Cd.DEFAULT_NARRATIVE_SETTINGS=void 0;var fM=pM();Object.defineProperty(Cd,"DEFAULT_NARRATIVE_SETTINGS",{enumerable:!0,get:function(){return fM.DEFAULT_NARRATIVE_SETTINGS}});Object.defineProperty(Cd,"buildNarrativeSettings",{enumerable:!0,get:function(){return fM.buildNarrativeSettings}})});var gM=p(Ep=>{"use strict";Object.defineProperty(Ep,"__esModule",{value:!0});Ep.EventEmitter=void 0;var jb=class{constructor(){l(this,"handlers",new Map)}on(e,r){let n=this.handlers.get(e)||[];n.push(r),this.handlers.set(e,n)}off(e,r){let n=this.handlers.get(e);if(n){let i=n.indexOf(r);i!==-1&&n.splice(i,1)}}emit(e){let r=[],n=this.handlers.get(e.type)||[];for(let i of n){let o=i(e);o&&r.push(...o)}return r}clear(e){e?this.handlers.delete(e):this.handlers.clear()}listenerCount(e){return this.handlers.get(e)?.length||0}};Ep.EventEmitter=jb});var hM=p(cu=>{"use strict";Object.defineProperty(cu,"__esModule",{value:!0});cu.StoryWithEvents=void 0;cu.validateStoryConfig=EK;var TK=gM(),Wb=class{constructor(e){l(this,"config");l(this,"eventEmitter");this.config=e,this.eventEmitter=new TK.EventEmitter}on(e,r){this.eventEmitter.on(e,r)}off(e,r){this.eventEmitter.off(e,r)}emit(e){return this.eventEmitter.emit(e)}initializeWorld(e){throw new Error("initializeWorld must be implemented")}createPlayer(e){throw new Error("createPlayer must be implemented")}};cu.StoryWithEvents=Wb;function EK(t){if(!t.id||!t.title||!t.author||!t.version)throw new Error("Missing required story configuration fields");if(!/^\d+\.\d+\.\d+(-[a-zA-Z0-9.-]+)?$/.test(t.version))throw new Error("Invalid version format. Must be semantic version (e.g., 1.0.0 or 1.0.0-beta)")}});var du=p(wd=>{"use strict";Object.defineProperty(wd,"__esModule",{value:!0});wd.eventSequencer=wd.EventSequenceUtils=void 0;var Ub=class{constructor(){l(this,"counter",Date.now())}next(){return++this.counter}resetTurn(e){}sequence(e,r){return{...e,sequence:this.next(),timestamp:new Date,turn:r,scope:"turn"}}sequenceAll(e,r){return e.map(n=>this.sequence(n,r))}},Hb=class{static sort(e){return[...e].sort((r,n)=>r.sequence-n.sequence)}static filterByType(e,r){return e.filter(n=>n.type===r)}static filterByTurn(e,r){return e.filter(n=>n.turn===r)}static filterByScope(e,r){return e.filter(n=>n.scope===r)}static groupByType(e){let r={};for(let n of e)r[n.type]||(r[n.type]=[]),r[n.type].push(n);return r}static groupByTurn(e){let r={};for(let n of e)r[n.turn]||(r[n.turn]=[]),r[n.turn].push(n);return r}static getLatestByType(e,r){let n=this.filterByType(e,r);if(n.length!==0)return n.reduce((i,o)=>o.sequence>i.sequence?o:i)}static countByType(e){let r={};for(let n of e)r[n.type]=(r[n.type]||0)+1;return r}static getInRange(e,r,n,i=!0){return i?e.filter(o=>o.sequence>=r&&o.sequence<=n):e.filter(o=>o.sequence>r&&o.sequence<n)}};wd.EventSequenceUtils=Hb;wd.eventSequencer=new Ub});var TM=p(yM=>{"use strict";Object.defineProperty(yM,"__esModule",{value:!0})});var vM=p(EM=>{"use strict";Object.defineProperty(EM,"__esModule",{value:!0})});var bM=p(_M=>{"use strict";Object.defineProperty(_M,"__esModule",{value:!0})});var IM=p(Nd=>{"use strict";Object.defineProperty(Nd,"__esModule",{value:!0});Nd.Result=void 0;Nd.Result={ok(t){return{success:!0,value:t}},fail(t){return{success:!1,error:t}},isOk(t){return t.success},isFail(t){return!t.success},map(t,e){return t.success?Nd.Result.ok(e(t.value)):t},mapError(t,e){return t.success?t:Nd.Result.fail(e(t.error))},flatMap(t,e){return t.success?e(t.value):t},unwrap(t){if(t.success)return t.value;throw t.error},unwrapOr(t,e){return t.success?t.value:e}}});var SM=p(OM=>{"use strict";Object.defineProperty(OM,"__esModule",{value:!0})});var AM=p($n=>{"use strict";var vK=$n&&$n.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),lu=$n&&$n.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&vK(e,t,r)};Object.defineProperty($n,"__esModule",{value:!0});lu(TM(),$n);lu(vM(),$n);lu(bM(),$n);lu(IM(),$n);lu(SM(),$n)});var CM=p(uu=>{"use strict";Object.defineProperty(uu,"__esModule",{value:!0});uu.generateIfid=bK;uu.validateIfid=RM;uu.normalizeIfid=IK;var _K=/^[A-Z0-9-]{8,63}$/;function bK(){return globalThis.crypto.randomUUID().toUpperCase()}function RM(t){return _K.test(t)}function IK(t){let e=t.toUpperCase();return RM(e)?e:null}});var wM=p(Fa=>{"use strict";Object.defineProperty(Fa,"__esModule",{value:!0});Fa.normalizeIfid=Fa.validateIfid=Fa.generateIfid=void 0;var qb=CM();Object.defineProperty(Fa,"generateIfid",{enumerable:!0,get:function(){return qb.generateIfid}});Object.defineProperty(Fa,"validateIfid",{enumerable:!0,get:function(){return qb.validateIfid}});Object.defineProperty(Fa,"normalizeIfid",{enumerable:!0,get:function(){return qb.normalizeIfid}})});var DM=p(NM=>{"use strict";Object.defineProperty(NM,"__esModule",{value:!0})});var MM=p(LM=>{"use strict";Object.defineProperty(LM,"__esModule",{value:!0})});var Gb=p(Va=>{"use strict";Object.defineProperty(Va,"__esModule",{value:!0});Va.EventCategories=Va.StandardEventTags=Va.StandardEventTypes=void 0;Va.StandardEventTypes={ACTION:"action",SYSTEM:"system",NARRATIVE:"narrative",ERROR:"error"};Va.StandardEventTags={SUCCESS:"success",FAILURE:"failure",INFO:"info",WARNING:"warning",ERROR:"error"};Va.EventCategories={ACTION:"action",SYSTEM:"system",NARRATIVE:"narrative"}});var PM=p(Dd=>{"use strict";Object.defineProperty(Dd,"__esModule",{value:!0});Dd.Subsystems=void 0;Dd.createSystemEvent=OK;Dd.isSystemEvent=RK;Dd.Subsystems={PARSER:"parser",VALIDATOR:"validator",EXECUTOR:"executor",WORLD_MODEL:"world-model",TEXT_SERVICE:"text-service",EVENT_PROCESSOR:"event-processor",RULE_ENGINE:"rule-engine"};function OK(t,e,r,n){return{id:AK(),timestamp:Date.now(),subsystem:t,type:e,data:r,...n}}var SK=0;function AK(){return`sys_${Date.now()}_${++SK}`}function RK(t){return typeof t=="object"&&t!==null&&"id"in t&&"timestamp"in t&&"subsystem"in t&&"type"in t&&"data"in t}});var kM=p(J=>{"use strict";Object.defineProperty(J,"__esModule",{value:!0});J.PlatformEventType=void 0;J.isPlatformEvent=Fb;J.isPlatformRequestEvent=CK;J.isPlatformCompletionEvent=wK;J.createPlatformEvent=Lr;J.createSaveRequestedEvent=NK;J.createRestoreRequestedEvent=DK;J.createQuitRequestedEvent=LK;J.createRestartRequestedEvent=MK;J.createSaveCompletedEvent=PK;J.createRestoreCompletedEvent=kK;J.createQuitConfirmedEvent=BK;J.createQuitCancelledEvent=xK;J.createRestartCompletedEvent=jK;J.createUndoRequestedEvent=WK;J.createUndoCompletedEvent=UK;J.createAgainRequestedEvent=HK;J.createAgainFailedEvent=qK;J.PlatformEventType={SAVE_REQUESTED:"platform.save_requested",RESTORE_REQUESTED:"platform.restore_requested",QUIT_REQUESTED:"platform.quit_requested",RESTART_REQUESTED:"platform.restart_requested",UNDO_REQUESTED:"platform.undo_requested",AGAIN_REQUESTED:"platform.again_requested",SAVE_COMPLETED:"platform.save_completed",RESTORE_COMPLETED:"platform.restore_completed",QUIT_CONFIRMED:"platform.quit_confirmed",RESTART_COMPLETED:"platform.restart_completed",UNDO_COMPLETED:"platform.undo_completed",SAVE_FAILED:"platform.save_failed",RESTORE_FAILED:"platform.restore_failed",QUIT_CANCELLED:"platform.quit_cancelled",RESTART_CANCELLED:"platform.restart_cancelled",UNDO_FAILED:"platform.undo_failed",AGAIN_FAILED:"platform.again_failed"};function Fb(t){return"requiresClientAction"in t&&t.requiresClientAction===!0}function CK(t){return Fb(t)&&(t.type===J.PlatformEventType.SAVE_REQUESTED||t.type===J.PlatformEventType.RESTORE_REQUESTED||t.type===J.PlatformEventType.QUIT_REQUESTED||t.type===J.PlatformEventType.RESTART_REQUESTED||t.type===J.PlatformEventType.UNDO_REQUESTED||t.type===J.PlatformEventType.AGAIN_REQUESTED)}function wK(t){return Fb(t)&&(t.type===J.PlatformEventType.SAVE_COMPLETED||t.type===J.PlatformEventType.RESTORE_COMPLETED||t.type===J.PlatformEventType.QUIT_CONFIRMED||t.type===J.PlatformEventType.RESTART_COMPLETED||t.type===J.PlatformEventType.UNDO_COMPLETED||t.type===J.PlatformEventType.SAVE_FAILED||t.type===J.PlatformEventType.RESTORE_FAILED||t.type===J.PlatformEventType.QUIT_CANCELLED||t.type===J.PlatformEventType.RESTART_CANCELLED||t.type===J.PlatformEventType.UNDO_FAILED||t.type===J.PlatformEventType.AGAIN_FAILED)}function Lr(t,e,r){return{id:`platform-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:t,timestamp:Date.now(),requiresClientAction:!0,entities:{},payload:{context:e,...r}}}function NK(t){return Lr(J.PlatformEventType.SAVE_REQUESTED,t)}function DK(t){return Lr(J.PlatformEventType.RESTORE_REQUESTED,t)}function LK(t){return Lr(J.PlatformEventType.QUIT_REQUESTED,t)}function MK(t){return Lr(J.PlatformEventType.RESTART_REQUESTED,t)}function PK(t,e){return Lr(t?J.PlatformEventType.SAVE_COMPLETED:J.PlatformEventType.SAVE_FAILED,void 0,{success:t,error:e})}function kK(t,e){return Lr(t?J.PlatformEventType.RESTORE_COMPLETED:J.PlatformEventType.RESTORE_FAILED,void 0,{success:t,error:e})}function BK(){return Lr(J.PlatformEventType.QUIT_CONFIRMED,void 0,{success:!0})}function xK(){return Lr(J.PlatformEventType.QUIT_CANCELLED,void 0,{success:!1})}function jK(t){return Lr(t?J.PlatformEventType.RESTART_COMPLETED:J.PlatformEventType.RESTART_CANCELLED,void 0,{success:t})}function WK(t){return Lr(J.PlatformEventType.UNDO_REQUESTED,t)}function UK(t,e,r){return Lr(t?J.PlatformEventType.UNDO_COMPLETED:J.PlatformEventType.UNDO_FAILED,void 0,{success:t,restoredToTurn:e,error:r})}function HK(t){return Lr(J.PlatformEventType.AGAIN_REQUESTED,t)}function qK(t){return Lr(J.PlatformEventType.AGAIN_FAILED,void 0,{success:!1,error:t})}});var BM=p(Z=>{"use strict";Object.defineProperty(Z,"__esModule",{value:!0});Z.GameEventType=void 0;Z.isGameEvent=GK;Z.isGameStartSequenceEvent=FK;Z.isGameEndSequenceEvent=VK;Z.createGameEvent=an;Z.createGameInitializingEvent=zK;Z.createGameInitializedEvent=KK;Z.createStoryLoadingEvent=$K;Z.createStoryLoadedEvent=QK;Z.createGameStartingEvent=XK;Z.createGameStartedEvent=ZK;Z.createGameEndingEvent=JK;Z.createGameEndedEvent=e$;Z.createGameWonEvent=t$;Z.createGameLostEvent=r$;Z.createGameQuitEvent=n$;Z.createGameAbortedEvent=i$;Z.isGameStartedEvent=o$;Z.isGameEndedEvent=a$;Z.isGameWonEvent=s$;Z.isGameLostEvent=c$;Z.isGameQuitEvent=d$;Z.isGameAbortedEvent=l$;Z.GameEventType={GAME_INITIALIZING:"game.initializing",GAME_INITIALIZED:"game.initialized",STORY_LOADING:"game.story_loading",STORY_LOADED:"game.story_loaded",GAME_STARTING:"game.starting",GAME_STARTED:"game.started",GAME_ENDING:"game.ending",GAME_ENDED:"game.ended",GAME_WON:"game.won",GAME_LOST:"game.lost",GAME_QUIT:"game.quit",GAME_ABORTED:"game.aborted",SESSION_SAVING:"game.session_saving",SESSION_SAVED:"game.session_saved",SESSION_RESTORING:"game.session_restoring",SESSION_RESTORED:"game.session_restored",INITIALIZATION_FAILED:"game.initialization_failed",STORY_LOAD_FAILED:"game.story_load_failed",FATAL_ERROR:"game.fatal_error"};function GK(t){return Object.values(Z.GameEventType).includes(t.type)}function FK(t){return t.type===Z.GameEventType.GAME_INITIALIZING||t.type===Z.GameEventType.GAME_INITIALIZED||t.type===Z.GameEventType.STORY_LOADING||t.type===Z.GameEventType.STORY_LOADED||t.type===Z.GameEventType.GAME_STARTING||t.type===Z.GameEventType.GAME_STARTED}function VK(t){return t.type===Z.GameEventType.GAME_ENDING||t.type===Z.GameEventType.GAME_ENDED||t.type===Z.GameEventType.GAME_WON||t.type===Z.GameEventType.GAME_LOST||t.type===Z.GameEventType.GAME_QUIT||t.type===Z.GameEventType.GAME_ABORTED}function YK(){return`game-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function an(t,e){return{id:YK(),type:t,timestamp:Date.now(),entities:{},data:e||{}}}function zK(){return an(Z.GameEventType.GAME_INITIALIZING,{gameState:"initializing"})}function KK(){return an(Z.GameEventType.GAME_INITIALIZED,{gameState:"ready"})}function $K(t){return an(Z.GameEventType.STORY_LOADING,{story:{id:t}})}function QK(t){return an(Z.GameEventType.STORY_LOADED,{story:t,gameState:"ready"})}function XK(t){return an(Z.GameEventType.GAME_STARTING,{story:t,gameState:"ready"})}function ZK(t,e,r,n){return an(Z.GameEventType.GAME_STARTED,{story:t,engineVersion:r,clientVersion:n,gameState:"running",session:{startTime:e||Date.now(),turns:0,moves:0}})}function JK(t,e){return an(Z.GameEventType.GAME_ENDING,{gameState:"ending",session:e,ending:{reason:t}})}function e$(t,e,r){return an(Z.GameEventType.GAME_ENDED,{gameState:"ended",session:{...e,endTime:Date.now()},ending:{...r,type:t}})}function t$(t,e){return an(Z.GameEventType.GAME_WON,{gameState:"ended",session:{...t,endTime:Date.now()},ending:{...e,type:"victory"}})}function r$(t,e){return an(Z.GameEventType.GAME_LOST,{gameState:"ended",session:{...e,endTime:Date.now()},ending:{type:"defeat",reason:t}})}function n$(t){return an(Z.GameEventType.GAME_QUIT,{gameState:"ended",session:{...t,endTime:Date.now()},ending:{type:"quit",reason:"Player quit"}})}function i$(t,e){return an(Z.GameEventType.GAME_ABORTED,{gameState:"ended",session:{...e,endTime:Date.now()},ending:{type:"abort",reason:t},error:{message:t}})}function o$(t){return t.type===Z.GameEventType.GAME_STARTED}function a$(t){return t.type===Z.GameEventType.GAME_ENDED}function s$(t){return t.type===Z.GameEventType.GAME_WON}function c$(t){return t.type===Z.GameEventType.GAME_LOST}function d$(t){return t.type===Z.GameEventType.GAME_QUIT}function l$(t){return t.type===Z.GameEventType.GAME_ABORTED}});var jM=p(xM=>{"use strict";Object.defineProperty(xM,"__esModule",{value:!0})});var WM=p(Vb=>{"use strict";Object.defineProperty(Vb,"__esModule",{value:!0});Vb.isKnownEvent=u$;function u$(t){return t.type in{}}});var HM=p(Ld=>{"use strict";Object.defineProperty(Ld,"__esModule",{value:!0});Ld.createTypedEvent=Yb;Ld.createMessageEvent=m$;Ld.createEmptyEvent=p$;Ld.resetEventCounter=f$;var UM=0;function Yb(t,e,r={}){return{id:r.id??`evt-${Date.now()}-${++UM}`,type:t,timestamp:Date.now(),data:e,entities:r.entities??{},tags:r.tags,priority:r.priority,narrate:r.narrate}}function m$(t,e,r,n){let i=`message.${t}`;return Yb(i,{messageId:e,params:r},n)}function p$(t,e){return Yb(t,{},e)}function f$(){UM=0}});var qM=p(Ao=>{"use strict";Object.defineProperty(Ao,"__esModule",{value:!0});Ao.isEventType=g$;Ao.hasEventPrefix=h$;Ao.getEventData=y$;Ao.getEventDataWithDefaults=T$;Ao.requireEventData=E$;Ao.getEventProperty=v$;Ao.getUntypedEventData=_$;function g$(t,e){return t.type===e}function h$(t,e){return t.type.startsWith(e)}function y$(t,e){if(t.type===e)return t.data}function T$(t,e,r){return t.type===e&&t.data?{...r,...t.data}:r}function E$(t,e){if(t.type!==e)throw new Error(`Expected event type '${e}', got '${t.type}'`);return t.data}function v$(t,e,r){if(t.type===e&&t.data)return t.data[r]}function _$(t){return t.data&&typeof t.data=="object"?t.data:{}}});var zb=p(mu=>{"use strict";Object.defineProperty(mu,"__esModule",{value:!0});mu.SimpleEventSource=void 0;mu.createEventSource=b$;var vp=class{constructor(){l(this,"handlers",[])}emit(e){[...this.handlers].forEach(n=>{try{n(e)}catch(i){console.error("Error in event handler:",i)}})}subscribe(e){return this.handlers.push(e),()=>{let r=this.handlers.indexOf(e);r>-1&&this.handlers.splice(r,1)}}get subscriberCount(){return this.handlers.length}clear(){this.handlers=[]}};mu.SimpleEventSource=vp;function b$(){return new vp}});var bp=p(Md=>{"use strict";Object.defineProperty(Md,"__esModule",{value:!0});Md.SemanticEventSourceImpl=void 0;Md.createSemanticEventSource=GM;Md.createEventSource=O$;var I$=zb(),_p=class extends I$.SimpleEventSource{constructor(){super();l(this,"events",[]);l(this,"eventEmitter");l(this,"lastProcessedIndex",0);this.eventEmitter=new Kb,this.subscribe(r=>{this.eventEmitter.emit(r)})}addEvent(r){this.events.push(r),this.emit(r)}getAllEvents(){return[...this.events]}getEventsByType(r){return this.events.filter(n=>n.type===r)}getEventsByEntity(r){return this.events.filter(n=>{let i=n.entities;return i.actor===r||i.target===r||i.instrument===r||i.location===r||i.others&&i.others.includes(r)})}getEventsByTag(r){return this.events.filter(n=>n.tags&&n.tags.includes(r))}filter(r){return this.events.filter(r)}clearEvents(){this.events=[]}getEmitter(){return this.eventEmitter}getEventsSince(r){if(!r)return this.getAllEvents();let n=this.events.findIndex(i=>i.id===r);return n===-1?this.getAllEvents():this.events.slice(n+1)}getUnprocessedEvents(){let r=this.events.slice(this.lastProcessedIndex);return this.lastProcessedIndex=this.events.length,r}};Md.SemanticEventSourceImpl=_p;var Kb=class{constructor(){l(this,"listeners",new Map);l(this,"globalListeners",new Set)}on(e,r){if(e==="*"){this.globalListeners.add(r);return}this.listeners.has(e)||this.listeners.set(e,new Set),this.listeners.get(e).add(r)}off(e,r){if(e==="*"){this.globalListeners.delete(r);return}let n=this.listeners.get(e);n&&(n.delete(r),n.size===0&&this.listeners.delete(e))}emit(e){let r=this.listeners.get(e.type);if(r)for(let n of r)try{n(e)}catch(i){console.error(`Error in event listener for ${e.type}:`,i)}for(let n of this.globalListeners)try{n(e)}catch(i){console.error("Error in global event listener:",i)}}};function GM(){return new _p}function O$(){return GM()}});var Qb=p(Pd=>{"use strict";Object.defineProperty(Pd,"__esModule",{value:!0});Pd.EventSourceImpl=void 0;Pd.createEvent=A$;Pd.createEventSource=w$;var S$=bp();function A$(t,e,r,n){let i=n?.tags||[],o=n?.priority??0,a=n?.narrate??!0,s=n?{...n}:void 0;s&&(delete s.tags,delete s.priority,delete s.narrate);let c={id:C$(),type:t,timestamp:Date.now(),entities:r||{},data:e||{},tags:i,priority:o,narrate:a};return s&&Object.keys(s).length>0&&(c.metadata=s),c}var R$=bp();Object.defineProperty(Pd,"EventSourceImpl",{enumerable:!0,get:function(){return R$.SemanticEventSourceImpl}});var $b=0;function C$(){$b=($b+1)%1e4;let e=Math.floor(Math.random()*1e3)+$b*1e3;return`evt_${Date.now()}_${e}`}function w$(){return(0,S$.createSemanticEventSource)()}});var Zb=p(xe=>{"use strict";var N$=xe&&xe.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),Ro=xe&&xe.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&N$(e,t,r)};Object.defineProperty(xe,"__esModule",{value:!0});xe.createEventSource=xe.EventSourceImpl=xe.createEvent=xe.createSemanticEventSource=xe.SemanticEventSourceImpl=xe.createGenericEventSource=xe.SimpleEventSource=void 0;Ro(MM(),xe);Ro(Gb(),xe);Ro(PM(),xe);Ro(kM(),xe);Ro(BM(),xe);Ro(jM(),xe);Ro(WM(),xe);Ro(HM(),xe);Ro(qM(),xe);var FM=zb();Object.defineProperty(xe,"SimpleEventSource",{enumerable:!0,get:function(){return FM.SimpleEventSource}});Object.defineProperty(xe,"createGenericEventSource",{enumerable:!0,get:function(){return FM.createEventSource}});var VM=bp();Object.defineProperty(xe,"SemanticEventSourceImpl",{enumerable:!0,get:function(){return VM.SemanticEventSourceImpl}});Object.defineProperty(xe,"createSemanticEventSource",{enumerable:!0,get:function(){return VM.createSemanticEventSource}});var Xb=Qb();Object.defineProperty(xe,"createEvent",{enumerable:!0,get:function(){return Xb.createEvent}});Object.defineProperty(xe,"EventSourceImpl",{enumerable:!0,get:function(){return Xb.EventSourceImpl}});Object.defineProperty(xe,"createEventSource",{enumerable:!0,get:function(){return Xb.createEventSource}})});var zM=p(Ip=>{"use strict";Object.defineProperty(Ip,"__esModule",{value:!0});Ip.ExtensionType=void 0;var YM;(function(t){t.COMMAND="command",t.ABILITY="ability",t.EVENT="event",t.PARSER="parser"})(YM||(Ip.ExtensionType=YM={}))});var $M=p(KM=>{"use strict";Object.defineProperty(KM,"__esModule",{value:!0})});var Sp=p(pu=>{"use strict";Object.defineProperty(pu,"__esModule",{value:!0});pu.SimpleRuleSystemImpl=void 0;pu.createSimpleRuleSystem=D$;var QM=Qb(),XM=Gb(),Op=class{constructor(){l(this,"rules",new Map)}addRule(e){this.rules.set(e.id,e)}removeRule(e){this.rules.delete(e)}getRules(){return Array.from(this.rules.values())}processEvent(e,r){let n=this.getMatchingRules(e);n.sort((c,d)=>(d.priority||0)-(c.priority||0));let i=!1,o,a=[],s=[];for(let c of n){if(c.condition&&!c.condition(e,r))continue;let d;try{d=c.action(e,r)}catch(u){console.error(`Error executing rule ${c.id}:`,u);continue}if(d.prevent&&!i){i=!0,o=d.message,d.message&&a.push((0,QM.createEvent)(XM.StandardEventTypes.NARRATIVE,{message:d.message},{actor:e.entities.actor,location:e.entities.location}));break}d.events&&a.push(...d.events),d.message&&!d.prevent&&(o||(o=d.message),a.push((0,QM.createEvent)(XM.StandardEventTypes.NARRATIVE,{message:d.message},{actor:e.entities.actor,location:e.entities.location}))),d.changes&&s.push(...d.changes)}for(let c of s)r.getEntity(c.entityId)&&r.updateEntity(c.entityId,{[c.attribute]:c.value});return{prevent:i,message:o,events:a,changes:s}}getMatchingRules(e){return Array.from(this.rules.values()).filter(r=>{if(r.eventType==="*")return!0;if(r.eventType.endsWith(":*")){let n=r.eventType.split(":")[0];return e.type.startsWith(`${n}:`)}return r.eventType===e.type})}};pu.SimpleRuleSystemImpl=Op;function D$(){return new Op}});var eP=p(sn=>{"use strict";Object.defineProperty(sn,"__esModule",{value:!0});sn.getTargetItem=eI;sn.getActor=L$;sn.entityIs=ZM;sn.getAttribute=Jb;sn.hasAbility=JM;sn.giveAbility=M$;sn.removeAbility=P$;sn.setAttribute=k$;sn.itemTooHeavy=B$;sn.isTaking=x$;sn.playerHasAbility=j$;function eI(t,e){let r=t.entities.target||t.data?.itemId;if(typeof r=="string")return e.getEntity(r)}function L$(t,e){let r=t.entities.actor;return r?e.getEntity(r):void 0}function ZM(t,e){return t?.id===e||t?.attributes?.name===e}function Jb(t,e){return t?.attributes?.[e]}function JM(t,e){return t?.attributes?.[`ability_${e}`]===!0}function M$(t,e){return{entityId:t,attribute:`ability_${e}`,value:!0}}function P$(t,e){return{entityId:t,attribute:`ability_${e}`,value:void 0}}function k$(t,e,r){return{entityId:t,attribute:e,value:r}}function B$(t,e){let r=eI(t,e),n=e.getPlayer(),i=Jb(r,"weight")||0,o=Jb(n,"strength")||10;return i>o}function x$(t){return(e,r)=>{let n=eI(e,r);return ZM(n,t)}}function j$(t){return(e,r)=>{let n=r.getPlayer();return JM(n,t)}}});var tI=p(fu=>{"use strict";Object.defineProperty(fu,"__esModule",{value:!0});fu.SimpleRuleWorldAdapter=void 0;fu.createSimpleRuleWorld=W$;var Ap=class{constructor(e,r="player",n){l(this,"worldState");l(this,"playerId");l(this,"currentLocationId");this.worldState=e,this.playerId=r,this.currentLocationId=n}getEntity(e){return this.worldState.entities?.[e]||this.worldState[e]}updateEntity(e,r){let n=this.getEntity(e);n&&(n.attributes?Object.assign(n.attributes,r):Object.assign(n,r))}getPlayer(){return this.getEntity(this.playerId)}getCurrentLocation(){return this.currentLocationId?this.getEntity(this.currentLocationId):void 0}setPlayerId(e){this.playerId=e}setCurrentLocationId(e){this.currentLocationId=e}};fu.SimpleRuleWorldAdapter=Ap;function W$(t,e="player",r){return new Ap(t,e,r)}});var rI=p(gu=>{"use strict";Object.defineProperty(gu,"__esModule",{value:!0});gu.RuleSystemAdapter=void 0;gu.createRuleSystem=q$;var U$=Sp(),Rp=class{constructor(e){l(this,"simpleRuleSystem");this.simpleRuleSystem=e}processEvent(e,r){let n=H$(r),i=this.simpleRuleSystem.processEvent(e,n);return{prevented:i.prevent||!1,preventMessage:i.message,events:i.events||[],context:r}}};gu.RuleSystemAdapter=Rp;function H$(t){return{getEntity:e=>t.getEntity(e),updateEntity:(e,r)=>{let n=t.getEntity(e);n&&(n.attributes?Object.assign(n.attributes,r):Object.assign(n,r))},getPlayer:()=>t.player,getCurrentLocation:()=>t.currentLocation}}function q$(){let t=new U$.SimpleRuleSystemImpl;return new Rp(t)}});var tP=p(xt=>{"use strict";var G$=xt&&xt.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),hu=xt&&xt.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&G$(e,t,r)};Object.defineProperty(xt,"__esModule",{value:!0});xt.createRuleSystem=xt.createSimpleRuleWorld=xt.createSimpleRuleSystem=void 0;hu($M(),xt);hu(Sp(),xt);hu(eP(),xt);hu(tI(),xt);hu(rI(),xt);var F$=Sp();Object.defineProperty(xt,"createSimpleRuleSystem",{enumerable:!0,get:function(){return F$.createSimpleRuleSystem}});var V$=tI();Object.defineProperty(xt,"createSimpleRuleWorld",{enumerable:!0,get:function(){return V$.createSimpleRuleWorld}});var Y$=rI();Object.defineProperty(xt,"createRuleSystem",{enumerable:!0,get:function(){return Y$.createRuleSystem}})});var rP=p(Cp=>{"use strict";Object.defineProperty(Cp,"__esModule",{value:!0});Cp.DebugEventTypes=void 0;Cp.DebugEventTypes={parser:{TOKEN_ANALYSIS:"token_analysis",PATTERN_MATCH:"pattern_match",CANDIDATE_SCORING:"candidate_scoring"},validator:{ENTITY_RESOLUTION:"entity_resolution",SCOPE_CHECK:"scope_check",AMBIGUITY_RESOLUTION:"ambiguity_resolution",VALIDATION_ERROR:"validation_error"},executor:{ACTION_START:"action_start",ACTION_COMPLETE:"action_complete",ACTION_ERROR:"action_error"},worldModel:{ENTITY_CHANGE:"entity_change",RELATION_CHANGE:"relation_change",PROPERTY_CHANGE:"property_change"},textService:{TEMPLATE_SELECTION:"template_selection",TEXT_GENERATION:"text_generation",CHANNEL_ROUTING:"channel_routing"}}});var nP=p(cc=>{"use strict";var z$=cc&&cc.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),K$=cc&&cc.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&z$(e,t,r)};Object.defineProperty(cc,"__esModule",{value:!0});K$(rP(),cc)});var nI=p(Ya=>{"use strict";Object.defineProperty(Ya,"__esModule",{value:!0});Ya.StandardValidators=Ya.QueryType=Ya.QuerySource=void 0;var iP;(function(t){t.SYSTEM="system",t.DISAMBIGUATION="disambiguation",t.NPC="npc",t.GAME_MECHANIC="mechanic",t.NARRATIVE="narrative"})(iP||(Ya.QuerySource=iP={}));var oP;(function(t){t.YES_NO="yes_no",t.MULTIPLE_CHOICE="multiple_choice",t.FREE_TEXT="free_text",t.NUMERIC="numeric",t.DISAMBIGUATION="disambiguation"})(oP||(Ya.QueryType=oP={}));Ya.StandardValidators={yesNo:t=>{let e=t.toLowerCase().trim(),r=["yes","y","yeah","yep","sure","ok","okay"],n=["no","n","nope","nah","cancel"];return r.includes(e)?{valid:!0,normalized:!0}:n.includes(e)?{valid:!0,normalized:!1}:{valid:!1,message:"Please answer yes or no.",hint:"You can also use y/n"}},numeric:(t,e,r)=>{let n=parseInt(t.trim(),10);return isNaN(n)?{valid:!1,message:"Please enter a number."}:e!==void 0&&n<e?{valid:!1,message:`Please enter a number at least ${e}.`}:r!==void 0&&n>r?{valid:!1,message:`Please enter a number no more than ${r}.`}:{valid:!0,normalized:n}},multipleChoice:(t,e)=>{let r=t.trim(),n=parseInt(r,10);if(!isNaN(n)&&n>=1&&n<=e.length)return{valid:!0,normalized:n-1};let i=e.findIndex(o=>o.toLowerCase().includes(r.toLowerCase())||r.toLowerCase().includes(o.toLowerCase()));return i>=0?{valid:!0,normalized:i}:{valid:!1,message:`Please choose a number 1-${e.length} or type part of an option.`}}}});var sP=p((Due,iI)=>{"use strict";var $$=Object.prototype.hasOwnProperty,ir="~";function yu(){}Object.create&&(yu.prototype=Object.create(null),new yu().__proto__||(ir=!1));function Q$(t,e,r){this.fn=t,this.context=e,this.once=r||!1}function aP(t,e,r,n,i){if(typeof r!="function")throw new TypeError("The listener must be a function");var o=new Q$(r,n||t,i),a=ir?ir+e:e;return t._events[a]?t._events[a].fn?t._events[a]=[t._events[a],o]:t._events[a].push(o):(t._events[a]=o,t._eventsCount++),t}function wp(t,e){--t._eventsCount===0?t._events=new yu:delete t._events[e]}function Yt(){this._events=new yu,this._eventsCount=0}Yt.prototype.eventNames=function(){var e=[],r,n;if(this._eventsCount===0)return e;for(n in r=this._events)$$.call(r,n)&&e.push(ir?n.slice(1):n);return Object.getOwnPropertySymbols?e.concat(Object.getOwnPropertySymbols(r)):e};Yt.prototype.listeners=function(e){var r=ir?ir+e:e,n=this._events[r];if(!n)return[];if(n.fn)return[n.fn];for(var i=0,o=n.length,a=new Array(o);i<o;i++)a[i]=n[i].fn;return a};Yt.prototype.listenerCount=function(e){var r=ir?ir+e:e,n=this._events[r];return n?n.fn?1:n.length:0};Yt.prototype.emit=function(e,r,n,i,o,a){var s=ir?ir+e:e;if(!this._events[s])return!1;var c=this._events[s],d=arguments.length,u,m;if(c.fn){switch(c.once&&this.removeListener(e,c.fn,void 0,!0),d){case 1:return c.fn.call(c.context),!0;case 2:return c.fn.call(c.context,r),!0;case 3:return c.fn.call(c.context,r,n),!0;case 4:return c.fn.call(c.context,r,n,i),!0;case 5:return c.fn.call(c.context,r,n,i,o),!0;case 6:return c.fn.call(c.context,r,n,i,o,a),!0}for(m=1,u=new Array(d-1);m<d;m++)u[m-1]=arguments[m];c.fn.apply(c.context,u)}else{var f=c.length,g;for(m=0;m<f;m++)switch(c[m].once&&this.removeListener(e,c[m].fn,void 0,!0),d){case 1:c[m].fn.call(c[m].context);break;case 2:c[m].fn.call(c[m].context,r);break;case 3:c[m].fn.call(c[m].context,r,n);break;case 4:c[m].fn.call(c[m].context,r,n,i);break;default:if(!u)for(g=1,u=new Array(d-1);g<d;g++)u[g-1]=arguments[g];c[m].fn.apply(c[m].context,u)}}return!0};Yt.prototype.on=function(e,r,n){return aP(this,e,r,n,!1)};Yt.prototype.once=function(e,r,n){return aP(this,e,r,n,!0)};Yt.prototype.removeListener=function(e,r,n,i){var o=ir?ir+e:e;if(!this._events[o])return this;if(!r)return wp(this,o),this;var a=this._events[o];if(a.fn)a.fn===r&&(!i||a.once)&&(!n||a.context===n)&&wp(this,o);else{for(var s=0,c=[],d=a.length;s<d;s++)(a[s].fn!==r||i&&!a[s].once||n&&a[s].context!==n)&&c.push(a[s]);c.length?this._events[o]=c.length===1?c[0]:c:wp(this,o)}return this};Yt.prototype.removeAllListeners=function(e){var r;return e?(r=ir?ir+e:e,this._events[r]&&wp(this,r)):(this._events=new yu,this._eventsCount=0),this};Yt.prototype.off=Yt.prototype.removeListener;Yt.prototype.addListener=Yt.prototype.on;Yt.prefixed=ir;Yt.EventEmitter=Yt;typeof iI<"u"&&(iI.exports=Yt)});var cP=p(za=>{"use strict";var X$=za&&za.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(za,"__esModule",{value:!0});za.QueryManager=void 0;za.createQueryManager=e5;za.isQueryEvent=t5;var Z$=X$(sP()),oI=nI(),J$=Zb(),Np=class extends Z$.default{constructor(){super();l(this,"state",{queryStack:[],history:[],interceptingInput:!1});l(this,"handlers",new Map);l(this,"validators",new Map);l(this,"timeouts",new Map);l(this,"eventSource",(0,J$.createSemanticEventSource)());this.registerValidator("yes_no",oI.StandardValidators.yesNo),this.registerValidator("numeric",(r,n)=>{let i=n.context.min,o=n.context.max;return oI.StandardValidators.numeric(r,i,o)}),this.registerValidator("multiple_choice",(r,n)=>oI.StandardValidators.multipleChoice(r,n.options||[]))}registerHandler(r,n){this.handlers.set(r,n)}registerValidator(r,n){this.validators.set(r,n)}async askQuery(r){if(this.state.pendingQuery)if(r.priority&&r.priority>(this.state.pendingQuery.priority||0))this.state.queryStack.unshift(this.state.pendingQuery),this.state.pendingQuery=r;else return this.state.queryStack.push(r),null;else this.state.pendingQuery=r;if(this.state.interceptingInput=!0,this.emit("query:pending",r),r.timeout){let n=setTimeout(()=>{this.handleTimeout(r)},r.timeout);this.timeouts.set(r.id,n)}return new Promise(n=>{let i=(s,c)=>{c.id===r.id&&(this.off("query:answered",i),this.off("query:timeout",o),this.off("query:cancelled",a),n(s))},o=s=>{s.id===r.id&&(this.off("query:answered",i),this.off("query:timeout",o),this.off("query:cancelled",a),n(null))},a=s=>{s.id===r.id&&(this.off("query:answered",i),this.off("query:timeout",o),this.off("query:cancelled",a),n(null))};this.on("query:answered",i),this.on("query:timeout",o),this.on("query:cancelled",a)})}processInput(r){if(!this.state.pendingQuery||!this.state.interceptingInput)return"pass";let n=this.state.pendingQuery;if(this.looksLikeCommand(r)&&n.allowInterruption)return this.interruptQuery(n,r),"interrupt";let i={valid:!0,normalized:r};if(n.validator){let c=this.validators.get(n.validator);c&&(i=c(r,n))}else if(n.type==="multiple_choice"&&n.options){let c=r.trim().toLowerCase(),d=parseInt(c,10)-1;!isNaN(d)&&d>=0&&d<n.options.length?i={valid:!0,normalized:d}:n.options.some(u=>u.toLowerCase()===c)?i={valid:!0,normalized:c}:i={valid:!1,message:`Please select one of the available options: ${n.options.join(", ")}`,hint:"You can enter the option number or text"}}if(!i.valid){this.emit("query:invalid",r,i,n);let c={queryId:n.id,input:r,message:i.message||"Invalid response",hint:i.hint},d={id:`evt_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:"query.invalid",timestamp:Date.now(),entities:{},data:c};return this.eventSource.emit(d),"handled"}let o={queryId:n.id,rawInput:r,response:i.normalized||r,selectedIndex:typeof i.normalized=="number"?i.normalized:void 0,wasInterrupted:!1,timestamp:Date.now()},a=this.timeouts.get(n.id);if(a&&(clearTimeout(a),this.timeouts.delete(n.id)),this.state.history.push({query:n,response:o,result:"answered"}),this.state.pendingQuery=void 0,this.state.queryStack.length>0){let c=this.state.queryStack.shift();this.state.pendingQuery=c,this.emit("query:pending",c)}else this.state.interceptingInput=!1;this.emit("query:answered",o,n);let s=this.findHandler(n);return s&&s.handleResponse(o,n),"handled"}cancelCurrentQuery(){if(!this.state.pendingQuery)return;let r=this.state.pendingQuery,n=this.timeouts.get(r.id);if(n&&(clearTimeout(n),this.timeouts.delete(r.id)),this.state.history.push({query:r,result:"cancelled"}),this.state.pendingQuery=void 0,this.state.queryStack.length>0){let o=this.state.queryStack.shift();this.state.pendingQuery=o,this.emit("query:pending",o)}else this.state.interceptingInput=!1;this.emit("query:cancelled",r);let i=this.findHandler(r);i&&i.handleCancel&&i.handleCancel(r)}getState(){return{...this.state}}getEventSource(){return this.eventSource}hasPendingQuery(){return!!this.state.pendingQuery}getCurrentQuery(){return this.state.pendingQuery}clearAll(){this.state.pendingQuery&&this.cancelCurrentQuery(),this.state.queryStack=[],this.state.interceptingInput=!1;for(let[,r]of this.timeouts)clearTimeout(r);this.timeouts.clear()}handleTimeout(r){if(this.state.pendingQuery?.id!==r.id)return;if(this.state.history.push({query:r,result:"timeout"}),this.state.pendingQuery=void 0,this.timeouts.delete(r.id),this.state.queryStack.length>0){let i=this.state.queryStack.shift();this.state.pendingQuery=i,this.emit("query:pending",i)}else this.state.interceptingInput=!1;this.emit("query:timeout",r);let n=this.findHandler(r);n&&n.handleTimeout&&n.handleTimeout(r)}interruptQuery(r,n){let i=this.timeouts.get(r.id);i&&(clearTimeout(i),this.timeouts.delete(r.id)),this.state.history.push({query:r,result:"cancelled"}),this.state.pendingQuery=void 0,this.state.interceptingInput=!1,this.emit("query:interrupted",r,n)}findHandler(r){for(let[,n]of this.handlers)if(n.canHandle(r))return n}looksLikeCommand(r){return[/^(look|take|drop|go|examine|inventory|save|load|help)/i,/^(n|s|e|w|ne|nw|se|sw|up|down|in|out)$/i,/^x\s+/i,/^g\s+/i,/^l$/i].some(i=>i.test(r.trim()))}};za.QueryManager=Np;function e5(){return new Np}function t5(t,e){return t===e}});var lP=p(Ka=>{"use strict";var r5=Ka&&Ka.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),dP=Ka&&Ka.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&r5(e,t,r)};Object.defineProperty(Ka,"__esModule",{value:!0});dP(nI(),Ka);dP(cP(),Ka)});var uP=p(aI=>{"use strict";Object.defineProperty(aI,"__esModule",{value:!0});aI.createSeededRandom=n5;function n5(t){let e=t??Date.now(),r=1103515245,n=12345,i=2**31;function o(){return e=(r*e+n)%i,e/i}function a(f,g){return Math.floor(o()*(g-f+1))+f}function s(f){return o()<f}function c(f){if(f.length===0)throw new Error("Cannot pick from empty array");return f[a(0,f.length-1)]}function d(f){let g=[...f];for(let h=g.length-1;h>0;h--){let y=a(0,h);[g[h],g[y]]=[g[y],g[h]]}return g}function u(){return e}function m(f){e=f}return{next:o,int:a,chance:s,pick:c,shuffle:d,getSeed:u,setSeed:m}}});var mP=p(Dp=>{"use strict";Object.defineProperty(Dp,"__esModule",{value:!0});Dp.createSeededRandom=void 0;var i5=uP();Object.defineProperty(Dp,"createSeededRandom",{enumerable:!0,get:function(){return i5.createSeededRandom}})});var Ve=p(or=>{"use strict";var o5=or&&or.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),Co=or&&or.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&o5(e,t,r)};Object.defineProperty(or,"__esModule",{value:!0});Co(AM(),or);Co(wM(),or);Co(DM(),or);Co(Zb(),or);Co(zM(),or);Co(tP(),or);Co(nP(),or);Co(lP(),or);Co(mP(),or)});var Tu=p(kd=>{"use strict";Object.defineProperty(kd,"__esModule",{value:!0});kd.isEngineAwareParser=a5;kd.hasWorldContext=s5;kd.hasPronounContext=c5;kd.hasPlatformEventEmitter=d5;function a5(t){return"setWorldContext"in t||"setPlatformEventEmitter"in t||"updatePronounContext"in t||"resetPronounContext"in t}function s5(t){return"setWorldContext"in t&&typeof t.setWorldContext=="function"}function c5(t){return"updatePronounContext"in t&&"resetPronounContext"in t&&typeof t.updatePronounContext=="function"&&typeof t.resetPronounContext=="function"}function d5(t){return"setPlatformEventEmitter"in t&&typeof t.setPlatformEventEmitter=="function"}});var Mp=p(Lp=>{"use strict";Object.defineProperty(Lp,"__esModule",{value:!0});Lp.SharedDataKeys=void 0;Lp.SharedDataKeys={INFERENCE_PERFORMED:"inferencePerformed",ORIGINAL_TARGET:"originalTarget",INFERRED_TARGET:"inferredTarget",IMPLICIT_TAKE_EVENTS:"implicitTakeEvents",VALIDATION_RESULT:"validationResult"}});var sI=p($a=>{"use strict";Object.defineProperty($a,"__esModule",{value:!0});$a.EventTypes=$a.MessageNamespaces=$a.ScopeErrors=void 0;$a.ScopeErrors={NOT_KNOWN:"scope.not_known",NOT_VISIBLE:"scope.not_visible",NOT_REACHABLE:"scope.not_reachable",NOT_CARRIED:"scope.not_carried",OUT_OF_SCOPE:"scope.out_of_scope"};$a.MessageNamespaces={SYSTEM:"if.system",ACTION:"if.action",ERROR:"if.error",GAME:"if.game",STORY:"story",EXTENSION:"ext"};$a.EventTypes={TEXT:"text",ACTION_SUCCESS:"action.success",ACTION_ERROR:"action.error",ACTION_FAILED:"action.failed",GAME_MESSAGE:"game.message",SYSTEM_MESSAGE:"system.message"}});var cI=p(Eu=>{"use strict";Object.defineProperty(Eu,"__esModule",{value:!0});Eu.TraitRegistry=void 0;Eu.isTrait=l5;function l5(t){return t&&typeof t=="object"&&"type"in t&&typeof t.type=="string"}var Pp=class{static register(e){if(this.traits.has(e.type))throw new Error(`Trait type '${e.type}' is already registered`);this.traits.set(e.type,e)}static get(e){return this.traits.get(e)}static has(e){return this.traits.has(e)}static clear(){this.traits.clear()}static getAll(){return new Map(this.traits)}};l(Pp,"traits",new Map);Eu.TraitRegistry=Pp});var ee=p(B=>{"use strict";Object.defineProperty(B,"__esModule",{value:!0});B.TRAIT_CATEGORIES=B.TraitCategory=B.TraitType=void 0;B.isValidTraitType=u5;B.getTraitCategory=m5;B.getTraitsByCategory=p5;B.getAllTraitTypes=f5;B.registerTraitType=g5;B.TraitType={IDENTITY:"identity",CONTAINER:"container",SUPPORTER:"supporter",ROOM:"room",WEARABLE:"wearable",CLOTHING:"clothing",EDIBLE:"edible",SCENERY:"scenery",OPENABLE:"openable",LOCKABLE:"lockable",SWITCHABLE:"switchable",READABLE:"readable",LIGHT_SOURCE:"lightSource",PULLABLE:"pullable",ATTACHED:"attached",PUSHABLE:"pushable",BUTTON:"button",MOVEABLE_SCENERY:"moveableScenery",DOOR:"door",CLIMBABLE:"climbable",ACTOR:"actor",EXIT:"exit",WEAPON:"weapon",BREAKABLE:"breakable",DESTRUCTIBLE:"destructible",COMBATANT:"combatant",EQUIPPED:"equipped",NPC:"npc",VEHICLE:"vehicle",ENTERABLE:"enterable",STORY_INFO:"storyInfo"};B.TraitCategory={STANDARD:"standard",INTERACTIVE:"interactive",ADVANCED:"advanced"};B.TRAIT_CATEGORIES={[B.TraitType.IDENTITY]:B.TraitCategory.STANDARD,[B.TraitType.CONTAINER]:B.TraitCategory.STANDARD,[B.TraitType.SUPPORTER]:B.TraitCategory.STANDARD,[B.TraitType.ROOM]:B.TraitCategory.STANDARD,[B.TraitType.WEARABLE]:B.TraitCategory.STANDARD,[B.TraitType.CLOTHING]:B.TraitCategory.STANDARD,[B.TraitType.EDIBLE]:B.TraitCategory.STANDARD,[B.TraitType.SCENERY]:B.TraitCategory.STANDARD,[B.TraitType.OPENABLE]:B.TraitCategory.INTERACTIVE,[B.TraitType.LOCKABLE]:B.TraitCategory.INTERACTIVE,[B.TraitType.SWITCHABLE]:B.TraitCategory.INTERACTIVE,[B.TraitType.READABLE]:B.TraitCategory.INTERACTIVE,[B.TraitType.LIGHT_SOURCE]:B.TraitCategory.INTERACTIVE,[B.TraitType.PULLABLE]:B.TraitCategory.INTERACTIVE,[B.TraitType.ATTACHED]:B.TraitCategory.INTERACTIVE,[B.TraitType.PUSHABLE]:B.TraitCategory.INTERACTIVE,[B.TraitType.BUTTON]:B.TraitCategory.INTERACTIVE,[B.TraitType.MOVEABLE_SCENERY]:B.TraitCategory.INTERACTIVE,[B.TraitType.DOOR]:B.TraitCategory.STANDARD,[B.TraitType.CLIMBABLE]:B.TraitCategory.INTERACTIVE,[B.TraitType.EXIT]:B.TraitCategory.STANDARD,[B.TraitType.ACTOR]:B.TraitCategory.STANDARD,[B.TraitType.WEAPON]:B.TraitCategory.INTERACTIVE,[B.TraitType.BREAKABLE]:B.TraitCategory.INTERACTIVE,[B.TraitType.DESTRUCTIBLE]:B.TraitCategory.INTERACTIVE,[B.TraitType.COMBATANT]:B.TraitCategory.INTERACTIVE,[B.TraitType.EQUIPPED]:B.TraitCategory.INTERACTIVE,[B.TraitType.NPC]:B.TraitCategory.STANDARD,[B.TraitType.VEHICLE]:B.TraitCategory.INTERACTIVE,[B.TraitType.ENTERABLE]:B.TraitCategory.INTERACTIVE,[B.TraitType.STORY_INFO]:B.TraitCategory.STANDARD};function u5(t){return Object.values(B.TraitType).includes(t)}function m5(t){return B.TRAIT_CATEGORIES[t]}function p5(t){return Object.entries(B.TRAIT_CATEGORIES).filter(([e,r])=>r===t).map(([e,r])=>e)}function f5(){return Object.values(B.TraitType)}function g5(t,e,r=B.TraitCategory.STANDARD){B.TraitType[t]=e,B.TRAIT_CATEGORIES[e]=r}});var Bd=p(kp=>{"use strict";Object.defineProperty(kp,"__esModule",{value:!0});kp.IFEntity=void 0;var h5=cI(),Ze=ee(),dI=class t{constructor(e,r,n){l(this,"id");l(this,"type");l(this,"attributes");l(this,"relationships");l(this,"traits");l(this,"scopePriorities",new Map);l(this,"minimumScopes",new Map);l(this,"annotations",new Map);l(this,"on");this.id=e,this.type=r,this.attributes=n?.attributes?{...n.attributes}:{},this.relationships=n?.relationships||{},this.traits=new Map}has(e){return this.traits.has(e)}get(e){let r=typeof e=="string"?e:typeof e=="function"?e.type:e;return this.traits.get(r)}getTrait(e){return this.get(e)}add(e){if(!(0,h5.isTrait)(e))throw new Error("Invalid trait: must have a type property");return this.traits.has(e.type)?(console.warn(`Entity "${this.id}" already has trait: ${e.type} - ignoring duplicate add`),this):(this.traits.set(e.type,e),this)}remove(e){return this.traits.delete(e)}hasAll(...e){return e.every(r=>this.traits.has(r))}hasAny(...e){return e.some(r=>this.traits.has(r))}getTraits(){return Array.from(this.traits.values())}getTraitTypes(){return Array.from(this.traits.keys())}clearTraits(){this.traits.clear()}scope(e,r){return r!==void 0&&this.scopePriorities.set(e,r),this.scopePriorities.get(e)??100}clearScope(e){this.scopePriorities.delete(e)}clearAllScopes(){this.scopePriorities.clear()}getScopePriorities(){return Object.fromEntries(this.scopePriorities)}setMinimumScope(e,r){if(r&&r.length>0)for(let n of r)this.minimumScopes.set(n,e);else this.minimumScopes.set("*",e);return this}getMinimumScope(e){return e&&this.minimumScopes.has(e)?this.minimumScopes.get(e):this.minimumScopes.has("*")?this.minimumScopes.get("*"):0}clearMinimumScope(e){if(e&&e.length>0)for(let r of e)this.minimumScopes.delete(r);else this.minimumScopes.clear()}getMinimumScopes(){return Object.fromEntries(this.minimumScopes)}annotate(e,r,n){let i={kind:e,id:r.id,data:r,condition:n},o=this.annotations.get(e);return o?o.push(i):this.annotations.set(e,[i]),this}getAnnotations(e){return this.annotations.get(e)??[]}getActiveAnnotations(e,r){let n=this.annotations.get(e);return n?n.filter(i=>i.condition?this.evaluateCondition(i.condition,r):!0):[]}removeAnnotation(e,r){let n=this.annotations.get(e);if(!n)return!1;let i=n.findIndex(o=>o.id===r);return i===-1?!1:(n.splice(i,1),n.length===0&&this.annotations.delete(e),!0)}hasAnnotations(e){let r=this.annotations.get(e);return!!r&&r.length>0}evaluateCondition(e,r){let n=e.scope??"self",i;switch(n){case"self":i=this;break;case"player":i=r.getPlayer();break;case"location":{let a=r.getLocation(this.id);i=a?r.getEntity(a):void 0;break}}if(!i)return!1;let o=i.get(e.trait);return o?o[e.property]===e.value:!1}clone(e){let r=new t(e,this.type,{attributes:JSON.parse(JSON.stringify(this.attributes)),relationships:JSON.parse(JSON.stringify(this.relationships))});for(let[n,i]of this.traits)r.traits.set(n,JSON.parse(JSON.stringify(i)));for(let[n,i]of this.scopePriorities)r.scopePriorities.set(n,i);for(let[n,i]of this.minimumScopes)r.minimumScopes.set(n,i);for(let[n,i]of this.annotations)r.annotations.set(n,JSON.parse(JSON.stringify(i)));return r}toJSON(){let e={id:this.id,type:this.type,attributes:this.attributes,relationships:this.relationships,traits:Array.from(this.traits.entries()).map(([r,n])=>({...n})),version:3};return this.scopePriorities.size>0&&(e.scopePriorities=Object.fromEntries(this.scopePriorities)),this.minimumScopes.size>0&&(e.minimumScopes=Object.fromEntries(this.minimumScopes)),this.annotations.size>0&&(e.annotations=Object.fromEntries(Array.from(this.annotations.entries()).map(([r,n])=>[r,n]))),e}static fromJSON(e){let r=e.type||"object";if(!e.version&&e.attributes){if(e.attributes.entityType)r=e.attributes.entityType;else if(e.id&&e.id.match(/^[a-z][0-9a-z]{2}$/)){let i=e.id[0];r={r:"room",d:"door",i:"item",a:"actor",c:"container",s:"supporter",y:"scenery",e:"exit",o:"object"}[i]||"object"}}let n=new t(e.id,r,{attributes:e.attributes,relationships:e.relationships});if(e.traits&&Array.isArray(e.traits))for(let i of e.traits)n.traits.set(i.type,i);if(e.scopePriorities&&typeof e.scopePriorities=="object")for(let[i,o]of Object.entries(e.scopePriorities))n.scopePriorities.set(i,o);if(e.minimumScopes&&typeof e.minimumScopes=="object")for(let[i,o]of Object.entries(e.minimumScopes))n.minimumScopes.set(i,o);if(e.annotations&&typeof e.annotations=="object")for(let[i,o]of Object.entries(e.annotations))Array.isArray(o)&&n.annotations.set(i,o);return n}get isRoom(){return this.has(Ze.TraitType.ROOM)}get canContain(){return this.has(Ze.TraitType.CONTAINER)||this.has(Ze.TraitType.SUPPORTER)||this.has(Ze.TraitType.ROOM)||this.has(Ze.TraitType.ACTOR)}get isTakeable(){return!this.has(Ze.TraitType.SCENERY)&&!this.has(Ze.TraitType.ROOM)&&!this.has(Ze.TraitType.DOOR)}get isScenery(){return this.has(Ze.TraitType.SCENERY)}get isOpenable(){return this.has(Ze.TraitType.OPENABLE)}get isOpen(){let e=this.get(Ze.TraitType.OPENABLE);return e?e.isOpen:!1}get isLockable(){return this.has(Ze.TraitType.LOCKABLE)}get isLocked(){let e=this.get(Ze.TraitType.LOCKABLE);return e?e.isLocked:!1}get isContainer(){return this.has(Ze.TraitType.CONTAINER)}get isSupporter(){return this.has(Ze.TraitType.SUPPORTER)}get isDoor(){return this.has(Ze.TraitType.DOOR)}get isActor(){return this.has(Ze.TraitType.ACTOR)}get isPlayer(){let e=this.get(Ze.TraitType.ACTOR);return e?e.isPlayer:!1}get providesLight(){let e=this.get(Ze.TraitType.LIGHT_SOURCE);return e?e.isLit:!1}get isSwitchable(){return this.has(Ze.TraitType.SWITCHABLE)}get enterable(){return this.has(Ze.TraitType.ENTERABLE)||this.has(Ze.TraitType.VEHICLE)}get isOn(){let e=this.get(Ze.TraitType.SWITCHABLE);return e?e.isOn:!1}get name(){let e=this.get(Ze.TraitType.IDENTITY);return e&&e.name?e.name:this.attributes.displayName?this.attributes.displayName:this.attributes.name?this.attributes.name:this.id}get description(){let e=this.get(Ze.TraitType.IDENTITY);return e?e.description:void 0}get weight(){return this.attributes.weight||0}hasTrait(e){return this.has(e)}};kp.IFEntity=dI});var pP=p(Bp=>{"use strict";Object.defineProperty(Bp,"__esModule",{value:!0});Bp.EntityStore=void 0;var y5=Bd(),lI=class t{constructor(){l(this,"ifEntities");this.ifEntities=new Map}add(e){this.ifEntities.set(e.id,e)}get(e){return this.ifEntities.get(e)}has(e){return this.ifEntities.has(e)}remove(e){let r=this.ifEntities.get(e);return r&&r.clearTraits(),this.ifEntities.delete(e)}getAll(){return Array.from(this.ifEntities.values())}getByType(e){return this.getAll().filter(r=>r.type===e)}findWithTrait(e){return this.getAll().filter(r=>r.has(e))}findWithAllTraits(...e){return this.getAll().filter(r=>r.hasAll(...e))}findWithAnyTraits(...e){return this.getAll().filter(r=>r.hasAny(...e))}clear(){for(let e of this.ifEntities.values())e.clearTraits();this.ifEntities.clear()}get size(){return this.ifEntities.size}[Symbol.iterator](){return this.ifEntities.values()}toJSON(){return this.getAll().map(e=>e.toJSON())}static fromJSON(e){let r=new t;if(Array.isArray(e))for(let n of e){let i=y5.IFEntity.fromJSON(n);r.add(i)}return r}};Bp.EntityStore=lI});var uI=p(zt=>{"use strict";Object.defineProperty(zt,"__esModule",{value:!0});zt.EntityType=void 0;zt.isEntityType=T5;zt.getEntityTypePrefix=E5;zt.EntityType={ROOM:"room",DOOR:"door",ITEM:"item",ACTOR:"actor",CONTAINER:"container",SUPPORTER:"supporter",SCENERY:"scenery",EXIT:"exit",OBJECT:"object"};function T5(t){return Object.values(zt.EntityType).includes(t)}function E5(t){return{[zt.EntityType.ROOM]:"r",[zt.EntityType.DOOR]:"d",[zt.EntityType.ITEM]:"i",[zt.EntityType.ACTOR]:"a",[zt.EntityType.CONTAINER]:"c",[zt.EntityType.SUPPORTER]:"s",[zt.EntityType.SCENERY]:"y",[zt.EntityType.EXIT]:"e",[zt.EntityType.OBJECT]:"o"}[t]||"o"}});var fP=p(Nn=>{"use strict";Object.defineProperty(Nn,"__esModule",{value:!0});Nn.getEntityTypePrefix=Nn.isEntityType=Nn.EntityType=Nn.EntityStore=Nn.IFEntity=void 0;var v5=Bd();Object.defineProperty(Nn,"IFEntity",{enumerable:!0,get:function(){return v5.IFEntity}});var _5=pP();Object.defineProperty(Nn,"EntityStore",{enumerable:!0,get:function(){return _5.EntityStore}});var mI=uI();Object.defineProperty(Nn,"EntityType",{enumerable:!0,get:function(){return mI.EntityType}});Object.defineProperty(Nn,"isEntityType",{enumerable:!0,get:function(){return mI.isEntityType}});Object.defineProperty(Nn,"getEntityTypePrefix",{enumerable:!0,get:function(){return mI.getEntityTypePrefix}})});var Dt=p(vu=>{"use strict";Object.defineProperty(vu,"__esModule",{value:!0});vu.Behavior=void 0;vu.isWorldAwareBehavior=b5;var xp=class{static require(e,r){if(!e.has(r))throw new Error(`Entity "${e.id}" missing required trait: ${r}`);return e.get(r)}static optional(e,r){if(e.has(r))return e.get(r)}static validateEntity(e){return this.requiredTraits.every(r=>e.has(r))}static getMissingTraits(e){return this.requiredTraits.filter(r=>!e.has(r))}};l(xp,"requiredTraits",[]);vu.Behavior=xp;function b5(t){return"setWorldContext"in t}});var _u=p(jp=>{"use strict";Object.defineProperty(jp,"__esModule",{value:!0});jp.IdentityBehavior=void 0;var I5=Dt(),Mr=ee(),Pr=class Pr extends I5.Behavior{static validateIdentity(e){let r=Pr.require(e,Mr.TraitType.IDENTITY);if(!r.name||!r.name.trim())throw new Error(`Entity ${e.id} has no name`);if(r.properName&&r.article&&(r.article=""),r.weight!==void 0&&r.weight<0)throw new Error(`Entity ${e.id} has negative weight`);if(r.volume!==void 0&&r.volume<0)throw new Error(`Entity ${e.id} has negative volume`);let n=["tiny","small","medium","large","huge"];if(r.size!==void 0&&!n.includes(r.size))throw new Error(`Entity ${e.id} has invalid size: ${r.size}`)}static formatName(e,r){let n=Pr.require(e,Mr.TraitType.IDENTITY),i;return n.properName||!n.article?i=n.name:i=`${n.article} ${n.name}`,r?.definite&&!n.properName&&n.article!=="the"&&(i=`the ${n.name}`),r?.capitalize&&(i=i.charAt(0).toUpperCase()+i.slice(1)),i}static getPossessiveName(e){let r=Pr.formatName(e);return r.endsWith("s")?`${r}'`:`${r}'s`}static matchesName(e,r){let n=Pr.require(e,Mr.TraitType.IDENTITY),i=r.toLowerCase();return n.name.toLowerCase()===i?!0:n.aliases.some(o=>o.toLowerCase()===i)}static isConcealed(e){return Pr.require(e,Mr.TraitType.IDENTITY).concealed}static setConcealed(e,r){let n=Pr.require(e,Mr.TraitType.IDENTITY);n.concealed=r}static reveal(e){Pr.setConcealed(e,!1)}static conceal(e){Pr.setConcealed(e,!0)}static getWeight(e){return e.has(Mr.TraitType.IDENTITY)&&e.get(Mr.TraitType.IDENTITY)?.weight||0}static getVolume(e){return e.has(Mr.TraitType.IDENTITY)&&e.get(Mr.TraitType.IDENTITY)?.volume||0}static getSize(e){return Pr.require(e,Mr.TraitType.IDENTITY).size}static getTotalWeight(e,r){let i=Pr.require(e,Mr.TraitType.IDENTITY).weight||0;if(r&&(e.has(Mr.TraitType.CONTAINER)||e.has(Mr.TraitType.SUPPORTER))){let o=r(e.id);for(let a of o)i+=Pr.getTotalWeight(a,r)}return i}};l(Pr,"requiredTraits",[Mr.TraitType.IDENTITY]);var pI=Pr;jp.IdentityBehavior=pI});var bu=p(Up=>{"use strict";Object.defineProperty(Up,"__esModule",{value:!0});Up.WearableBehavior=void 0;var Li=ee(),Wp=class{static canWear(e,r){let n=e.get(Li.TraitType.WEARABLE);return!(!n||n.worn)}static canRemove(e,r){let n=e.get(Li.TraitType.WEARABLE);return!(!n||!n.worn||n.wornBy!==r.id)}static wear(e,r){let n=e.get(Li.TraitType.WEARABLE);return n?n.worn?n.wornBy===r.id?{success:!1,alreadyWorn:!0}:{success:!1,wornByOther:n.wornBy}:(n.worn=!0,n.wornBy=r.id,{success:!0,slot:n.slot,layer:n.layer,wearMessage:n.wearMessage}):{success:!1}}static remove(e,r){let n=e.get(Li.TraitType.WEARABLE);return n?n.worn?n.wornBy!==r.id?{success:!1,wornByOther:n.wornBy}:(n.worn=!1,n.wornBy=void 0,{success:!0,removeMessage:n.removeMessage}):{success:!1,notWorn:!0}:{success:!1}}static isWorn(e){let r=e.get(Li.TraitType.WEARABLE);return r?r.worn:!1}static getWearer(e){return e.get(Li.TraitType.WEARABLE)?.wornBy}static getSlot(e){let r=e.get(Li.TraitType.WEARABLE);return r?r.slot:"clothing"}static getLayer(e){let r=e.get(Li.TraitType.WEARABLE);return r?r.layer:1}static getBlockedSlots(e){let r=e.get(Li.TraitType.WEARABLE);return r?[...r.blocksSlots]:[]}};l(Wp,"requiredTraits",[Li.TraitType.WEARABLE]);Up.WearableBehavior=Wp});var Gp=p(qp=>{"use strict";Object.defineProperty(qp,"__esModule",{value:!0});qp.ContainerBehavior=void 0;var O5=Dt(),Kt=ee(),Hp=_u(),S5=bu(),Dn=class Dn extends O5.Behavior{static canAccept(e,r,n){let i=Dn.require(e,Kt.TraitType.CONTAINER);if(e.has(Kt.TraitType.OPENABLE)){let o=e.get(Kt.TraitType.OPENABLE);if(o&&!o.isOpen)return!1}if(i.allowedTypes&&i.allowedTypes.length>0){let o=r.type||"object";if(!i.allowedTypes.includes(o))return!1}if(i.excludedTypes&&i.excludedTypes.length>0){let o=r.type||"object";if(i.excludedTypes.includes(o))return!1}return!(r.has(Kt.TraitType.ACTOR)&&!i.enterable||i.capacity&&!this.checkCapacity(e,r,n))}static checkCapacity(e,r,n){let o=Dn.require(e,Kt.TraitType.CONTAINER).capacity;if(!o)return!0;if(o.maxItems!==void 0&&n.getContents(e.id).filter(c=>!S5.WearableBehavior.isWorn(c)).length>=o.maxItems)return!1;if(o.maxWeight!==void 0){let a=this.getTotalWeight(e,n),s=Hp.IdentityBehavior.getWeight(r);if(a+s>o.maxWeight)return!1}if(o.maxVolume!==void 0){let a=this.getTotalVolume(e,n),s=Hp.IdentityBehavior.getVolume(r);if(a+s>o.maxVolume)return!1}return!0}static getTotalWeight(e,r){return r.getContents(e.id).reduce((i,o)=>i+Hp.IdentityBehavior.getWeight(o),0)}static getTotalVolume(e,r){return r.getContents(e.id).reduce((i,o)=>i+Hp.IdentityBehavior.getVolume(o),0)}static getRemainingCapacity(e,r){let n=Dn.require(e,Kt.TraitType.CONTAINER),i={};if(n.capacity?.maxItems!==void 0){let o=r.getContents(e.id).length;i.items=n.capacity.maxItems-o}return n.capacity?.maxWeight!==void 0&&(i.weight=n.capacity.maxWeight-this.getTotalWeight(e,r)),n.capacity?.maxVolume!==void 0&&(i.volume=n.capacity.maxVolume-this.getTotalVolume(e,r)),i}static isTransparent(e){return Dn.require(e,Kt.TraitType.CONTAINER).isTransparent||!1}static isEnterable(e){return Dn.require(e,Kt.TraitType.CONTAINER).enterable||!1}static getAllowedTypes(e){return Dn.require(e,Kt.TraitType.CONTAINER).allowedTypes}static getExcludedTypes(e){return Dn.require(e,Kt.TraitType.CONTAINER).excludedTypes}static addItem(e,r,n){let i=Dn.require(e,Kt.TraitType.CONTAINER);if(e.has(Kt.TraitType.OPENABLE)){let a=e.get(Kt.TraitType.OPENABLE);if(a&&!a.isOpen)return{success:!1,containerClosed:!0,stateChanged:!1}}if(n.getLocation(r.id)===e.id)return{success:!1,alreadyContains:!0,stateChanged:!1};if(i.allowedTypes&&i.allowedTypes.length>0){let a=r.type||"object";if(!i.allowedTypes.includes(a))return{success:!1,wrongType:!0,stateChanged:!1}}if(i.excludedTypes&&i.excludedTypes.length>0){let a=r.type||"object";if(i.excludedTypes.includes(a))return{success:!1,wrongType:!0,stateChanged:!1}}return Dn.checkCapacity(e,r,n)?{success:!0,stateChanged:!0}:{success:!1,containerFull:!0,stateChanged:!1}}static removeItem(e,r,n){if(e.has(Kt.TraitType.OPENABLE)){let o=e.get(Kt.TraitType.OPENABLE);if(o&&!o.isOpen)return{success:!1,containerClosed:!0,stateChanged:!1}}return n.getLocation(r.id)!==e.id?{success:!1,notContained:!0,stateChanged:!1}:{success:!0,stateChanged:!0}}};l(Dn,"requiredTraits",[Kt.TraitType.CONTAINER]);var fI=Dn;qp.ContainerBehavior=fI});var gI=p(Yp=>{"use strict";Object.defineProperty(Yp,"__esModule",{value:!0});Yp.SceneryBehavior=void 0;var Fp=ee(),Vp=class{static getUntakeableReason(e){let r=e.get(Fp.TraitType.SCENERY);return r?r.cantTakeMessage?"custom_message":"fixed_in_place":"not_scenery"}static getCantTakeMessage(e){return e.get(Fp.TraitType.SCENERY)?.cantTakeMessage}static isMentioned(e){let r=e.get(Fp.TraitType.SCENERY);return r?r.mentioned:!0}};l(Vp,"requiredTraits",[Fp.TraitType.SCENERY]);Yp.SceneryBehavior=Vp});var hI=p(Kp=>{"use strict";Object.defineProperty(Kp,"__esModule",{value:!0});Kp.ReadableBehavior=void 0;var wo=ee(),xd=Ve(),zp=class{static getText(e){let r=e.get(wo.TraitType.READABLE);return r?r.pageContent&&r.currentPage&&r.pageContent[r.currentPage-1]||r.text:""}static markAsRead(e){let r=e.get(wo.TraitType.READABLE);return!r||r.hasBeenRead?[]:(r.hasBeenRead=!0,[(0,xd.createEvent)("if.readable.read",{reader:"player",readable:e.id,firstTime:!0})])}static canRead(e,r){let n=e.get(wo.TraitType.READABLE);return!n||!n.isReadable?!1:n.requiresAbility?r===n.requiredAbility:!0}static turnToPage(e,r){let n=e.get(wo.TraitType.READABLE);if(!n||!n.pageContent||!n.pages)return[];if(r<1||r>n.pages)return[(0,xd.createEvent)("if.action.failed",{action:"turn_page",reason:"invalid_page",entity:e.id})];let i=n.currentPage||1;return n.currentPage=r,[(0,xd.createEvent)("if.readable.page_turned",{readable:e.id,fromPage:i,toPage:r,totalPages:n.pages})]}static nextPage(e){let r=e.get(wo.TraitType.READABLE);return!r||!r.currentPage||!r.pages?[]:this.turnToPage(e,r.currentPage+1)}static previousPage(e){let r=e.get(wo.TraitType.READABLE);return!r||!r.currentPage||!r.pages?[]:this.turnToPage(e,r.currentPage-1)}static getPreview(e){let r=e.get(wo.TraitType.READABLE);if(!r)return"";if(r.preview)return r.preview;let n=this.getText(e);if(n.length<=50)return n;let i=n.substring(0,50),o=i.lastIndexOf(" ");return o>30?i.substring(0,o)+"...":i+"..."}static read(e,r){let n=r.get(wo.TraitType.READABLE);if(!n)return[(0,xd.createEvent)("if.action.failed",{action:"read",reason:"not_readable",actor:e.id,target:r.id})];if(!this.canRead(r))return[(0,xd.createEvent)("if.action.failed",{action:"read",reason:n.requiresAbility?"requires_ability":"cannot_read",actor:e.id,target:r.id,requiredAbility:n.requiredAbility,message:n.cannotReadMessage})];let i=[];return n.hasBeenRead||i.push(...this.markAsRead(r)),i.push((0,xd.createEvent)("if.readable.read",{reader:e.id,readable:r.id,text:this.getText(r),page:n.currentPage,totalPages:n.pages,language:n.language,readableType:n.readableType})),i}};l(zp,"requiredTraits",[wo.TraitType.READABLE]);Kp.ReadableBehavior=zp});var gP=p(jd=>{"use strict";Object.defineProperty(jd,"__esModule",{value:!0});jd.IFEventCategory=jd.IFEvents=void 0;jd.IFEvents={TAKEN:"taken",DROPPED:"dropped",MOVED:"moved",EXAMINED:"examined",PUT_IN:"put_in",PUT_ON:"put_on",REMOVED_FROM:"removed_from",ITEM_PUT_ON:"item_put_on",ITEM_REMOVED_FROM:"item_removed_from",CONTAINER_EMPTIED:"container_emptied",CONTAINER_NOT_OPEN:"container_not_open",NOT_A_CONTAINER:"not_a_container",NOT_A_SUPPORTER:"not_a_supporter",DOESNT_FIT:"doesnt_fit",OPENED:"opened",CLOSED:"closed",NOT_OPENABLE:"not_openable",LOCKED:"locked",UNLOCKED:"unlocked",CONTAINER_LOCKED:"container_locked",CONTAINER_UNLOCKED:"container_unlocked",ALREADY_LOCKED:"already_locked",ALREADY_UNLOCKED:"already_unlocked",UNLOCK_FAILED:"unlock_failed",NOT_LOCKABLE:"not_lockable",SWITCHED_ON:"switched_on",SWITCHED_OFF:"switched_off",DEVICE_SWITCHED_ON:"device_switched_on",DEVICE_SWITCHED_OFF:"device_switched_off",DEVICE_ACTIVATED:"device_activated",WORN:"worn",REMOVED:"removed",EATEN:"eaten",DRUNK:"drunk",ITEM_EATEN:"item_eaten",ITEM_DRUNK:"item_drunk",ITEM_DESTROYED:"item_destroyed",ACTOR_MOVED:"actor_moved",ACTOR_ENTERED:"actor_entered",ACTOR_EXITED:"actor_exited",MOVEMENT_BLOCKED:"movement_blocked",ENTERED:"entered",EXITED:"exited",EVACUATED:"evacuated",CLIMBED:"climbed",ROOM_ENTERED:"room_entered",ROOM_EXITED:"room_exited",ROOM_DESCRIBED:"room_described",ROOM_FIRST_ENTERED:"room_first_entered",ROOM_ILLUMINATED:"room_illuminated",ROOM_DARKENED:"room_darkened",NEW_EXIT_REVEALED:"new_exit_revealed",LIGHT_CHANGED:"light_changed",LOCATION_ILLUMINATED:"location_illuminated",LOCATION_DARKENED:"location_darkened",FUEL_DEPLETED:"fuel_depleted",FUEL_LOW:"fuel_low",REFUELED:"refueled",READ:"read",SEARCHED:"searched",LISTENED:"listened",SMELLED:"smelled",TOUCHED:"touched",GIVEN:"given",SHOWN:"shown",THROWN:"thrown",PUSHED:"pushed",PULLED:"pulled",TURNED:"turned",USED:"used",CUSTOM_MESSAGE:"custom_message",VISIBILITY_CHANGED:"visibility_changed",ACTION_PREVENTED:"action_prevented",ACTION_FAILED:"action_failed",ACTION_SUCCEEDED:"action_succeeded",WAITED:"waited",SCORE_DISPLAYED:"score_displayed",HELP_DISPLAYED:"help_displayed",ABOUT_DISPLAYED:"about_displayed",SCORE_GAINED:"if.event.score_gained",SCORE_LOST:"if.event.score_lost"};jd.IFEventCategory={MANIPULATION:"manipulation",MOVEMENT:"movement",STATE_CHANGE:"state_change",PERCEPTION:"perception",META:"meta"}});var yP=p(hP=>{"use strict";Object.defineProperty(hP,"__esModule",{value:!0})});var EP=p(TP=>{"use strict";Object.defineProperty(TP,"__esModule",{value:!0})});var _P=p(vP=>{"use strict";Object.defineProperty(vP,"__esModule",{value:!0})});var IP=p(bP=>{"use strict";Object.defineProperty(bP,"__esModule",{value:!0})});var SP=p(OP=>{"use strict";Object.defineProperty(OP,"__esModule",{value:!0})});var RP=p(AP=>{"use strict";Object.defineProperty(AP,"__esModule",{value:!0})});var wP=p($p=>{"use strict";Object.defineProperty($p,"__esModule",{value:!0});$p.ParseErrorType=void 0;var CP;(function(t){t.NO_VERB="NO_VERB",t.UNKNOWN_VERB="UNKNOWN_VERB",t.UNKNOWN_WORD="UNKNOWN_WORD",t.AMBIGUOUS="AMBIGUOUS",t.INCOMPLETE="INCOMPLETE",t.PATTERN_MISMATCH="PATTERN_MISMATCH"})(CP||($p.ParseErrorType=CP={}))});var NP=p(Qp=>{"use strict";Object.defineProperty(Qp,"__esModule",{value:!0});Qp.ParserFactory=void 0;var Mi=new Map,yI=class{static registerParser(e,r){let n=e.toLowerCase();Mi.set(n,r);let i=n.split("-")[0];i!==n&&!Mi.has(i)&&Mi.set(i,r)}static createParser(e,r){let n=e.toLowerCase(),i=Mi.get(n);if(!i){let o=n.split("-")[0];i=Mi.get(o)}if(!i){let o=Array.from(Mi.keys()).sort();throw new Error(`No parser registered for language: ${e}. Available languages: ${o.join(", ")}. Register a parser using ParserFactory.registerParser().`)}return new i(r)}static getRegisteredLanguages(){return Array.from(Mi.keys()).sort()}static isLanguageRegistered(e){let r=e.toLowerCase();if(Mi.has(r))return!0;let n=r.split("-")[0];return Mi.has(n)}static clearRegistry(){Mi.clear()}};Qp.ParserFactory=yI});var DP=p(No=>{"use strict";var A5=No&&No.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),TI=No&&No.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&A5(e,t,r)};Object.defineProperty(No,"__esModule",{value:!0});TI(RP(),No);TI(wP(),No);TI(NP(),No)});var EI=p(Wd=>{"use strict";Object.defineProperty(Wd,"__esModule",{value:!0});Wd.GrammarPatterns=Wd.PartOfSpeech=void 0;Wd.PartOfSpeech={VERB:"verb",NOUN:"noun",ADJECTIVE:"adjective",PREPOSITION:"preposition",ARTICLE:"article",PRONOUN:"pronoun",DIRECTION:"direction",SPECIAL:"special",DETERMINER:"determiner",CONJUNCTION:"conjunction",NUMBER:"number"};Wd.GrammarPatterns=Object.freeze({VERB_ONLY:Object.freeze({name:"verb_only",elements:Object.freeze(["VERB"]),example:"look"}),VERB_NOUN:Object.freeze({name:"verb_noun",elements:Object.freeze(["VERB","NOUN"]),example:"take sword"}),VERB_NOUN_PREP_NOUN:Object.freeze({name:"verb_noun_prep_noun",elements:Object.freeze(["VERB","NOUN","PREP","NOUN"]),example:"put sword in chest"}),VERB_PREP_NOUN:Object.freeze({name:"verb_prep_noun",elements:Object.freeze(["VERB","PREP","NOUN"]),example:"look at painting"}),VERB_DIRECTION:Object.freeze({name:"verb_direction",elements:Object.freeze(["VERB","DIRECTION"]),example:"go north"}),DIRECTION_ONLY:Object.freeze({name:"direction_only",elements:Object.freeze(["DIRECTION"]),example:"north"})})});var LP=p(Ud=>{"use strict";Object.defineProperty(Ud,"__esModule",{value:!0});Ud.vocabularyRegistry=Ud.VocabularyRegistry=void 0;var kr=EI(),Xp=class{constructor(){l(this,"providers",new Map);l(this,"entityVocabulary",new Map);l(this,"cachedVocabulary",null);l(this,"dirtyCache",!0)}registerProvider(e){this.providers.set(e.id,e),this.dirtyCache=!0}unregisterProvider(e){this.providers.delete(e),this.dirtyCache=!0}registerEntity(e){this.entityVocabulary.set(e.entityId,e),this.dirtyCache=!0}unregisterEntity(e){this.entityVocabulary.delete(e),this.dirtyCache=!0}updateEntityScope(e,r){let n=this.entityVocabulary.get(e);n&&(n.inScope=r)}getVocabulary(){if(!this.dirtyCache&&this.cachedVocabulary)return this.cachedVocabulary;let e=[],r=new Map,n=new Map,i=Array.from(this.providers.values()).sort((o,a)=>(a.priority||0)-(o.priority||0));for(let o of i){let a=o.getVocabulary();e.push(...a)}for(let[o,a]of this.entityVocabulary){for(let s of a.nouns)e.push({word:s.toLowerCase(),partOfSpeech:kr.PartOfSpeech.NOUN,mapsTo:o,source:"entity",priority:a.priority,metadata:{inScope:a.inScope}});for(let s of a.adjectives)e.push({word:s.toLowerCase(),partOfSpeech:kr.PartOfSpeech.ADJECTIVE,mapsTo:o,source:"entity",priority:a.priority,metadata:{inScope:a.inScope}})}for(let o of e){let a=o.word.toLowerCase();r.has(a)||r.set(a,[]);let s=r.get(a);s&&s.push(o),n.has(o.partOfSpeech)||n.set(o.partOfSpeech,[]);let c=n.get(o.partOfSpeech);c&&c.push(o)}for(let o of r.values())o.sort((a,s)=>(s.priority||0)-(a.priority||0));return this.cachedVocabulary={entries:e,byWord:r,byPartOfSpeech:n},this.dirtyCache=!1,this.cachedVocabulary}lookup(e,r){let i=this.getVocabulary().byWord.get(e.toLowerCase())||[];return r?i.filter(o=>o.partOfSpeech===r):i}getByPartOfSpeech(e){return this.getVocabulary().byPartOfSpeech.get(e)||[]}hasWord(e,r){return this.lookup(e,r).length>0}getInScopeEntities(){return Array.from(this.entityVocabulary.values()).filter(e=>e.inScope)}clear(){this.providers.clear(),this.entityVocabulary.clear(),this.cachedVocabulary=null,this.dirtyCache=!0}registerVerbs(e){let r=[];for(let n of e)for(let i of n.verbs)r.push({word:i.toLowerCase(),partOfSpeech:kr.PartOfSpeech.VERB,mapsTo:n.actionId,source:"base",metadata:{pattern:n.pattern,prepositions:n.prepositions}});this.registerProvider({id:"standard-verbs",getVocabulary:()=>r,priority:100})}registerDynamicVerbs(e,r="story"){let n=[];for(let i of e)for(let o of i.verbs)n.push({word:o.toLowerCase(),partOfSpeech:kr.PartOfSpeech.VERB,mapsTo:i.actionId,source:r,priority:80,metadata:{pattern:i.pattern,prepositions:i.prepositions}});this.registerProvider({id:`dynamic-verbs-${r}`,getVocabulary:()=>n,priority:80})}registerDirections(e){let r=[];for(let n of e){for(let i of n.words)r.push({word:i.toLowerCase(),partOfSpeech:kr.PartOfSpeech.DIRECTION,mapsTo:n.direction,source:"base"});if(n.abbreviations)for(let i of n.abbreviations)r.push({word:i.toLowerCase(),partOfSpeech:kr.PartOfSpeech.DIRECTION,mapsTo:n.direction,source:"base",priority:90})}this.registerProvider({id:"standard-directions",getVocabulary:()=>r,priority:100})}registerPrepositions(e){let r=[];for(let n of e)r.push({word:n.toLowerCase(),partOfSpeech:kr.PartOfSpeech.PREPOSITION,mapsTo:n.toUpperCase(),source:"base"});this.registerProvider({id:"standard-prepositions",getVocabulary:()=>r,priority:100})}registerDeterminers(e){let r=[];for(let n of e)r.push({word:n.toLowerCase(),partOfSpeech:kr.PartOfSpeech.DETERMINER,mapsTo:n.toUpperCase(),source:"base"});this.registerProvider({id:"standard-determiners",getVocabulary:()=>r,priority:100})}registerConjunctions(e){let r=[];for(let n of e)r.push({word:n.toLowerCase(),partOfSpeech:kr.PartOfSpeech.CONJUNCTION,mapsTo:n.toUpperCase(),source:"base"});this.registerProvider({id:"standard-conjunctions",getVocabulary:()=>r,priority:100})}registerNumbers(e){let r=[];for(let n of e)r.push({word:n.toLowerCase(),partOfSpeech:kr.PartOfSpeech.NUMBER,mapsTo:n,source:"base"});this.registerProvider({id:"standard-numbers",getVocabulary:()=>r,priority:100})}registerSpecial(e){let r=[];for(let n of e.pronouns)r.push({word:n.toLowerCase(),partOfSpeech:kr.PartOfSpeech.PRONOUN,mapsTo:"IT",source:"base"});for(let n of e.articles)r.push({word:n.toLowerCase(),partOfSpeech:kr.PartOfSpeech.ARTICLE,mapsTo:"ARTICLE",source:"base"});for(let n of e.allWords)r.push({word:n.toLowerCase(),partOfSpeech:kr.PartOfSpeech.SPECIAL,mapsTo:"ALL",source:"base"});for(let n of e.exceptWords)r.push({word:n.toLowerCase(),partOfSpeech:kr.PartOfSpeech.SPECIAL,mapsTo:"EXCEPT",source:"base"});this.registerProvider({id:"special-vocabulary",getVocabulary:()=>r,priority:100})}};Ud.VocabularyRegistry=Xp;Ud.vocabularyRegistry=new Xp});var MP=p(Iu=>{"use strict";Object.defineProperty(Iu,"__esModule",{value:!0});Iu.adaptVerbVocabulary=R5;Iu.adaptDirectionVocabulary=C5;Iu.adaptSpecialVocabulary=w5;function R5(t){if(t.getVerbs)return t.getVerbs();let e=[],r=t.getVerbMappings?.()||{};for(let[n,i]of Object.entries(r))Array.isArray(i)&&e.push({actionId:n,verbs:i,pattern:t.getVerbPattern?.(n)});return e}function C5(t){if(t.getDirections)return t.getDirections();let e=[],r=t.getDirectionMappings?.()||{};for(let[n,i]of Object.entries(r))if(Array.isArray(i)){let o=i.filter(s=>s.length>2),a=i.filter(s=>s.length<=2);e.push({direction:n,words:o.length>0?o:i,abbreviations:a.length>0?a:void 0})}return e}function w5(t){return t.getSpecialVocabulary?t.getSpecialVocabulary():{pronouns:t.getPronouns?.()||["it","them"],allWords:t.getAllWords?.()||["all","everything"],exceptWords:t.getExceptWords?.()||["except","but"],articles:t.getArticles?.()||["a","an","the"]}}});var PP=p(Do=>{"use strict";var N5=Do&&Do.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),vI=Do&&Do.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&N5(e,t,r)};Object.defineProperty(Do,"__esModule",{value:!0});vI(EI(),Do);vI(LP(),Do);vI(MP(),Do)});var _I=p(Zp=>{"use strict";Object.defineProperty(Zp,"__esModule",{value:!0});Zp.SlotType=void 0;var kP;(function(t){t.ENTITY="entity",t.TEXT="text",t.TEXT_GREEDY="text_greedy",t.INSTRUMENT="instrument",t.DIRECTION="direction",t.NUMBER="number",t.ORDINAL="ordinal",t.TIME="time",t.MANNER="manner",t.QUOTED_TEXT="quoted_text",t.TOPIC="topic",t.VOCABULARY="vocabulary",t.ADJECTIVE="adjective",t.NOUN="noun"})(kP||(Zp.SlotType=kP={}))});var BP=p(Jp=>{"use strict";Object.defineProperty(Jp,"__esModule",{value:!0});Jp.PatternSyntaxError=void 0;var bI=class extends Error{constructor(r,n,i){super(r);l(this,"pattern");l(this,"position");this.pattern=n,this.position=i,this.name="PatternSyntaxError"}};Jp.PatternSyntaxError=bI});var xP=p(ef=>{"use strict";Object.defineProperty(ef,"__esModule",{value:!0});ef.GrammarEngine=void 0;var Ot=_I(),II=class{constructor(e){l(this,"rules",[]);l(this,"rulesByAction",new Map);l(this,"compiler");this.compiler=e}addRule(e){e.compiledPattern||(e.compiledPattern=this.compiler.compile(e.pattern)),this.rules.push(e);let r=this.rulesByAction.get(e.action)||[];r.push(e),this.rulesByAction.set(e.action,r),this.sortRules()}addRules(e){e.forEach(r=>this.addRule(r))}getBestMatch(e,r,n){let i=this.findMatches(e,r,n);return i.length>0?i[0]:null}clear(){this.rules=[],this.rulesByAction.clear()}getRules(){return[...this.rules]}getRulesForAction(e){return this.rulesByAction.get(e)||[]}sortRules(){this.rules.sort((e,r)=>r.priority-e.priority),this.rulesByAction.forEach(e=>{e.sort((r,n)=>n.priority-r.priority)})}createBuilder(){let e=this;return{define(r){let n={id:`rule_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,pattern:r,slots:new Map,priority:100},i={hasTrait(o,a){let s=n.slots.get(o)||{name:o,constraints:[],traitFilters:[]};return s.traitFilters||(s.traitFilters=[]),s.traitFilters.push(a),n.slots.set(o,s),i},where(o,a){let s=n.slots.get(o)||{name:o,constraints:[]};return s.constraints.push(a),n.slots.set(o,s),i},text(o){let a=n.slots.get(o)||{name:o,constraints:[]};return a.slotType=Ot.SlotType.TEXT,n.slots.set(o,a),i},instrument(o){let a=n.slots.get(o)||{name:o,constraints:[]};return a.slotType=Ot.SlotType.INSTRUMENT,n.slots.set(o,a),i},mapsTo(o){return n.action=o,i},withPriority(o){return n.priority=o,i},withSemanticVerbs(o){return n.semantics||(n.semantics={}),n.semantics.verbs=o,i},withSemanticPrepositions(o){return n.semantics||(n.semantics={}),n.semantics.prepositions=o,i},withSemanticDirections(o){return n.semantics||(n.semantics={}),n.semantics.directions=o,i},withDefaultSemantics(o){return n.defaultSemantics=o,i},number(o){let a=n.slots.get(o)||{name:o,constraints:[]};return a.slotType=Ot.SlotType.NUMBER,n.slots.set(o,a),i},ordinal(o){let a=n.slots.get(o)||{name:o,constraints:[]};return a.slotType=Ot.SlotType.ORDINAL,n.slots.set(o,a),i},time(o){let a=n.slots.get(o)||{name:o,constraints:[]};return a.slotType=Ot.SlotType.TIME,n.slots.set(o,a),i},direction(o){let a=n.slots.get(o)||{name:o,constraints:[]};return a.slotType=Ot.SlotType.DIRECTION,n.slots.set(o,a),i},manner(o){let a=n.slots.get(o)||{name:o,constraints:[]};return a.slotType=Ot.SlotType.MANNER,n.slots.set(o,a),i},fromVocabulary(o,a){let s=n.slots.get(o)||{name:o,constraints:[]};return s.slotType=Ot.SlotType.VOCABULARY,s.vocabularyCategory=a,n.slots.set(o,s),i},adjective(o){let a=n.slots.get(o)||{name:o,constraints:[]};return a.slotType=Ot.SlotType.ADJECTIVE,n.slots.set(o,a),i},noun(o){let a=n.slots.get(o)||{name:o,constraints:[]};return a.slotType=Ot.SlotType.NOUN,n.slots.set(o,a),i},quotedText(o){let a=n.slots.get(o)||{name:o,constraints:[]};return a.slotType=Ot.SlotType.QUOTED_TEXT,n.slots.set(o,a),i},topic(o){let a=n.slots.get(o)||{name:o,constraints:[]};return a.slotType=Ot.SlotType.TOPIC,n.slots.set(o,a),i},build(){if(!n.action)throw new Error("Grammar rule must have an action (use .mapsTo())");return e.addRule(n),n}};return i},forAction(r){let n=[],i=[],o={},a=new Map,s=new Map,c=new Map,d=100,u,m={verbs(f){return n.push(...f),m},pattern(f){return i.push(f),m},patterns(f){return i.push(...f),m},directions(f){return Object.assign(o,f),m},hasTrait(f,g){let h=s.get(f)||[];return h.push(g),s.set(f,h),m},where(f,g){let h=a.get(f)||[];return h.push({constraint:g}),a.set(f,h),m},withPriority(f){return d=f,m},withDefaultSemantics(f){return u=f,m},slotType(f,g){return c.set(f,g),m},build(){if(n.length>0&&i.length>0)for(let f of n)for(let g of i){let h=g.trim()?`${f} ${g}`:f,y=e.createBuilder().define(h);y=y.mapsTo(r),y=y.withPriority(d),u&&(y=y.withDefaultSemantics(u));for(let[T,I]of a)for(let{constraint:A}of I)y=y.where(T,A);for(let[T,I]of s)for(let A of I)y=y.hasTrait(T,A);for(let[T,I]of c)switch(I){case Ot.SlotType.TEXT:y=y.text(T);break;case Ot.SlotType.INSTRUMENT:y=y.instrument(T);break;case Ot.SlotType.NUMBER:y=y.number(T);break;case Ot.SlotType.ORDINAL:y=y.ordinal(T);break;case Ot.SlotType.TIME:y=y.time(T);break;case Ot.SlotType.DIRECTION:y=y.direction(T);break;case Ot.SlotType.MANNER:y=y.manner(T);break}y.build()}if(n.length>0&&i.length===0)for(let f of n){let g=e.createBuilder().define(f);g=g.mapsTo(r),g=g.withPriority(d),u&&(g=g.withDefaultSemantics(u)),g.build()}for(let[f,g]of Object.entries(o))for(let h of g){let y=e.createBuilder().define(h);y=y.mapsTo(r),y=y.withPriority(h.length===1?90:d),y=y.withDefaultSemantics({direction:f}),y.build()}}};return m},getRules(){return e.getRules()},clear(){e.clear()}}}};ef.GrammarEngine=II});var jP=p(Ou=>{"use strict";Object.defineProperty(Ou,"__esModule",{value:!0});Ou.ScopeBuilderImpl=void 0;Ou.scope=D5;var tf=class{constructor(){l(this,"constraint",{base:"all",filters:[],traitFilters:[],explicitEntities:[],includeRules:[]})}visible(){return this.constraint.base="visible",this}touchable(){return this.constraint.base="touchable",this}carried(){return this.constraint.base="carried",this}nearby(){return this.constraint.base="nearby",this}matching(e){return this.constraint.filters.push(e),this}kind(e){return this.constraint.filters.push({kind:e}),this}orExplicitly(e){return this.constraint.explicitEntities.push(...e),this}orRule(e){return this.constraint.includeRules.push(e),this}hasTrait(e){return this.constraint.traitFilters.push(e),this}build(){return{...this.constraint}}};Ou.ScopeBuilderImpl=tf;function D5(){return new tf}});var WP=p(rf=>{"use strict";Object.defineProperty(rf,"__esModule",{value:!0});rf.GrammarVocabularyProvider=void 0;var OI=class{constructor(){l(this,"categories",new Map)}define(e,r){if(this.categories.has(e))throw new Error(`Vocabulary category '${e}' already exists. Use extend() to add words.`);let n=new Set(r.words.map(i=>i.toLowerCase()));this.categories.set(e,{words:n,when:r.when})}extend(e,r){let n=this.categories.get(e);if(!n)throw new Error(`Vocabulary category '${e}' does not exist. Use define() first.`);for(let i of r)n.words.add(i.toLowerCase())}match(e,r,n){let i=this.categories.get(e);return!i||i.when&&!i.when(n)?!1:i.words.has(r.toLowerCase())}getWords(e){let r=this.categories.get(e);return r?new Set(r.words):new Set}isActive(e,r){let n=this.categories.get(e);return n?n.when?n.when(r):!0:!1}hasCategory(e){return this.categories.has(e)}getCategories(){return Array.from(this.categories.keys())}removeCategory(e){return this.categories.delete(e)}clear(){this.categories.clear()}};rf.GrammarVocabularyProvider=OI});var UP=p(Qn=>{"use strict";var L5=Qn&&Qn.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),Su=Qn&&Qn.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&L5(e,t,r)};Object.defineProperty(Qn,"__esModule",{value:!0});Su(_I(),Qn);Su(BP(),Qn);Su(xP(),Qn);Su(jP(),Qn);Su(WP(),Qn)});var jt=p(ar=>{"use strict";var M5=ar&&ar.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),Lo=ar&&ar.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&M5(e,t,r)};Object.defineProperty(ar,"__esModule",{value:!0});Lo(gP(),ar);Lo(yP(),ar);Lo(EP(),ar);Lo(_P(),ar);Lo(IP(),ar);Lo(SP(),ar);Lo(DP(),ar);Lo(PP(),ar);Lo(UP(),ar)});var qd=p(Hd=>{"use strict";Object.defineProperty(Hd,"__esModule",{value:!0});Hd.IFEventCategory=Hd.IFEvents=void 0;var HP=jt();Object.defineProperty(Hd,"IFEvents",{enumerable:!0,get:function(){return HP.IFEvents}});Object.defineProperty(Hd,"IFEventCategory",{enumerable:!0,get:function(){return HP.IFEventCategory}})});var of=p(nf=>{"use strict";Object.defineProperty(nf,"__esModule",{value:!0});nf.SwitchableBehavior=void 0;var P5=Dt(),Xn=ee(),SI=qd(),cn=class cn extends P5.Behavior{static canSwitchOn(e){let r=cn.require(e,Xn.TraitType.SWITCHABLE);return!(r.isOn||r.requiresPower&&!r.hasPower)}static canSwitchOff(e){return cn.require(e,Xn.TraitType.SWITCHABLE).isOn}static switchOn(e){let r=cn.require(e,Xn.TraitType.SWITCHABLE);return r.isOn?{success:!1,wasOn:!0}:r.requiresPower&&!r.hasPower?{success:!1,noPower:!0}:(r.isOn=!0,r.autoOffTime>0&&(r.autoOffCounter=r.autoOffTime),{success:!0,autoOffTime:r.autoOffTime>0?r.autoOffTime:void 0,powerConsumption:r.powerConsumption,runningSound:r.runningSound,onSound:r.onSound,onMessage:r.onMessage})}static switchOff(e){let r=cn.require(e,Xn.TraitType.SWITCHABLE);return r.isOn?(r.isOn=!1,r.autoOffCounter=0,{success:!0,offSound:r.offSound,offMessage:r.offMessage}):{success:!1,wasOff:!0}}static toggle(e){return cn.require(e,Xn.TraitType.SWITCHABLE).isOn?this.switchOff(e):this.switchOn(e)}static setPower(e,r){let n=cn.require(e,Xn.TraitType.SWITCHABLE),i=n.hasPower;return n.hasPower=r,!r&&n.isOn&&n.requiresPower?(n.isOn=!1,n.autoOffCounter=0,[{id:`${Date.now()}-${Math.random()}`,timestamp:Date.now(),type:SI.IFEvents.DEVICE_SWITCHED_OFF,entities:{target:e.id},data:{reason:"power_loss",customMessage:"The device powers down as it loses power."}}]):r&&!i?[{id:`${Date.now()}-${Math.random()}`,timestamp:Date.now(),type:SI.IFEvents.DEVICE_ACTIVATED,entities:{target:e.id},data:{reason:"power_restored",customMessage:"Power is restored to the device."}}]:[]}static updateTurn(e){let r=cn.require(e,Xn.TraitType.SWITCHABLE);return r.isOn&&r.autoOffCounter>0&&(r.autoOffCounter--,r.autoOffCounter===0)?(r.isOn=!1,[{id:`${Date.now()}-${Math.random()}`,timestamp:Date.now(),type:SI.IFEvents.DEVICE_SWITCHED_OFF,entities:{target:e.id},data:{reason:"auto_off",customMessage:"The device automatically switches off."}}]):[]}static isOn(e){return cn.require(e,Xn.TraitType.SWITCHABLE).isOn}static getTimeRemaining(e){let r=cn.require(e,Xn.TraitType.SWITCHABLE);return r.isOn?r.autoOffCounter:0}static getPowerConsumption(e){let r=cn.require(e,Xn.TraitType.SWITCHABLE);return r.isOn?r.powerConsumption:0}};l(cn,"requiredTraits",[Xn.TraitType.SWITCHABLE]);var AI=cn;nf.SwitchableBehavior=AI});var CI=p(af=>{"use strict";Object.defineProperty(af,"__esModule",{value:!0});af.LightSourceBehavior=void 0;var k5=Dt(),Zn=ee(),B5=of(),Ln=class Ln extends k5.Behavior{static light(e){let r=Ln.require(e,Zn.TraitType.LIGHT_SOURCE);return r.fuelRemaining!==void 0&&r.fuelRemaining<=0?!1:(r.isLit=!0,!0)}static extinguish(e){let r=Ln.require(e,Zn.TraitType.LIGHT_SOURCE);r.isLit=!1}static isLit(e){let r=Ln.require(e,Zn.TraitType.LIGHT_SOURCE);return r.isLit!==void 0?r.isLit:e.hasTrait(Zn.TraitType.SWITCHABLE)?B5.SwitchableBehavior.isOn(e):!0}static getBrightness(e){return Ln.require(e,Zn.TraitType.LIGHT_SOURCE).brightness}static getFuelRemaining(e){return Ln.require(e,Zn.TraitType.LIGHT_SOURCE).fuelRemaining}static hasFuel(e){let r=Ln.require(e,Zn.TraitType.LIGHT_SOURCE);return r.fuelRemaining===void 0||r.fuelRemaining>0}static consumeFuel(e,r){let n=Ln.require(e,Zn.TraitType.LIGHT_SOURCE);if(n.fuelRemaining===void 0)return!0;let i=r??n.fuelConsumptionRate??1;return n.fuelRemaining<i?(n.fuelRemaining=0,n.isLit=!1,!1):(n.fuelRemaining-=i,!0)}static refuel(e,r){let n=Ln.require(e,Zn.TraitType.LIGHT_SOURCE);n.fuelRemaining!==void 0&&(r===void 0&&n.maxFuel!==void 0?n.fuelRemaining=n.maxFuel:r!==void 0&&(n.fuelRemaining=n.fuelRemaining+r,n.maxFuel!==void 0&&n.fuelRemaining>n.maxFuel&&(n.fuelRemaining=n.maxFuel)))}static getFuelPercentage(e){let r=Ln.require(e,Zn.TraitType.LIGHT_SOURCE);if(!(r.fuelRemaining===void 0||r.maxFuel===void 0))return Math.round(r.fuelRemaining/r.maxFuel*100)}};l(Ln,"requiredTraits",[Zn.TraitType.LIGHT_SOURCE]);var RI=Ln;af.LightSourceBehavior=RI});var df=p(cf=>{"use strict";Object.defineProperty(cf,"__esModule",{value:!0});cf.ExitTrait=void 0;var qP=ee(),sf=class{constructor(e){l(this,"type",qP.TraitType.EXIT);l(this,"from");l(this,"to");l(this,"direction");l(this,"command");l(this,"aliases");l(this,"visible",!0);l(this,"listed",!0);l(this,"bidirectional",!1);l(this,"reverseCommand");l(this,"reverseDirection");l(this,"useMessage");l(this,"blockedMessage");l(this,"conditional",!1);l(this,"conditionId");if(!e.from||!e.to||!e.command)throw new Error("ExitTrait requires from, to, and command");this.from=e.from,this.to=e.to,this.command=e.command,e.direction!==void 0&&(this.direction=e.direction),e.aliases!==void 0&&(this.aliases=e.aliases),e.visible!==void 0&&(this.visible=e.visible),e.listed!==void 0&&(this.listed=e.listed),e.bidirectional!==void 0&&(this.bidirectional=e.bidirectional),e.reverseCommand!==void 0&&(this.reverseCommand=e.reverseCommand),e.reverseDirection!==void 0&&(this.reverseDirection=e.reverseDirection),e.useMessage!==void 0&&(this.useMessage=e.useMessage),e.blockedMessage!==void 0&&(this.blockedMessage=e.blockedMessage),e.conditional!==void 0&&(this.conditional=e.conditional),e.conditionId!==void 0&&(this.conditionId=e.conditionId)}};l(sf,"type",qP.TraitType.EXIT);cf.ExitTrait=sf});var wI=p(pf=>{"use strict";Object.defineProperty(pf,"__esModule",{value:!0});pf.ExitBehavior=void 0;var GP=Bd(),sr=ee(),FP=df(),lf=Ve(),uf=qd(),mf=class{static matchesCommand(e,r){let n=e.get(sr.TraitType.EXIT);return n?n.command.toLowerCase()===r.toLowerCase()||n.direction&&n.direction.toLowerCase()===r.toLowerCase()?!0:n.aliases?n.aliases.some(i=>i.toLowerCase()===r.toLowerCase()):!1:!1}static canUse(e,r,n){let i=e.get(sr.TraitType.EXIT);if(!i||!i.visible)return!1;if(i.conditional&&i.conditionId)return!0;if(e.has(sr.TraitType.OPENABLE)){let o=e.get(sr.TraitType.OPENABLE);if(o&&!o.isOpen)return!1}if(e.has(sr.TraitType.LOCKABLE)){let o=e.get(sr.TraitType.LOCKABLE);if(o&&o.isLocked)return!1}return!0}static use(e,r,n){let i=e.get(sr.TraitType.EXIT);if(!i)return[(0,lf.createEvent)(uf.IFEvents.ACTION_FAILED,{action:"use_exit",reason:"not_an_exit"},{target:e.id,actor:r.id})];if(!this.canUse(e,r,n)){let a=this.getBlockedReason(e);return[(0,lf.createEvent)(uf.IFEvents.ACTION_FAILED,{action:"use_exit",reason:a,message:i.blockedMessage},{target:e.id,actor:r.id})]}let o=[];return i.useMessage&&o.push((0,lf.createEvent)(uf.IFEvents.CUSTOM_MESSAGE,{message:i.useMessage},{actor:r.id})),o.push((0,lf.createEvent)(uf.IFEvents.MOVED,{from:i.from,to:i.to,via:e.id,direction:i.direction,command:i.command},{actor:r.id})),o}static getBlockedReason(e){let r=e.get(sr.TraitType.EXIT);if(!r)return"not_an_exit";if(!r.visible)return"exit_not_visible";if(e.has(sr.TraitType.LOCKABLE)){let n=e.get(sr.TraitType.LOCKABLE);if(n&&n.isLocked)return"exit_locked"}if(e.has(sr.TraitType.OPENABLE)){let n=e.get(sr.TraitType.OPENABLE);if(n&&!n.isOpen)return"exit_closed"}return r.conditional?"condition_not_met":"exit_blocked"}static getExitsFrom(e,r){return[]}static getVisibleExitsFrom(e,r){return this.getExitsFrom(e,r).filter(n=>{let i=n.get(sr.TraitType.EXIT);return i&&i.visible})}static getListedExitsFrom(e,r){return this.getExitsFrom(e,r).filter(n=>{let i=n.get(sr.TraitType.EXIT);return i&&i.visible&&i.listed})}static createBidirectional(e,r){if(!e.from||!e.to||!e.command)throw new Error("Bidirectional exit requires from, to, and command");let n=`${e.from}-to-${e.to}`,i=new GP.IFEntity(n,"exit");i.add(new FP.ExitTrait({...e,bidirectional:!0}));let o=`${e.to}-to-${e.from}`,a=new GP.IFEntity(o,"exit"),s={from:e.to,to:e.from,command:e.reverseCommand||this.getReverseCommand(e.command),direction:e.reverseDirection||this.getReverseDirection(e.direction),visible:e.visible,listed:e.listed,bidirectional:!0};return a.add(new FP.ExitTrait(s)),[i,a]}static getReverseDirection(e){return e?{north:"south",south:"north",east:"west",west:"east",northeast:"southwest",northwest:"southeast",southeast:"northwest",southwest:"northeast",up:"down",down:"up",in:"out",out:"in"}[e.toLowerCase()]:void 0}static getReverseCommand(e){let r=e.replace(/^go\s+/,""),n=this.getReverseDirection(r);return n?e.startsWith("go ")?`go ${n}`:n:"go back"}};l(mf,"requiredTraits",[sr.TraitType.EXIT]);pf.ExitBehavior=mf});var DI=p(ff=>{"use strict";Object.defineProperty(ff,"__esModule",{value:!0});ff.ClimbableBehavior=void 0;var Qa=ee(),NI=class{static isClimbable(e){return e.has(Qa.TraitType.CLIMBABLE)?e.get(Qa.TraitType.CLIMBABLE).canClimb:!1}static climb(e){if(!e.has(Qa.TraitType.CLIMBABLE))return{success:!1,blocked:!0,blockedReason:"not_climbable"};let r=e.get(Qa.TraitType.CLIMBABLE);return r.canClimb?{success:!0,destination:r.destination,direction:r.direction,successMessage:r.successMessage}:{success:!1,blocked:!0,blockedReason:r.blockedMessage||"cant_climb"}}static getDirection(e){return e.has(Qa.TraitType.CLIMBABLE)?e.get(Qa.TraitType.CLIMBABLE).direction:void 0}static getDestination(e){return e.has(Qa.TraitType.CLIMBABLE)?e.get(Qa.TraitType.CLIMBABLE).destination:void 0}};ff.ClimbableBehavior=NI});var MI=p(gf=>{"use strict";Object.defineProperty(gf,"__esModule",{value:!0});gf.OpenableBehavior=void 0;var x5=Dt(),Xa=ee(),Mn=class Mn extends x5.Behavior{static canOpen(e){return!Mn.require(e,Xa.TraitType.OPENABLE).isOpen}static canClose(e){let r=Mn.require(e,Xa.TraitType.OPENABLE);return r.isOpen&&r.canClose}static open(e){let r=Mn.require(e,Xa.TraitType.OPENABLE);return r.isOpen?{success:!1,alreadyOpen:!0,stateChanged:!1}:(r.isOpen=!0,{success:!0,stateChanged:!0,openMessage:r.openMessage,openSound:r.openSound,revealsContents:r.revealsContents})}static close(e){let r=Mn.require(e,Xa.TraitType.OPENABLE);return r.isOpen?r.canClose?(r.isOpen=!1,{success:!0,stateChanged:!0,closeMessage:r.closeMessage,closeSound:r.closeSound}):{success:!1,cantClose:!0,stateChanged:!1}:{success:!1,alreadyClosed:!0,stateChanged:!1}}static toggle(e){return Mn.require(e,Xa.TraitType.OPENABLE).isOpen?Mn.close(e):Mn.open(e)}static isOpen(e){return Mn.require(e,Xa.TraitType.OPENABLE).isOpen}static revealsContents(e){return Mn.require(e,Xa.TraitType.OPENABLE).revealsContents}};l(Mn,"requiredTraits",[Xa.TraitType.OPENABLE]);var LI=Mn;gf.OpenableBehavior=LI});var kI=p(hf=>{"use strict";Object.defineProperty(hf,"__esModule",{value:!0});hf.LockableBehavior=void 0;var j5=Dt(),$t=ee(),Qt=class Qt extends j5.Behavior{static canUnlockWith(e,r){let n=Qt.require(e,$t.TraitType.LOCKABLE);return!!(n.keyId===r||n.keyIds&&n.keyIds.includes(r))}static canLockWith(e,r){return this.canUnlockWith(e,r)}static requiresKey(e){let r=Qt.require(e,$t.TraitType.LOCKABLE);return!!(r.keyId||r.keyIds?.length)}static canLock(e){let r=Qt.require(e,$t.TraitType.LOCKABLE);return e.has($t.TraitType.OPENABLE)&&e.get($t.TraitType.OPENABLE).isOpen?!1:!r.isLocked}static canUnlock(e){return Qt.require(e,$t.TraitType.LOCKABLE).isLocked}static lock(e,r){let n=Qt.require(e,$t.TraitType.LOCKABLE);if(n.isLocked)return{success:!1,alreadyLocked:!0,stateChanged:!1};if(e.has($t.TraitType.OPENABLE)&&e.get($t.TraitType.OPENABLE).isOpen)return{success:!1,notClosed:!0,stateChanged:!1};if(Qt.requiresKey(e)){if(!r)return{success:!1,noKey:!0,stateChanged:!1};if(!this.canLockWith(e,r.id))return{success:!1,wrongKey:!0,stateChanged:!1}}return n.isLocked=!0,{success:!0,stateChanged:!0,lockMessage:n.lockMessage,lockSound:n.lockSound}}static unlock(e,r){let n=Qt.require(e,$t.TraitType.LOCKABLE);if(!n.isLocked)return{success:!1,alreadyUnlocked:!0,stateChanged:!1};if(Qt.requiresKey(e)){if(!r)return{success:!1,noKey:!0,stateChanged:!1};if(!this.canUnlockWith(e,r.id))return{success:!1,wrongKey:!0,stateChanged:!1}}return n.isLocked=!1,{success:!0,stateChanged:!0,unlockMessage:n.unlockMessage,unlockSound:n.unlockSound}}static forceUnlock(e){let r=Qt.require(e,$t.TraitType.LOCKABLE);r.isLocked=!1}static isLocked(e){return Qt.require(e,$t.TraitType.LOCKABLE).isLocked}static handleClose(e){let r=Qt.require(e,$t.TraitType.LOCKABLE);return r.autoLock&&!r.isLocked?this.lock(e):null}static canOpen(e){return!Qt.require(e,$t.TraitType.LOCKABLE).isLocked}static getLockedMessage(e){return Qt.require(e,$t.TraitType.LOCKABLE).lockedMessage}};l(Qt,"requiredTraits",[$t.TraitType.LOCKABLE]);var PI=Qt;hf.LockableBehavior=PI});var xI=p(yf=>{"use strict";Object.defineProperty(yf,"__esModule",{value:!0});yf.WeaponBehavior=void 0;var W5=Dt(),Pi=ee(),Gd=class Gd extends W5.Behavior{static calculateDamage(e){if(!e.has(Pi.TraitType.WEAPON))throw new Error(`Entity "${e.id}" is not a weapon`);let r=e.get(Pi.TraitType.WEAPON),n=r.maxDamage-r.minDamage,i=r.minDamage+Math.floor(Math.random()*(n+1)),o=Math.random()<.1,a=o?i*2:i,s=!1;return r.breakable&&r.durability!==void 0&&(r.durability--,r.durability<=0&&(s=!0)),{damage:a,weaponType:r.weaponType,criticalHit:o,weaponBroke:s}}static canDamage(e,r){if(!e.has(Pi.TraitType.WEAPON))return!1;if(!r)return!0;let n=e.get(Pi.TraitType.WEAPON);switch(r){case"ghost":case"spirit":return n.weaponType==="magic"||n.weaponType==="blessed";case"armor":case"metal":return n.weaponType==="piercing"||n.weaponType==="magic";default:return!0}}static getWeaponType(e){return Gd.require(e,Pi.TraitType.WEAPON).weaponType}static isTwoHanded(e){return Gd.require(e,Pi.TraitType.WEAPON).twoHanded}static repair(e){let r=Gd.require(e,Pi.TraitType.WEAPON);return r.breakable?(r.durability=r.maxDurability,!0):!1}static isBroken(e){if(!e.has(Pi.TraitType.WEAPON))return!1;let r=e.get(Pi.TraitType.WEAPON);return r.breakable?r.durability!==void 0&&r.durability<=0:!1}};l(Gd,"requiredTraits",[Pi.TraitType.WEAPON]);var BI=Gd;yf.WeaponBehavior=BI});var jI=p(Ef=>{"use strict";Object.defineProperty(Ef,"__esModule",{value:!0});Ef.BreakableBehavior=void 0;var U5=Dt(),dc=ee(),Tf=class extends U5.Behavior{static canBreak(e){return e.has(dc.TraitType.BREAKABLE)?!e.get(dc.TraitType.BREAKABLE).broken:!1}static break(e,r){if(!e.has(dc.TraitType.BREAKABLE))return{success:!1,message:"Entity is not breakable"};let n=e.get(dc.TraitType.BREAKABLE);if(n.broken)return{success:!1,alreadyBroken:!0};n.broken=!0;let i={success:!0};return i.itemRemoved=!1,i}static isBroken(e){return e.has(dc.TraitType.BREAKABLE)?e.get(dc.TraitType.BREAKABLE).broken:!1}};l(Tf,"requiredTraits",[dc.TraitType.BREAKABLE]);Ef.BreakableBehavior=Tf});var UI=p(vf=>{"use strict";Object.defineProperty(vf,"__esModule",{value:!0});vf.DestructibleBehavior=void 0;var H5=Dt(),Mo=ee(),Au=class Au extends H5.Behavior{static canDamage(e,r){if(!e.has(Mo.TraitType.DESTRUCTIBLE))return!1;let n=e.get(Mo.TraitType.DESTRUCTIBLE);return!(n.invulnerable||n.hitPoints<=0||n.requiresWeapon&&!r||n.requiresType&&r!==n.requiresType)}static damage(e,r,n,i){if(!e.has(Mo.TraitType.DESTRUCTIBLE))return{success:!1,damage:0,destroyed:!1,remainingHitPoints:0,message:"Entity is not destructible"};let o=e.get(Mo.TraitType.DESTRUCTIBLE);if(o.invulnerable)return{success:!1,damage:0,destroyed:!1,remainingHitPoints:o.hitPoints,invulnerable:!0};if(o.requiresWeapon&&!n)return{success:!1,damage:0,destroyed:!1,remainingHitPoints:o.hitPoints,requiresWeapon:!0};if(o.requiresType&&n!==o.requiresType)return{success:!1,damage:0,destroyed:!1,remainingHitPoints:o.hitPoints,wrongWeaponType:!0};let a=Math.max(1,r-o.armor);o.hitPoints=Math.max(0,o.hitPoints-a);let s={success:!0,damage:a,destroyed:o.hitPoints<=0,remainingHitPoints:o.hitPoints,message:o.hitPoints>0?o.damageMessage:o.destroyMessage};if(o.hitPoints<=0){if(o.transformTo){let c=i.getLocation(e.id),d=`transformed ${e.id}`,u=i.createEntity(d,o.transformTo);c&&u&&(i.moveEntity(u.id,c),s.transformedTo=u.id,i.removeEntity(e.id))}o.revealExit&&(s.exitRevealed=o.revealExit)}return s}static isDestroyed(e){return e.has(Mo.TraitType.DESTRUCTIBLE)?e.get(Mo.TraitType.DESTRUCTIBLE).hitPoints<=0:!1}static getHitPoints(e){return Au.require(e,Mo.TraitType.DESTRUCTIBLE).hitPoints}static repair(e){let r=Au.require(e,Mo.TraitType.DESTRUCTIBLE);return r.hitPoints>=r.maxHitPoints?!1:(r.hitPoints=r.maxHitPoints,!0)}};l(Au,"requiredTraits",[Mo.TraitType.DESTRUCTIBLE]);var WI=Au;vf.DestructibleBehavior=WI});var qI=p(_f=>{"use strict";Object.defineProperty(_f,"__esModule",{value:!0});_f.CombatBehavior=void 0;var q5=Dt(),cr=ee(),lc=class lc extends q5.Behavior{static canAttack(e){if(!e.has(cr.TraitType.COMBATANT))return!1;let r=e.get(cr.TraitType.COMBATANT);return r.isAlive&&r.health>0}static attack(e,r,n){if(!e.has(cr.TraitType.COMBATANT))return{success:!1,damage:0,killed:!1,remainingHealth:0,message:"Entity is not a combatant"};let i=e.get(cr.TraitType.COMBATANT);if(!i.isAlive||i.health<=0)return{success:!1,damage:0,killed:!1,remainingHealth:0};let o=Math.max(1,r-i.armor);i.health=Math.max(0,i.health-o);let a={success:!0,damage:o,killed:i.health<=0,remainingHealth:i.health,message:i.hitMessage,retaliated:i.canRetaliate&&i.health>0};if(i.health<=0&&(i.isAlive=!1,a.deathMessage=i.deathMessage,i.dropsInventory)){let s=n.getLocation(e.id),c=n.getContents(e.id),d=[];if(s)for(let u of c)n.moveEntity(u.id,s),d.push(u.id);d.length>0&&(a.droppedItems=d)}return a}static heal(e,r){if(!e.has(cr.TraitType.COMBATANT))return 0;let n=e.get(cr.TraitType.COMBATANT);if(!n.isAlive)return 0;let i=n.health;return n.health=Math.min(n.maxHealth,n.health+r),n.health-i}static resurrect(e){if(!e.has(cr.TraitType.COMBATANT))return!1;let r=e.get(cr.TraitType.COMBATANT);return r.isAlive?!1:(r.isAlive=!0,r.health=r.maxHealth,!0)}static isAlive(e){if(!e.has(cr.TraitType.COMBATANT))return!0;let r=e.get(cr.TraitType.COMBATANT);return r.isAlive&&r.health>0}static getHealth(e){return lc.require(e,cr.TraitType.COMBATANT).health}static getHealthPercentage(e){let r=lc.require(e,cr.TraitType.COMBATANT);return r.health/r.maxHealth*100}static isHostile(e){return lc.require(e,cr.TraitType.COMBATANT).hostile}static setHostile(e,r){let n=lc.require(e,cr.TraitType.COMBATANT);n.hostile=r}};l(lc,"requiredTraits",[cr.TraitType.COMBATANT]);var HI=lc;_f.CombatBehavior=HI});var VP=p(bf=>{"use strict";Object.defineProperty(bf,"__esModule",{value:!0});bf.AttackBehavior=void 0;var Br=ee(),G5=xI(),F5=jI(),V5=UI(),Y5=qI(),GI=class{static attack(e,r,n){let i=1,o,a;if(r&&r.has(Br.TraitType.WEAPON)&&(a=G5.WeaponBehavior.calculateDamage(r),i=a.damage,o=a.weaponType),e.has(Br.TraitType.BREAKABLE)){let s=F5.BreakableBehavior.break(e,n);if(s.success)return{success:!0,type:"broke",damage:i,targetDestroyed:!0,debrisCreated:s.debrisCreated,weaponBroke:a?.weaponBroke,message:s.message}}if(e.has(Br.TraitType.DESTRUCTIBLE)){let s=V5.DestructibleBehavior.damage(e,i,o,n);return s.success?{success:!0,type:s.destroyed?"destroyed":"damaged",damage:s.damage,remainingHitPoints:s.remainingHitPoints,targetDestroyed:s.destroyed,transformedTo:s.transformedTo,exitRevealed:s.exitRevealed,weaponBroke:a?.weaponBroke,message:s.message}:{success:!1,type:"ineffective",damage:0,message:s.requiresWeapon?"You need a weapon to damage that.":s.wrongWeaponType?"That weapon won't work on this target.":s.invulnerable?"That cannot be damaged.":"Your attack has no effect."}}if(e.has(Br.TraitType.COMBATANT)){let s=Y5.CombatBehavior.attack(e,i,n);if(s.success)return{success:!0,type:s.killed?"killed":"hit",damage:s.damage,remainingHitPoints:s.remainingHealth,targetKilled:s.killed,itemsDropped:s.droppedItems,weaponBroke:a?.weaponBroke,message:s.killed?s.deathMessage:s.message}}return{success:!1,type:"ineffective",damage:0,message:"Your attack has no effect on that."}}static canAttack(e,r){return e.has(Br.TraitType.BREAKABLE)||e.has(Br.TraitType.DESTRUCTIBLE)||e.has(Br.TraitType.COMBATANT)}static inferWeapon(e){let r=e.filter(i=>i.has(Br.TraitType.WEAPON));if(r.length===0)return;let n=r.filter(i=>{if(!i.has(Br.TraitType.EQUIPPED))return!1;let o=i.get(Br.TraitType.EQUIPPED);return o&&o.isEquipped});return n.length>0?n.reduce((i,o)=>{let a=i.get(Br.TraitType.WEAPON),s=o.get(Br.TraitType.WEAPON);if(!a||!s)return i;let c=a.maxDamage||0;return(s.maxDamage||0)>c?o:i}):r.reduce((i,o)=>{let a=i.get(Br.TraitType.WEAPON),s=o.get(Br.TraitType.WEAPON);if(!a||!s)return i;let c=a.maxDamage||0;return(s.maxDamage||0)>c?o:i})}};bf.AttackBehavior=GI});var zP=p(ve=>{"use strict";Object.defineProperty(ve,"__esModule",{value:!0});ve.AttackBehavior=ve.CombatBehavior=ve.DestructibleBehavior=ve.BreakableBehavior=ve.WeaponBehavior=ve.LockableBehavior=ve.OpenableBehavior=ve.ClimbableBehavior=ve.ExitBehavior=ve.LightSourceBehavior=ve.ReadableBehavior=ve.WearableBehavior=ve.SceneryBehavior=ve.ContainerBehavior=ve.isWorldAwareBehavior=ve.Behavior=void 0;var YP=Dt();Object.defineProperty(ve,"Behavior",{enumerable:!0,get:function(){return YP.Behavior}});Object.defineProperty(ve,"isWorldAwareBehavior",{enumerable:!0,get:function(){return YP.isWorldAwareBehavior}});var z5=Gp();Object.defineProperty(ve,"ContainerBehavior",{enumerable:!0,get:function(){return z5.ContainerBehavior}});var K5=gI();Object.defineProperty(ve,"SceneryBehavior",{enumerable:!0,get:function(){return K5.SceneryBehavior}});var $5=bu();Object.defineProperty(ve,"WearableBehavior",{enumerable:!0,get:function(){return $5.WearableBehavior}});var Q5=hI();Object.defineProperty(ve,"ReadableBehavior",{enumerable:!0,get:function(){return Q5.ReadableBehavior}});var X5=CI();Object.defineProperty(ve,"LightSourceBehavior",{enumerable:!0,get:function(){return X5.LightSourceBehavior}});var Z5=wI();Object.defineProperty(ve,"ExitBehavior",{enumerable:!0,get:function(){return Z5.ExitBehavior}});var J5=DI();Object.defineProperty(ve,"ClimbableBehavior",{enumerable:!0,get:function(){return J5.ClimbableBehavior}});var eQ=MI();Object.defineProperty(ve,"OpenableBehavior",{enumerable:!0,get:function(){return eQ.OpenableBehavior}});var tQ=kI();Object.defineProperty(ve,"LockableBehavior",{enumerable:!0,get:function(){return tQ.LockableBehavior}});var rQ=xI();Object.defineProperty(ve,"WeaponBehavior",{enumerable:!0,get:function(){return rQ.WeaponBehavior}});var nQ=jI();Object.defineProperty(ve,"BreakableBehavior",{enumerable:!0,get:function(){return nQ.BreakableBehavior}});var iQ=UI();Object.defineProperty(ve,"DestructibleBehavior",{enumerable:!0,get:function(){return iQ.DestructibleBehavior}});var oQ=qI();Object.defineProperty(ve,"CombatBehavior",{enumerable:!0,get:function(){return oQ.CombatBehavior}});var aQ=VP();Object.defineProperty(ve,"AttackBehavior",{enumerable:!0,get:function(){return aQ.AttackBehavior}})});var FI=p(If=>{"use strict";Object.defineProperty(If,"__esModule",{value:!0});If.ActionFailureReason=void 0;If.ActionFailureReason={NOT_VISIBLE:"not_visible",NOT_REACHABLE:"not_reachable",NOT_IN_SCOPE:"not_in_scope",FIXED_IN_PLACE:"fixed_in_place",ALREADY_OPEN:"already_open",ALREADY_CLOSED:"already_closed",NOT_OPENABLE:"not_openable",LOCKED:"locked",NOT_LOCKABLE:"not_lockable",ALREADY_LOCKED:"already_locked",ALREADY_UNLOCKED:"already_unlocked",CONTAINER_FULL:"container_full",CONTAINER_CLOSED:"container_closed",NOT_A_CONTAINER:"not_a_container",NOT_A_SUPPORTER:"not_a_supporter",ALREADY_IN_CONTAINER:"already_in_container",NOT_WEARABLE:"not_wearable",ALREADY_WEARING:"already_wearing",NOT_WEARING:"not_wearing",WORN_BY_OTHER:"worn_by_other",TOO_HEAVY:"too_heavy",CARRYING_TOO_MUCH:"carrying_too_much",WRONG_KEY:"wrong_key",NO_KEY_SPECIFIED:"no_key_specified",NOT_A_KEY:"not_a_key",ALREADY_ON:"already_on",ALREADY_OFF:"already_off",NOT_SWITCHABLE:"not_switchable",NO_POWER:"no_power",NO_EXIT_THAT_WAY:"no_exit_that_way",CANT_GO_THAT_WAY:"cant_go_that_way",DOOR_CLOSED:"door_closed",DOOR_LOCKED:"door_locked",CANT_DO_THAT:"cant_do_that",NOT_IMPLEMENTED:"not_implemented",INVALID_TARGET:"invalid_target",NOTHING_HAPPENS:"nothing_happens",ACTOR_CANT_SEE:"actor_cant_see",ACTOR_CANT_REACH:"actor_cant_reach",ACTOR_BUSY:"actor_busy",NOT_EDIBLE:"not_edible",NOTHING_LEFT:"nothing_left",NOT_READABLE:"not_readable",NOTHING_WRITTEN:"nothing_written"}});var VI=p(_e=>{"use strict";Object.defineProperty(_e,"__esModule",{value:!0});_e.DirectionOpposites=_e.Direction=void 0;_e.getOppositeDirection=sQ;_e.isDirection=cQ;_e.Direction={NORTH:"NORTH",SOUTH:"SOUTH",EAST:"EAST",WEST:"WEST",NORTHEAST:"NORTHEAST",NORTHWEST:"NORTHWEST",SOUTHEAST:"SOUTHEAST",SOUTHWEST:"SOUTHWEST",UP:"UP",DOWN:"DOWN",IN:"IN",OUT:"OUT"};_e.DirectionOpposites={[_e.Direction.NORTH]:_e.Direction.SOUTH,[_e.Direction.SOUTH]:_e.Direction.NORTH,[_e.Direction.EAST]:_e.Direction.WEST,[_e.Direction.WEST]:_e.Direction.EAST,[_e.Direction.NORTHEAST]:_e.Direction.SOUTHWEST,[_e.Direction.NORTHWEST]:_e.Direction.SOUTHEAST,[_e.Direction.SOUTHEAST]:_e.Direction.NORTHWEST,[_e.Direction.SOUTHWEST]:_e.Direction.NORTHEAST,[_e.Direction.UP]:_e.Direction.DOWN,[_e.Direction.DOWN]:_e.Direction.UP,[_e.Direction.IN]:_e.Direction.OUT,[_e.Direction.OUT]:_e.Direction.IN};function sQ(t){return _e.DirectionOpposites[t]}function cQ(t){return typeof t=="string"&&Object.values(_e.Direction).includes(t)}});var KP=p(Po=>{"use strict";var dQ=Po&&Po.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),YI=Po&&Po.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&dQ(e,t,r)};Object.defineProperty(Po,"__esModule",{value:!0});YI(FI(),Po);YI(qd(),Po);YI(VI(),Po)});var QP=p(Of=>{"use strict";Object.defineProperty(Of,"__esModule",{value:!0});Of.PartOfSpeech=void 0;var $P;(function(t){t.VERB="VERB",t.NOUN="NOUN",t.ADJECTIVE="ADJECTIVE",t.ARTICLE="ARTICLE",t.PREPOSITION="PREPOSITION",t.PRONOUN="PRONOUN",t.DETERMINER="DETERMINER",t.CONJUNCTION="CONJUNCTION",t.UNKNOWN="UNKNOWN"})($P||(Of.PartOfSpeech=$P={}))});var ZP=p(XP=>{"use strict";Object.defineProperty(XP,"__esModule",{value:!0})});var ek=p(JP=>{"use strict";Object.defineProperty(JP,"__esModule",{value:!0})});var tk=p(ko=>{"use strict";var lQ=ko&&ko.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),zI=ko&&ko.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&lQ(e,t,r)};Object.defineProperty(ko,"__esModule",{value:!0});zI(QP(),ko);zI(ZP(),ko);zI(ek(),ko)});var nk=p(rk=>{"use strict";Object.defineProperty(rk,"__esModule",{value:!0})});var ok=p(ik=>{"use strict";Object.defineProperty(ik,"__esModule",{value:!0})});var sk=p(ak=>{"use strict";Object.defineProperty(ak,"__esModule",{value:!0})});var dk=p(ck=>{"use strict";Object.defineProperty(ck,"__esModule",{value:!0})});var lk=p(ki=>{"use strict";var uQ=ki&&ki.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),Sf=ki&&ki.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&uQ(e,t,r)};Object.defineProperty(ki,"__esModule",{value:!0});Sf(nk(),ki);Sf(ok(),ki);Sf(sk(),ki);Sf(dk(),ki)});var Cf=p(Rf=>{"use strict";Object.defineProperty(Rf,"__esModule",{value:!0});Rf.IdentityTrait=void 0;var uk=ee(),Af=class{constructor(e){l(this,"type",uk.TraitType.IDENTITY);l(this,"name","");l(this,"description","");l(this,"nameId");l(this,"descriptionId");l(this,"aliases",[]);l(this,"brief");l(this,"properName",!1);l(this,"article","a");l(this,"concealed",!1);l(this,"weight");l(this,"volume");l(this,"size");l(this,"grammaticalNumber");l(this,"adjectives",[]);l(this,"nounType");l(this,"points");l(this,"pointsDescription");e&&Object.assign(this,e)}};l(Af,"type",uk.TraitType.IDENTITY);Rf.IdentityTrait=Af});var KI=p(Nf=>{"use strict";Object.defineProperty(Nf,"__esModule",{value:!0});Nf.ContainerTrait=void 0;var mk=ee(),wf=class{constructor(e){l(this,"type",mk.TraitType.CONTAINER);l(this,"capacity");l(this,"isTransparent");l(this,"enterable");l(this,"allowedTypes");l(this,"excludedTypes");this.isTransparent=!1,this.enterable=!1,e&&(e.capacity!==void 0&&(this.capacity=e.capacity),e.isTransparent!==void 0&&(this.isTransparent=e.isTransparent),e.enterable!==void 0&&(this.enterable=e.enterable),e.allowedTypes!==void 0&&(this.allowedTypes=e.allowedTypes),e.excludedTypes!==void 0&&(this.excludedTypes=e.excludedTypes))}};l(wf,"type",mk.TraitType.CONTAINER);Nf.ContainerTrait=wf});var $I=p(Lf=>{"use strict";Object.defineProperty(Lf,"__esModule",{value:!0});Lf.SupporterTrait=void 0;var pk=ee(),Df=class{constructor(e){l(this,"type",pk.TraitType.SUPPORTER);l(this,"capacity");l(this,"enterable",!1);l(this,"allowedTypes");l(this,"excludedTypes");e&&Object.assign(this,e)}};l(Df,"type",pk.TraitType.SUPPORTER);Lf.SupporterTrait=Df});var QI=p(Pf=>{"use strict";Object.defineProperty(Pf,"__esModule",{value:!0});Pf.RoomTrait=void 0;var fk=ee(),Mf=class{constructor(e={}){l(this,"type",fk.TraitType.ROOM);l(this,"visited");l(this,"exits");l(this,"blockedExits");l(this,"outdoor");l(this,"isDark");l(this,"isOutdoors");l(this,"isUnderground");l(this,"initialDescription");l(this,"initialDescriptionId");l(this,"ambientSound");l(this,"ambientSmell");l(this,"region");l(this,"tags");l(this,"capacity");l(this,"allowedTypes");l(this,"excludedTypes");l(this,"isTransparent",!0);l(this,"enterable",!0);this.visited=e.visited??!1,this.exits=e.exits??{},this.blockedExits=e.blockedExits,this.outdoor=e.outdoor??!1,this.isDark=e.isDark??!1,this.isOutdoors=e.isOutdoors??!1,this.isUnderground=e.isUnderground??!1,this.initialDescription=e.initialDescription,this.initialDescriptionId=e.initialDescriptionId,this.ambientSound=e.ambientSound,this.ambientSmell=e.ambientSmell,this.region=e.region,this.tags=e.tags??[],this.capacity=e.capacity,this.allowedTypes=e.allowedTypes,this.excludedTypes=e.excludedTypes}};l(Mf,"type",fk.TraitType.ROOM);Pf.RoomTrait=Mf});var XI=p(Bf=>{"use strict";Object.defineProperty(Bf,"__esModule",{value:!0});Bf.WearableTrait=void 0;var gk=ee(),kf=class{constructor(e={}){l(this,"type",gk.TraitType.WEARABLE);l(this,"worn",!1);l(this,"wornBy");l(this,"slot");l(this,"layer");l(this,"wearMessage");l(this,"removeMessage");l(this,"wearableOver");l(this,"blocksSlots");l(this,"weight");l(this,"bulk");l(this,"canRemove");l(this,"bodyPart");this.worn=e.isWorn??!1,this.wornBy=e.wornBy,this.slot=e.slot??"clothing",this.layer=e.layer??1,this.wearMessage=e.wearMessage,this.removeMessage=e.removeMessage,this.wearableOver=e.wearableOver??!0,this.blocksSlots=e.blocksSlots??[],this.weight=e.weight??1,this.bulk=e.bulk??1,this.canRemove=e.canRemove??!0,this.bodyPart=e.bodyPart??"torso"}get isWorn(){return this.worn}set isWorn(e){this.worn=e}};l(kf,"type",gk.TraitType.WEARABLE);Bf.WearableTrait=kf});var ZI=p(jf=>{"use strict";Object.defineProperty(jf,"__esModule",{value:!0});jf.ClothingTrait=void 0;var hk=ee(),xf=class{constructor(e={}){l(this,"type",hk.TraitType.CLOTHING);l(this,"worn",!1);l(this,"wornBy");l(this,"slot");l(this,"layer");l(this,"wearMessage");l(this,"removeMessage");l(this,"wearableOver");l(this,"blocksSlots");l(this,"weight");l(this,"bulk");l(this,"canRemove");l(this,"bodyPart");l(this,"material");l(this,"style");l(this,"damageable");l(this,"condition");this.worn=e.isWorn??!1,this.wornBy=e.wornBy,this.slot=e.slot??"clothing",this.layer=e.layer??1,this.wearMessage=e.wearMessage,this.removeMessage=e.removeMessage,this.wearableOver=e.wearableOver??!0,this.blocksSlots=e.blocksSlots??[],this.weight=e.weight??1,this.bulk=e.bulk??1,this.canRemove=e.canRemove??!0,this.bodyPart=e.bodyPart??"torso",this.material=e.material??"fabric",this.style=e.style??"casual",this.damageable=e.damageable??!0,this.condition=e.condition??"good"}get isWorn(){return this.worn}set isWorn(e){this.worn=e}};l(xf,"type",hk.TraitType.CLOTHING);jf.ClothingTrait=xf});var JI=p(Uf=>{"use strict";Object.defineProperty(Uf,"__esModule",{value:!0});Uf.EdibleTrait=void 0;var yk=ee(),Wf=class{constructor(e={}){l(this,"type",yk.TraitType.EDIBLE);l(this,"nutrition");l(this,"servings");l(this,"liquid");l(this,"consumeMessage");l(this,"remainsType");l(this,"hasEffect");l(this,"effectDescription");l(this,"weight");l(this,"bulk");l(this,"taste");l(this,"effects");l(this,"satisfiesHunger");let r=e.servings??e.portions??1;this.servings=e.consumed?0:r,this.nutrition=e.nutrition??1,this.liquid=e.liquid??e.isDrink??!1,this.consumeMessage=e.consumeMessage,this.remainsType=e.remainsType,this.hasEffect=e.hasEffect??(e.effects&&e.effects.length>0)??!1,this.effectDescription=e.effectDescription,this.weight=e.weight??1,this.bulk=e.bulk??1,this.taste=e.taste,this.effects=e.effects,this.satisfiesHunger=e.satisfiesHunger}};l(Wf,"type",yk.TraitType.EDIBLE);Uf.EdibleTrait=Wf});var eO=p(qf=>{"use strict";Object.defineProperty(qf,"__esModule",{value:!0});qf.SceneryTrait=void 0;var Tk=ee(),Hf=class{constructor(e){l(this,"type",Tk.TraitType.SCENERY);l(this,"cantTakeMessage");l(this,"mentioned",!0);l(this,"visible",!0);e&&Object.assign(this,e)}};l(Hf,"type",Tk.TraitType.SCENERY);qf.SceneryTrait=Hf});var Ru=p(Ff=>{"use strict";Object.defineProperty(Ff,"__esModule",{value:!0});Ff.OpenableTrait=void 0;var Ek=ee(),Gf=class{constructor(e={}){l(this,"type",Ek.TraitType.OPENABLE);l(this,"isOpen");l(this,"startsOpen");l(this,"openMessage");l(this,"closeMessage");l(this,"alreadyOpenMessage");l(this,"alreadyClosedMessage");l(this,"revealsContents");l(this,"canClose");l(this,"openSound");l(this,"closeSound");this.startsOpen=e.startsOpen??!1,this.isOpen=e.isOpen??this.startsOpen,this.openMessage=e.openMessage,this.closeMessage=e.closeMessage,this.alreadyOpenMessage=e.alreadyOpenMessage,this.alreadyClosedMessage=e.alreadyClosedMessage,this.revealsContents=e.revealsContents??!0,this.canClose=e.canClose??!0,this.openSound=e.openSound,this.closeSound=e.closeSound}};l(Gf,"type",Ek.TraitType.OPENABLE);Ff.OpenableTrait=Gf});var Cu=p(Yf=>{"use strict";Object.defineProperty(Yf,"__esModule",{value:!0});Yf.LockableTrait=void 0;var vk=ee(),Vf=class{constructor(e={}){l(this,"type",vk.TraitType.LOCKABLE);l(this,"isLocked");l(this,"startsLocked");l(this,"keyId");l(this,"keyIds");l(this,"acceptsMasterKey");l(this,"lockMessage");l(this,"unlockMessage");l(this,"alreadyLockedMessage");l(this,"alreadyUnlockedMessage");l(this,"lockedMessage");l(this,"wrongKeyMessage");l(this,"autoLock");l(this,"lockSound");l(this,"unlockSound");this.startsLocked=e.startsLocked??!1,this.isLocked=e.isLocked??this.startsLocked,this.keyId=e.keyId,this.keyIds=e.keyIds,this.acceptsMasterKey=e.acceptsMasterKey??!0,this.lockMessage=e.lockMessage,this.unlockMessage=e.unlockMessage,this.alreadyLockedMessage=e.alreadyLockedMessage,this.alreadyUnlockedMessage=e.alreadyUnlockedMessage,this.lockedMessage=e.lockedMessage,this.wrongKeyMessage=e.wrongKeyMessage,this.autoLock=e.autoLock??!1,this.lockSound=e.lockSound,this.unlockSound=e.unlockSound}};l(Vf,"type",vk.TraitType.LOCKABLE);Yf.LockableTrait=Vf});var tO=p(Kf=>{"use strict";Object.defineProperty(Kf,"__esModule",{value:!0});Kf.SwitchableTrait=void 0;var _k=ee(),zf=class{constructor(e={}){l(this,"type",_k.TraitType.SWITCHABLE);l(this,"isOn");l(this,"startsOn");l(this,"powerConsumption");l(this,"requiresPower");l(this,"hasPower");l(this,"onMessage");l(this,"offMessage");l(this,"alreadyOnMessage");l(this,"alreadyOffMessage");l(this,"noPowerMessage");l(this,"onSound");l(this,"offSound");l(this,"runningSound");l(this,"autoOffTime");l(this,"autoOffCounter");this.startsOn=e.startsOn??!1,this.requiresPower=e.requiresPower??!1,this.hasPower=e.hasPower??!0,this.isOn=e.isOn??(this.startsOn&&this.hasPower),this.powerConsumption=e.powerConsumption??1,this.onMessage=e.onMessage,this.offMessage=e.offMessage,this.alreadyOnMessage=e.alreadyOnMessage,this.alreadyOffMessage=e.alreadyOffMessage,this.noPowerMessage=e.noPowerMessage,this.onSound=e.onSound,this.offSound=e.offSound,this.runningSound=e.runningSound,this.autoOffTime=e.autoOffTime??0,this.autoOffCounter=e.autoOffCounter??(this.isOn&&this.autoOffTime>0?this.autoOffTime:0)}};l(zf,"type",_k.TraitType.SWITCHABLE);Kf.SwitchableTrait=zf});var rO=p(Qf=>{"use strict";Object.defineProperty(Qf,"__esModule",{value:!0});Qf.ReadableTrait=void 0;var bk=ee(),$f=class{constructor(e){l(this,"type",bk.TraitType.READABLE);l(this,"text","");l(this,"preview");l(this,"isReadable",!0);l(this,"language","common");l(this,"requiresAbility",!1);l(this,"requiredAbility");l(this,"cannotReadMessage");l(this,"hasBeenRead",!1);l(this,"readableType","text");l(this,"pages");l(this,"currentPage");l(this,"pageContent");e&&Object.assign(this,e),this.pageContent&&this.pageContent.length>0&&!this.currentPage&&(this.currentPage=1,this.pages=this.pageContent.length)}};l($f,"type",bk.TraitType.READABLE);Qf.ReadableTrait=$f});var nO=p(Zf=>{"use strict";Object.defineProperty(Zf,"__esModule",{value:!0});Zf.LightSourceTrait=void 0;var Ik=ee(),Xf=class{constructor(e){l(this,"type",Ik.TraitType.LIGHT_SOURCE);l(this,"brightness",5);l(this,"isLit");l(this,"fuelRemaining");l(this,"maxFuel");l(this,"fuelConsumptionRate");e&&Object.assign(this,e)}};l(Xf,"type",Ik.TraitType.LIGHT_SOURCE);Zf.LightSourceTrait=Xf});var iO=p(eg=>{"use strict";Object.defineProperty(eg,"__esModule",{value:!0});eg.DoorTrait=void 0;var Ok=ee(),Jf=class{constructor(e){l(this,"type",Ok.TraitType.DOOR);l(this,"room1");l(this,"room2");l(this,"bidirectional",!0);if(e&&Object.assign(this,e),!this.room1||!this.room2)throw new Error("Door must connect two rooms")}};l(Jf,"type",Ok.TraitType.DOOR);eg.DoorTrait=Jf});var aO=p(Fd=>{"use strict";Object.defineProperty(Fd,"__esModule",{value:!0});Fd.ClimbableTrait=void 0;Fd.isClimbableTrait=mQ;Fd.createClimbableTrait=pQ;var oO=ee(),wu=class{constructor(e={}){l(this,"type",oO.TraitType.CLIMBABLE);l(this,"canClimb");l(this,"blockedMessage");l(this,"direction");l(this,"destination");l(this,"successMessage");this.canClimb=e.canClimb??!0,this.blockedMessage=e.blockedMessage,this.direction=e.direction??"both",this.destination=e.destination,this.successMessage=e.successMessage}};l(wu,"type",oO.TraitType.CLIMBABLE);Fd.ClimbableTrait=wu;function mQ(t){return t.type===oO.TraitType.CLIMBABLE}function pQ(t={}){return new wu(t)}});var sO=p(Bo=>{"use strict";Object.defineProperty(Bo,"__esModule",{value:!0});Bo.ActorTrait=Bo.HONORIFICS=Bo.PRONOUNS=void 0;var Sk=ee();Bo.PRONOUNS={HE_HIM:{subject:"he",object:"him",possessive:"his",possessiveAdj:"his",reflexive:"himself",verbForm:"singular"},SHE_HER:{subject:"she",object:"her",possessive:"hers",possessiveAdj:"her",reflexive:"herself",verbForm:"singular"},THEY_THEM:{subject:"they",object:"them",possessive:"theirs",possessiveAdj:"their",reflexive:"themselves",verbForm:"plural"},XE_XEM:{subject:"xe",object:"xem",possessive:"xyrs",possessiveAdj:"xyr",reflexive:"xemself",verbForm:"singular"},ZE_ZIR:{subject:"ze",object:"zir",possessive:"zirs",possessiveAdj:"zir",reflexive:"zirself",verbForm:"singular"},ZE_HIR:{subject:"ze",object:"hir",possessive:"hirs",possessiveAdj:"hir",reflexive:"hirself",verbForm:"singular"},EY_EM:{subject:"ey",object:"em",possessive:"eirs",possessiveAdj:"eir",reflexive:"emself",verbForm:"singular"},FAE_FAER:{subject:"fae",object:"faer",possessive:"faers",possessiveAdj:"faer",reflexive:"faerself",verbForm:"singular"}};Bo.HONORIFICS={MR:"Mr.",MRS:"Mrs.",MS:"Ms.",MX:"Mx.",MISS:"Miss",DR:"Dr.",PROF:"Prof."};var tg=class{constructor(e){l(this,"type",Sk.TraitType.ACTOR);l(this,"isPlayer",!1);l(this,"isPlayable",!0);l(this,"state");l(this,"pronouns",Bo.PRONOUNS.THEY_THEM);l(this,"honorific");l(this,"grammaticalGender");l(this,"briefDescription");l(this,"capacity");l(this,"allowedTypes");l(this,"excludedTypes");l(this,"isTransparent",!1);l(this,"enterable",!1);l(this,"customProperties");e&&(this.isPlayer=e.isPlayer??this.isPlayer,this.isPlayable=e.isPlayable??this.isPlayable,this.state=e.state,this.customProperties=e.customProperties,e.pronouns&&(this.pronouns=e.pronouns),this.honorific=e.honorific,this.grammaticalGender=e.grammaticalGender,this.briefDescription=e.briefDescription,this.capacity=e.capacity,this.allowedTypes=e.allowedTypes,this.excludedTypes=e.excludedTypes)}getPrimaryPronouns(){return Array.isArray(this.pronouns)?this.pronouns[0]:this.pronouns}setPronouns(e){this.pronouns=e}setInventoryLimit(e){this.capacity={...this.capacity,...e}}makePlayer(){this.isPlayer=!0,this.isPlayable=!0}setCustomProperty(e,r){this.customProperties||(this.customProperties={}),this.customProperties[e]=r}getCustomProperty(e){return this.customProperties?.[e]}};l(tg,"type",Sk.TraitType.ACTOR);Bo.ActorTrait=tg});var cO=p(ng=>{"use strict";Object.defineProperty(ng,"__esModule",{value:!0});ng.PullableTrait=void 0;var Ak=ee(),rg=class{constructor(e={}){l(this,"type",Ak.TraitType.PULLABLE);l(this,"pullType");l(this,"activates");l(this,"linkedTo");l(this,"pullSound");l(this,"requiresStrength");l(this,"repeatable");l(this,"state");l(this,"pullCount");l(this,"maxPulls");l(this,"detachesOnPull");l(this,"effects");this.pullType=e.pullType??"lever",this.activates=e.activates,this.linkedTo=e.linkedTo,this.pullSound=e.pullSound,this.requiresStrength=e.requiresStrength,this.repeatable=e.repeatable??!0,this.state=e.state??"default",this.pullCount=e.pullCount??0,this.maxPulls=e.maxPulls,this.detachesOnPull=e.detachesOnPull??!1,this.effects=e.effects}};l(rg,"type",Ak.TraitType.PULLABLE);ng.PullableTrait=rg});var dO=p(og=>{"use strict";Object.defineProperty(og,"__esModule",{value:!0});og.AttachedTrait=void 0;var Rk=ee(),ig=class{constructor(e={}){l(this,"type",Rk.TraitType.ATTACHED);l(this,"attachedTo");l(this,"attachmentType");l(this,"detachable");l(this,"detachForce");l(this,"loose");l(this,"detachSound");l(this,"onDetach");this.attachedTo=e.attachedTo,this.attachmentType=e.attachmentType??"stuck",this.detachable=e.detachable??!1,this.detachForce=e.detachForce,this.loose=e.loose??!1,this.detachSound=e.detachSound,this.onDetach=e.onDetach}};l(ig,"type",Rk.TraitType.ATTACHED);og.AttachedTrait=ig});var lO=p(sg=>{"use strict";Object.defineProperty(sg,"__esModule",{value:!0});sg.PushableTrait=void 0;var Ck=ee(),ag=class{constructor(e={}){l(this,"type",Ck.TraitType.PUSHABLE);l(this,"pushType");l(this,"revealsPassage");l(this,"pushSound");l(this,"requiresStrength");l(this,"repeatable");l(this,"state");l(this,"pushCount");l(this,"maxPushes");l(this,"pushDirection");l(this,"activates");l(this,"effects");this.pushType=e.pushType??"button",this.revealsPassage=e.revealsPassage,this.pushSound=e.pushSound,this.requiresStrength=e.requiresStrength,this.repeatable=e.repeatable??!0,this.state=e.state??"default",this.pushCount=e.pushCount??0,this.maxPushes=e.maxPushes,this.pushDirection=e.pushDirection,this.activates=e.activates,this.effects=e.effects}};l(ag,"type",Ck.TraitType.PUSHABLE);sg.PushableTrait=ag});var uO=p(dg=>{"use strict";Object.defineProperty(dg,"__esModule",{value:!0});dg.ButtonTrait=void 0;var wk=ee(),cg=class{constructor(e={}){l(this,"type",wk.TraitType.BUTTON);l(this,"latching");l(this,"color");l(this,"size");l(this,"shape");l(this,"material");l(this,"label");l(this,"pressed");this.latching=e.latching??!1,this.color=e.color,this.size=e.size,this.shape=e.shape,this.material=e.material,this.label=e.label,this.pressed=e.pressed??!1}};l(cg,"type",wk.TraitType.BUTTON);dg.ButtonTrait=cg});var mO=p(ug=>{"use strict";Object.defineProperty(ug,"__esModule",{value:!0});ug.MoveableSceneryTrait=void 0;var Nk=ee(),lg=class{constructor(e={}){l(this,"type",Nk.TraitType.MOVEABLE_SCENERY);l(this,"weightClass");l(this,"revealsWhenMoved");l(this,"reveals");l(this,"blocksExits");l(this,"blockedExits");l(this,"moved");l(this,"originalRoom");l(this,"moveSound");l(this,"requiresMultiplePeople");l(this,"peopleRequired");this.weightClass=e.weightClass??"heavy",this.revealsWhenMoved=e.revealsWhenMoved??!1,this.reveals=e.reveals,this.blocksExits=e.blocksExits??!1,this.blockedExits=e.blockedExits,this.moved=e.moved??!1,this.originalRoom=e.originalRoom,this.moveSound=e.moveSound,this.requiresMultiplePeople=e.requiresMultiplePeople??!1,this.peopleRequired=e.peopleRequired}};l(lg,"type",Nk.TraitType.MOVEABLE_SCENERY);ug.MoveableSceneryTrait=lg});var Dk=p(pg=>{"use strict";Object.defineProperty(pg,"__esModule",{value:!0});pg.WeaponTrait=void 0;var mg=class{constructor(e={}){l(this,"type","weapon");l(this,"damage");l(this,"skillBonus");l(this,"isBlessed");l(this,"glowsNearDanger");l(this,"isGlowing");l(this,"requiredTrait");l(this,"minDamage");l(this,"maxDamage");l(this,"weaponType");l(this,"twoHanded");l(this,"attackMessage");l(this,"hitSound");l(this,"breakable");l(this,"durability");l(this,"maxDurability");this.damage=e.damage??e.maxDamage??1,this.skillBonus=e.skillBonus??0,this.isBlessed=e.isBlessed??!1,this.glowsNearDanger=e.glowsNearDanger??!1,this.isGlowing=e.isGlowing??!1,this.requiredTrait=e.requiredTrait,this.minDamage=e.minDamage??1,this.maxDamage=e.maxDamage??e.minDamage??1,this.weaponType=e.weaponType??"blunt",this.twoHanded=e.twoHanded??!1,this.attackMessage=e.attackMessage,this.hitSound=e.hitSound,this.breakable=e.breakable??!1,this.durability=e.durability,this.maxDurability=e.maxDurability}setGlowing(e){this.isGlowing=e}};l(mg,"type","weapon");pg.WeaponTrait=mg});var Lk=p(gg=>{"use strict";Object.defineProperty(gg,"__esModule",{value:!0});gg.BreakableTrait=void 0;var fg=class{constructor(e={}){l(this,"type","breakable");l(this,"broken");this.broken=e.broken??!1}};l(fg,"type","breakable");gg.BreakableTrait=fg});var Mk=p(yg=>{"use strict";Object.defineProperty(yg,"__esModule",{value:!0});yg.DestructibleTrait=void 0;var hg=class{constructor(e={}){l(this,"type","destructible");l(this,"hitPoints");l(this,"maxHitPoints");l(this,"requiresWeapon");l(this,"requiresType");l(this,"transformTo");l(this,"revealExit");l(this,"damageMessage");l(this,"destroyMessage");l(this,"invulnerable");l(this,"armor");this.hitPoints=e.hitPoints??e.maxHitPoints??3,this.maxHitPoints=e.maxHitPoints??3,this.requiresWeapon=e.requiresWeapon??!1,this.requiresType=e.requiresType,this.transformTo=e.transformTo,this.revealExit=e.revealExit,this.damageMessage=e.damageMessage,this.destroyMessage=e.destroyMessage,this.invulnerable=e.invulnerable??!1,this.armor=e.armor??0}};l(hg,"type","destructible");yg.DestructibleTrait=hg});var Pk=p(Eg=>{"use strict";Object.defineProperty(Eg,"__esModule",{value:!0});Eg.CombatantTrait=void 0;var Tg=class{constructor(e={}){l(this,"type","combatant");l(this,"health");l(this,"maxHealth");l(this,"skill");l(this,"baseDamage");l(this,"isConscious");l(this,"recoveryTurns");l(this,"armor");l(this,"attackPower");l(this,"defense");l(this,"isAlive");l(this,"hitMessage");l(this,"deathMessage");l(this,"attackMessage");l(this,"hostile");l(this,"canRetaliate");l(this,"dropsInventory");l(this,"experienceValue");this.health=e.health??e.maxHealth??10,this.maxHealth=e.maxHealth??10,this.skill=e.skill??30,this.baseDamage=e.baseDamage??e.attackPower??1,this.isConscious=e.isConscious??!0,this.recoveryTurns=e.recoveryTurns,this.armor=e.armor??0,this.attackPower=e.attackPower??1,this.defense=e.defense??0,this.isAlive=e.isAlive??!0,this.hitMessage=e.hitMessage,this.deathMessage=e.deathMessage,this.attackMessage=e.attackMessage,this.hostile=e.hostile??!1,this.canRetaliate=e.canRetaliate??!0,this.dropsInventory=e.dropsInventory??!0,this.experienceValue=e.experienceValue??0}get alive(){return this.health>0}get canAct(){return this.isAlive&&this.isConscious}knockOut(e){this.isConscious=!1,e!==void 0&&(this.recoveryTurns=e)}wakeUp(){this.isAlive&&(this.isConscious=!0,this.recoveryTurns=void 0)}kill(){this.health=0,this.isAlive=!1,this.isConscious=!1}takeDamage(e){let r=Math.max(0,e-this.armor);return this.health=Math.max(0,this.health-r),this.health<=0?(this.kill(),!0):(this.health<=this.maxHealth*.2&&this.knockOut(),!1)}heal(e){this.isAlive&&(this.health=Math.min(this.maxHealth,this.health+e),this.health>this.maxHealth*.2&&this.wakeUp())}};l(Tg,"type","combatant");Eg.CombatantTrait=Tg});var kk=p(_g=>{"use strict";Object.defineProperty(_g,"__esModule",{value:!0});_g.EquippedTrait=void 0;var vg=class{constructor(e={}){l(this,"type","equipped");l(this,"slot");l(this,"isEquipped");l(this,"equipMessage");l(this,"unequipMessage");l(this,"quickEquip");l(this,"modifiers");this.slot=e.slot??"accessory",this.isEquipped=e.isEquipped??!1,this.equipMessage=e.equipMessage,this.unequipMessage=e.unequipMessage,this.quickEquip=e.quickEquip??!1,this.modifiers=e.modifiers}};l(vg,"type","equipped");_g.EquippedTrait=vg});var pO=p(Ig=>{"use strict";Object.defineProperty(Ig,"__esModule",{value:!0});Ig.NpcTrait=void 0;var bg=class{constructor(e={}){l(this,"type","npc");l(this,"isAlive");l(this,"isConscious");l(this,"isHostile");l(this,"canMove");l(this,"allowedRooms");l(this,"forbiddenRooms");l(this,"behaviorId");l(this,"conversationState");l(this,"knowledge");l(this,"goals");l(this,"customProperties");this.isAlive=e.isAlive??!0,this.isConscious=e.isConscious??!0,this.isHostile=e.isHostile??!1,this.canMove=e.canMove??!1,this.allowedRooms=e.allowedRooms,this.forbiddenRooms=e.forbiddenRooms,this.behaviorId=e.behaviorId,this.conversationState=e.conversationState,this.knowledge=e.knowledge,this.goals=e.goals,this.customProperties=e.customProperties}get canAct(){return this.isAlive&&this.isConscious}canEnterRoom(e){return!(!this.canMove||this.forbiddenRooms?.includes(e)||this.allowedRooms&&!this.allowedRooms.includes(e))}makeHostile(){this.isHostile=!0}makePassive(){this.isHostile=!1}knockOut(){this.isConscious=!1}wakeUp(){this.isAlive&&(this.isConscious=!0)}kill(){this.isAlive=!1,this.isConscious=!1}revive(){this.isAlive=!0,this.isConscious=!0}setKnowledge(e,r){this.knowledge||(this.knowledge={}),this.knowledge[e]=r}getKnowledge(e){return this.knowledge?.[e]}knows(e){return this.knowledge?.[e]!==void 0}addGoal(e){this.goals||(this.goals=[]),this.goals.includes(e)||this.goals.push(e)}removeGoal(e){this.goals&&(this.goals=this.goals.filter(r=>r!==e))}hasGoal(e){return this.goals?.includes(e)??!1}setCustomProperty(e,r){this.customProperties||(this.customProperties={}),this.customProperties[e]=r}getCustomProperty(e){return this.customProperties?.[e]}};l(bg,"type","npc");Ig.NpcTrait=bg});var gO=p(Vd=>{"use strict";Object.defineProperty(Vd,"__esModule",{value:!0});Vd.VehicleTrait=void 0;Vd.isVehicleTrait=fQ;Vd.createVehicleTrait=gQ;var fO=ee(),Nu=class{constructor(e={}){l(this,"type",fO.TraitType.VEHICLE);l(this,"vehicleType");l(this,"movesWithContents",!0);l(this,"blocksWalkingMovement");l(this,"requiresExitBeforeLeaving");l(this,"currentPosition");l(this,"positionRooms");l(this,"isOperational");l(this,"notOperationalReason");l(this,"transparent");this.vehicleType=e.vehicleType??"generic",this.blocksWalkingMovement=e.blocksWalkingMovement??!0,this.requiresExitBeforeLeaving=e.requiresExitBeforeLeaving??!0,this.currentPosition=e.currentPosition,this.positionRooms=e.positionRooms,this.isOperational=e.isOperational??!0,this.notOperationalReason=e.notOperationalReason,this.transparent=e.transparent??!0}};l(Nu,"type",fO.TraitType.VEHICLE);Vd.VehicleTrait=Nu;function fQ(t){return t.type===fO.TraitType.VEHICLE}function gQ(t={}){return new Nu(t)}});var Bk=p(Yd=>{"use strict";Object.defineProperty(Yd,"__esModule",{value:!0});Yd.EnterableTrait=void 0;Yd.isEnterableTrait=hQ;Yd.createEnterableTrait=yQ;var hO=ee(),Du=class{constructor(e){l(this,"type",hO.TraitType.ENTERABLE);l(this,"preposition");this.preposition=e?.preposition??"in"}};l(Du,"type",hO.TraitType.ENTERABLE);Yd.EnterableTrait=Du;function hQ(t){return t.type===hO.TraitType.ENTERABLE}function yQ(t){return new Du(t)}});var yO=p(Sg=>{"use strict";Object.defineProperty(Sg,"__esModule",{value:!0});Sg.StoryInfoTrait=void 0;var Og=class{constructor(e){l(this,"type","storyInfo");l(this,"title","");l(this,"author","");l(this,"version","");l(this,"description");l(this,"buildDate");l(this,"engineVersion");l(this,"clientVersion");l(this,"portedBy");e&&Object.assign(this,e)}};l(Og,"type","storyInfo");Sg.StoryInfoTrait=Og});var fB=p(F=>{"use strict";Object.defineProperty(F,"__esModule",{value:!0});F.StoryInfoTrait=F.EnterableTrait=F.VehicleTrait=F.NpcTrait=F.EquippedTrait=F.CombatantTrait=F.DestructibleTrait=F.BreakableTrait=F.WeaponTrait=F.MoveableSceneryTrait=F.ButtonTrait=F.PushableTrait=F.AttachedTrait=F.PullableTrait=F.ClimbableTrait=F.ExitTrait=F.ActorTrait=F.DoorTrait=F.LightSourceTrait=F.ReadableTrait=F.SwitchableTrait=F.LockableTrait=F.OpenableTrait=F.SceneryTrait=F.EdibleTrait=F.ClothingTrait=F.WearableTrait=F.RoomTrait=F.SupporterTrait=F.ContainerTrait=F.IdentityTrait=F.TRAIT_IMPLEMENTATIONS=void 0;F.getTraitImplementation=TQ;F.createTrait=EQ;var De=ee(),xk=Cf();Object.defineProperty(F,"IdentityTrait",{enumerable:!0,get:function(){return xk.IdentityTrait}});var jk=KI();Object.defineProperty(F,"ContainerTrait",{enumerable:!0,get:function(){return jk.ContainerTrait}});var Wk=$I();Object.defineProperty(F,"SupporterTrait",{enumerable:!0,get:function(){return Wk.SupporterTrait}});var Uk=QI();Object.defineProperty(F,"RoomTrait",{enumerable:!0,get:function(){return Uk.RoomTrait}});var Hk=XI();Object.defineProperty(F,"WearableTrait",{enumerable:!0,get:function(){return Hk.WearableTrait}});var qk=ZI();Object.defineProperty(F,"ClothingTrait",{enumerable:!0,get:function(){return qk.ClothingTrait}});var Gk=JI();Object.defineProperty(F,"EdibleTrait",{enumerable:!0,get:function(){return Gk.EdibleTrait}});var Fk=eO();Object.defineProperty(F,"SceneryTrait",{enumerable:!0,get:function(){return Fk.SceneryTrait}});var Vk=Ru();Object.defineProperty(F,"OpenableTrait",{enumerable:!0,get:function(){return Vk.OpenableTrait}});var Yk=Cu();Object.defineProperty(F,"LockableTrait",{enumerable:!0,get:function(){return Yk.LockableTrait}});var zk=tO();Object.defineProperty(F,"SwitchableTrait",{enumerable:!0,get:function(){return zk.SwitchableTrait}});var Kk=rO();Object.defineProperty(F,"ReadableTrait",{enumerable:!0,get:function(){return Kk.ReadableTrait}});var $k=nO();Object.defineProperty(F,"LightSourceTrait",{enumerable:!0,get:function(){return $k.LightSourceTrait}});var Qk=iO();Object.defineProperty(F,"DoorTrait",{enumerable:!0,get:function(){return Qk.DoorTrait}});var Xk=aO();Object.defineProperty(F,"ClimbableTrait",{enumerable:!0,get:function(){return Xk.ClimbableTrait}});var Zk=sO();Object.defineProperty(F,"ActorTrait",{enumerable:!0,get:function(){return Zk.ActorTrait}});var Jk=df();Object.defineProperty(F,"ExitTrait",{enumerable:!0,get:function(){return Jk.ExitTrait}});var eB=cO();Object.defineProperty(F,"PullableTrait",{enumerable:!0,get:function(){return eB.PullableTrait}});var tB=dO();Object.defineProperty(F,"AttachedTrait",{enumerable:!0,get:function(){return tB.AttachedTrait}});var rB=lO();Object.defineProperty(F,"PushableTrait",{enumerable:!0,get:function(){return rB.PushableTrait}});var nB=uO();Object.defineProperty(F,"ButtonTrait",{enumerable:!0,get:function(){return nB.ButtonTrait}});var iB=mO();Object.defineProperty(F,"MoveableSceneryTrait",{enumerable:!0,get:function(){return iB.MoveableSceneryTrait}});var oB=Dk();Object.defineProperty(F,"WeaponTrait",{enumerable:!0,get:function(){return oB.WeaponTrait}});var aB=Lk();Object.defineProperty(F,"BreakableTrait",{enumerable:!0,get:function(){return aB.BreakableTrait}});var sB=Mk();Object.defineProperty(F,"DestructibleTrait",{enumerable:!0,get:function(){return sB.DestructibleTrait}});var cB=Pk();Object.defineProperty(F,"CombatantTrait",{enumerable:!0,get:function(){return cB.CombatantTrait}});var dB=kk();Object.defineProperty(F,"EquippedTrait",{enumerable:!0,get:function(){return dB.EquippedTrait}});var lB=pO();Object.defineProperty(F,"NpcTrait",{enumerable:!0,get:function(){return lB.NpcTrait}});var uB=gO();Object.defineProperty(F,"VehicleTrait",{enumerable:!0,get:function(){return uB.VehicleTrait}});var mB=Bk();Object.defineProperty(F,"EnterableTrait",{enumerable:!0,get:function(){return mB.EnterableTrait}});var pB=yO();Object.defineProperty(F,"StoryInfoTrait",{enumerable:!0,get:function(){return pB.StoryInfoTrait}});F.TRAIT_IMPLEMENTATIONS={[De.TraitType.IDENTITY]:xk.IdentityTrait,[De.TraitType.CONTAINER]:jk.ContainerTrait,[De.TraitType.SUPPORTER]:Wk.SupporterTrait,[De.TraitType.ROOM]:Uk.RoomTrait,[De.TraitType.WEARABLE]:Hk.WearableTrait,[De.TraitType.CLOTHING]:qk.ClothingTrait,[De.TraitType.EDIBLE]:Gk.EdibleTrait,[De.TraitType.SCENERY]:Fk.SceneryTrait,[De.TraitType.OPENABLE]:Vk.OpenableTrait,[De.TraitType.LOCKABLE]:Yk.LockableTrait,[De.TraitType.SWITCHABLE]:zk.SwitchableTrait,[De.TraitType.READABLE]:Kk.ReadableTrait,[De.TraitType.LIGHT_SOURCE]:$k.LightSourceTrait,[De.TraitType.DOOR]:Qk.DoorTrait,[De.TraitType.CLIMBABLE]:Xk.ClimbableTrait,[De.TraitType.ACTOR]:Zk.ActorTrait,[De.TraitType.EXIT]:Jk.ExitTrait,[De.TraitType.PULLABLE]:eB.PullableTrait,[De.TraitType.ATTACHED]:tB.AttachedTrait,[De.TraitType.PUSHABLE]:rB.PushableTrait,[De.TraitType.BUTTON]:nB.ButtonTrait,[De.TraitType.MOVEABLE_SCENERY]:iB.MoveableSceneryTrait,[De.TraitType.WEAPON]:oB.WeaponTrait,[De.TraitType.BREAKABLE]:aB.BreakableTrait,[De.TraitType.DESTRUCTIBLE]:sB.DestructibleTrait,[De.TraitType.COMBATANT]:cB.CombatantTrait,[De.TraitType.EQUIPPED]:dB.EquippedTrait,[De.TraitType.NPC]:lB.NpcTrait,[De.TraitType.VEHICLE]:uB.VehicleTrait,[De.TraitType.ENTERABLE]:mB.EnterableTrait,[De.TraitType.STORY_INFO]:pB.StoryInfoTrait};function TQ(t){return F.TRAIT_IMPLEMENTATIONS[t]}function EQ(t,e){let r=F.TRAIT_IMPLEMENTATIONS[t];if(!r)throw new Error(`Unknown trait type: ${t}`);return new r(e)}});var hB=p(Za=>{"use strict";var vQ=Za&&Za.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),gB=Za&&Za.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&vQ(e,t,r)};Object.defineProperty(Za,"__esModule",{value:!0});gB(Cf(),Za);gB(_u(),Za)});var TO=p(zd=>{"use strict";Object.defineProperty(zd,"__esModule",{value:!0});zd.isContainerCapable=Ag;zd.canContain=_Q;zd.getContainerTrait=bQ;zd.hasContainerProperties=IQ;var xr=ee();function Ag(t){return t.type===xr.TraitType.CONTAINER||t.type===xr.TraitType.ROOM||t.type===xr.TraitType.ACTOR}function _Q(t){return t.type==="room"||t.type==="actor"?!0:t.hasTrait(xr.TraitType.CONTAINER)||t.hasTrait(xr.TraitType.ROOM)||t.hasTrait(xr.TraitType.ACTOR)||t.hasTrait(xr.TraitType.SUPPORTER)||t.hasTrait(xr.TraitType.ENTERABLE)||t.hasTrait(xr.TraitType.VEHICLE)}function bQ(t){let e=t.getTrait(xr.TraitType.CONTAINER);if(e&&Ag(e))return e;let r=t.getTrait(xr.TraitType.ROOM);if(r&&Ag(r))return r;let n=t.getTrait(xr.TraitType.ACTOR);if(n&&Ag(n))return n;if(t.type==="room"||t.type==="actor")return{type:t.type==="room"?xr.TraitType.ROOM:xr.TraitType.ACTOR,isTransparent:t.type==="room",enterable:t.type==="room",capacity:void 0}}function IQ(t){return typeof t=="object"&&t!==null&&typeof t.isTransparent=="boolean"&&typeof t.enterable=="boolean"}});var EO=p(jr=>{"use strict";Object.defineProperty(jr,"__esModule",{value:!0});jr.hasContainerProperties=jr.isContainerCapable=jr.getContainerTrait=jr.canContain=jr.ContainerBehavior=jr.ContainerTrait=void 0;var OQ=KI();Object.defineProperty(jr,"ContainerTrait",{enumerable:!0,get:function(){return OQ.ContainerTrait}});var SQ=Gp();Object.defineProperty(jr,"ContainerBehavior",{enumerable:!0,get:function(){return SQ.ContainerBehavior}});var Rg=TO();Object.defineProperty(jr,"canContain",{enumerable:!0,get:function(){return Rg.canContain}});Object.defineProperty(jr,"getContainerTrait",{enumerable:!0,get:function(){return Rg.getContainerTrait}});Object.defineProperty(jr,"isContainerCapable",{enumerable:!0,get:function(){return Rg.isContainerCapable}});Object.defineProperty(jr,"hasContainerProperties",{enumerable:!0,get:function(){return Rg.hasContainerProperties}})});var bO=p(Cg=>{"use strict";Object.defineProperty(Cg,"__esModule",{value:!0});Cg.RoomBehavior=void 0;var AQ=Dt(),Lt=ee(),vO=qd(),Tt=class Tt extends AQ.Behavior{static getExit(e,r){let n=Tt.require(e,Lt.TraitType.ROOM);return n.exits&&n.exits[r]||null}static hasExit(e,r){return this.getExit(e,r)!==void 0}static isExitBlocked(e,r){return Tt.require(e,Lt.TraitType.ROOM).blockedExits?.hasOwnProperty(r)??!1}static getBlockedMessage(e,r){return Tt.require(e,Lt.TraitType.ROOM).blockedExits?.[r]}static setExit(e,r,n,i){let o=Tt.require(e,Lt.TraitType.ROOM);o.exits||(o.exits={}),o.exits[r]={destination:n,via:i},o.blockedExits&&delete o.blockedExits[r]}static blockExit(e,r,n){let i=Tt.require(e,Lt.TraitType.ROOM);return i.blockedExits||(i.blockedExits={}),i.blockedExits[r]=n,[{id:`${Date.now()}-${Math.random()}`,timestamp:Date.now(),type:vO.IFEvents.MOVEMENT_BLOCKED,entities:{location:e.id},data:{direction:r,message:n}}]}static unblockExit(e,r){let n=Tt.require(e,Lt.TraitType.ROOM);return n.blockedExits?n.blockedExits[r]?(delete n.blockedExits[r],[{id:`${Date.now()}-${Math.random()}`,timestamp:Date.now(),type:vO.IFEvents.NEW_EXIT_REVEALED,entities:{location:e.id},data:{direction:r,unblocked:!0}}]):[]:[]}static removeExit(e,r){let n=Tt.require(e,Lt.TraitType.ROOM);n.exits&&delete n.exits[r],n.blockedExits&&delete n.blockedExits[r]}static markVisited(e,r){let n=Tt.require(e,Lt.TraitType.ROOM);return n.visited?[]:(n.visited=!0,[{id:`${Date.now()}-${Math.random()}`,timestamp:Date.now(),type:vO.IFEvents.ROOM_FIRST_ENTERED,entities:{location:e.id,actor:r.id},data:{hasInitialDescription:!!n.initialDescription}}])}static hasBeenVisited(e){return Tt.require(e,Lt.TraitType.ROOM).visited}static getAllExits(e){let r=Tt.require(e,Lt.TraitType.ROOM);return r.exits?new Map(Object.entries(r.exits)):new Map}static getAvailableExits(e){let r=Tt.require(e,Lt.TraitType.ROOM),n=new Map;if(!r.exits)return n;for(let[i,o]of Object.entries(r.exits))this.isExitBlocked(e,i)||n.set(i,o);return n}static isOutdoors(e){return Tt.require(e,Lt.TraitType.ROOM).isOutdoors||!1}static isUnderground(e){return Tt.require(e,Lt.TraitType.ROOM).isUnderground||!1}static getRegion(e){return Tt.require(e,Lt.TraitType.ROOM).region}static hasTag(e,r){return Tt.require(e,Lt.TraitType.ROOM).tags.includes(r.toLowerCase())}static addTag(e,r){let n=Tt.require(e,Lt.TraitType.ROOM),i=r.toLowerCase();n.tags.includes(i)||n.tags.push(i)}static removeTag(e,r){let n=Tt.require(e,Lt.TraitType.ROOM),i=r.toLowerCase(),o=n.tags.indexOf(i);o>=0&&n.tags.splice(o,1)}};l(Tt,"requiredTraits",[Lt.TraitType.ROOM]);var _O=Tt;Cg.RoomBehavior=_O});var IO=p(Kd=>{"use strict";Object.defineProperty(Kd,"__esModule",{value:!0});Kd.RoomBehavior=Kd.RoomTrait=void 0;var RQ=QI();Object.defineProperty(Kd,"RoomTrait",{enumerable:!0,get:function(){return RQ.RoomTrait}});var CQ=bO();Object.defineProperty(Kd,"RoomBehavior",{enumerable:!0,get:function(){return CQ.RoomBehavior}})});var TB=p(Ja=>{"use strict";var wQ=Ja&&Ja.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),yB=Ja&&Ja.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&wQ(e,t,r)};Object.defineProperty(Ja,"__esModule",{value:!0});yB(Ru(),Ja);yB(MI(),Ja)});var vB=p(es=>{"use strict";var NQ=es&&es.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),EB=es&&es.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&NQ(e,t,r)};Object.defineProperty(es,"__esModule",{value:!0});EB(Cu(),es);EB(kI(),es)});var _B=p($d=>{"use strict";Object.defineProperty($d,"__esModule",{value:!0});$d.ReadableBehavior=$d.ReadableTrait=void 0;var DQ=rO();Object.defineProperty($d,"ReadableTrait",{enumerable:!0,get:function(){return DQ.ReadableTrait}});var LQ=hI();Object.defineProperty($d,"ReadableBehavior",{enumerable:!0,get:function(){return LQ.ReadableBehavior}})});var bB=p(Qd=>{"use strict";Object.defineProperty(Qd,"__esModule",{value:!0});Qd.LightSourceBehavior=Qd.LightSourceTrait=void 0;var MQ=nO();Object.defineProperty(Qd,"LightSourceTrait",{enumerable:!0,get:function(){return MQ.LightSourceTrait}});var PQ=CI();Object.defineProperty(Qd,"LightSourceBehavior",{enumerable:!0,get:function(){return PQ.LightSourceBehavior}})});var IB=p(Xd=>{"use strict";Object.defineProperty(Xd,"__esModule",{value:!0});Xd.ExitBehavior=Xd.ExitTrait=void 0;var kQ=df();Object.defineProperty(Xd,"ExitTrait",{enumerable:!0,get:function(){return kQ.ExitTrait}});var BQ=wI();Object.defineProperty(Xd,"ExitBehavior",{enumerable:!0,get:function(){return BQ.ExitBehavior}})});var SB=p(ts=>{"use strict";var xQ=ts&&ts.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),OB=ts&&ts.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&xQ(e,t,r)};Object.defineProperty(ts,"__esModule",{value:!0});OB(aO(),ts);OB(DI(),ts)});var OO=p(Zd=>{"use strict";Object.defineProperty(Zd,"__esModule",{value:!0});Zd.SceneryBehavior=Zd.SceneryTrait=void 0;var jQ=eO();Object.defineProperty(Zd,"SceneryTrait",{enumerable:!0,get:function(){return jQ.SceneryTrait}});var WQ=gI();Object.defineProperty(Zd,"SceneryBehavior",{enumerable:!0,get:function(){return WQ.SceneryBehavior}})});var AB=p(wg=>{"use strict";Object.defineProperty(wg,"__esModule",{value:!0});wg.SupporterBehavior=void 0;var UQ=Dt(),Jn=ee(),HQ=_u(),ei=class ei extends UQ.Behavior{static canAccept(e,r,n){let i=ei.require(e,Jn.TraitType.SUPPORTER);if(i.allowedTypes&&i.allowedTypes.length>0){let o=r.type||"object";if(!i.allowedTypes.includes(o))return!1}if(i.excludedTypes&&i.excludedTypes.length>0){let o=r.type||"object";if(i.excludedTypes.includes(o))return!1}return!(r.has(Jn.TraitType.ACTOR)&&!i.enterable||i.capacity&&!this.checkCapacity(e,r,n))}static checkCapacity(e,r,n){let o=ei.require(e,Jn.TraitType.SUPPORTER).capacity;if(o.maxItems!==void 0&&n.getContents(e.id).length>=o.maxItems)return!1;if(o.maxWeight!==void 0){let a=this.getTotalWeight(e,n),s=this.getItemTotalWeight(r,n);if(a+s>o.maxWeight)return!1}return!0}static getTotalWeight(e,r){return r.getContents(e.id).reduce((i,o)=>i+this.getItemTotalWeight(o,r),0)}static getItemTotalWeight(e,r){let n=HQ.IdentityBehavior.getWeight(e);if(e.has(Jn.TraitType.CONTAINER)||e.has(Jn.TraitType.SUPPORTER)){let i=r.getContents(e.id);for(let o of i)n+=this.getItemTotalWeight(o,r)}return n}static getRemainingCapacity(e,r){let n=ei.require(e,Jn.TraitType.SUPPORTER),i={};if(n.capacity?.maxItems!==void 0){let o=r.getContents(e.id).length;i.items=n.capacity.maxItems-o}return n.capacity?.maxWeight!==void 0&&(i.weight=n.capacity.maxWeight-this.getTotalWeight(e,r)),i}static isEnterable(e){return ei.require(e,Jn.TraitType.SUPPORTER).enterable||!1}static getAllowedTypes(e){return ei.require(e,Jn.TraitType.SUPPORTER).allowedTypes}static getExcludedTypes(e){return ei.require(e,Jn.TraitType.SUPPORTER).excludedTypes}static addItem(e,r,n){if(n.getLocation(r.id)===e.id)return{success:!1,alreadyThere:!0,stateChanged:!1};if(!ei.canAccept(e,r,n)){let o=ei.require(e,Jn.TraitType.SUPPORTER);if(o.allowedTypes&&o.allowedTypes.length>0){let a=r.type||"object";if(!o.allowedTypes.includes(a))return{success:!1,wrongType:!0,stateChanged:!1}}if(o.excludedTypes&&o.excludedTypes.length>0){let a=r.type||"object";if(o.excludedTypes.includes(a))return{success:!1,wrongType:!0,stateChanged:!1}}return{success:!1,noSpace:!0,stateChanged:!1}}return{success:!0,stateChanged:!0}}static removeItem(e,r,n){return n.getLocation(r.id)!==e.id?{success:!1,notThere:!0,stateChanged:!1}:{success:!0,stateChanged:!0}}};l(ei,"requiredTraits",[Jn.TraitType.SUPPORTER]);var SO=ei;wg.SupporterBehavior=SO});var AO=p(Jd=>{"use strict";Object.defineProperty(Jd,"__esModule",{value:!0});Jd.SupporterBehavior=Jd.SupporterTrait=void 0;var qQ=$I();Object.defineProperty(Jd,"SupporterTrait",{enumerable:!0,get:function(){return qQ.SupporterTrait}});var GQ=AB();Object.defineProperty(Jd,"SupporterBehavior",{enumerable:!0,get:function(){return GQ.SupporterBehavior}})});var CB=p(rs=>{"use strict";var FQ=rs&&rs.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),RB=rs&&rs.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&FQ(e,t,r)};Object.defineProperty(rs,"__esModule",{value:!0});RB(tO(),rs);RB(of(),rs)});var NB=p(ns=>{"use strict";var VQ=ns&&ns.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),wB=ns&&ns.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&VQ(e,t,r)};Object.defineProperty(ns,"__esModule",{value:!0});wB(XI(),ns);wB(bu(),ns)});var DB=p(Dg=>{"use strict";Object.defineProperty(Dg,"__esModule",{value:!0});Dg.EdibleBehavior=void 0;var YQ=Dt(),ti=ee(),RO=Ve(),Ng=qd(),zQ=FI(),Wr=class Wr extends YQ.Behavior{static canConsume(e){let r=Wr.require(e,ti.TraitType.EDIBLE);return r.consumed===!0?!1:(r.servings??r.portions??1)>0}static consume(e,r){let n=Wr.require(e,ti.TraitType.EDIBLE),i=n.servings??n.portions??1,o=n.liquid||n.isDrink||!1;if(i<=0||n.consumed===!0)return[(0,RO.createEvent)(Ng.IFEvents.ACTION_FAILED,{action:o?"drink":"eat",reason:zQ.ActionFailureReason.NOTHING_LEFT,customMessage:"There's nothing left."},{target:e.id,actor:r.id})];i--,n.servings=i,n.portions!==void 0&&(n.portions=i),i<=0&&(n.consumed=!0);let a=[(0,RO.createEvent)(o?Ng.IFEvents.ITEM_DRUNK:Ng.IFEvents.ITEM_EATEN,{nutrition:n.nutrition,servingsLeft:i,customMessage:n.consumeMessage,hasEffect:n.hasEffect,effectDescription:n.effectDescription},{target:e.id,actor:r.id})];return i<=0&&a.push((0,RO.createEvent)(Ng.IFEvents.ITEM_DESTROYED,{reason:"consumed",remainsType:n.remainsType},{target:e.id,actor:r.id})),a}static isEmpty(e){let r=Wr.require(e,ti.TraitType.EDIBLE);return r.consumed===!0?!0:(r.servings??r.portions??1)<=0}static isLiquid(e){let r=Wr.require(e,ti.TraitType.EDIBLE);return r.liquid||r.isDrink||!1}static getNutrition(e){return Wr.require(e,ti.TraitType.EDIBLE).nutrition}static getServings(e){let r=Wr.require(e,ti.TraitType.EDIBLE);return r.consumed===!0?0:r.servings??r.portions??1}static hasEffect(e){return Wr.require(e,ti.TraitType.EDIBLE).hasEffect}static getTaste(e){return Wr.require(e,ti.TraitType.EDIBLE).taste}static getEffects(e){return Wr.require(e,ti.TraitType.EDIBLE).effects}static hasSpecificEffect(e,r){return Wr.getEffects(e)?.includes(r)??!1}static satisfiesHunger(e){return Wr.require(e,ti.TraitType.EDIBLE).satisfiesHunger}};l(Wr,"requiredTraits",[ti.TraitType.EDIBLE]);var CO=Wr;Dg.EdibleBehavior=CO});var MB=p(is=>{"use strict";var KQ=is&&is.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),LB=is&&is.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&KQ(e,t,r)};Object.defineProperty(is,"__esModule",{value:!0});LB(JI(),is);LB(DB(),is)});var PB=p(Lg=>{"use strict";Object.defineProperty(Lg,"__esModule",{value:!0});Lg.DoorBehavior=void 0;var $Q=Dt(),os=ee(),Bi=class Bi extends $Q.Behavior{static getRooms(e){let r=Bi.require(e,os.TraitType.DOOR);return[r.room1,r.room2]}static getOtherRoom(e,r){let n=Bi.require(e,os.TraitType.DOOR);if(n.room1===r)return n.room2;if(n.room2===r)return n.bidirectional?n.room1:void 0}static isBidirectional(e){return Bi.require(e,os.TraitType.DOOR).bidirectional}static connects(e,r,n){let i=Bi.require(e,os.TraitType.DOOR);return i.room1===r&&i.room2===n||i.room1===n&&i.room2===r}static connectsTo(e,r){let n=Bi.require(e,os.TraitType.DOOR);return n.room1===r||n.room2===r}static getEntryRoom(e){return Bi.require(e,os.TraitType.DOOR).room1}static getExitRoom(e){return Bi.require(e,os.TraitType.DOOR).room2}};l(Bi,"requiredTraits",[os.TraitType.DOOR]);var wO=Bi;Lg.DoorBehavior=wO});var NO=p(el=>{"use strict";Object.defineProperty(el,"__esModule",{value:!0});el.DoorBehavior=el.DoorTrait=void 0;var QQ=iO();Object.defineProperty(el,"DoorTrait",{enumerable:!0,get:function(){return QQ.DoorTrait}});var XQ=PB();Object.defineProperty(el,"DoorBehavior",{enumerable:!0,get:function(){return XQ.DoorBehavior}})});var BB=p(Pg=>{"use strict";Object.defineProperty(Pg,"__esModule",{value:!0});Pg.ActorBehavior=void 0;var ZQ=Dt(),dr=ee(),JQ=Gp(),Mg=_u(),kB=bu(),gt=class gt extends ZQ.Behavior{static isPlayer(e){return gt.require(e,dr.TraitType.ACTOR).isPlayer||!1}static isPlayable(e){return gt.require(e,dr.TraitType.ACTOR).isPlayable||!1}static getPronouns(e){return gt.require(e,dr.TraitType.ACTOR).pronouns}static getPronoun(e,r){return gt.getPronouns(e)[r]}static canCarry(e,r,n){let i=gt.require(e,dr.TraitType.ACTOR);if(i.capacity){let o=i.capacity;if(o.maxItems!==void 0&&n.getContents(e.id).length>=o.maxItems)return!1;if(o.maxWeight!==void 0){let a=gt.getCarriedWeight(e,n),s=Mg.IdentityBehavior.getWeight(r);if(a+s>o.maxWeight)return!1}if(o.maxVolume!==void 0){let a=gt.getCarriedVolume(e,n),s=Mg.IdentityBehavior.getVolume(r);if(a+s>o.maxVolume)return!1}}return!0}static getCarriedWeight(e,r){return r.getContents(e.id).reduce((i,o)=>i+Mg.IdentityBehavior.getWeight(o),0)}static getCarriedVolume(e,r){return r.getContents(e.id).reduce((i,o)=>i+Mg.IdentityBehavior.getVolume(o),0)}static getRemainingCapacity(e,r){let n=gt.require(e,dr.TraitType.ACTOR),i={};if(n.capacity){let o=n.capacity;if(o.maxItems!==void 0){let a=r.getContents(e.id).length;i.items=o.maxItems-a}o.maxWeight!==void 0&&(i.weight=o.maxWeight-gt.getCarriedWeight(e,r)),o.maxVolume!==void 0&&(i.volume=o.maxVolume-gt.getCarriedVolume(e,r))}return i}static isHolding(e,r,n){return n.getLocation(r)===e.id}static getState(e){return gt.require(e,dr.TraitType.ACTOR).state}static setState(e,r){let n=gt.require(e,dr.TraitType.ACTOR);n.state=r}static getCustomProperty(e,r){return gt.require(e,dr.TraitType.ACTOR).customProperties?.[r]}static setCustomProperty(e,r,n){let i=gt.require(e,dr.TraitType.ACTOR);i.customProperties||(i.customProperties={}),i.customProperties[r]=n}static findPlayer(e){return e.find(r=>r.has(dr.TraitType.ACTOR)&&gt.isPlayer(r))}static canTakeItem(e,r,n){let i=e.get(dr.TraitType.ACTOR);if(!i)return!1;if(e.has(dr.TraitType.CONTAINER))return JQ.ContainerBehavior.canAccept(e,r,n);if(i?.capacity?.maxWeight!==void 0){let o=i.capacity.maxWeight;if(gt.getCarriedWeight(e,n)+0>o)return!1}return!(!e.has(dr.TraitType.CONTAINER)&&i?.capacity?.maxItems!==void 0&&n.getContents(e.id).filter(a=>!kB.WearableBehavior.isWorn(a)).length>=i.capacity.maxItems)}static takeItem(e,r,n){let i=n.getLocation(r.id);if(i===e.id)return{success:!1,alreadyHeld:!0,stateChanged:!1};if(!gt.canTakeItem(e,r,n)){let s=e.get(dr.TraitType.ACTOR);if(s?.capacity?.maxWeight!==void 0){let c=s.capacity.maxWeight;if(gt.getCarriedWeight(e,n)+0>c)return{success:!1,tooHeavy:!0,stateChanged:!1}}return{success:!1,inventoryFull:!0,stateChanged:!1}}let o=!1,a;return i&&(o=!0,a=i),{success:!0,stateChanged:!0,needsRemoval:o,fromContainer:a}}static dropItem(e,r,n){return n.getLocation(r.id)!==e.id?{success:!1,notHeld:!0,stateChanged:!1}:kB.WearableBehavior.isWorn(r)?{success:!1,stillWorn:!0,stateChanged:!1}:{success:!0,stateChanged:!0}}};l(gt,"requiredTraits",[dr.TraitType.ACTOR]);var DO=gt;Pg.ActorBehavior=DO});var MO=p(xi=>{"use strict";Object.defineProperty(xi,"__esModule",{value:!0});xi.ActorBehavior=xi.HONORIFICS=xi.PRONOUNS=xi.ActorTrait=void 0;var LO=sO();Object.defineProperty(xi,"ActorTrait",{enumerable:!0,get:function(){return LO.ActorTrait}});Object.defineProperty(xi,"PRONOUNS",{enumerable:!0,get:function(){return LO.PRONOUNS}});Object.defineProperty(xi,"HONORIFICS",{enumerable:!0,get:function(){return LO.HONORIFICS}});var e3=BB();Object.defineProperty(xi,"ActorBehavior",{enumerable:!0,get:function(){return e3.ActorBehavior}})});var xB=p(uc=>{"use strict";var t3=uc&&uc.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),r3=uc&&uc.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&t3(e,t,r)};Object.defineProperty(uc,"__esModule",{value:!0});r3(dO(),uc)});var jB=p(mc=>{"use strict";var n3=mc&&mc.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),i3=mc&&mc.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&n3(e,t,r)};Object.defineProperty(mc,"__esModule",{value:!0});i3(uO(),mc)});var WB=p(pc=>{"use strict";var o3=pc&&pc.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),a3=pc&&pc.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&o3(e,t,r)};Object.defineProperty(pc,"__esModule",{value:!0});a3(ZI(),pc)});var UB=p(fc=>{"use strict";var s3=fc&&fc.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),c3=fc&&fc.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&s3(e,t,r)};Object.defineProperty(fc,"__esModule",{value:!0});c3(mO(),fc)});var HB=p(gc=>{"use strict";var d3=gc&&gc.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),l3=gc&&gc.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&d3(e,t,r)};Object.defineProperty(gc,"__esModule",{value:!0});l3(cO(),gc)});var qB=p(hc=>{"use strict";var u3=hc&&hc.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),m3=hc&&hc.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&u3(e,t,r)};Object.defineProperty(hc,"__esModule",{value:!0});m3(lO(),hc)});var GB=p(kg=>{"use strict";Object.defineProperty(kg,"__esModule",{value:!0});kg.NpcTrait=void 0;var p3=pO();Object.defineProperty(kg,"NpcTrait",{enumerable:!0,get:function(){return p3.NpcTrait}})});var FB=p(ji=>{"use strict";Object.defineProperty(ji,"__esModule",{value:!0});ji.isVehicle=PO;ji.isActorInVehicle=f3;ji.getActorVehicle=kO;ji.getVehicleOccupants=g3;ji.moveVehicle=h3;ji.canVehicleMove=y3;ji.canActorLeaveLocation=T3;ji.canActorWalkInVehicle=E3;var tl=ee();function PO(t){return t.has(tl.TraitType.VEHICLE)}function f3(t,e){let r=t.getLocation(e);if(!r)return!1;let n=t.getEntity(r);return n?PO(n):!1}function kO(t,e){let r=t.getLocation(e);if(!r)return;let n=t.getEntity(r);if(n&&PO(n))return n}function g3(t,e){return t.getContents(e).filter(n=>n.has(tl.TraitType.ACTOR))}function h3(t,e,r){let n=t.getEntity(e);if(!n)return!1;let i=n.get(tl.TraitType.VEHICLE);if(!i)return!1;if(t.moveEntity(e,r),i.positionRooms){let o=Object.entries(i.positionRooms).find(([a,s])=>s===r);o&&(i.currentPosition=o[0])}return!0}function y3(t){let e=t.get(tl.TraitType.VEHICLE);return e?e.isOperational?{canMove:!0}:{canMove:!1,reason:e.notOperationalReason??"The vehicle is not operational"}:{canMove:!1,reason:"Not a vehicle"}}function T3(t,e){let r=kO(t,e);if(!r)return{canLeave:!0};let n=r.get(tl.TraitType.VEHICLE);return n?n.requiresExitBeforeLeaving?{canLeave:!1,mustExitVehicle:r}:{canLeave:!0}:{canLeave:!0}}function E3(t,e){let r=kO(t,e);if(!r)return{canWalk:!0};let n=r.get(tl.TraitType.VEHICLE);return n?n.blocksWalkingMovement?{canWalk:!1,vehicle:r}:{canWalk:!0,vehicle:r}:{canWalk:!1,vehicle:r}}});var YB=p(as=>{"use strict";var v3=as&&as.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),VB=as&&as.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&v3(e,t,r)};Object.defineProperty(as,"__esModule",{value:!0});VB(gO(),as);VB(FB(),as)});var zB=p(Bg=>{"use strict";Object.defineProperty(Bg,"__esModule",{value:!0});Bg.StoryInfoTrait=void 0;var _3=yO();Object.defineProperty(Bg,"StoryInfoTrait",{enumerable:!0,get:function(){return _3.StoryInfoTrait}})});var jg=p(xg=>{"use strict";Object.defineProperty(xg,"__esModule",{value:!0});xg.createNamespacedId=b3;xg.parseNamespacedId=I3;function b3(t,e){return`${t}.${e}`}function I3(t){let e=t.split(".");if(e.length<2)return null;let r=e.slice(0,-1).join("."),n=e[e.length-1];return{namespace:r,id:n}}});var xO=p(ss=>{"use strict";Object.defineProperty(ss,"__esModule",{value:!0});ss.extensionRegistry=ss.ExtensionRegistry=void 0;ss.getExtensionRegistry=O3;var BO=jg(),Wg=class{constructor(){l(this,"traits",new Map);l(this,"events",new Map);l(this,"actions",new Map);l(this,"namespaces",new Set)}registerTrait(e,r){let n=this.getTraitType(e,r.type);if(this.traits.has(n))throw new Error(`Trait type '${n}' is already registered`);this.traits.set(n,r.implementation),this.namespaces.add(e)}registerEvent(e,r){let n=this.getEventType(e,r.type);if(this.events.has(n))throw new Error(`Event type '${n}' is already registered`);this.events.set(n,r),this.namespaces.add(e)}registerAction(e,r){let n=this.getActionId(e,r.id);if(this.actions.has(n))throw new Error(`Action '${n}' is already registered`);this.actions.set(n,r),this.namespaces.add(e)}getTraitType(e,r){return(0,BO.createNamespacedId)(e,r)}getEventType(e,r){return(0,BO.createNamespacedId)(e,r)}getActionId(e,r){return(0,BO.createNamespacedId)(e,r)}getTrait(e){return this.traits.get(e)}getEvent(e){return this.events.get(e)}getAction(e){return this.actions.get(e)}hasNamespace(e){return this.namespaces.has(e)}getNamespaces(){return Array.from(this.namespaces)}getTraitsByNamespace(e){let r=e+".";return Array.from(this.traits.keys()).filter(n=>n.startsWith(r))}getEventsByNamespace(e){let r=e+".";return Array.from(this.events.keys()).filter(n=>n.startsWith(r))}getActionsByNamespace(e){let r=e+".";return Array.from(this.actions.keys()).filter(n=>n.startsWith(r))}clearNamespace(e){let r=e+".";for(let n of this.traits.keys())n.startsWith(r)&&this.traits.delete(n);for(let n of this.events.keys())n.startsWith(r)&&this.events.delete(n);for(let n of this.actions.keys())n.startsWith(r)&&this.actions.delete(n);this.namespaces.delete(e)}clear(){this.traits.clear(),this.events.clear(),this.actions.clear(),this.namespaces.clear()}getTraits(){return new Map(this.traits)}getEvents(){return new Map(this.events)}getActions(){return new Map(this.actions)}getServices(){return new Map}};ss.ExtensionRegistry=Wg;ss.extensionRegistry=new Wg;function O3(){return ss.extensionRegistry}});var KB=p(cs=>{"use strict";Object.defineProperty(cs,"__esModule",{value:!0});cs.extensionLoader=cs.ExtensionLoader=cs.ExtensionLoadError=void 0;var S3=xO(),xo=class extends Error{constructor(r,n,i){super(r);l(this,"extensionId");l(this,"cause");this.extensionId=n,this.cause=i,this.name="ExtensionLoadError"}};cs.ExtensionLoadError=xo;var Ug=class{constructor(e=S3.extensionRegistry){l(this,"extensions",new Map);l(this,"registry");this.registry=e}async loadExtension(e){let{id:r,namespace:n,dependencies:i}=e.metadata;if(this.extensions.has(r))throw new xo(`Extension '${r}' is already loaded`,r);if(i){for(let o of i)if(!o.optional&&!this.extensions.has(o.id))throw new xo(`Required dependency '${o.id}' is not loaded`,r)}try{if(e.initialize&&await e.initialize(),e.traits)for(let o of e.traits)this.registry.registerTrait(n,o);if(e.events)for(let o of e.events)this.registry.registerEvent(n,o);if(e.actions)for(let o of e.actions)this.registry.registerAction(n,o);this.extensions.set(r,e)}catch(o){throw this.registry.clearNamespace(n),new xo(`Failed to load extension '${r}': ${o}`,r,o instanceof Error?o:void 0)}}async unloadExtension(e){let r=this.extensions.get(e);if(!r)throw new xo(`Extension '${e}' is not loaded`,e);for(let[n,i]of this.extensions){if(n===e)continue;if((i.metadata.dependencies||[]).some(s=>s.id===e&&!s.optional))throw new xo(`Cannot unload '${e}': extension '${n}' depends on it`,e)}try{r.cleanup&&await r.cleanup(),this.registry.clearNamespace(r.metadata.namespace),this.extensions.delete(e)}catch(n){throw new xo(`Failed to unload extension '${e}': ${n}`,e,n instanceof Error?n:void 0)}}getExtension(e){return this.extensions.get(e)}getLoadedExtensions(){return Array.from(this.extensions.values())}isLoaded(e){return this.extensions.has(e)}getLoadOrder(){let e=new Set,r=[],n=i=>{if(e.has(i))return;e.add(i);let o=this.extensions.get(i);if(!o)return;let a=o.metadata.dependencies||[];for(let s of a)this.extensions.has(s.id)&&n(s.id);r.push(i)};for(let i of this.extensions.keys())n(i);return r}validateDependencies(e){let r=[],n=e.metadata.dependencies||[];for(let i of n)!i.optional&&!this.extensions.has(i.id)&&r.push(i.id);return r}};cs.ExtensionLoader=Ug;cs.extensionLoader=new Ug});var XB=p(ht=>{"use strict";var A3=ht&&ht.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),R3=ht&&ht.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&A3(e,t,r)};Object.defineProperty(ht,"__esModule",{value:!0});ht.parseNamespacedId=ht.createNamespacedId=ht.ExtensionLoadError=ht.extensionLoader=ht.ExtensionLoader=ht.extensionRegistry=ht.ExtensionRegistry=void 0;R3(jg(),ht);var $B=xO();Object.defineProperty(ht,"ExtensionRegistry",{enumerable:!0,get:function(){return $B.ExtensionRegistry}});Object.defineProperty(ht,"extensionRegistry",{enumerable:!0,get:function(){return $B.extensionRegistry}});var jO=KB();Object.defineProperty(ht,"ExtensionLoader",{enumerable:!0,get:function(){return jO.ExtensionLoader}});Object.defineProperty(ht,"extensionLoader",{enumerable:!0,get:function(){return jO.extensionLoader}});Object.defineProperty(ht,"ExtensionLoadError",{enumerable:!0,get:function(){return jO.ExtensionLoadError}});var QB=jg();Object.defineProperty(ht,"createNamespacedId",{enumerable:!0,get:function(){return QB.createNamespacedId}});Object.defineProperty(ht,"parseNamespacedId",{enumerable:!0,get:function(){return QB.parseNamespacedId}})});var UO=p(Hg=>{"use strict";Object.defineProperty(Hg,"__esModule",{value:!0});Hg.SpatialIndex=void 0;var WO=class{constructor(){l(this,"parentToChildren",new Map);l(this,"childToParent",new Map)}addChild(e,r){let n=this.childToParent.get(r);n&&this.removeChild(n,r),this.parentToChildren.has(e)||this.parentToChildren.set(e,new Set),this.parentToChildren.get(e).add(r),this.childToParent.set(r,e)}removeChild(e,r){let n=this.parentToChildren.get(e);n&&(n.delete(r),n.size===0&&this.parentToChildren.delete(e)),this.childToParent.delete(r)}remove(e){let r=this.childToParent.get(e);r&&this.removeChild(r,e);let n=this.parentToChildren.get(e);n&&(Array.from(n).forEach(o=>{this.childToParent.delete(o)}),this.parentToChildren.delete(e))}getParent(e){return this.childToParent.get(e)}getChildren(e){let r=this.parentToChildren.get(e);return r?Array.from(r):[]}hasChildren(e){let r=this.parentToChildren.get(e);return r?r.size>0:!1}getAllDescendants(e,r=10){let n=[],i=new Set,o=(a,s)=>{if(s>r||i.has(a))return;i.add(a);let c=this.getChildren(a);n.push(...c),c.forEach(d=>o(d,s+1))};return o(e,0),n}getAncestors(e,r=10){let n=[],i=e,o=0;for(;o<r;){let a=this.getParent(i);if(!a)break;n.push(a),i=a,o++}return n}clear(){this.parentToChildren.clear(),this.childToParent.clear()}toJSON(){return{parentToChildren:Array.from(this.parentToChildren.entries()).map(([e,r])=>({parent:e,children:Array.from(r)})),childToParent:Array.from(this.childToParent.entries())}}loadJSON(e){if(this.clear(),e.parentToChildren)for(let{parent:r,children:n}of e.parentToChildren)this.parentToChildren.set(r,new Set(n));if(e.childToParent)for(let[r,n]of e.childToParent)this.childToParent.set(r,n)}};Hg.SpatialIndex=WO});var ZB=p(HO=>{"use strict";Object.defineProperty(HO,"__esModule",{value:!0});HO.createEffect=C3;function C3(t,e){return{type:t,payload:e}}});var ex=p(jo=>{"use strict";Object.defineProperty(jo,"__esModule",{value:!0});jo.registerCapabilityBehavior=w3;jo.getBehaviorForCapability=N3;jo.getBehaviorBinding=JB;jo.hasCapabilityBehavior=D3;jo.unregisterCapabilityBehavior=L3;jo.clearCapabilityRegistry=M3;jo.getAllCapabilityBindings=P3;var qO="__sharpee_capability_behaviors__";function ri(){let t=globalThis;return t[qO]||(t[qO]=new Map),t[qO]}var rl={get size(){return ri().size},has(t){return ri().has(t)},get(t){return ri().get(t)},set(t,e){return ri().set(t,e)},delete(t){return ri().delete(t)},clear(){return ri().clear()},keys(){return ri().keys()},values(){return ri().values()},entries(){return ri().entries()},[Symbol.iterator](){return ri()[Symbol.iterator]()}};function qg(t,e){return`${t}:${e}`}function w3(t,e,r,n){let i=qg(t,e);if(rl.has(i))throw new Error(`Behavior already registered for trait "${t}" and capability "${e}"`);rl.set(i,{traitType:t,capability:e,behavior:r,priority:n?.priority??0,resolution:n?.resolution,mode:n?.mode,validateBinding:n?.validateBinding})}function N3(t,e){return JB(t,e)?.behavior}function JB(t,e){let r=t.constructor.type,n=qg(r,e),i=rl.get(n);if(i){if(i.validateBinding&&!i.validateBinding(t))throw new Error(`Behavior validation failed for trait "${r}", capability "${e}"`);return i}}function D3(t,e){return rl.has(qg(t,e))}function L3(t,e){rl.delete(qg(t,e))}function M3(){rl.clear()}function P3(){return new Map(ri())}});var tx=p(yc=>{"use strict";Object.defineProperty(yc,"__esModule",{value:!0});yc.defineCapabilityDefaults=k3;yc.getCapabilityConfig=B3;yc.hasCapabilityDefaults=x3;yc.clearCapabilityDefaults=j3;yc.getAllCapabilityDefaults=W3;var GO={resolution:"first-wins",mode:"blocking"},Lu=new Map;function k3(t,e){Lu.set(t,{resolution:e.resolution??GO.resolution,mode:e.mode??GO.mode})}function B3(t){return Lu.get(t)??{...GO}}function x3(t){return Lu.has(t)}function j3(){Lu.clear()}function W3(){return new Map(Lu)}});var nx=p(Tc=>{"use strict";Object.defineProperty(Tc,"__esModule",{value:!0});Tc.findTraitWithCapability=rx;Tc.hasCapability=U3;Tc.getEntityCapabilities=H3;Tc.traitHasCapability=q3;Tc.getCapableTraits=G3;function rx(t,e){for(let r of t.traits.values())if(r.constructor.capabilities?.includes(e))return r}function U3(t,e){return rx(t,e)!==void 0}function H3(t){let e=[];for(let r of t.traits.values()){let n=r.constructor;n.capabilities&&e.push(...n.capabilities)}return e}function q3(t,e,r){let i=t.constructor.capabilities?.includes(e)??!1;return r?i&&t instanceof r:i}function G3(t){return Array.from(t.traits.values()).filter(e=>{let r=e.constructor;return r.capabilities&&r.capabilities.length>0})}});var ix=p(Mu=>{"use strict";Object.defineProperty(Mu,"__esModule",{value:!0});Mu.EntityBuilder=void 0;Mu.buildEntity=F3;var Gg=class{constructor(e){l(this,"entity");l(this,"claimedCaps",new Set);this.entity=e}add(e){let r=e.constructor,n=r.capabilities??[];for(let i of n){if(this.claimedCaps.has(i)){let o=this.findTraitWithCapability(i),a=o?o.constructor.type:"unknown";throw new Error(`Entity "${this.entity.id}": capability "${i}" already claimed by trait "${a}". New trait "${r.type}" cannot also claim it.`)}this.claimedCaps.add(i)}return this.entity.add(e),this}build(){return this.entity}getClaimedCapabilities(){return Array.from(this.claimedCaps)}findTraitWithCapability(e){for(let r of this.entity.traits.values())if(r.constructor.capabilities?.includes(e))return r}};Mu.EntityBuilder=Gg;function F3(t){return new Gg(t)}});var ox=p(Wo=>{"use strict";Object.defineProperty(Wo,"__esModule",{value:!0});Wo.registerActionInterceptor=V3;Wo.getInterceptorForAction=Y3;Wo.getInterceptorBinding=z3;Wo.hasActionInterceptor=K3;Wo.unregisterActionInterceptor=$3;Wo.clearInterceptorRegistry=Q3;Wo.getAllInterceptorBindings=X3;var FO="__sharpee_interceptor_registry__";function Wi(){let t=globalThis;return t[FO]||(t[FO]=new Map),t[FO]}var ds={get size(){return Wi().size},has(t){return Wi().has(t)},get(t){return Wi().get(t)},set(t,e){return Wi().set(t,e)},delete(t){return Wi().delete(t)},clear(){return Wi().clear()},keys(){return Wi().keys()},values(){return Wi().values()},entries(){return Wi().entries()},[Symbol.iterator](){return Wi()[Symbol.iterator]()}};function Pu(t,e){return`${t}:${e}`}function V3(t,e,r,n){let i=Pu(t,e);if(ds.has(i))throw new Error(`Interceptor already registered for trait "${t}" and action "${e}"`);ds.set(i,{traitType:t,actionId:e,interceptor:r,priority:n?.priority??0})}function Y3(t,e){let r=[];for(let o of t.traits.values()){let a=o.type,s=Pu(a,e),c=ds.get(s);c&&r.push({trait:o,binding:c})}if(r.length===0)return;r.sort((o,a)=>a.binding.priority-o.binding.priority);let{trait:n,binding:i}=r[0];return{interceptor:i.interceptor,trait:n,binding:i}}function z3(t,e){return ds.get(Pu(t,e))}function K3(t,e){return ds.has(Pu(t,e))}function $3(t,e){ds.delete(Pu(t,e))}function Q3(){ds.clear()}function X3(){return new Map(ds)}});var sx=p(Ec=>{"use strict";Object.defineProperty(Ec,"__esModule",{value:!0});Ec.findTraitWithInterceptor=ax;Ec.hasInterceptor=Z3;Ec.getEntityInterceptors=J3;Ec.traitHasInterceptor=eX;Ec.getInterceptorTraits=tX;function ax(t,e){for(let r of t.traits.values())if(r.constructor.interceptors?.includes(e))return r}function Z3(t,e){return ax(t,e)!==void 0}function J3(t){let e=[];for(let r of t.traits.values()){let n=r.constructor;n.interceptors&&e.push(...n.interceptors)}return e}function eX(t,e,r){let i=t.constructor.interceptors?.includes(e)??!1;return r?i&&t instanceof r:i}function tX(t){return Array.from(t.traits.values()).filter(e=>{let r=e.constructor;return r.interceptors&&r.interceptors.length>0})}});var VO=p(Y=>{"use strict";Object.defineProperty(Y,"__esModule",{value:!0});Y.getInterceptorTraits=Y.traitHasInterceptor=Y.getEntityInterceptors=Y.hasInterceptor=Y.findTraitWithInterceptor=Y.getAllInterceptorBindings=Y.clearInterceptorRegistry=Y.unregisterActionInterceptor=Y.hasActionInterceptor=Y.getInterceptorBinding=Y.getInterceptorForAction=Y.registerActionInterceptor=Y.buildEntity=Y.EntityBuilder=Y.getCapableTraits=Y.traitHasCapability=Y.getEntityCapabilities=Y.hasCapability=Y.findTraitWithCapability=Y.getAllCapabilityDefaults=Y.clearCapabilityDefaults=Y.hasCapabilityDefaults=Y.getCapabilityConfig=Y.defineCapabilityDefaults=Y.getAllCapabilityBindings=Y.clearCapabilityRegistry=Y.unregisterCapabilityBehavior=Y.hasCapabilityBehavior=Y.getBehaviorBinding=Y.getBehaviorForCapability=Y.registerCapabilityBehavior=Y.createEffect=void 0;var rX=ZB();Object.defineProperty(Y,"createEffect",{enumerable:!0,get:function(){return rX.createEffect}});var vc=ex();Object.defineProperty(Y,"registerCapabilityBehavior",{enumerable:!0,get:function(){return vc.registerCapabilityBehavior}});Object.defineProperty(Y,"getBehaviorForCapability",{enumerable:!0,get:function(){return vc.getBehaviorForCapability}});Object.defineProperty(Y,"getBehaviorBinding",{enumerable:!0,get:function(){return vc.getBehaviorBinding}});Object.defineProperty(Y,"hasCapabilityBehavior",{enumerable:!0,get:function(){return vc.hasCapabilityBehavior}});Object.defineProperty(Y,"unregisterCapabilityBehavior",{enumerable:!0,get:function(){return vc.unregisterCapabilityBehavior}});Object.defineProperty(Y,"clearCapabilityRegistry",{enumerable:!0,get:function(){return vc.clearCapabilityRegistry}});Object.defineProperty(Y,"getAllCapabilityBindings",{enumerable:!0,get:function(){return vc.getAllCapabilityBindings}});var ku=tx();Object.defineProperty(Y,"defineCapabilityDefaults",{enumerable:!0,get:function(){return ku.defineCapabilityDefaults}});Object.defineProperty(Y,"getCapabilityConfig",{enumerable:!0,get:function(){return ku.getCapabilityConfig}});Object.defineProperty(Y,"hasCapabilityDefaults",{enumerable:!0,get:function(){return ku.hasCapabilityDefaults}});Object.defineProperty(Y,"clearCapabilityDefaults",{enumerable:!0,get:function(){return ku.clearCapabilityDefaults}});Object.defineProperty(Y,"getAllCapabilityDefaults",{enumerable:!0,get:function(){return ku.getAllCapabilityDefaults}});var Bu=nx();Object.defineProperty(Y,"findTraitWithCapability",{enumerable:!0,get:function(){return Bu.findTraitWithCapability}});Object.defineProperty(Y,"hasCapability",{enumerable:!0,get:function(){return Bu.hasCapability}});Object.defineProperty(Y,"getEntityCapabilities",{enumerable:!0,get:function(){return Bu.getEntityCapabilities}});Object.defineProperty(Y,"traitHasCapability",{enumerable:!0,get:function(){return Bu.traitHasCapability}});Object.defineProperty(Y,"getCapableTraits",{enumerable:!0,get:function(){return Bu.getCapableTraits}});var cx=ix();Object.defineProperty(Y,"EntityBuilder",{enumerable:!0,get:function(){return cx.EntityBuilder}});Object.defineProperty(Y,"buildEntity",{enumerable:!0,get:function(){return cx.buildEntity}});var _c=ox();Object.defineProperty(Y,"registerActionInterceptor",{enumerable:!0,get:function(){return _c.registerActionInterceptor}});Object.defineProperty(Y,"getInterceptorForAction",{enumerable:!0,get:function(){return _c.getInterceptorForAction}});Object.defineProperty(Y,"getInterceptorBinding",{enumerable:!0,get:function(){return _c.getInterceptorBinding}});Object.defineProperty(Y,"hasActionInterceptor",{enumerable:!0,get:function(){return _c.hasActionInterceptor}});Object.defineProperty(Y,"unregisterActionInterceptor",{enumerable:!0,get:function(){return _c.unregisterActionInterceptor}});Object.defineProperty(Y,"clearInterceptorRegistry",{enumerable:!0,get:function(){return _c.clearInterceptorRegistry}});Object.defineProperty(Y,"getAllInterceptorBindings",{enumerable:!0,get:function(){return _c.getAllInterceptorBindings}});var xu=sx();Object.defineProperty(Y,"findTraitWithInterceptor",{enumerable:!0,get:function(){return xu.findTraitWithInterceptor}});Object.defineProperty(Y,"hasInterceptor",{enumerable:!0,get:function(){return xu.hasInterceptor}});Object.defineProperty(Y,"getEntityInterceptors",{enumerable:!0,get:function(){return xu.getEntityInterceptors}});Object.defineProperty(Y,"traitHasInterceptor",{enumerable:!0,get:function(){return xu.traitHasInterceptor}});Object.defineProperty(Y,"getInterceptorTraits",{enumerable:!0,get:function(){return xu.getInterceptorTraits}})});var YO=p(Ur=>{"use strict";Object.defineProperty(Ur,"__esModule",{value:!0});Ur.VisibilityBehavior=Ur.VISIBILITY_CAPABILITY=void 0;var nX=Dt(),ie=ee(),iX=of(),ls=VO();Ur.VISIBILITY_CAPABILITY="if.scope.visible";var Fg=class extends nX.Behavior{static isDark(e,r){let n=e.getTrait(ie.TraitType.ROOM);return!n||!n.isDark?!1:!this.hasLightSource(e,r)}static isLightActive(e){let r=e.getTrait(ie.TraitType.LIGHT_SOURCE);return r?.isLit!==void 0?r.isLit===!0:e.hasTrait(ie.TraitType.SWITCHABLE)?iX.SwitchableBehavior.isOn(e):!0}static canSee(e,r,n){if(e.id===r.id)return!0;let i=r.getTrait(ie.TraitType.SCENERY);if(i&&i.visible===!1)return!1;let o=(0,ls.findTraitWithCapability)(r,Ur.VISIBILITY_CAPABILITY);if(o){let u=(0,ls.getBehaviorForCapability)(o,Ur.VISIBILITY_CAPABILITY);if(u&&!u.validate(r,n,e.id,{}).valid)return!1}let a=n.getContainingRoom(e.id),s=n.getContainingRoom(r.id);if(r.hasTrait(ie.TraitType.ROOM))return a?.id===r.id;if(!a||a.id!==s?.id)return!1;let c=a.getTrait(ie.TraitType.ROOM);return c&&c.isDark&&!this.hasLightSource(a,n)?!!(r.hasTrait(ie.TraitType.LIGHT_SOURCE)&&r.getTrait(ie.TraitType.LIGHT_SOURCE)?.isLit===!0||n.getLocation(r.id)===e.id):this.hasLineOfSight(e.id,r.id,n)}static getVisible(e,r){let n=[],i=new Set,o=r.getContainingRoom(e.id);if(!o)return n;this.canSee(e,o,r)&&(n.push(o),i.add(o.id));let a=o.getTrait(ie.TraitType.ROOM),s=a&&a.isDark,c=this.hasLightSource(o,r);if(s&&!c){let m=r.getContents(e.id);for(let g of m)i.has(g.id)||(n.push(g),i.add(g.id));let f=r.getAllContents(o.id,{recursive:!0});for(let g of f)if(g.hasTrait(ie.TraitType.LIGHT_SOURCE)){let h=g.getTrait(ie.TraitType.LIGHT_SOURCE);h&&h.isLit===!0&&!i.has(g.id)&&(n.push(g),i.add(g.id))}return n}let d=r.getContents(o.id);for(let m of d)if(m.id!==e.id&&!i.has(m.id)){let f=m.getTrait(ie.TraitType.IDENTITY);if(f&&f.concealed===!0)continue;let g=m.getTrait(ie.TraitType.SCENERY);if(g&&g.visible===!1)continue;let h=(0,ls.findTraitWithCapability)(m,Ur.VISIBILITY_CAPABILITY);if(h){let y=(0,ls.getBehaviorForCapability)(h,Ur.VISIBILITY_CAPABILITY);if(y&&!y.validate(m,r,e.id,{}).valid)continue}n.push(m),i.add(m.id),(m.hasTrait(ie.TraitType.CONTAINER)||m.hasTrait(ie.TraitType.SUPPORTER)||m.hasTrait(ie.TraitType.ACTOR))&&this.addVisibleContents(m,n,i,r)}let u=r.getContents(e.id);for(let m of u)i.has(m.id)||(n.push(m),i.add(m.id),(m.hasTrait(ie.TraitType.CONTAINER)||m.hasTrait(ie.TraitType.SUPPORTER))&&this.addVisibleContents(m,n,i,r));return n}static addVisibleContents(e,r,n,i){if(e.hasTrait(ie.TraitType.CONTAINER)&&!(e.getTrait(ie.TraitType.CONTAINER)?.isTransparent??!1)&&e.hasTrait(ie.TraitType.OPENABLE)&&!(e.getTrait(ie.TraitType.OPENABLE)?.isOpen??!1))return;let o=i.getContents(e.id,{includeWorn:!0});for(let a of o)if(!n.has(a.id)){let s=a.getTrait(ie.TraitType.SCENERY);if(s&&s.visible===!1)continue;let c=(0,ls.findTraitWithCapability)(a,Ur.VISIBILITY_CAPABILITY);if(c){let d=(0,ls.getBehaviorForCapability)(c,Ur.VISIBILITY_CAPABILITY);if(d&&!d.validate(a,i,e.id,{}).valid)continue}r.push(a),n.add(a.id),(a.hasTrait(ie.TraitType.CONTAINER)||a.hasTrait(ie.TraitType.SUPPORTER)||a.hasTrait(ie.TraitType.ACTOR))&&this.addVisibleContents(a,r,n,i)}}static hasLightSource(e,r){let n=r.getAllContents(e.id,{recursive:!0,includeWorn:!0});for(let i of n)if(i.hasTrait(ie.TraitType.LIGHT_SOURCE)&&this.isLightActive(i)&&this.isAccessible(i.id,e.id,r))return!0;return!1}static isAccessible(e,r,n){let i=e;for(;i!==r;){let o=n.getLocation(i);if(!o)return!1;let a=n.getEntity(o);if(!a)return!1;if(a.hasTrait(ie.TraitType.ACTOR)){i=o;continue}if(a.hasTrait(ie.TraitType.CONTAINER)&&!(a.getTrait(ie.TraitType.CONTAINER)?.isTransparent??!1)&&a.hasTrait(ie.TraitType.OPENABLE)&&!(a.getTrait(ie.TraitType.OPENABLE)?.isOpen??!1))return!1;i=o}return!0}static hasLineOfSight(e,r,n){let i=this.getContainmentPath(r,n);for(let o=0;o<i.length-1;o++){let a=i[o],s=i[o+1],c=n.getEntity(s);if(!c)return!1;if(!c.hasTrait(ie.TraitType.ACTOR)&&c.hasTrait(ie.TraitType.CONTAINER)&&!(c.getTrait(ie.TraitType.CONTAINER)?.isTransparent??!1)&&c.hasTrait(ie.TraitType.OPENABLE)&&!(c.getTrait(ie.TraitType.OPENABLE)?.isOpen??!1))return!1}return!0}static getContainmentPath(e,r){let n=[e],i=e,o=0,a=10;for(;o<a;){let s=r.getLocation(i);if(!s||(n.push(s),r.getEntity(s)?.hasTrait(ie.TraitType.ROOM)))break;i=s,o++}return n}static isVisible(e,r){let n=e.getTrait(ie.TraitType.SCENERY);if(n&&n.visible===!1)return!1;let i=(0,ls.findTraitWithCapability)(e,Ur.VISIBILITY_CAPABILITY);if(i){let a=(0,ls.getBehaviorForCapability)(i,Ur.VISIBILITY_CAPABILITY);if(a&&!a.validate(e,r,"",{}).valid)return!1}let o=e.id;for(;;){let a=r.getLocation(o);if(!a)break;let s=r.getEntity(a);if(!s)break;if(s.hasTrait(ie.TraitType.ACTOR)){o=a;continue}if(s.hasTrait(ie.TraitType.CONTAINER)&&!(s.getTrait(ie.TraitType.CONTAINER)?.isTransparent??!1)&&s.hasTrait(ie.TraitType.OPENABLE)&&!(s.getTrait(ie.TraitType.OPENABLE)?.isOpen??!1))return!1;o=a}return!0}static getDescribableLocation(e,r){let n=r.getLocation(e.id);if(!n)return{location:e,immediateContainer:null};let i=r.getEntity(n);if(!i)return{location:e,immediateContainer:null};if(i.hasTrait(ie.TraitType.ROOM))return{location:i,immediateContainer:null};if(i.hasTrait(ie.TraitType.VEHICLE)){if(i.getTrait(ie.TraitType.VEHICLE).transparent){let a=r.getContainingRoom(e.id);if(a)return{location:a,immediateContainer:i}}return{location:i,immediateContainer:null}}if(i.hasTrait(ie.TraitType.CONTAINER)){if(i.hasTrait(ie.TraitType.OPENABLE)&&i.getTrait(ie.TraitType.OPENABLE)?.isOpen){let a=r.getContainingRoom(e.id);if(a)return{location:a,immediateContainer:i}}return{location:i,immediateContainer:null}}return{location:i,immediateContainer:null}}};l(Fg,"requiredTraits",[]);Ur.VisibilityBehavior=Fg});var KO=p(Vg=>{"use strict";Object.defineProperty(Vg,"__esModule",{value:!0});Vg.ScopeRegistry=void 0;var zO=class{constructor(){l(this,"rules",new Map);l(this,"rulesByLocation",new Map);l(this,"rulesByAction",new Map);l(this,"globalRules",new Set)}addRule(e){if(!e.id)throw new Error("Scope rule must have an id");if(e.priority=e.priority??100,e.enabled=e.enabled??!0,e.source=e.source??"core",this.rules.set(e.id,e),e.fromLocations==="*")this.globalRules.add(e.id);else for(let r of e.fromLocations)this.rulesByLocation.has(r)||this.rulesByLocation.set(r,new Set),this.rulesByLocation.get(r).add(e.id);if(e.forActions&&e.forActions!=="*")for(let r of e.forActions)this.rulesByAction.has(r)||this.rulesByAction.set(r,new Set),this.rulesByAction.get(r).add(e.id)}removeRule(e){let r=this.rules.get(e);if(!r)return!1;if(this.rules.delete(e),r.fromLocations==="*")this.globalRules.delete(e);else for(let n of r.fromLocations)this.rulesByLocation.get(n)?.delete(e);if(r.forActions&&r.forActions!=="*")for(let n of r.forActions)this.rulesByAction.get(n)?.delete(e);return!0}getRule(e){return this.rules.get(e)}getAllRules(){return Array.from(this.rules.values())}getApplicableRules(e){let r=new Set;for(let o of this.globalRules)r.add(o);let n=this.rulesByLocation.get(e.currentLocation);if(n)for(let o of n)r.add(o);let i=[];for(let o of r){let a=this.rules.get(o);!a||!a.enabled||e.actionId&&a.forActions&&a.forActions!=="*"&&!a.forActions.includes(e.actionId)||i.push(a)}return i.sort((o,a)=>(a.priority||0)-(o.priority||0))}setRuleEnabled(e,r){let n=this.rules.get(e);return n?(n.enabled=r,!0):!1}clear(){this.rules.clear(),this.rulesByLocation.clear(),this.rulesByAction.clear(),this.globalRules.clear()}getRulesBySource(e){return Array.from(this.rules.values()).filter(r=>r.source===e)}getStats(){let e={totalRules:this.rules.size,enabledRules:0,disabledRules:0,globalRules:this.globalRules.size,locationSpecificRules:0,actionSpecificRules:0,rulesBySource:new Map};for(let r of this.rules.values()){r.enabled?e.enabledRules++:e.disabledRules++,r.fromLocations!=="*"&&e.locationSpecificRules++,r.forActions&&r.forActions!=="*"&&e.actionSpecificRules++;let n=r.source||"unknown";e.rulesBySource.set(n,(e.rulesBySource.get(n)||0)+1)}return e}};Vg.ScopeRegistry=zO});var QO=p(Yg=>{"use strict";Object.defineProperty(Yg,"__esModule",{value:!0});Yg.ScopeEvaluator=void 0;var $O=class{constructor(e){l(this,"registry");l(this,"cache",new Map);this.registry=e}evaluate(e,r={}){let n=Date.now(),i=this.getCacheKey(e);if(r.cache&&this.cache.has(i)){let u=this.cache.get(i);return u.metrics&&(u.metrics.cacheHits=(u.metrics.cacheHits||0)+1),u}let o=this.registry.getApplicableRules(e);r.ruleFilter&&(o=o.filter(r.ruleFilter)),r.maxRules&&o.length>r.maxRules&&(o=o.slice(0,r.maxRules));let a=new Set,s=[],c=[];for(let u of o){let m=this.evaluateRule(u,e);if(m.conditionMet){for(let f of m.includedEntities)a.add(f);s.push(m)}else r.debug&&c.push(u)}let d={entityIds:a,appliedRules:s,metrics:{rulesEvaluated:o.length,totalTime:Date.now()-n,cacheHits:0}};return r.debug&&(d.skippedRules=c),r.cache&&this.cache.set(i,d),d}evaluateRule(e,r){if(!(!e.condition||e.condition(r)))return{rule:e,includedEntities:[],conditionMet:!1};let i=[];if(e.includeEntities&&(typeof e.includeEntities=="function"?i=e.includeEntities(r):i=[...e.includeEntities]),e.includeLocations&&r.world)for(let a of e.includeLocations){let s=this.getEntitiesInLocation(r.world,a);i.push(...s)}let o;return e.message&&(typeof e.message=="function"?o=e.message(i[0]||"",r.actionId||""):o=e.message),{rule:e,includedEntities:i,conditionMet:!0,message:o}}getEntitiesInLocation(e,r){let n=[];if(e.getEntity(r)&&n.push(r),e.getContents){let i=e.getContents(r)||[];n.push(...i.map(o=>o.id));for(let o of i)if(e.getAllContents){let a=e.getAllContents(o.id)||[];n.push(...a.map(s=>s.id))}}return n}getCacheKey(e){return`${e.actorId}:${e.currentLocation}:${e.actionId||"any"}`}clearCache(){this.cache.clear()}getVisibleEntities(e){let r={...e,actionId:e.actionId||"examining"},n=this.evaluate(r);return Array.from(n.entityIds)}getTouchableEntities(e){return this.getVisibleEntities(e)}isEntityInScope(e,r){return this.evaluate(r).entityIds.has(e)}getScopeWithDetails(e){let r=this.evaluate(e,{debug:!0}),n=new Map;for(let i of r.appliedRules)n.set(i.rule.id,{rule:i.rule,entities:i.includedEntities,message:i.message});return{entities:Array.from(r.entityIds),ruleDetails:n}}};Yg.ScopeEvaluator=$O});var px=p(Kg=>{"use strict";Object.defineProperty(Kg,"__esModule",{value:!0});Kg.WorldModel=void 0;var XO=Bd(),Uo=uI(),Hr=ee(),oX=IO(),zg=bO(),aX=EO(),sX=AO(),cX=MO(),dX=NO(),dx=OO(),lX=Cf(),uX=Ru(),mX=Cu(),lx=VI(),pX=UO(),ux=YO(),fX=TO(),gX=jt(),hX=KO(),yX=QO(),mx={room:"r",door:"d",item:"i",actor:"a",container:"c",supporter:"s",scenery:"y",exit:"e",object:"o"},ZO=class{constructor(e={},r){l(this,"entities",new Map);l(this,"state",{});l(this,"playerId");l(this,"spatialIndex");l(this,"config");l(this,"capabilities",{});l(this,"scoreLedger",[]);l(this,"scoreMaxScore",0);l(this,"idCounters",new Map);l(this,"eventHandlers",new Map);l(this,"eventValidators",new Map);l(this,"eventPreviewers",new Map);l(this,"appliedEvents",[]);l(this,"eventProcessorWiring",null);l(this,"maxEventHistory",1e3);l(this,"eventChains",new Map);l(this,"platformEvents");l(this,"scopeRegistry");l(this,"scopeEvaluator");l(this,"grammarVocabularyProvider");l(this,"relationships",new Map);this.config={enableSpatialIndex:!0,maxDepth:10,strictMode:!1,...e},this.spatialIndex=new pX.SpatialIndex,this.platformEvents=r,this.scopeRegistry=new hX.ScopeRegistry,this.scopeEvaluator=new yX.ScopeEvaluator(this.scopeRegistry),this.grammarVocabularyProvider=new gX.GrammarVocabularyProvider,this.registerDefaultScopeRules()}emitPlatformEvent(e,r){this.platformEvents&&this.platformEvents.addEvent({id:`world_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),type:`platform.world.${e}`,entities:{},data:{subsystem:"world",...r},tags:["platform","world","debug"],priority:0,narrate:!1})}registerCapability(e,r={}){if(this.capabilities[e]){if(this.config.strictMode)throw new Error(`Capability '${e}' is already registered`);return}let n={};if(r.schema)for(let[i,o]of Object.entries(r.schema))o.default!==void 0&&(n[i]=o.default);r.initialData&&Object.assign(n,r.initialData),this.capabilities[e]={data:n,schema:r.schema}}updateCapability(e,r){let n=this.capabilities[e];if(!n){if(this.config.strictMode)throw new Error(`Capability '${e}' is not registered`);return}if(n.schema)for(let[i,o]of Object.entries(r)){let a=n.schema[i];if(a){let s=Array.isArray(o)?"array":typeof o;if(s!==a.type&&o!==null&&o!==void 0&&this.config.strictMode)throw new Error(`Invalid type for capability '${e}' field '${i}': expected ${a.type}, got ${s}`)}}Object.assign(n.data,r)}getCapability(e){return this.capabilities[e]?.data}hasCapability(e){return e in this.capabilities}generateId(e){let r=mx[e]||mx.object,i=(this.idCounters.get(r)||0)+1;if(i>1295)throw new Error(`ID overflow for type '${e}' (prefix '${r}'). Maximum 1296 entities per type.`);this.idCounters.set(r,i);let o=i.toString(36).padStart(2,"0");return`${r}${o}`}createEntity(e,r="object"){if(!(0,Uo.isEntityType)(r))throw new Error(`Unknown entity type: '${r}'. Valid types are: ${Object.values(Uo.EntityType).join(", ")}`);let n=this.generateId(r),i=new XO.IFEntity(n,r,{attributes:{displayName:e,name:e,entityType:r}});return this.entities.set(n,i),i}createEntityWithTraits(e){let r=this.generateId(e),n=new XO.IFEntity(r,e);switch(e){case Uo.EntityType.ROOM:n.add(new oX.RoomTrait({}));break;case Uo.EntityType.CONTAINER:n.add(new aX.ContainerTrait);break;case Uo.EntityType.SUPPORTER:n.add(new sX.SupporterTrait);break;case Uo.EntityType.ACTOR:n.add(new cX.ActorTrait);break;case Uo.EntityType.DOOR:break;case Uo.EntityType.SCENERY:n.add(new dx.SceneryTrait);break}return this.entities.set(r,n),n}getEntity(e){return this.entities.get(e)}hasEntity(e){return this.entities.has(e)}removeEntity(e){return this.entities.get(e)?(this.spatialIndex.remove(e),this.getLocation(e)&&this.moveEntity(e,null),this.entities.delete(e)):!1}getAllEntities(){return Array.from(this.entities.values())}updateEntity(e,r){let n=this.getEntity(e);if(!n){if(this.config.strictMode)throw new Error(`Cannot update non-existent entity: ${e}`);return}r(n)}getLocation(e){return this.spatialIndex.getParent(e)}getContents(e,r={}){let i=this.spatialIndex.getChildren(e).map(o=>this.getEntity(o)).filter(o=>o!==void 0);return r.visibleOnly&&(i=i.filter(o=>{let a=o.getTrait(Hr.TraitType.SCENERY);return!a||a.visible!==!1})),r.includeWorn||(i=i.filter(o=>{let a=o.getTrait(Hr.TraitType.WEARABLE),s=o.getTrait(Hr.TraitType.CLOTHING),c=a&&a.isWorn,d=s&&s.isWorn;return!(c||d)})),i}moveEntity(e,r){if(!this.canMoveEntity(e,r))return this.emitPlatformEvent("move_entity_failed",{entityId:e,targetId:r,reason:"cannot_move"}),!1;let n=this.getLocation(e);return n&&this.spatialIndex.removeChild(n,e),r&&this.spatialIndex.addChild(r,e),this.emitPlatformEvent("entity_moved",{entityId:e,fromLocation:n,toLocation:r}),!0}canMoveEntity(e,r){if(!this.getEntity(e))return!1;if(r===null)return!0;let i=this.getEntity(r);if(!i||this.wouldCreateLoop(e,r)||!(0,fX.canContain)(i))return!1;if(i.hasTrait(Hr.TraitType.CONTAINER)&&i.hasTrait(Hr.TraitType.OPENABLE)){let o=i.getTrait(Hr.TraitType.OPENABLE);if(o&&!o.isOpen)return!1}return!0}getContainingRoom(e){let r=e,n=0;for(;r&&n<this.config.maxDepth;){let i=this.getLocation(r);if(!i)return;let o=this.getEntity(i);if(o?.hasTrait(Hr.TraitType.ROOM))return o;r=i,n++}}getAllContents(e,r={}){let n=[],i=new Set,o=(a,s=0,c=!1)=>{if(i.has(a)||s>this.config.maxDepth)return;i.add(a);let d=c?{visibleOnly:r.visibleOnly,includeWorn:r.includeWorn}:{visibleOnly:r.visibleOnly,includeWorn:!0},u=this.getContents(a,d);n.push(...u),r.recursive&&u.forEach(m=>o(m.id,s+1,!1))};return o(e,0,!0),n}getState(){return{...this.state}}setState(e){this.state={...e}}getStateValue(e){return this.state[e]}setStateValue(e,r){this.state[e]=r}findByTrait(e){return this.findWhere(r=>r.hasTrait(e))}findByType(e){return this.findWhere(r=>r.type===e)}findWhere(e){return Array.from(this.entities.values()).filter(e)}getRelated(e,r){let n=this.relationships.get(e);if(!n)return[];let i=n.get(r);return i?Array.from(i):[]}areRelated(e,r,n){return this.getRelated(e,n).includes(r)}addRelationship(e,r,n){if(!this.hasEntity(e)||!this.hasEntity(r)){if(this.config.strictMode)throw new Error("Cannot add relationship between non-existent entities");return}this.relationships.has(e)||this.relationships.set(e,new Map);let i=this.relationships.get(e);i.has(n)||i.set(n,new Set),i.get(n).add(r)}removeRelationship(e,r,n){let i=this.relationships.get(e);if(!i)return;let o=i.get(n);o&&(o.delete(r),o.size===0&&i.delete(n)),i.size===0&&this.relationships.delete(e)}getTotalWeight(e){let r=this.getEntity(e);if(!r)return 0;let n=r.weight||0,i=this.getAllContents(e,{recursive:!0});for(let o of i)n+=o.weight||0;return n}wouldCreateLoop(e,r){if(e===r)return!0;let n=r,i=new Set;for(;n;){if(i.has(n))return!1;if(n===e)return!0;i.add(n),n=this.getLocation(n)||""}return!1}findPath(e,r){if(e===r)return[];let n=this.getEntity(e),i=this.getEntity(r);if(!n?.hasTrait(Hr.TraitType.ROOM)||!i?.hasTrait(Hr.TraitType.ROOM))return null;let o=[{roomId:e,path:[]}],a=new Set;for(;o.length>0;){let{roomId:s,path:c}=o.shift();if(a.has(s))continue;a.add(s);let d=this.getEntity(s);if(!d)continue;let u=d.getTrait(Hr.TraitType.ROOM)?.exits||{};for(let[m,f]of Object.entries(u)){let g,h;if(typeof f=="string")g=f,h=f;else if(typeof f=="object")if(f.via){let y=this.getEntity(f.via);if(!y)continue;if(h=f.via,y.hasTrait(Hr.TraitType.DOOR)){let T=y.getTrait(Hr.TraitType.DOOR);g=T?.room1===s?T?.room2:T?.room1}else if(y.hasTrait(Hr.TraitType.EXIT))g=y.getTrait(Hr.TraitType.EXIT)?.to;else continue}else f.destination&&(g=f.destination,h=g);if(!(!g||!h)){if(g===r)return h===g&&c.length===0?[]:[...c,h];if(!a.has(g)){let y=h===g?c:[...c,h];o.push({roomId:g,path:y})}}}}return null}getPlayer(){return this.playerId?this.getEntity(this.playerId):void 0}setPlayer(e){if(!this.hasEntity(e))throw new Error(`Cannot set player to non-existent entity: ${e}`);this.playerId=e}awardScore(e,r,n){return this.scoreLedger.some(i=>i.id===e)?!1:(this.scoreLedger.push({id:e,points:r,description:n}),!0)}revokeScore(e){let r=this.scoreLedger.findIndex(n=>n.id===e);return r<0?!1:(this.scoreLedger.splice(r,1),!0)}hasScore(e){return this.scoreLedger.some(r=>r.id===e)}getScore(){let e=0;for(let r of this.scoreLedger)e+=r.points;return e}getScoreEntries(){return[...this.scoreLedger]}setMaxScore(e){this.scoreMaxScore=e}getMaxScore(){return this.scoreMaxScore}toJSON(){let e={entities:Array.from(this.entities.entries()).map(([r,n])=>({id:r,entity:n.toJSON()})),state:this.state,playerId:this.playerId,spatialIndex:this.spatialIndex.toJSON(),relationships:Array.from(this.relationships.entries()).map(([r,n])=>({entityId:r,relationships:Array.from(n.entries()).map(([i,o])=>({type:i,related:Array.from(o)}))})),idCounters:Array.from(this.idCounters.entries()),scoreLedger:this.scoreLedger,scoreMaxScore:this.scoreMaxScore,capabilities:Object.entries(this.capabilities).map(([r,n])=>({name:r,data:n.data,schema:n.schema}))};return JSON.stringify(e,null,2)}loadJSON(e){let r=JSON.parse(e),n=new Map(this.eventChains),i={...this.capabilities};this.clear();for(let[o,a]of n)this.eventChains.set(o,a);this.capabilities=i;for(let{id:o,entity:a}of r.entities){let s=XO.IFEntity.fromJSON(a);this.entities.set(o,s)}if(this.state=r.state||{},this.playerId=r.playerId,r.spatialIndex&&this.spatialIndex.loadJSON(r.spatialIndex),r.relationships)for(let{entityId:o,relationships:a}of r.relationships){let s=new Map;for(let{type:c,related:d}of a)s.set(c,new Set(d));this.relationships.set(o,s)}if(r.idCounters?this.idCounters=new Map(r.idCounters):this.rebuildIdCounters(),r.capabilities)for(let{name:o,data:a,schema:s}of r.capabilities)this.capabilities[o]={data:a,schema:s};r.scoreLedger&&(this.scoreLedger=r.scoreLedger),r.scoreMaxScore!==void 0&&(this.scoreMaxScore=r.scoreMaxScore)}clear(){this.entities.clear(),this.state={},this.playerId=void 0,this.spatialIndex.clear(),this.relationships.clear(),this.appliedEvents=[],this.idCounters.clear(),this.capabilities={},this.scoreLedger=[],this.scoreMaxScore=0,this.grammarVocabularyProvider.clear(),this.eventChains.clear()}registerEventHandler(e,r){this.eventHandlers.set(e,r),this.eventProcessorWiring&&this.wireHandlerToProcessor(e,r)}unregisterEventHandler(e){this.eventHandlers.delete(e)}registerEventValidator(e,r){this.eventValidators.set(e,r)}registerEventPreviewer(e,r){this.eventPreviewers.set(e,r)}connectEventProcessor(e){this.eventProcessorWiring=e;for(let[r,n]of this.eventHandlers)this.wireHandlerToProcessor(r,n);for(let r of this.eventChains.keys())this.wireChainToProcessor(r)}wireHandlerToProcessor(e,r){if(!this.eventProcessorWiring)return;let n=i=>(r(i,this),[]);this.eventProcessorWiring.registerHandler(e,n)}chainEvent(e,r,n={}){let{mode:i="cascade",key:o,priority:a=100}=n,s={handler:r,key:o,priority:a};this.eventChains.has(e)||this.eventChains.set(e,[]);let c=this.eventChains.get(e);if(i==="override")this.eventChains.set(e,[s]);else if(o){let d=c.findIndex(u=>u.key===o);d>=0?c[d]=s:c.push(s)}else c.push(s);c.sort((d,u)=>d.priority-u.priority),this.eventProcessorWiring&&this.wireChainToProcessor(e)}wireChainToProcessor(e){this.eventProcessorWiring&&this.eventProcessorWiring.registerHandler(e,r=>this.executeChains(e,r).map(i=>({type:"emit",event:i})))}executeChains(e,r){let n=this.eventChains.get(e)||[],i=[],o=r.data||{},a=o._chainDepth||0,s=o._transactionId;for(let c of n){let d=c.handler(r,this);if(d){let u=Array.isArray(d)?d:[d];for(let m of u){let f=a+1;if(f>10){console.warn(`Chain depth exceeded for ${m.type}, skipping`);continue}let g=m.data||{},h={id:m.id||`chain-${Date.now()}-${Math.random().toString(36).substr(2,9)}`,type:m.type,timestamp:m.timestamp||Date.now(),entities:m.entities||{},data:{...g,_chainedFrom:r.type,_chainSourceId:r.id,_chainDepth:f,...s?{_transactionId:s}:{}}};i.push(h)}}}return i}applyEvent(e){if(!this.canApplyEvent(e))throw new Error(`Cannot apply event of type '${e.type}': validation failed`);let r=this.eventHandlers.get(e.type);r&&r(e,this),this.appliedEvents.push(e),this.appliedEvents.length>this.maxEventHistory&&(this.appliedEvents=this.appliedEvents.slice(-this.maxEventHistory))}canApplyEvent(e){let r=this.eventValidators.get(e.type);return r?r(e,this):!0}previewEvent(e){let r=this.eventPreviewers.get(e.type);return r?r(e,this):[]}getAppliedEvents(){return[...this.appliedEvents]}getEventsSince(e){return this.appliedEvents.filter(r=>r.timestamp>e)}clearEventHistory(){this.appliedEvents=[]}rebuildIdCounters(){this.idCounters.clear();for(let e of this.entities.values()){let r=e.id;if(r.length>=3){let n=r[0],i=r.substring(1),o=parseInt(i,36);if(!isNaN(o)){let a=this.idCounters.get(n)||0;o>a&&this.idCounters.set(n,o)}}}}getDataStore(){return{entities:this.entities,spatialIndex:this.spatialIndex,state:this.state,playerId:this.playerId,relationships:this.relationships,idCounters:this.idCounters,capabilities:this.capabilities}}getScopeRegistry(){return this.scopeRegistry}getGrammarVocabularyProvider(){return this.grammarVocabularyProvider}addScopeRule(e){this.scopeRegistry.addRule(e),this.emitPlatformEvent("scope_rule_added",{ruleId:e.id,fromLocations:e.fromLocations,forActions:e.forActions})}removeScopeRule(e){let r=this.scopeRegistry.removeRule(e);return r&&this.emitPlatformEvent("scope_rule_removed",{ruleId:e}),r}evaluateScope(e,r){if(!this.getEntity(e))return console.warn("evaluateScope: No actor found for ID:",e),[];let i=this.getLocation(e);if(!i)return console.warn("evaluateScope: No location found for actor:",e),[];let o={world:this,actorId:e,actionId:r,currentLocation:i},a=this.scopeEvaluator.evaluate(o);return Array.from(a.entityIds)}registerDefaultScopeRules(){this.addScopeRule({id:"default_room_visibility",fromLocations:"*",includeEntities:e=>{if(!this.getEntity(e.currentLocation))return console.warn("No room found for location:",e.currentLocation),[];let n=this.getContents(e.currentLocation),i=n.map(o=>o.id);i.push(e.currentLocation);for(let o of n){let a=this.getAllContents(o.id);i.push(...a.map(s=>s.id))}return i},priority:50,source:"core"}),this.addScopeRule({id:"default_inventory_visibility",fromLocations:"*",includeEntities:e=>{let r=this.getContents(e.actorId),n=r.map(i=>i.id);for(let i of r){let o=this.getAllContents(i.id);n.push(...o.map(a=>a.id))}return n},priority:100,source:"core"})}getVisible(e){let r=this.getEntity(e);return r?ux.VisibilityBehavior.getVisible(r,this):[]}getInScope(e){return this.evaluateScope(e).map(n=>this.getEntity(n)).filter(n=>n!==void 0)}canSee(e,r){let n=this.getEntity(e),i=this.getEntity(r);return!n||!i?!1:ux.VisibilityBehavior.canSee(n,i,this)}connectRooms(e,r,n){let i=this.getEntity(e),o=this.getEntity(r);if(!i||!o)throw new Error(`connectRooms: both rooms must exist (${e}, ${r})`);let a=(0,lx.getOppositeDirection)(n);zg.RoomBehavior.setExit(i,n,r),zg.RoomBehavior.setExit(o,a,e)}createDoor(e,r){let n=this.getEntity(r.room1Id),i=this.getEntity(r.room2Id);if(!n||!i)throw new Error(`createDoor: both rooms must exist (${r.room1Id}, ${r.room2Id})`);let o=this.createEntity(e,Uo.EntityType.DOOR);o.add(new lX.IdentityTrait({name:e,aliases:r.aliases,description:r.description})),o.add(new dX.DoorTrait({room1:r.room1Id,room2:r.room2Id})),o.add(new dx.SceneryTrait),o.add(new uX.OpenableTrait({isOpen:r.isOpen??!1})),(r.isLocked!==void 0||r.keyId)&&o.add(new mX.LockableTrait({isLocked:r.isLocked??!0,...r.keyId?{requiredKey:r.keyId}:{}}));let a=(0,lx.getOppositeDirection)(r.direction);return zg.RoomBehavior.setExit(n,r.direction,r.room2Id,o.id),zg.RoomBehavior.setExit(i,a,r.room1Id,o.id),this.moveEntity(o.id,r.room1Id),o}};Kg.WorldModel=ZO});var gx=p($g=>{"use strict";Object.defineProperty($g,"__esModule",{value:!0});$g.AuthorModel=void 0;var TX=Bd(),fx=ee(),EX=Ru(),vX=Cu(),JO=class{constructor(e,r){l(this,"dataStore");l(this,"worldModel");l(this,"eventHandlers",new Map);this.dataStore=e,this.worldModel=r}getDataStore(){return this.dataStore}createEntity(e,r="object",n=!1){let i=this.generateId(r),o=new TX.IFEntity(i,r,{attributes:{displayName:e,name:e,entityType:r}});return this.dataStore.entities.set(i,o),n&&this.emitEvent("author:entity:created",{entityId:i,name:e,entityType:r}),o}removeEntity(e,r=!1){let n=this.dataStore.entities.get(e);if(n){this.dataStore.spatialIndex.remove(e),this.dataStore.relationships.delete(e);for(let[,i]of this.dataStore.relationships)for(let[,o]of i)o.delete(e);this.dataStore.entities.delete(e),r&&this.emitEvent("author:entity:removed",{entityId:e,name:n.name})}}moveEntity(e,r,n=!1){let i=this.dataStore.spatialIndex.getParent(e);i&&this.dataStore.spatialIndex.removeChild(i,e),r!==null&&this.dataStore.spatialIndex.addChild(r,e),n&&this.emitEvent("author:entity:moved",{entityId:e,from:i,to:r})}getEntity(e){return this.dataStore.entities.get(e)}setEntityProperty(e,r,n,i=!1){let o=this.dataStore.entities.get(e);o&&(o.attributes[r]=n,i&&this.emitEvent("author:entity:property:changed",{entityId:e,property:r,value:n}))}addTrait(e,r,n=!1){let i=this.dataStore.entities.get(e);i&&(i.add(r),n&&this.emitEvent("author:entity:trait:added",{entityId:e,traitType:r.type}))}removeTrait(e,r,n=!1){let i=this.dataStore.entities.get(e);i&&(i.remove(r),n&&this.emitEvent("author:entity:trait:removed",{entityId:e,traitType:r}))}populate(e,r,n=!1){for(let i of r)this.moveEntity(i,e,n)}connect(e,r,n,i=!1){let o=this.dataStore.entities.get(e),a=this.dataStore.entities.get(r);if(!o||!a)return;let c={north:"south",south:"north",east:"west",west:"east",northeast:"southwest",northwest:"southeast",southeast:"northwest",southwest:"northeast",up:"down",down:"up",in:"out",out:"in"}[n]||n;o.attributes.exits||(o.attributes.exits={}),a.attributes.exits||(a.attributes.exits={}),o.attributes.exits[n]=r,a.attributes.exits[c]=e,i&&this.emitEvent("author:rooms:connected",{room1Id:e,room2Id:r,direction:n,opposite:c})}fillContainer(e,r,n=!1){for(let i of r){let o=this.createEntity(i.name,i.type||"item",n);if(i.attributes&&Object.assign(o.attributes,i.attributes),i.traits)for(let a of i.traits);this.moveEntity(o.id,e,n)}}placeActor(e,r,n=!1){this.moveEntity(e,r,n)}setupContainer(e,r,n,i,o=!1){let a=this.dataStore.entities.get(e);if(a){if(r!==void 0){let s=a.getTrait(fx.TraitType.OPENABLE);if(s)s.isOpen=r;else{let c=new EX.OpenableTrait;c.isOpen=r,this.addTrait(e,c,o)}}if(n!==void 0){let s=a.getTrait(fx.TraitType.LOCKABLE);if(s)s.isLocked=n,i&&(s.requiredKey=i);else{let c=new vX.LockableTrait;c.isLocked=n,i&&(c.requiredKey=i),this.addTrait(e,c,o)}}}}setStateValue(e,r,n=!1){this.dataStore.state[e]=r,n&&this.emitEvent("author:state:changed",{key:e,value:r})}setPlayer(e,r=!1){this.dataStore.entities.has(e)||console.warn(`Setting player to non-existent entity: ${e}`),this.worldModel?this.worldModel.playerId=e:this.dataStore.playerId=e,r&&this.emitEvent("author:player:set",{playerId:e})}clear(e=!1){this.dataStore.entities.clear(),this.dataStore.spatialIndex.clear();for(let r in this.dataStore.state)delete this.dataStore.state[r];this.worldModel?this.worldModel.playerId=void 0:this.dataStore.playerId=void 0,this.dataStore.relationships.clear(),this.dataStore.idCounters.clear(),this.dataStore.capabilities={},e&&this.emitEvent("author:world:cleared",{})}import(e,r=!1){r&&this.emitEvent("author:world:imported",{entityCount:this.dataStore.entities.size})}generateId(e){let r={room:"r",door:"d",item:"i",actor:"a",container:"c",supporter:"s",scenery:"y",exit:"e",object:"o"},n=r[e]||r.object,o=(this.dataStore.idCounters.get(n)||0)+1;if(o>1295)throw new Error(`ID overflow for type '${e}' (prefix '${n}')`);this.dataStore.idCounters.set(n,o);let a=o.toString(36).padStart(2,"0");return`${n}${a}`}emitEvent(e,r){let n=this.eventHandlers.get(e);if(n){let i={type:e,timestamp:Date.now(),...r};n(i)}}registerEventHandler(e,r){this.eventHandlers.set(e,r)}unregisterEventHandler(e){this.eventHandlers.delete(e)}};$g.AuthorModel=JO});var hx=p(Qg=>{"use strict";Object.defineProperty(Qg,"__esModule",{value:!0});Qg.StandardCapabilities=void 0;Qg.StandardCapabilities={SCORING:"scoring",SAVE_RESTORE:"saveRestore",CONVERSATION:"conversation",GAME_META:"gameMeta",COMMAND_HISTORY:"commandHistory",DEBUG:"debug"}});var yx=p(qr=>{"use strict";Object.defineProperty(qr,"__esModule",{value:!0});qr.StandardCapabilities=qr.AuthorModel=qr.VisibilityBehavior=qr.SpatialIndex=qr.GrammarVocabularyProvider=qr.WorldModel=void 0;var _X=px();Object.defineProperty(qr,"WorldModel",{enumerable:!0,get:function(){return _X.WorldModel}});var bX=jt();Object.defineProperty(qr,"GrammarVocabularyProvider",{enumerable:!0,get:function(){return bX.GrammarVocabularyProvider}});var IX=UO();Object.defineProperty(qr,"SpatialIndex",{enumerable:!0,get:function(){return IX.SpatialIndex}});var OX=YO();Object.defineProperty(qr,"VisibilityBehavior",{enumerable:!0,get:function(){return OX.VisibilityBehavior}});var SX=gx();Object.defineProperty(qr,"AuthorModel",{enumerable:!0,get:function(){return SX.AuthorModel}});var AX=hx();Object.defineProperty(qr,"StandardCapabilities",{enumerable:!0,get:function(){return AX.StandardCapabilities}})});var Tx=p(Xg=>{"use strict";Object.defineProperty(Xg,"__esModule",{value:!0});Xg.ScopeService=void 0;var eS=class{constructor(e){l(this,"world");this.world=e}canSee(e,r){return!0}canReach(e,r){return!0}};Xg.ScopeService=eS});var Ex=p(Zg=>{"use strict";Object.defineProperty(Zg,"__esModule",{value:!0});Zg.ScopeService=void 0;var RX=Tx();Object.defineProperty(Zg,"ScopeService",{enumerable:!0,get:function(){return RX.ScopeService}})});var _x=p(vx=>{"use strict";Object.defineProperty(vx,"__esModule",{value:!0})});var bx=p(Ho=>{"use strict";var CX=Ho&&Ho.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),tS=Ho&&Ho.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&CX(e,t,r)};Object.defineProperty(Ho,"__esModule",{value:!0});tS(_x(),Ho);tS(KO(),Ho);tS(QO(),Ho)});var Ox=p(Ix=>{"use strict";Object.defineProperty(Ix,"__esModule",{value:!0})});var Ax=p(Sx=>{"use strict";Object.defineProperty(Sx,"__esModule",{value:!0})});var Rx=p(bc=>{"use strict";var wX=bc&&bc.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),NX=bc&&bc.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&wX(e,t,r)};Object.defineProperty(bc,"__esModule",{value:!0});NX(Ax(),bc)});var E=p(se=>{"use strict";var DX=se&&se.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),me=se&&se.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&DX(e,t,r)};Object.defineProperty(se,"__esModule",{value:!0});me(fP(),se);me(zP(),se);me(KP(),se);me(tk(),se);me(lk(),se);me(cI(),se);me(ee(),se);me(fB(),se);me(hB(),se);me(EO(),se);me(IO(),se);me(TB(),se);me(vB(),se);me(_B(),se);me(bB(),se);me(IB(),se);me(SB(),se);me(OO(),se);me(AO(),se);me(CB(),se);me(NB(),se);me(MB(),se);me(NO(),se);me(MO(),se);me(xB(),se);me(jB(),se);me(WB(),se);me(UB(),se);me(HB(),se);me(qB(),se);me(GB(),se);me(YB(),se);me(zB(),se);me(XB(),se);me(yx(),se);me(Ex(),se);me(bx(),se);me(Ox(),se);me(VO(),se);me(Rx(),se)});var we=p(Ui=>{"use strict";Object.defineProperty(Ui,"__esModule",{value:!0});Ui.WitnessLevel=Ui.SenseType=Ui.ScopeLevelStrings=Ui.ScopeLevel=void 0;var Cx;(function(t){t[t.UNAWARE=0]="UNAWARE",t[t.AWARE=1]="AWARE",t[t.VISIBLE=2]="VISIBLE",t[t.REACHABLE=3]="REACHABLE",t[t.CARRIED=4]="CARRIED"})(Cx||(Ui.ScopeLevel=Cx={}));Ui.ScopeLevelStrings={CARRIED:"carried",REACHABLE:"reachable",VISIBLE:"visible",AUDIBLE:"audible",DETECTABLE:"detectable",OUT_OF_SCOPE:"out_of_scope"};var wx;(function(t){t.SIGHT="sight",t.HEARING="hearing",t.SMELL="smell",t.TOUCH="touch",t.VIBE="vibe"})(wx||(Ui.SenseType=wx={}));var Nx;(function(t){t.FULL="full",t.PARTIAL="partial",t.PERIPHERAL="peripheral",t.INFERRED="inferred"})(Nx||(Ui.WitnessLevel=Nx={}))});var Wu=p(ju=>{"use strict";Object.defineProperty(ju,"__esModule",{value:!0});ju.StandardScopeResolver=void 0;ju.createScopeResolver=LX;var Se=E(),qo=we();function Jg(t){return t.has(Se.TraitType.IDENTITY)?t.getTrait(Se.TraitType.IDENTITY)?.concealed===!0:!1}var eh=class{constructor(e){l(this,"world");this.world=e}getScope(e,r){if(Jg(r))return qo.ScopeLevel.UNAWARE;let n=this.calculatePhysicalScope(e,r),i=this.getContainingRoom(e.id),o=r.getMinimumScope(i?.id??null);return Math.max(n,o)}calculatePhysicalScope(e,r){return this.isCarried(e,r)?qo.ScopeLevel.CARRIED:this.canReach(e,r)?qo.ScopeLevel.REACHABLE:this.canSee(e,r)?qo.ScopeLevel.VISIBLE:this.canHear(e,r)||this.canSmell(e,r)?qo.ScopeLevel.AWARE:qo.ScopeLevel.UNAWARE}canSee(e,r){let n=this.world.getLocation(e.id),i=this.world.getLocation(r.id);if(!n||!i)return!1;let o=this.getContainingRoom(e.id),a=this.getContainingRoom(r.id);return!o||!a||this.isInDarkness(o)&&!this.hasLightSource(e)||o.id!==a.id?!1:this.isVisibleInContainer(r.id,e.id)}canReach(e,r){if(!this.canSee(e,r))return!1;if(this.isCarried(e,r))return!0;let n=this.world.getLocation(e.id),i=this.world.getLocation(r.id);if(n===i)return!0;let o=i?this.world.getEntity(i):null;if(o){if(o.has(Se.TraitType.SUPPORTER))return!0;if(o.has(Se.TraitType.CONTAINER)){let a=o.getTrait(Se.TraitType.CONTAINER);if(o.has(Se.TraitType.OPENABLE)){let s=o.getTrait(Se.TraitType.OPENABLE);if(s&&!s.isOpen)return!1}return!0}}return!0}canHear(e,r){let n=this.world.getLocation(e.id),i=this.world.getLocation(r.id);if(!n||!i)return!1;let o=this.getContainingRoom(e.id),a=this.getContainingRoom(r.id);if(!o||!a)return!1;if(o.id===a.id){if(this.isInClosedContainer(r.id)){let c=r.get(Se.TraitType.IDENTITY);return(c&&typeof c=="object"&&"customProperties"in c&&c.customProperties?.loud===!0)===!0}return!0}let s=this.getRoomConnection(o,a);return s?(s.isOpen,!0):!1}canSmell(e,r){let n=this.world.getLocation(e.id),i=this.world.getLocation(r.id);if(!n||!i)return!1;let o=this.getContainingRoom(e.id),a=this.getContainingRoom(r.id);if(!o||!a)return!1;if(o.id===a.id){if(this.isInClosedContainer(r.id)){let c=r.get(Se.TraitType.IDENTITY);return(c&&typeof c=="object"&&"customProperties"in c&&c.customProperties?.verySmelly===!0)===!0&&this.hasScent(r)}return this.hasScent(r)}let s=this.getRoomConnection(o,a);return s&&s.isOpen?this.hasScent(r):!1}getVisible(e){let r=[],n=this.world.getAllEntities(),i=this.getContainingRoom(e.id);for(let o of n){if(o.id===e.id||Jg(o))continue;if(this.canSee(e,o)){r.push(o);continue}o.getMinimumScope(i?.id??null)>=qo.ScopeLevel.VISIBLE&&r.push(o)}return r}getReachable(e){let r=[],n=this.world.getAllEntities(),i=this.getContainingRoom(e.id);for(let o of n){if(o.id===e.id||Jg(o))continue;if(this.canReach(e,o)){r.push(o);continue}o.getMinimumScope(i?.id??null)>=qo.ScopeLevel.REACHABLE&&r.push(o)}return r}getAudible(e){let r=[],n=this.world.getAllEntities(),i=this.getContainingRoom(e.id);for(let o of n){if(o.id===e.id||Jg(o))continue;if(this.canHear(e,o)){r.push(o);continue}o.getMinimumScope(i?.id??null)>=qo.ScopeLevel.AWARE&&r.push(o)}return r}isCarried(e,r){return this.world.getLocation(r.id)===e.id}getContainingRoom(e){let r=e,n=10;for(;r&&n-- >0;){let i=this.world.getEntity(r);if(!i)return null;if(i.has(Se.TraitType.ROOM))return i;let o=this.world.getLocation(r);if(!o)return null;r=o}return null}isVisibleInContainer(e,r){let n=e,i=10;for(;n&&i-- >0;){let o=this.world.getLocation(n);if(!o)return!1;let a=this.world.getEntity(o);if(!a)return!1;if(a.has(Se.TraitType.ROOM))return!0;if(a.has(Se.TraitType.CONTAINER)&&a.has(Se.TraitType.OPENABLE)){let s=a.getTrait(Se.TraitType.OPENABLE);if(s&&!s.isOpen)return!1}a.has(Se.TraitType.SUPPORTER),n=o}return!1}getRoomConnection(e,r){let n=this.world.getAllEntities().filter(s=>this.world.getLocation(s.id)===e.id),i=this.world.getAllEntities().filter(s=>this.world.getLocation(s.id)===r.id),o=s=>{for(let c of s)if(c.has(Se.TraitType.DOOR)){let d=c.get(Se.TraitType.DOOR);if(d.room1===e.id&&d.room2===r.id||d.room1===r.id&&d.room2===e.id)return c.has(Se.TraitType.OPENABLE)?{isOpen:c.get(Se.TraitType.OPENABLE).isOpen}:{isOpen:!0}}return null},a=o(n);return a||o(i)}hasScent(e){let r=e.get(Se.TraitType.IDENTITY);if(r&&typeof r=="object"&&"customProperties"in r){let n=r.customProperties;if(n?.smelly||n?.verySmelly)return!0}return!!(e.has(Se.TraitType.EDIBLE)||e.has(Se.TraitType.ACTOR))}isInDarkness(e){let r=e.get(Se.TraitType.IDENTITY);return r&&typeof r=="object"&&"customProperties"in r?r.customProperties?.isDark===!0:!1}hasLightSource(e){let r=this.world.getAllEntities().filter(i=>this.world.getLocation(i.id)===e.id);for(let i of r)if(this.isLightSource(i))return!0;let n=e.get(Se.TraitType.IDENTITY);return!!(n&&typeof n=="object"&&"customProperties"in n&&n.customProperties?.providesLight)}isLightSource(e){if(e.has(Se.TraitType.LIGHT_SOURCE)){let n=e.getTrait(Se.TraitType.LIGHT_SOURCE);if(e.has(Se.TraitType.SWITCHABLE)){let i=e.getTrait(Se.TraitType.SWITCHABLE);return i?i.isOn===!0:!1}return!0}let r=e.get(Se.TraitType.IDENTITY);return!!(r&&typeof r=="object"&&"customProperties"in r&&r.customProperties?.isLit)}isInClosedContainer(e){let r=e,n=10;for(;r&&n-- >0;){let i=this.world.getLocation(r);if(!i)return!1;let o=this.world.getEntity(i);if(!o||o.has(Se.TraitType.ROOM))return!1;if(o.has(Se.TraitType.CONTAINER)&&o.has(Se.TraitType.OPENABLE)){let a=o.getTrait(Se.TraitType.OPENABLE);if(a&&!a.isOpen)return!0}r=i}return!1}};ju.StandardScopeResolver=eh;function LX(t){return new eh(t)}});var ae=p(nl=>{"use strict";Object.defineProperty(nl,"__esModule",{value:!0});nl.IFActions=nl.ActionIDs=void 0;nl.ActionIDs={GOING:"if.action.going",LOOKING:"if.action.looking",EXAMINING:"if.action.examining",TAKING:"if.action.taking",DROPPING:"if.action.dropping",OPENING:"if.action.opening",INVENTORY:"if.action.inventory"};nl.IFActions={GOING:"if.action.going",ENTERING_ROOM:"if.action.entering_room",ENTERING:"if.action.entering",EXITING:"if.action.exiting",CLIMBING:"if.action.climbing",JUMPING:"if.action.jumping",LOOKING:"if.action.looking",EXAMINING:"if.action.examining",SEARCHING:"if.action.searching",LOOKING_UNDER:"if.action.looking_under",LOOKING_BEHIND:"if.action.looking_behind",LISTENING:"if.action.listening",SMELLING:"if.action.smelling",TOUCHING:"if.action.touching",TASTING:"if.action.tasting",TAKING:"if.action.taking",DROPPING:"if.action.dropping",PUTTING:"if.action.putting",INSERTING:"if.action.inserting",REMOVING:"if.action.removing",THROWING:"if.action.throwing",OPENING:"if.action.opening",CLOSING:"if.action.closing",EMPTYING:"if.action.emptying",LOCKING:"if.action.locking",UNLOCKING:"if.action.unlocking",WEARING:"if.action.wearing",TAKING_OFF:"if.action.taking_off",SWITCHING_ON:"if.action.switching_on",SWITCHING_OFF:"if.action.switching_off",PUSHING:"if.action.pushing",PULLING:"if.action.pulling",TURNING:"if.action.turning",SETTING:"if.action.setting",EATING:"if.action.eating",DRINKING:"if.action.drinking",TALKING:"if.action.talking",ASKING:"if.action.asking",TELLING:"if.action.telling",ANSWERING:"if.action.answering",SHOWING:"if.action.showing",GIVING:"if.action.giving",ATTACKING:"if.action.attacking",KISSING:"if.action.kissing",WAVING:"if.action.waving",LOWERING:"if.action.lowering",RAISING:"if.action.raising",CONSULTING:"if.action.consulting",READING:"if.action.reading",INVENTORY:"if.action.inventory",WAITING:"if.action.waiting",SLEEPING:"if.action.sleeping",WAKING:"if.action.waking",SAVING:"if.action.saving",RESTORING:"if.action.restoring",RESTARTING:"if.action.restarting",QUITTING:"if.action.quitting",UNDOING:"if.action.undoing",AGAIN:"if.action.again",SCORING:"if.action.scoring",VERIFYING:"if.action.verifying",VERSION:"if.action.version",HELP:"if.action.help",HINTS:"if.action.hints",ABOUT:"if.action.about"}});var Dx=p(th=>{"use strict";Object.defineProperty(th,"__esModule",{value:!0});th.TakingMessages=void 0;th.TakingMessages={NO_TARGET:"no_target",CANT_TAKE_SELF:"cant_take_self",ALREADY_HAVE:"already_have",CANT_TAKE_ROOM:"cant_take_room",FIXED_IN_PLACE:"fixed_in_place",CONTAINER_FULL:"container_full",TOO_HEAVY:"too_heavy",CANNOT_TAKE:"cannot_take",CANT_TAKE:"cant_take",NOTHING_TO_TAKE:"nothing_to_take",TAKEN:"taken",TAKEN_FROM:"taken_from",TAKEN_MULTI:"taken_multi"}});var Px=p(us=>{"use strict";Object.defineProperty(us,"__esModule",{value:!0});us.isWearableTrait=MX;us.isContainerTrait=Lx;us.hasCapacityLimit=PX;us.isTakingSharedData=Mx;us.getTakingSharedData=kX;us.setTakingSharedData=BX;function MX(t){if(!t||typeof t!="object")return!1;let e=t;return"isWorn"in e&&typeof e.isWorn=="boolean"||"worn"in e&&typeof e.worn=="boolean"}function Lx(t){return t!==null&&typeof t=="object"&&("capacity"in t||"isTransparent"in t||"enterable"in t)}function PX(t){return Lx(t)&&t.capacity!==void 0&&typeof t.capacity=="object"}function Mx(t){return typeof t=="object"&&t!==null}function kX(t){return Mx(t.sharedData)||(t.sharedData={}),t.sharedData}function BX(t,e){Object.assign(t.sharedData,e)}});var Uu=p(Ic=>{"use strict";Object.defineProperty(Ic,"__esModule",{value:!0});Ic.isMultiObjectCommand=xX;Ic.isAllCommand=jX;Ic.isListCommand=WX;Ic.getExcludedNames=Bx;Ic.expandMultiObject=UX;var rh=E(),kx=Wu();function xX(t){let e=t.command.parsed.structure.directObject;return!!(e?.isAll||e?.isList)}function jX(t){return t.command.parsed.structure.directObject?.isAll===!0}function WX(t){return t.command.parsed.structure.directObject?.isList===!0}function Bx(t){let e=t.command.parsed.excluded;return!e||e.length===0?[]:e.map(r=>r.head||r.text).map(r=>r.toLowerCase())}function UX(t,e={}){let r=t.command.parsed.structure.directObject,n=t.world,i=t.player;if(r?.isAll)return HX(t,e);if(r?.isList&&r.items)return qX(t,r.items,e);let o=t.command.directObject?.entity;return o?[{entity:o}]:[]}function HX(t,e){let r=t.world,n=t.player,i=new kx.StandardScopeResolver(r),o;switch(e.scope){case"carried":o=r.getContents(n.id);break;case"visible":o=i.getVisible(n);break;default:o=i.getReachable(n);break}e.filter&&(o=o.filter(s=>e.filter(s,r))),o=o.filter(s=>GX(s));let a=Bx(t);return a.length>0&&(o=o.filter(s=>{let c=s.name.toLowerCase(),d=xx(s).map(u=>u.toLowerCase());return!a.includes(c)&&!d.some(u=>a.includes(u))})),o.map(s=>({entity:s}))}function qX(t,e,r){let n=t.world,i=t.player,o=new kx.StandardScopeResolver(n),a=[],s;switch(r.scope){case"carried":s=n.getContents(i.id);break;case"visible":s=o.getVisible(i);break;default:s=o.getReachable(i);break}for(let c of e){let d=(c.head||c.text).toLowerCase(),u=s.find(m=>{let f=m.name.toLowerCase(),g=xx(m).map(h=>h.toLowerCase());return f===d||g.includes(d)});u&&(!r.filter||r.filter(u,n))&&a.push({entity:u,nounPhrase:c})}return a}function GX(t){return!(t.has(rh.TraitType.ROOM)||t.has(rh.TraitType.SCENERY)||t.has(rh.TraitType.ACTOR))}function xx(t){let e=t.get(rh.TraitType.IDENTITY);if(e&&typeof e=="object"&&"aliases"in e){let r=e.aliases;if(Array.isArray(r))return r.map(String)}return[]}});var nS=p(nh=>{"use strict";Object.defineProperty(nh,"__esModule",{value:!0});nh.takingAction=void 0;var lr=E(),Ux=ae(),rS=we(),Pn=Dx(),Go=Px(),Hx=Uu();function qx(t,e){let r=t.player,n=(0,lr.getInterceptorForAction)(e,Ux.IFActions.TAKING);if(n){let{interceptor:a}=n,s={},c=(0,Go.getTakingSharedData)(t);if(c._interceptor=a,c._interceptorData=s,a.preValidate){let d=a.preValidate(e,t.world,r.id,s);if(d!==null&&!d.valid)return{valid:!1,error:d.error,params:d.params}}}let i=t.requireScope(e,rS.ScopeLevel.REACHABLE);if(!i.ok)return i.error;if(e.id===r.id)return{valid:!1,error:Pn.TakingMessages.CANT_TAKE_SELF};if(t.world.getLocation(e.id)===r.id)return{valid:!1,error:Pn.TakingMessages.ALREADY_HAVE,params:{item:e.name}};if(e.has(lr.TraitType.ROOM))return{valid:!1,error:Pn.TakingMessages.CANT_TAKE_ROOM,params:{item:e.name}};if(e.has(lr.TraitType.SCENERY))return{valid:!1,error:lr.SceneryBehavior.getCantTakeMessage(e)||Pn.TakingMessages.FIXED_IN_PLACE,params:{item:e.name}};if(n){let a=(0,Go.getTakingSharedData)(t)._interceptor,s=(0,Go.getTakingSharedData)(t)._interceptorData;if(a?.postValidate){let c=a.postValidate(e,t.world,r.id,s);if(c!==null&&!c.valid)return{valid:!1,error:c.error,params:c.params}}}if(!lr.ActorBehavior.canTakeItem(r,e,t.world)){if(r.has(lr.TraitType.CONTAINER)){let a=r.get(lr.TraitType.CONTAINER);if((0,Go.hasCapacityLimit)(a)){if(a.capacity.maxItems!==void 0&&t.world.getContents(r.id).filter(d=>{if(!d.has||!d.has(lr.TraitType.WEARABLE))return!0;let u=d.get(lr.TraitType.WEARABLE);return!(0,Go.isWearableTrait)(u)||!u.isWorn&&!u.worn}).length>=a.capacity.maxItems)return{valid:!1,error:Pn.TakingMessages.CONTAINER_FULL};if(a.capacity.maxWeight!==void 0){let s=lr.ContainerBehavior.getTotalWeight(r,t.world),c=lr.IdentityBehavior.getWeight(e);if(s+c>a.capacity.maxWeight)return{valid:!1,error:Pn.TakingMessages.TOO_HEAVY}}}}return{valid:!1,error:Pn.TakingMessages.CANNOT_TAKE,params:{item:e.name}}}return{valid:!0}}function FX(t){let e=t.player.id,r=(0,Hx.expandMultiObject)(t,{scope:"reachable",filter:(a,s)=>s.getLocation(a.id)!==e});if(r.length===0)return{valid:!1,error:Pn.TakingMessages.NOTHING_TO_TAKE};let n=r.map(a=>{let s=qx(t,a.entity);return{entity:a.entity,success:s.valid,error:s.valid?void 0:s.error}}),i=(0,Go.getTakingSharedData)(t);return i.multiObjectResults=n,n.some(a=>a.success)?{valid:!0}:{valid:!1,error:n[0].error}}function jx(t,e,r){let n=t.player,i=t.world.getLocation(e.id);if(r.previousLocation=i,e.has(lr.TraitType.WEARABLE)){let a=e.get(lr.TraitType.WEARABLE);if((0,Go.isWearableTrait)(a)&&(a.isWorn||a.worn)){r.implicitlyRemoved=!0,r.wasWorn=!0;let s=i?t.world.getEntity(i):null;s&&lr.WearableBehavior.remove(e,s)}}t.world.moveEntity(e.id,n.id);let o=e.getTrait(lr.TraitType.IDENTITY);o?.points&&t.world.awardScore(e.id,o.points,o.pointsDescription??o.name??e.id)}function Wx(t,e,r,n,i=!1){let o=t.player;if(r.implicitlyRemoved){let m=r.previousLocation,f=m?t.world.getEntity(m):null;n.push(t.event("if.event.removed",{implicit:!0,item:e.name,container:f?.name}))}let a=r.previousLocation,s=a&&a!==t.world.getLocation(o.id),c=a?t.world.getEntity(a):null,d;i?d=Pn.TakingMessages.TAKEN_MULTI:s?d=Pn.TakingMessages.TAKEN_FROM:d=Pn.TakingMessages.TAKEN;let u={item:e.name,itemId:e.id,actor:o.name,actorId:o.id,previousLocation:r.previousLocation,container:c?.name||""};n.push(t.event("if.event.taken",{messageId:`${t.action.id}.${d}`,params:u,...u}))}function VX(t,e,r,n){n.push(t.event("if.event.take_blocked",{messageId:`${t.action.id}.${r}`,params:{item:e.name},item:e.name,itemId:e.id,reason:r}))}nh.takingAction={id:Ux.IFActions.TAKING,defaultScope:{target:rS.ScopeLevel.REACHABLE},requiredMessages:["no_target","cant_take_self","already_have","cant_take_room","fixed_in_place","container_full","too_heavy","taken","taken_from","nothing_to_take"],metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:rS.ScopeLevel.REACHABLE},validate(t){if((0,Hx.isMultiObjectCommand)(t))return FX(t);let e=t.command.directObject?.entity;return e?qx(t,e):{valid:!1,error:Pn.TakingMessages.NO_TARGET}},execute(t){let e=(0,Go.getTakingSharedData)(t);if(e.multiObjectResults){for(let n of e.multiObjectResults)n.success&&jx(t,n.entity,n);return}let r=t.command.directObject.entity;jx(t,r,e)},report(t){let e=(0,Go.getTakingSharedData)(t),r=[];if(e.multiObjectResults){let i=e.multiObjectResults.length>1;for(let o of e.multiObjectResults)o.success?Wx(t,o.entity,o,r,i):VX(t,o.entity,o.error,r);return r}let n=t.command.directObject.entity;return Wx(t,n,e,r,!1),r},blocked(t,e){let r=t.command.directObject?.entity,n=e.error||"",i=n.includes(".")?n:`${t.action.id}.${n}`;return[t.event("if.event.take_blocked",{messageId:i,params:{...e.params,item:r?.name},item:r?.name,itemId:r?.id,reason:e.error})]},group:"object_manipulation"}});var aS=p(oh=>{"use strict";Object.defineProperty(oh,"__esModule",{value:!0});oh.createActionContext=Gx;oh.createMockActionContext=zX;var ih=Ve(),iS=E(),Hu=sI(),kn=we(),YX=Wu(),Oc=nS(),oS=class t{constructor(e,r,n,i,o,a){l(this,"world");l(this,"player");l(this,"currentLocation");l(this,"action");l(this,"command");l(this,"sequenceCounter",0);l(this,"scopeResolver");l(this,"sharedData",{});this.world=e,this.player=r,this.currentLocation=n,this.action=i,this.command=o,this.scopeResolver=a||new YX.StandardScopeResolver(e)}canSee(e){return this.scopeResolver.canSee(this.player,e)}canReach(e){return this.scopeResolver.canReach(this.player,e)}canTake(e){return!e.has(iS.TraitType.SCENERY)&&!e.has(iS.TraitType.ROOM)&&!e.has(iS.TraitType.DOOR)}isInScope(e){return this.scopeResolver.getScope(this.player,e)>=kn.ScopeLevel.AWARE}getVisible(){return this.scopeResolver.getVisible(this.player)}getInScope(){let e=this.scopeResolver.getVisible(this.player),r=this.scopeResolver.getAudible(this.player),n=this.scopeResolver.getReachable(this.player),i=new Map;return[...e,...r,...n].forEach(o=>{i.set(o.id,o)}),Array.from(i.values())}getEntityScope(e){return this.scopeResolver.getScope(this.player,e)}getSlotScope(e){let r=this.getEntityFromSlot(e);return r?this.getEntityScope(r):kn.ScopeLevel.UNAWARE}requireScope(e,r){let n=this.getEntityScope(e);return n>=r?{ok:!0,actualScope:n}:{ok:!1,error:this.getScopeError(r,n,e),actualScope:n}}requireSlotScope(e,r){let n=this.getEntityFromSlot(e);return n?this.requireScope(n,r):{ok:!1,error:{valid:!1,error:"no_target",params:{slot:e}}}}requireCarriedOrImplicitTake(e){let r=this.getEntityScope(e);if(r>=kn.ScopeLevel.CARRIED)return{ok:!0};if(r<kn.ScopeLevel.REACHABLE)return{ok:!1,error:this.getScopeError(kn.ScopeLevel.REACHABLE,r,e)};if(!this.canTake(e))return{ok:!1,error:{valid:!1,error:"fixed_in_place",params:{item:e.name}}};let n={parsed:{rawInput:`take ${e.name}`,action:Oc.takingAction.id,tokens:[],structure:{verb:{tokens:[0],text:"take",head:"take"}},pattern:"VERB_NOUN",confidence:1},actionId:Oc.takingAction.id,directObject:{entity:e,parsed:{text:e.name,candidates:[e.name]}}},i=new t(this.world,this.player,this.currentLocation,Oc.takingAction,n,this.scopeResolver),o=Oc.takingAction.validate(i);if(!o.valid)return{ok:!1,error:{valid:!1,error:o.error||"cannot_take",params:o.params}};Oc.takingAction.execute(i);let a=Oc.takingAction.report?Oc.takingAction.report(i):[],c=[this.event("if.event.implicit_take",{item:e.id,itemName:e.name}),...a];return this.sharedData.implicitTakeEvents||(this.sharedData.implicitTakeEvents=[]),this.sharedData.implicitTakeEvents.push(...c),{ok:!0,implicitTakeEvents:c}}getEntityFromSlot(e){switch(e){case"target":case"directObject":return this.command.directObject?.entity??null;case"item":return this.command.directObject?.entity??null;case"container":case"recipient":case"instrument":case"indirectObject":return this.command.indirectObject?.entity??null;default:return this.command.directObject?.entity??null}}getScopeError(e,r,n){let i={item:n.name};return r===kn.ScopeLevel.UNAWARE?{valid:!1,error:Hu.ScopeErrors.NOT_KNOWN,params:i}:e>=kn.ScopeLevel.VISIBLE&&r<kn.ScopeLevel.VISIBLE?{valid:!1,error:Hu.ScopeErrors.NOT_VISIBLE,params:i}:e>=kn.ScopeLevel.REACHABLE&&r<kn.ScopeLevel.REACHABLE?{valid:!1,error:Hu.ScopeErrors.NOT_REACHABLE,params:i}:e>=kn.ScopeLevel.CARRIED&&r<kn.ScopeLevel.CARRIED?{valid:!1,error:Hu.ScopeErrors.NOT_CARRIED,params:i}:{valid:!1,error:Hu.ScopeErrors.OUT_OF_SCOPE,params:i}}event(e,r){return this.createEventInternal(e,r)}createEventInternal(e,r){if(e==="action.error"||e==="action.success"||e==="action.blocked"){let o={...r,timestamp:r.timestamp||Date.now()},a=this.getEventEntities();return(0,ih.createEvent)(e,o,a)}if(e.startsWith("if.")){let o=this.getEventEntities();return(0,ih.createEvent)(e,r,o)}if(r&&typeof r=="object"&&"data"in r){let{actionId:o,reason:a,data:s,timestamp:c}=r,d={actionId:o||this.action.id,timestamp:c||Date.now(),...a&&{reason:a},data:s||{}},u=this.getEventEntities();return(0,ih.createEvent)(e,d,u)}let n={actionId:this.action.id,timestamp:Date.now(),data:r},i=this.getEventEntities();return(0,ih.createEvent)(e,n,i)}getEventEntities(){let e={};return this.player?.id&&(e.actor=this.player.id),this.command?.directObject?.entity?.id&&(e.target=this.command.directObject.entity.id),this.command?.indirectObject?.entity?.id&&(e.instrument=this.command.indirectObject.entity.id),this.currentLocation?.id&&(e.location=this.currentLocation.id),e}createSubContext(e){let r=new t(this.world,this.player,this.currentLocation,e,this.command,this.scopeResolver);return r.sharedData=this.sharedData,r}};function Gx(t,e,r,n,i){let o=t.getLocation(e.id),a=o?t.getEntity(o):null;if(!a)throw new Error("Player has no valid location");return new oS(t,e,a,r,n,i)}function zX(t,e,r,n,i){if(!t)throw new Error("createMockActionContext: world is required");if(!e)throw new Error("createMockActionContext: player is required");if(!r)throw new Error("createMockActionContext: action is required");let o={parsed:{rawInput:"test",action:r.id,tokens:[],structure:{verb:{tokens:[0],text:"test",head:"test"}},pattern:"VERB_ONLY",confidence:1},actionId:r.id,...n};return Gx(t,e,r,o,i)}});var sS=p(ah=>{"use strict";Object.defineProperty(ah,"__esModule",{value:!0});ah.MetaCommandRegistry=void 0;var qu=class{static register(e){if(!e){console.warn("MetaCommandRegistry: Attempted to register empty action ID");return}this.metaCommands.add(e)}static unregister(e){return this.metaCommands.delete(e)}static isMeta(e){return e?this.metaCommands.has(e):!1}static getAll(){return Array.from(this.metaCommands).sort()}static clear(){this.metaCommands.clear(),this.reset()}static reset(){this.metaCommands=new Set(["if.action.saving","if.action.restoring","if.action.quitting","if.action.restarting","if.action.undoing","if.action.scoring","if.action.version","if.action.about","if.action.help","if.action.again","transcript","transcript_on","transcript_off","undo","verbose","brief","superbrief","notify"])}static count(){return this.metaCommands.size}static hasCustomCommands(){let e=new Set(["if.action.saving","if.action.restoring","if.action.quitting","if.action.restarting","if.action.undoing","if.action.scoring","if.action.version","if.action.about","if.action.help","if.action.again","transcript","transcript_on","transcript_off","undo","verbose","brief","superbrief","notify"]);for(let r of this.metaCommands)if(!e.has(r))return!0;return!1}static isNonUndoable(e){let n=e.trim().toLowerCase().split(/\s+/)[0];return this.nonUndoableVerbs.has(n)}};l(qu,"metaCommands",new Set(["if.action.saving","if.action.restoring","if.action.quitting","if.action.restarting","if.action.scoring","if.action.version","if.action.about","if.action.help","transcript","transcript_on","transcript_off","if.action.again","if.action.undoing","undo","verbose","brief","superbrief","notify"])),l(qu,"nonUndoableVerbs",new Set(["undo","save","restore","restart","quit","score","version","about","help","verbose","brief","superbrief","notify","again","g","look","l","examine","x","inventory","i"]));ah.MetaCommandRegistry=qu});var dS=p(sh=>{"use strict";Object.defineProperty(sh,"__esModule",{value:!0});sh.MetaAction=void 0;var KX=sS(),cS=class{constructor(){l(this,"descriptionMessageId");l(this,"examplesMessageId");l(this,"group");l(this,"priority")}validate(e){return{valid:!0}}ensureRegistered(){this.id?KX.MetaCommandRegistry.register(this.id):console.warn("MetaAction: Cannot register without an id")}};sh.MetaAction=cS});var Fx=p(ch=>{"use strict";Object.defineProperty(ch,"__esModule",{value:!0});ch.ReadOnlyActionContext=void 0;var ms=we(),lS=class{constructor(e,r,n,i,o,a){l(this,"world");l(this,"player");l(this,"currentLocation");l(this,"command");l(this,"action");l(this,"scopeResolver");l(this,"sharedData",{});this.world=e,this.player=r,this.currentLocation=n,this.command=i,this.action=o||{id:"unknown",validate:()=>({valid:!0}),execute:()=>[]},this.scopeResolver=a||{}}canSee(e){return this.world.canSee(this.player.id,e.id)}canReach(e){let r=this.world.getLocation(e.id);if(r===this.player.id||r===this.currentLocation.id)return!0;if(r){let n=this.world.getEntity(r);if(n){let i=this.world.getLocation(n.id);if(i===this.currentLocation.id){if(n.has("container")){let o=n.get("openable");if(!o||o.isOpen)return!0}if(n.has("supporter"))return!0}if(i===this.player.id&&n.has("container")){let o=n.get("openable");if(!o||o.isOpen)return!0}}}return!1}canTake(e){return!(!this.canSee(e)||!this.canReach(e)||e.has("room")||e.has("scenery")||this.world.getLocation(e.id)===this.player.id)}isInScope(e){return this.world.getInScope(this.player.id).some(n=>n.id===e.id)}getVisible(){return this.world.getVisible(this.player.id)}getInScope(){return this.world.getInScope(this.player.id)}getCapability(e){return this.world.getCapability(e)}event(e,r){throw new Error("ReadOnlyActionContext does not support event creation. Use createActionContext from enhanced-context.ts instead.")}getEntityScope(e){let r=this.world.getLocation(e.id);return r===this.player.id?ms.ScopeLevel.CARRIED:r===this.currentLocation.id||this.canReach(e)?ms.ScopeLevel.REACHABLE:this.canSee(e)?ms.ScopeLevel.VISIBLE:ms.ScopeLevel.UNAWARE}getSlotScope(e){let n={target:"directObject",item:"directObject",container:"indirectObject",recipient:"indirectObject"}[e]||e,o=this.command[n]?.entity;return o?this.getEntityScope(o):ms.ScopeLevel.UNAWARE}requireScope(e,r){let n=this.getEntityScope(e);if(n>=r)return{ok:!0,actualScope:n};let i;return r===ms.ScopeLevel.CARRIED?i="scope.not_carried":r===ms.ScopeLevel.REACHABLE?i="scope.not_reachable":r===ms.ScopeLevel.VISIBLE?i="scope.not_visible":i="scope.out_of_scope",{ok:!1,actualScope:n,error:{valid:!1,error:i,params:{entityId:e.id,entityName:e.name,required:r,actual:n}}}}requireSlotScope(e,r){let i={target:"directObject",item:"directObject",container:"indirectObject",recipient:"indirectObject"}[e]||e,a=this.command[i]?.entity;return a?this.requireScope(a,r):{ok:!1,error:{valid:!1,error:"scope.not_found",params:{slot:e}}}}requireCarriedOrImplicitTake(e){throw new Error("ReadOnlyActionContext does not support implicit takes. Use createActionContext from enhanced-context.ts instead.")}};ch.ReadOnlyActionContext=lS});var Vx=p(dh=>{"use strict";Object.defineProperty(dh,"__esModule",{value:!0});dh.StandardActionRegistry=void 0;var uS=class{constructor(){l(this,"actions",new Map);l(this,"actionsByPattern",new Map);l(this,"actionsByGroup",new Map);l(this,"languageProvider",null)}setLanguageProvider(e){this.languageProvider=e,this.rebuildPatternMappings()}register(e){if(this.actions.set(e.id,e),e.group){let r=this.actionsByGroup.get(e.group)||[];r.push(e),this.actionsByGroup.set(e.group,r)}if("aliases"in e&&Array.isArray(e.aliases)){let r=e.aliases;for(let n of r){let i=n.toLowerCase();this.actionsByPattern.set(i,[e])}}this.languageProvider&&this.updatePatternMappingsForAction(e)}registerMany(e){for(let r of e)this.register(r)}get(e){return this.actions.get(e)}getAll(){return Array.from(this.actions.values())}has(e){return this.actions.has(e)}findByPattern(e){return this.actionsByPattern.get(e.toLowerCase())||[]}getByGroup(e){return this.actionsByGroup.get(e)||[]}find(e){let r=this.get(e);return r||this.findByPattern(e)[0]}registerMessages(e,r){}updatePatternMappingsForAction(e){if(!this.languageProvider)return;let r=this.languageProvider.getActionPatterns(e.id);if(r)for(let n of r){let i=n.toLowerCase(),o=this.actionsByPattern.get(i)||[];o.includes(e)||(o.push(e),o.sort((a,s)=>(s.priority||0)-(a.priority||0)),this.actionsByPattern.set(i,o))}}rebuildPatternMappings(){this.actionsByPattern.clear();for(let e of this.actions.values())this.updatePatternMappingsForAction(e)}};dh.StandardActionRegistry=uS});var mS=p(lh=>{"use strict";Object.defineProperty(lh,"__esModule",{value:!0});lh.takingAction=void 0;var $X=nS();Object.defineProperty(lh,"takingAction",{enumerable:!0,get:function(){return $X.takingAction}})});var il=p(ps=>{"use strict";Object.defineProperty(ps,"__esModule",{value:!0});ps.actionDataRegistry=ps.ActionDataRegistry=void 0;ps.buildEventData=Yx;ps.buildValidationErrorData=QX;function Yx(t,e,r,n){let i=t.builder(e,r,n);if(t.extension){let o=t.extension(i,e,r,n);if(t.protectedFields)for(let a of t.protectedFields)a in i&&(o[a]=i[a]);i=o}return i}function QX(t,e,r){let n={actionId:t.action.id,error:e,messageId:e,params:r||{}};return t.command.directObject?.entity&&(n.params.target=t.command.directObject.entity.name,n.params.targetId=t.command.directObject.entity.id),t.command.indirectObject?.entity&&(n.params.indirectTarget=t.command.indirectObject.entity.name,n.params.indirectTargetId=t.command.indirectObject.entity.id),n}var uh=class{constructor(){l(this,"builders",new Map)}register(e,r){this.builders.set(e,r)}get(e){return this.builders.get(e)}has(e){return this.builders.has(e)}buildData(e,r,n,i){let o=this.get(e);if(o)return Yx(o,r,n,i)}};ps.ActionDataRegistry=uh;ps.actionDataRegistry=new uh});var zx=p(mh=>{"use strict";Object.defineProperty(mh,"__esModule",{value:!0});mh.DroppingMessages=void 0;mh.DroppingMessages={NO_TARGET:"no_target",NOT_HELD:"not_held",STILL_WORN:"still_worn",CONTAINER_NOT_OPEN:"container_not_open",CONTAINER_FULL:"container_full",CANT_DROP_HERE:"cant_drop_here",CANT_DROP:"cant_drop",NOTHING_TO_DROP:"nothing_to_drop",DROPPED:"dropped",DROPPED_IN:"dropped_in",DROPPED_ON:"dropped_on",DROPPED_QUIETLY:"dropped_quietly",DROPPED_CARELESSLY:"dropped_carelessly",DROPPED_MULTI:"dropped_multi"}});var Hi=p(Sc=>{"use strict";Object.defineProperty(Sc,"__esModule",{value:!0});Sc.captureEntitySnapshot=ph;Sc.captureRoomSnapshot=XX;Sc.captureEntitySnapshots=ZX;Sc.createEntityReference=Kx;Sc.createEntityReferences=JX;function ph(t,e,r=!0){let n=t.get?.("identity"),i=t.get?.("physical"),o=t.get?.("openable"),a=t.get?.("lockable"),s=t.get?.("container"),c=t.get?.("supporter"),d=t.get?.("wearable"),u=t.get?.("edible"),m=t.get?.("pushable"),f=t.get?.("scenery"),g={id:t.id,name:n?.name||t.id,description:n?.description,shortDescription:n?.shortDescription,nameId:n?.nameId,descriptionId:n?.descriptionId,location:e.getLocation(t.id)};if(i&&(g.isPortable=i.portable!==!1),o!==void 0&&(g.isOpenable=!0,g.isOpen=o.isOpen===!0),a!==void 0&&(g.isLockable=!0,g.isLocked=a.isLocked===!0),s!==void 0&&(g.isContainer=!0),c!==void 0&&(g.isSupporter=!0),d!==void 0&&(g.isWearable=!0,g.isWorn=d.isWorn===!0),u!==void 0&&(g.isEdible=!0),m!==void 0&&(g.isPushable=!0),f!==void 0&&(g.isScenery=!0),r&&(s||c)){let T=e.getContents(t.id);T.length>0&&(g.contents=T.map(I=>ph(I,e,!1)))}let h=["identity","physical","openable","lockable","container","supporter","wearable","edible","pushable","scenery"],y={};for(let[T,I]of Object.entries(t))!h.includes(T)&&T!=="id"&&T!=="type"&&(y[T]=I);return Object.keys(y).length>0&&(g.traits=y),g}function XX(t,e,r=!0){let n=t.get?.("identity"),i=t.get?.("room"),o=t.get?.("darkness"),a={id:t.id,name:n?.name||t.attributes?.name||t.id,description:n?.description||t.attributes?.description,nameId:n?.nameId,descriptionId:n?.descriptionId};o!==void 0?a.isDark=o.isDark===!0:i?.isDark!==void 0&&(a.isDark=i.isDark===!0),i?.visited!==void 0&&(a.isVisited=i.visited===!0);let s={},c=["north","south","east","west","northeast","northwest","southeast","southwest","up","down","in","out"];for(let m of c){let f=t[m];f&&typeof f=="string"&&(s[m]=f)}if(Object.keys(s).length>0&&(a.exits=s),r){let m=e.getContents(t.id);m.length>0&&(a.contents=m.map(f=>ph(f,e,!0)))}let d=["identity","room","darkness"],u={};for(let[m,f]of Object.entries(t))!d.includes(m)&&!c.includes(m)&&m!=="id"&&m!=="type"&&(u[m]=f);return Object.keys(u).length>0&&(a.traits=u),a}function ZX(t,e){return t.map(r=>ph(r,e,!0))}function Kx(t){let e=t.get?.("identity");return{id:t.id,name:e?.name||t.id}}function JX(t){return t.map(Kx)}});var $x=p(fs=>{"use strict";Object.defineProperty(fs,"__esModule",{value:!0});fs.droppedDataConfig=fs.buildDroppedData=void 0;fs.determineDroppingMessage=t6;var ol=E(),pS=Hi(),e6=(t,e,r)=>{let n=t.player,i=t.command.directObject?.entity;if(!i)return{item:"",itemName:"nothing",toLocation:"",toLocationName:"nowhere"};let o=t.world.getLocation(n.id),a=o?t.world.getEntity(o):t.currentLocation;if(!a)throw new Error("No valid drop location found");let s=(0,pS.captureEntitySnapshot)(i,t.world,!0),c=(0,pS.captureEntitySnapshot)(n,t.world,!1),d=(0,pS.captureEntitySnapshot)(a,t.world,a.has(ol.TraitType.ROOM)),u={item:i.id,itemName:i.name,toLocation:a.id,toLocationName:a.name,itemSnapshot:s,actorSnapshot:c,locationSnapshot:d};return a.has(ol.TraitType.ROOM)?u.toRoom=!0:a.has(ol.TraitType.CONTAINER)?u.toContainer=!0:a.has(ol.TraitType.SUPPORTER)&&(u.toSupporter=!0),u};fs.buildDroppedData=e6;function t6(t,e){let r=e.command.directObject?.entity,n=e.world.getEntity(t.toLocation);if(!r||!n)return{messageId:"dropped",params:{item:t.itemName}};let i={item:r.name,location:n.name},o="dropped";if(t.toContainer)o="dropped_in",i.container=n.name;else if(t.toSupporter)o="dropped_on",i.supporter=n.name;else if(t.toRoom){if((e.command.parsed.structure.verb?.text.toLowerCase()||"drop")==="discard")o="dropped_carelessly";else if(r.has(ol.TraitType.IDENTITY)){let s=r.get(ol.TraitType.IDENTITY);s&&s.name?.toLowerCase().includes("glass")&&(o="dropped_quietly")}}return{messageId:o,params:i}}fs.droppedDataConfig={builder:fs.buildDroppedData,protectedFields:["item","itemName","toLocation","toLocationName"]}});var Xx=p(fh=>{"use strict";Object.defineProperty(fh,"__esModule",{value:!0});fh.isDroppingSharedData=Qx;fh.getDroppingSharedData=r6;function Qx(t){return typeof t=="object"&&t!==null}function r6(t){return Qx(t.sharedData)||(t.sharedData={}),t.sharedData}});var i0=p(gh=>{"use strict";Object.defineProperty(gh,"__esModule",{value:!0});gh.droppingAction=void 0;var dn=E(),n6=il(),Zx=ae(),Jx=we(),ni=zx(),e0=$x(),Gu=Xx(),t0=Uu();function r0(t){let e=t.player,r=t.world.getLocation(e.id);return r?t.world.getEntity(r):t.currentLocation}function n0(t,e){let r=t.player;if(!dn.ActorBehavior.isHolding(r,e.id,t.world))return{valid:!1,error:ni.DroppingMessages.NOT_HELD,params:{item:e.name}};if(e.has(dn.TraitType.WEARABLE)&&dn.WearableBehavior.isWorn(e))return{valid:!1,error:ni.DroppingMessages.STILL_WORN,params:{item:e.name}};let n=r0(t);if(!n)return{valid:!1,error:ni.DroppingMessages.CANT_DROP_HERE};if(n.has(dn.TraitType.CONTAINER)&&!n.has(dn.TraitType.ROOM)&&!dn.ContainerBehavior.canAccept(n,e,t.world)){let i=n.get(dn.TraitType.CONTAINER);return i.capacity?.maxItems!==void 0&&t.world.getContents(n.id).length>=i.capacity.maxItems?{valid:!1,error:ni.DroppingMessages.CONTAINER_FULL,params:{item:e.name,container:n.name}}:{valid:!1,error:ni.DroppingMessages.CANT_DROP_HERE}}return{valid:!0}}function i6(t){let e=(0,t0.expandMultiObject)(t,{scope:"carried"});if(e.length===0)return{valid:!1,error:ni.DroppingMessages.NOTHING_TO_DROP};let r=e.map(o=>{let a=n0(t,o.entity);return{entity:o.entity,success:a.valid,error:a.valid?void 0:a.error,errorParams:a.valid?void 0:a.params}}),n=(0,Gu.getDroppingSharedData)(t);return n.multiObjectResults=r,r.some(o=>o.success)?{valid:!0}:{valid:!1,error:r[0].error,params:r[0].errorParams}}function o6(t,e,r){let n=t.player,i=t.world.getLocation(n.id);r.dropLocation=i,dn.ActorBehavior.dropItem(n,e,t.world),i&&t.world.moveEntity(e.id,i)}function a6(t,e,r,n,i=!1){let o=t.player,a=r.dropLocation?t.world.getEntity(r.dropLocation):r0(t),s=ni.DroppingMessages.DROPPED,c={item:e.name,location:a?.name},d=!1,u=!1,m=!1;a&&(a.has(dn.TraitType.ROOM)?m=!0:a.has(dn.TraitType.CONTAINER)?d=!0:a.has(dn.TraitType.SUPPORTER)&&(u=!0)),i?s=ni.DroppingMessages.DROPPED_MULTI:d?(s=ni.DroppingMessages.DROPPED_IN,c.container=a?.name):u&&(s=ni.DroppingMessages.DROPPED_ON,c.supporter=a?.name),n.push(t.event("if.event.dropped",{messageId:`${t.action.id}.${s}`,params:c,item:e.name,itemId:e.id,actorId:o.id,toLocation:a?.id,toLocationName:a?.name,toContainer:d,toSupporter:u,toRoom:m}))}function s6(t,e,r,n,i){i.push(t.event("if.event.drop_blocked",{messageId:`${t.action.id}.${r}`,params:{...n,item:e.name},item:e.name,itemId:e.id,reason:r}))}gh.droppingAction={id:Zx.IFActions.DROPPING,defaultScope:{item:Jx.ScopeLevel.CARRIED},requiredMessages:["no_target","not_held","still_worn","container_not_open","container_full","dropped","dropped_in","dropped_on","cant_drop_here","dropped_quietly","dropped_carelessly","nothing_to_drop"],metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:Jx.ScopeLevel.CARRIED},validate(t){if((0,t0.isMultiObjectCommand)(t))return i6(t);let e=t.command.directObject?.entity;if(!e)return{valid:!1,error:ni.DroppingMessages.NO_TARGET};let r=(0,Gu.getDroppingSharedData)(t),i=(0,dn.getInterceptorForAction)(e,Zx.IFActions.DROPPING)?.interceptor,o={};if(r.interceptor=i,r.interceptorData=o,i?.preValidate){let s=i.preValidate(e,t.world,t.player.id,o);if(s!==null)return{valid:s.valid,error:s.error,params:s.params}}let a=n0(t,e);if(!a.valid)return a;if(i?.postValidate){let s=i.postValidate(e,t.world,t.player.id,o);if(s!==null)return{valid:s.valid,error:s.error,params:s.params}}return{valid:!0}},execute(t){let e=(0,Gu.getDroppingSharedData)(t);if(e.multiObjectResults){for(let c of e.multiObjectResults)c.success&&o6(t,c.entity,c);return}let r=t.player,n=t.command.directObject.entity,i=dn.ActorBehavior.dropItem(r,n,t.world),o=t.world.getLocation(r.id);o&&t.world.moveEntity(n.id,o),e.dropResult=i;let a=e.interceptor,s=e.interceptorData||{};a?.postExecute&&a.postExecute(n,t.world,r.id,s)},report(t){let e=(0,Gu.getDroppingSharedData)(t);if(e.multiObjectResults){let u=[],m=e.multiObjectResults.length>1;for(let f of e.multiObjectResults)f.success?a6(t,f.entity,f,u,m):s6(t,f.entity,f.error,f.errorParams,u);return u}let r=(0,n6.buildEventData)(e0.droppedDataConfig,t),n=t.player,i=t.command.directObject.entity,{messageId:o,params:a}=(0,e0.determineDroppingMessage)(r,t),s=[t.event("if.event.dropped",{messageId:`${t.action.id}.${o}`,params:a,...r,item:i.name,itemId:i.id,actorId:n.id})],c=e.interceptor,d=e.interceptorData||{};if(c?.postReport){let u=c.postReport(i,t.world,n.id,d);for(let m of u)s.push(t.event(m.type,m.payload))}return s},blocked(t,e){let r=t.command.directObject?.entity,n=(0,Gu.getDroppingSharedData)(t),i=n.interceptor,o=n.interceptorData||{};if(i?.onBlocked&&r&&e.error){let a=i.onBlocked(r,t.world,t.player.id,e.error,o);if(a!==null)return a.map(s=>t.event(s.type,s.payload))}return[t.event("if.event.drop_blocked",{messageId:`${t.action.id}.${e.error}`,params:{...e.params,item:r?.name},item:r?.name,itemId:r?.id,reason:e.error})]},group:"object_manipulation"}});var fS=p(hh=>{"use strict";Object.defineProperty(hh,"__esModule",{value:!0});hh.droppingAction=void 0;var c6=i0();Object.defineProperty(hh,"droppingAction",{enumerable:!0,get:function(){return c6.droppingAction}})});var hS=p(gS=>{"use strict";Object.defineProperty(gS,"__esModule",{value:!0});gS.emitIllustrations=d6;function d6(t,e,r,n){return t.hasAnnotations("illustration")?t.getActiveAnnotations("illustration",n.world).filter(o=>o.data.trigger===e).map(o=>n.event("if.event.illustrated",{groupId:r,entityId:t.id,src:o.data.src,alt:o.data.alt,position:o.data.position??"right",width:o.data.width??"40%",...o.data.targetPanel?{targetPanel:o.data.targetPanel}:{}})):[]}});var o0=p(gs=>{"use strict";Object.defineProperty(gs,"__esModule",{value:!0});gs.examiningDataConfig=gs.buildExaminingData=void 0;gs.buildExaminingMessageParams=u6;var Xt=E(),Fu=E(),yS=Hi(),l6=(t,e,r)=>{let n=t.player,i=t.command.directObject?.entity;if(!i)return{targetId:"",targetName:"nothing"};let o=i.id===n.id,s={target:(0,yS.captureEntitySnapshot)(i,t.world,!0),targetId:i.id,targetName:o?"yourself":i.name};if(o)return s.self=!0,s;if(i.has(Xt.TraitType.IDENTITY)){let c=i.get(Xt.TraitType.IDENTITY);c&&(s.hasDescription=!!c.description,s.hasBrief=!!c.brief)}if(i.has(Xt.TraitType.CONTAINER)){let c=t.world.getContents(i.id),d=(0,yS.captureEntitySnapshots)(c,t.world);s.isContainer=!0,s.hasContents=c.length>0,s.contentCount=c.length,s.contentsSnapshots=d,s.contents=c.map(u=>({id:u.id,name:u.name})),i.has(Xt.TraitType.OPENABLE)?(s.isOpenable=!0,s.isOpen=Fu.OpenableBehavior.isOpen(i)):s.isOpen=!0}if(i.has(Xt.TraitType.SUPPORTER)){let c=t.world.getContents(i.id),d=(0,yS.captureEntitySnapshots)(c,t.world);s.isSupporter=!0,s.hasContents=c.length>0,s.contentCount=c.length,s.contentsSnapshots=d,s.contents=c.map(u=>({id:u.id,name:u.name}))}if(i.has(Xt.TraitType.SWITCHABLE)&&(s.isSwitchable=!0,s.isOn=Fu.SwitchableBehavior.isOn(i)),i.has(Xt.TraitType.READABLE)){let c=i.get(Xt.TraitType.READABLE);s.isReadable=!0,s.hasText=c?!!c.text:!1}return i.has(Xt.TraitType.WEARABLE)&&(s.isWearable=!0,s.isWorn=Fu.WearableBehavior.isWorn(i)),i.has(Xt.TraitType.DOOR)&&(s.isDoor=!0,i.has(Xt.TraitType.OPENABLE)&&(s.isOpenable=!0,s.isOpen=Fu.OpenableBehavior.isOpen(i)),i.has(Xt.TraitType.LOCKABLE)&&(s.isLockable=!0,s.isLocked=Fu.LockableBehavior.isLocked(i))),s};gs.buildExaminingData=l6;function u6(t,e){let r={},n=t.self?"examined_self":"examined",i;if(!t.self&&e){if(t.hasDescription&&e.has(Xt.TraitType.IDENTITY)){let o=e.get(Xt.TraitType.IDENTITY);o?.description&&(r.description=o.description)}if(t.isContainer){if(n="examined_container",r.isOpen=t.isOpen,t.isOpen&&t.hasContents&&t.contents){let a=t.contents.map(s=>s.name).join(", ");i={messageId:"container_contents",params:{container:e.name,items:a}}}}else if(t.isSupporter){if(n="examined_supporter",t.hasContents&&t.contents){let a=t.contents.map(s=>s.name).join(", ");i={messageId:"surface_contents",params:{surface:e.name,items:a}}}}else if(t.isSwitchable)n="examined_switchable",r.isOn=t.isOn;else if(t.isReadable&&t.hasText&&e.has(Xt.TraitType.READABLE)){let o=e.get(Xt.TraitType.READABLE);o?.text&&(r.text=o.text,n="examined_readable")}else t.isWearable?(n="examined_wearable",r.isWorn=t.isWorn):t.isDoor?(n="examined_door",t.isLocked!==void 0&&(r.isLocked=t.isLocked)):n==="examined"&&(r.target=e.name)}return{messageId:n,params:r,contentsMessage:i}}gs.examiningDataConfig={builder:gs.buildExaminingData,protectedFields:["targetId","targetName","target"]}});var a0=p(yh=>{"use strict";Object.defineProperty(yh,"__esModule",{value:!0});yh.ExaminingMessages=void 0;yh.ExaminingMessages={NO_TARGET:"no_target",NOT_VISIBLE:"not_visible",EXAMINED:"examined",EXAMINED_SELF:"examined_self",EXAMINED_CONTAINER:"examined_container",EXAMINED_SUPPORTER:"examined_supporter",EXAMINED_READABLE:"examined_readable",EXAMINED_SWITCHABLE:"examined_switchable",EXAMINED_WEARABLE:"examined_wearable",EXAMINED_DOOR:"examined_door",NOTHING_SPECIAL:"nothing_special",DESCRIPTION:"description",BRIEF_DESCRIPTION:"brief_description"}});var c0=p(Th=>{"use strict";Object.defineProperty(Th,"__esModule",{value:!0});Th.examiningAction=void 0;var m6=ae(),TS=we(),p6=hS(),f6=il(),s0=o0(),g6=a0();Th.examiningAction={id:m6.IFActions.EXAMINING,defaultScope:{target:TS.ScopeLevel.VISIBLE},requiredMessages:["no_target","not_visible","examined","examined_self","examined_container","examined_supporter","examined_readable","examined_switchable","examined_wearable","examined_door","nothing_special","description","brief_description"],validate(t){let e=t.player,r=t.command.directObject?.entity;if(!r)return{valid:!1,error:g6.ExaminingMessages.NO_TARGET};if(r.id!==e.id){let n=t.requireScope(r,TS.ScopeLevel.VISIBLE);if(!n.ok)return n.error}return{valid:!0}},execute(t){},report(t){let e=t.command.directObject.entity,r=(0,f6.buildEventData)(s0.examiningDataConfig,t),{messageId:n,params:i,contentsMessage:o}=(0,s0.buildExaminingMessageParams)(r,e),a=t.event("if.event.examined",{messageId:`${t.action.id}.${n}`,params:i,...r}),s=[a];return s.push(...(0,p6.emitIllustrations)(e,"on-examine",a.id,t)),o&&s.push(t.event("if.event.examined",{messageId:`${t.action.id}.${o.messageId}`,params:o.params,isContentsMessage:!0})),s},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.examined",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{target:r?.name,...e.params},reason:e.error,targetId:r?.id,targetName:r?.name})]},group:"observation",metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:TS.ScopeLevel.VISIBLE}}});var ES=p(Eh=>{"use strict";Object.defineProperty(Eh,"__esModule",{value:!0});Eh.examiningAction=void 0;var h6=c0();Object.defineProperty(Eh,"examiningAction",{enumerable:!0,get:function(){return h6.examiningAction}})});var d0=p(vh=>{"use strict";Object.defineProperty(vh,"__esModule",{value:!0});vh.OpeningMessages=void 0;vh.OpeningMessages={NO_TARGET:"no_target",NOT_OPENABLE:"not_openable",ALREADY_OPEN:"already_open",LOCKED:"locked",CANT_REACH:"cant_reach",CANNOT_OPEN:"cannot_open",OPENED:"opened",REVEALING:"revealing",ITS_EMPTY:"its_empty"}});var u0=p(_h=>{"use strict";Object.defineProperty(_h,"__esModule",{value:!0});_h.openingAction=void 0;var hs=E(),l0=ae(),vS=we(),al=d0();_h.openingAction={id:l0.IFActions.OPENING,defaultScope:{target:vS.ScopeLevel.REACHABLE},targetRequirements:{trait:hs.TraitType.OPENABLE,condition:"not_open",description:"openable"},requiresHolding:!1,requiredMessages:["no_target","not_openable","already_open","locked","opened","revealing","its_empty","cant_reach"],metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:vS.ScopeLevel.REACHABLE},group:"container_manipulation",validate(t){let e=t.command.directObject?.entity;if(!e)return{valid:!1,error:al.OpeningMessages.NO_TARGET};let r=(0,hs.getInterceptorForAction)(e,l0.IFActions.OPENING);if(r){let{interceptor:i}=r,o={};if(i.preValidate){let a=i.preValidate(e,t.world,t.player.id,o);if(a!==null&&!a.valid)return{valid:!1,error:a.error,params:a.params}}}let n=t.requireScope(e,vS.ScopeLevel.REACHABLE);return n.ok?e.has(hs.TraitType.OPENABLE)?hs.OpenableBehavior.canOpen(e)?e.has(hs.TraitType.LOCKABLE)&&hs.LockableBehavior.isLocked(e)?{valid:!1,error:al.OpeningMessages.LOCKED,params:{item:e.name}}:{valid:!0}:{valid:!1,error:al.OpeningMessages.ALREADY_OPEN,params:{item:e.name}}:{valid:!1,error:al.OpeningMessages.NOT_OPENABLE,params:{item:e.name}}:n.error},execute(t){let e=t.command.directObject.entity,r=hs.OpenableBehavior.open(e),n={openResult:r};t.sharedData.openResult=r},report(t){let e=t.command.directObject.entity,r=t.sharedData.openResult,n=[],i=e.has(hs.TraitType.CONTAINER),o=i?t.world.getContents(e.id):[],a=al.OpeningMessages.OPENED,s={item:e.name};return i&&o.length===0&&(a=al.OpeningMessages.ITS_EMPTY,s={container:e.name}),n.push(t.event("if.event.opened",{messageId:`${t.action.id}.${a}`,params:s,targetId:e.id,targetName:e.name,actorId:t.player.id})),n.push(t.event("opened",{targetId:e.id,targetName:e.name})),n},blocked(t,e){let r=t.command.directObject?.entity,n=e.error||"",i=n.includes(".")?n:`${t.action.id}.${n}`;return[t.event("if.event.open_blocked",{messageId:i,params:{...e.params,item:r?.name},targetId:r?.id,targetName:r?.name,reason:e.error})]}}});var _S=p(bh=>{"use strict";Object.defineProperty(bh,"__esModule",{value:!0});bh.openingAction=void 0;var y6=u0();Object.defineProperty(bh,"openingAction",{enumerable:!0,get:function(){return y6.openingAction}})});var p0=p(Ac=>{"use strict";Object.defineProperty(Ac,"__esModule",{value:!0});Ac.closedDataConfig=Ac.buildClosedData=void 0;var m0=Hi(),T6=t=>{let e=t.command.directObject?.entity;if(!e)return{target:"nothing"};let r=(0,m0.captureEntitySnapshot)(e,t.world,!1),n=t.world.getContents(e.id),i=(0,m0.captureEntitySnapshots)(n,t.world);return{target:e.name,targetSnapshot:r,contentsSnapshots:i,targetId:e.id}};Ac.buildClosedData=T6;Ac.closedDataConfig={builder:Ac.buildClosedData,protectedFields:["target","targetId"]}});var f0=p(Ih=>{"use strict";Object.defineProperty(Ih,"__esModule",{value:!0});Ih.ClosingMessages=void 0;Ih.ClosingMessages={NO_TARGET:"no_target",NOT_CLOSABLE:"not_closable",ALREADY_CLOSED:"already_closed",PREVENTS_CLOSING:"prevents_closing",CANT_CLOSE:"cant_close",CANNOT_CLOSE:"cannot_close",CLOSED:"closed"}});var IS=p(Oh=>{"use strict";Object.defineProperty(Oh,"__esModule",{value:!0});Oh.closingAction=void 0;var qi=E(),E6=il(),g0=ae(),v6=p0(),sl=f0(),bS=we();function h0(t){return t.sharedData}Oh.closingAction={id:g0.IFActions.CLOSING,defaultScope:{target:bS.ScopeLevel.REACHABLE},targetRequirements:{trait:qi.TraitType.OPENABLE,condition:"is_open",description:"closable"},requiresHolding:!1,requiredMessages:["no_target","not_closable","already_closed","closed","cant_reach","prevents_closing"],metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:bS.ScopeLevel.REACHABLE},group:"container_manipulation",validate(t){let e=t.command.directObject?.entity;if(!e)return{valid:!1,error:sl.ClosingMessages.NO_TARGET};let r=(0,qi.getInterceptorForAction)(e,g0.IFActions.CLOSING);if(r){let{interceptor:o}=r,a={};if(o.preValidate){let s=o.preValidate(e,t.world,t.player.id,a);if(s!==null&&!s.valid)return{valid:!1,error:s.error,params:s.params}}}let n=t.requireScope(e,bS.ScopeLevel.REACHABLE);if(!n.ok)return n.error;if(!e.has(qi.TraitType.OPENABLE))return{valid:!1,error:sl.ClosingMessages.NOT_CLOSABLE,params:{item:e.name}};if(!qi.OpenableBehavior.canClose(e))return qi.OpenableBehavior.isOpen(e)?{valid:!1,error:sl.ClosingMessages.PREVENTS_CLOSING,params:{item:e.name}}:{valid:!1,error:sl.ClosingMessages.ALREADY_CLOSED,params:{item:e.name}};let i=e.get(qi.TraitType.OPENABLE);if(i.closeRequirements){let o=i.closeRequirements;if(o.preventedBy)return{valid:!1,error:sl.ClosingMessages.PREVENTS_CLOSING,params:{item:e.name,obstacle:o.preventedBy}}}return{valid:!0}},execute(t){let e=t.command.directObject.entity,r=qi.OpenableBehavior.close(e),n=h0(t);n.closeResult=r},report(t){let e=t.command.directObject.entity,n=h0(t).closeResult,i=[];i.push(t.event("closed",{targetId:e.id,targetName:e.name,customMessage:n.closeMessage,sound:n.closeSound}));let o=(0,E6.buildEventData)(v6.closedDataConfig,t),a=e.has(qi.TraitType.CONTAINER),s=e.has(qi.TraitType.DOOR),c=e.has(qi.TraitType.SUPPORTER),d=!1,u=0,m=[];if(a){let f=t.world.getContents(e.id);d=f.length>0,u=f.length,m=f.map(g=>g.id)}return i.push(t.event("if.event.closed",{messageId:`${t.action.id}.${sl.ClosingMessages.CLOSED}`,params:{item:e.name},...o,targetId:e.id,targetName:e.name,actorId:t.player.id,containerId:e.id,containerName:e.name,isContainer:a,isDoor:s,isSupporter:c,hasContents:d,contentsCount:u,contentsIds:m,item:e.name})),i},blocked(t,e){let r=t.command.directObject?.entity,n=e.error||"",i=n.includes(".")?n:`${t.action.id}.${n}`;return[t.event("if.event.close_blocked",{messageId:i,params:{...e.params,item:r?.name},targetId:r?.id,targetName:r?.name,reason:e.error})]}}});var y0=p(Sh=>{"use strict";Object.defineProperty(Sh,"__esModule",{value:!0});Sh.GoingMessages=void 0;Sh.GoingMessages={NO_DIRECTION:"no_direction",NOT_IN_ROOM:"not_in_room",NO_EXITS:"no_exits",NO_EXIT_THAT_WAY:"no_exit_that_way",MOVEMENT_BLOCKED:"movement_blocked",DOOR_CLOSED:"door_closed",DOOR_LOCKED:"door_locked",DESTINATION_NOT_FOUND:"destination_not_found",TOO_DARK:"too_dark",NEED_LIGHT:"need_light",WENT:"went",ARRIVED:"arrived",CANT_GO:"cant_go"}});var E0=p(Mt=>{"use strict";Object.defineProperty(Mt,"__esModule",{value:!0});Mt.actorEnteredDataConfig=Mt.actorExitedDataConfig=Mt.actorMovedDataConfig=Mt.buildActorEnteredData=Mt.buildActorExitedData=Mt.buildActorMovedData=void 0;Mt.determineGoingMessage=S6;var Ah=E(),OS=Hi(),_6=SS();function T0(t,e,r){let i=r.getAllEntities().filter(o=>o.has(Ah.TraitType.ROOM));for(let o of i){let a=Ah.RoomBehavior.getExit(o,e);if(a&&a.destination===t.id)return{room:o,mapHint:a.mapHint}}return{room:t}}var b6=(t,e,r)=>{let n=t.player,i=t.command.parsed.extras?.direction;if(!i&&t.command.directObject?.entity){let T=t.command.directObject.entity.name||t.command.directObject.entity.attributes?.name;T&&(i=T)}let o=(0,Ah.getOppositeDirection)(i),a=t.world.getLocation(n.id),s=t.world.getEntity(a),{room:c,mapHint:d}=T0(s,i,t.world),u=(0,OS.captureRoomSnapshot)(c,t.world,!1),m=(0,OS.captureRoomSnapshot)(s,t.world,!1),f=(0,OS.captureEntitySnapshot)(n,t.world,!0),h=(0,_6.getGoingSharedData)(t).isFirstVisit===!0,y={actor:f,sourceRoom:u,destinationRoom:m,direction:i,fromRoom:c.id,toRoom:s.id,oppositeDirection:o,firstVisit:h};return d&&(y.mapHint=d),y};Mt.buildActorMovedData=b6;var I6=(t,e,r)=>{let n=t.player,i=t.command.parsed.extras?.direction;if(!i&&t.command.directObject?.entity){let s=t.command.directObject.entity.name||t.command.directObject.entity.attributes?.name;s&&(i=s)}let o=t.world.getLocation(n.id),a=t.world.getEntity(o);return{actorId:n.id,direction:i,toRoom:a.id}};Mt.buildActorExitedData=I6;var O6=(t,e,r)=>{let n=t.player,i=t.command.parsed.extras?.direction;if(!i&&t.command.directObject?.entity){let d=t.command.directObject.entity.name||t.command.directObject.entity.attributes?.name;d&&(i=d)}let o=(0,Ah.getOppositeDirection)(i),a=t.world.getLocation(n.id),s=t.world.getEntity(a),{room:c}=T0(s,i,t.world);return{actorId:n.id,direction:o,fromRoom:c.id}};Mt.buildActorEnteredData=O6;function S6(t){let e=t.firstVisit?"first_visit":"moved_to",r=t.destinationRoom,n=r?.name||r?.attributes?.name||r?.id||"unknown";return{messageId:e,params:{direction:t.direction,destination:n}}}Mt.actorMovedDataConfig={builder:Mt.buildActorMovedData,protectedFields:["direction","fromRoom","toRoom"]};Mt.actorExitedDataConfig={builder:Mt.buildActorExitedData,protectedFields:["actorId","direction"]};Mt.actorEnteredDataConfig={builder:Mt.buildActorEnteredData,protectedFields:["actorId","direction"]}});var SS=p(Yu=>{"use strict";Object.defineProperty(Yu,"__esModule",{value:!0});Yu.goingAction=void 0;Yu.getGoingSharedData=Vu;var Wt=E(),AS=ae(),A6=we(),v0=Hi(),RS=il(),Fo=y0(),CS=E0();function Vu(t){return t.sharedData}Yu.goingAction={id:AS.IFActions.GOING,requiredMessages:["no_direction","not_in_room","no_exits","no_exit_that_way","movement_blocked","door_closed","door_locked","destination_not_found","moved","moved_to","first_visit","too_dark","need_light"],validate(t){let e=t.player,r=Vu(t),n=t.command.parsed.extras?.direction;if(!n&&t.command.directObject?.entity){let y=t.command.directObject.entity.name||t.command.directObject.entity.attributes?.name;y&&(n=y)}if(!n)return{valid:!1,error:Fo.GoingMessages.NO_DIRECTION};let i=(0,Wt.canActorWalkInVehicle)(t.world,e.id),o=t.currentLocation;if(i.vehicle){if(!i.canWalk)return{valid:!1,error:Fo.GoingMessages.NOT_IN_ROOM,params:{vehicle:i.vehicle?.name}};let y=t.world.getContainingRoom(e.id);y&&(o=y,r.vehicleId=t.world.getLocation(e.id))}if(!o.has(Wt.TraitType.ROOM))return{valid:!1,error:Fo.GoingMessages.NOT_IN_ROOM};let s=(0,Wt.getInterceptorForAction)(o,AS.IFActions.GOING)?.interceptor,c={direction:n};if(r.interceptor=s,r.interceptorData=c,r.sourceRoom=o,s?.preValidate){let y=s.preValidate(o,t.world,e.id,c);if(y!==null&&!y.valid)return r.blockedBy="source",{valid:y.valid,error:y.error,params:y.params}}let d=Wt.RoomBehavior.getExit(o,n);if(!d)return Wt.RoomBehavior.getAllExits(o).size===0?{valid:!1,error:Fo.GoingMessages.NO_EXITS}:{valid:!1,error:Fo.GoingMessages.NO_EXIT_THAT_WAY,params:{direction:n}};if(Wt.RoomBehavior.isExitBlocked(o,n)){let y=Wt.RoomBehavior.getBlockedMessage(o,n)||"You can't go that way.";return{valid:!1,error:Fo.GoingMessages.MOVEMENT_BLOCKED,params:{direction:n,message:y}}}if(d.via){let y=t.world.getEntity(d.via);if(y){let T=y.has(Wt.TraitType.LOCKABLE)&&Wt.LockableBehavior.isLocked(y),I=y.has(Wt.TraitType.OPENABLE)&&!Wt.OpenableBehavior.isOpen(y);if(T)return{valid:!1,error:Fo.GoingMessages.DOOR_LOCKED,params:{door:y.name,direction:n,isClosed:I,isLocked:!0}};if(I)return{valid:!1,error:Fo.GoingMessages.DOOR_CLOSED,params:{door:y.name,direction:n}}}}let u=d.destination,m=t.world.getEntity(u);if(!m)return{valid:!1,error:Fo.GoingMessages.DESTINATION_NOT_FOUND,params:{direction:n}};let g=(0,Wt.getInterceptorForAction)(m,AS.IFActions.ENTERING_ROOM)?.interceptor,h={direction:n,sourceRoomId:o.id,destinationRoomId:m.id};if(r.destinationInterceptor=g,r.destinationInterceptorData=h,r.destinationRoom=m,g?.preValidate){let y=g.preValidate(m,t.world,e.id,h);if(y!==null&&!y.valid)return r.blockedBy="destination",{valid:y.valid,error:y.error,params:y.params}}if(s?.postValidate){let y=s.postValidate(o,t.world,e.id,c);if(y!==null)return r.blockedBy="source",{valid:y.valid,error:y.error,params:y.params}}if(g?.postValidate){let y=g.postValidate(m,t.world,e.id,h);if(y!==null)return r.blockedBy="destination",{valid:y.valid,error:y.error,params:y.params}}return{valid:!0}},execute(t){let e=t.player,r=Vu(t),n=t.currentLocation;if(r.vehicleId){let f=t.world.getContainingRoom(e.id);f&&(n=f)}let i=t.command.parsed.extras?.direction;if(!i&&t.command.directObject?.entity){let f=t.command.directObject.entity.name||t.command.directObject.entity.attributes?.name;f&&(i=f)}let o=Wt.RoomBehavior.getExit(n,i),a=t.world.getEntity(o.destination),s=!Wt.RoomBehavior.hasBeenVisited(a);r.isFirstVisit=s,r.previousLocation=n.id,r.currentLocation=a.id,r.direction=i,r.vehicleId?t.world.moveEntity(r.vehicleId,a.id):t.world.moveEntity(e.id,a.id),s&&Wt.RoomBehavior.markVisited(a,e);let c=r.interceptor,d=r.interceptorData||{};c?.postExecute&&r.sourceRoom&&c.postExecute(r.sourceRoom,t.world,e.id,d);let u=r.destinationInterceptor,m=r.destinationInterceptorData||{};u?.postExecute&&r.destinationRoom&&u.postExecute(r.destinationRoom,t.world,e.id,m)},report(t){let e=Vu(t),r=t.world.getEntity(e.currentLocation),n=(0,RS.buildEventData)(CS.actorExitedDataConfig,t),i=(0,RS.buildEventData)(CS.actorMovedDataConfig,t),o=(0,RS.buildEventData)(CS.actorEnteredDataConfig,t),a=[t.event("if.event.actor_exited",n),t.event("if.event.actor_moved",i),t.event("if.event.actor_entered",o)];if(Wt.VisibilityBehavior.isDark(r,t.world))return a.push(t.event("if.event.went",{messageId:`${t.action.id}.too_dark`,params:{},actorId:t.player.id,destinationId:r.id,isDark:!0})),a;let c=(0,v0.captureRoomSnapshot)(r,t.world,!1),d=t.world.getContents(r.id).filter(T=>T.id!==t.player.id).filter(T=>{let I=T.getTrait(Wt.TraitType.IDENTITY);return!(I&&I.concealed===!0)}),u=(0,v0.captureEntitySnapshots)(d,t.world),m={room:c,visibleItems:u,roomId:r.id,roomName:r.name,roomDescription:r.description,includeContents:!0,verbose:!0,previousLocation:e.previousLocation,currentLocation:e.currentLocation,isDark:!1,contents:d.map(T=>({id:T.id,name:T.name,description:T.description}))};if(a.push(t.event("if.event.room.description",m)),d.length>0){let T=d.map(I=>I.name).join(", ");a.push(t.event("if.event.list.contents",{messageId:"if.action.looking.contents_list",params:{items:T,count:d.length},locationId:r.id,itemIds:d.map(I=>I.id),itemNames:d.map(I=>I.name)}))}let f=e.interceptor,g=e.interceptorData||{};if(f?.postReport&&e.sourceRoom){let T=f.postReport(e.sourceRoom,t.world,t.player.id,g);for(let I of T)a.push(t.event(I.type,I.payload))}let h=e.destinationInterceptor,y=e.destinationInterceptorData||{};if(h?.postReport&&e.destinationRoom){let T=h.postReport(e.destinationRoom,t.world,t.player.id,y);for(let I of T)a.push(t.event(I.type,I.payload))}return a},blocked(t,e){let r=Vu(t);if(r.blockedBy==="destination"){let o=r.destinationInterceptor,a=r.destinationInterceptorData||{};if(o?.onBlocked&&r.destinationRoom&&e.error){let s=o.onBlocked(r.destinationRoom,t.world,t.player.id,e.error,a);if(s!==null)return s.map(c=>t.event(c.type,c.payload))}}let n=r.interceptor,i=r.interceptorData||{};if(n?.onBlocked&&r.sourceRoom&&e.error){let o=n.onBlocked(r.sourceRoom,t.world,t.player.id,e.error,i);if(o!==null)return o.map(a=>t.event(a.type,a.payload))}return[t.event("if.event.went",{blocked:!0,reason:e.error,messageId:`${t.action.id}.${e.error}`,params:e.params||{},actorId:t.player.id})]},group:"movement",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1,directObjectScope:A6.ScopeLevel.VISIBLE}}});var wS=p(Rh=>{"use strict";Object.defineProperty(Rh,"__esModule",{value:!0});Rh.goingAction=void 0;var R6=SS();Object.defineProperty(Rh,"goingAction",{enumerable:!0,get:function(){return R6.goingAction}})});var _0=p(Pt=>{"use strict";Object.defineProperty(Pt,"__esModule",{value:!0});Pt.listContentsDataConfig=Pt.roomDescriptionDataConfig=Pt.lookingEventDataConfig=Pt.buildListContentsData=Pt.buildRoomDescriptionData=Pt.buildLookingEventData=void 0;Pt.determineLookingMessage=L6;var Zt=E(),cl=Hi();function C6(t){let e=t.world.getContainingRoom(t.player.id);return e?Zt.VisibilityBehavior.isDark(e,t.world):!1}var w6=(t,e,r)=>{let n=t.player,{location:i,immediateContainer:o}=Zt.VisibilityBehavior.getDescribableLocation(n,t.world),a=t.getVisible().filter(m=>m.id!==i.id&&m.id!==n.id),s=C6(t),c=(0,cl.captureRoomSnapshot)(i,t.world,!1),d=(0,cl.captureEntitySnapshots)(a,t.world),u=i.get?.("identity");return{actorId:n.id,room:c,visibleItems:d,locationId:i.id,locationName:i.name,locationDescription:i.description,locationNameId:u?.nameId,locationDescriptionId:u?.descriptionId,isDark:s,inVehicle:o?.name||null,contents:a.map(m=>({id:m.id,name:m.name,description:m.description})),timestamp:Date.now()}};Pt.buildLookingEventData=w6;var N6=(t,e,r)=>{let{location:n,immediateContainer:i}=Zt.VisibilityBehavior.getDescribableLocation(t.player,t.world),o=t.getVisible().filter(f=>f.id!==n.id&&f.id!==t.player.id),a=(0,cl.captureRoomSnapshot)(n,t.world,!1),s=(0,cl.captureEntitySnapshots)(o,t.world),c=t.verboseMode??!0,d=!t.visitedLocations?.includes(n.id),u=c||d,m=n.get?.("identity");return{room:a,visibleItems:s,roomId:n.id,roomName:n.name,roomDescription:n.description,roomNameId:m?.nameId,roomDescriptionId:m?.descriptionId,includeContents:!0,verbose:u,inVehicle:i?.name||null,contents:o.map(f=>({id:f.id,name:f.name,description:f.description})),timestamp:Date.now()}};Pt.buildRoomDescriptionData=N6;var D6=(t,e,r)=>{let{location:n}=Zt.VisibilityBehavior.getDescribableLocation(t.player,t.world),i=t.getVisible().filter(g=>g.id!==n.id&&g.id!==t.player.id);if(i.length===0)return{};let o=(0,cl.captureRoomSnapshot)(n,t.world,!1),a=(0,cl.captureEntitySnapshots)(i,t.world),s=i.filter(g=>t.world.getLocation(g.id)===n.id),c=s.filter(g=>g.hasTrait(Zt.TraitType.ACTOR)),d=s.filter(g=>g.hasTrait(Zt.TraitType.CONTAINER)&&!g.hasTrait(Zt.TraitType.ACTOR)),u=s.filter(g=>g.hasTrait(Zt.TraitType.SUPPORTER)&&!g.hasTrait(Zt.TraitType.CONTAINER)),m=s.filter(g=>!g.hasTrait(Zt.TraitType.ACTOR)&&!g.hasTrait(Zt.TraitType.CONTAINER)&&!g.hasTrait(Zt.TraitType.SUPPORTER)),f=[];for(let g of d){if(g.hasTrait(Zt.TraitType.OPENABLE)){let{OpenableBehavior:y}=E();if(!y.isOpen(g))continue}let h=t.world.getContents(g.id);h.length>0&&f.push({containerId:g.id,containerName:g.name,preposition:"in",itemIds:h.map(y=>y.id),itemNames:h.map(y=>y.name)})}for(let g of u){let h=t.world.getContents(g.id);h.length>0&&f.push({containerId:g.id,containerName:g.name,preposition:"on",itemIds:h.map(y=>y.id),itemNames:h.map(y=>y.name)})}return{allItems:a,location:o,items:i.map(g=>g.id),directItems:s.map(g=>g.id),directItemNames:s.map(g=>g.name),npcs:c.map(g=>g.id),containers:d.map(g=>g.id),supporters:u.map(g=>g.id),other:m.map(g=>g.id),openContainerContents:f,context:"room",locationName:n.name,timestamp:Date.now()}};Pt.buildListContentsData=D6;function L6(t,e){let{location:r,immediateContainer:n}=Zt.VisibilityBehavior.getDescribableLocation(t.player,t.world),i={};if(e)return{messageId:"room_dark",params:{location:r.name}};if(i.name=r.name,i.description=r.description,i.location=r.name,n&&(i.inVehicle=n.name),!n&&r.hasTrait(Zt.TraitType.CONTAINER))return{messageId:"in_container",params:{container:r.name,location:r.name}};if(!n&&r.hasTrait(Zt.TraitType.SUPPORTER))return{messageId:"on_supporter",params:{supporter:r.name,location:r.name}};let o=t.verboseMode??!0,a=!t.visitedLocations?.includes(r.id),s=!o&&!a?"room_description_brief":"room_description",c=t.getVisible().filter(g=>g.id!==r.id&&g.id!==t.player.id),d=t.command.parsed.structure.verb?.text.toLowerCase()||"look",u=t.command.directObject!==void 0&&t.command.directObject!==null||t.command.parsed.structure.directObject!==void 0&&t.command.parsed.structure.directObject!==null;if(d==="examine"&&!u)return{messageId:"examine_surroundings",params:i};let f=c.filter(g=>t.world.getLocation(g.id)===r.id);if(f.length>0){let g=f.map(h=>h.name).join(", ");return{messageId:s,params:{items:g,count:f.length,hasItems:!0,...i}}}return{messageId:s,params:i}}Pt.lookingEventDataConfig={builder:Pt.buildLookingEventData,protectedFields:["actorId","locationId","timestamp"]};Pt.roomDescriptionDataConfig={builder:Pt.buildRoomDescriptionData,protectedFields:["roomId","timestamp"]};Pt.listContentsDataConfig={builder:Pt.buildListContentsData,protectedFields:["locationName","timestamp"]}});var I0=p(wh=>{"use strict";Object.defineProperty(wh,"__esModule",{value:!0});wh.lookingAction=void 0;var b0=E(),M6=ae(),P6=hS(),NS=il(),Ch=_0();wh.lookingAction={id:M6.IFActions.LOOKING,requiredMessages:["room_description","room_description_brief","room_dark","contents_list","nothing_special","in_container","on_supporter","cant_see_in_dark","look_around","examine_surroundings"],validate(t){return{valid:!0}},execute(t){let e=t.currentLocation,r=t.world.getContainingRoom(t.player.id);if(r&&r.hasTrait(b0.TraitType.ROOM)){let n=r.getTrait(b0.TraitType.ROOM);n&&!n.visited&&(n.visited=!0)}},report(t){let e=[],r=(0,NS.buildEventData)(Ch.lookingEventDataConfig,t),n=r.isDark,{messageId:i,params:o}=(0,Ch.determineLookingMessage)(t,n);if(n)return e.push(t.event("if.event.looked",{messageId:`${t.action.id}.${i}`,params:o,...r})),e;let a=t.event("if.event.looked",r);e.push(a);let s=(0,NS.buildEventData)(Ch.roomDescriptionDataConfig,t);e.push(t.event("if.event.room.description",s));let c=t.world.getContainingRoom(t.player.id);c&&e.push(...(0,P6.emitIllustrations)(c,"on-enter",a.id,t));let d=(0,NS.buildEventData)(Ch.listContentsDataConfig,t);o.hasItems&&e.push(t.event("if.event.list.contents",{messageId:`${t.action.id}.contents_list`,params:o,...d}));let u=d.openContainerContents;if(u&&u.length>0)for(let m of u){let f=m.preposition==="in"?"container_contents":"surface_contents",g=m.preposition==="in"?"container":"surface";e.push(t.event("if.event.list.contents",{messageId:`${t.action.id}.${f}`,params:{[g]:m.containerName,items:m.itemNames.join(", ")},containerId:m.containerId,containerName:m.containerName,preposition:m.preposition,itemIds:m.itemIds,itemNames:m.itemNames}))}return e},blocked(t,e){return[t.event("if.event.looked",{blocked:!0,reason:e.error,messageId:`${t.action.id}.${e.error}`,params:e.params,actorId:t.player.id})]},group:"observation",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1}}});var S0=p(O0=>{"use strict";Object.defineProperty(O0,"__esModule",{value:!0})});var DS=p(Vo=>{"use strict";var k6=Vo&&Vo.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),B6=Vo&&Vo.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&k6(e,t,r)};Object.defineProperty(Vo,"__esModule",{value:!0});Vo.lookingAction=void 0;var x6=I0();Object.defineProperty(Vo,"lookingAction",{enumerable:!0,get:function(){return x6.lookingAction}});B6(S0(),Vo)});var A0=p(Nh=>{"use strict";Object.defineProperty(Nh,"__esModule",{value:!0});Nh.InventoryMessages=void 0;Nh.InventoryMessages={INVENTORY_EMPTY:"inventory_empty",CARRYING:"carrying",WEARING:"wearing",CARRYING_AND_WEARING:"carrying_and_wearing",HOLDING_LIST:"holding_list",WORN_LIST:"worn_list",CHECKING_POCKETS:"checking_pockets",RIFLING_THROUGH_BAG:"rifling_through_bag",INVENTORY_HEADER:"inventory_header",NOTHING_AT_ALL:"nothing_at_all",HANDS_EMPTY:"hands_empty",POCKETS_EMPTY:"pockets_empty",CARRYING_COUNT:"carrying_count",WEARING_COUNT:"wearing_count",BURDEN_LIGHT:"burden_light",BURDEN_HEAVY:"burden_heavy",BURDEN_OVERLOADED:"burden_overloaded"}});var w0=p(Dh=>{"use strict";Object.defineProperty(Dh,"__esModule",{value:!0});Dh.inventoryAction=void 0;var Rc=E(),j6=ae(),R0=A0();function C0(t){return t.sharedData}function W6(t){let e=t.player,r=t.currentLocation,n=t.world.getContents(e.id),i=n.filter(T=>T.has(Rc.TraitType.WEARABLE)?T.get(Rc.TraitType.WEARABLE).worn:!1),o=n.filter(T=>T.has(Rc.TraitType.WEARABLE)?!T.get(Rc.TraitType.WEARABLE).worn:!0),a=0,s=!1,c=0;if(e.has(Rc.TraitType.ACTOR)){let T=e.get(Rc.TraitType.ACTOR);T&&T.inventoryLimit?.maxWeight!==void 0&&(s=!0,c=T.inventoryLimit.maxWeight,n.forEach(I=>{let A=I.get(Rc.TraitType.IDENTITY);A&&A.weight&&(a+=A.weight)}))}let d={actorId:e.id,locationId:r.id,totalItems:n.length,heldItems:o.length,wornItems:i.length,isEmpty:n.length===0,carried:o.map(T=>({id:T.id,name:T.name})),worn:i.map(T=>({id:T.id,name:T.name})),items:[...o.map(T=>({id:T.id,name:T.name,worn:!1})),...i.map(T=>({id:T.id,name:T.name,worn:!0}))]};if(s&&(d.totalWeight=a,d.maxWeight=c,d.weightLimit=c,d.weightPercentage=Math.round(a/c*100),n.length>0)){let T=a/c*100;T>=90?d.burden="overloaded":T>=75?d.burden="heavy":d.burden="light"}let u=t.command.parsed.structure.verb?.text.toLowerCase()||"inventory";(u==="i"||u==="inv")&&(d.brief=!0);let m={},f="carrying";if(n.length===0){f="inventory_empty";let T=["inventory_empty","nothing_at_all","hands_empty","pockets_empty"];f=T[Math.floor(Math.random()*T.length)]}else o.length>0&&i.length>0?(f="carrying_and_wearing",m.holdingCount=o.length,m.wearingCount=i.length):i.length>0&&o.length===0?(f="wearing",m.wearingCount=i.length):m.holdingCount=o.length;let g=o.length>0?o.map(T=>T.name).join(", "):void 0,h=i.length>0?i.map(T=>T.name).join(", "):void 0,y=d.burden&&n.length>0?`burden_${d.burden}`:void 0;return{holding:o,worn:i,carried:n,eventData:d,messageId:f,params:m,holdingList:g,wornList:h,burdenMessage:y,totalWeight:a,weightLimit:c}}Dh.inventoryAction={id:j6.IFActions.INVENTORY,requiredMessages:["inventory_empty","carrying","wearing","carrying_and_wearing","holding_list","worn_list","checking_pockets","rifling_through_bag","inventory_header","nothing_at_all","hands_empty","pockets_empty","carrying_count","wearing_count","burden_light","burden_heavy","burden_overloaded"],validate(t){return{valid:!0}},execute(t){let e=W6(t),r=C0(t);r.analysis=e},report(t){let e=[],n=C0(t).analysis;return n&&(e.push(t.event("if.event.inventory",{messageId:`${t.action.id}.${n.messageId}`,params:{...n.params,holdingList:n.holdingList,wornList:n.wornList},...n.eventData})),n.holdingList&&e.push(t.event("if.event.inventory",{messageId:`${t.action.id}.${R0.InventoryMessages.HOLDING_LIST}`,params:{items:n.holdingList},isHoldingList:!0})),n.wornList&&e.push(t.event("if.event.inventory",{messageId:`${t.action.id}.${R0.InventoryMessages.WORN_LIST}`,params:{items:n.wornList},isWornList:!0})),n.burdenMessage&&e.push(t.event("if.event.inventory",{messageId:`${t.action.id}.${n.burdenMessage}`,params:{weight:n.totalWeight,limit:n.weightLimit},isBurdenMessage:!0}))),e},blocked(t,e){return[t.event("if.event.inventory",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:e.params||{},reason:e.error})]},group:"meta",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1}}});var D0=p(N0=>{"use strict";Object.defineProperty(N0,"__esModule",{value:!0})});var LS=p(Yo=>{"use strict";var U6=Yo&&Yo.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),H6=Yo&&Yo.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&U6(e,t,r)};Object.defineProperty(Yo,"__esModule",{value:!0});Yo.inventoryAction=void 0;var q6=w0();Object.defineProperty(Yo,"inventoryAction",{enumerable:!0,get:function(){return q6.inventoryAction}});H6(D0(),Yo)});var M0=p(Lh=>{"use strict";Object.defineProperty(Lh,"__esModule",{value:!0});Lh.waitingAction=void 0;var G6=ae();function L0(t){return t.sharedData}Lh.waitingAction={id:G6.IFActions.WAITING,requiredMessages:["time_passes"],group:"meta",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1},validate(t){return{valid:!0}},execute(t){let e=t.currentLocation,r=L0(t);r.locationId=e?.id,r.locationName=e?.name},blocked(t,e){return[t.event("if.event.wait_blocked",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:e.params,reason:e.error})]},report(t){let e=[],r=L0(t);return e.push(t.event("if.event.waited",{messageId:`${t.action.id}.time_passes`,turnsPassed:1,location:r.locationId,locationName:r.locationName})),e}}});var MS=p(Mh=>{"use strict";Object.defineProperty(Mh,"__esModule",{value:!0});Mh.waitingAction=void 0;var F6=M0();Object.defineProperty(Mh,"waitingAction",{enumerable:!0,get:function(){return F6.waitingAction}})});var B0=p(Ph=>{"use strict";Object.defineProperty(Ph,"__esModule",{value:!0});Ph.sleepingAction=void 0;var V6=ae();function P0(t){return t.sharedData}function k0(t){let e=t.player,r={turnsPassed:1},n={},i="slept",o=!0,a=t.world.getLocation?.(e.id);if(a){let c=t.world.getEntity(a);c&&(r.location=c.id,r.locationName=c.name)}return{canSleep:o,messageId:i,eventData:r,params:n,wakeRefreshed:!1}}Ph.sleepingAction={id:V6.IFActions.SLEEPING,requiredMessages:["slept","dozed_off","fell_asleep","brief_nap","deep_sleep","slept_fitfully","cant_sleep_here","too_dangerous_to_sleep","already_well_rested","woke_refreshed","disturbed_sleep","nightmares","peaceful_sleep"],validate(t){let e=k0(t);return e.canSleep?{valid:!0}:{valid:!1,error:e.messageId,params:e.params}},execute(t){let e=k0(t),r=P0(t);r.messageId=e.messageId,r.eventData=e.eventData,r.params=e.params,r.wakeRefreshed=e.wakeRefreshed},blocked(t,e){return[t.event("if.event.sleep_blocked",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:e.params,reason:e.error})]},report(t){let e=[],r=P0(t);return e.push(t.event("if.event.slept",{messageId:`${t.action.id}.${r.messageId||"slept"}`,params:r.params,...r.eventData})),r.wakeRefreshed&&e.push(t.event("if.event.slept",{messageId:`${t.action.id}.woke_refreshed`,wakeRefreshed:!0})),e},group:"meta",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1}}});var PS=p(kh=>{"use strict";Object.defineProperty(kh,"__esModule",{value:!0});kh.sleepingAction=void 0;var Y6=B0();Object.defineProperty(kh,"sleepingAction",{enumerable:!0,get:function(){return Y6.sleepingAction}})});var j0=p(Bh=>{"use strict";Object.defineProperty(Bh,"__esModule",{value:!0});Bh.scoringAction=void 0;var z6=E(),K6=ae();function x0(t){return t.sharedData}function $6(t,e){if(e===0)return"Beginner";let r=t/e*100;return r>=90?"Master":r>=75?"Expert":r>=50?"Proficient":r>=25?"Amateur":"Novice"}Bh.scoringAction={id:K6.IFActions.SCORING,requiredMessages:["no_scoring","score_display","score_simple","score_with_rank","perfect_score","with_achievements","early_game","mid_game","late_game","game_complete"],validate(t){return{valid:!0}},execute(t){let e=x0(t),r=t.world.getCapability(z6.StandardCapabilities.SCORING);if(r?.enabled===!1){e.enabled=!1;return}e.enabled=!0;let n=t.world.getScore(),i=t.world.getMaxScore(),o=r?.moves||0,a=r?.achievements||[],s=r?.rank||$6(n,i),c={score:n,maxScore:i,moves:o},d={score:n,maxScore:i,moves:o,rank:s},u="score_simple";if(i>0){let f=Math.round(n/i*100);c.percentage=f,d.percentage=f,c.rank=s,n===i?u="perfect_score":u="score_with_rank"}else o>0&&(u="score_display");a.length>0&&(c.achievements=a,d.achievements=a.join(", "));let m;if(i>0){let f=n/i*100;f===100?m="game_complete":f>=75?m="late_game":f>=25?m="mid_game":m="early_game",c.progress=m}e.eventData=c,e.params=d,e.messageId=u,e.achievements=a,e.progressMessage=m},blocked(t,e){return[t.event("if.event.score_displayed",{messageId:`if.action.scoring.${e.error}`,params:e.params||{},blocked:!0,reason:e.error})]},report(t){let e=x0(t);if(!e.enabled)return[t.event("if.event.score_displayed",{messageId:"if.action.scoring.no_scoring",params:{},enabled:!1})];if(!e.eventData)return[];let r=`if.action.scoring.${e.messageId||"score_simple"}`;return[t.event("if.event.score_displayed",{messageId:r,params:e.params||{},...e.eventData,hasAchievements:e.achievements&&e.achievements.length>0,achievements:e.achievements,progressMessage:e.progressMessage})]},group:"meta",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1}}});var kS=p(xh=>{"use strict";Object.defineProperty(xh,"__esModule",{value:!0});xh.scoringAction=void 0;var Q6=j0();Object.defineProperty(xh,"scoringAction",{enumerable:!0,get:function(){return Q6.scoringAction}})});var U0=p(jh=>{"use strict";Object.defineProperty(jh,"__esModule",{value:!0});jh.helpAction=void 0;var X6=ae();function W0(t){return t.sharedData}function Z6(t){let e={},r=t.command.parsed.extras?.topic||t.command.indirectObject?.parsed.text||t.command.directObject?.parsed.text||null;if(r)e.specificHelp=!0,e.helpRequest=r;else{e.generalHelp=!0,e.helpType="general";let n=t.world.getSharedData?.()||{};n.helpRequested||(e.firstTime=!0);let o=n.helpSections||["basic_commands","movement","objects","special_commands"];e.sections=o;let a=n.hintsEnabled??!0;e.hintsAvailable=a}return{topic:r,eventData:e}}jh.helpAction={id:X6.IFActions.HELP,group:"meta",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1},requiredMessages:["general_help","help_topic","unknown_topic","help_movement","help_objects","help_special","first_time_help","hints_available","hints_disabled","stuck_help","help_footer"],validate(t){return{valid:!0}},execute(t){let e=Z6(t),r=W0(t);r.eventData=e.eventData},blocked(t,e){return[t.event("if.event.help_displayed",{messageId:`if.action.help.${e.error}`,params:e.params||{},blocked:!0,reason:e.error})]},report(t){let e=W0(t);if(e.eventData){let r="if.action.help.general";return e.eventData.specificHelp?r="if.action.help.topic":e.eventData.firstTime&&(r="if.action.help.first_time"),[t.event("if.event.help_displayed",{messageId:r,params:{topic:e.eventData.helpRequest,sections:e.eventData.sections,hintsAvailable:e.eventData.hintsAvailable},...e.eventData})]}return[]}}});var BS=p(Wh=>{"use strict";Object.defineProperty(Wh,"__esModule",{value:!0});Wh.helpAction=void 0;var J6=U0();Object.defineProperty(Wh,"helpAction",{enumerable:!0,get:function(){return J6.helpAction}})});var H0=p(Uh=>{"use strict";Object.defineProperty(Uh,"__esModule",{value:!0});Uh.aboutAction=void 0;var eZ=ae();Uh.aboutAction={id:eZ.IFActions.ABOUT,validate(t){return{valid:!0}},execute(t){},blocked(t,e){return[t.event("if.event.about_displayed",{messageId:`if.action.about.${e.error}`,params:e.params||{},blocked:!0,reason:e.error})]},report(t){let e=t.world,i=e.findByTrait("storyInfo")[0]?.get("storyInfo")||e.storyConfig||{},o={messageId:"if.action.about.success",params:{title:i.title||"Unknown",author:Array.isArray(i.author)?i.author.join(", "):i.author||"Unknown",version:i.version||"0.0.0",description:i.description||"",engineVersion:i.engineVersion||"",buildDate:i.buildDate||"",clientVersion:i.clientVersion||"",portedBy:i.portedBy||""}};return[t.event("if.event.about_displayed",o)]},group:"meta",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1}}});var xS=p(Hh=>{"use strict";Object.defineProperty(Hh,"__esModule",{value:!0});Hh.aboutAction=void 0;var tZ=H0();Object.defineProperty(Hh,"aboutAction",{enumerable:!0,get:function(){return tZ.aboutAction}})});var q0=p(Cc=>{"use strict";Object.defineProperty(Cc,"__esModule",{value:!0});Cc.versionAction=Cc.ENGINE_VERSION=void 0;var rZ=ae();Cc.ENGINE_VERSION="0.9.43-beta.1";Cc.versionAction={id:rZ.IFActions.VERSION,validate(t){return{valid:!0}},execute(t){},blocked(t,e){return[t.event("if.event.version_displayed",{messageId:`if.action.version.${e.error}`,params:e.params||{},blocked:!0,reason:e.error})]},report(t){let e=t.world,n=e.findByTrait("storyInfo")[0]?.get("storyInfo"),i=n||e.storyConfig||{},o=n||e.versionInfo||{},a=i.title||"Unknown",s=o.version||i.version||"0.0.0",c=o.engineVersion||Cc.ENGINE_VERSION,d=o.clientVersion||e.clientVersion||"N/A",u=o.buildDate,m=i.author||"Unknown",g={messageId:u?"if.action.version.version_full":"if.action.version.version_no_date",params:{storyTitle:a,storyVersion:s,engineVersion:c,clientVersion:d,buildDate:u,title:a,version:s,author:Array.isArray(m)?m.join(", "):m},storyTitle:a,storyVersion:s,engineVersion:c,clientVersion:d,buildDate:u};return[t.event("if.event.version_displayed",g)]},group:"meta",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1}}});var jS=p(dl=>{"use strict";Object.defineProperty(dl,"__esModule",{value:!0});dl.ENGINE_VERSION=dl.versionAction=void 0;var G0=q0();Object.defineProperty(dl,"versionAction",{enumerable:!0,get:function(){return G0.versionAction}});Object.defineProperty(dl,"ENGINE_VERSION",{enumerable:!0,get:function(){return G0.ENGINE_VERSION}})});var F0=p(qh=>{"use strict";Object.defineProperty(qh,"__esModule",{value:!0});qh.StandardWitnessSystem=void 0;var nZ=E(),iZ=Ve(),ur=we(),WS=class{constructor(e,r){l(this,"world");l(this,"scopeResolver");l(this,"knowledge",new Map);this.world=e,this.scopeResolver=r}recordWitnesses(e){let r=new Map,n=this.world.getAllEntities().filter(o=>o.has(nZ.TraitType.ACTOR)&&o.id!==e.actorId);for(let o of n){let a=this.canWitnessChange(o,e);a&&r.set(o.id,a)}let i={change:e,witnesses:r};return this.updateKnowledge(i),i}updateKnowledge(e){for(let[r,n]of e.witnesses){this.knowledge.has(r)||this.knowledge.set(r,new Map);let i=this.knowledge.get(r);switch(e.change.type){case"move":this.updateMovementKnowledge(r,e.change,n);break;case"create":this.updateDiscoveryKnowledge(r,e.change,n);break;case"destroy":this.updateDestructionKnowledge(r,e.change,n);break;case"modify":this.updateModificationKnowledge(r,e.change,n);break;case"action":this.updateActionKnowledge(r,e.change,n);break}this.emitWitnessEvent(r,e.change,n)}}getKnownEntities(e){let r=this.knowledge.get(e);return r?Array.from(r.values()):[]}hasDiscovered(e,r){let n=this.knowledge.get(e);return n?n.get(r)?.exists===!0:!1}getKnowledge(e,r){let n=this.knowledge.get(e);if(n)return n.get(r)}canWitnessChange(e,r){let n=this.world.getEntity(r.entityId);return n?this.scopeResolver.canSee(e,n)?{actorId:e.id,sense:ur.SenseType.SIGHT,level:this.determineWitnessLevel(e,n,ur.SenseType.SIGHT),confidence:"certain"}:this.scopeResolver.canHear(e,n)?{actorId:e.id,sense:ur.SenseType.HEARING,level:this.determineWitnessLevel(e,n,ur.SenseType.HEARING),confidence:"likely"}:this.scopeResolver.canSmell(e,n)?{actorId:e.id,sense:ur.SenseType.SMELL,level:this.determineWitnessLevel(e,n,ur.SenseType.SMELL),confidence:"unsure"}:null:null}determineWitnessLevel(e,r,n){return n===ur.SenseType.SIGHT&&this.scopeResolver.canReach(e,r)?ur.WitnessLevel.FULL:ur.WitnessLevel.PARTIAL}updateMovementKnowledge(e,r,n){let i=this.knowledge.get(e),o=i.get(r.entityId);o||(o=this.createInitialKnowledge(r.entityId,n),i.set(r.entityId,o)),r.to&&(o.lastKnownLocation=r.to),r.from&&r.to&&(o.movementHistory||(o.movementHistory=[]),o.movementHistory.push({from:r.from,to:r.to,witnessedAt:r.timestamp,witnessedBy:n.sense,confidence:n.confidence}),o.movementHistory.length>10&&o.movementHistory.shift()),this.updateSenseTimestamps(o,n,r.timestamp)}updateDiscoveryKnowledge(e,r,n){let i=this.knowledge.get(e),o=this.createInitialKnowledge(r.entityId,n);o.exists=!0,o.discoveredAt=r.timestamp,o.discoveredBy=n.sense,i.set(r.entityId,o)}updateDestructionKnowledge(e,r,n){let o=this.knowledge.get(e).get(r.entityId);o&&(o.exists=!1,this.updateSenseTimestamps(o,n,r.timestamp))}updateModificationKnowledge(e,r,n){let i=this.knowledge.get(e),o=i.get(r.entityId);o||(o=this.createInitialKnowledge(r.entityId,n),i.set(r.entityId,o)),n.sense===ur.SenseType.SIGHT&&r.property&&(o.visualProperties||(o.visualProperties=new Map),o.visualProperties.set(r.property,r.newValue)),this.updateSenseTimestamps(o,n,r.timestamp)}updateActionKnowledge(e,r,n){let i=this.knowledge.get(e);if(r.actorId&&r.actorId!==e){let o=i.get(r.actorId);o||(o=this.createInitialKnowledge(r.actorId,n),i.set(r.actorId,o)),this.updateSenseTimestamps(o,n,r.timestamp)}if(r.target){let o=i.get(r.target);o||(o=this.createInitialKnowledge(r.target,n),i.set(r.target,o)),this.updateSenseTimestamps(o,n,r.timestamp)}}createInitialKnowledge(e,r){return{entityId:e,exists:!0,discoveredAt:Date.now(),discoveredBy:r.sense}}updateSenseTimestamps(e,r,n){switch(r.sense){case ur.SenseType.SIGHT:e.lastSeen=n;break;case ur.SenseType.HEARING:e.lastHeard=n;break;case ur.SenseType.SMELL:e.lastSmelled=n,e.scentStrength="moderate";break}}emitWitnessEvent(e,r,n){let i=this.world.getEntity(e);if(!i)return;let o=null;switch(r.type){case"action":o={type:"if.witness.action",data:{witnessId:e,sense:n.sense,level:n.level,action:r.action||"",actorId:r.actorId||"",targetId:r.target,fromLocation:r.from,toLocation:r.to,timestamp:r.timestamp}};break;case"move":o={type:"if.witness.movement",data:{witnessId:e,sense:n.sense,level:n.level,entityId:n.level===ur.WitnessLevel.FULL?r.entityId:"unknown",fromLocation:r.from||"",toLocation:r.to||"",direction:this.getDirection(r.from,r.to),timestamp:r.timestamp}};break}if(o){let a={actor:i.id};r.entityId&&(a.target=r.entityId),r.target&&(a.target=r.target),(0,iZ.createEvent)(o.type,o.data,a)}}getDirection(e,r){}};qh.StandardWitnessSystem=WS});var Gi=p(zo=>{"use strict";var oZ=zo&&zo.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),US=zo&&zo.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&oZ(e,t,r)};Object.defineProperty(zo,"__esModule",{value:!0});US(we(),zo);US(Wu(),zo);US(F0(),zo)});var HS=p(ii=>{"use strict";Object.defineProperty(ii,"__esModule",{value:!0});ii.LOCK_MESSAGES=void 0;ii.analyzeLockContext=aZ;ii.validateKeyRequirements=sZ;ii.createLockErrorEvent=cZ;ii.determineLockMessage=dZ;var ll=E();ii.LOCK_MESSAGES={NO_KEY:"no_key",KEY_NOT_HELD:"key_not_held",WRONG_KEY:"wrong_key"};function aZ(t,e,r){let n=t.player,i=ll.LockableBehavior.requiresKey(e),o=!1;return r&&(o=t.world.getLocation(r.id)===n.id),{target:e,key:r,isContainer:e.has(ll.TraitType.CONTAINER),isDoor:e.has(ll.TraitType.DOOR),requiresKey:i,keyHeld:o}}function sZ(t,e,r,n){if(!ll.LockableBehavior.requiresKey(e))return null;if(!r)return{valid:!1,error:ii.LOCK_MESSAGES.NO_KEY};let i=t.player;return t.world.getLocation(r.id)!==i.id?{valid:!1,error:ii.LOCK_MESSAGES.KEY_NOT_HELD,params:{key:r.name}}:(n?ll.LockableBehavior.canLockWith(e,r.id):ll.LockableBehavior.canUnlockWith(e,r.id))?null:{valid:!1,error:ii.LOCK_MESSAGES.WRONG_KEY,params:{key:r.name,item:e.name}}}function cZ(t,e,r,n,i){let o=t.action.id;if(i){if(e.alreadyLocked)return t.event("action.error",{actionId:o,messageId:"already_locked",reason:"already_locked",params:{item:r.name}});if(e.notClosed)return t.event("action.error",{actionId:o,messageId:"not_closed",reason:"not_closed",params:{item:r.name}})}else if(e.alreadyUnlocked)return t.event("action.error",{actionId:o,messageId:"already_unlocked",reason:"already_unlocked",params:{item:r.name}});return e.noKey?t.event("action.error",{actionId:o,messageId:"no_key",reason:"no_key"}):e.wrongKey?t.event("action.error",{actionId:o,messageId:"wrong_key",reason:"wrong_key",params:{key:n?.name||"key",item:r.name}}):t.event("action.error",{actionId:o,messageId:i?"cannot_lock":"cannot_unlock",reason:i?"cannot_lock":"cannot_unlock",params:{item:r.name}})}function dZ(t,e){return t?e?"locked_with":"locked":e?"unlocked_with":"unlocked"}});var V0=p(Gh=>{"use strict";Object.defineProperty(Gh,"__esModule",{value:!0});Gh.MESSAGES=void 0;Gh.MESSAGES={NO_TARGET:"no_target",NOT_LOCKABLE:"not_lockable",NO_KEY:"no_key",WRONG_KEY:"wrong_key",ALREADY_LOCKED:"already_locked",NOT_CLOSED:"not_closed",CANT_REACH:"cant_reach",KEY_NOT_HELD:"key_not_held",LOCKED:"locked",LOCKED_WITH:"locked_with"}});var z0=p(Yh=>{"use strict";Object.defineProperty(Yh,"__esModule",{value:!0});Yh.lockingAction=void 0;var ul=E(),lZ=ae(),Fh=Gi(),qS=HS(),Vh=V0();function Y0(t){return t.sharedData}Yh.lockingAction={id:lZ.IFActions.LOCKING,defaultScope:{target:Fh.ScopeLevel.REACHABLE,key:Fh.ScopeLevel.CARRIED},requiredMessages:["no_target","not_lockable","no_key","wrong_key","already_locked","not_closed","locked","locked_with","cant_reach","key_not_held"],group:"lock_manipulation",validate(t){let e=t.command.directObject?.entity,r=t.command.instrument?.entity??t.command.indirectObject?.entity;if(!e)return{valid:!1,error:Vh.MESSAGES.NO_TARGET};let n=t.requireScope(e,Fh.ScopeLevel.REACHABLE);if(!n.ok)return n.error;if(!e.has(ul.TraitType.LOCKABLE))return{valid:!1,error:Vh.MESSAGES.NOT_LOCKABLE,params:{item:e.name}};if(!ul.LockableBehavior.canLock(e)){if(ul.LockableBehavior.isLocked(e))return{valid:!1,error:Vh.MESSAGES.ALREADY_LOCKED,params:{item:e.name}};if(e.has(ul.TraitType.OPENABLE)&&ul.OpenableBehavior.isOpen(e))return{valid:!1,error:Vh.MESSAGES.NOT_CLOSED,params:{item:e.name}}}let i=(0,qS.validateKeyRequirements)(t,e,r,!0);return i||{valid:!0}},execute(t){let e=t.command.directObject.entity,r=t.command.instrument?.entity??t.command.indirectObject?.entity,n=Y0(t),i=(0,qS.analyzeLockContext)(t,e,r),o=ul.LockableBehavior.lock(e,r);if(n.targetId=e.id,n.targetName=e.name,!o.success){n.failed=!0,o.wrongKey?n.errorMessageId="wrong_key":o.noKey?n.errorMessageId="no_key":o.alreadyLocked?n.errorMessageId="already_locked":n.errorMessageId="cant_lock";return}n.failed=!1,i.isContainer&&(n.isContainer=!0),i.isDoor&&(n.isDoor=!0),r&&(n.keyId=r.id,n.keyName=r.name),o.lockSound&&(n.sound=o.lockSound),n.messageId=(0,qS.determineLockMessage)(!0,!!r),n.params={item:e.name},i.isContainer&&(n.params.isContainer=!0),i.isDoor&&(n.params.isDoor=!0),r&&(n.params.key=r.name)},report(t){let e=Y0(t);return e.failed?[t.event("if.event.lock_blocked",{messageId:`${t.action.id}.${e.errorMessageId}`,params:{item:e.targetName},targetId:e.targetId,targetName:e.targetName,reason:e.errorMessageId})]:[t.event("if.event.locked",{messageId:`${t.action.id}.${e.messageId}`,params:e.params,targetId:e.targetId,targetName:e.targetName,actorId:t.player.id,isContainer:e.isContainer,isDoor:e.isDoor,keyId:e.keyId,keyName:e.keyName,sound:e.sound})]},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.lock_blocked",{messageId:`${t.action.id}.${e.error}`,params:e.params||{},targetId:r?.id,targetName:r?.name,reason:e.error})]},metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:Fh.ScopeLevel.REACHABLE}}});var GS=p(zh=>{"use strict";Object.defineProperty(zh,"__esModule",{value:!0});zh.lockingAction=void 0;var uZ=z0();Object.defineProperty(zh,"lockingAction",{enumerable:!0,get:function(){return uZ.lockingAction}})});var K0=p(Kh=>{"use strict";Object.defineProperty(Kh,"__esModule",{value:!0});Kh.MESSAGES=void 0;Kh.MESSAGES={NO_TARGET:"no_target",NOT_LOCKABLE:"not_lockable",NO_KEY:"no_key",WRONG_KEY:"wrong_key",ALREADY_UNLOCKED:"already_unlocked",CANT_REACH:"cant_reach",KEY_NOT_HELD:"key_not_held",UNLOCKED:"unlocked",UNLOCKED_WITH:"unlocked_with"}});var Q0=p(Qh=>{"use strict";Object.defineProperty(Qh,"__esModule",{value:!0});Qh.unlockingAction=void 0;var zu=E(),mZ=ae(),$h=Gi(),FS=HS(),VS=K0();function $0(t){return t.sharedData}Qh.unlockingAction={id:mZ.IFActions.UNLOCKING,defaultScope:{target:$h.ScopeLevel.REACHABLE,key:$h.ScopeLevel.CARRIED},requiredMessages:["no_target","not_lockable","no_key","wrong_key","already_unlocked","unlocked","unlocked_with","cant_reach","key_not_held","still_locked"],group:"lock_manipulation",validate(t){let e=t.command.directObject?.entity,r=t.command.instrument?.entity??t.command.indirectObject?.entity;if(!e)return{valid:!1,error:VS.MESSAGES.NO_TARGET};let n=t.requireScope(e,$h.ScopeLevel.REACHABLE);if(!n.ok)return n.error;if(!e.has(zu.TraitType.LOCKABLE))return{valid:!1,error:VS.MESSAGES.NOT_LOCKABLE,params:{item:e.name}};if(!zu.LockableBehavior.canUnlock(e))return{valid:!1,error:VS.MESSAGES.ALREADY_UNLOCKED,params:{item:e.name}};let i=(0,FS.validateKeyRequirements)(t,e,r,!1);return i||{valid:!0}},execute(t){let e=t.command.directObject.entity,r=t.command.instrument?.entity??t.command.indirectObject?.entity,n=$0(t),i=(0,FS.analyzeLockContext)(t,e,r),o=zu.LockableBehavior.unlock(e,r);if(n.targetId=e.id,n.targetName=e.name,!o.success){n.failed=!0,o.wrongKey?n.errorMessageId="wrong_key":o.noKey?n.errorMessageId="no_key":n.errorMessageId="cant_unlock";return}if(n.failed=!1,i.isContainer){n.isContainer=!0;let a=t.world.getContents(e.id);n.hasContents=a.length>0,n.contentsCount=a.length,n.contentsIds=a.map(s=>s.id)}i.isDoor&&(n.isDoor=!0),r&&(n.keyId=r.id,n.keyName=r.name),o.unlockSound&&(n.sound=o.unlockSound),e.has(zu.TraitType.OPENABLE)&&e.get(zu.TraitType.OPENABLE).autoOpenOnUnlock&&(n.willAutoOpen=!0),n.messageId=(0,FS.determineLockMessage)(!1,!!r),n.params={item:e.name},i.isContainer&&(n.params.isContainer=!0,n.params.hasContents=n.hasContents),i.isDoor&&(n.params.isDoor=!0),r&&(n.params.key=r.name),n.willAutoOpen&&(n.params.willAutoOpen=!0),n.sound&&(n.params.sound=n.sound)},report(t){let e=$0(t);return e.failed?[t.event("if.event.unlock_blocked",{messageId:`${t.action.id}.${e.errorMessageId}`,params:{item:e.targetName},targetId:e.targetId,targetName:e.targetName,reason:e.errorMessageId})]:[t.event("if.event.unlocked",{messageId:`${t.action.id}.${e.messageId}`,params:e.params,targetId:e.targetId,targetName:e.targetName,containerId:e.targetId,containerName:e.targetName,actorId:t.player.id,isContainer:e.isContainer,isDoor:e.isDoor,keyId:e.keyId,keyName:e.keyName,sound:e.sound,willAutoOpen:e.willAutoOpen,hasContents:e.hasContents,contentsCount:e.contentsCount,contentsIds:e.contentsIds})]},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.unlock_blocked",{messageId:`${t.action.id}.${e.error}`,params:e.params||{},targetId:r?.id,targetName:r?.name,reason:e.error})]},metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:$h.ScopeLevel.REACHABLE}}});var YS=p(Xh=>{"use strict";Object.defineProperty(Xh,"__esModule",{value:!0});Xh.unlockingAction=void 0;var pZ=Q0();Object.defineProperty(Xh,"unlockingAction",{enumerable:!0,get:function(){return pZ.unlockingAction}})});var zS=p(Zh=>{"use strict";Object.defineProperty(Zh,"__esModule",{value:!0});Zh.analyzeSwitchingContext=fZ;Zh.determineSwitchingMessage=gZ;var ys=E();function fZ(t,e){let r=t.player,n={target:e,isLightSource:e.has(ys.TraitType.LIGHT_SOURCE),otherLightsPresent:!1,isInSameRoom:!1};if(n.isLightSource){let a=e.get(ys.TraitType.LIGHT_SOURCE);n.lightRadius=a.radius||1,n.lightIntensity=a.intensity||"normal"}let i=t.world.getContainingRoom(r.id),o=t.world.getContainingRoom(e.id);if(i&&o&&i.id===o.id&&(n.isInSameRoom=!0,n.isLightSource)){let s=t.world.getContents(i.id).filter(u=>u.id!==e.id&&u.has(ys.TraitType.LIGHT_SOURCE)&&u.has(ys.TraitType.SWITCHABLE)&&u.get(ys.TraitType.SWITCHABLE).isOn),d=t.world.getContents(r.id).filter(u=>u.id!==e.id&&u.has(ys.TraitType.LIGHT_SOURCE)&&u.has(ys.TraitType.SWITCHABLE)&&u.get(ys.TraitType.SWITCHABLE).isOn);n.otherLightsPresent=s.length>0||d.length>0,n.willAffectDarkness=!n.otherLightsPresent}return n}function gZ(t,e,r,n,i,o){return o?t?"door_opens":"door_closes":n?t?"temporary_activation":"was_temporary":r?"with_sound":e.isLightSource&&e.isInSameRoom?t?e.willAffectDarkness?"illuminates_darkness":"light_on":e.willAffectDarkness?"light_off":"light_off_still_lit":!t&&i?"silence_falls":e.isLightSource?t?"switched_on":"switched_off":t?"device_humming":"device_stops"}});var X0=p(Jh=>{"use strict";Object.defineProperty(Jh,"__esModule",{value:!0});Jh.MESSAGES=void 0;Jh.MESSAGES={NO_TARGET:"no_target",NOT_SWITCHABLE:"not_switchable",ALREADY_ON:"already_on",NO_POWER:"no_power",SWITCHED_ON:"switched_on",LIGHT_ON:"light_on",DEVICE_HUMMING:"device_humming",TEMPORARY_ACTIVATION:"temporary_activation",WITH_SOUND:"with_sound",DOOR_OPENS:"door_opens",ILLUMINATES_DARKNESS:"illuminates_darkness"}});var tj=p(ry=>{"use strict";Object.defineProperty(ry,"__esModule",{value:!0});ry.switchingOnAction=void 0;var oi=E(),Z0=ae(),KS=Gi(),J0=zS(),ey=X0(),ej=Hi();function ty(t){return t.sharedData}ry.switchingOnAction={id:Z0.IFActions.SWITCHING_ON,defaultScope:{target:KS.ScopeLevel.REACHABLE},requiredMessages:["no_target","not_visible","not_reachable","not_switchable","already_on","no_power","switched_on","light_on","device_humming","temporary_activation","with_sound","door_opens","illuminates_darkness"],validate(t){let e=t.command.directObject?.entity,r=ty(t);if(!e)return{valid:!1,error:ey.MESSAGES.NO_TARGET};let i=(0,oi.getInterceptorForAction)(e,Z0.IFActions.SWITCHING_ON)?.interceptor,o={};if(r.interceptor=i,r.interceptorData=o,i?.preValidate){let s=i.preValidate(e,t.world,t.player.id,o);if(s!==null)return{valid:s.valid,error:s.error,params:s.params}}let a=t.requireScope(e,KS.ScopeLevel.REACHABLE);if(!a.ok)return a.error;if(!e.has(oi.TraitType.SWITCHABLE))return{valid:!1,error:ey.MESSAGES.NOT_SWITCHABLE,params:{target:e.name}};if(!oi.SwitchableBehavior.canSwitchOn(e)){let s=e.get(oi.TraitType.SWITCHABLE);if(s.isOn)return{valid:!1,error:ey.MESSAGES.ALREADY_ON,params:{target:e.name}};if(s.requiresPower&&!s.hasPower)return{valid:!1,error:ey.MESSAGES.NO_POWER,params:{target:e.name}}}if(i?.postValidate){let s=i.postValidate(e,t.world,t.player.id,o);if(s!==null)return{valid:s.valid,error:s.error,params:s.params}}return{valid:!0}},execute(t){let e=t.command.directObject.entity,r=ty(t);r.targetId=e.id,r.targetName=e.name;let n=t.world.getContainingRoom(t.player.id),i=n?oi.VisibilityBehavior.isDark(n,t.world):!1;r.wasDarkBefore=i;let o=oi.SwitchableBehavior.switchOn(e);if(e.has(oi.TraitType.LIGHT_SOURCE)&&oi.LightSourceBehavior.light(e),!o.success){r.failed=!0,o.wasOn?r.errorMessageId="already_on":o.noPower?r.errorMessageId="no_power":r.errorMessageId="not_switchable";return}r.failed=!1;let a=(0,J0.analyzeSwitchingContext)(t,e);if(r.params={target:e.name},a.isLightSource&&(r.isLightSource=!0,r.lightRadius=a.lightRadius,r.lightIntensity=a.lightIntensity,a.isInSameRoom&&a.willAffectDarkness&&(r.willIlluminateLocation=!0)),r.willIlluminateLocation&&r.wasDarkBefore){let u=t.world.getContainingRoom(t.player.id);if(u){r.roomSnapshot=(0,ej.captureRoomSnapshot)(u,t.world,!1);let m=t.world.getContents(u.id).filter(f=>f.id!==t.player.id);r.visibleSnapshots=(0,ej.captureEntitySnapshots)(m,t.world)}}o.autoOffTime&&o.autoOffTime>0&&(r.autoOffTime=o.autoOffTime,r.temporary=!0),o.powerConsumption&&(r.powerConsumption=o.powerConsumption),o.runningSound&&(r.continuousSound=o.runningSound),o.onSound&&(r.sound=o.onSound,r.params.sound=o.onSound);let s=!1;e.has(oi.TraitType.CONTAINER)&&e.has(oi.TraitType.OPENABLE)&&(e.get(oi.TraitType.OPENABLE).isOpen||(r.willOpen=!0,s=!0)),r.messageId=(0,J0.determineSwitchingMessage)(!0,a,o.onSound,!!(o.autoOffTime&&o.autoOffTime>0),void 0,s);let c=r.interceptor,d=r.interceptorData||{};c?.postExecute&&c.postExecute(e,t.world,t.player.id,d)},report(t){let e=ty(t);if(e.failed)return[t.event("if.event.switch_on_blocked",{messageId:`${t.action.id}.${e.errorMessageId}`,params:{target:e.targetName},targetId:e.targetId,targetName:e.targetName,reason:e.errorMessageId})];let r=[t.event("if.event.switched_on",{messageId:`${t.action.id}.${e.messageId}`,params:e.params,target:e.targetId,targetName:e.targetName,actorId:t.player.id,isLightSource:e.isLightSource,lightRadius:e.lightRadius,lightIntensity:e.lightIntensity,willIlluminateLocation:e.willIlluminateLocation,temporary:e.temporary,autoOffTime:e.autoOffTime,powerConsumption:e.powerConsumption,continuousSound:e.continuousSound,sound:e.sound,willOpen:e.willOpen})];if(e.willIlluminateLocation&&e.wasDarkBefore&&e.roomSnapshot){let o=e.roomSnapshot,a=t.world.getContents(o.id).filter(s=>s.id!==t.player.id);if(r.push(t.event("if.event.room.description",{room:o,visibleItems:e.visibleSnapshots||[],roomId:o.id,roomName:o.name,roomDescription:o.description,includeContents:!0,verbose:!0})),r.push(t.event("action.success",{actionId:"if.action.looking",messageId:"room_description",params:{name:o.name,description:o.description}})),a.length>0){let s=a.map(c=>c.name).join(", ");r.push(t.event("action.success",{actionId:"if.action.looking",messageId:"contents_list",params:{items:s,count:a.length}}))}}let n=e.interceptor,i=e.interceptorData||{};if(n?.postReport){let o=t.command.directObject?.entity;if(o){let a=n.postReport(o,t.world,t.player.id,i);for(let s of a)r.push(t.event(s.type,s.payload))}}return r},blocked(t,e){let r=t.command.directObject?.entity,n=ty(t),i=n.interceptor,o=n.interceptorData||{};if(i?.onBlocked&&r&&e.error){let a=i.onBlocked(r,t.world,t.player.id,e.error,o);if(a!==null)return a.map(s=>t.event(s.type,s.payload))}return[t.event("if.event.switch_on_blocked",{messageId:`${t.action.id}.${e.error}`,params:e.params||{},targetId:r?.id,targetName:r?.name,reason:e.error})]},group:"device_manipulation",metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:KS.ScopeLevel.REACHABLE}}});var $S=p(ny=>{"use strict";Object.defineProperty(ny,"__esModule",{value:!0});ny.switchingOnAction=void 0;var hZ=tj();Object.defineProperty(ny,"switchingOnAction",{enumerable:!0,get:function(){return hZ.switchingOnAction}})});var rj=p(iy=>{"use strict";Object.defineProperty(iy,"__esModule",{value:!0});iy.MESSAGES=void 0;iy.MESSAGES={NO_TARGET:"no_target",NOT_SWITCHABLE:"not_switchable",ALREADY_OFF:"already_off",SWITCHED_OFF:"switched_off",LIGHT_OFF:"light_off",LIGHT_OFF_STILL_LIT:"light_off_still_lit",DEVICE_STOPS:"device_stops",SILENCE_FALLS:"silence_falls",WITH_SOUND:"with_sound",DOOR_CLOSES:"door_closes",WAS_TEMPORARY:"was_temporary"}});var oj=p(oy=>{"use strict";Object.defineProperty(oy,"__esModule",{value:!0});oy.switchingOffAction=void 0;var Ko=E(),yZ=ae(),QS=Gi(),nj=zS(),XS=rj();function ij(t){return t.sharedData}oy.switchingOffAction={id:yZ.IFActions.SWITCHING_OFF,defaultScope:{target:QS.ScopeLevel.REACHABLE},requiredMessages:["no_target","not_visible","not_reachable","not_switchable","already_off","switched_off","light_off","light_off_still_lit","device_stops","silence_falls","with_sound","door_closes","was_temporary"],validate(t){let e=t.command.directObject?.entity;if(!e)return{valid:!1,error:XS.MESSAGES.NO_TARGET};let r=t.requireScope(e,QS.ScopeLevel.REACHABLE);return r.ok?e.has(Ko.TraitType.SWITCHABLE)?Ko.SwitchableBehavior.canSwitchOff(e)?{valid:!0}:{valid:!1,error:XS.MESSAGES.ALREADY_OFF,params:{target:e.name}}:{valid:!1,error:XS.MESSAGES.NOT_SWITCHABLE,params:{target:e.name}}:r.error},execute(t){let e=t.command.directObject.entity,r=ij(t);r.targetId=e.id,r.targetName=e.name;let i=e.get(Ko.TraitType.SWITCHABLE),o=i.autoOffCounter>0,a=i.autoOffCounter,s=i.runningSound,c=i.powerConsumption,d=Ko.SwitchableBehavior.switchOff(e);if(e.has(Ko.TraitType.LIGHT_SOURCE)&&Ko.LightSourceBehavior.extinguish(e),!d.success){r.failed=!0,d.wasOff?r.errorMessageId="already_off":r.errorMessageId="not_switchable";return}r.failed=!1;let u=(0,nj.analyzeSwitchingContext)(t,e);r.params={target:e.name},u.isLightSource&&(r.isLightSource=!0,u.isInSameRoom&&u.willAffectDarkness&&(r.willDarkenLocation=!0)),o&&(r.wasTemporary=!0,r.remainingTime=a,r.params.remainingTime=a),c&&(r.powerFreed=c),d.offSound?(r.sound=d.offSound,r.params.sound=d.offSound):s&&(r.stoppedSound=s);let m=!1;if(e.has(Ko.TraitType.CONTAINER)&&e.has(Ko.TraitType.OPENABLE)){let f=e.get(Ko.TraitType.OPENABLE);f.isOpen&&f.autoCloseOnOff&&(r.willClose=!0,m=!0)}r.messageId=(0,nj.determineSwitchingMessage)(!1,u,d.offSound,o,s,m)},report(t){let e=ij(t);return e.failed?[t.event("if.event.switch_off_blocked",{messageId:`${t.action.id}.${e.errorMessageId}`,params:{target:e.targetName},targetId:e.targetId,targetName:e.targetName,reason:e.errorMessageId})]:[t.event("if.event.switched_off",{messageId:`${t.action.id}.${e.messageId}`,params:e.params,target:e.targetId,targetName:e.targetName,actorId:t.player.id,isLightSource:e.isLightSource,willDarkenLocation:e.willDarkenLocation,wasTemporary:e.wasTemporary,remainingTime:e.remainingTime,powerFreed:e.powerFreed,sound:e.sound,stoppedSound:e.stoppedSound,willClose:e.willClose})]},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.switch_off_blocked",{messageId:`${t.action.id}.${e.error}`,params:e.params||{},targetId:r?.id,targetName:r?.name,reason:e.error})]},group:"device_manipulation",metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:QS.ScopeLevel.REACHABLE}}});var ZS=p(ay=>{"use strict";Object.defineProperty(ay,"__esModule",{value:!0});ay.switchingOffAction=void 0;var TZ=oj();Object.defineProperty(ay,"switchingOffAction",{enumerable:!0,get:function(){return TZ.switchingOffAction}})});var aj=p(sy=>{"use strict";Object.defineProperty(sy,"__esModule",{value:!0});sy.EnteringMessages=void 0;sy.EnteringMessages={NO_TARGET:"no_target",NOT_ENTERABLE:"not_enterable",ALREADY_INSIDE:"already_inside",CONTAINER_CLOSED:"container_closed",TOO_FULL:"too_full",ENTERED:"entered",ENTERED_ON:"entered_on",CANT_ENTER:"cant_enter",ACTION_FAILED:"action_failed"}});var cj=p(dy=>{"use strict";Object.defineProperty(dy,"__esModule",{value:!0});dy.enteringAction=void 0;var Ku=E(),sj=ae(),wc=aj();function cy(t){return t.sharedData}var JS=we();dy.enteringAction={id:sj.IFActions.ENTERING,defaultScope:{target:JS.ScopeLevel.REACHABLE},requiredMessages:["no_target","not_enterable","already_inside","container_closed","too_full","entered","entered_on","cant_enter"],group:"movement",validate(t){let e=t.player,r=t.command.directObject?.entity,n=cy(t);if(!r)return{valid:!1,error:wc.EnteringMessages.NO_TARGET};let o=(0,Ku.getInterceptorForAction)(r,sj.IFActions.ENTERING)?.interceptor,a={};if(n.interceptor=o,n.interceptorData=a,o?.preValidate){let d=o.preValidate(r,t.world,e.id,a);if(d!==null)return{valid:d.valid,error:d.error,params:d.params}}let s=t.requireScope(r,JS.ScopeLevel.REACHABLE);if(!s.ok)return s.error;if(t.world.getLocation(e.id)===r.id)return{valid:!1,error:wc.EnteringMessages.ALREADY_INSIDE,params:{place:r.name}};if(!r.has(Ku.TraitType.ENTERABLE))return{valid:!1,error:wc.EnteringMessages.NOT_ENTERABLE,params:{place:r.name}};if(r.has(Ku.TraitType.OPENABLE)&&!Ku.OpenableBehavior.isOpen(r))return{valid:!1,error:wc.EnteringMessages.CONTAINER_CLOSED,params:{container:r.name}};if(o?.postValidate){let d=o.postValidate(r,t.world,e.id,a);if(d!==null)return{valid:d.valid,error:d.error,params:d.params}}return{valid:!0}},execute(t){let e=t.player,r=t.command.directObject.entity,n=t.world.getLocation(e.id),i=cy(t),a=r.get(Ku.TraitType.ENTERABLE).preposition;t.world.moveEntity(e.id,r.id);let s={targetId:r.id,targetName:r.name,fromLocation:n,preposition:a};i.enteringState=s;let c=i.interceptor,d=i.interceptorData||{};c?.postExecute&&c.postExecute(r,t.world,e.id,d)},report(t){let e=cy(t),r=e.enteringState;if(!r)return[t.event("if.event.entered",{messageId:`${t.action.id}.${wc.EnteringMessages.ACTION_FAILED}`,error:"Missing state from execute phase"})];let n=r.preposition==="on"?wc.EnteringMessages.ENTERED_ON:wc.EnteringMessages.ENTERED,i=[t.event("if.event.entered",{messageId:`${t.action.id}.${n}`,params:{place:r.targetName},targetId:r.targetId,targetName:r.targetName,fromLocation:r.fromLocation,preposition:r.preposition})],o=e.interceptor,a=e.interceptorData||{};if(o?.postReport){let s=t.command.directObject?.entity;if(s){let c=o.postReport(s,t.world,t.player.id,a);for(let d of c)i.push(t.event(d.type,d.payload))}}return i},blocked(t,e){let r=t.command.directObject?.entity,n=cy(t),i=n.interceptor,o=n.interceptorData||{};if(i?.onBlocked&&r&&e.error){let a=i.onBlocked(r,t.world,t.player.id,e.error,o);if(a!==null)return a.map(s=>t.event(s.type,s.payload))}return[t.event("if.event.entered",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{place:r?.name,...e.params},reason:e.error,targetId:r?.id,targetName:r?.name})]},metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:JS.ScopeLevel.REACHABLE}}});var eA=p(ly=>{"use strict";Object.defineProperty(ly,"__esModule",{value:!0});ly.enteringAction=void 0;var EZ=cj();Object.defineProperty(ly,"enteringAction",{enumerable:!0,get:function(){return EZ.enteringAction}})});var dj=p(uy=>{"use strict";Object.defineProperty(uy,"__esModule",{value:!0});uy.ExitingMessages=void 0;uy.ExitingMessages={NOWHERE_TO_GO:"nowhere_to_go",ALREADY_OUTSIDE:"already_outside",CONTAINER_CLOSED:"container_closed",CANT_EXIT:"cant_exit",EXITED:"exited",EXITED_FROM:"exited_from"}});var uj=p(my=>{"use strict";Object.defineProperty(my,"__esModule",{value:!0});my.exitingAction=void 0;var ml=E(),vZ=ae(),$u=dj();function lj(t){return t.sharedData}var _Z=we();my.exitingAction={id:vZ.IFActions.EXITING,requiredMessages:["already_outside","container_closed","cant_exit","exited","exited_from","nowhere_to_go"],group:"movement",validate(t){let e=t.player,r=t.world.getLocation(e.id);if(!r)return{valid:!1,error:$u.ExitingMessages.NOWHERE_TO_GO};let n=t.world.getEntity(r);return n?n.has(ml.TraitType.ROOM)?{valid:!1,error:$u.ExitingMessages.ALREADY_OUTSIDE}:t.world.getLocation(r)?n.has(ml.TraitType.CONTAINER)&&n.has(ml.TraitType.OPENABLE)&&!ml.OpenableBehavior.isOpen(n)?{valid:!1,error:$u.ExitingMessages.CONTAINER_CLOSED,params:{container:n.name}}:{valid:!0}:{valid:!1,error:$u.ExitingMessages.NOWHERE_TO_GO}:{valid:!1,error:$u.ExitingMessages.NOWHERE_TO_GO}},execute(t){let e=t.player,r=t.world.getLocation(e.id),n=t.world.getEntity(r),i=t.world.getLocation(r),o="from";n.has(ml.TraitType.CONTAINER)?o="out of":n.has(ml.TraitType.SUPPORTER)&&(o="off"),t.world.moveEntity(e.id,i);let a={fromLocation:r,fromLocationName:n.name,toLocation:i,preposition:o},s=lj(t);s.exitingState=a},report(t){let r=lj(t).exitingState;return r?[t.event("if.event.exited",{messageId:`${t.action.id}.exited`,params:{place:r.fromLocationName},fromLocation:r.fromLocation,fromLocationName:r.fromLocationName,toLocation:r.toLocation,preposition:r.preposition})]:[t.event("if.event.exited",{messageId:`${t.action.id}.action_failed`,error:"Missing state from execute phase"})]},blocked(t,e){return[t.event("if.event.exited",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:e.params||{},reason:e.error})]},metadata:{requiresDirectObject:!1,requiresIndirectObject:!1,directObjectScope:_Z.ScopeLevel.REACHABLE}}});var tA=p(py=>{"use strict";Object.defineProperty(py,"__esModule",{value:!0});py.exitingAction=void 0;var bZ=uj();Object.defineProperty(py,"exitingAction",{enumerable:!0,get:function(){return bZ.exitingAction}})});var pj=p(fy=>{"use strict";Object.defineProperty(fy,"__esModule",{value:!0});fy.climbingAction=void 0;var IZ=we(),Nc=E(),OZ=ae();function mj(t){return t.sharedData}fy.climbingAction={id:OZ.IFActions.CLIMBING,requiredMessages:["no_target","not_climbable","cant_go_that_way","climbed_up","climbed_down","climbed_onto","already_there","too_high","too_dangerous"],group:"movement",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1,directObjectScope:IZ.ScopeLevel.REACHABLE},validate(t){let e=t.command.directObject?.entity,r=t.command.parsed.extras?.direction;return r&&!e?SZ(r,t):e?AZ(e,t):{valid:!1,error:"no_target"}},execute(t){let e=t.command.directObject?.entity,r=t.command.parsed.extras?.direction,n=mj(t);if(n.fromLocationId=t.currentLocation.id,r&&!e){let i=r.toLowerCase();n.mode="directional",n.direction=i;let s=t.currentLocation.get(Nc.TraitType.ROOM)?.exits||{};i==="up"&&s.up?n.destinationId=s.up.to||s.up.destination:i==="down"&&s.down&&(n.destinationId=s.down.to||s.down.destination),n.destinationId&&t.world.moveEntity(t.player.id,n.destinationId)}else e&&(n.mode="object",n.targetId=e.id,n.targetName=e.name,t.world.moveEntity(t.player.id,e.id))},blocked(t,e){let r=t.command.directObject?.entity,n=t.command.parsed.extras?.direction;return[t.event("if.event.climbed",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{target:r?.name,...e.params},reason:e.error,targetId:r?.id,targetName:r?.name,direction:n})]},report(t){let e=[],r=mj(t);if(r.mode==="directional"){let n=r.direction==="up"?"climbed_up":"climbed_down";e.push(t.event("if.event.climbed",{messageId:`${t.action.id}.${n}`,params:{direction:r.direction},direction:r.direction,method:"directional",destinationId:r.destinationId})),r.destinationId&&e.push(t.event("if.event.moved",{direction:r.direction,fromRoom:r.fromLocationId,toRoom:r.destinationId,method:"climbing"}))}else e.push(t.event("if.event.climbed",{messageId:`${t.action.id}.climbed_onto`,params:{target:r.targetName},targetId:r.targetId,targetName:r.targetName,method:"onto"})),e.push(t.event("if.event.entered",{targetId:r.targetId,method:"climbing",preposition:"onto"}));return e}};function SZ(t,e){let r=t.toLowerCase();if(r!=="up"&&r!=="down")return{valid:!1,error:"cant_go_that_way",params:{direction:t}};let n=e.currentLocation;if(!n.has(Nc.TraitType.ROOM))return{valid:!1,error:"cant_go_that_way",params:{direction:r}};let i=n.get(Nc.TraitType.ROOM);return!i.exits||!i.exits[r]?{valid:!1,error:"cant_go_that_way",params:{direction:r}}:{valid:!0}}function AZ(t,e){let r=!1;return t.has(Nc.TraitType.CLIMBABLE)?Nc.ClimbableBehavior.climb(t).success&&(r=!0):t.has(Nc.TraitType.SUPPORTER)&&t.get(Nc.TraitType.SUPPORTER).enterable&&(r=!0),r?e.world.getLocation(e.player.id)===t.id?{valid:!1,error:"already_there",params:{place:t.name}}:{valid:!0}:{valid:!1,error:"not_climbable",params:{object:t.name}}}});var rA=p(gy=>{"use strict";Object.defineProperty(gy,"__esModule",{value:!0});gy.climbingAction=void 0;var RZ=pj();Object.defineProperty(gy,"climbingAction",{enumerable:!0,get:function(){return RZ.climbingAction}})});var fj=p(fl=>{"use strict";Object.defineProperty(fl,"__esModule",{value:!0});fl.analyzeSearchTarget=CZ;fl.revealConcealedItems=wZ;fl.determineSearchMessage=NZ;fl.buildSearchEventData=LZ;var pl=E();function CZ(t,e){let r=e||t.currentLocation,n=!e,i=t.world.getContents(r.id),o=i.filter(s=>s.has(pl.TraitType.IDENTITY)?pl.IdentityBehavior.isConcealed(s):!1),a;return n?a="location":r.has(pl.TraitType.CONTAINER)?a="container":r.has(pl.TraitType.SUPPORTER)?a="supporter":a="object",{target:r,contents:i,concealedItems:o,isLocation:n,targetType:a}}function wZ(t){t.forEach(e=>{e.has(pl.TraitType.IDENTITY)&&pl.IdentityBehavior.reveal(e)})}function NZ(t){let{target:e,contents:r,concealedItems:n,targetType:i}=t,o={target:e.name};if(n.length>0)return o.items=n.map(a=>a.name).join(", "),o.where=DZ(i),{messageId:"found_concealed",params:o};switch(i){case"container":return r.length===0?{messageId:"empty_container",params:o}:(o.items=r.map(a=>a.name).join(", "),{messageId:"container_contents",params:o});case"supporter":return r.length>0?(o.items=r.map(a=>a.name).join(", "),{messageId:"supporter_contents",params:o}):{messageId:"nothing_special",params:o};case"location":return{messageId:"searched_location",params:o};default:return r.length>0?{messageId:"searched_object",params:o}:{messageId:"nothing_special",params:o}}}function DZ(t){switch(t){case"container":return"inside";case"supporter":return"on";default:return"here"}}function LZ(t){return{target:t.target.id,targetName:t.target.name,foundItems:t.concealedItems.map(e=>e.id),foundItemNames:t.concealedItems.map(e=>e.name),searchingLocation:t.isLocation}}});var yj=p(yy=>{"use strict";Object.defineProperty(yy,"__esModule",{value:!0});yy.searchingAction=void 0;var nA=E(),MZ=ae(),gj=we(),hy=fj();function hj(t){return t.sharedData}yy.searchingAction={id:MZ.IFActions.SEARCHING,defaultScope:{target:gj.ScopeLevel.REACHABLE},requiredMessages:["not_visible","not_reachable","container_closed","nothing_special","found_items","empty_container","container_contents","supporter_contents","searched_location","searched_object","found_concealed"],metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:gj.ScopeLevel.REACHABLE},validate(t){let e=t.command.directObject?.entity;return e?e.has(nA.TraitType.CONTAINER)&&e.has(nA.TraitType.OPENABLE)&&!nA.OpenableBehavior.isOpen(e)?{valid:!1,error:"container_closed",params:{target:e.name}}:{valid:!0}:{valid:!0}},execute(t){let e=t.command.directObject?.entity,r=hj(t),n=(0,hy.analyzeSearchTarget)(t,e);n.concealedItems.length>0&&(0,hy.revealConcealedItems)(n.concealedItems);let i=(0,hy.buildSearchEventData)(n),{messageId:o,params:a}=(0,hy.determineSearchMessage)(n);r.eventData=i,r.messageId=o,r.params=a},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.searched",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{target:r?.name,...e.params},reason:e.error,targetId:r?.id,targetName:r?.name})]},report(t){let e=[],r=hj(t);return e.push(t.event("if.event.searched",{messageId:`${t.action.id}.${r.messageId||"nothing_special"}`,params:r.params||{},...r.eventData})),e},group:"sensory"}});var iA=p(Ty=>{"use strict";Object.defineProperty(Ty,"__esModule",{value:!0});Ty.searchingAction=void 0;var PZ=yj();Object.defineProperty(Ty,"searchingAction",{enumerable:!0,get:function(){return PZ.searchingAction}})});var Ej=p(Ey=>{"use strict";Object.defineProperty(Ey,"__esModule",{value:!0});Ey.listeningAction=void 0;var Dc=E(),kZ=ae(),BZ=Gi();function Tj(t){return t.sharedData}function xZ(t){let e=t.command.directObject?.entity,r={},n={},i;if(e){r.target=e.id,n.target=e.name;let o=!1;if(e.has(Dc.TraitType.SWITCHABLE))e.get(Dc.TraitType.SWITCHABLE).isOn?(o=!0,r.hasSound=!0,r.soundType="device",i="device_running"):i="device_off";else if(e.has(Dc.TraitType.CONTAINER)){let a=t.world.getContents(e.id);a.length>0?(r.hasContents=!0,r.contentCount=a.length,i=a.some(c=>c.has(Dc.TraitType.EDIBLE)?c.get(Dc.TraitType.EDIBLE).isDrink:!1)?"liquid_sounds":"container_sounds",o=!0):i="no_sound"}else i="no_sound";!o&&!i&&(i="listened_to")}else{r.listeningToEnvironment=!0;let o=t.currentLocation,s=t.world.getContents(o.id).filter(c=>c.has(Dc.TraitType.SWITCHABLE)?c.get(Dc.TraitType.SWITCHABLE).isOn:!1);s.length>0?(r.soundSources=s.map(c=>c.id),n.devices=s.map(c=>c.name).join(", "),i="active_devices"):i="silence",r.roomId=o.id}return{messageId:i,params:n,eventData:r}}Ey.listeningAction={id:kZ.IFActions.LISTENING,requiredMessages:["not_visible","silence","ambient_sounds","active_devices","no_sound","device_running","device_off","container_sounds","liquid_sounds","listened_to","listened_environment"],group:"sensory",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1,directObjectScope:BZ.ScopeLevel.AWARE},validate(t){return{valid:!0}},execute(t){let e=xZ(t),r=Tj(t);r.messageId=e.messageId,r.params=e.params,r.eventData=e.eventData},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.listen_blocked",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{...e.params,target:r?.name},reason:e.error,targetId:r?.id,targetName:r?.name})]},report(t){let e=[],r=Tj(t);return e.push(t.event("if.event.listened",{messageId:`${t.action.id}.${r.messageId||"silence"}`,params:r.params,...r.eventData})),e}}});var _j=p(vj=>{"use strict";Object.defineProperty(vj,"__esModule",{value:!0})});var oA=p($o=>{"use strict";var jZ=$o&&$o.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),WZ=$o&&$o.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&jZ(e,t,r)};Object.defineProperty($o,"__esModule",{value:!0});$o.listeningAction=void 0;var UZ=Ej();Object.defineProperty($o,"listeningAction",{enumerable:!0,get:function(){return UZ.listeningAction}});WZ(_j(),$o)});var Ij=p(vy=>{"use strict";Object.defineProperty(vy,"__esModule",{value:!0});vy.smellingAction=void 0;var ai=E(),HZ=ae(),qZ=we();function bj(t){return t.sharedData}function GZ(t){let e=t.command.directObject?.entity,r={},n={},i="no_particular_scent",o=!1;if(e){if(r.target=e.id,n.target=e.name,e.has(ai.TraitType.EDIBLE))o=!0,r.hasScent=!0,e.get(ai.TraitType.EDIBLE).isDrink?(r.scentType="drinkable",i="drink_scent"):(r.scentType="edible",i="food_scent");else if(e.has(ai.TraitType.LIGHT_SOURCE))e.get(ai.TraitType.LIGHT_SOURCE).isLit&&(o=!0,r.hasScent=!0,r.scentType="burning",i="burning_scent");else if(e.has(ai.TraitType.CONTAINER)&&e.has(ai.TraitType.OPENABLE)&&e.get(ai.TraitType.OPENABLE).isOpen){let c=t.world.getContents(e.id).filter(d=>d.has(ai.TraitType.EDIBLE));c.length>0&&(o=!0,r.hasScent=!0,r.scentType="container_contents",r.scentSources=c.map(d=>d.id),i="container_food_scent")}o||(i="no_particular_scent")}else{r.smellingEnvironment=!0;let a=t.currentLocation,s=t.world.getContents(a.id),c=[],d=!1,u=!1;s.forEach(m=>{m.has(ai.TraitType.EDIBLE)&&(c.push(m.id),d=!0),m.has(ai.TraitType.LIGHT_SOURCE)&&m.get(ai.TraitType.LIGHT_SOURCE).isLit&&(c.push(m.id),u=!0)}),c.length>0&&(r.scentSources=c),u?i="smoke_detected":d?i="food_nearby":c.length>0?i="room_scents":i="no_scent",r.roomId=a.id}return{messageId:i,eventData:r,params:n,hasScent:o}}vy.smellingAction={id:HZ.IFActions.SMELLING,requiredMessages:["not_visible","too_far","no_scent","room_scents","food_nearby","smoke_detected","no_particular_scent","food_scent","drink_scent","burning_scent","container_food_scent","musty_scent","fresh_scent","smelled","smelled_environment"],metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:qZ.ScopeLevel.AWARE},validate(t){let e=t.player,r=t.command.directObject?.entity;if(r){let n=t.world.getContainingRoom(r.id),i=t.world.getContainingRoom(e.id);if(n&&i&&n.id!==i.id)return{valid:!1,error:"too_far",params:{target:r.name}}}return{valid:!0}},execute(t){let e=GZ(t),r=bj(t);r.messageId=e.messageId,r.eventData=e.eventData,r.params=e.params},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.smell_blocked",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{...e.params,target:r?.name},reason:e.error,targetId:r?.id,targetName:r?.name})]},report(t){let e=[],r=bj(t);return e.push(t.event("if.event.smelled",{messageId:`${t.action.id}.${r.messageId||"no_scent"}`,params:r.params,...r.eventData})),e},group:"sensory"}});var Sj=p(Oj=>{"use strict";Object.defineProperty(Oj,"__esModule",{value:!0})});var aA=p(Qo=>{"use strict";var FZ=Qo&&Qo.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),VZ=Qo&&Qo.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&FZ(e,t,r)};Object.defineProperty(Qo,"__esModule",{value:!0});Qo.smellingAction=void 0;var YZ=Ij();Object.defineProperty(Qo,"smellingAction",{enumerable:!0,get:function(){return YZ.smellingAction}});VZ(Sj(),Qo)});var Rj=p(_y=>{"use strict";Object.defineProperty(_y,"__esModule",{value:!0});_y.touchingAction=void 0;var mr=E(),zZ=ae(),sA=we();function Aj(t){return t.sharedData}_y.touchingAction={id:zZ.IFActions.TOUCHING,defaultScope:{target:sA.ScopeLevel.REACHABLE},requiredMessages:["no_target","not_visible","not_reachable","feels_normal","feels_warm","feels_hot","feels_cold","feels_soft","feels_hard","feels_smooth","feels_rough","feels_wet","device_vibrating","immovable_object","liquid_container","touched","touched_gently","poked","prodded","patted","stroked"],metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:sA.ScopeLevel.REACHABLE},validate(t){let e=t.command.directObject?.entity;if(!e)return{valid:!1,error:"no_target",params:{}};let r=t.requireScope(e,sA.ScopeLevel.REACHABLE);return r.ok?{valid:!0}:r.error},execute(t){let e=t.command.directObject?.entity,r=Aj(t),n={target:e.id,targetName:e.name},i="feels_normal";e.has(mr.TraitType.LIGHT_SOURCE)&&e.get(mr.TraitType.LIGHT_SOURCE).isLit&&(n.temperature="hot",n.isLit=!0,i="feels_hot"),e.has(mr.TraitType.SWITCHABLE)&&i==="feels_normal"&&e.get(mr.TraitType.SWITCHABLE).isOn&&(n.temperature="warm",n.isActive=!0,e.get(mr.TraitType.IDENTITY)?.description?.toLowerCase().includes("vibrat")?i="device_vibrating":i="feels_warm"),e.has(mr.TraitType.WEARABLE)?(n.texture="soft",i==="feels_normal"&&(i="feels_soft")):e.has(mr.TraitType.DOOR)?(n.texture="smooth",n.material="hard",i==="feels_normal"&&(i="feels_smooth")):e.has(mr.TraitType.CONTAINER)||e.has(mr.TraitType.SUPPORTER)?(n.texture="solid",e.has(mr.TraitType.CONTAINER)&&t.world.getContents(e.id).some(c=>c.has(mr.TraitType.EDIBLE)?c.get(mr.TraitType.EDIBLE).isDrink:!1)&&(i="liquid_container"),i==="feels_normal"&&(i="feels_hard")):e.has(mr.TraitType.EDIBLE)&&e.get(mr.TraitType.EDIBLE).isDrink&&(n.texture="liquid",i==="feels_normal"&&(i="feels_wet")),e.has(mr.TraitType.SCENERY)&&(n.immovable=!0,i==="feels_normal"&&(i="immovable_object"));let o=t.command.parsed.structure.verb?.text.toLowerCase()||"touch";if(i==="feels_normal")switch(o){case"poke":i="poked";break;case"prod":i="prodded";break;case"pat":i="patted";break;case"stroke":i="stroked";break;case"feel":i="touched_gently";break;default:i="touched"}r.targetId=e.id,r.targetName=e.name,r.messageId=i,r.eventData=n},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.touch_blocked",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{...e.params,target:r?.name},reason:e.error,targetId:r?.id,targetName:r?.name})]},report(t){let e=[],r=Aj(t);return e.push(t.event("if.event.touched",{messageId:`${t.action.id}.${r.messageId||"touched"}`,params:{target:r.targetName},...r.eventData})),e},group:"sensory"}});var wj=p(Cj=>{"use strict";Object.defineProperty(Cj,"__esModule",{value:!0})});var cA=p(Xo=>{"use strict";var KZ=Xo&&Xo.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),$Z=Xo&&Xo.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&KZ(e,t,r)};Object.defineProperty(Xo,"__esModule",{value:!0});Xo.touchingAction=void 0;var QZ=Rj();Object.defineProperty(Xo,"touchingAction",{enumerable:!0,get:function(){return QZ.touchingAction}});$Z(wj(),Xo)});var Nj=p(by=>{"use strict";Object.defineProperty(by,"__esModule",{value:!0});by.PuttingMessages=void 0;by.PuttingMessages={NO_TARGET:"no_target",NO_DESTINATION:"no_destination",NOT_HELD:"not_held",NOT_CONTAINER:"not_container",NOT_SURFACE:"not_surface",CONTAINER_CLOSED:"container_closed",ALREADY_THERE:"already_there",PUT_IN:"put_in",PUT_ON:"put_on",CANT_PUT_IN_ITSELF:"cant_put_in_itself",CANT_PUT_ON_ITSELF:"cant_put_on_itself",NO_ROOM:"no_room",NO_SPACE:"no_space",CANT_PUT:"cant_put",NOTHING_TO_PUT:"nothing_to_put"}});var Dj=p(dA=>{"use strict";Object.defineProperty(dA,"__esModule",{value:!0});dA.getPuttingSharedData=XZ;function XZ(t){return(typeof t.sharedData!="object"||t.sharedData===null)&&(t.sharedData={}),t.sharedData}});var kj=p(Oy=>{"use strict";Object.defineProperty(Oy,"__esModule",{value:!0});Oy.puttingAction=void 0;var Iy=we(),Bn=E(),Ts=Hi(),Lj=ae(),Ut=Nj(),Qu=Dj(),Mj=Uu();function lA(t,e){let r=e.has(Bn.TraitType.CONTAINER),n=e.has(Bn.TraitType.SUPPORTER);return t?(t==="in"||t==="into"||t==="inside")&&r?{targetPreposition:"in"}:(t==="on"||t==="onto")&&n?{targetPreposition:"on"}:t==="in"||t==="into"||t==="inside"?{targetPreposition:"in",error:Ut.PuttingMessages.NOT_CONTAINER,params:{destination:e.name}}:{targetPreposition:"on",error:Ut.PuttingMessages.NOT_SURFACE,params:{destination:e.name}}:r?{targetPreposition:"in"}:n?{targetPreposition:"on"}:{targetPreposition:"in",error:Ut.PuttingMessages.NOT_CONTAINER,params:{destination:e.name}}}function Pj(t,e,r,n){if(e.id===r.id)return{valid:!1,error:n==="on"?Ut.PuttingMessages.CANT_PUT_ON_ITSELF:Ut.PuttingMessages.CANT_PUT_IN_ITSELF,params:{item:e.name}};if(t.world.getLocation(e.id)===r.id){let s=r.has(Bn.TraitType.SUPPORTER)?"on":"in";return{valid:!1,error:Ut.PuttingMessages.ALREADY_THERE,params:{item:e.name,relation:s,destination:r.name}}}let{targetPreposition:i,error:o,params:a}=lA(n,r);if(o)return{valid:!1,error:o,params:a};if(i==="in"){if(r.has(Bn.TraitType.OPENABLE)&&!Bn.OpenableBehavior.isOpen(r))return{valid:!1,error:Ut.PuttingMessages.CONTAINER_CLOSED,params:{container:r.name}};if(!Bn.ContainerBehavior.canAccept(r,e,t.world))return{valid:!1,error:Ut.PuttingMessages.NO_ROOM,params:{container:r.name}}}return i==="on"&&!Bn.SupporterBehavior.canAccept(r,e,t.world)?{valid:!1,error:Ut.PuttingMessages.NO_SPACE,params:{surface:r.name}}:{valid:!0,targetPreposition:i}}function ZZ(t){let e=t.command.indirectObject?.entity,r=t.command.parsed.structure.preposition?.text;if(!e)return{valid:!1,error:Ut.PuttingMessages.NO_DESTINATION};let n=(0,Mj.expandMultiObject)(t,{scope:"carried"});if(n.length===0)return{valid:!1,error:Ut.PuttingMessages.NOTHING_TO_PUT};let i=n.map(s=>{let c=Pj(t,s.entity,e,r);return{entity:s.entity,success:c.valid,error:c.valid?void 0:c.error,errorParams:c.valid?void 0:c.params,targetPreposition:c.targetPreposition}}),o=(0,Qu.getPuttingSharedData)(t);return o.multiObjectResults=i,i.some(s=>s.success)?{valid:!0}:{valid:!1,error:i[0].error,params:i[0].errorParams}}function JZ(t,e,r,n,i){if(n.targetPreposition=i,i==="in"){let o=Bn.ContainerBehavior.addItem(r,e,t.world);n.putResult=o}else{let o=Bn.SupporterBehavior.addItem(r,e,t.world);n.putResult=o}t.world.moveEntity(e.id,r.id)}function e4(t,e,r,n,i){if(n.targetPreposition==="in"){let a={item:e.name,container:r.name};i.push(t.event("if.event.put_in",{messageId:`${t.action.id}.${Ut.PuttingMessages.PUT_IN}`,params:a,itemId:e.id,itemName:e.name,targetId:r.id,targetName:r.name,actorId:t.player.id,preposition:"in",itemSnapshot:(0,Ts.captureEntitySnapshot)(e,t.world,!0),targetSnapshot:(0,Ts.captureEntitySnapshot)(r,t.world,!0)}))}else{let a={item:e.name,surface:r.name};i.push(t.event("if.event.put_on",{messageId:`${t.action.id}.${Ut.PuttingMessages.PUT_ON}`,params:a,itemId:e.id,itemName:e.name,targetId:r.id,targetName:r.name,actorId:t.player.id,preposition:"on",itemSnapshot:(0,Ts.captureEntitySnapshot)(e,t.world,!0),targetSnapshot:(0,Ts.captureEntitySnapshot)(r,t.world,!0)}))}}function t4(t,e,r,n,i,o){o.push(t.event("if.event.put_blocked",{messageId:`${t.action.id}.${n}`,params:{...i,item:e.name,destination:r.name},itemId:e.id,itemName:e.name,targetId:r.id,targetName:r.name,reason:n}))}Oy.puttingAction={id:Lj.IFActions.PUTTING,defaultScope:{item:Iy.ScopeLevel.REACHABLE,target:Iy.ScopeLevel.REACHABLE},requiredMessages:["no_target","no_destination","not_held","not_container","not_surface","container_closed","already_there","put_in","put_on","cant_put_in_itself","cant_put_on_itself","no_room","no_space","nothing_to_put"],group:"object_manipulation",metadata:{requiresDirectObject:!0,requiresIndirectObject:!0,directObjectScope:Iy.ScopeLevel.REACHABLE,indirectObjectScope:Iy.ScopeLevel.REACHABLE},validate(t){if((0,Mj.isMultiObjectCommand)(t))return ZZ(t);let e=t.player,r=t.command.directObject?.entity,n=t.command.indirectObject?.entity,i=t.command.parsed.structure.preposition?.text,o=(0,Qu.getPuttingSharedData)(t);if(!r)return{valid:!1,error:Ut.PuttingMessages.NO_TARGET};if(!n)return{valid:!1,error:Ut.PuttingMessages.NO_DESTINATION,params:{item:r.name}};let s=(0,Bn.getInterceptorForAction)(n,Lj.IFActions.PUTTING)?.interceptor,c={itemId:r.id,itemName:r.name,targetId:n.id,targetName:n.name,preposition:i};if(o.interceptor=s,o.interceptorData=c,s?.preValidate){let m=s.preValidate(n,t.world,e.id,c);if(m!==null)return{valid:m.valid,error:m.error,params:m.params}}let d=t.requireCarriedOrImplicitTake(r);if(!d.ok)return d.error;let u=Pj(t,r,n,i);if(!u.valid)return u;if(s?.postValidate){let m=s.postValidate(n,t.world,e.id,c);if(m!==null)return{valid:m.valid,error:m.error,params:m.params}}return u},execute(t){let e=t.player,r=(0,Qu.getPuttingSharedData)(t),n=t.command.indirectObject.entity,i=t.command.parsed.structure.preposition?.text;if(r.multiObjectResults){let{targetPreposition:d}=lA(i,n);for(let u of r.multiObjectResults)u.success&&JZ(t,u.entity,n,u,d);return}let o=t.command.directObject.entity,{targetPreposition:a}=lA(i,n);if(r.targetPreposition=a,a==="in"){let d=Bn.ContainerBehavior.addItem(n,o,t.world);r.putResult=d}else{let d=Bn.SupporterBehavior.addItem(n,o,t.world);r.putResult=d}t.world.moveEntity(o.id,n.id);let s=r.interceptor,c=r.interceptorData||{};s?.postExecute&&s.postExecute(n,t.world,e.id,c)},report(t){let e=(0,Qu.getPuttingSharedData)(t),r=t.command.indirectObject.entity,n=[];if(t.sharedData.implicitTakeEvents&&n.push(...t.sharedData.implicitTakeEvents),e.multiObjectResults){for(let c of e.multiObjectResults)c.success?e4(t,c.entity,r,c,n):t4(t,c.entity,r,c.error,c.errorParams,n);return n}let i=t.command.directObject.entity;if(e.targetPreposition==="in"){let c={item:i.name,container:r.name};n.push(t.event("if.event.put_in",{messageId:`${t.action.id}.${Ut.PuttingMessages.PUT_IN}`,params:c,itemId:i.id,itemName:i.name,targetId:r.id,targetName:r.name,actorId:t.player.id,preposition:"in",itemSnapshot:(0,Ts.captureEntitySnapshot)(i,t.world,!0),targetSnapshot:(0,Ts.captureEntitySnapshot)(r,t.world,!0)}))}else{let c={item:i.name,surface:r.name};n.push(t.event("if.event.put_on",{messageId:`${t.action.id}.${Ut.PuttingMessages.PUT_ON}`,params:c,itemId:i.id,itemName:i.name,targetId:r.id,targetName:r.name,actorId:t.player.id,preposition:"on",itemSnapshot:(0,Ts.captureEntitySnapshot)(i,t.world,!0),targetSnapshot:(0,Ts.captureEntitySnapshot)(r,t.world,!0)}))}let a=e.interceptor,s=e.interceptorData||{};if(a?.postReport){let c=a.postReport(r,t.world,t.player.id,s);for(let d of c)n.push(t.event(d.type,d.payload))}return n},blocked(t,e){let r=t.command.directObject?.entity,n=t.command.indirectObject?.entity,i=(0,Qu.getPuttingSharedData)(t),o=i.interceptor,a=i.interceptorData||{};if(o?.onBlocked&&n&&e.error){let s=o.onBlocked(n,t.world,t.player.id,e.error,a);if(s!==null)return s.map(c=>t.event(c.type,c.payload))}return[t.event("if.event.put_blocked",{messageId:`${t.action.id}.${e.error}`,params:{...e.params,item:r?.name,destination:n?.name},itemId:r?.id,itemName:r?.name,targetId:n?.id,targetName:n?.name,reason:e.error})]}}});var xj=p(Bj=>{"use strict";Object.defineProperty(Bj,"__esModule",{value:!0})});var Sy=p(Zo=>{"use strict";var r4=Zo&&Zo.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),n4=Zo&&Zo.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&r4(e,t,r)};Object.defineProperty(Zo,"__esModule",{value:!0});Zo.puttingAction=void 0;var i4=kj();Object.defineProperty(Zo,"puttingAction",{enumerable:!0,get:function(){return i4.puttingAction}});n4(xj(),Zo)});var jj=p(Ay=>{"use strict";Object.defineProperty(Ay,"__esModule",{value:!0});Ay.InsertingMessages=void 0;Ay.InsertingMessages={NO_TARGET:"no_target",NO_DESTINATION:"no_destination",NOT_HELD:"not_held",NOT_INSERTABLE:"not_insertable",NOT_CONTAINER:"not_container",ALREADY_THERE:"already_there",INSERTED:"inserted",WONT_FIT:"wont_fit",CONTAINER_CLOSED:"container_closed",CANT_INSERT:"cant_insert",NOTHING_TO_INSERT:"nothing_to_insert"}});var Hj=p(Cy=>{"use strict";Object.defineProperty(Cy,"__esModule",{value:!0});Cy.insertingAction=void 0;var Ry=we(),o4=ae(),Lc=Sy(),Wj=aS(),uA=jj();function mA(t){return t.sharedData}function Uj(t){return{...t.command,parsed:{...t.command.parsed,structure:{...t.command.parsed.structure,preposition:{tokens:[],text:"in"}},preposition:"in"}}}Cy.insertingAction={id:o4.IFActions.INSERTING,defaultScope:{item:Ry.ScopeLevel.REACHABLE,container:Ry.ScopeLevel.REACHABLE},requiredMessages:["no_target","no_destination","not_held","not_insertable","not_container","already_there","inserted","wont_fit","container_closed","nothing_to_insert"],group:"object_manipulation",metadata:{requiresDirectObject:!0,requiresIndirectObject:!0,directObjectScope:Ry.ScopeLevel.REACHABLE,indirectObjectScope:Ry.ScopeLevel.REACHABLE},validate(t){let e=t.command.directObject?.entity,r=t.command.indirectObject?.entity;if(!(t.command.parsed.structure.directObject?.isAll||t.command.parsed.structure.directObject?.isList)&&!e)return{valid:!1,error:uA.InsertingMessages.NO_TARGET};if(!r)return{valid:!1,error:uA.InsertingMessages.NO_DESTINATION,params:{item:e?.name}};let i=Uj(t),o=(0,Wj.createActionContext)(t.world,t.player,Lc.puttingAction,i),a=mA(t);a.modifiedContext=o;let s=Lc.puttingAction.validate(o);return s.valid?{valid:!0}:s},execute(t){let e=mA(t);if(!e.modifiedContext){let n=Uj(t);e.modifiedContext=(0,Wj.createActionContext)(t.world,t.player,Lc.puttingAction,n)}Lc.puttingAction.execute(e.modifiedContext)},report(t){let r=mA(t).modifiedContext;if(!r){let n=t.command.directObject?.entity,i=t.command.indirectObject?.entity;return[t.event("if.event.insert_blocked",{messageId:`${t.action.id}.${uA.InsertingMessages.CANT_INSERT}`,params:{item:n?.name,container:i?.name},itemId:n?.id,itemName:n?.name,containerId:i?.id,containerName:i?.name,reason:"cant_insert"})]}return"report"in Lc.puttingAction&&typeof Lc.puttingAction.report=="function"?Lc.puttingAction.report(r):[]},blocked(t,e){let r=t.command.directObject?.entity,n=t.command.indirectObject?.entity;return[t.event("if.event.insert_blocked",{messageId:`${t.action.id}.${e.error}`,params:{...e.params,item:r?.name,container:n?.name},itemId:r?.id,itemName:r?.name,containerId:n?.id,containerName:n?.name,reason:e.error})]}}});var Gj=p(qj=>{"use strict";Object.defineProperty(qj,"__esModule",{value:!0})});var pA=p(Jo=>{"use strict";var a4=Jo&&Jo.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),s4=Jo&&Jo.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&a4(e,t,r)};Object.defineProperty(Jo,"__esModule",{value:!0});Jo.insertingAction=void 0;var c4=Hj();Object.defineProperty(Jo,"insertingAction",{enumerable:!0,get:function(){return c4.insertingAction}});s4(Gj(),Jo)});var Fj=p(fA=>{"use strict";Object.defineProperty(fA,"__esModule",{value:!0});fA.createReadingEvent=d4;function d4(t){return{id:`${Date.now()}-read`,type:"if.event.read",timestamp:Date.now(),data:{...t},entities:{target:t.targetId}}}});var zj=p(Ny=>{"use strict";Object.defineProperty(Ny,"__esModule",{value:!0});Ny.reading=void 0;var wy=E(),l4=Fj();function Vj(t){return t.sharedData}var Yj=we();Ny.reading={id:"if.action.reading",defaultScope:{target:Yj.ScopeLevel.REACHABLE},targetRequirements:{trait:wy.TraitType.READABLE,description:"readable"},requiresHolding:!0,validate(t){let{directObject:e}=t.command;if(!e?.entity)return{valid:!1,error:"what_to_read"};let r=e.entity,n=t.requireScope(r,Yj.ScopeLevel.VISIBLE);if(!n.ok)return n.error;let i=r.get(wy.TraitType.READABLE);if(!i)return{valid:!1,error:"not_readable",params:{item:String(r.attributes.name||"that")}};if(i.isReadable===!1)return{valid:!1,error:"cannot_read_now",params:{item:String(r.attributes.name||"that"),reason:i.cannotReadMessage||"cannot_read_now"}};if(!r.has(wy.TraitType.SCENERY)){let o=t.requireCarriedOrImplicitTake(r);if(!o.ok)return o.error}return i.requiresAbility&&i.requiredAbility,{valid:!0}},execute(t){let{directObject:e}=t.command,r=e.entity,n=r.get(wy.TraitType.READABLE),i=Vj(t);n.hasBeenRead=!0;let o={targetId:r.id,targetName:String(r.attributes.name||"something"),text:n.text,readableType:n.readableType||"text",hasBeenRead:!0};n.pageContent&&n.currentPage&&(o.currentPage=n.currentPage,o.totalPages=n.pages||n.pageContent.length,o.text=n.pageContent[n.currentPage-1]);let a=(0,l4.createReadingEvent)(o),s="read_text";n.readableType==="book"?s=n.pageContent?"read_book_page":"read_book":n.readableType==="sign"?s="read_sign":n.readableType==="inscription"&&(s="read_inscription");let c={item:String(r.attributes.name||"something"),text:o.text};o.currentPage&&(c.currentPage=o.currentPage,c.totalPages=o.totalPages),i.readEvent=a,i.messageId=s,i.params=c},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.read",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{item:r?.name,...e.params},reason:e.error,targetId:r?.id,targetName:r?.name})]},report(t){let e=Vj(t),r=[];t.sharedData.implicitTakeEvents&&r.push(...t.sharedData.implicitTakeEvents);let n=t.command.directObject?.entity;return r.push(t.event("if.event.read",{messageId:`${t.action.id}.${e.messageId||"read_text"}`,params:e.params||{},targetId:n?.id,targetName:String(n?.attributes.name||"something"),text:e.params?.text})),r}}});var gA=p(Dy=>{"use strict";Object.defineProperty(Dy,"__esModule",{value:!0});Dy.reading=void 0;var u4=zj();Object.defineProperty(Dy,"reading",{enumerable:!0,get:function(){return u4.reading}})});var Kj=p(Ly=>{"use strict";Object.defineProperty(Ly,"__esModule",{value:!0});Ly.RemovingMessages=void 0;Ly.RemovingMessages={NO_TARGET:"no_target",NO_SOURCE:"no_source",NOT_IN_CONTAINER:"not_in_container",NOT_ON_SURFACE:"not_on_surface",CONTAINER_CLOSED:"container_closed",REMOVED_FROM:"removed_from",REMOVED_FROM_SURFACE:"removed_from_surface",CANT_REACH:"cant_reach",ALREADY_HAVE:"already_have",CANNOT_TAKE:"cannot_take",CANT_REMOVE:"cant_remove",TOO_HEAVY:"too_heavy",CONTAINER_FULL:"container_full",CANT_TAKE:"cant_take",NOTHING_TO_REMOVE:"nothing_to_remove"}});var $j=p(hA=>{"use strict";Object.defineProperty(hA,"__esModule",{value:!0});hA.getRemovingSharedData=m4;function m4(t){return(typeof t.sharedData!="object"||t.sharedData===null)&&(t.sharedData={}),t.sharedData}});var Jj=p(My=>{"use strict";Object.defineProperty(My,"__esModule",{value:!0});My.removingAction=void 0;var gl=Hi(),Ae=E(),p4=ae(),yA=Gi(),pr=Kj(),TA=$j(),Xj=Uu();function f4(t){return!(t.has(Ae.TraitType.ROOM)||t.has(Ae.TraitType.SCENERY)||t.has(Ae.TraitType.ACTOR))}function Qj(t,e){return t.world.getContents(e.id).filter(n=>f4(n))}function Zj(t,e,r){let n=t.player;if(Ae.ActorBehavior.isHolding(n,e.id,t.world))return{valid:!1,error:pr.RemovingMessages.ALREADY_HAVE,params:{item:e.name}};let i=t.world.getLocation(e.id);return!i||i!==r.id?r.has(Ae.TraitType.CONTAINER)?{valid:!1,error:pr.RemovingMessages.NOT_IN_CONTAINER,params:{item:e.name,container:r.name}}:r.has(Ae.TraitType.SUPPORTER)?{valid:!1,error:pr.RemovingMessages.NOT_ON_SURFACE,params:{item:e.name,surface:r.name}}:{valid:!1,error:pr.RemovingMessages.NOT_IN_CONTAINER,params:{item:e.name,container:r.name}}:r.has(Ae.TraitType.CONTAINER)&&r.has(Ae.TraitType.OPENABLE)&&!Ae.OpenableBehavior.isOpen(r)?{valid:!1,error:pr.RemovingMessages.CONTAINER_CLOSED,params:{container:r.name}}:Ae.ActorBehavior.canTakeItem(n,e,t.world)?{valid:!0}:{valid:!1,error:pr.RemovingMessages.CANNOT_TAKE,params:{item:e.name}}}function g4(t){let e=t.command.indirectObject?.entity;if(!e)return{valid:!1,error:pr.RemovingMessages.NO_SOURCE};if(e.has(Ae.TraitType.CONTAINER)&&e.has(Ae.TraitType.OPENABLE)&&!Ae.OpenableBehavior.isOpen(e))return{valid:!1,error:pr.RemovingMessages.CONTAINER_CLOSED,params:{container:e.name}};let r=t.command.parsed.structure.directObject,n;if(r?.isAll){n=Qj(t,e);let s=(0,Xj.getExcludedNames)(t);s.length>0&&(n=n.filter(c=>{let d=c.name.toLowerCase();return!s.includes(d)}))}else if(r?.isList&&r.items){let s=Qj(t,e);n=[];for(let c of r.items){let d=(c.head||c.text).toLowerCase(),u=s.find(m=>m.name.toLowerCase()===d);u&&n.push(u)}}else n=[];if(n.length===0)return{valid:!1,error:pr.RemovingMessages.NOTHING_TO_REMOVE};let i=n.map(s=>{let c=Zj(t,s,e);return{entity:s,success:c.valid,error:c.valid?void 0:c.error,errorParams:c.valid?void 0:c.params}}),o=(0,TA.getRemovingSharedData)(t);return o.multiObjectResults=i,i.some(s=>s.success)?{valid:!0}:{valid:!1,error:i[0].error,params:i[0].errorParams}}function h4(t,e,r,n){let i=t.player,o=null;r.has(Ae.TraitType.CONTAINER)?o=Ae.ContainerBehavior.removeItem(r,e,t.world):r.has(Ae.TraitType.SUPPORTER)&&(o=Ae.SupporterBehavior.removeItem(r,e,t.world)),n.removeResult=o;let a=Ae.ActorBehavior.takeItem(i,e,t.world);n.takeResult=a,t.world.moveEntity(e.id,i.id)}function y4(t,e,r,n,i){let o=t.player,a={item:e.name},s;r.has(Ae.TraitType.CONTAINER)?(a.container=r.name,s=pr.RemovingMessages.REMOVED_FROM):(a.surface=r.name,s=pr.RemovingMessages.REMOVED_FROM_SURFACE),i.push(t.event("if.event.taken",{messageId:`${t.action.id}.${s}`,params:a,item:e.name,itemId:e.id,actorId:o.id,fromLocation:r.id,container:r.name,fromContainer:r.has(Ae.TraitType.CONTAINER),fromSupporter:r.has(Ae.TraitType.SUPPORTER)&&!r.has(Ae.TraitType.CONTAINER),itemSnapshot:(0,gl.captureEntitySnapshot)(e,t.world,!0),actorSnapshot:(0,gl.captureEntitySnapshot)(o,t.world,!1),sourceSnapshot:(0,gl.captureEntitySnapshot)(r,t.world,r.has(Ae.TraitType.ROOM))}))}function T4(t,e,r,n,i,o){o.push(t.event("if.event.remove_blocked",{messageId:`${t.action.id}.${n}`,params:{...i,item:e.name,source:r.name},itemId:e.id,itemName:e.name,sourceId:r.id,sourceName:r.name,reason:n}))}My.removingAction={id:p4.IFActions.REMOVING,defaultScope:{item:yA.ScopeLevel.REACHABLE,source:yA.ScopeLevel.REACHABLE},requiredMessages:["no_target","no_source","not_in_container","not_on_surface","container_closed","removed_from","removed_from_surface","cant_reach","already_have","nothing_to_remove"],group:"object_manipulation",metadata:{requiresDirectObject:!0,requiresIndirectObject:!0,directObjectScope:yA.ScopeLevel.REACHABLE},validate(t){if((0,Xj.isMultiObjectCommand)(t))return g4(t);let e=t.command.directObject?.entity,r=t.command.indirectObject?.entity;return e?r?Zj(t,e,r):{valid:!1,error:pr.RemovingMessages.NO_SOURCE,params:{item:e.name}}:{valid:!1,error:pr.RemovingMessages.NO_TARGET,params:{}}},execute(t){let e=(0,TA.getRemovingSharedData)(t),r=t.command.indirectObject.entity;if(e.multiObjectResults){for(let s of e.multiObjectResults)s.success&&h4(t,s.entity,r,s);return}let n=t.player,i=t.command.directObject.entity,o=null;r.has(Ae.TraitType.CONTAINER)?o=Ae.ContainerBehavior.removeItem(r,i,t.world):r.has(Ae.TraitType.SUPPORTER)&&(o=Ae.SupporterBehavior.removeItem(r,i,t.world)),e.removeResult=o;let a=Ae.ActorBehavior.takeItem(n,i,t.world);e.takeResult=a,t.world.moveEntity(i.id,n.id)},report(t){let e=(0,TA.getRemovingSharedData)(t),r=t.command.indirectObject.entity;if(e.multiObjectResults){let s=[];for(let c of e.multiObjectResults)c.success?y4(t,c.entity,r,c,s):T4(t,c.entity,r,c.error,c.errorParams,s);return s}let n=t.player,i=t.command.directObject.entity,o={item:i.name},a;return r.has(Ae.TraitType.CONTAINER)?(o.container=r.name,a=pr.RemovingMessages.REMOVED_FROM):(o.surface=r.name,a=pr.RemovingMessages.REMOVED_FROM_SURFACE),[t.event("if.event.taken",{messageId:`${t.action.id}.${a}`,params:o,item:i.name,itemId:i.id,actorId:n.id,fromLocation:r.id,container:r.name,fromContainer:r.has(Ae.TraitType.CONTAINER),fromSupporter:r.has(Ae.TraitType.SUPPORTER)&&!r.has(Ae.TraitType.CONTAINER),itemSnapshot:(0,gl.captureEntitySnapshot)(i,t.world,!0),actorSnapshot:(0,gl.captureEntitySnapshot)(n,t.world,!1),sourceSnapshot:(0,gl.captureEntitySnapshot)(r,t.world,r.has(Ae.TraitType.ROOM))})]},blocked(t,e){let r=t.command.directObject?.entity,n=t.command.indirectObject?.entity;return[t.event("if.event.remove_blocked",{messageId:`${t.action.id}.${e.error}`,params:{...e.params,item:r?.name,source:n?.name},itemId:r?.id,itemName:r?.name,sourceId:n?.id,sourceName:n?.name,reason:e.error})]}}});var EA=p(Py=>{"use strict";Object.defineProperty(Py,"__esModule",{value:!0});Py.removingAction=void 0;var E4=Jj();Object.defineProperty(Py,"removingAction",{enumerable:!0,get:function(){return E4.removingAction}})});var tW=p(By=>{"use strict";Object.defineProperty(By,"__esModule",{value:!0});By.givingAction=void 0;var ky=we(),Xu=E(),v4=ae();function eW(t){return t.sharedData}By.givingAction={id:v4.IFActions.GIVING,defaultScope:{item:ky.ScopeLevel.REACHABLE,recipient:ky.ScopeLevel.REACHABLE},requiredMessages:["no_item","no_recipient","not_holding","recipient_not_visible","recipient_not_reachable","not_actor","self","inventory_full","too_heavy","not_interested","refuses","given","accepts","gratefully_accepts","reluctantly_accepts"],metadata:{requiresDirectObject:!0,requiresIndirectObject:!0,directObjectScope:ky.ScopeLevel.REACHABLE,indirectObjectScope:ky.ScopeLevel.REACHABLE},validate(t){let e=t.player,r=t.command.directObject?.entity,n=t.command.indirectObject?.entity;if(!r)return{valid:!1,error:"no_item",params:{}};if(!n)return{valid:!1,error:"no_recipient",params:{}};let i=t.requireCarriedOrImplicitTake(r);if(!i.ok)return i.error;if(!n.has(Xu.TraitType.ACTOR))return{valid:!1,error:"not_actor",params:{recipient:n.name}};if(n.id===e.id)return{valid:!1,error:"self",params:{item:r.name}};let o=n.get(Xu.TraitType.ACTOR);if(o){let s=o.capacity||o.inventoryLimit;if(s){let c=t.world.getContents(n.id);if(s.maxItems!==void 0&&c.length>=s.maxItems)return{valid:!1,error:"inventory_full",params:{recipient:n.name}};if(s.maxWeight!==void 0){let d=c.reduce((m,f)=>m+Xu.IdentityBehavior.getWeight(f),0),u=Xu.IdentityBehavior.getWeight(r);if(d+u>s.maxWeight)return{valid:!1,error:"too_heavy",params:{item:r.name,recipient:n.name}}}}}let a=o?.preferences;if(a){let s=r.name.toLowerCase();if(a.refuses&&Array.isArray(a.refuses)){for(let c of a.refuses)if(s.includes(c.toLowerCase()))return{valid:!1,error:"not_interested",params:{item:r.name,recipient:n.name}}}}return{valid:!0}},execute(t){let e=t.command.directObject.entity,r=t.command.indirectObject.entity,n=eW(t);n.itemId=e.id,n.itemName=e.name,n.recipientId=r.id,n.recipientName=r.name,t.world.moveEntity(e.id,r.id);let i="normal",a=r.get(Xu.TraitType.ACTOR)?.preferences;if(a){let s=e.name.toLowerCase();if(a.likes&&Array.isArray(a.likes)){for(let c of a.likes)if(s.includes(c.toLowerCase())){i="grateful";break}}if(i==="normal"&&a.dislikes&&Array.isArray(a.dislikes)){for(let c of a.dislikes)if(s.includes(c.toLowerCase())){i="reluctant";break}}}switch(n.acceptanceType=i,i){case"grateful":n.messageId="gratefully_accepts";break;case"reluctant":n.messageId="reluctantly_accepts";break;default:n.messageId="given"}n.params={item:e.name,recipient:r.name}},blocked(t,e){let r=t.command.directObject?.entity,n=t.command.indirectObject?.entity;return[t.event("if.event.give_blocked",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{...e.params,item:r?.name,recipient:n?.name},reason:e.error,itemId:r?.id,itemName:r?.name,recipientId:n?.id,recipientName:n?.name})]},report(t){let e=eW(t),r=[];return t.sharedData.implicitTakeEvents&&r.push(...t.sharedData.implicitTakeEvents),r.push(t.event("if.event.given",{messageId:`${t.action.id}.${e.messageId}`,params:e.params,item:e.itemId,itemName:e.itemName,recipient:e.recipientId,recipientName:e.recipientName,accepted:!0})),r},group:"social"}});var nW=p(rW=>{"use strict";Object.defineProperty(rW,"__esModule",{value:!0})});var vA=p(ea=>{"use strict";var _4=ea&&ea.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),b4=ea&&ea.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&_4(e,t,r)};Object.defineProperty(ea,"__esModule",{value:!0});ea.givingAction=void 0;var I4=tW();Object.defineProperty(ea,"givingAction",{enumerable:!0,get:function(){return I4.givingAction}});b4(nW(),ea)});var oW=p(jy=>{"use strict";Object.defineProperty(jy,"__esModule",{value:!0});jy.showingAction=void 0;var xy=we(),hl=E(),O4=ae();function iW(t){return t.sharedData}function S4(t){let e=t.command.directObject?.entity,r=t.command.indirectObject?.entity;if(!e||!r)return null;let i=(e.has(hl.TraitType.WEARABLE)?e.get(hl.TraitType.WEARABLE):null)?.worn===!0,o={item:e.id,itemName:e.name,viewer:r.id,viewerName:r.name,isWorn:i},a={item:e.name,viewer:r.name},s="shown";if(e.has(hl.TraitType.IDENTITY)){let d=e.get(hl.TraitType.IDENTITY);d.properName&&d.name&&(o.itemProperName=d.name)}let c=r.get(hl.TraitType.ACTOR);if(c&&c.reactions){let d=c.reactions,u=e.name.toLowerCase();d.recognizes&&d.recognizes.some(m=>u.includes(m))?(s="viewer_recognizes",o.recognized=!0):d.impressed&&d.impressed.some(m=>u.includes(m))?(s="viewer_impressed",o.impressed=!0):d.unimpressed&&d.unimpressed.some(m=>u.includes(m))?s="viewer_unimpressed":d.examines&&d.examines.some(m=>u.includes(m))?s="viewer_examines":s="viewer_nods"}return i&&s==="shown"&&(s="wearing_shown"),{item:e,viewer:r,isWearing:i,messageId:s,eventData:o,params:a}}jy.showingAction={id:O4.IFActions.SHOWING,defaultScope:{item:xy.ScopeLevel.REACHABLE,viewer:xy.ScopeLevel.VISIBLE},requiredMessages:["no_item","no_viewer","not_carrying","viewer_not_visible","viewer_too_far","not_actor","self","shown","viewer_examines","viewer_nods","viewer_impressed","viewer_unimpressed","viewer_recognizes","wearing_shown"],metadata:{requiresDirectObject:!0,requiresIndirectObject:!0,directObjectScope:xy.ScopeLevel.REACHABLE,indirectObjectScope:xy.ScopeLevel.VISIBLE},validate(t){let e=t.player,r=t.command.directObject?.entity,n=t.command.indirectObject?.entity;if(!r)return{valid:!1,error:"no_item",params:{}};if(!n)return{valid:!1,error:"no_viewer",params:{}};let i=t.requireCarriedOrImplicitTake(r);if(!i.ok)return i.error;let o=t.world.getLocation?.(n.id),a=t.world.getLocation?.(e.id);return o!==a?{valid:!1,error:"viewer_too_far",params:{viewer:n.name}}:n.has(hl.TraitType.ACTOR)?n.id===e.id?{valid:!1,error:"self",params:{item:r.name}}:{valid:!0}:{valid:!1,error:"not_actor"}},execute(t){let e=S4(t),r=iW(t);e&&(r.messageId=e.messageId,r.eventData=e.eventData,r.params=e.params)},blocked(t,e){let r=t.command.directObject?.entity,n=t.command.indirectObject?.entity;return[t.event("if.event.show_blocked",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{...e.params,item:r?.name,viewer:n?.name},reason:e.error,itemId:r?.id,itemName:r?.name,viewerId:n?.id,viewerName:n?.name})]},report(t){let e=[],r=iW(t);return t.sharedData.implicitTakeEvents&&e.push(...t.sharedData.implicitTakeEvents),e.push(t.event("if.event.shown",{messageId:`${t.action.id}.${r.messageId||"shown"}`,params:r.params,...r.eventData})),e},group:"social"}});var sW=p(aW=>{"use strict";Object.defineProperty(aW,"__esModule",{value:!0})});var _A=p(ta=>{"use strict";var A4=ta&&ta.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),R4=ta&&ta.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&A4(e,t,r)};Object.defineProperty(ta,"__esModule",{value:!0});ta.showingAction=void 0;var C4=oW();Object.defineProperty(ta,"showingAction",{enumerable:!0,get:function(){return C4.showingAction}});R4(sW(),ta)});var lW=p(Hy=>{"use strict";Object.defineProperty(Hy,"__esModule",{value:!0});Hy.throwingAction=void 0;var fe=E(),cW=ae(),Wy=we();function dW(t){return t&&{north:fe.Direction.NORTH,south:fe.Direction.SOUTH,east:fe.Direction.EAST,west:fe.Direction.WEST,northeast:fe.Direction.NORTHEAST,northwest:fe.Direction.NORTHWEST,southeast:fe.Direction.SOUTHEAST,southwest:fe.Direction.SOUTHWEST,up:fe.Direction.UP,down:fe.Direction.DOWN,in:fe.Direction.IN,out:fe.Direction.OUT,n:fe.Direction.NORTH,s:fe.Direction.SOUTH,e:fe.Direction.EAST,w:fe.Direction.WEST,ne:fe.Direction.NORTHEAST,nw:fe.Direction.NORTHWEST,se:fe.Direction.SOUTHEAST,sw:fe.Direction.SOUTHWEST,u:fe.Direction.UP,d:fe.Direction.DOWN}[t.toLowerCase()]||null}function Uy(t){return t.sharedData}Hy.throwingAction={id:cW.IFActions.THROWING,defaultScope:{item:Wy.ScopeLevel.REACHABLE,target:Wy.ScopeLevel.VISIBLE},requiredMessages:["no_item","not_holding","target_not_visible","target_not_here","no_exit","too_heavy","self","thrown","thrown_down","thrown_gently","thrown_at","hits_target","misses_target","bounces_off","lands_on","lands_in","thrown_direction","sails_through","breaks_on_impact","breaks_against","fragile_breaks","target_ducks","target_catches","target_angry"],metadata:{requiresDirectObject:!0,requiresIndirectObject:!0,directObjectScope:Wy.ScopeLevel.REACHABLE,indirectObjectScope:Wy.ScopeLevel.VISIBLE},validate(t){let e=t.player,r=t.command.directObject?.entity,n=t.command.indirectObject?.entity,i=t.command.parsed.extras?.direction,o=Uy(t);if(!r)return{valid:!1,error:"no_item"};let s=(n?(0,fe.getInterceptorForAction)(n,cW.IFActions.THROWING):void 0)?.interceptor,c={itemId:r.id,itemName:r.name};if(o.interceptor=s,o.interceptorData=c,s?.preValidate&&n){let u=s.preValidate(n,t.world,e.id,c);if(u!==null)return{valid:u.valid,error:u.error,params:u.params}}let d=t.requireCarriedOrImplicitTake(r);if(!d.ok)return d.error;if(n){let u=t.world.getLocation?.(n.id),m=t.world.getLocation?.(e.id);if(u!==m)return{valid:!1,error:"target_not_here",params:{target:n.name}};if(n.id===e.id)return{valid:!1,error:"self"}}else if(i){let u=dW(i);if(!u)return{valid:!1,error:"no_exit"};let m=t.currentLocation;if(m.has(fe.TraitType.ROOM)&&!fe.RoomBehavior.getExit(m,u))return{valid:!1,error:"no_exit",params:{direction:u}}}if(n||i){let u=fe.IdentityBehavior.getWeight(r);if(u>10)return{valid:!1,error:"too_heavy",params:{item:r.name,weight:u}}}if(s?.postValidate&&n){let u=s.postValidate(n,t.world,e.id,c);if(u!==null)return{valid:u.valid,error:u.error,params:u.params}}return{valid:!0}},execute(t){let e=t.player,r=t.command.directObject.entity,n=t.command.indirectObject?.entity,i=t.command.parsed.extras?.direction,o=Uy(t);o.itemId=r.id,o.itemName=r.name;let a=dW(i);n?(o.throwType="at_target",o.targetId=n.id,o.targetName=n.name):a?(o.throwType="directional",o.direction=a):o.throwType="general",o.weight=fe.IdentityBehavior.getWeight(r);let s=r.name.toLowerCase(),d=(r.get(fe.TraitType.IDENTITY)?.description||"").toLowerCase(),u=["glass","crystal","delicate","fragile","bottle","vase","china","porcelain"];o.isFragile=u.some(h=>s.includes(h)||d.includes(h)),o.params={item:r.name};let m=t.world.getLocation?.(e.id)||"";if(o.willBreak=!1,o.messageId="thrown",o.throwType==="at_target"&&n){o.params.target=n.name;let h=!1;if(n.has(fe.TraitType.ACTOR)){h=Math.random()>.3;let y=fe.ActorBehavior.getCustomProperty(n,"agility"),T=fe.ActorBehavior.getCustomProperty(n,"canCatch");!h&&y>5?(o.targetDucked=!0,o.messageId="target_ducks"):T&&Math.random()>.7&&(o.targetCaught=!0,h=!1,m=n.id,o.messageId="target_catches")}else h=Math.random()>.1;o.hit=h,h?(o.messageId="hits_target",o.targetAngry=n.has(fe.TraitType.ACTOR),o.isFragile&&(o.willBreak=Math.random()>.2,o.willBreak&&(o.messageId="breaks_against")),o.willBreak||(n.has(fe.TraitType.SUPPORTER)?(m=n.id,o.messageId="lands_on"):n.has(fe.TraitType.CONTAINER)&&(n.has(fe.TraitType.OPENABLE)?fe.OpenableBehavior.isOpen(n)?(m=n.id,o.messageId="lands_in"):o.messageId="bounces_off":(m=n.id,o.messageId="lands_in")))):!o.targetDucked&&!o.targetCaught&&(o.messageId="misses_target")}else if(o.throwType==="directional"&&a){o.params.direction=a;let h=t.currentLocation;if(h.has(fe.TraitType.ROOM)){let y=fe.RoomBehavior.getExit(h,a);y?(m=y.destination,o.messageId="sails_through",o.isFragile&&(o.willBreak=Math.random()>.5,o.willBreak&&(o.messageId="breaks_on_impact"))):o.messageId="thrown_direction"}}else o.isFragile?(o.willBreak=Math.random()>.7,o.willBreak?o.messageId="fragile_breaks":o.messageId="thrown_gently"):o.messageId="thrown_down";o.finalLocation=o.willBreak?null:m,o.finalLocation?t.world.moveEntity(r.id,o.finalLocation):o.willBreak&&t.world.moveEntity(r.id,"");let f=o.interceptor,g=o.interceptorData||{};f?.postExecute&&n&&f.postExecute(n,t.world,e.id,g)},blocked(t,e){let r=t.command.directObject?.entity,n=t.command.indirectObject?.entity,i=Uy(t),o=i.interceptor,a=i.interceptorData||{};if(o?.onBlocked&&n&&e.error){let s=o.onBlocked(n,t.world,t.player.id,e.error,a);if(s!==null)return s.map(c=>t.event(c.type,c.payload))}return[t.event("if.event.throw_blocked",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{...e.params,item:r?.name,target:n?.name},reason:e.error,itemId:r?.id,itemName:r?.name,targetId:n?.id,targetName:n?.name})]},report(t){let e=Uy(t),r=[];t.sharedData.implicitTakeEvents&&r.push(...t.sharedData.implicitTakeEvents);let n={messageId:`${t.action.id}.${e.messageId}`,params:e.params,item:e.itemId,itemName:e.itemName,throwType:e.throwType,isFragile:e.isFragile,weight:e.weight,willBreak:e.willBreak,finalLocation:e.finalLocation};if(e.targetId&&(n.target=e.targetId,n.targetName=e.targetName,n.hit=e.hit),e.direction&&(n.direction=e.direction),r.push(t.event("if.event.thrown",n)),e.willBreak){let a={item:e.itemId,itemName:e.itemName,cause:"thrown"};r.push(t.event("if.event.item_destroyed",a))}e.hit&&e.targetAngry&&r.push(t.event("if.event.thrown",{messageId:`${t.action.id}.target_angry`,params:e.params,item:e.itemId,itemName:e.itemName,target:e.targetId,targetName:e.targetName}));let i=e.interceptor,o=e.interceptorData||{};if(i?.postReport){let a=t.command.indirectObject?.entity;if(a){let s=i.postReport(a,t.world,t.player.id,o);for(let c of s)r.push(t.event(c.type,c.payload))}}return r},group:"interaction"}});var bA=p(qy=>{"use strict";Object.defineProperty(qy,"__esModule",{value:!0});qy.throwingAction=void 0;var w4=lW();Object.defineProperty(qy,"throwingAction",{enumerable:!0,get:function(){return w4.throwingAction}})});var uW=p(IA=>{"use strict";Object.defineProperty(IA,"__esModule",{value:!0});IA.getPushingSharedData=N4;function N4(t){return(typeof t.sharedData!="object"||t.sharedData===null)&&(t.sharedData={}),t.sharedData}});var pW=p(Fy=>{"use strict";Object.defineProperty(Fy,"__esModule",{value:!0});Fy.pushingAction=void 0;var ra=E(),mW=ae(),OA=we(),Gy=uW();Fy.pushingAction={id:mW.IFActions.PUSHING,defaultScope:{target:OA.ScopeLevel.REACHABLE},requiredMessages:["no_target","not_visible","not_reachable","too_heavy","wearing_it","button_pushed","button_clicks","switch_toggled","pushed_direction","pushed_nudged","pushed_with_effort","reveals_passage","wont_budge","pushing_does_nothing","fixed_in_place"],metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:OA.ScopeLevel.REACHABLE},validate(t){let e=t.player,r=t.command.directObject?.entity,n=(0,Gy.getPushingSharedData)(t);if(!r)return{valid:!1,error:"no_target"};let o=(0,ra.getInterceptorForAction)(r,mW.IFActions.PUSHING)?.interceptor,a={targetId:r.id,targetName:r.name};if(n.interceptor=o,n.interceptorData=a,o?.preValidate){let c=o.preValidate(r,t.world,e.id,a);if(c!==null)return{valid:c.valid,error:c.error,params:c.params}}let s=t.requireScope(r,OA.ScopeLevel.REACHABLE);if(!s.ok)return s.error;if(r.has(ra.TraitType.WEARABLE)&&t.world.getLocation(r.id)===e.id)return{valid:!1,error:"wearing_it"};if(!r.has(ra.TraitType.PUSHABLE))return r.has(ra.TraitType.SCENERY)?{valid:!1,error:"fixed_in_place"}:{valid:!1,error:"pushing_does_nothing"};if(o?.postValidate){let c=o.postValidate(r,t.world,e.id,a);if(c!==null)return{valid:c.valid,error:c.error,params:c.params}}return{valid:!0}},execute(t){let e=t.command.directObject.entity,r=t.command.parsed.extras?.direction,n=(0,Gy.getPushingSharedData)(t);n.targetId=e.id,n.targetName=e.name,n.direction=r,n.messageParams={};let i=e.get(ra.TraitType.PUSHABLE);switch(n.pushType=i.pushType,i.pushType){case"button":if(n.activated=!0,e.has(ra.TraitType.SWITCHABLE)){let s=e.get(ra.TraitType.SWITCHABLE);n.willToggle=!0,n.currentState=s.isOn,n.newState=!s.isOn,ra.SwitchableBehavior.toggle(e),e.has(ra.TraitType.BUTTON)?n.messageId="button_clicks":n.messageId="switch_toggled",n.messageParams.target=e.name,n.messageParams.newState=n.newState?"on":"off"}else n.messageId="button_pushed",n.messageParams.target=e.name;i.pushSound&&(n.sound=i.pushSound);break;case"heavy":i.requiresStrength&&(n.requiresStrength=i.requiresStrength),r?(n.moved=!0,n.moveDirection=r,n.messageId="pushed_with_effort",n.messageParams.target=e.name,n.messageParams.direction=r):(n.moved=!1,n.nudged=!0,n.messageId="wont_budge",n.messageParams.target=e.name);break;case"moveable":r?(n.moved=!0,n.moveDirection=r,i.revealsPassage?(n.revealsPassage=!0,n.messageId="reveals_passage"):n.messageId="pushed_direction",n.messageParams.target=e.name,n.messageParams.direction=r):(n.moved=!1,n.nudged=!0,n.messageId="pushed_nudged",n.messageParams.target=e.name),i.pushSound&&(n.sound=i.pushSound);break;default:n.messageId="pushing_does_nothing",n.messageParams.target=e.name;break}let o=n.interceptor,a=n.interceptorData||{};o?.postExecute&&o.postExecute(e,t.world,t.player.id,a)},blocked(t,e){let r=t.command.directObject?.entity,n=(0,Gy.getPushingSharedData)(t),i=n.interceptor,o=n.interceptorData||{};if(i?.onBlocked&&r&&e.error){let a=i.onBlocked(r,t.world,t.player.id,e.error,o);if(a!==null)return a.map(s=>t.event(s.type,s.payload))}return[t.event("if.event.pushed",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{target:r?.name,...e.params},reason:e.error,targetId:r?.id,targetName:r?.name})]},report(t){let e=[],r=(0,Gy.getPushingSharedData)(t),n=t.command.directObject.entity;e.push(t.event("if.event.pushed",{messageId:`${t.action.id}.${r.messageId}`,params:r.messageParams,target:r.targetId,targetName:r.targetName,direction:r.direction,pushType:r.pushType,activated:r.activated,willToggle:r.willToggle,currentState:r.currentState,newState:r.newState,sound:r.sound,moved:r.moved,moveDirection:r.moveDirection,nudged:r.nudged,revealsPassage:r.revealsPassage,requiresStrength:r.requiresStrength}));let i=r.interceptor,o=r.interceptorData||{};if(i?.postReport){let a=i.postReport(n,t.world,t.player.id,o);for(let s of a)e.push(t.event(s.type,s.payload))}return e},group:"device_manipulation"}});var gW=p(fW=>{"use strict";Object.defineProperty(fW,"__esModule",{value:!0})});var SA=p(na=>{"use strict";var D4=na&&na.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),L4=na&&na.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&D4(e,t,r)};Object.defineProperty(na,"__esModule",{value:!0});na.pushingAction=void 0;var M4=pW();Object.defineProperty(na,"pushingAction",{enumerable:!0,get:function(){return M4.pushingAction}});L4(gW(),na)});var yW=p(Vy=>{"use strict";Object.defineProperty(Vy,"__esModule",{value:!0});Vy.pullingAction=void 0;var Zu=E(),P4=ae(),AA=we();function hW(t){return t.sharedData}Vy.pullingAction={id:P4.IFActions.PULLING,defaultScope:{target:AA.ScopeLevel.REACHABLE},group:"interaction",metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:AA.ScopeLevel.REACHABLE},requiredMessages:["no_target","not_visible","not_reachable","cant_pull_that","worn","pulled","nothing_happens","already_pulled"],validate(t){let e=t.command.directObject?.entity;if(!e)return{valid:!1,error:"no_target"};let r=t.requireScope(e,AA.ScopeLevel.REACHABLE);return r.ok?e.has(Zu.TraitType.PULLABLE)?e.has(Zu.TraitType.WEARABLE)&&e.get(Zu.TraitType.WEARABLE)?.isWorn?{valid:!1,error:"worn",params:{target:e.name}}:e.get(Zu.TraitType.PULLABLE).state==="pulled"?{valid:!1,error:"already_pulled",params:{target:e.name}}:{valid:!0}:{valid:!1,error:"cant_pull_that",params:{target:e.name}}:r.error},execute(t){let e=t.command.directObject.entity,r=e.get(Zu.TraitType.PULLABLE),n=hW(t);n.targetId=e.id,n.targetName=e.name,n.pullCount=r.pullCount||0,n.pullType=r.pullType,r.state="pulled",r.pullCount=(r.pullCount||0)+1},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.pulled",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{target:r?.name,...e.params},reason:e.error,targetId:r?.id,targetName:r?.name})]},report(t){let e=[],r=hW(t);return e.push(t.event("if.event.pulled",{messageId:`${t.action.id}.pulled`,params:{target:r.targetName},target:r.targetId,targetName:r.targetName,pullCount:r.pullCount,pullType:r.pullType})),e}}});var EW=p(TW=>{"use strict";Object.defineProperty(TW,"__esModule",{value:!0})});var RA=p(ia=>{"use strict";var k4=ia&&ia.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),B4=ia&&ia.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&k4(e,t,r)};Object.defineProperty(ia,"__esModule",{value:!0});ia.pullingAction=void 0;var x4=yW();Object.defineProperty(ia,"pullingAction",{enumerable:!0,get:function(){return x4.pullingAction}});B4(EW(),ia)});var wA=p(CA=>{"use strict";Object.defineProperty(CA,"__esModule",{value:!0});CA.createCapabilityDispatchAction=W4;var vW=E(),j4=we();function _W(t,e){return t.map(r=>e.event(r.type,r.payload))}function W4(t){return{id:t.actionId,group:t.group,metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:t.scope??j4.ScopeLevel.REACHABLE},requiredMessages:["no_target","cant_do_that"],validate(e){let r=e.command.directObject?.entity;if(!r)return{valid:!1,error:t.noTargetError};let n=(0,vW.findTraitWithCapability)(r,t.actionId);if(!n)return{valid:!1,error:t.cantDoThatError,params:{target:r.name}};let i=(0,vW.getBehaviorForCapability)(n,t.actionId);if(!i)return console.warn(`Capability dispatch: trait "${n.type}" claims "${t.actionId}" but no behavior registered`),{valid:!1,error:t.cantDoThatError,params:{target:r.name}};let o={},a=i.validate(r,e.world,e.player.id,o);return a.valid?{valid:!0,data:{trait:n,behavior:i,entityId:r.id,entityName:r.name,sharedData:o}}:{valid:!1,error:a.error,params:a.params}},execute(e){let r=e.validationResult?.data,n=e.command.directObject?.entity;!n||!r?.behavior||r.behavior.execute(n,e.world,e.player.id,r.sharedData)},blocked(e,r){let n=e.validationResult?.data??r.data,i=e.command.directObject?.entity;if(i&&n?.behavior){let o=n.behavior.blocked(i,e.world,e.player.id,r.error||t.cantDoThatError,n.sharedData);return _W(o,e)}return[e.event("if.event.capability_blocked",{blocked:!0,messageId:r.error||t.cantDoThatError,actionId:t.actionId,reason:r.error||t.cantDoThatError,targetId:i?.id,targetName:i?.name,...r.params})]},report(e){let r=e.validationResult?.data,n=e.command.directObject?.entity;if(!n||!r?.behavior)return[];let i=r.behavior.report(n,e.world,e.player.id,r.sharedData);return _W(i,e)}}}});var bW=p(Yy=>{"use strict";Object.defineProperty(Yy,"__esModule",{value:!0});Yy.loweringAction=void 0;var U4=wA(),H4=ae();Yy.loweringAction=(0,U4.createCapabilityDispatchAction)({actionId:H4.IFActions.LOWERING,group:"manipulation",noTargetError:"if.lower.no_target",cantDoThatError:"if.lower.cant_lower_that"})});var NA=p(zy=>{"use strict";Object.defineProperty(zy,"__esModule",{value:!0});zy.loweringAction=void 0;var q4=bW();Object.defineProperty(zy,"loweringAction",{enumerable:!0,get:function(){return q4.loweringAction}})});var IW=p(Ky=>{"use strict";Object.defineProperty(Ky,"__esModule",{value:!0});Ky.raisingAction=void 0;var G4=wA(),F4=ae();Ky.raisingAction=(0,G4.createCapabilityDispatchAction)({actionId:F4.IFActions.RAISING,group:"manipulation",noTargetError:"if.raise.no_target",cantDoThatError:"if.raise.cant_raise_that"})});var DA=p($y=>{"use strict";Object.defineProperty($y,"__esModule",{value:!0});$y.raisingAction=void 0;var V4=IW();Object.defineProperty($y,"raisingAction",{enumerable:!0,get:function(){return V4.raisingAction}})});var LA=p(Vi=>{"use strict";Object.defineProperty(Vi,"__esModule",{value:!0});Vi.analyzeWearableContext=Y4;Vi.checkWearingConflicts=z4;Vi.checkRemovalBlockers=K4;Vi.buildWearableEventParams=$4;Vi.createWearableErrorEvent=Q4;Vi.createWearableSuccessEvent=X4;Vi.isWornByActor=Z4;Vi.hasRemovalRestrictions=J4;var Fi=E();function Y4(t,e,r){let n=e.get(Fi.TraitType.WEARABLE),i=t.world.getContents(r.id);return{item:e,actor:r,wearableTrait:n,inventory:i}}function z4(t){let{item:e,wearableTrait:r,inventory:n}=t;if(r.bodyPart&&r.layer===void 0){let i=n.find(o=>{if(o.id===e.id||!o.has(Fi.TraitType.WEARABLE))return!1;let a=o.get(Fi.TraitType.WEARABLE);return a.worn&&a.bodyPart===r.bodyPart&&a.layer===void 0});if(i)return i}if(r.layer!==void 0&&r.bodyPart){let i=n.filter(o=>o.has(Fi.TraitType.WEARABLE)?o.get(Fi.TraitType.WEARABLE).worn:!1);for(let o of i){let a=o.get(Fi.TraitType.WEARABLE);if(a.layer!==void 0&&a.layer>r.layer&&a.bodyPart===r.bodyPart)return o}}return null}function K4(t){let{item:e,wearableTrait:r,inventory:n}=t;return r.layer!==void 0&&r.bodyPart&&n.find(o=>{if(o.id===e.id||!o.has(Fi.TraitType.WEARABLE))return!1;let a=o.get(Fi.TraitType.WEARABLE);return a.worn&&a.layer!==void 0&&a.layer>r.layer&&a.bodyPart===r.bodyPart})||null}function $4(t,e){let r={item:t.name};return e.bodyPart&&(r.bodyPart=e.bodyPart),e.layer!==void 0&&(r.layer=e.layer),r}function Q4(t,e,r,n){return t.event("action.error",{actionId:t.action.id,messageId:e,reason:r,params:n||{}})}function X4(t,e,r){return t.event("action.success",{actionId:t.action.id,messageId:e,params:r})}function Z4(t,e){if(!t.has(Fi.TraitType.WEARABLE))return!1;let r=t.get(Fi.TraitType.WEARABLE);return r.worn&&r.wornBy===e.id}function J4(t){return!!t.cursed}});var AW=p(Xy=>{"use strict";Object.defineProperty(Xy,"__esModule",{value:!0});Xy.wearingAction=void 0;var Qy=E(),eJ=ae(),OW=Gi(),MA=LA();function SW(t){return t.sharedData}Xy.wearingAction={id:eJ.IFActions.WEARING,defaultScope:{item:OW.ScopeLevel.REACHABLE},requiredMessages:["no_target","not_wearable","not_held","already_wearing","worn","cant_wear_that","hands_full"],group:"wearable_manipulation",validate(t){let e=t.player,r=t.command.directObject?.entity;if(!r)return{valid:!1,error:"no_target"};if(!r.has(Qy.TraitType.WEARABLE))return{valid:!1,error:"not_wearable"};let n=t.requireCarriedOrImplicitTake(r);return n.ok?Qy.WearableBehavior.canWear(r,e)?{valid:!0}:r.get(Qy.TraitType.WEARABLE).worn?{valid:!1,error:"already_wearing"}:{valid:!1,error:"cant_wear_that"}:n.error},execute(t){let e=t.player,r=t.command.directObject.entity,n=SW(t);n.itemId=r.id,n.itemName=r.name;let i=(0,MA.analyzeWearableContext)(t,r,e),{wearableTrait:o}=i;n.bodyPart=o.bodyPart,n.layer=o.layer;let a=(0,MA.checkWearingConflicts)(i);if(a){n.failed=!0,n.errorMessageId=o.layer!==void 0?"hands_full":"already_wearing",n.errorReason=n.errorMessageId,n.errorParams={item:a.name};return}let s=Qy.WearableBehavior.wear(r,e);if(!s.success){n.failed=!0,s.alreadyWorn?(n.errorMessageId="already_wearing",n.errorReason="already_wearing",n.errorParams={item:r.name}):s.wornByOther?(n.errorMessageId="already_wearing",n.errorReason="worn_by_other",n.errorParams={item:r.name,wornBy:s.wornByOther}):(n.errorMessageId="cant_wear_that",n.errorReason="cant_wear_that",n.errorParams={item:r.name});return}n.failed=!1,n.params=(0,MA.buildWearableEventParams)(r,o),n.messageId="worn"},report(t){let e=SW(t),r=[];return e.failed?[t.event("if.event.wear_blocked",{messageId:`${t.action.id}.${e.errorMessageId}`,params:e.errorParams,itemId:e.itemId,itemName:e.itemName,reason:e.errorReason})]:(t.sharedData.implicitTakeEvents&&r.push(...t.sharedData.implicitTakeEvents),r.push(t.event("if.event.worn",{messageId:`${t.action.id}.${e.messageId}`,params:e.params,itemId:e.itemId,itemName:e.itemName,actorId:t.player.id,bodyPart:e.bodyPart,layer:e.layer})),r)},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.wear_blocked",{messageId:`${t.action.id}.${e.error}`,params:e.params||{},itemId:r?.id,itemName:r?.name,reason:e.error})]},metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:OW.ScopeLevel.REACHABLE}}});var PA=p(Zy=>{"use strict";Object.defineProperty(Zy,"__esModule",{value:!0});Zy.wearingAction=void 0;var tJ=AW();Object.defineProperty(Zy,"wearingAction",{enumerable:!0,get:function(){return tJ.wearingAction}})});var wW=p(tT=>{"use strict";Object.defineProperty(tT,"__esModule",{value:!0});tT.takingOffAction=void 0;var Jy=E(),rJ=ae(),RW=Gi(),eT=LA();function CW(t){return t.sharedData}tT.takingOffAction={id:rJ.IFActions.TAKING_OFF,defaultScope:{item:RW.ScopeLevel.CARRIED},requiredMessages:["no_target","not_wearing","removed","cant_remove","prevents_removal"],group:"wearable_manipulation",validate(t){let e=t.player,r=t.command.directObject?.entity;if(!r)return{valid:!1,error:"no_target"};if(!r.has(Jy.TraitType.WEARABLE))return{valid:!1,error:"not_wearing"};if(!Jy.WearableBehavior.canRemove(r,e)){let n=r.get(Jy.TraitType.WEARABLE);return n.worn?n.wornBy!==e.id?{valid:!1,error:"not_wearing"}:{valid:!1,error:"cant_remove"}:{valid:!1,error:"not_wearing"}}return{valid:!0}},execute(t){let e=t.player,r=t.command.directObject.entity,n=CW(t);n.itemId=r.id,n.itemName=r.name;let i=(0,eT.analyzeWearableContext)(t,r,e),{wearableTrait:o}=i;n.bodyPart=o.bodyPart,n.layer=o.layer;let a=(0,eT.checkRemovalBlockers)(i);if(a){n.failed=!0,n.errorMessageId="prevents_removal",n.errorReason="prevents_removal",n.errorParams={blocking:a.name};return}if((0,eT.hasRemovalRestrictions)(o)){n.failed=!0,n.errorMessageId="cant_remove",n.errorReason="cant_remove",n.errorParams={item:r.name};return}let s=Jy.WearableBehavior.remove(r,e);if(!s.success){n.failed=!0,s.notWorn?(n.errorMessageId="not_wearing",n.errorReason="not_wearing",n.errorParams={item:r.name}):s.wornByOther?(n.errorMessageId="not_wearing",n.errorReason="worn_by_other",n.errorParams={item:r.name,wornBy:s.wornByOther}):(n.errorMessageId="cant_remove",n.errorReason="cant_remove",n.errorParams={item:r.name});return}n.failed=!1,n.params=(0,eT.buildWearableEventParams)(r,o),n.messageId="removed"},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.take_off_blocked",{messageId:`${t.action.id}.${e.error}`,params:e.params||{},itemId:r?.id,itemName:r?.name,reason:e.error})]},report(t){let e=CW(t);return e.failed?[t.event("if.event.take_off_blocked",{messageId:`${t.action.id}.${e.errorMessageId}`,params:e.errorParams||{},itemId:e.itemId,itemName:e.itemName,reason:e.errorReason})]:[t.event("if.event.removed",{messageId:`${t.action.id}.${e.messageId}`,params:e.params,itemId:e.itemId,itemName:e.itemName,actorId:t.player.id,bodyPart:e.bodyPart,layer:e.layer})]},metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:RW.ScopeLevel.CARRIED}}});var kA=p(rT=>{"use strict";Object.defineProperty(rT,"__esModule",{value:!0});rT.takingOffAction=void 0;var nJ=wW();Object.defineProperty(rT,"takingOffAction",{enumerable:!0,get:function(){return nJ.takingOffAction}})});var DW=p(nT=>{"use strict";Object.defineProperty(nT,"__esModule",{value:!0});nT.eatingAction=void 0;var si=E(),iJ=ae(),BA=we();function NW(t){return t.sharedData}nT.eatingAction={id:iJ.IFActions.EATING,defaultScope:{item:BA.ScopeLevel.REACHABLE},targetRequirements:{trait:si.TraitType.EDIBLE,description:"edible"},requiresHolding:!0,requiredMessages:["no_item","not_visible","not_reachable","not_edible","is_drink","already_consumed","eaten","eaten_all","eaten_some","delicious","tasty","bland","awful","filling","still_hungry","poisonous"],metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:BA.ScopeLevel.REACHABLE},validate(t){let e=t.command.directObject?.entity;if(!e)return{valid:!1,error:"no_item"};let r=t.requireScope(e,BA.ScopeLevel.REACHABLE);if(!r.ok)return r.error;if(!e.has(si.TraitType.EDIBLE))return{valid:!1,error:"not_edible",params:{item:e.name}};if(si.EdibleBehavior.isLiquid(e))return{valid:!1,error:"is_drink",params:{item:e.name}};if(!si.EdibleBehavior.canConsume(e))return{valid:!1,error:"already_consumed",params:{item:e.name}};let n=t.requireCarriedOrImplicitTake(e);return n.ok?{valid:!0}:n.error},execute(t){let e=t.command.directObject.entity,r=t.player,n=si.EdibleBehavior.getServings(e),i=si.EdibleBehavior.getNutrition(e),o=si.EdibleBehavior.getTaste(e),a=si.EdibleBehavior.getEffects(e),s=si.EdibleBehavior.satisfiesHunger(e);si.EdibleBehavior.consume(e,r);let c=si.EdibleBehavior.getServings(e),d={item:e.id,itemName:e.name};i!==void 0&&i!==1&&(d.nutrition=i),n>1&&(d.servings=n,d.servingsRemaining=c),a&&a.length>0&&(d.effects=a),s!==void 0&&(d.satisfiesHunger=s);let u="eaten";if(a&&a.includes("poison"))u="poisonous";else if(o)switch(o){case"delicious":u="delicious";break;case"tasty":case"good":u="tasty";break;case"bland":case"plain":u="bland";break;case"awful":case"terrible":u="awful";break}else n>1&&c>0?u="eaten_some":n>1&&c===0?u="eaten_all":s===!0?u="filling":s===!1&&(u="still_hungry");let m=NW(t);m.itemId=e.id,m.itemName=e.name,m.messageId=u,m.eventData=d},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.eaten",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{item:r?.name,...e.params},reason:e.error,itemId:r?.id,itemName:r?.name})]},report(t){let e=[],r=NW(t);return t.sharedData.implicitTakeEvents&&e.push(...t.sharedData.implicitTakeEvents),e.push(t.event("if.event.eaten",{messageId:`${t.action.id}.${r.messageId}`,params:{item:r.eventData?.itemName},...r.eventData})),e},group:"interaction"}});var MW=p(LW=>{"use strict";Object.defineProperty(LW,"__esModule",{value:!0})});var xA=p(oa=>{"use strict";var oJ=oa&&oa.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),aJ=oa&&oa.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&oJ(e,t,r)};Object.defineProperty(oa,"__esModule",{value:!0});oa.eatingAction=void 0;var sJ=DW();Object.defineProperty(oa,"eatingAction",{enumerable:!0,get:function(){return sJ.eatingAction}});aJ(MW(),oa)});var kW=p(iT=>{"use strict";Object.defineProperty(iT,"__esModule",{value:!0});iT.drinkingAction=void 0;var ln=E(),cJ=ae(),jA=we();function PW(t){return t.sharedData}function dJ(t,e,r,n,i){let o="drunk";if(e){e.nutrition&&(n.nutrition=e.nutrition),e.portions&&(n.portions=e.portions,n.portionsRemaining=(e.portions||1)-1,o=n.portionsRemaining>0?"drunk_some":"drunk_all");let a=e.taste;if(a){let c={refreshing:"refreshing",satisfying:"satisfying",bitter:"bitter",sweet:"sweet",strong:"strong",alcoholic:"strong"};c[a]&&(o=c[a])}if(e.effects){n.effects=e.effects;let c=e.effects;c.includes("magic")?o="magical_effects":c.includes("healing")&&(o="healing")}let s=e.satisfiesThirst;s!==void 0&&(n.satisfiesThirst=s,s===!0&&o==="drunk"?o="thirst_quenched":s===!1&&(o="still_thirsty"))}if(r&&r.containsLiquid){n.fromContainer=!0,r.liquidType&&(n.liquidType=r.liquidType);let a=r.liquidAmount;a!==void 0?(n.liquidAmount=a,n.liquidRemaining=Math.max(0,a-1),n.liquidRemaining===0?o="empty_now":o==="drunk"&&(o="from_container",r.liquidType&&(i.liquidType=r.liquidType))):o="drunk_from"}if(o==="drunk"||o==="drunk_some"){let a={sip:"sipped",quaff:"quaffed",swallow:"gulped"};a[t]&&(o=a[t])}return o}iT.drinkingAction={id:cJ.IFActions.DRINKING,defaultScope:{item:jA.ScopeLevel.REACHABLE},group:"interaction",metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:jA.ScopeLevel.REACHABLE},requiredMessages:["no_item","not_visible","not_reachable","not_drinkable","already_consumed","container_closed","drunk","drunk_all","drunk_some","drunk_from","refreshing","satisfying","bitter","sweet","strong","thirst_quenched","still_thirsty","magical_effects","healing","from_container","empty_now","some_remains","sipped","quaffed","gulped"],validate(t){let e=t.command.directObject?.entity;if(!e)return{valid:!1,error:"no_item"};let r=t.requireScope(e,jA.ScopeLevel.REACHABLE);if(!r.ok)return r.error;let n=!1,i,o;return e.has(ln.TraitType.EDIBLE)&&(i=e.get(ln.TraitType.EDIBLE),n=i.isDrink===!0),e.has(ln.TraitType.CONTAINER)&&(o=e.get(ln.TraitType.CONTAINER),!n&&o.containsLiquid&&(n=!0)),n?i&&i.consumed?{valid:!1,error:"already_consumed",params:{item:e.name}}:o&&e.has(ln.TraitType.OPENABLE)&&!ln.OpenableBehavior.isOpen(e)?{valid:!1,error:"container_closed",params:{item:e.name}}:{valid:!0}:{valid:!1,error:"not_drinkable",params:{item:e.name}}},execute(t){let e=t.player,r=t.command.directObject.entity,n=PW(t),i=r.has(ln.TraitType.EDIBLE)?r.get(ln.TraitType.EDIBLE):void 0,o=r.has(ln.TraitType.CONTAINER)?r.get(ln.TraitType.CONTAINER):void 0,s=t.world.getLocation(r.id)===e.id,c={item:r.id,itemName:r.name},d={item:r.name},u=i?ln.EdibleBehavior.getServings(r):0,m=t.command.parsed.structure.verb?.text.toLowerCase()||"drink",f=dJ(m,i,o,c,d);if(s||t.world.moveEntity(r.id,e.id),i){ln.EdibleBehavior.consume(r,e);let g=ln.EdibleBehavior.getServings(r);u>1&&(c.portions=u,c.portionsRemaining=g)}if(o&&o.liquidAmount!==void 0){let g=o.liquidAmount,h=Math.max(0,g-1);o.liquidAmount=h,c.liquidAmount=g,c.liquidRemaining=h}n.itemId=r.id,n.itemName=r.name,n.isHeld=s,n.messageId=f,n.params=d,n.eventData=c},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.drunk",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{item:r?.name,...e.params},reason:e.error,itemId:r?.id,itemName:r?.name})]},report(t){let e=[],r=PW(t);if(!r.isHeld){let n={implicit:!0,item:r.itemId,itemName:r.itemName};e.push(t.event("if.event.taken",n))}return e.push(t.event("if.event.drunk",{messageId:`${t.action.id}.${r.messageId}`,params:r.params||{},...r.eventData})),e}}});var xW=p(BW=>{"use strict";Object.defineProperty(BW,"__esModule",{value:!0})});var WA=p(aa=>{"use strict";var lJ=aa&&aa.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),uJ=aa&&aa.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&lJ(e,t,r)};Object.defineProperty(aa,"__esModule",{value:!0});aa.drinkingAction=void 0;var mJ=kW();Object.defineProperty(aa,"drinkingAction",{enumerable:!0,get:function(){return mJ.drinkingAction}});uJ(xW(),aa)});var WW=p(oT=>{"use strict";Object.defineProperty(oT,"__esModule",{value:!0});oT.talkingAction=void 0;var Ju=E(),pJ=ae(),fJ=we();function jW(t){return t.sharedData}oT.talkingAction={id:pJ.IFActions.TALKING,requiredMessages:["no_target","not_visible","too_far","not_actor","self","not_available","talked","no_response","acknowledges","first_meeting","greets_back","formal_greeting","casual_greeting","greets_again","remembers_you","friendly_greeting","has_topics","nothing_to_say"],validate(t){let e=t.player,r=t.command.directObject?.entity;if(!r)return{valid:!1,error:"no_target"};if(!t.canSee(r))return{valid:!1,error:"not_visible"};let n=t.world.getLocation(r.id),i=t.world.getLocation(e.id);if(n!==i)return{valid:!1,error:"too_far"};if(!r.has(Ju.TraitType.ACTOR))return{valid:!1,error:"not_actor",params:{target:r.name}};if(r.id===e.id)return{valid:!1,error:"self"};let a=r.get(Ju.TraitType.ACTOR)?.conversation||Ju.ActorBehavior.getCustomProperty(r,"conversation");return a&&a.isAvailable!==void 0&&!a.isAvailable?{valid:!1,error:"not_available",params:{target:r.name}}:{valid:!0}},execute(t){let e=t.command.directObject?.entity,r=jW(t),n={target:e.id,targetName:e.name},o=e.get(Ju.TraitType.ACTOR)?.conversation||Ju.ActorBehavior.getCustomProperty(e,"conversation"),a="talked";o?(n.conversationState=o.state||"initial",n.hasTopics=!!(o.topics&&Object.keys(o.topics).length>0),o.hasGreeted?o.relationship==="friendly"?a="friendly_greeting":o.remembersPlayer?a="remembers_you":a="greets_again":(n.firstMeeting=!0,o.personality==="formal"?a="formal_greeting":o.personality==="casual"?a="casual_greeting":a="first_meeting"),["formal_greeting","casual_greeting","first_meeting","friendly_greeting","remembers_you"].includes(a)||(n.hasTopics?a="has_topics":a==="greets_again"&&!n.hasTopics&&o.topics!==void 0&&(a="nothing_to_say"))):a="no_response",r.targetName=e.name,r.messageId=a,r.eventData=n},blocked(t,e){let r=t.command.directObject?.entity;return[t.event("if.event.talk_blocked",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{...e.params,target:r?.name},reason:e.error,targetId:r?.id,targetName:r?.name})]},report(t){let e=[],r=jW(t);return e.push(t.event("if.event.talked",{messageId:`${t.action.id}.${r.messageId||"talked"}`,params:{target:r.targetName},...r.eventData})),e},group:"social",metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:fJ.ScopeLevel.AWARE}}});var HW=p(UW=>{"use strict";Object.defineProperty(UW,"__esModule",{value:!0})});var UA=p(sa=>{"use strict";var gJ=sa&&sa.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),hJ=sa&&sa.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&gJ(e,t,r)};Object.defineProperty(sa,"__esModule",{value:!0});sa.talkingAction=void 0;var yJ=WW();Object.defineProperty(sa,"talkingAction",{enumerable:!0,get:function(){return yJ.talkingAction}});hJ(HW(),sa)});var qW=p(HA=>{"use strict";Object.defineProperty(HA,"__esModule",{value:!0});HA.findWieldedWeapon=TJ;var Mc=E();function TJ(t,e){let n=e.getContents(t.id).filter(o=>o.has(Mc.TraitType.WEAPON));if(n.length===0)return;let i=n.filter(o=>o.has(Mc.TraitType.EQUIPPED)?o.get(Mc.TraitType.EQUIPPED)?.isEquipped:!1);return i.length>0?i.reduce((o,a)=>{let s=o.get(Mc.TraitType.WEAPON);return a.get(Mc.TraitType.WEAPON).damage>s.damage?a:o}):n.reduce((o,a)=>{let s=o.get(Mc.TraitType.WEAPON);return a.get(Mc.TraitType.WEAPON).damage>s.damage?a:o})}});var qA=p(aT=>{"use strict";Object.defineProperty(aT,"__esModule",{value:!0});aT.findWieldedWeapon=void 0;var EJ=qW();Object.defineProperty(aT,"findWieldedWeapon",{enumerable:!0,get:function(){return EJ.findWieldedWeapon}})});var FW=p(cT=>{"use strict";Object.defineProperty(cT,"__esModule",{value:!0});cT.attackingAction=void 0;var Pc=E(),GW=ae(),vJ=we(),_J=qA();function sT(t){return t.sharedData}cT.attackingAction={id:GW.IFActions.ATTACKING,group:"interaction",metadata:{requiresDirectObject:!0,requiresIndirectObject:!1,directObjectScope:vJ.ScopeLevel.REACHABLE},requiredMessages:["no_target","not_visible","not_reachable","self","not_holding_weapon","attacked","attacked_with","hit","hit_with","struck","struck_with","punched","kicked","unarmed_attack","broke","smashed","destroyed","shattered","already_damaged","partial_break","defends","dodges","retaliates","flees","peaceful_solution","no_fighting","unnecessary_violence"],validate(t){let e=t.player,r=t.command.directObject?.entity,n=t.command.instrument?.entity??t.command.indirectObject?.entity,i=sT(t);if(!r)return{valid:!1,error:"no_target"};let a=(0,Pc.getInterceptorForAction)(r,GW.IFActions.ATTACKING)?.interceptor,s={};if(i.interceptor=a,i.interceptorData=s,a?.preValidate){let c=a.preValidate(r,t.world,e.id,s);if(c!==null)return{valid:c.valid,error:c.error,params:c.params}}if(!t.canSee(r))return{valid:!1,error:"not_visible",params:{target:r.name}};if(!t.canReach(r))return{valid:!1,error:"not_reachable",params:{target:r.name}};if(r.id===e.id)return{valid:!1,error:"self"};if(n){let c=t.requireCarriedOrImplicitTake(n);if(!c.ok)return c.error}if(r.has(Pc.TraitType.COMBATANT)){let c=r.get(Pc.TraitType.COMBATANT);if(c&&!c.isAlive)return{valid:!1,error:"already_dead",params:{target:r.name}};if(!a)return{valid:!1,error:"violence_not_the_answer",params:{target:r.name}}}if(a?.postValidate){let c=a.postValidate(r,t.world,e.id,s);if(c!==null)return{valid:c.valid,error:c.error,params:c.params}}return{valid:!0}},execute(t){let e=t.command.directObject.entity,r=t.command.instrument?.entity??t.command.indirectObject?.entity,n=!1,i=sT(t),o=t.command.parsed.action||t.command.parsed.structure.verb?.text||"attack";if(!r&&(o==="stab"||o==="slash"||o==="cut"||e.has(Pc.TraitType.COMBATANT))){if(r=(0,_J.findWieldedWeapon)(t.player,t.world),!r){let s=t.world.getContents(t.player.id);r=Pc.AttackBehavior.inferWeapon(s)}n=!!r}if(e.has(Pc.TraitType.COMBATANT)){let a=i.interceptor,s=i.interceptorData||{};if(s.weaponId=r?.id,s.weaponName=r?.name,s.weaponInferred=n,s.verb=o,s.targetId=e.id,s.targetName=e.name,a?.postExecute){a.postExecute(e,t.world,t.player.id,s);let c=s.attackResult;Object.assign(t.sharedData,{attackResult:c||{success:!0,type:"missed",damage:0,remainingHitPoints:0,targetDestroyed:!1},weaponUsed:r?.id,weaponInferred:n,customMessage:s.customMessage,combatResult:s.combatResult,usedCombatService:s.usedCombatService??!1})}else Object.assign(t.sharedData,{attackResult:{success:!1,type:"missed",damage:0,remainingHitPoints:0,targetDestroyed:!1},weaponUsed:r?.id,weaponInferred:n,usedCombatService:!1})}else{let a=Pc.AttackBehavior.attack(e,r,t.world),s={success:a.success,type:a.type,damage:a.damage,remainingHitPoints:a.remainingHitPoints,targetDestroyed:a.targetDestroyed,targetKilled:a.targetKilled,itemsDropped:a.itemsDropped,debrisCreated:a.debrisCreated,exitRevealed:a.exitRevealed,transformedTo:a.transformedTo};Object.assign(t.sharedData,{attackResult:s,weaponUsed:r?.id,weaponInferred:n,customMessage:a.message,usedCombatService:!1})}},blocked(t,e){let r=t.command.directObject?.entity,n=sT(t),i=n.interceptor,o=n.interceptorData||{};if(i?.onBlocked&&r&&e.error){let a=i.onBlocked(r,t.world,t.player.id,e.error,o);if(a!==null)return a.map(s=>t.event(s.type,s.payload))}return[t.event("if.event.attacked",{blocked:!0,messageId:`${t.action.id}.${e.error}`,params:{target:r?.name,...e.params},reason:e.error,targetId:r?.id,targetName:r?.name})]},report(t){let e=t.command.directObject.entity,r=t.sharedData.weaponUsed,n=r?t.world.getEntity(r):void 0,i=t.command.parsed.action||"attack",o=t.sharedData.attackResult,a=t.sharedData.customMessage,s=t.sharedData.usedCombatService,c=t.sharedData.combatResult,d=sT(t),u=[];if(t.sharedData.implicitTakeEvents&&u.push(...t.sharedData.implicitTakeEvents),!o.success&&!s)return[t.event("if.event.attacked",{messageId:`${t.action.id}.${a||"attack_ineffective"}`,params:{target:e.name},target:e.id,targetName:e.name,failed:!0})];let m={target:e.id,targetName:e.name,weapon:n?.id,weaponName:n?.name,unarmed:!n},f={target:e.name,weapon:n?.name};u.push(t.event("if.event.attacked",m));let g;if(s&&c)g=c.messageId,f.damage=c.damage,f.attackerName=t.player.name,f.targetName=e.name,c.messageData&&Object.assign(f,c.messageData);else switch(o.type){case"broke":g="target_broke",o.debrisCreated?.length&&(f.debris=o.debrisCreated.length);break;case"damaged":g="target_damaged",f.damage=o.damage,f.remaining=o.remainingHitPoints;break;case"destroyed":if(g="target_destroyed",o.transformedTo){let T=t.world.getEntity(o.transformedTo);f.transformedTo=T?.name}o.exitRevealed&&(f.exitRevealed=o.exitRevealed);break;case"killed":g="killed_target",o.itemsDropped?.length&&(f.itemsDropped=o.itemsDropped.length);break;case"knocked_out":g="combat.attack.knocked_out",f.damage=o.damage;break;case"missed":g="combat.attack.missed";break;case"hit":g=n?"hit_with":"hit_target",f.damage=o.damage;break;default:g="attacked"}if(u[0]=t.event("if.event.attacked",{messageId:`${t.action.id}.${a||g}`,params:f,...m}),o.itemsDropped?.length)for(let T of o.itemsDropped){let I=t.world.getEntity(T);I&&u.push(t.event("if.event.dropped",{item:T,itemName:I.name,dropper:e.id,dropperName:e.name}))}o.exitRevealed&&u.push(t.event("if.event.exit_revealed",{direction:o.exitRevealed,room:t.world.getLocation(t.player.id)}));let h=d.interceptor,y=d.interceptorData||{};if(h?.postReport){let T=h.postReport(e,t.world,t.player.id,y);for(let I of T)u.push(t.event(I.type,I.payload))}return o.targetKilled&&u.push(t.event("if.event.death",{target:e.id,targetName:e.name,killedBy:t.player.id})),o.targetKnockedOut&&u.push(t.event("if.event.knocked_out",{target:e.id,targetName:e.name,knockedOutBy:t.player.id})),u}}});var YW=p(VW=>{"use strict";Object.defineProperty(VW,"__esModule",{value:!0})});var GA=p(ca=>{"use strict";var bJ=ca&&ca.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),IJ=ca&&ca.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&bJ(e,t,r)};Object.defineProperty(ca,"__esModule",{value:!0});ca.attackingAction=void 0;var OJ=FW();Object.defineProperty(ca,"attackingAction",{enumerable:!0,get:function(){return OJ.attackingAction}});IJ(YW(),ca)});var zW=p(dT=>{"use strict";Object.defineProperty(dT,"__esModule",{value:!0});dT.savingAction=void 0;var SJ=Ve(),AJ=ae();function RJ(t,e){let r=t.world.getCapability("sharedData")||{},n=r.score||0,i=r.moves||0,o=r.turnCount||0,a=e==="quicksave"||t.command.parsed.extras?.quick,s=t.command.parsed.extras?.auto,c={saveName:e!=="default"?e:void 0,autosave:s,timestamp:Date.now(),metadata:{score:n,moves:i,turnCount:o,quickSave:a}},d={saveName:e,timestamp:c.timestamp,metadata:{score:n,moves:i,turnCount:o,quickSave:a}};return{saveName:e,isQuickSave:a,isAutoSave:s,score:n,moves:i,turnCount:o,saveContext:c,eventData:d}}dT.savingAction={id:AJ.IFActions.SAVING,requiredMessages:["game_saved","game_saved_as","save_successful","save_slot","overwrite_save","save_details","quick_save","auto_save","save_failed","no_save_slots","invalid_save_name","save_not_allowed","save_in_progress","confirm_overwrite","save_reminder","saved_locally","saved_to_cloud","save_exported"],validate(t){let e=t.command.parsed.extras?.name||t.command.parsed.extras?.slot||t.command.indirectObject?.parsed?.text||"default",n=(t.world.getCapability("sharedData")||{}).saveRestrictions||{};return n.disabled?{valid:!1,error:"save_not_allowed"}:n.inProgress?{valid:!1,error:"save_in_progress"}:e.length>50||/[<>:"/\\|?*]/.test(e)?{valid:!1,error:"invalid_save_name"}:{valid:!0}},execute(t){let e=t.command.parsed.extras?.name||t.command.parsed.extras?.slot||t.command.directObject?.parsed?.text||"default",r=RJ(t,e);Object.assign(t.sharedData,r)},blocked(t,e){return[t.event("if.event.save_blocked",{messageId:`if.action.saving.${e.error}`,params:e.params||{},blocked:!0,reason:e.error})]},report(t){let e=[],r=t.sharedData,n=(0,SJ.createSaveRequestedEvent)(r.saveContext);return e.push(n),e.push(t.event("if.event.save_requested",r.eventData)),e},group:"meta",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1}}});var $W=p(KW=>{"use strict";Object.defineProperty(KW,"__esModule",{value:!0})});var FA=p(da=>{"use strict";var CJ=da&&da.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),wJ=da&&da.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&CJ(e,t,r)};Object.defineProperty(da,"__esModule",{value:!0});da.savingAction=void 0;var NJ=zW();Object.defineProperty(da,"savingAction",{enumerable:!0,get:function(){return NJ.savingAction}});wJ($W(),da)});var QW=p(lT=>{"use strict";Object.defineProperty(lT,"__esModule",{value:!0});lT.restoringAction=void 0;var DJ=Ve(),LJ=ae();function MJ(t){return Object.entries(t).filter(([e])=>e!=="autosave").map(([e,r])=>({slot:e,name:r.name||e,timestamp:r.timestamp||Date.now(),metadata:{score:r.score,moves:r.moves,version:r.version}}))}function PJ(t){if(t.length===0)return null;let e=t.reduce((r,n)=>!r||n.timestamp>r.timestamp?n:r,null);return e?{slot:e.slot,timestamp:e.timestamp}:null}function kJ(t,e){let n=(t.world.getCapability("sharedData")||{}).saves||{},i=MJ(n),o=PJ(i),a={slot:e!=="default"?e:void 0,availableSaves:i,lastSave:o||void 0},s={saveName:e,timestamp:Date.now(),availableSaves:i.length};return{saveName:e,availableSaves:i,lastSave:o,restoreContext:a,eventData:s}}lT.restoringAction={id:LJ.IFActions.RESTORING,requiredMessages:["game_restored","game_loaded","restore_successful","welcome_back","restore_details","quick_restore","resuming_game","restore_failed","save_not_found","no_saves","corrupt_save","incompatible_save","restore_not_allowed","confirm_restore","unsaved_progress","available_saves","no_saves_available","choose_save","import_save","save_imported"],validate(t){let e=t.world.getCapability("sharedData")||{},r=e.saves||{};return(e.restoreRestrictions||{}).disabled?{valid:!1,error:"restore_not_allowed"}:Object.keys(r).filter(o=>o!=="autosave").length===0?{valid:!1,error:"no_saves"}:{valid:!0}},execute(t){let e=t.command.parsed.extras?.name||t.command.parsed.extras?.slot||t.command.indirectObject?.parsed?.text||"default",r=kJ(t,e);Object.assign(t.sharedData,r)},blocked(t,e){return[t.event("if.event.restore_blocked",{messageId:`if.action.restoring.${e.error}`,params:e.params||{},blocked:!0,reason:e.error})]},report(t){let e=[],r=t.sharedData,n=(0,DJ.createRestoreRequestedEvent)(r.restoreContext);return e.push(n),e.push(t.event("if.event.restore_requested",r.eventData)),e},group:"meta",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1}}});var ZW=p(XW=>{"use strict";Object.defineProperty(XW,"__esModule",{value:!0})});var VA=p(la=>{"use strict";var BJ=la&&la.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),xJ=la&&la.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&BJ(e,t,r)};Object.defineProperty(la,"__esModule",{value:!0});la.restoringAction=void 0;var jJ=QW();Object.defineProperty(la,"restoringAction",{enumerable:!0,get:function(){return jJ.restoringAction}});xJ(ZW(),la)});var eU=p(uT=>{"use strict";Object.defineProperty(uT,"__esModule",{value:!0});uT.quittingAction=void 0;var WJ=Ve(),UJ=ae();function JW(t){return t.sharedData}function HJ(t){let e=t.world.getCapability("sharedData")||{},r=(e.moves||0)>(e.lastSaveMove||0),n=e.score||0,i=e.maxScore||0,o=e.moves||0,a=i>0&&n/i>.8,s=t.command.parsed.extras?.force||t.command.parsed.extras?.now||t.command.parsed.action==="exit",c={score:n,moves:o,hasUnsavedChanges:r,force:s,stats:{maxScore:i,nearComplete:a,playTime:e.playTime||0,achievements:e.achievements||[]}},d={timestamp:Date.now(),hasUnsavedChanges:r,force:s,score:n,moves:o};return{quitContext:c,eventData:d,forceQuit:s,hasUnsavedProgress:r}}uT.quittingAction={id:UJ.IFActions.QUITTING,requiredMessages:["quit_confirm_query","quit_save_query","quit_unsaved_query","quit_requested","game_ending"],validate(t){return{valid:!0}},execute(t){let e=HJ(t),r=JW(t);r.quitContext=e.quitContext,r.eventData=e.eventData,r.forceQuit=e.forceQuit,r.hasUnsavedProgress=e.hasUnsavedProgress},blocked(t,e){return[t.event("if.event.quit_blocked",{messageId:`if.action.quitting.${e.error}`,params:e.params||{},blocked:!0,reason:e.error})]},report(t){let e=[],r=JW(t);if(!r.quitContext||!r.eventData)return e;let n=(0,WJ.createQuitRequestedEvent)(r.quitContext);return e.push(n),e.push(t.event("client.query",{queryId:`quit_${Date.now()}`,prompt:"Are you sure you want to quit?",source:"system",type:"multiple_choice",messageId:"quit_confirm_query",options:["quit","cancel"],context:r.quitContext})),e.push(t.event("if.event.quit_requested",r.eventData)),e},group:"meta",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1}}});var rU=p(tU=>{"use strict";Object.defineProperty(tU,"__esModule",{value:!0})});var YA=p(ua=>{"use strict";var qJ=ua&&ua.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),GJ=ua&&ua.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&qJ(e,t,r)};Object.defineProperty(ua,"__esModule",{value:!0});ua.quittingAction=void 0;var FJ=eU();Object.defineProperty(ua,"quittingAction",{enumerable:!0,get:function(){return FJ.quittingAction}});GJ(rU(),ua)});var nU=p(mT=>{"use strict";Object.defineProperty(mT,"__esModule",{value:!0});mT.restartingAction=void 0;var VJ=Ve(),YJ=ae();function zJ(t){let e=t.world.getCapability("sharedData")||{},r=e.moves>(e.lastSaveMove||0),n=e.score||0,i=e.moves||0,o=t.currentLocation?.name||"unknown",a=t.command.parsed.extras?.force||t.command.parsed.extras?.now||t.command.parsed.action==="reset",s={currentProgress:{score:n,moves:i,location:o},confirmationRequired:!a&&(r||i>10),hasUnsavedChanges:r,force:a},c={timestamp:Date.now(),hasUnsavedChanges:r,force:a,currentProgress:{score:n,moves:i,location:o}},d=!a&&(r||i>10);return{forceRestart:a,hasUnsavedProgress:r,score:n,moves:i,currentLocation:o,restartContext:s,eventData:c,showHint:d}}mT.restartingAction={id:YJ.IFActions.RESTARTING,requiredMessages:["restart_confirm","restart_unsaved","restart_requested","game_restarting","starting_over","new_game"],validate(t){return{valid:!0}},execute(t){let e=zJ(t);Object.assign(t.sharedData,e)},blocked(t,e){return[t.event("if.event.restart_blocked",{messageId:`if.action.restarting.${e.error}`,params:e.params||{},blocked:!0,reason:e.error})]},report(t){let e=[],r=t.sharedData,n=(0,VJ.createRestartRequestedEvent)(r.restartContext);return e.push(n),e.push(t.event("if.event.restart_requested",r.eventData)),e},group:"meta",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1}}});var oU=p(iU=>{"use strict";Object.defineProperty(iU,"__esModule",{value:!0})});var zA=p(ma=>{"use strict";var KJ=ma&&ma.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),$J=ma&&ma.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&KJ(e,t,r)};Object.defineProperty(ma,"__esModule",{value:!0});ma.restartingAction=void 0;var QJ=nU();Object.defineProperty(ma,"restartingAction",{enumerable:!0,get:function(){return QJ.restartingAction}});$J(oU(),ma)});var aU=p(pT=>{"use strict";Object.defineProperty(pT,"__esModule",{value:!0});pT.undoingAction=void 0;var XJ=Ve(),ZJ=ae();pT.undoingAction={id:ZJ.IFActions.UNDOING,requiredMessages:["undo_success","undo_failed","nothing_to_undo"],validate(t){return{valid:!0}},execute(t){},blocked(t,e){return[]},report(t){return[(0,XJ.createUndoRequestedEvent)()]},group:"meta",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1}}});var cU=p(sU=>{"use strict";Object.defineProperty(sU,"__esModule",{value:!0})});var KA=p(pa=>{"use strict";var JJ=pa&&pa.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),e9=pa&&pa.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&JJ(e,t,r)};Object.defineProperty(pa,"__esModule",{value:!0});pa.undoingAction=void 0;var t9=aU();Object.defineProperty(pa,"undoingAction",{enumerable:!0,get:function(){return t9.undoingAction}});e9(cU(),pa)});var lU=p(fT=>{"use strict";Object.defineProperty(fT,"__esModule",{value:!0});fT.againAction=void 0;var r9=Ve(),n9=ae();function dU(t){return t.sharedData}fT.againAction={id:n9.IFActions.AGAIN,requiredMessages:["nothing_to_repeat"],group:"meta",metadata:{requiresDirectObject:!1,requiresIndirectObject:!1},validate(t){let e=t.world.getCapability("commandHistory");if(!e||!e.entries||e.entries.length===0)return{valid:!1,error:"nothing_to_repeat"};let r=e.entries[e.entries.length-1],n=dU(t);return n.lastCommand=r.originalText,n.lastActionId=r.actionId,{valid:!0}},execute(t){},blocked(t,e){return[t.event("if.event.again_blocked",{blocked:!0,messageId:`${t.action.id}.${e.error}`,reason:e.error})]},report(t){let e=dU(t);return[(0,r9.createAgainRequestedEvent)({command:e.lastCommand,actionId:e.lastActionId})]}}});var $A=p(gT=>{"use strict";Object.defineProperty(gT,"__esModule",{value:!0});gT.againAction=void 0;var i9=lU();Object.defineProperty(gT,"againAction",{enumerable:!0,get:function(){return i9.againAction}})});var uU=p(hT=>{"use strict";Object.defineProperty(hT,"__esModule",{value:!0});hT.TraceAction=void 0;var o9=dS(),QA=class extends o9.MetaAction{constructor(){super();l(this,"id","author.trace");l(this,"verbs",["trace"]);this.ensureRegistered()}validate(r){let{command:n}=r,i=n.parsed?.tokens||[];if(i.length===0)return{valid:!1,error:"no_tokens"};if(i[0]?.normalized?.toLowerCase()!=="trace")return{valid:!1,error:"not_trace"};if(i.length===1)return{valid:!0};if(i.length===2){let a=i[1]?.normalized?.toLowerCase();return a==="on"||a==="off"?{valid:!0}:{valid:!1,error:"invalid_state"}}if(i.length===3){let a=i[1]?.normalized?.toLowerCase(),s=i[2]?.normalized?.toLowerCase(),c=["parser","validation","system","all"],d=["on","off"];return c.includes(a)&&d.includes(s)?{valid:!0}:{valid:!1,error:"invalid_target_or_state"}}return{valid:!1,error:"invalid_pattern"}}execute(r){let{command:n,world:i}=r,o=n.parsed?.tokens||[],a=[],s=i.getCapability("debug")||{debugParserEvents:!1,debugValidationEvents:!1,debugSystemEvents:!1};if(o.length===1)return a.push(r.event("trace.status",{parser:s.debugParserEvents||!1,validation:s.debugValidationEvents||!1,system:s.debugSystemEvents||!1})),a;if(o.length===2){let c=o[1]?.normalized?.toLowerCase()==="on";return s.debugParserEvents=c,s.debugValidationEvents=c,s.debugSystemEvents=c,i.updateCapability("debug",s),a.push(r.event("trace.changed",{target:"all",enabled:c})),a}if(o.length===3){let c=o[1]?.normalized?.toLowerCase(),d=o[2]?.normalized?.toLowerCase()==="on";switch(c){case"parser":s.debugParserEvents=d;break;case"validation":s.debugValidationEvents=d;break;case"system":s.debugSystemEvents=d;break;case"all":s.debugParserEvents=d,s.debugValidationEvents=d,s.debugSystemEvents=d;break;default:return a.push(r.event("action.error",{reason:`Unknown trace target: ${c}`})),a}i.updateCapability("debug",s),a.push(r.event("trace.changed",{target:c,enabled:d}))}return a}};hT.TraceAction=QA});var XA=p(yT=>{"use strict";Object.defineProperty(yT,"__esModule",{value:!0});yT.TraceAction=void 0;var a9=uU();Object.defineProperty(yT,"TraceAction",{enumerable:!0,get:function(){return a9.TraceAction}})});var mU=p(K=>{"use strict";var s9=K&&K.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),de=K&&K.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&s9(e,t,r)};Object.defineProperty(K,"__esModule",{value:!0});K.standardActions=K.takingOffAction=K.wearingAction=K.throwingAction=K.removingAction=K.takingAction=void 0;var c9=mS();Object.defineProperty(K,"takingAction",{enumerable:!0,get:function(){return c9.takingAction}});de(fS(),K);de(ES(),K);de(_S(),K);de(IS(),K);de(wS(),K);de(DS(),K);de(LS(),K);de(MS(),K);de(PS(),K);de(kS(),K);de(BS(),K);de(xS(),K);de(jS(),K);de(GS(),K);de(YS(),K);de($S(),K);de(ZS(),K);de(eA(),K);de(tA(),K);de(rA(),K);de(iA(),K);de(oA(),K);de(aA(),K);de(cA(),K);de(Sy(),K);de(pA(),K);de(gA(),K);var d9=EA();Object.defineProperty(K,"removingAction",{enumerable:!0,get:function(){return d9.removingAction}});de(vA(),K);de(_A(),K);var l9=bA();Object.defineProperty(K,"throwingAction",{enumerable:!0,get:function(){return l9.throwingAction}});de(SA(),K);de(RA(),K);de(NA(),K);de(DA(),K);var u9=PA();Object.defineProperty(K,"wearingAction",{enumerable:!0,get:function(){return u9.wearingAction}});var m9=kA();Object.defineProperty(K,"takingOffAction",{enumerable:!0,get:function(){return m9.takingOffAction}});de(xA(),K);de(WA(),K);de(UA(),K);de(GA(),K);de(FA(),K);de(VA(),K);de(YA(),K);de(zA(),K);de(KA(),K);de($A(),K);var p9=mS(),f9=fS(),g9=ES(),h9=_S(),y9=IS(),T9=wS(),E9=DS(),v9=LS(),_9=MS(),b9=PS(),I9=kS(),O9=BS(),S9=xS(),A9=jS(),R9=GS(),C9=YS(),w9=$S(),N9=ZS(),D9=eA(),L9=tA(),M9=rA(),P9=iA(),k9=oA(),B9=aA(),x9=cA(),j9=Sy(),W9=pA(),U9=gA(),H9=EA(),q9=vA(),G9=_A(),F9=bA(),V9=SA(),Y9=RA(),z9=NA(),K9=DA(),$9=PA(),Q9=kA(),X9=xA(),Z9=WA(),J9=UA(),e8=GA(),t8=FA(),r8=VA(),n8=YA(),i8=zA(),o8=KA(),a8=$A(),s8=XA(),c8=new s8.TraceAction;K.standardActions=[p9.takingAction,f9.droppingAction,g9.examiningAction,h9.openingAction,y9.closingAction,T9.goingAction,E9.lookingAction,v9.inventoryAction,_9.waitingAction,b9.sleepingAction,I9.scoringAction,O9.helpAction,S9.aboutAction,A9.versionAction,R9.lockingAction,C9.unlockingAction,w9.switchingOnAction,N9.switchingOffAction,D9.enteringAction,L9.exitingAction,M9.climbingAction,P9.searchingAction,k9.listeningAction,B9.smellingAction,x9.touchingAction,j9.puttingAction,W9.insertingAction,U9.reading,H9.removingAction,q9.givingAction,G9.showingAction,F9.throwingAction,V9.pushingAction,Y9.pullingAction,z9.loweringAction,K9.raisingAction,$9.wearingAction,Q9.takingOffAction,X9.eatingAction,Z9.drinkingAction,J9.talkingAction,e8.attackingAction,t8.savingAction,r8.restoringAction,n8.quittingAction,i8.restartingAction,o8.undoingAction,a8.againAction,c8]});var pU=p(St=>{"use strict";var d8=St&&St.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),kc=St&&St.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&d8(e,t,r)};Object.defineProperty(St,"__esModule",{value:!0});St.createEvent=St.MetaCommandRegistry=St.MetaAction=void 0;kc(sI(),St);kc(aS(),St);var l8=dS();Object.defineProperty(St,"MetaAction",{enumerable:!0,get:function(){return l8.MetaAction}});var u8=sS();Object.defineProperty(St,"MetaCommandRegistry",{enumerable:!0,get:function(){return u8.MetaCommandRegistry}});kc(Fx(),St);kc(Vx(),St);kc(ae(),St);kc(mU(),St);kc(XA(),St);var m8=Ve();Object.defineProperty(St,"createEvent",{enumerable:!0,get:function(){return m8.createEvent}})});var gU=p(fU=>{"use strict";Object.defineProperty(fU,"__esModule",{value:!0})});var yU=p(hU=>{"use strict";Object.defineProperty(hU,"__esModule",{value:!0})});var TU=p(fa=>{"use strict";Object.defineProperty(fa,"__esModule",{value:!0});fa.createTargetData=p8;fa.createObjectData=f8;fa.createContainerData=g8;fa.createLocationData=h8;fa.entitiesToIds=y8;fa.entitiesToNames=T8;fa.createMovementData=E8;function p8(t){return{targetId:t.id,targetName:t.name}}function f8(t){return{targetId:t.id,targetName:t.name,objectId:t.id,objectName:t.name}}function g8(t){return{containerId:t.id,containerName:t.name}}function h8(t){return{locationId:t.id,locationName:t.name}}function y8(t){return t.map(e=>e.id)}function T8(t){return t.map(e=>e.name)}function E8(t,e){return{fromLocationId:t.id,fromLocationName:t.name,toLocationId:e.id,toLocationName:e.name}}});var vU=p(EU=>{"use strict";Object.defineProperty(EU,"__esModule",{value:!0})});var _U=p(Yi=>{"use strict";var v8=Yi&&Yi.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),TT=Yi&&Yi.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&v8(e,t,r)};Object.defineProperty(Yi,"__esModule",{value:!0});TT(gU(),Yi);TT(yU(),Yi);TT(TU(),Yi);TT(vU(),Yi)});var ZA=p(Et=>{"use strict";Object.defineProperty(Et,"__esModule",{value:!0});Et.adaptSpecialVocabulary=Et.adaptDirectionVocabulary=Et.adaptVerbVocabulary=Et.GrammarPatterns=Et.vocabularyRegistry=Et.VocabularyRegistry=Et.PartOfSpeech=Et.ParseErrorType=Et.ParserFactory=void 0;var ga=jt();Object.defineProperty(Et,"ParserFactory",{enumerable:!0,get:function(){return ga.ParserFactory}});Object.defineProperty(Et,"ParseErrorType",{enumerable:!0,get:function(){return ga.ParseErrorType}});Object.defineProperty(Et,"PartOfSpeech",{enumerable:!0,get:function(){return ga.PartOfSpeech}});Object.defineProperty(Et,"VocabularyRegistry",{enumerable:!0,get:function(){return ga.VocabularyRegistry}});Object.defineProperty(Et,"vocabularyRegistry",{enumerable:!0,get:function(){return ga.vocabularyRegistry}});Object.defineProperty(Et,"GrammarPatterns",{enumerable:!0,get:function(){return ga.GrammarPatterns}});Object.defineProperty(Et,"adaptVerbVocabulary",{enumerable:!0,get:function(){return ga.adaptVerbVocabulary}});Object.defineProperty(Et,"adaptDirectionVocabulary",{enumerable:!0,get:function(){return ga.adaptDirectionVocabulary}});Object.defineProperty(Et,"adaptSpecialVocabulary",{enumerable:!0,get:function(){return ga.adaptSpecialVocabulary}})});var bU=p(ET=>{"use strict";Object.defineProperty(ET,"__esModule",{value:!0});ET.CommandValidator=void 0;var je=we(),_8=Wu(),JA=class{constructor(e,r,n){l(this,"world");l(this,"actionRegistry");l(this,"scopeResolver");l(this,"systemEvents");l(this,"currentActionId");this.world=e,this.actionRegistry=r,this.scopeResolver=n||new _8.StandardScopeResolver(e)}setSystemEventSource(e){this.systemEvents=e}validate(e){let r=Date.now(),n=[],i=this.actionRegistry.get(e.action);if(!i){let g=e.structure?.verb?.text||e.action,h=this.actionRegistry.findByPattern(g);h.length>0&&(i=h[0])}if(!i)return{success:!1,error:{type:"VALIDATION_ERROR",code:"ACTION_NOT_AVAILABLE",parsed:e,details:{action:e.action}}};this.currentActionId=i.id;let o;if(e.structure?.directObject){let g=e.structure.directObject;if(g.isAll||g.isList)o=void 0;else{let y=this.getActionMetadata(i).directObjectScope||je.ScopeLevel.VISIBLE,T=this.resolveEntity(g,"direct",y,e);if(!T.success)return T;o=T.value}}let a;if(e.structure?.indirectObject){let h=this.getActionMetadata(i).indirectObjectScope||je.ScopeLevel.VISIBLE,y=this.resolveEntity(e.structure.indirectObject,"indirect",h,e);if(!y.success)return y;a=y.value}let s;if(e.instrument){let g=this.resolveEntity(e.instrument,"instrument",je.ScopeLevel.REACHABLE,e);if(!g.success)return g;s=g.value}let c=this.getActionMetadata(i);if(o&&c.directObjectScope){let g=this.checkEntityScope(o.entity,c.directObjectScope,o.parsed.text);if(!g.success)return{success:!1,error:{type:"VALIDATION_ERROR",code:"ENTITY_NOT_VISIBLE",parsed:e,details:{entity:o.entity.id,entityName:o.parsed.text,scopeCode:g.code}}}}if(a&&c.indirectObjectScope){let g=this.checkEntityScope(a.entity,c.indirectObjectScope,a.parsed.text);if(!g.success)return{success:!1,error:{type:"VALIDATION_ERROR",code:"ENTITY_NOT_VISIBLE",parsed:e,details:{entity:a.entity.id,entityName:a.parsed.text,scopeCode:g.code}}}}let d=this.checkActionPreconditions(i,o?.entity,a?.entity);if(!d.success)return{success:!1,error:{type:"VALIDATION_ERROR",code:"PRECONDITION_FAILED",parsed:e,details:d.details}};let u=Date.now()-r,m={};if(o){let g=this.world.getPlayer(),h=this.scopeResolver.getScope(g,o.entity),y=this.getPerceivedSenses(g,o.entity);m.directObject={level:h,perceivedBy:y}}if(a){let g=this.world.getPlayer(),h=this.scopeResolver.getScope(g,a.entity),y=this.getPerceivedSenses(g,a.entity);m.indirectObject={level:h,perceivedBy:y}}if(s){let g=this.world.getPlayer(),h=this.scopeResolver.getScope(g,s.entity),y=this.getPerceivedSenses(g,s.entity);m.instrument={level:h,perceivedBy:y}}return{success:!0,value:{parsed:e,actionId:i.id,directObject:o,indirectObject:a,instrument:s,metadata:{validationTime:u,warnings:n.length>0?n:void 0},...Object.keys(m).length>0&&{scopeInfo:m}}}}resolveWithSelection(e,r){let n=Date.now(),i=[],o=this.actionRegistry.get(e.action);if(!o){let h=e.structure?.verb?.text||e.action,y=this.actionRegistry.findByPattern(h);y.length>0&&(o=y[0])}if(!o)return{success:!1,error:{type:"VALIDATION_ERROR",code:"ACTION_NOT_AVAILABLE",parsed:e,details:{action:e.action}}};this.currentActionId=o.id;let a;if(e.structure?.directObject){let h=e.structure.directObject;if(h.isAll||h.isList)a=void 0;else if(r.directObject){let y=this.world.getEntity(r.directObject);if(!y)return{success:!1,error:{type:"VALIDATION_ERROR",code:"ENTITY_NOT_FOUND",parsed:e,details:{slot:"directObject",selectedId:r.directObject,reason:"Selected entity no longer exists"}}};a={entity:y,parsed:h}}else{let T=this.getActionMetadata(o).directObjectScope||je.ScopeLevel.VISIBLE,I=this.resolveEntity(h,"direct",T,e);if(!I.success)return I;a=I.value}}let s;if(e.structure?.indirectObject)if(r.indirectObject){let h=this.world.getEntity(r.indirectObject);if(!h)return{success:!1,error:{type:"VALIDATION_ERROR",code:"ENTITY_NOT_FOUND",parsed:e,details:{slot:"indirectObject",selectedId:r.indirectObject,reason:"Selected entity no longer exists"}}};s={entity:h,parsed:e.structure.indirectObject}}else{let y=this.getActionMetadata(o).indirectObjectScope||je.ScopeLevel.VISIBLE,T=this.resolveEntity(e.structure.indirectObject,"indirect",y,e);if(!T.success)return T;s=T.value}let c;if(e.instrument)if(r.instrument){let h=this.world.getEntity(r.instrument);if(!h)return{success:!1,error:{type:"VALIDATION_ERROR",code:"ENTITY_NOT_FOUND",parsed:e,details:{slot:"instrument",selectedId:r.instrument,reason:"Selected entity no longer exists"}}};c={entity:h,parsed:e.instrument}}else{let h=this.resolveEntity(e.instrument,"instrument",je.ScopeLevel.REACHABLE,e);if(!h.success)return h;c=h.value}let d=this.getActionMetadata(o);if(a&&d.directObjectScope){let h=this.checkEntityScope(a.entity,d.directObjectScope,a.parsed.text);if(!h.success)return{success:!1,error:{type:"VALIDATION_ERROR",code:"ENTITY_NOT_VISIBLE",parsed:e,details:{entity:a.entity.id,entityName:a.parsed.text,scopeCode:h.code}}}}if(s&&d.indirectObjectScope){let h=this.checkEntityScope(s.entity,d.indirectObjectScope,s.parsed.text);if(!h.success)return{success:!1,error:{type:"VALIDATION_ERROR",code:"ENTITY_NOT_VISIBLE",parsed:e,details:{entity:s.entity.id,entityName:s.parsed.text,scopeCode:h.code}}}}let u=this.checkActionPreconditions(o,a?.entity,s?.entity);if(!u.success)return{success:!1,error:{type:"VALIDATION_ERROR",code:"PRECONDITION_FAILED",parsed:e,details:u.details}};let m=Date.now()-n,f={};if(a){let h=this.world.getPlayer(),y=this.scopeResolver.getScope(h,a.entity),T=this.getPerceivedSenses(h,a.entity);f.directObject={level:y,perceivedBy:T}}if(s){let h=this.world.getPlayer(),y=this.scopeResolver.getScope(h,s.entity),T=this.getPerceivedSenses(h,s.entity);f.indirectObject={level:y,perceivedBy:T}}if(c){let h=this.world.getPlayer(),y=this.scopeResolver.getScope(h,c.entity),T=this.getPerceivedSenses(h,c.entity);f.instrument={level:y,perceivedBy:T}}let g={parsed:e,actionId:o.id,directObject:a,indirectObject:s,instrument:c,metadata:{validationTime:m,warnings:i.length>0?i:void 0},...Object.keys(f).length>0&&{scopeInfo:f}};return this.emitDebugEvent("entity_resolution",e,{method:"resolveWithSelection",selections:r,success:!0}),{success:!0,value:g}}resolveEntity(e,r,n,i){if(!e)throw new Error("Cannot resolve undefined reference");if(this.emitDebugEvent("entity_resolution",i,{objectType:r,reference:e,requiredScope:n,startTime:Date.now()}),e.entityId){let h=this.resolveEntityById(e.entityId,e);if(h)return this.emitDebugEvent("entity_resolution",i,{objectType:r,preResolvedEntityId:e.entityId,entity:h.entity.id}),{success:!0,value:h}}let o=e.head||e.text,a=[];if(n===je.ScopeLevel.AWARE)a=this.world.getAllEntities().filter(h=>h.type!=="room"&&h.id!==this.world.getPlayer()?.id),a=a.filter(h=>{let y=this.getEntityName(h).toLowerCase(),T=h.type?.toLowerCase()||"",I=this.getEntitySynonyms(h).map(L=>L.toLowerCase()),A=o.toLowerCase();return y===A||T===A||I.includes(A)});else{let h=this.getEntitiesByName(o);a=h;let y=this.getEntitiesByType(o);a.push(...y);let T=this.getEntitiesBySynonym(o);if(a.push(...T),this.emitDebugEvent("entity_search",i,{searchTerm:o,byName:h.length,byType:y.length,bySynonym:T.length,totalBeforeDedupe:a.length}),a=a.filter((I,A,L)=>L.findIndex(S=>S.id===I.id)===A),a.length===0){let I=this.getEntitiesByAdjective(o);I.length>0&&(a=I,this.emitDebugEvent("entity_search",i,{searchTerm:o,byAdjective:I.length,fallback:!0}))}}let c=this.filterByScope(a,n);if(c.length===0&&a.length>0){let h=this.getEntitiesByAdjective(o);if(h.length>0){let y=this.filterByScope(h,n);y.length>0&&(a=h,c=y,this.emitDebugEvent("entity_search",i,{searchTerm:o,byAdjective:h.length,adjectiveInScope:y.length,fallbackAfterScope:!0}))}}let d=[],u=this.world.getPlayer();if(u)for(let h of a){let y=this.scopeResolver.getScope(u,h);d.push({id:h.id,name:this.getEntityName(h),type:h.type,location:this.world.getLocation(h.id),scope:y,meetsRequired:this.filterByScope([h],n).length>0,visible:this.isEntityVisible(h),reachable:this.isEntityReachable(h),touchable:this.isEntityTouchable(h)})}this.emitDebugEvent("scope_check",i,{objectType:r,requiredScope:n,totalCandidates:a.length,entitiesInScope:c.length,candidateScopes:d,scopeDetails:c.map(h=>({id:h.id,name:this.getEntityName(h),visible:this.isEntityVisible(h),reachable:this.isEntityReachable(h),touchable:this.isEntityTouchable(h)}))});let f=this.scoreEntities(c,e).filter(h=>h.score>0);if(f.length===0)return this.emitDebugEvent("validation_error",i,{errorType:"NO_MATCHES",reference:e,scope:n,checkedEntities:c.length}),{success:!1,error:{type:"VALIDATION_ERROR",code:"ENTITY_NOT_FOUND",parsed:i,details:{searchText:e.text,candidates:e.candidates,scope:n}}};if(f.length>1){let h=this.resolveAmbiguity(f,e,i);if(h)return{success:!0,value:{entity:h.entity,parsed:e}};let y=e.modifiers||[];if(y.length===0&&e.text&&e.head){let I=e.head.toLowerCase(),A=e.text.toLowerCase().split(/\s+/).filter(S=>S!==I),L=["the","a","an","all","some","every","any","my"];y=A.filter(S=>!L.includes(S))}if(y.length>0&&!f.some(A=>A.matchReasons.some(L=>L.startsWith("modifier_match_"))))return this.emitDebugEvent("entity_resolution",i,{objectType:r,resolved:!1,reason:"modifiers_not_matched",searchText:e.text,specifiedModifiers:y}),{success:!1,error:{type:"VALIDATION_ERROR",code:"ENTITY_NOT_FOUND",parsed:i,details:{searchText:e.text,modifiers:y,nearMatches:f.slice(0,3).map(A=>this.getEntityName(A.entity))}}};let T=f.slice(0,5).map(I=>({id:I.entity.id,name:this.getEntityName(I.entity),description:this.getEntityDescription(I.entity),score:I.score,matchReasons:I.matchReasons}));return this.emitDebugEvent("disambiguation_required",i,{objectType:r,searchText:e.text,candidateCount:f.length,topCandidates:T}),{success:!1,error:{type:"VALIDATION_ERROR",code:"AMBIGUOUS_ENTITY",parsed:i,details:{ambiguousEntities:T,searchText:e.text,matchCount:f.length,objectType:r}}}}let g=f[0];return this.emitDebugEvent("entity_resolution",i,{objectType:r,resolved:!0,entity:g.entity.id,score:g.score,matchReasons:g.matchReasons}),{success:!0,value:{entity:g.entity,parsed:e}}}getEntitiesByName(e){let r=e.toLowerCase();return this.world.findWhere(n=>n.type==="room"||n.id===this.world.getPlayer()?.id?!1:this.getEntityName(n).toLowerCase()===r)}getEntitiesByType(e){let r=e.toLowerCase();return this.world.findByType(r)}getEntitiesBySynonym(e){let r=e.toLowerCase();return this.world.findWhere(n=>n.type==="room"||n.id===this.world.getPlayer()?.id?!1:this.getEntitySynonyms(n).map(o=>o.toLowerCase()).includes(r))}getEntitiesByAdjective(e){let r=e.toLowerCase();return this.world.findWhere(n=>n.type==="room"||n.id===this.world.getPlayer()?.id?!1:this.getEntityAdjectives(n).map(o=>o.toLowerCase()).includes(r))}filterByScope(e,r){let n=this.world.getPlayer();return n?e.filter(i=>{let o=this.scopeResolver.getScope(n,i);switch(r){case je.ScopeLevel.CARRIED:return o===je.ScopeLevel.CARRIED;case je.ScopeLevel.REACHABLE:return o===je.ScopeLevel.CARRIED||o===je.ScopeLevel.REACHABLE;case je.ScopeLevel.VISIBLE:return o===je.ScopeLevel.CARRIED||o===je.ScopeLevel.REACHABLE||o===je.ScopeLevel.VISIBLE;case je.ScopeLevel.AWARE:let a=this.scopeResolver.canHear&&this.scopeResolver.canHear(n,i),s=this.scopeResolver.canSmell&&this.scopeResolver.canSmell(n,i);return a||s||o>=je.ScopeLevel.AWARE;default:return o>=r}}):[]}scoreEntities(e,r){if(!r)return[];let n=[],i=(r.head||r.text).toLowerCase(),o=r.modifiers||[];if(o.length===0&&r.text&&r.head){let a=r.head.toLowerCase(),s=r.text.toLowerCase().split(/\s+/).filter(d=>d!==a),c=["the","a","an","all","some","every","any","my"];o=s.filter(d=>!c.includes(d))}for(let a of e){let s=0,c=[],d=this.getEntityName(a).toLowerCase(),u=a.type?.toLowerCase()||"",m=this.getEntityAdjectives(a).map(h=>h.toLowerCase()),f=this.getEntitySynonyms(a).map(h=>h.toLowerCase());d===i?(s+=10,c.push("exact_name_match")):u===i?(s+=8,c.push("type_match")):f.includes(i)?(s+=6,c.push("synonym_match")):m.includes(i)&&(s+=4,c.push("adjective_match"));for(let h of o)m.includes(h.toLowerCase())&&(s+=5,c.push(`modifier_match_${h}`));o.length===0&&m.length>0&&(s-=1,c.push("unspecified_adjectives")),this.isEntityVisible(a)&&(s+=1,c.push("visible")),this.isEntityReachable(a)&&(s+=1,c.push("reachable")),this.isInPlayerInventory(a)&&(s+=2,c.push("in_inventory"));let g=this.currentActionId;if(g&&typeof a.scope=="function"){let h=a.scope(g),y=Math.round((h-100)/10);y!==0&&(s+=y,c.push(`scope_priority_${h}`))}s>0&&n.push({entity:a,score:s,matchReasons:c})}return n.sort((a,s)=>s.score-a.score),n}resolveAmbiguity(e,r,n){if(this.emitDebugEvent("ambiguity_resolution",n,{reference:r,matchCount:e.length,topMatches:e.slice(0,5).map(a=>({entity:a.entity.id,name:this.getEntityName(a.entity),score:a.score,reasons:a.matchReasons}))}),e.length>=2){let a=e[0].score,s=e[1].score;if(a>=s*1.5)return this.emitDebugEvent("ambiguity_resolution",n,{resolved:!0,method:"score_threshold",chosen:e[0].entity.id,scoreGap:a-s}),e[0]}let i=r?.modifiers||[];if(i.length===0&&r?.text&&r?.head){let a=r.head.toLowerCase(),s=r.text.toLowerCase().split(/\s+/).filter(d=>d!==a),c=["the","a","an","all","some","every","any","my"];i=s.filter(d=>!c.includes(d))}if(i.length>0){let a=e.filter(s=>{let c=this.getEntityAdjectives(s.entity).map(d=>d.toLowerCase());return i.every(d=>c.includes(d.toLowerCase()))});if(a.length===1)return this.emitDebugEvent("ambiguity_resolution",n,{resolved:!0,method:"all_modifiers_match",chosen:a[0].entity.id}),a[0]}let o=e.filter(a=>this.isEntityVisible(a.entity)&&this.isEntityReachable(a.entity));return o.length===1?(this.emitDebugEvent("ambiguity_resolution",n,{resolved:!0,method:"only_reachable",chosen:o[0].entity.id}),o[0]):(this.emitDebugEvent("ambiguity_resolution",n,{resolved:!1,method:"none",remainingCount:e.length}),null)}resolveEntityById(e,r){let n=this.world.getEntity(e);return n?{entity:n,parsed:r}:null}isEntityVisible(e){let r=this.world.getPlayer();return r?this.scopeResolver.canSee(r,e):!1}isEntityReachable(e){let r=this.world.getPlayer();return r?this.scopeResolver.canReach(r,e):!1}isEntityTouchable(e){return!(!this.isEntityReachable(e)||e.has&&e.has("intangible"))}isInPlayerInventory(e){let r=this.world.getPlayer();return r?this.world.getContents(r.id).some(i=>i.id===e.id):!1}checkEntityScope(e,r,n){let i=this.world.getPlayer();if(!i)return{success:!1,code:"NO_PLAYER"};let o=this.scopeResolver.getScope(i,e);switch(r){case je.ScopeLevel.CARRIED:if(o!==je.ScopeLevel.CARRIED)return{success:!1,code:"NOT_CARRIED"};break;case je.ScopeLevel.REACHABLE:if(o!==je.ScopeLevel.CARRIED&&o!==je.ScopeLevel.REACHABLE)return{success:!1,code:"NOT_REACHABLE"};break;case je.ScopeLevel.VISIBLE:if(o<je.ScopeLevel.VISIBLE)return{success:!1,code:"NOT_VISIBLE"};break;case je.ScopeLevel.AWARE:if(o===je.ScopeLevel.UNAWARE)return{success:!1,code:"NOT_AWARE"};break}return{success:!0}}getPerceivedSenses(e,r){let n=[];return this.scopeResolver.canSee(e,r)&&n.push("sight"),this.scopeResolver.canHear&&this.scopeResolver.canHear(e,r)&&n.push("hearing"),this.scopeResolver.canSmell&&this.scopeResolver.canSmell(e,r)&&n.push("smell"),this.scopeResolver.canReach(e,r)&&n.push("touch"),n}getEntityName(e){let r=e.name;return typeof r=="string"?r:e.type||e.id}getEntityDescription(e){return e.description||this.getEntityName(e)}getEntityAdjectives(e){let r=[],n=e.get("identity");if(n&&typeof n=="object"&&"adjectives"in n){let i=n.adjectives;Array.isArray(i)&&r.push(...i.map(String))}return r}getEntitySynonyms(e){let r=[],n=e.get("identity");if(n&&typeof n=="object"&&"aliases"in n){let i=n.aliases;Array.isArray(i)&&r.push(...i.map(String))}return e.type&&r.push(e.type),r}getActionMetadata(e){return e.metadata&&"requiresDirectObject"in e.metadata&&"requiresIndirectObject"in e.metadata?e.metadata:{requiresDirectObject:!1,requiresIndirectObject:!1,directObjectScope:je.ScopeLevel.VISIBLE,indirectObjectScope:je.ScopeLevel.VISIBLE}}checkActionPreconditions(e,r,n){return e.metadata&&typeof e.metadata.validate=="function"?e.metadata.validate(r,n):{success:!0,message:"OK"}}emitDebugEvent(e,r,n){this.systemEvents&&this.systemEvents.emit({id:`validator_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),subsystem:"validator",type:e,data:{command:r,...n}})}};ET.CommandValidator=JA});var IU=p(vT=>{"use strict";Object.defineProperty(vT,"__esModule",{value:!0});vT.CommandValidator=void 0;var b8=bU();Object.defineProperty(vT,"CommandValidator",{enumerable:!0,get:function(){return b8.CommandValidator}})});var SU=p(fr=>{"use strict";Object.defineProperty(fr,"__esModule",{value:!0});fr.commonPrepositions=fr.specialVocabulary=fr.standardDirections=fr.standardVerbs=void 0;fr.registerStandardVocabulary=OU;var _T=ZA();fr.standardVerbs=[{actionId:"GO",verbs:["go","walk","move","travel","head"],pattern:"verb_direction"},{actionId:"TAKE",verbs:["take","get","pick","grab","acquire","obtain"],pattern:"verb_noun"},{actionId:"DROP",verbs:["drop","put","place","leave","discard"],pattern:"verb_noun"},{actionId:"EXAMINE",verbs:["examine","look","x","ex","inspect","study","observe"],pattern:"verb_noun",prepositions:["at"]},{actionId:"OPEN",verbs:["open","unlock"],pattern:"verb_noun"},{actionId:"CLOSE",verbs:["close","shut","lock"],pattern:"verb_noun"},{actionId:"INVENTORY",verbs:["inventory","inv","i"],pattern:"verb_only"},{actionId:"LOOK",verbs:["look","l"],pattern:"verb_only"},{actionId:"PUT",verbs:["put","place","insert","deposit"],pattern:"verb_noun_prep_noun",prepositions:["in","into","on","onto","under","behind"]},{actionId:"USE",verbs:["use","apply","activate"],pattern:"verb_noun"},{actionId:"TALK",verbs:["talk","speak","say","tell","ask"],pattern:"verb_prep_noun",prepositions:["to","with"]},{actionId:"GIVE",verbs:["give","offer","hand"],pattern:"verb_noun_prep_noun",prepositions:["to"]},{actionId:"ATTACK",verbs:["attack","hit","strike","fight","kill"],pattern:"verb_noun"},{actionId:"WAIT",verbs:["wait","z"],pattern:"verb_only"},{actionId:"SAVE",verbs:["save"],pattern:"verb_only"},{actionId:"LOAD",verbs:["load","restore"],pattern:"verb_only"},{actionId:"QUIT",verbs:["quit","exit","q"],pattern:"verb_only"},{actionId:"author.trace",verbs:["trace"],pattern:"verb_noun"}];fr.standardDirections=[{direction:"NORTH",words:["north"],abbreviations:["n"]},{direction:"SOUTH",words:["south"],abbreviations:["s"]},{direction:"EAST",words:["east"],abbreviations:["e"]},{direction:"WEST",words:["west"],abbreviations:["w"]},{direction:"NORTHEAST",words:["northeast"],abbreviations:["ne"]},{direction:"NORTHWEST",words:["northwest"],abbreviations:["nw"]},{direction:"SOUTHEAST",words:["southeast"],abbreviations:["se"]},{direction:"SOUTHWEST",words:["southwest"],abbreviations:["sw"]},{direction:"UP",words:["up","upward","upwards"],abbreviations:["u"]},{direction:"DOWN",words:["down","downward","downwards"],abbreviations:["d"]},{direction:"IN",words:["in","inside","enter"],abbreviations:[]},{direction:"OUT",words:["out","outside","exit","leave"],abbreviations:[]}];fr.specialVocabulary={pronouns:["it","them","that","those","this","these"],allWords:["all","everything","every"],exceptWords:["except","but"],articles:["a","an","the","some"]};fr.commonPrepositions=["in","into","on","onto","at","to","from","with","under","over","behind","beside","through","across","between","among"];function OU(){_T.vocabularyRegistry.registerVerbs(fr.standardVerbs),_T.vocabularyRegistry.registerDirections(fr.standardDirections),_T.vocabularyRegistry.registerSpecial(fr.specialVocabulary),_T.vocabularyRegistry.registerProvider({id:"standard-prepositions",priority:100,getVocabulary:()=>fr.commonPrepositions.map(t=>({word:t,partOfSpeech:"preposition",mapsTo:t.toUpperCase(),source:"base"}))})}OU()});var AU=p(Bc=>{"use strict";var I8=Bc&&Bc.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),O8=Bc&&Bc.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&I8(e,t,r)};Object.defineProperty(Bc,"__esModule",{value:!0});O8(SU(),Bc)});var RU=p(bT=>{"use strict";Object.defineProperty(bT,"__esModule",{value:!0});bT.ScoringCapabilitySchema=void 0;bT.ScoringCapabilitySchema={scoreValue:{type:"number",default:0,required:!0},maxScore:{type:"number",default:0,required:!0},moves:{type:"number",default:0,required:!1},achievements:{type:"array",default:[],required:!1},scoreHistory:{type:"array",default:[],required:!1},scoredTreasures:{type:"array",default:[],required:!1}}});var CU=p(IT=>{"use strict";Object.defineProperty(IT,"__esModule",{value:!0});IT.SaveRestoreCapabilitySchema=void 0;IT.SaveRestoreCapabilitySchema={saves:{type:"object",default:{},required:!0},lastSave:{type:"string",default:"",required:!1},autoSaveEnabled:{type:"boolean",default:!0,required:!1},maxSaveSlots:{type:"number",default:10,required:!1}}});var wU=p(OT=>{"use strict";Object.defineProperty(OT,"__esModule",{value:!0});OT.ConversationCapabilitySchema=void 0;OT.ConversationCapabilitySchema={states:{type:"object",default:{},required:!0},globalTopics:{type:"array",default:[],required:!1},conversationHistory:{type:"array",default:[],required:!1}}});var NU=p(ST=>{"use strict";Object.defineProperty(ST,"__esModule",{value:!0});ST.GameMetaCapabilitySchema=void 0;ST.GameMetaCapabilitySchema={turnCount:{type:"number",default:0,required:!0},startTime:{type:"number",default:0,required:!0},lastAction:{type:"string",default:"",required:!1},preferences:{type:"object",default:{verboseMode:!1,briefMode:!1,scoring:!0},required:!0}}});var DU=p(AT=>{"use strict";Object.defineProperty(AT,"__esModule",{value:!0});AT.CommandHistoryCapabilitySchema=void 0;AT.CommandHistoryCapabilitySchema={entries:{type:"array",default:[],required:!0},maxEntries:{type:"number",default:100,required:!1}}});var LU=p(Es=>{"use strict";Object.defineProperty(Es,"__esModule",{value:!0});Es.DEBUG_CAPABILITY=Es.DebugCapabilitySchema=void 0;Es.isAnyDebugEnabled=S8;Es.createDefaultDebugData=A8;Es.DebugCapabilitySchema={debugParserEvents:{type:"boolean",default:!1,required:!1},debugValidationEvents:{type:"boolean",default:!1,required:!1},debugSystemEvents:{type:"boolean",default:!1,required:!1},debugEngineEvents:{type:"boolean",default:!1,required:!1},debugTextEvents:{type:"boolean",default:!1,required:!1}};Es.DEBUG_CAPABILITY="debug";function S8(t){return t?!!(t.debugParserEvents||t.debugValidationEvents||t.debugSystemEvents||t.debugEngineEvents||t.debugTextEvents):!1}function A8(){return{debugParserEvents:!1,debugValidationEvents:!1,debugSystemEvents:!1,debugEngineEvents:!1,debugTextEvents:!1}}});var jU=p(Je=>{"use strict";Object.defineProperty(Je,"__esModule",{value:!0});Je.StandardCapabilitySchemas=Je.createDefaultDebugData=Je.isAnyDebugEnabled=Je.DEBUG_CAPABILITY=Je.DebugCapabilitySchema=Je.CommandHistoryCapabilitySchema=Je.GameMetaCapabilitySchema=Je.ConversationCapabilitySchema=Je.SaveRestoreCapabilitySchema=Je.ScoringCapabilitySchema=void 0;Je.registerStandardCapabilities=R8;var yl=E(),MU=RU();Object.defineProperty(Je,"ScoringCapabilitySchema",{enumerable:!0,get:function(){return MU.ScoringCapabilitySchema}});var PU=CU();Object.defineProperty(Je,"SaveRestoreCapabilitySchema",{enumerable:!0,get:function(){return PU.SaveRestoreCapabilitySchema}});var kU=wU();Object.defineProperty(Je,"ConversationCapabilitySchema",{enumerable:!0,get:function(){return kU.ConversationCapabilitySchema}});var BU=NU();Object.defineProperty(Je,"GameMetaCapabilitySchema",{enumerable:!0,get:function(){return BU.GameMetaCapabilitySchema}});var xU=DU();Object.defineProperty(Je,"CommandHistoryCapabilitySchema",{enumerable:!0,get:function(){return xU.CommandHistoryCapabilitySchema}});var em=LU();Object.defineProperty(Je,"DebugCapabilitySchema",{enumerable:!0,get:function(){return em.DebugCapabilitySchema}});Object.defineProperty(Je,"DEBUG_CAPABILITY",{enumerable:!0,get:function(){return em.DEBUG_CAPABILITY}});Object.defineProperty(Je,"isAnyDebugEnabled",{enumerable:!0,get:function(){return em.isAnyDebugEnabled}});Object.defineProperty(Je,"createDefaultDebugData",{enumerable:!0,get:function(){return em.createDefaultDebugData}});Je.StandardCapabilitySchemas={[yl.StandardCapabilities.SCORING]:MU.ScoringCapabilitySchema,[yl.StandardCapabilities.SAVE_RESTORE]:PU.SaveRestoreCapabilitySchema,[yl.StandardCapabilities.CONVERSATION]:kU.ConversationCapabilitySchema,[yl.StandardCapabilities.GAME_META]:BU.GameMetaCapabilitySchema,[yl.StandardCapabilities.COMMAND_HISTORY]:xU.CommandHistoryCapabilitySchema,[yl.StandardCapabilities.DEBUG]:em.DebugCapabilitySchema};function R8(t,e=Object.keys(Je.StandardCapabilitySchemas)){for(let r of e){let n=Je.StandardCapabilitySchemas[r];n&&t.registerCapability(r,{schema:n})}}});var WU=p(tm=>{"use strict";Object.defineProperty(tm,"__esModule",{value:!0});tm.QuitQueryHandler=void 0;tm.createQuitQueryHandler=C8;var ci=Ve(),RT=class{constructor(){l(this,"eventSource",(0,ci.createSemanticEventSource)())}canHandle(e){return e.source===ci.QuerySource.SYSTEM&&(e.type===ci.QueryType.YES_NO||e.type===ci.QueryType.MULTIPLE_CHOICE)&&(e.messageId==="quit_confirmation"||e.messageId==="quit_confirm_query"||e.messageId==="quit_unsaved_query"||e.messageId==="quit_save_query")}handleResponse(e,r){let n=[],i=r.context,o=r.options?.[e.selectedIndex||0]||e.response;if(typeof o=="boolean")if(o===!0){let a={score:i.score,moves:i.moves,hasUnsavedChanges:i.hasUnsavedProgress||!1,force:!0,stats:{maxScore:i.maxScore,nearComplete:i.nearComplete}},s=(0,ci.createQuitRequestedEvent)(a);n.push(s),n.push(this.createEvent("query.handled",{queryId:r.id,action:"quit_confirmed",savedBeforeQuit:!1}))}else{let a=(0,ci.createQuitCancelledEvent)();n.push(a),n.push(this.createEvent("query.handled",{queryId:r.id,action:"quit_cancelled"}))}else switch(o){case"quit":case"quit_without_saving":case"yes":let a={score:i.score,moves:i.moves,hasUnsavedChanges:i.hasUnsavedProgress||!1,force:!0,stats:{maxScore:i.maxScore,nearComplete:i.nearComplete}},s=(0,ci.createQuitRequestedEvent)(a);n.push(s),n.push(this.createEvent("query.handled",{queryId:r.id,action:"quit_confirmed",savedBeforeQuit:!1}));break;case"save_and_quit":n.push(this.createEvent("platform.save_requested",{saveName:"autosave",autosave:!0,timestamp:Date.now(),metadata:{reason:"quit",score:i.score,moves:i.moves}}));let c={score:i.score,moves:i.moves,hasUnsavedChanges:!1,force:!0,stats:{maxScore:i.maxScore,savedBeforeQuit:!0}},d=(0,ci.createQuitRequestedEvent)(c);n.push(d),n.push(this.createEvent("query.handled",{queryId:r.id,action:"save_and_quit",savedBeforeQuit:!0}));break;default:let u=(0,ci.createQuitCancelledEvent)();n.push(u),n.push(this.createEvent("query.handled",{queryId:r.id,action:"quit_cancelled"}));break}for(let a of n)this.eventSource.emit(a)}handleTimeout(e){let r=(0,ci.createQuitCancelledEvent)();this.eventSource.emit(r),this.eventSource.emit(this.createEvent("query.timeout",{queryId:e.id,action:"quit_cancelled",reason:"timeout"}))}handleCancel(e){let r=(0,ci.createQuitCancelledEvent)();this.eventSource.emit(r),this.eventSource.emit(this.createEvent("query.cancelled",{queryId:e.id,action:"quit_cancelled",reason:"cancelled"}))}getEventSource(){return this.eventSource}createEvent(e,r){return{id:`evt_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:e,timestamp:Date.now(),entities:{},data:r}}};tm.QuitQueryHandler=RT;function C8(){return new RT}});var UU=p(rm=>{"use strict";Object.defineProperty(rm,"__esModule",{value:!0});rm.RestartQueryHandler=void 0;rm.createRestartQueryHandler=w8;var di=Ve(),CT=class{constructor(){l(this,"eventSource",(0,di.createSemanticEventSource)())}canHandle(e){return e.source===di.QuerySource.SYSTEM&&(e.type===di.QueryType.YES_NO||e.type===di.QueryType.MULTIPLE_CHOICE)&&(e.messageId==="restart_confirmation"||e.messageId==="restart_confirm"||e.messageId==="restart_unsaved"||e.messageId==="restart_progress")}handleResponse(e,r){let n=[],i=r.context,o=r.options?.[e.selectedIndex||0]||e.response;if(typeof o=="boolean")if(o===!0){let a={currentProgress:{score:i.score,moves:i.moves,location:i.location},confirmationRequired:!1,hasUnsavedChanges:i.hasUnsavedProgress||!1,force:!0},s=(0,di.createRestartRequestedEvent)(a);n.push(s),n.push(this.createEvent("query.handled",{queryId:r.id,action:"restart_confirmed",savedBeforeRestart:!1}))}else{let a=(0,di.createRestartCompletedEvent)(!1);n.push(a),n.push(this.createEvent("query.handled",{queryId:r.id,action:"restart_cancelled"}))}else switch(o){case"restart":case"restart_without_saving":case"yes":let a={currentProgress:{score:i.score,moves:i.moves,location:i.location},confirmationRequired:!1,hasUnsavedChanges:i.hasUnsavedProgress||!1,force:!0},s=(0,di.createRestartRequestedEvent)(a);n.push(s),n.push(this.createEvent("query.handled",{queryId:r.id,action:"restart_confirmed",savedBeforeRestart:!1}));break;case"save_and_restart":n.push(this.createEvent("platform.save_requested",{saveName:"before_restart",autosave:!0,timestamp:Date.now(),metadata:{reason:"restart",score:i.score,moves:i.moves,location:i.location}}));let c={currentProgress:{score:i.score,moves:i.moves,location:i.location},confirmationRequired:!1,hasUnsavedChanges:!1,force:!0},d=(0,di.createRestartRequestedEvent)(c);n.push(d),n.push(this.createEvent("query.handled",{queryId:r.id,action:"save_and_restart",savedBeforeRestart:!0}));break;default:let u=(0,di.createRestartCompletedEvent)(!1);n.push(u),n.push(this.createEvent("query.handled",{queryId:r.id,action:"restart_cancelled"}));break}for(let a of n)this.eventSource.emit(a)}handleTimeout(e){let r=(0,di.createRestartCompletedEvent)(!1);this.eventSource.emit(r),this.eventSource.emit(this.createEvent("query.timeout",{queryId:e.id,action:"restart_cancelled",reason:"timeout"}))}handleCancel(e){let r=(0,di.createRestartCompletedEvent)(!1);this.eventSource.emit(r),this.eventSource.emit(this.createEvent("query.cancelled",{queryId:e.id,action:"restart_cancelled",reason:"cancelled"}))}getEventSource(){return this.eventSource}createEvent(e,r){return{id:`evt_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:e,timestamp:Date.now(),entities:{},data:r}}};rm.RestartQueryHandler=CT;function w8(){return new CT}});var qU=p(vs=>{"use strict";var N8=vs&&vs.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),HU=vs&&vs.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&N8(e,t,r)};Object.defineProperty(vs,"__esModule",{value:!0});HU(WU(),vs);HU(UU(),vs)});var FU=p(wT=>{"use strict";Object.defineProperty(wT,"__esModule",{value:!0});wT.PerceptionService=void 0;var GU=E(),eR=class{filterEvents(e,r,n){let i=this.getActorRoom(r,n);if(!i)return e;let o=this.canPerceive(r,i,n,"sight");return e.map(a=>!this.isVisualEvent(a)||o?a:this.createPerceptionBlockedEvent(a,r,i,n))}canPerceive(e,r,n,i){switch(i){case"sight":return this.canSeeVisually(e,r,n);case"hearing":return this.canHear(e,r,n);case"smell":return this.canSmell(e,r,n);case"touch":return this.canTouch(e,r,n);default:return!0}}canSeeVisually(e,r,n){return!(this.isBlind(e)||this.isWearingBlindfold(e,n)||GU.VisibilityBehavior.isDark(r,n))}canHear(e,r,n){return!0}canSmell(e,r,n){return!0}canTouch(e,r,n){return!0}isBlind(e){return!1}isWearingBlindfold(e,r){return!1}getActorRoom(e,r){return"getContainingRoom"in r&&r.getContainingRoom(e.id)||null}isVisualEvent(e){return e.type==="if.event.room.description"||e.type==="if.event.contents.listed"||e.type==="action.success"&&e.data?.messageId==="contents_list"}createPerceptionBlockedEvent(e,r,n,i){let o=this.getBlockReason(r,n,i),a={originalType:e.type,reason:o,sense:"sight",originalData:e.data};return{...e,type:"if.event.perception.blocked",data:a}}getBlockReason(e,r,n){return this.isBlind(e)?"blindness":this.isWearingBlindfold(e,n)?"blindfolded":GU.VisibilityBehavior.isDark(r,n)?"darkness":"unknown"}};wT.PerceptionService=eR});var VU=p(NT=>{"use strict";Object.defineProperty(NT,"__esModule",{value:!0});NT.PerceptionService=void 0;var D8=FU();Object.defineProperty(NT,"PerceptionService",{enumerable:!0,get:function(){return D8.PerceptionService}})});var zU=p(YU=>{"use strict";Object.defineProperty(YU,"__esModule",{value:!0})});var LT=p(DT=>{"use strict";Object.defineProperty(DT,"__esModule",{value:!0});DT.NpcMessages=void 0;DT.NpcMessages={NPC_ENTERS:"npc.enters",NPC_LEAVES:"npc.leaves",NPC_ARRIVES:"npc.arrives",NPC_DEPARTS:"npc.departs",NPC_NOTICES_PLAYER:"npc.notices_player",NPC_IGNORES_PLAYER:"npc.ignores_player",NPC_TAKES:"npc.takes",NPC_DROPS:"npc.drops",NPC_FOLLOWS:"npc.follows",GUARD_BLOCKS:"npc.guard.blocks",GUARD_ATTACKS:"npc.guard.attacks",GUARD_DEFEATED:"npc.guard.defeated",NPC_ATTACKS:"npc.attacks",NPC_MISSES:"npc.misses",NPC_HITS:"npc.hits",NPC_KILLED:"npc.killed",NPC_UNCONSCIOUS:"npc.unconscious",NPC_SPEAKS:"npc.speaks",NPC_SHOUTS:"npc.shouts",NPC_WHISPERS:"npc.whispers",NPC_MUTTERS:"npc.mutters",NPC_LAUGHS:"npc.laughs",NPC_GROWLS:"npc.growls",NPC_CRIES:"npc.cries",NPC_SIGHS:"npc.sighs",NPC_GREETS:"npc.greets",NPC_FAREWELL:"npc.farewell",NPC_NO_RESPONSE:"npc.no_response",NPC_CONFUSED:"npc.confused"}});var KU=p(xc=>{"use strict";Object.defineProperty(xc,"__esModule",{value:!0});xc.NpcService=void 0;xc.registerNpcCombatResolver=P8;xc.clearNpcCombatResolver=k8;xc.createNpcService=x8;var un=E(),L8=LT(),tR="__sharpee_npc_combat_resolver__";function M8(){return globalThis[tR]}function P8(t){globalThis[tR]=t}function k8(){delete globalThis[tR]}function B8(t){return`${t}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function _s(t,e,r){return{id:B8("npc"),type:t,timestamp:Date.now(),entities:r?{actor:r}:{},data:e}}var MT=class{constructor(){l(this,"behaviors",new Map)}registerBehavior(e){this.behaviors.set(e.id,e)}removeBehavior(e){this.behaviors.delete(e)}getBehavior(e){return this.behaviors.get(e)}tick(e){let r=[],{world:n,turn:i,random:o,playerLocation:a,playerId:s}=e,c=this.getActiveNpcs(n);for(let d of c){let u=d.get(un.TraitType.NPC);if(!u||!u.isAlive||!u.isConscious)continue;let m=this.getBehaviorForNpc(d);if(!m)continue;let f=n.getLocation(d.id)||"",g=this.createNpcContext(d,n,o,i,a,f),h=m.onTurn(g),y=this.executeActions(d,h,n,o);r.push(...y)}return r}onPlayerEnters(e,r,n,i){let o=[],a=e.getPlayer()?.id||"",c=e.getContents(r).filter(d=>d.has(un.TraitType.NPC));for(let d of c){let u=d.get(un.TraitType.NPC);if(!u||!u.isAlive||!u.isConscious)continue;let m=this.getBehaviorForNpc(d);if(!m?.onPlayerEnters)continue;let f=this.createNpcContext(d,e,n,i,r,r),g=m.onPlayerEnters(f),h=this.executeActions(d,g,e,n);o.push(...h)}return o}onPlayerLeaves(e,r,n,i){let o=[],a=e.getPlayer()?.id||"",s=e.getLocation(a)||"",d=e.getContents(r).filter(u=>u.has(un.TraitType.NPC));for(let u of d){let m=u.get(un.TraitType.NPC);if(!m||!m.isAlive||!m.isConscious)continue;let f=this.getBehaviorForNpc(u);if(!f?.onPlayerLeaves)continue;let g=this.createNpcContext(u,e,n,i,s,r),h=f.onPlayerLeaves(g),y=this.executeActions(u,h,e,n);o.push(...y)}return o}onPlayerSpeaks(e,r,n,i,o){let a=e.getEntity(r);if(!a)return[];let s=a.get(un.TraitType.NPC);if(!s||!s.isAlive||!s.isConscious)return[];let c=this.getBehaviorForNpc(a);if(!c?.onSpokenTo)return[_s("npc.spoke",{npc:r,messageId:L8.NpcMessages.NPC_NO_RESPONSE,data:{npcName:a.name}},r)];let d=e.getPlayer()?.id||"",u=e.getLocation(d)||"",m=e.getLocation(r)||"",f=this.createNpcContext(a,e,i,o,u,m),g=c.onSpokenTo(f,n);return this.executeActions(a,g,e,i)}onNpcAttacked(e,r,n,i,o){let a=e.getEntity(r);if(!a)return[];let s=a.get(un.TraitType.NPC);if(!s||!s.isAlive||!s.isConscious)return[];let c=this.getBehaviorForNpc(a);if(!c?.onAttacked)return[];let d=e.getEntity(n);if(!d)return[];let u=e.getLocation(n)||"",m=e.getLocation(r)||"",f=this.createNpcContext(a,e,i,o,u,m),g=c.onAttacked(f,d);return this.executeActions(a,g,e,i)}getActiveNpcs(e){return e.getAllEntities().filter(n=>{if(!n.has(un.TraitType.NPC))return!1;let i=n.get(un.TraitType.NPC);return i.isAlive&&i.isConscious})}getBehaviorForNpc(e){let r=e.get(un.TraitType.NPC);if(r.behaviorId)return this.behaviors.get(r.behaviorId)}createNpcContext(e,r,n,i,o,a){let s=r.getContents(e.id);return{npc:e,world:r,random:n,turnCount:i,playerLocation:o,npcLocation:a,npcInventory:s,playerVisible:a===o,getEntitiesInRoom:()=>r.getContents(a),getAvailableExits:()=>this.getExitsFromRoom(r,a,e)}}getExitsFromRoom(e,r,n){let i=e.getEntity(r);if(!i)return[];let o=i.get(un.TraitType.ROOM);if(!o?.exits)return[];let a=n.get(un.TraitType.NPC),s=[];for(let[c,d]of Object.entries(o.exits)){let u=d;if(u.destination){let m=u.destination;if(!a.canMove||a.forbiddenRooms?.includes(m)||a.allowedRooms&&!a.allowedRooms.includes(m))continue;s.push({direction:c,destination:m})}}return s}executeActions(e,r,n,i){let o=[];for(let a of r){let s=this.executeAction(e,a,n,i);o.push(...s)}return o}executeAction(e,r,n,i){switch(r.type){case"move":return this.executeMove(e,r.direction,n);case"moveTo":return this.executeMoveTo(e,r.roomId,n);case"take":return this.executeTake(e,r.target,n);case"drop":return this.executeDrop(e,r.target,n);case"attack":return this.executeAttack(e,r.target,n,i);case"speak":return[_s("npc.spoke",{npc:e.id,messageId:r.messageId,data:r.data,params:r.data},e.id)];case"emote":return[_s("npc.emoted",{npc:e.id,messageId:r.messageId,data:r.data,params:r.data},e.id)];case"wait":return[];case"custom":return r.handler();default:return[]}}executeMove(e,r,n){let i=n.getLocation(e.id);if(!i)return[];let o=n.getEntity(i);if(!o)return[];let a=o.get(un.TraitType.ROOM);if(!a?.exits?.[r])return[];let s=a.exits[r].destination;return s?(n.moveEntity(e.id,s),[_s("npc.moved",{npc:e.id,from:i,to:s,direction:r},e.id)]):[]}executeMoveTo(e,r,n){let i=n.getLocation(e.id);return i?(n.moveEntity(e.id,r),[_s("npc.moved",{npc:e.id,from:i,to:r},e.id)]):[]}executeTake(e,r,n){return n.getEntity(r)?(n.moveEntity(r,e.id),[_s("npc.took",{npc:e.id,target:r},e.id)]):[]}executeDrop(e,r,n){if(!n.getEntity(r))return[];let o=n.getLocation(e.id);return o?(n.moveEntity(r,o),[_s("npc.dropped",{npc:e.id,target:r},e.id)]):[]}executeAttack(e,r,n,i){let o=n.getEntity(r);if(!o)return[];let a=M8();return a?a(e,o,n,i):[_s("npc.attacked",{npc:e.id,target:r},e.id)]}};xc.NpcService=MT;function x8(){return new MT}});var $U=p(ha=>{"use strict";Object.defineProperty(ha,"__esModule",{value:!0});ha.passiveBehavior=ha.guardBehavior=void 0;ha.createWandererBehavior=j8;ha.createFollowerBehavior=W8;ha.createPatrolBehavior=U8;var PT=LT(),rR=E();ha.guardBehavior={id:"guard",name:"Guard Behavior",onTurn(t){let e=t.npc.get(rR.TraitType.COMBATANT);if(e&&(!e.isAlive||!e.isConscious))return[];if(e?.hostile&&t.playerVisible){let r=t.world.getPlayer();if(r)return[{type:"attack",target:r.id}]}return[]},onPlayerEnters(t){let e=t.npc.get(rR.TraitType.COMBATANT);return e&&(!e.isAlive||!e.isConscious)?[]:[{type:"emote",messageId:PT.NpcMessages.GUARD_BLOCKS,data:{npcName:t.npc.name}}]},onAttacked(t,e){let r=t.npc.get(rR.TraitType.COMBATANT);return r&&(!r.isAlive||!r.isConscious)?[]:[{type:"attack",target:e.id}]}};function j8(t={}){let e=t.moveChance??.3,r=t.announceEntry??!0;return{id:"wanderer",name:"Wanderer Behavior",onTurn(n){let i=[];if(n.random.chance(e)){let o=n.getAvailableExits();if(o.length>0){let a=n.random.pick(o);i.push({type:"move",direction:a.direction}),r&&a.destination===n.playerLocation&&i.push({type:"emote",messageId:PT.NpcMessages.NPC_ENTERS,data:{npcName:n.npc.name}})}}return i},onPlayerEnters(n){return[{type:"emote",messageId:PT.NpcMessages.NPC_NOTICES_PLAYER,data:{npcName:n.npc.name}}]}}}function W8(t={}){let e=t.immediate??!0,r=t.followMessageId??PT.NpcMessages.NPC_FOLLOWS,n;return{id:"follower",name:"Follower Behavior",onTurn(i){let o=[];if(!i.playerVisible&&n){let s=i.getAvailableExits().find(c=>c.destination===i.playerLocation);s&&(o.push({type:"move",direction:s.direction}),o.push({type:"emote",messageId:r,data:{npcName:i.npc.name}}))}return n=i.playerLocation,o},onPlayerLeaves(i){if(!e)return[];let a=i.getAvailableExits().find(s=>s.destination===i.playerLocation);return a?[{type:"move",direction:a.direction},{type:"emote",messageId:r,data:{npcName:i.npc.name}}]:[]},getState(){return{lastPlayerLocation:n}},setState(i,o){n=o.lastPlayerLocation}}}ha.passiveBehavior={id:"passive",name:"Passive Behavior",onTurn(){return[]}};function U8(t={route:[]}){let e=t.route,r=t.loop??!0,n=t.waitTurns??0,i=0,o=1,a=0;return{id:"patrol",name:"Patrol Behavior",onTurn(s){if(e.length===0)return[];if(a>0)return a--,[];let c=e[i];if(s.npcLocation!==c){let u=s.getAvailableExits().find(m=>m.destination===c);if(u)return[{type:"move",direction:u.direction}]}return a=n,r?i=(i+1)%e.length:(i+=o,(i>=e.length-1||i<=0)&&(o*=-1)),[]},getState(){return{currentWaypoint:i,direction:o,waitCounter:a}},setState(s,c){i=c.currentWaypoint??0,o=c.direction??1,a=c.waitCounter??0}}}});var XU=p(ze=>{"use strict";var H8=ze&&ze.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),QU=ze&&ze.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&H8(e,t,r)};Object.defineProperty(ze,"__esModule",{value:!0});ze.createPatrolBehavior=ze.createFollowerBehavior=ze.createWandererBehavior=ze.passiveBehavior=ze.guardBehavior=ze.clearNpcCombatResolver=ze.registerNpcCombatResolver=ze.createNpcService=ze.NpcService=void 0;QU(zU(),ze);QU(LT(),ze);var kT=KU();Object.defineProperty(ze,"NpcService",{enumerable:!0,get:function(){return kT.NpcService}});Object.defineProperty(ze,"createNpcService",{enumerable:!0,get:function(){return kT.createNpcService}});Object.defineProperty(ze,"registerNpcCombatResolver",{enumerable:!0,get:function(){return kT.registerNpcCombatResolver}});Object.defineProperty(ze,"clearNpcCombatResolver",{enumerable:!0,get:function(){return kT.clearNpcCombatResolver}});var nm=$U();Object.defineProperty(ze,"guardBehavior",{enumerable:!0,get:function(){return nm.guardBehavior}});Object.defineProperty(ze,"passiveBehavior",{enumerable:!0,get:function(){return nm.passiveBehavior}});Object.defineProperty(ze,"createWandererBehavior",{enumerable:!0,get:function(){return nm.createWandererBehavior}});Object.defineProperty(ze,"createFollowerBehavior",{enumerable:!0,get:function(){return nm.createFollowerBehavior}});Object.defineProperty(ze,"createPatrolBehavior",{enumerable:!0,get:function(){return nm.createPatrolBehavior}})});var BT=p(im=>{"use strict";Object.defineProperty(im,"__esModule",{value:!0});im.OPENED_REVEALED_CHAIN_KEY=void 0;im.createOpenedRevealedChain=G8;var q8=E();im.OPENED_REVEALED_CHAIN_KEY="stdlib.chain.opened-revealed";function G8(){return(t,e)=>{let r=t.data,{targetId:n,targetName:i}=r;if(!n)return null;let o=e.getEntity(n);if(!o||!o.has(q8.TraitType.CONTAINER))return null;let a=e.getContents(n);if(a.length===0)return null;let s={containerId:n,containerName:i||o.name||"container",items:a.map(d=>({entityId:d.id,messageId:d.name||d.id}))};return{id:`revealed-${n}-${Date.now()}`,type:"if.event.revealed",timestamp:Date.now(),entities:{target:n,others:a.map(d=>d.id)},data:s}}}});var JU=p(jc=>{"use strict";Object.defineProperty(jc,"__esModule",{value:!0});jc.createOpenedRevealedChain=jc.OPENED_REVEALED_CHAIN_KEY=void 0;jc.registerStandardChains=F8;var ZU=BT();function F8(t){t.chainEvent("if.event.opened",(0,ZU.createOpenedRevealedChain)(),{key:ZU.OPENED_REVEALED_CHAIN_KEY,priority:100})}var V8=BT();Object.defineProperty(jc,"OPENED_REVEALED_CHAIN_KEY",{enumerable:!0,get:function(){return V8.OPENED_REVEALED_CHAIN_KEY}});var Y8=BT();Object.defineProperty(jc,"createOpenedRevealedChain",{enumerable:!0,get:function(){return Y8.createOpenedRevealedChain}})});var tH=p(om=>{"use strict";Object.defineProperty(om,"__esModule",{value:!0});om.meetsActionRequirements=eH;om.findValidTargets=z8;om.tryInferTarget=K8;function eH(t,e,r){let n=e.targetRequirements;if(!n)return!0;if(n.trait){if(!t.has(n.trait))return!1;if(n.condition){let i=t.get(n.trait);if(!i)return!1;switch(n.condition){case"not_open":return i.isOpen!==!0;case"is_open":return i.isOpen===!0;case"not_locked":return i.isLocked===!0;case"is_locked":return i.isLocked!==!0;case"not_on":return i.isOn!==!0;case"is_on":return i.isOn===!0;default:return!0}}}return!0}function z8(t,e,r){return e.filter(n=>eH(n,t,r))}function K8(t,e,r,n,i){return e?{inferred:!1,originalTarget:t,failureReason:"not_pronoun"}:{inferred:!1,originalTarget:t,failureReason:"not_pronoun"}}});var rH=p(bs=>{"use strict";Object.defineProperty(bs,"__esModule",{value:!0});bs.findValidTargets=bs.meetsActionRequirements=bs.tryInferTarget=void 0;var nR=tH();Object.defineProperty(bs,"tryInferTarget",{enumerable:!0,get:function(){return nR.tryInferTarget}});Object.defineProperty(bs,"meetsActionRequirements",{enumerable:!0,get:function(){return nR.meetsActionRequirements}});Object.defineProperty(bs,"findValidTargets",{enumerable:!0,get:function(){return nR.findValidTargets}})});var zi=p(At=>{"use strict";var $8=At&&At.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),mn=At&&At.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&$8(e,t,r)};Object.defineProperty(At,"__esModule",{value:!0});mn(pU(),At);mn(_U(),At);mn(ZA(),At);mn(IU(),At);mn(AU(),At);mn(jU(),At);mn(qU(),At);mn(Gi(),At);mn(VU(),At);mn(XU(),At);mn(qA(),At);mn(JU(),At);mn(rH(),At)});var sR=p(aR=>{"use strict";Object.defineProperty(aR,"__esModule",{value:!0});aR.createActionContext=oH;var Ye=zi(),iR=E(),Q8=Ve(),nH=Mp();function iH(t,e){switch(e){case"target":case"directObject":case"item":return t.directObject?.entity??null;case"container":case"recipient":case"instrument":case"indirectObject":return t.indirectObject?.entity??null;default:return t.directObject?.entity??null}}function oR(t,e,r){let n={item:r.name};return e===Ye.ScopeLevel.UNAWARE?{valid:!1,error:Ye.ScopeErrors.NOT_KNOWN,params:n}:t>=Ye.ScopeLevel.VISIBLE&&e<Ye.ScopeLevel.VISIBLE?{valid:!1,error:Ye.ScopeErrors.NOT_VISIBLE,params:n}:t>=Ye.ScopeLevel.REACHABLE&&e<Ye.ScopeLevel.REACHABLE?{valid:!1,error:Ye.ScopeErrors.NOT_REACHABLE,params:n}:t>=Ye.ScopeLevel.CARRIED&&e<Ye.ScopeLevel.CARRIED?{valid:!1,error:Ye.ScopeErrors.NOT_CARRIED,params:n}:{valid:!1,error:Ye.ScopeErrors.OUT_OF_SCOPE,params:n}}function oH(t,e,r,n,i){let o=e.player,a=t.getLocation(o.id)?t.getEntity(t.getLocation(o.id)):o,s={};return{world:t,player:o,currentLocation:a,command:r,scopeResolver:i,action:n,sharedData:s,validationResult:void 0,canSee:d=>i.canSee(o,d),canReach:d=>i.canReach(o,d),canTake:d=>!d.has("if.trait.scenery")&&!d.has("if.trait.fixed")&&d.type!=="room"&&d.type!=="location",isInScope:d=>i.getScope(o,d)>=Ye.ScopeLevel.AWARE,getVisible:()=>i.getVisible(o),getInScope:()=>t.getAllEntities().filter(u=>i.getScope(o,u)>=Ye.ScopeLevel.AWARE),getEntityScope:d=>i.getScope(o,d),getSlotScope:d=>{let u=iH(r,d);return u?i.getScope(o,u):Ye.ScopeLevel.UNAWARE},requireScope:(d,u)=>{let m=i.getScope(o,d);return m>=u?{ok:!0,actualScope:m}:{ok:!1,error:oR(u,m,d),actualScope:m}},requireSlotScope:(d,u)=>{let m=iH(r,d);if(!m)return{ok:!1,error:{valid:!1,error:"no_target",params:{slot:d}}};let f=i.getScope(o,m);return f>=u?{ok:!0,actualScope:f}:{ok:!1,error:oR(u,f,m),actualScope:f}},requireCarriedOrImplicitTake:d=>{let u=i.getScope(o,d);if(u>=Ye.ScopeLevel.CARRIED)return{ok:!0};if(u<Ye.ScopeLevel.REACHABLE)return{ok:!1,error:oR(Ye.ScopeLevel.REACHABLE,u,d)};if(e.implicitActions?.implicitTake===!1)return{ok:!1,error:{valid:!1,error:Ye.ScopeErrors.NOT_CARRIED,params:{item:d.name}}};if(n.allowImplicitTake===!1)return{ok:!1,error:{valid:!1,error:Ye.ScopeErrors.NOT_CARRIED,params:{item:d.name}}};if(d.has(iR.TraitType.SCENERY)||d.has(iR.TraitType.ROOM)||d.has(iR.TraitType.DOOR))return{ok:!1,error:{valid:!1,error:"fixed_in_place",params:{item:d.name}}};let m={parsed:{rawInput:`take ${d.name}`,action:Ye.takingAction.id,tokens:[],structure:{verb:{tokens:[0],text:"take",head:"take"}},pattern:"VERB_NOUN",confidence:1},actionId:Ye.takingAction.id,directObject:{entity:d,parsed:{text:d.name,candidates:[d.name]}}},f=oH(t,e,m,Ye.takingAction,i),g=Ye.takingAction.validate(f);if(!g.valid)return{ok:!1,error:{valid:!1,error:g.error||"cannot_take",params:g.params}};Ye.takingAction.execute(f);let y=(Ye.takingAction.report?Ye.takingAction.report(f):[]).filter(L=>L.type!=="action.success"),I=[(0,Q8.createEvent)("if.event.implicit_take",{item:d.id,itemName:d.name},{actor:o.id,target:d.id,location:a?.id||o.id}),...y],A=s[nH.SharedDataKeys.IMPLICIT_TAKE_EVENTS]??[];return s[nH.SharedDataKeys.IMPLICIT_TAKE_EVENTS]=[...A,...I],{ok:!0,implicitTakeEvents:I}},event:(d,u)=>{let m={actor:o.id,location:a?.id||o.id};return r.directObject?.entity&&(m.target=r.directObject.entity.id),r.indirectObject?.entity&&(m.indirect=r.indirectObject.entity.id),{id:`evt_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,type:d,timestamp:Date.now(),data:{...u,actionId:n.id,turn:e.currentTurn},entities:m}}}}});var dR=p(Is=>{"use strict";Object.defineProperty(Is,"__esModule",{value:!0});Is.checkCapabilityDispatch=X8;Is.checkCapabilityDispatchMulti=sH;Is.executeCapabilityValidate=Z8;Is.executeCapabilityExecute=J8;Is.executeCapabilityReport=e2;Is.executeCapabilityBlocked=t2;var cR=E();function X8(t,e){return e?sH(t,[e]):{shouldDispatch:!1}}function sH(t,e){let r=e.filter(s=>s!==void 0);if(r.length===0)return{shouldDispatch:!1};let n=[];for(let s of r){let c=(0,cR.findTraitWithCapability)(s,t);if(!c)continue;let d=(0,cR.getBehaviorBinding)(c,t);if(!d){console.warn(`Universal dispatch: trait "${c.type}" claims "${t}" but no behavior registered. Falling back to stdlib action.`);continue}n.push({entity:s,trait:c,behavior:d.behavior,priority:d.priority,resolutionOverride:d.resolution})}if(n.length===0)return{shouldDispatch:!1};n.sort((s,c)=>c.priority-s.priority);let i=n.find(s=>s.resolutionOverride)?.resolutionOverride,o=(0,cR.getCapabilityConfig)(t),a=i??o.resolution;if(n.length===1||a==="first-wins"||a==="highest-priority"){let s=n[0];return{shouldDispatch:!0,trait:s.trait,behavior:s.behavior,entity:s.entity,claims:n,resolution:a}}return{shouldDispatch:!0,trait:n[0].trait,behavior:n[0].behavior,entity:n[0].entity,claims:n,resolution:a}}function cH(t,e){return t.map(r=>e.event(r.type,r.payload))}function Z8(t,e){let{trait:r,behavior:n,entity:i,claims:o,resolution:a}=t;if(!r||!n||!i)return{valid:!1,error:"capability_dispatch_error"};let s={};if(!o||o.length<=1||a==="first-wins"||a==="highest-priority")return aH(i,r,n,e,s);if(a==="any-blocks"){for(let d of o){let u={},m=d.behavior.validate(d.entity,e.world,e.player.id,u);if(!m.valid){let f={trait:d.trait,behavior:d.behavior,entityId:d.entity.id,entityName:d.entity.name,sharedData:u};return{valid:!1,error:m.error,params:m.params,data:f}}}return{valid:!0,data:{trait:r,behavior:n,entityId:i.id,entityName:i.name,sharedData:s}}}if(a==="all-must-pass"){for(let d of o){let u={},m=d.behavior.validate(d.entity,e.world,e.player.id,u);if(!m.valid){let f={trait:d.trait,behavior:d.behavior,entityId:d.entity.id,entityName:d.entity.name,sharedData:u};return{valid:!1,error:m.error,params:m.params,data:f}}}return{valid:!0,data:{trait:r,behavior:n,entityId:i.id,entityName:i.name,sharedData:s}}}return aH(i,r,n,e,s)}function aH(t,e,r,n,i){let o=r.validate(t,n.world,n.player.id,i),a={trait:e,behavior:r,entityId:t.id,entityName:t.name,sharedData:i};return o.valid?{valid:!0,data:a}:{valid:!1,error:o.error,params:o.params,data:a}}function J8(t){let e=t.validationResult?.data,r=t.command.directObject?.entity;!r||!e?.behavior||e.behavior.execute(r,t.world,t.player.id,e.sharedData)}function e2(t){let e=t.validationResult?.data,r=t.command.directObject?.entity;if(!r||!e?.behavior)return[];let n=e.behavior.report(r,t.world,t.player.id,e.sharedData);return cH(n,t)}function t2(t,e,r){let n=t.validationResult?.data??e.data,i=t.command.directObject?.entity;if(i&&n?.behavior){let o=n.behavior.blocked(i,t.world,t.player.id,e.error||"action_blocked",n.sharedData);return cH(o,t)}return[t.event("action.blocked",{actionId:r,messageId:e.error||"action_blocked",params:e.params||{}})]}});var WT=p(am=>{"use strict";Object.defineProperty(am,"__esModule",{value:!0});am.CommandExecutor=void 0;am.createCommandExecutor=n2;var dH=Ve(),r2=Tu(),lR=Mp(),uR=zi(),xT=du(),lH=sR(),Wc=dR(),jT=class{constructor(e,r,n,i,o){l(this,"parser");l(this,"validator");l(this,"actionRegistry");l(this,"eventProcessor");l(this,"scopeResolver");l(this,"parsedCommandTransformers",[]);if(!e)throw new Error("World model is required");if(!r)throw new Error("Action registry is required");if(!n)throw new Error("Event processor is required");if(!i)throw new Error("Parser is required");this.parser=i,this.validator=new uR.CommandValidator(e,r),o&&this.validator.setSystemEventSource(o),this.actionRegistry=r,this.eventProcessor=n}registerParsedCommandTransformer(e){this.parsedCommandTransformers.push(e)}unregisterParsedCommandTransformer(e){let r=this.parsedCommandTransformers.indexOf(e);return r!==-1?(this.parsedCommandTransformers.splice(r,1),!0):!1}async execute(e,r,n,i){let o=n.currentTurn;xT.eventSequencer.resetTurn(o);let a=i?.collectTiming?Date.now():0,s=0,c=0;try{let d=r.getPlayer();if(d&&(0,r2.hasWorldContext)(this.parser)){let Be=r.getLocation(d.id)||"";this.parser.setWorldContext(r,d.id,Be)}let u=i?.collectTiming?Date.now():0,m=this.parser.parse(e);if(i?.collectTiming&&(s=Date.now()-u),!m.success)throw new Error(`Parse failed: ${m.error.code}`);let f=m.value;for(let Be of this.parsedCommandTransformers)f=Be(f,r);let g=this.validator.validate(f);if(!g.success){if(g.error.code==="AMBIGUOUS_ENTITY"){let Be=g.error.details||{},cM=Be.ambiguousEntities||[],yp=xT.eventSequencer.sequence({type:"client.query",data:{source:dH.QuerySource.DISAMBIGUATION,type:dH.QueryType.DISAMBIGUATION,messageId:"core.disambiguation_prompt",candidates:cM,searchText:Be.searchText,originalCommand:f}},o);return{turn:o,input:e,success:!1,needsInput:!0,events:[yp],error:"DISAMBIGUATION_NEEDED"}}throw new Error(`Validation failed: ${g.error.code}`)}let h=i?.collectTiming?Date.now():0,y=g.value,T=this.actionRegistry.get(y.actionId);if(!T)throw new Error(`Action not found: ${y.actionId}`);this.scopeResolver||(this.scopeResolver=(0,uR.createScopeResolver)(r));let I=(0,lH.createActionContext)(r,n,y,T,this.scopeResolver),A=[y.directObject?.entity,y.indirectObject?.entity],L=(0,Wc.checkCapabilityDispatchMulti)(y.actionId,A),S=L.shouldDispatch?(0,Wc.executeCapabilityValidate)(L,I):T.validate(I),R=y,k=I,w=L.shouldDispatch,Te=n.implicitActions?.inference!==!1;if(!S.valid&&T.targetRequirements&&Te){let Be=y.directObject,yp=Be?.parsed?.wasPronoun===!0;if(yp&&Be?.entity){let cK=this.scopeResolver.getVisible(r.getPlayer()),Ad=(0,uR.tryInferTarget)(Be.entity,yp,T,cK,r);if(Ad.inferred&&Ad.inferredTarget){let dM={...y,directObject:{entity:Ad.inferredTarget,parsed:{...Be.parsed,text:Ad.inferredTarget.name}}},Tp=(0,lH.createActionContext)(r,n,dM,T,this.scopeResolver),Pb=Tp.sharedData;Pb[lR.SharedDataKeys.INFERENCE_PERFORMED]=!0,Pb[lR.SharedDataKeys.ORIGINAL_TARGET]=Be.entity,Pb[lR.SharedDataKeys.INFERRED_TARGET]=Ad.inferredTarget;let dK=[Ad.inferredTarget,y.indirectObject?.entity],kb=(0,Wc.checkCapabilityDispatchMulti)(y.actionId,dK),lM=kb.shouldDispatch?(0,Wc.executeCapabilityValidate)(kb,Tp):T.validate(Tp);lM.valid&&(S=lM,R=dM,k=Tp,w=kb.shouldDispatch)}}}k.validationResult=S;let Oe;if(S.valid)if(w)(0,Wc.executeCapabilityExecute)(k),Oe=(0,Wc.executeCapabilityReport)(k);else{let Be=T.execute(k);if(Be==null)if(T.report)Oe=T.report(k);else throw new Error(`Action ${T.id} uses new pattern but lacks report()`);else Oe=Be}else w?Oe=(0,Wc.executeCapabilityBlocked)(k,S,y.actionId):T.blocked?Oe=T.blocked(k,S):Oe=[{id:`${o}-error`,type:"action.error",timestamp:Date.now(),data:{actionId:y.actionId,messageId:S.error||"validation_failed",params:S.params||{}},entities:{}}];i?.collectTiming&&(c=Date.now()-h);let ue=Oe;if(Oe.length>0){let Be=this.eventProcessor.processEvents(Oe);Be.reactions&&Be.reactions.length>0&&(ue=[...Oe,...Be.reactions])}let mt=xT.eventSequencer.sequenceAll(ue,o),le={turn:o,input:e,success:!Oe.some(Be=>Be.type==="action.error"),events:mt,actionId:y.actionId,parsedCommand:y.parsed,validatedCommand:y};return i?.collectTiming&&(le.timing={parsing:s,execution:c,total:Date.now()-a}),le}catch(d){let u={turn:o,input:e,success:!1,events:[xT.eventSequencer.sequence({type:"command.failed",data:{reason:d.message,input:e}},o)],error:d.message};return i?.collectTiming&&(u.timing={parsing:s,execution:c,total:Date.now()-a}),u}}};am.CommandExecutor=jT;function n2(t,e,r,n,i){return new jT(t,e,r,n,i)}});var mH=p(uH=>{"use strict";Object.defineProperty(uH,"__esModule",{value:!0})});var mR=p(Re=>{"use strict";Object.defineProperty(Re,"__esModule",{value:!0});Re.handleClimbed=Re.handleExited=Re.handleEntered=Re.handleRemovedFrom=Re.handlePutOn=Re.handlePutIn=Re.handleActorMoved=Re.handleRemoved=Re.handleDropped=Re.handleTaken=void 0;Re.registerMovementHandlers=f2;var Os=E(),Ki=jt(),i2=(t,e)=>{let{actor:r,target:n}=t.entities;if(r&&n){let i=e.getEntity(n);i&&i.has(Os.TraitType.WEARABLE)&&e.updateEntity(n,o=>{let a=o.get(Os.TraitType.WEARABLE);a?.worn&&(a.worn=!1)}),e.moveEntity(n,r)}};Re.handleTaken=i2;var o2=(t,e)=>{let{actor:r,target:n,location:i}=t.entities,o=i||(r?e.getLocation(r):void 0);n&&o&&e.moveEntity(n,o)};Re.handleDropped=o2;var a2=(t,e)=>{let{target:r}=t.entities;if(r){let n=e.getEntity(r);n&&n.has(Os.TraitType.WEARABLE)&&e.updateEntity(r,i=>{let o=i.get(Os.TraitType.WEARABLE);o?.worn&&(o.worn=!1)})}};Re.handleRemoved=a2;var s2=(t,e)=>{let{actor:r,location:n}=t.entities;if(r&&n){let i=e.getLocation(r);if(i){let a=e.getEntity(i);a&&a.has(Os.TraitType.ROOM)&&e.updateEntity(i,s=>{let c=s.get(Os.TraitType.ROOM);c&&!c.visited&&(c.visited=!0)})}e.moveEntity(r,n);let o=e.getEntity(n);o&&o.has(Os.TraitType.ROOM)&&e.updateEntity(n,a=>{let s=a.get(Os.TraitType.ROOM);s&&!s.visited&&(s.visited=!0)})}};Re.handleActorMoved=s2;var c2=(t,e)=>{let{target:r,location:n}=t.entities;r&&n&&e.moveEntity(r,n)};Re.handlePutIn=c2;var d2=(t,e)=>{let{target:r,location:n}=t.entities;r&&n&&e.moveEntity(r,n)};Re.handlePutOn=d2;var l2=(t,e)=>{let{actor:r,target:n}=t.entities;r&&n&&e.moveEntity(n,r)};Re.handleRemovedFrom=l2;var u2=(t,e)=>{let{actor:r,location:n}=t.entities;r&&n&&e.moveEntity(r,n)};Re.handleEntered=u2;var m2=(t,e)=>{let{actor:r,location:n}=t.entities;r&&n&&e.moveEntity(r,n)};Re.handleExited=m2;var p2=(t,e)=>{};Re.handleClimbed=p2;function f2(t){t.registerEventHandler(Ki.IFEvents.TAKEN,Re.handleTaken),t.registerEventHandler(Ki.IFEvents.DROPPED,Re.handleDropped),t.registerEventHandler(Ki.IFEvents.REMOVED,Re.handleRemoved),t.registerEventHandler(Ki.IFEvents.ACTOR_MOVED,Re.handleActorMoved),t.registerEventHandler(Ki.IFEvents.PUT_IN,Re.handlePutIn),t.registerEventHandler(Ki.IFEvents.PUT_ON,Re.handlePutOn),t.registerEventHandler(Ki.IFEvents.REMOVED_FROM,Re.handleRemovedFrom),t.registerEventHandler(Ki.IFEvents.ENTERED,Re.handleEntered),t.registerEventHandler(Ki.IFEvents.EXITED,Re.handleExited),t.registerEventHandler(Ki.IFEvents.CLIMBED,Re.handleClimbed)}});var pR=p(Pe=>{"use strict";Object.defineProperty(Pe,"__esModule",{value:!0});Pe.handleDrunk=Pe.handleEaten=Pe.handleWorn=Pe.handleSwitchedOff=Pe.handleSwitchedOn=Pe.handleUnlocked=Pe.handleLocked=Pe.handleClosed=Pe.handleOpened=void 0;Pe.registerStateChangeHandlers=O2;var Ta=E(),ya=jt(),g2=(t,e)=>{let{target:r}=t.entities;r&&e.updateEntity(r,n=>{let i=n.get(Ta.TraitType.OPENABLE);i&&(i.isOpen=!0)})};Pe.handleOpened=g2;var h2=(t,e)=>{let{target:r}=t.entities;r&&e.updateEntity(r,n=>{let i=n.get(Ta.TraitType.OPENABLE);i&&(i.isOpen=!1)})};Pe.handleClosed=h2;var y2=(t,e)=>{let{target:r}=t.entities;r&&e.updateEntity(r,n=>{let i=n.get(Ta.TraitType.LOCKABLE);i&&(i.isLocked=!0)})};Pe.handleLocked=y2;var T2=(t,e)=>{let{target:r}=t.entities;r&&e.updateEntity(r,n=>{let i=n.get(Ta.TraitType.LOCKABLE);i&&(i.isLocked=!1)})};Pe.handleUnlocked=T2;var E2=(t,e)=>{let{target:r}=t.entities;r&&e.updateEntity(r,n=>{let i=n.get(Ta.TraitType.SWITCHABLE);i&&(i.isOn=!0);let o=n.get(Ta.TraitType.LIGHT_SOURCE);o&&(o.isLit=!0)})};Pe.handleSwitchedOn=E2;var v2=(t,e)=>{let{target:r}=t.entities;r&&e.updateEntity(r,n=>{let i=n.get(Ta.TraitType.SWITCHABLE);i&&(i.isOn=!1);let o=n.get(Ta.TraitType.LIGHT_SOURCE);o&&(o.isLit=!1)})};Pe.handleSwitchedOff=v2;var _2=(t,e)=>{let{target:r}=t.entities;r&&e.updateEntity(r,n=>{let i=n.get(Ta.TraitType.WEARABLE);i&&(i.worn=!0)})};Pe.handleWorn=_2;var b2=(t,e)=>{let{target:r}=t.entities;r&&e.removeEntity(r)};Pe.handleEaten=b2;var I2=(t,e)=>{let{target:r}=t.entities;r&&e.removeEntity(r)};Pe.handleDrunk=I2;function O2(t){t.registerEventHandler(ya.IFEvents.OPENED,Pe.handleOpened),t.registerEventHandler(ya.IFEvents.CLOSED,Pe.handleClosed),t.registerEventHandler(ya.IFEvents.LOCKED,Pe.handleLocked),t.registerEventHandler(ya.IFEvents.UNLOCKED,Pe.handleUnlocked),t.registerEventHandler(ya.IFEvents.SWITCHED_ON,Pe.handleSwitchedOn),t.registerEventHandler(ya.IFEvents.SWITCHED_OFF,Pe.handleSwitchedOff),t.registerEventHandler(ya.IFEvents.WORN,Pe.handleWorn),t.registerEventHandler(ya.IFEvents.EATEN,Pe.handleEaten),t.registerEventHandler(ya.IFEvents.DRUNK,Pe.handleDrunk)}});var fR=p($i=>{"use strict";Object.defineProperty($i,"__esModule",{value:!0});$i.handlePlayerCheckedInventory=pH;$i.handlePlayerInventoryEmpty=fH;$i.handleTextInventoryList=gH;$i.handlePlayerLooked=hH;$i.handlePlayerExamined=yH;$i.handleTextRoomDescription=TH;$i.handleTextListContents=EH;$i.registerObservationHandlers=S2;function pH(t,e){let r=t.data}function fH(t,e){let r=t.data}function gH(t,e){let r=t.data}function hH(t,e){let r=t.data}function yH(t,e){let r=t.data}function TH(t,e){let r=t.data}function EH(t,e){let r=t.data}function S2(t){t.registerEventHandler("player.looked",hH),t.registerEventHandler("player.examined",yH),t.registerEventHandler("text.room_description",TH),t.registerEventHandler("text.list_contents",EH),t.registerEventHandler("player.checked_inventory",pH),t.registerEventHandler("player.inventory_empty",fH),t.registerEventHandler("text.inventory_list",gH)}});var gR=p(gr=>{"use strict";Object.defineProperty(gr,"__esModule",{value:!0});gr.handleTouched=gr.handleSmelled=gr.handleListened=gr.handleSearched=void 0;gr.registerSensoryHandlers=D2;var A2=Ve(),vH=E(),UT=jt(),R2=(t,e)=>{let{target:r}=t.entities,n=(0,A2.getUntypedEventData)(t),i=Array.isArray(n?.foundItems)?n.foundItems:[];r&&i&&i.length>0&&i.forEach(o=>{e.updateEntity(o,a=>{if(a.has(vH.TraitType.IDENTITY)){let s=a.get(vH.TraitType.IDENTITY);s.concealed=!1}})})};gr.handleSearched=R2;var C2=(t,e)=>{};gr.handleListened=C2;var w2=(t,e)=>{};gr.handleSmelled=w2;var N2=(t,e)=>{let{target:r}=t.entities};gr.handleTouched=N2;function D2(t){t.registerEventHandler(UT.IFEvents.SEARCHED,gr.handleSearched),t.registerEventHandler(UT.IFEvents.LISTENED,gr.handleListened),t.registerEventHandler(UT.IFEvents.SMELLED,gr.handleSmelled),t.registerEventHandler(UT.IFEvents.TOUCHED,gr.handleTouched)}});var bH=p(Ss=>{"use strict";var L2=Ss&&Ss.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),_H=Ss&&Ss.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&L2(e,t,r)};Object.defineProperty(Ss,"__esModule",{value:!0});_H(fR(),Ss);_H(gR(),Ss)});var hR=p(Uc=>{"use strict";Object.defineProperty(Uc,"__esModule",{value:!0});Uc.handleWaited=IH;Uc.handleScoreDisplayed=OH;Uc.handleHelpDisplayed=SH;Uc.handleAboutDisplayed=AH;Uc.registerMetaHandlers=M2;function IH(t,e){let r=t.data}function OH(t,e){let r=t.data}function SH(t,e){let r=t.data}function AH(t,e){let r=t.data}function M2(t){t.registerEventHandler("waited",IH),t.registerEventHandler("score_displayed",OH),t.registerEventHandler("help_displayed",SH),t.registerEventHandler("about_displayed",AH)}});var TR=p(hr=>{"use strict";Object.defineProperty(hr,"__esModule",{value:!0});hr.handleItemDestroyed=hr.handleThrown=hr.handleShown=hr.handleGiven=void 0;hr.registerComplexManipulationHandlers=j2;var yR=Ve(),HT=jt(),P2=(t,e)=>{let{actor:r,target:n,instrument:i,location:o}=t.entities,s=!!(0,yR.getUntypedEventData)(t)?.accepted;n&&o&&s&&e.moveEntity(n,o)};hr.handleGiven=P2;var k2=(t,e)=>{let{actor:r,target:n,instrument:i}=t.entities};hr.handleShown=k2;var B2=(t,e)=>{let{target:r,location:n}=t.entities,i=(0,yR.getUntypedEventData)(t),o=!!i?.willBreak,a=typeof i?.finalLocation=="string"?i.finalLocation:void 0;r&&(o?e.removeEntity(r):a&&e.moveEntity(r,a))};hr.handleThrown=B2;var x2=(t,e)=>{let r=(0,yR.getUntypedEventData)(t),n=typeof r?.item=="string"?r.item:void 0;n&&e.removeEntity(n)};hr.handleItemDestroyed=x2;function j2(t){t.registerEventHandler(HT.IFEvents.GIVEN,hr.handleGiven),t.registerEventHandler(HT.IFEvents.SHOWN,hr.handleShown),t.registerEventHandler(HT.IFEvents.THROWN,hr.handleThrown),t.registerEventHandler(HT.IFEvents.ITEM_DESTROYED,hr.handleItemDestroyed)}});var ER=p(yr=>{"use strict";Object.defineProperty(yr,"__esModule",{value:!0});yr.handleUsed=yr.handleTurned=yr.handlePulled=yr.handlePushed=void 0;yr.registerDeviceHandlers=G2;var GT=Ve(),As=E(),qT=jt(),W2=(t,e)=>{let{target:r,location:n}=t.entities,i=(0,GT.getUntypedEventData)(t),o=String(i?.pushType||"");if(!r)return;let a=e.getEntity(r);if(a)switch(o){case"button":if(a.has(As.TraitType.SWITCHABLE)&&i?.willToggle){let s=a.get(As.TraitType.SWITCHABLE);s.isOn=i?.newState}break;case"moveable":case"heavy":i?.moved&&i?.moveDirection&&n&&i?.revealsPassage;break;case"fixed":break}};yr.handlePushed=W2;var U2=(t,e)=>{let{target:r}=t.entities,n=(0,GT.getUntypedEventData)(t),i=String(n?.pullType||"");if(!r)return;let o=e.getEntity(r);if(o)switch(i){case"lever":case"cord":if(o.has(As.TraitType.SWITCHABLE)&&n?.willToggle){let a=o.get(As.TraitType.SWITCHABLE);a.isOn=n?.newState}break;case"attached":n?.willDetach;break;case"moveable":n?.moved&&n?.moveDirection;break}};yr.handlePulled=U2;var H2=(t,e)=>{let{target:r}=t.entities,n=(0,GT.getUntypedEventData)(t),i=String(n?.turnType||""),o=n?.newSetting;if(!r)return;let a=e.getEntity(r);if(a)switch(i){case"dial":case"knob":if(a.has(As.TraitType.SWITCHABLE)&&n?.willToggle){let s=a.get(As.TraitType.SWITCHABLE);s.isOn=n?.newState}break;case"wheel":case"crank":n?.activatesMechanism;break}};yr.handleTurned=H2;var q2=(t,e)=>{let{target:r}=t.entities,n=(0,GT.getUntypedEventData)(t),i=String(n?.useType||"");if(!r)return;let o=e.getEntity(r);if(o)switch(i){case"device":if(o.has(As.TraitType.SWITCHABLE)){let a=o.get(As.TraitType.SWITCHABLE);a.isOn=!a.isOn}break;case"tool":break;case"consumable":n?.consumed&&e.removeEntity(r);break}};yr.handleUsed=q2;function G2(t){t.registerEventHandler(qT.IFEvents.PUSHED,yr.handlePushed),t.registerEventHandler(qT.IFEvents.PULLED,yr.handlePulled),t.registerEventHandler(qT.IFEvents.TURNED,yr.handleTurned),t.registerEventHandler(qT.IFEvents.USED,yr.handleUsed)}});var vR=p(pn=>{"use strict";var F2=pn&&pn.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),Tl=pn&&pn.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&F2(e,t,r)};Object.defineProperty(pn,"__esModule",{value:!0});pn.registerStandardHandlers=Z2;Tl(mR(),pn);Tl(pR(),pn);Tl(bH(),pn);Tl(hR(),pn);Tl(TR(),pn);Tl(ER(),pn);var V2=mR(),Y2=pR(),z2=fR(),K2=gR(),$2=hR(),Q2=TR(),X2=ER();function Z2(t){(0,V2.registerMovementHandlers)(t),(0,Y2.registerStateChangeHandlers)(t),(0,z2.registerObservationHandlers)(t),(0,K2.registerSensoryHandlers)(t),(0,$2.registerMetaHandlers)(t),(0,Q2.registerComplexManipulationHandlers)(t),(0,X2.registerDeviceHandlers)(t)}});var CH=p(RH=>{"use strict";Object.defineProperty(RH,"__esModule",{value:!0})});var wH=p(_R=>{"use strict";Object.defineProperty(_R,"__esModule",{value:!0});_R.createWorldQuery=J2;function J2(t){return{getEntity:e=>t.getEntity(e),hasEntity:e=>t.hasEntity(e),getPlayer:()=>t.getPlayer(),getCurrentRoom:()=>{let e=t.getPlayer();return e?t.getContainingRoom(e.id):void 0},getContainingRoom:e=>t.getContainingRoom(e),getLocation:e=>t.getLocation(e),getContents:e=>t.getContents(e),findByTrait:e=>t.findByTrait(e),findWhere:e=>t.findWhere(e),getStateValue:e=>t.getStateValue(e),getCapability:e=>t.getCapability(e),hasCapability:e=>t.hasCapability(e)}}});var NH=p(FT=>{"use strict";Object.defineProperty(FT,"__esModule",{value:!0});FT.EffectProcessor=void 0;var e7=E(),bR=class{constructor(e,r){l(this,"world");l(this,"emitEvents");l(this,"pendingEmittedEvents",[]);this.world=e,this.emitEvents=r}process(e){this.pendingEmittedEvents=[];let r=this.validateAll(e);if(r.length>0)return{success:!1,errors:r,applied:[]};for(let i of e)this.apply(i);let n=this.pendingEmittedEvents.length>0?[...this.pendingEmittedEvents]:void 0;return this.pendingEmittedEvents=[],{success:!0,errors:[],applied:e,emittedEvents:n}}validateAll(e){let r=[];for(let n of e){let i=this.validate(n);i&&r.push({effect:n,reason:i})}return r}validate(e){switch(e.type){case"score":if(typeof e.points!="number")return"points must be a number";break;case"flag":if(!e.name||typeof e.name!="string")return"flag name required";if(typeof e.value!="boolean")return"flag value must be a boolean";break;case"message":if(!e.id||typeof e.id!="string")return"message id required";break;case"emit":if(!e.event||!e.event.type)return"emit effect requires a valid event";break;case"move_entity":if(!e.entityId)return"entityId required";if(!this.world.hasEntity(e.entityId))return`entity ${e.entityId} not found`;if(e.destination!==null&&!this.world.hasEntity(e.destination))return`destination ${e.destination} not found`;break;case"update_entity":if(!e.entityId)return"entityId required";if(!this.world.hasEntity(e.entityId))return`entity ${e.entityId} not found`;break;case"set_state":if(!e.key||typeof e.key!="string")return"state key required";break;case"update_exits":if(!e.roomId)return"roomId required";if(!this.world.hasEntity(e.roomId))return`room ${e.roomId} not found`;break;case"unblock":case"block":if(!e.room)return"room required";if(!this.world.hasEntity(e.room))return`room ${e.room} not found`;if(!e.exit)return"exit direction required";break;case"schedule":if(!e.daemon||typeof e.daemon!="string")return"daemon id required";if(typeof e.turns!="number"||e.turns<0)return"turns must be a non-negative number";break}return null}apply(e){switch(e.type){case"score":this.applyScoreEffect(e);break;case"flag":this.applyFlagEffect(e);break;case"message":this.applyMessageEffect(e);break;case"emit":this.applyEmitEffect(e);break;case"move_entity":this.applyMoveEntityEffect(e);break;case"update_entity":this.applyUpdateEntityEffect(e);break;case"set_state":this.applySetStateEffect(e);break;case"update_exits":this.applyUpdateExitsEffect(e);break;case"unblock":break;case"block":break;case"schedule":break}}applyScoreEffect(e){let r=this.world.getCapability("scoring");r&&typeof r.score=="number"&&this.world.updateCapability("scoring",{score:r.score+e.points})}applyFlagEffect(e){this.world.setStateValue(`flag.${e.name}`,e.value)}applyMessageEffect(e){let r={id:`msg-${Date.now()}-${Math.random().toString(36).slice(2)}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:e.id,...e.data},narrate:!0};this.pendingEmittedEvents.push(r),this.emitEvents&&this.emitEvents([r])}applyEmitEffect(e){this.pendingEmittedEvents.push(e.event),this.emitEvents&&this.emitEvents([e.event])}applyMoveEntityEffect(e){this.world.moveEntity(e.entityId,e.destination)}applyUpdateEntityEffect(e){this.world.updateEntity(e.entityId,r=>{for(let[n,i]of Object.entries(e.updates))r[n]=i})}applySetStateEffect(e){this.world.setStateValue(e.key,e.value)}applyUpdateExitsEffect(e){let r=this.world.getEntity(e.roomId);if(!r)return;let n=r.get(e7.RoomTrait);if(!n)return;n.exits||(n.exits={});let i=n.exits;for(let[o,a]of Object.entries(e.exits))a===null?delete i[o]:i[o]=a}};FT.EffectProcessor=bR});var IR=p(li=>{"use strict";var t7=li&&li.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),r7=li&&li.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&t7(e,t,r)};Object.defineProperty(li,"__esModule",{value:!0});li.EffectProcessor=li.createWorldQuery=void 0;r7(CH(),li);var n7=wH();Object.defineProperty(li,"createWorldQuery",{enumerable:!0,get:function(){return n7.createWorldQuery}});var i7=NH();Object.defineProperty(li,"EffectProcessor",{enumerable:!0,get:function(){return i7.EffectProcessor}})});var LH=p(VT=>{"use strict";Object.defineProperty(VT,"__esModule",{value:!0});VT.EventProcessor=void 0;var o7=vR(),DH=IR(),a7=0;function s7(){return`evt_${Date.now()}_${(++a7).toString(36)}`}var OR=class{constructor(e,r={}){l(this,"world");l(this,"options");l(this,"effectProcessor");l(this,"worldQuery");l(this,"storyHandlers",new Map);this.world=e,this.options={validate:r.validate??!0,preview:r.preview??!1,maxReactionDepth:r.maxReactionDepth??10},this.worldQuery=(0,DH.createWorldQuery)(e),this.effectProcessor=new DH.EffectProcessor(e,n=>{this.processEvents(n)}),(0,o7.registerStandardHandlers)(e)}registerHandler(e,r){let n=this.storyHandlers.get(e)||[];n.push(r),this.storyHandlers.set(e,n)}unregisterHandler(e,r){let n=this.storyHandlers.get(e);if(n){let i=n.indexOf(r);i!==-1&&n.splice(i,1),n.length===0&&this.storyHandlers.delete(e)}}processEvents(e){let r={applied:[],failed:[],changes:[],reactions:[]};for(let n of e){let i=this.processSingleEvent(n);if(i.success){if(r.applied.push(n),r.changes.push(...i.changes),i.reactions&&i.reactions.length>0){let o=this.processReactions(i.reactions,0);r.reactions.push(...o.reactions),r.applied.push(...o.applied),r.failed.push(...o.failed),r.changes.push(...o.changes)}}else r.failed.push({event:n,reason:i.reason||"Unknown failure"})}return r}processSingleEvent(e){if(this.options.validate&&!this.world.canApplyEvent(e))return{success:!1,reason:"Event validation failed",changes:[]};let r=[];this.options.preview&&(r=this.world.previewEvent(e));try{this.world.applyEvent(e);let n=this.invokeEntityHandlers(e);return{success:!0,changes:r,reactions:n}}catch(n){return{success:!1,reason:n instanceof Error?n.message:"Unknown error",changes:[]}}}processReactions(e,r){let n={applied:[],failed:[],changes:[],reactions:[]};if(r>=this.options.maxReactionDepth)return console.warn("Maximum reaction depth reached, stopping processing"),n;for(let i of e){let o=this.processSingleEvent(i);if(o.success){if(n.applied.push(i),n.changes.push(...o.changes),o.reactions&&o.reactions.length>0){let a=this.processReactions(o.reactions,r+1);n.reactions.push(...a.reactions),n.applied.push(...a.applied),n.failed.push(...a.failed),n.changes.push(...a.changes)}}else n.failed.push({event:i,reason:o.reason||"Unknown failure"})}return n.reactions.push(...e),n}isEffectArray(e){if(!Array.isArray(e)||e.length===0)return!1;let r=e[0];if(typeof r!="object"||r===null)return!1;let n=["score","flag","message","emit","schedule","unblock","block","move_entity","update_entity","set_state","update_exits"];return"type"in r&&n.includes(r.type)}invokeEntityHandlers(e){let r=[],n=[],i={...e,data:e.data||{}};if(e.entities?.target){let c=this.world.getEntity(e.entities.target);if(c?.on?.[e.type]){let d=c.on[e.type],u=Array.isArray(d)?d:[d];for(let m of u)try{let f=m(i,this.worldQuery);f&&Array.isArray(f)&&(this.isEffectArray(f)?r.push(...f):n.push(...f))}catch(f){console.error(`Entity handler error for ${e.type} on ${c.id}:`,f instanceof Error?f.message:f)}}}let o=this.storyHandlers.get(e.type);if(o)for(let c of o)try{let d=c(i,this.worldQuery);d&&Array.isArray(d)&&r.push(...d)}catch(d){console.error(`Story handler error for ${e.type}:`,d instanceof Error?d.message:d)}if(r.length>0){let c=this.effectProcessor.process(r);c.success||console.error("Effect processing failed:",c.errors),c.emittedEvents&&c.emittedEvents.length>0&&n.push(...c.emittedEvents)}let a=n.filter(c=>c.type==="game.message"),s=n;if(a.length>1){console.error(`Multiple game.message reactions for ${e.type} on ${e.entities?.target}:`,a.map(m=>m.data?.messageId)),s.push({id:s7(),type:"if.event.error",entities:e.entities,data:{message:`Multiple game.message reactions returned for ${e.type}`,sourceEvent:e.type,targetId:e.entities?.target,count:a.length,messageIds:a.map(m=>m.data?.messageId)},timestamp:Date.now()});let d=a[0].data,u=e.data;d.messageId&&(u.messageId=d.messageId),d.text&&(u.text=d.text),d.params&&(u.params=d.params),s=n.filter(m=>m.type!=="game.message")}else if(a.length===1){let d=a[0].data,u=e.data;d.messageId&&(u.messageId=d.messageId),d.text&&(u.text=d.text),d.params&&(u.params=d.params),s=n.filter(m=>m.type!=="game.message")}return s}getWorld(){return this.world}setOptions(e){this.options={...this.options,...e}}};VT.EventProcessor=OR});var PH=p(MH=>{"use strict";Object.defineProperty(MH,"__esModule",{value:!0})});var kH=p(fn=>{"use strict";var c7=fn&&fn.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),sm=fn&&fn.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&c7(e,t,r)};Object.defineProperty(fn,"__esModule",{value:!0});fn.WorldModel=void 0;sm(mH(),fn);sm(LH(),fn);sm(vR(),fn);sm(IR(),fn);sm(PH(),fn);var d7=E();Object.defineProperty(fn,"WorldModel",{enumerable:!0,get:function(){return d7.WorldModel}})});var SR=p(El=>{"use strict";Object.defineProperty(El,"__esModule",{value:!0});El.CORE_BLOCK_KEYS=El.CORE_DECORATION_TYPES=void 0;El.CORE_DECORATION_TYPES={EM:"em",STRONG:"strong",ITEM:"item",ROOM:"room",NPC:"npc",COMMAND:"command",DIRECTION:"direction",UNDERLINE:"underline",STRIKETHROUGH:"strikethrough",SUPER:"super",SUB:"sub"};El.CORE_BLOCK_KEYS={ROOM_NAME:"room.name",ROOM_DESCRIPTION:"room.description",ROOM_CONTENTS:"room.contents",ACTION_RESULT:"action.result",ACTION_BLOCKED:"action.blocked",STATUS_ROOM:"status.room",STATUS_SCORE:"status.score",STATUS_TURNS:"status.turns",ERROR:"error",PROMPT:"prompt",GAME_MESSAGE:"game.message",GAME_BANNER:"game.banner"}});var xH=p(Ea=>{"use strict";Object.defineProperty(Ea,"__esModule",{value:!0});Ea.isDecoration=l7;Ea.isTextBlock=u7;Ea.hasKeyPrefix=YT;Ea.isStatusBlock=m7;Ea.isRoomBlock=p7;Ea.isActionBlock=f7;Ea.extractPlainText=BH;function l7(t){return typeof t=="object"&&t!==null&&"type"in t&&"content"in t}function u7(t){return typeof t=="object"&&t!==null&&"key"in t&&"content"in t&&typeof t.key=="string"&&Array.isArray(t.content)}function YT(t,e){return t.key.startsWith(e)}function m7(t){return YT(t,"status.")}function p7(t){return YT(t,"room.")}function f7(t){return YT(t,"action.")}function BH(t){return t.map(e=>typeof e=="string"?e:BH(e.content)).join("")}});var Rs=p(rt=>{"use strict";Object.defineProperty(rt,"__esModule",{value:!0});rt.BLOCK_KEY_PREFIXES=rt.extractPlainText=rt.isActionBlock=rt.isRoomBlock=rt.isStatusBlock=rt.hasKeyPrefix=rt.isTextBlock=rt.isDecoration=rt.BLOCK_KEYS=rt.CORE_BLOCK_KEYS=rt.CORE_DECORATION_TYPES=void 0;var jH=SR();Object.defineProperty(rt,"CORE_DECORATION_TYPES",{enumerable:!0,get:function(){return jH.CORE_DECORATION_TYPES}});Object.defineProperty(rt,"CORE_BLOCK_KEYS",{enumerable:!0,get:function(){return jH.CORE_BLOCK_KEYS}});var g7=SR();Object.defineProperty(rt,"BLOCK_KEYS",{enumerable:!0,get:function(){return g7.CORE_BLOCK_KEYS}});var Hc=xH();Object.defineProperty(rt,"isDecoration",{enumerable:!0,get:function(){return Hc.isDecoration}});Object.defineProperty(rt,"isTextBlock",{enumerable:!0,get:function(){return Hc.isTextBlock}});Object.defineProperty(rt,"hasKeyPrefix",{enumerable:!0,get:function(){return Hc.hasKeyPrefix}});Object.defineProperty(rt,"isStatusBlock",{enumerable:!0,get:function(){return Hc.isStatusBlock}});Object.defineProperty(rt,"isRoomBlock",{enumerable:!0,get:function(){return Hc.isRoomBlock}});Object.defineProperty(rt,"isActionBlock",{enumerable:!0,get:function(){return Hc.isActionBlock}});Object.defineProperty(rt,"extractPlainText",{enumerable:!0,get:function(){return Hc.extractPlainText}});rt.BLOCK_KEY_PREFIXES={STATUS:"status.",ROOM:"room.",ACTION:"action."}});var RR=p(AR=>{"use strict";Object.defineProperty(AR,"__esModule",{value:!0});AR.filterEvents=h7;function h7(t){return t.filter(e=>!(e.type.startsWith("system.")||e.type.startsWith("platform.")))}});var CR=p(zT=>{"use strict";Object.defineProperty(zT,"__esModule",{value:!0});zT.sortEventsForProse=y7;zT.getChainMetadata=T7;function y7(t){return[...t].sort((e,r)=>{let n=e.data,i=r.data,o=n?._transactionId,a=i?._transactionId,s=["game.started","game.starting","game.loading","game.loaded","game.initialized"],c=s.includes(e.type),d=s.includes(r.type);if(c&&!d)return-1;if(!c&&d)return 1;if(o!==a)return 0;let u=e.type==="if.event.implicit_take",m=r.type==="if.event.implicit_take";if(u&&!m)return-1;if(!u&&m)return 1;let f=e.type==="if.event.room.description"||e.type==="if.event.room_description",g=r.type==="if.event.room.description"||r.type==="if.event.room_description";if(f&&!g)return-1;if(!f&&g)return 1;let h=e.type.startsWith("action."),y=r.type.startsWith("action.");if(h&&!y)return-1;if(!h&&y)return 1;let T=n?._chainDepth??0,I=i?._chainDepth??0;return T-I})}function T7(t){let e=t.data;return{_transactionId:e?._transactionId,_chainDepth:e?._chainDepth,_chainedFrom:e?._chainedFrom,_chainSourceId:e?._chainSourceId}}});var wR=p($T=>{"use strict";Object.defineProperty($T,"__esModule",{value:!0});$T.parseDecorations=KT;$T.hasDecorations=_7;function KT(t){if(!t)return[];let e=[],r="",n=0;for(;n<t.length;){let i=t[n];if(i==="\\"&&n+1<t.length){let o=t[n+1];if(o==="*"||o==="["||o==="]"||o==="\\"){r+=o,n+=2;continue}}if(i==="["){let o=E7(t,n);if(o!==-1){r&&(e.push(r),r="");let a=t.slice(n+1,o),s=a.indexOf(":");if(s!==-1){let c=a.slice(0,s),d=a.slice(s+1),u={type:c,content:KT(d)};e.push(u)}else r+=t.slice(n,o+1);n=o+1;continue}}if(i==="*"&&t[n+1]==="*"){let o=t.indexOf("**",n+2);if(o!==-1){r&&(e.push(r),r="");let a=t.slice(n+2,o),s={type:"strong",content:KT(a)};e.push(s),n=o+2;continue}}if(i==="*"){let o=v7(t,n+1);if(o!==-1){r&&(e.push(r),r="");let a=t.slice(n+1,o),s={type:"em",content:KT(a)};e.push(s),n=o+1;continue}}r+=i,n++}return r&&e.push(r),e}function E7(t,e){let r=1,n=e+1;for(;n<t.length&&r>0;){let i=t[n];if(i==="\\"&&n+1<t.length){n+=2;continue}if(i==="["?r++:i==="]"&&r--,r===0)return n;n++}return-1}function v7(t,e){let r=e;for(;r<t.length;){let n=t[r];if(n==="\\"&&r+1<t.length){r+=2;continue}if(n==="*"&&t[r+1]!=="*"&&(r===e||t[r-1]!=="*"))return r;r++}return-1}function _7(t){return/[*\[]/.test(t)}});var Qi=p(QT=>{"use strict";Object.defineProperty(QT,"__esModule",{value:!0});QT.createBlock=b7;QT.extractValue=I7;var WH=wR();function b7(t,e){let r=(0,WH.hasDecorations)(e)?(0,WH.parseDecorations)(e):[e];return{key:t,content:r}}function I7(t){if(typeof t=="function")try{let e=t();return e?String(e):null}catch{return null}return t?String(t):null}});var DR=p(NR=>{"use strict";Object.defineProperty(NR,"__esModule",{value:!0});NR.handleRoomDescription=O7;var UH=Rs(),XT=Qi();function O7(t,e){let r=t.data,n=[];if(r.verbose){let a,s=r.roomNameId??r.room?.nameId;if(s&&e.languageProvider){let c=e.languageProvider.getMessage(s,{});c&&c!==s&&(a=c)}if(a||(a=r.room?.name??r.roomName),a){let c=(0,XT.extractValue)(a);c&&n.push((0,XT.createBlock)(UH.BLOCK_KEYS.ROOM_NAME,c))}}let i,o=r.roomDescriptionId??r.room?.descriptionId;if(o&&e.languageProvider){let a=e.languageProvider.getMessage(o,{});a&&a!==o&&(i=a)}if(i||(i=r.room?.description??r.roomDescription),i){let a=(0,XT.extractValue)(i);a&&n.push((0,XT.createBlock)(UH.BLOCK_KEYS.ROOM_DESCRIPTION,a))}return n}});var LR=p(eE=>{"use strict";Object.defineProperty(eE,"__esModule",{value:!0});eE.handleActionSuccess=S7;eE.handleActionFailure=A7;var ZT=Rs(),JT=Qi();function S7(t,e){let r=t.data;if(r.messageId&&e.languageProvider){let i=r.actionId?`${r.actionId}.${r.messageId}`:r.messageId,o=e.languageProvider.getMessage(i,r.params);if(o===i&&r.messageId&&(o=e.languageProvider.getMessage(r.messageId,r.params)),o!==r.messageId&&o!==i)return[(0,JT.createBlock)(ZT.BLOCK_KEYS.ACTION_RESULT,o)]}let n=r.message??r.text;return n?[(0,JT.createBlock)(ZT.BLOCK_KEYS.ACTION_RESULT,n)]:[]}function A7(t,e){let r=t.data;if(r.messageId&&e.languageProvider){let i=r.actionId?`${r.actionId}.${r.messageId}`:r.messageId,o=e.languageProvider.getMessage(i,r.params);if(o===i&&r.messageId&&(o=e.languageProvider.getMessage(r.messageId,r.params)),o!==r.messageId&&o!==i)return[(0,JT.createBlock)(ZT.BLOCK_KEYS.ACTION_BLOCKED,o)]}let n=r.params?.reason??r.reason??r.message??"You can't do that.";return[(0,JT.createBlock)(ZT.BLOCK_KEYS.ACTION_BLOCKED,n)]}});var BR=p(kR=>{"use strict";Object.defineProperty(kR,"__esModule",{value:!0});kR.handleRevealed=R7;var MR=Rs(),PR=Qi();function R7(t,e){let r=t.data;if(r.message||r.text){let n=r.message??r.text??"";if(n)return[(0,PR.createBlock)(MR.BLOCK_KEYS.ACTION_RESULT,n)]}if(e.languageProvider){let n=e.languageProvider.getMessage(t.type,{containerId:r.containerId,containerName:r.containerName,container:r.containerName,items:r.items});if(n&&n!==t.type)return[(0,PR.createBlock)(MR.BLOCK_KEYS.ACTION_RESULT,n)]}if(r.items&&r.items.length>0){let n=r.items.map(a=>a.name??a.messageId??a.entityId).join(", "),o=`Inside the ${r.containerName??"it"} you see ${n}.`;return[(0,PR.createBlock)(MR.BLOCK_KEYS.ACTION_RESULT,o)]}return[]}});var xR=p(tE=>{"use strict";Object.defineProperty(tE,"__esModule",{value:!0});tE.handleGameMessage=C7;tE.handleGenericEvent=w7;var cm=Rs(),dm=Qi();function C7(t,e){let r=t.data;if(r.messageId&&e.languageProvider){let i=e.languageProvider.getMessage(r.messageId,r.params);if(i&&i!==r.messageId)return[(0,dm.createBlock)(cm.BLOCK_KEYS.GAME_MESSAGE,i)]}let n=r.text??r.message;return n?[(0,dm.createBlock)(cm.BLOCK_KEYS.GAME_MESSAGE,n)]:[]}function w7(t,e){let r=t.data;if(!r)return[];if(r.message||r.text){let n=r.message??r.text??"";if(n)return[(0,dm.createBlock)(cm.BLOCK_KEYS.ACTION_RESULT,n)]}if(e.languageProvider){let n=e.languageProvider.getMessage(t.type,r);if(n&&n!==t.type)return[(0,dm.createBlock)(cm.BLOCK_KEYS.ACTION_RESULT,n)];if(r.messageId){let i=e.languageProvider.getMessage(r.messageId,r);if(i&&i!==r.messageId)return[(0,dm.createBlock)(cm.BLOCK_KEYS.ACTION_RESULT,i)]}}return[]}});var HH=p(jR=>{"use strict";Object.defineProperty(jR,"__esModule",{value:!0});jR.handleGameStarted=D7;var N7=Qi();function D7(t,e){let r=t.data,n=r?.story;if(!n)return[];let i=r?.engineVersion||"unknown",o=r?.clientVersion||"N/A",a=n.buildDate?new Date(n.buildDate).toISOString().split("T")[0]:"",s={title:n.title||"Unknown",author:n.author||"Unknown",version:n.version||"1.0.0",id:n.id||"unknown",engineVersion:i,clientVersion:o,buildDate:a},c=e.languageProvider?.getMessage("game.started.banner",s);return!c||c==="game.started.banner"?[]:[(0,N7.createBlock)("game.banner",c)]}});var qH=p(WR=>{"use strict";Object.defineProperty(WR,"__esModule",{value:!0});WR.handleHelpDisplayed=P7;var L7=Qi(),M7=`HOW TO PLAY INTERACTIVE FICTION

Interactive fiction is a conversation between you and the game. You type commands; the game describes what happens.

MOVING AROUND
  Type a direction to move: NORTH (N), SOUTH (S), EAST (E), WEST (W),
  NORTHEAST (NE), NORTHWEST (NW), SOUTHEAST (SE), SOUTHWEST (SW),
  UP (U), DOWN (D), IN, OUT, ENTER, EXIT.

LOOKING AND EXAMINING
  LOOK (L) - Describe your surroundings.
  EXAMINE (X) something - Look closely at an object.

INTERACTING WITH OBJECTS
  TAKE (GET) something - Pick it up.
  DROP something - Put it down.
  OPEN / CLOSE something - Open or close a door, container, etc.
  PUT something IN / ON something - Place an object in a container or on a surface.
  LOCK / UNLOCK something WITH something - Lock or unlock with a key.
  TURN ON / TURN OFF something - Operate a switch or device.
  WEAR / TAKE OFF something - Put on or remove clothing.
  EAT / DRINK something - Consume food or drink.
  READ something - Read text on an object.
  SEARCH something - Search a container or area.
  LOOK UNDER / LOOK BEHIND something - Check hidden spots.

TALKING TO CHARACTERS
  TALK TO someone - Start a conversation.
  ASK someone ABOUT something - Ask about a topic.
  TELL someone ABOUT something - Tell them something.
  GIVE something TO someone - Hand over an item.
  SHOW something TO someone - Display an item.

OTHER COMMANDS
  INVENTORY (I) - List what you're carrying.
  WAIT (Z) - Let time pass.
  AGAIN (G) - Repeat your last command.
  SCORE - Check your progress.
  SAVE / RESTORE - Save or load your game.
  UNDO - Take back your last move.
  QUIT - End the game.
  ABOUT - Information about this game.

When in doubt, EXAMINE everything.`;function P7(t,e){return[(0,L7.createBlock)("help.text",M7)]}});var FH=p(UR=>{"use strict";Object.defineProperty(UR,"__esModule",{value:!0});UR.handleAboutDisplayed=k7;var GH=Qi();function k7(t,e){let n=t.data?.params||{},i={engineVersion:"",buildDate:"",clientVersion:"",id:"",...n},o=e.languageProvider?.getMessage("game.started.banner",i);if(!o||o==="game.started.banner"){let a=n.title||"Unknown",s=n.author||"Unknown";return[(0,GH.createBlock)("about.text",`${a}
By ${s}`)]}return[(0,GH.createBlock)("about.text",o)]}});var zH=p(lm=>{"use strict";Object.defineProperty(lm,"__esModule",{value:!0});lm.TextService=void 0;lm.createTextService=F7;var qc=Rs(),B7=RR(),x7=CR(),vl=Qi(),j7=DR(),VH=LR(),W7=BR(),YH=xR(),U7=HH(),H7=qH(),q7=FH(),G7=new Set(["if.event.opened","if.event.closed","if.event.locked","if.event.unlocked","if.event.switched_on","if.event.switched_off","if.event.taken","if.event.dropped","if.event.read"]),rE=class{constructor(e){l(this,"languageProvider");this.languageProvider=e}processTurn(e){let r=(0,B7.filterEvents)(e),n=(0,x7.sortEventsForProse)(r),i={languageProvider:this.languageProvider},o=[];for(let a of n){let s=this.routeToHandler(a,i);o.push(...s)}return o}routeToHandler(e,r){let n=this.tryProcessDomainEventMessage(e,r);if(n)return n;if(G7.has(e.type))return[];switch(e.type){case"game.started":return(0,U7.handleGameStarted)(e,r);case"if.event.room_description":case"if.event.room.description":return(0,j7.handleRoomDescription)(e,r);case"action.success":return(0,VH.handleActionSuccess)(e,r);case"action.failure":case"action.blocked":return(0,VH.handleActionFailure)(e,r);case"game.message":return(0,YH.handleGameMessage)(e,r);case"if.event.revealed":return(0,W7.handleRevealed)(e,r);case"if.event.help_displayed":return(0,H7.handleHelpDisplayed)(e,r);case"if.event.about_displayed":return(0,q7.handleAboutDisplayed)(e,r);case"if.event.implicit_take":return this.handleImplicitTake(e,r);case"command.failed":return this.handleCommandFailed(e,r);case"client.query":return this.handleClientQuery(e,r);default:return(0,YH.handleGenericEvent)(e,r)}}tryProcessDomainEventMessage(e,r){let n=e.data;if(!n?.messageId||e.type.startsWith("action.")||e.type==="client.query"||!r.languageProvider)return null;let i=r.languageProvider.getMessage(n.messageId,n.params);if(i===n.messageId)return null;let o=e.type.includes("blocked")||e.type.includes("failure")?qc.BLOCK_KEYS.ACTION_BLOCKED:qc.BLOCK_KEYS.ACTION_RESULT;return[(0,vl.createBlock)(o,i)]}handleImplicitTake(e,r){let i=e.data.itemName||"something";return[(0,vl.createBlock)(qc.BLOCK_KEYS.ACTION_RESULT,`(first taking the ${i})`)]}handleCommandFailed(e,r){let n=e.data;if(n.reason){if(n.reason.includes("ENTITY_NOT_FOUND")||n.reason.includes("modifiers_not_matched")){let o=r.languageProvider?.getMessage("core.entity_not_found")??"I don't see that here.";return[(0,vl.createBlock)(qc.BLOCK_KEYS.ERROR,o)]}if(n.reason.includes("NO_MATCH")||n.reason.includes("parse")){let o=r.languageProvider?.getMessage("core.command_not_understood")??"I don't understand that.";return[(0,vl.createBlock)(qc.BLOCK_KEYS.ERROR,o)]}}let i=r.languageProvider?.getMessage("core.command_failed")??"I don't understand that.";return[(0,vl.createBlock)(qc.BLOCK_KEYS.ERROR,i)]}handleClientQuery(e,r){let n=e.data;if(n.source!=="disambiguation")return[];let i=(n.candidates||[]).map(s=>s.name),o=this.formatCandidateList(i),a=r.languageProvider?.getMessage("core.disambiguation_prompt",{options:o})??`Which do you mean: ${o}?`;return[(0,vl.createBlock)(qc.BLOCK_KEYS.ERROR,a)]}formatCandidateList(e){if(e.length===0)return"";if(e.length===1)return`the ${e[0]}`;let r=e.map(i=>`the ${i}`);if(r.length===2)return`${r[0]} or ${r[1]}`;let n=r.pop();return`${r.join(", ")}, or ${n}`}};lm.TextService=rE;function F7(t){return new rE(t)}});var $H=p(nE=>{"use strict";Object.defineProperty(nE,"__esModule",{value:!0});nE.renderToString=$7;nE.renderStatusLine=Q7;var KH=Rs(),Ke={RESET:"\x1B[0m",BOLD:"\x1B[1m",ITALIC:"\x1B[3m",UNDERLINE:"\x1B[4m",STRIKETHROUGH:"\x1B[9m",BLACK:"\x1B[30m",RED:"\x1B[31m",GREEN:"\x1B[32m",YELLOW:"\x1B[33m",BLUE:"\x1B[34m",MAGENTA:"\x1B[35m",CYAN:"\x1B[36m",WHITE:"\x1B[37m",BRIGHT_RED:"\x1B[91m",BRIGHT_GREEN:"\x1B[92m",BRIGHT_YELLOW:"\x1B[93m",BRIGHT_BLUE:"\x1B[94m",BRIGHT_MAGENTA:"\x1B[95m",BRIGHT_CYAN:"\x1B[96m",BRIGHT_WHITE:"\x1B[97m"},V7={em:Ke.ITALIC,strong:Ke.BOLD,item:Ke.CYAN,room:Ke.YELLOW,npc:Ke.MAGENTA,command:Ke.GREEN,direction:Ke.WHITE,underline:Ke.UNDERLINE,strikethrough:Ke.STRIKETHROUGH};function Y7(t){let e=parseInt(t.slice(1,3),16),r=parseInt(t.slice(3,5),16),n=parseInt(t.slice(5,7),16);return e>r&&e>n?e>180?Ke.BRIGHT_RED:Ke.RED:r>e&&r>n?r>180?Ke.BRIGHT_GREEN:Ke.GREEN:n>e&&n>r?n>180?Ke.BRIGHT_BLUE:Ke.BLUE:e>200&&r>200?Ke.BRIGHT_YELLOW:e>200&&n>200?Ke.BRIGHT_MAGENTA:r>200&&n>200?Ke.BRIGHT_CYAN:e>180&&r>180&&n>180?Ke.BRIGHT_WHITE:Ke.WHITE}function _l(t,e){return t.map(r=>typeof r=="string"?r:z7(r,e)).join("")}function z7(t,e){let r=_l(t.content,e);if(!e.ansi)return t.type==="em"?`*${r}*`:t.type==="strong"?`**${r}**`:r;let n=V7[t.type];if(!n&&e.colors?.[t.type]){let i=e.colors[t.type];i.startsWith("#")&&(n=Y7(i))}return n?`${n}${r}${Ke.RESET}`:r}function K7(t,e){let r=_l(t.content,e);if(e.ansi){if(t.key==="room.name")return`${Ke.BOLD}${Ke.YELLOW}${r}${Ke.RESET}`;if(t.key==="action.blocked"||t.key==="error")return`${Ke.RED}${r}${Ke.RESET}`}return r}function $7(t,e={}){let r={ansi:!1,blockSeparator:`

`,includeStatus:!1,...e},i=(r.includeStatus?t:t.filter(a=>!(0,KH.isStatusBlock)(a))).map(a=>({key:a.key,text:K7(a,r)})).filter(a=>a.text.trim());if(i.length===0)return"";let o=[i[0].text];for(let a=1;a<i.length;a++){let s=i[a-1],c=i[a],d=s.key===c.key?`
`:r.blockSeparator;o.push(d+c.text)}return o.join("")}function Q7(t,e={}){let r=t.filter(KH.isStatusBlock),n=[],i=r.find(d=>d.key==="status.room");i&&n.push(_l(i.content,e));let o=r.find(d=>d.key==="status.score");o&&n.push(`Score: ${_l(o.content,e)}`);let a=r.find(d=>d.key==="status.turns");a&&n.push(`Turns: ${_l(a.content,e)}`);let s=["status.room","status.score","status.turns"],c=r.filter(d=>!s.includes(d.key));for(let d of c)n.push(_l(d.content,e));return n.join(" | ")}});var nq=p(te=>{"use strict";Object.defineProperty(te,"__esModule",{value:!0});te.CORE_DECORATION_TYPES=te.BLOCK_KEY_PREFIXES=te.BLOCK_KEYS=te.extractPlainText=te.isActionBlock=te.isRoomBlock=te.isStatusBlock=te.isTextBlock=te.isDecoration=te.renderStatusLine=te.renderToString=te.hasDecorations=te.parseDecorations=te.handleGenericEvent=te.handleGameMessage=te.handleRevealed=te.handleActionFailure=te.handleActionSuccess=te.handleRoomDescription=te.extractValue=te.createBlock=te.getChainMetadata=te.sortEventsForProse=te.filterEvents=te.createTextService=te.TextService=void 0;var QH=zH();Object.defineProperty(te,"TextService",{enumerable:!0,get:function(){return QH.TextService}});Object.defineProperty(te,"createTextService",{enumerable:!0,get:function(){return QH.createTextService}});var X7=RR();Object.defineProperty(te,"filterEvents",{enumerable:!0,get:function(){return X7.filterEvents}});var XH=CR();Object.defineProperty(te,"sortEventsForProse",{enumerable:!0,get:function(){return XH.sortEventsForProse}});Object.defineProperty(te,"getChainMetadata",{enumerable:!0,get:function(){return XH.getChainMetadata}});var ZH=Qi();Object.defineProperty(te,"createBlock",{enumerable:!0,get:function(){return ZH.createBlock}});Object.defineProperty(te,"extractValue",{enumerable:!0,get:function(){return ZH.extractValue}});var Z7=DR();Object.defineProperty(te,"handleRoomDescription",{enumerable:!0,get:function(){return Z7.handleRoomDescription}});var JH=LR();Object.defineProperty(te,"handleActionSuccess",{enumerable:!0,get:function(){return JH.handleActionSuccess}});Object.defineProperty(te,"handleActionFailure",{enumerable:!0,get:function(){return JH.handleActionFailure}});var J7=BR();Object.defineProperty(te,"handleRevealed",{enumerable:!0,get:function(){return J7.handleRevealed}});var eq=xR();Object.defineProperty(te,"handleGameMessage",{enumerable:!0,get:function(){return eq.handleGameMessage}});Object.defineProperty(te,"handleGenericEvent",{enumerable:!0,get:function(){return eq.handleGenericEvent}});var tq=wR();Object.defineProperty(te,"parseDecorations",{enumerable:!0,get:function(){return tq.parseDecorations}});Object.defineProperty(te,"hasDecorations",{enumerable:!0,get:function(){return tq.hasDecorations}});var rq=$H();Object.defineProperty(te,"renderToString",{enumerable:!0,get:function(){return rq.renderToString}});Object.defineProperty(te,"renderStatusLine",{enumerable:!0,get:function(){return rq.renderStatusLine}});var va=Rs();Object.defineProperty(te,"isDecoration",{enumerable:!0,get:function(){return va.isDecoration}});Object.defineProperty(te,"isTextBlock",{enumerable:!0,get:function(){return va.isTextBlock}});Object.defineProperty(te,"isStatusBlock",{enumerable:!0,get:function(){return va.isStatusBlock}});Object.defineProperty(te,"isRoomBlock",{enumerable:!0,get:function(){return va.isRoomBlock}});Object.defineProperty(te,"isActionBlock",{enumerable:!0,get:function(){return va.isActionBlock}});Object.defineProperty(te,"extractPlainText",{enumerable:!0,get:function(){return va.extractPlainText}});Object.defineProperty(te,"BLOCK_KEYS",{enumerable:!0,get:function(){return va.BLOCK_KEYS}});Object.defineProperty(te,"BLOCK_KEY_PREFIXES",{enumerable:!0,get:function(){return va.BLOCK_KEY_PREFIXES}});Object.defineProperty(te,"CORE_DECORATION_TYPES",{enumerable:!0,get:function(){return va.CORE_DECORATION_TYPES}})});var iq=p(iE=>{"use strict";Object.defineProperty(iE,"__esModule",{value:!0});iE.PluginRegistry=void 0;var HR=class{constructor(){l(this,"plugins",new Map)}register(e){if(this.plugins.has(e.id))throw new Error(`Plugin already registered: ${e.id}`);this.plugins.set(e.id,e)}unregister(e){this.plugins.delete(e)}getAll(){return Array.from(this.plugins.values()).sort((e,r)=>r.priority-e.priority)}getById(e){return this.plugins.get(e)}getStates(){let e={};for(let r of this.plugins.values())r.getState&&(e[r.id]=r.getState());return e}setStates(e){for(let[r,n]of Object.entries(e)){let i=this.plugins.get(r);i?.setState&&i.setState(n)}}};iE.PluginRegistry=HR});var qR=p(oE=>{"use strict";Object.defineProperty(oE,"__esModule",{value:!0});oE.PluginRegistry=void 0;var eee=iq();Object.defineProperty(oE,"PluginRegistry",{enumerable:!0,get:function(){return eee.PluginRegistry}})});var aE=p(Gc=>{"use strict";Object.defineProperty(Gc,"__esModule",{value:!0});Gc.normalizeEvent=oq;Gc.enrichEvent=aq;Gc.processEvent=sq;Gc.toSequencedEvent=tee;Gc.toSemanticEvent=iee;function oq(t){return{...t,id:t.id||ree(),type:t.type.toLowerCase(),timestamp:t.timestamp||Date.now(),entities:t.entities||{},data:t.data,tags:t.tags,priority:t.priority,narrate:t.narrate}}function aq(t,e){let r={...t};return e&&(e.turn!==void 0&&r.data&&typeof r.data=="object"&&(r.data={...r.data,turn:e.turn}),e.playerId&&!r.entities.actor&&(r.entities={...r.entities,actor:e.playerId}),e.locationId&&!r.entities.location&&(r.entities={...r.entities,location:e.locationId})),r.tags||(r.tags=[]),r.type.startsWith("action.")&&!r.tags.includes("action")?r.tags=[...r.tags,"action"]:r.type.startsWith("system.")&&!r.tags.includes("system")?r.tags=[...r.tags,"system"]:r.type.startsWith("game.")&&!r.tags.includes("game")&&(r.tags=[...r.tags,"game"]),r}function sq(t,e){let r=oq(t);return aq(r,e)}function tee(t,e,r){let n=sq(t,{turn:e});return{type:n.type,data:n.data,sequence:r,timestamp:new Date(n.timestamp),turn:e,scope:nee(n),source:n.id}}function ree(){return`event-${Date.now()}-${Math.random().toString(36).substr(2,9)}`}function nee(t){return t.type.startsWith("platform.")?"system":(t.type==="action.error","turn")}function iee(t){return{...t,id:t.source||`${t.turn}-${t.sequence}`,type:t.type,timestamp:t.timestamp.getTime(),data:t.data,entities:t.entities||{}}}});var GR=p(um=>{"use strict";Object.defineProperty(um,"__esModule",{value:!0});um.VocabularyManager=void 0;um.createVocabularyManager=aee;var oee=zi(),sE=class{updateEntityVocabulary(e,r){let n=e.get("IDENTITY");if(n&&typeof n=="object"){let i=n,o=[];i.name&&o.push(i.name.toLowerCase()),i.aliases&&Array.isArray(i.aliases)&&o.push(...i.aliases),oee.vocabularyRegistry.registerEntity({entityId:e.id,nouns:o,adjectives:i.adjectives||[],inScope:r})}}updateScopeVocabulary(e,r){if(!e.getEntity(r))return;let i=e.getInScope(r);for(let o of e.getAllEntities())this.updateEntityVocabulary(o,!1);for(let o of i)this.updateEntityVocabulary(o,!0)}};um.VocabularyManager=sE;function aee(){return new sE}});var FR=p(mm=>{"use strict";Object.defineProperty(mm,"__esModule",{value:!0});mm.SaveRestoreService=void 0;mm.createSaveRestoreService=dee;var cq=E(),see=Ve(),cee=aE(),cE=class{constructor(e){l(this,"undoSnapshots",[]);l(this,"undoSnapshotTurns",[]);l(this,"maxUndoSnapshots");this.maxUndoSnapshots=e?.maxSnapshots??10}createUndoSnapshot(e,r){if(this.maxUndoSnapshots<=0)return;let n=e.toJSON();for(this.undoSnapshots.push(n),this.undoSnapshotTurns.push(r);this.undoSnapshots.length>this.maxUndoSnapshots;)this.undoSnapshots.shift(),this.undoSnapshotTurns.shift()}undo(e){if(this.undoSnapshots.length===0)return null;let r=this.undoSnapshots.pop(),n=this.undoSnapshotTurns.pop();return e.loadJSON(r),{turn:n}}canUndo(){return this.undoSnapshots.length>0}getUndoLevels(){return this.undoSnapshots.length}clearUndoSnapshots(){this.undoSnapshots=[],this.undoSnapshotTurns=[]}createSaveData(e){let r=e.getContext(),n=e.getStory(),i=e.getEventSource(),o=e.getPluginRegistry(),a=e.getWorld(),s=e.getParser(),c={storyId:n?.config.id||"unknown",storyVersion:n?.config.version||"0.0.0",turnCount:r.currentTurn-1,playTime:Date.now()-r.metadata.started.getTime(),description:`Turn ${r.currentTurn-1}`},d={eventSource:this.serializeEventSource(i),spatialIndex:this.serializeSpatialIndex(a),turnHistory:this.serializeTurnHistory(r.history),parserState:this.serializeParserState(s),pluginStates:o.getStates()};return{version:"1.0.0",timestamp:Date.now(),metadata:c,engineState:d,storyConfig:{id:n?.config.id||"unknown",version:n?.config.version||"0.0.0",title:n?.config.title||"Unknown",author:Array.isArray(n?.config.author)?n.config.author.join(", "):n?.config.author||"Unknown"}}}loadSaveData(e,r){let n=r.getStory();if(e.version!=="1.0.0")throw new Error(`Unsupported save version: ${e.version}`);if(e.storyConfig?.id&&n?.config.id&&e.storyConfig.id!==n.config.id)throw new Error(`Save is for different story: ${e.storyConfig.id}`);let i=this.deserializeEventSource(e.engineState.eventSource),o=r.getWorld();return this.deserializeSpatialIndex(e.engineState.spatialIndex,o),e.engineState.pluginStates&&r.getPluginRegistry().setStates(e.engineState.pluginStates),this.clearUndoSnapshots(),{eventSource:i,currentTurn:e.metadata.turnCount+1}}serializeEventSource(e){let r=[];for(let n of e.getAllEvents())r.push({id:n.id,type:n.type,timestamp:n.timestamp||Date.now(),data:this.serializeEventData(n.data)});return r}serializeEventData(e){if(!e||typeof e!="object")return e||{};let r={};for(let[n,i]of Object.entries(e))typeof i=="function"?r[n]={__type:"function",__marker:"[Function]"}:i&&typeof i=="object"?Array.isArray(i)?r[n]=i.map(o=>typeof o=="object"?this.serializeEventData(o):o):r[n]=this.serializeEventData(i):r[n]=i;return r}deserializeEventSource(e){let r=(0,see.createSemanticEventSource)();for(let n of e)r.emit({id:n.id,type:n.type,timestamp:n.timestamp,data:this.deserializeEventData(n.data),entities:{}});return r}deserializeEventData(e){if(!e||typeof e!="object")return e;if(e.__type==="function")return()=>"[Serialized Function]";if(Array.isArray(e))return e.map(n=>this.deserializeEventData(n));let r={};for(let[n,i]of Object.entries(e))r[n]=this.deserializeEventData(i);return r}serializeSpatialIndex(e){let r={},n={},i={};for(let a of e.getAllEntities()){let s={};for(let[c,d]of a.traits)s[c]=this.serializeTrait(d);r[a.id]={id:a.id,traits:s,entityType:a.constructor.name}}let o=e.getAllEntities().filter(a=>a.type==="room"||a.type==="location"||a.has("if.trait.room"));for(let a of o){let s=e.getContents(a.id);n[a.id]={id:a.id,properties:{name:a.get(cq.TraitType.IDENTITY)?.name||"Unknown",description:a.get(cq.TraitType.IDENTITY)?.description||""},contents:s.map(c=>c.id),connections:this.extractConnections(a,e)}}return{entities:r,locations:n,relationships:i}}deserializeSpatialIndex(e,r){for(let[n,i]of Object.entries(e.entities)){let o=r.getEntity(n);if(o)for(let[a,s]of Object.entries(i.traits)){let c=this.deserializeTrait(a,s);c&&(o.has(a)&&o.remove(a),o.add(c))}}for(let[n,i]of Object.entries(e.locations))for(let o of i.contents){let a=r.getEntity(o);a&&r.moveEntity(a.id,n)}}serializeTurnHistory(e){let r=[];for(let[n,i]of e.entries())r.push({turnNumber:n+1,eventIds:i.events.map(o=>o.source||`${o.turn}-${o.sequence}`),timestamp:i.events[0]?.timestamp.getTime()||Date.now(),command:i.input});return r}deserializeTurnHistory(e,r){let n=[];for(let i of e){let a=r.getAllEvents().filter(s=>i.eventIds.includes(s.id)).map((s,c)=>(0,cee.toSequencedEvent)(s,i.turnNumber,c));n.push({turn:i.turnNumber,input:i.command||"",success:!0,events:a})}return n}serializeParserState(e){if(e)return{}}serializeTrait(e){return typeof e=="object"&&e!==null?{...e}:e}deserializeTrait(e,r){return r&&typeof r=="object"?{type:e,...r}:null}extractConnections(e,r){let n={},i=e.get("if.trait.room");return i?.exits&&Object.entries(i.exits).forEach(([a,s])=>{s.destination&&(n[a]=s.destination)}),r.getContents(e.id).forEach(a=>{let s=a.get("if.trait.door");if(s){let c=s.room1===e.id?s.room2:s.room1;if(c){let d=a.name?.toLowerCase()||"";d.includes("north")?n.north=c:d.includes("south")?n.south=c:d.includes("east")?n.east=c:d.includes("west")?n.west=c:n.door=c}}}),n}};mm.SaveRestoreService=cE;function dee(t){return new cE(t)}});var YR=p(pm=>{"use strict";Object.defineProperty(pm,"__esModule",{value:!0});pm.TurnEventProcessor=void 0;pm.createTurnEventProcessor=lee;var dq=Ve(),VR=aE(),dE=class{constructor(e){l(this,"perceptionService");this.perceptionService=e}processActionEvents(e,r,n,i){let o={turn:r.turn,playerId:r.playerId,locationId:r.locationId},a=e.map(c=>{let d=(0,VR.toSemanticEvent)(c);return(0,VR.processEvent)(d,o)});this.perceptionService&&(a=this.perceptionService.filterEvents(a,n,i));let s=[];for(let c of a)(0,dq.isPlatformRequestEvent)(c)&&s.push(c);return{semanticEvents:a,platformEvents:s}}processSemanticEvents(e,r,n,i){let o={turn:r.turn,playerId:r.playerId,locationId:r.locationId},a=e.map(c=>(0,VR.processEvent)(c,o));this.perceptionService&&(a=this.perceptionService.filterEvents(a,n,i));let s=[];for(let c of a)(0,dq.isPlatformRequestEvent)(c)&&s.push(c);return{semanticEvents:a,platformEvents:s}}emitEvents(e,r,n,i,o,a,s){let c=n.get(i)||[];n.set(i,[...c,...e]);for(let d of e)r.emit(d);if(o.onEvent)for(let d of e)o.onEvent(d);for(let d of e)a(d),s&&s(d)}checkForVictory(e){for(let r of e)if(r.type==="story.victory"){let n=r.data;return{reason:n?.reason||"Story completed",score:n?.score||0}}return null}};pm.TurnEventProcessor=dE;function lee(t){return new dE(t)}});var QR=p(uE=>{"use strict";Object.defineProperty(uE,"__esModule",{value:!0});uE.GameEngine=void 0;var lq=E(),uee=kH(),Fc=zi(),zR=nq(),U=Ve(),mee=qR(),uq=xb(),pee=WT(),fee=sR(),lE=du(),KR=aE(),Cs=Tu(),gee=GR(),hee=FR(),yee=YR(),$R=class{constructor(e){l(this,"world");l(this,"sessionStartTime");l(this,"sessionTurns",0);l(this,"sessionMoves",0);l(this,"context");l(this,"config");l(this,"commandExecutor");l(this,"eventProcessor");l(this,"platformEvents");l(this,"actionRegistry");l(this,"textService");l(this,"turnEvents",new Map);l(this,"running",!1);l(this,"story");l(this,"languageProvider");l(this,"parser");l(this,"eventListeners",new Map);l(this,"saveRestoreHooks");l(this,"eventSource",(0,U.createSemanticEventSource)());l(this,"systemEventSource");l(this,"pendingPlatformOps",[]);l(this,"perceptionService");l(this,"pluginRegistry");l(this,"random");l(this,"narrativeSettings");l(this,"vocabularyManager");l(this,"saveRestoreService");l(this,"turnEventProcessor");l(this,"platformOpHandler");l(this,"hasEmittedInitialized",!1);this.world=e.world,this.perceptionService=e.perceptionService,this.world.registerCapability(lq.StandardCapabilities.COMMAND_HISTORY,{schema:Fc.CommandHistoryCapabilitySchema}),this.config={maxHistory:100,validateEvents:!0,collectTiming:!1,maxUndoSnapshots:10,...e.config},this.context={currentTurn:1,player:e.player,history:[],metadata:{started:new Date,lastPlayed:new Date}},this.actionRegistry=new Fc.StandardActionRegistry;for(let n of Fc.standardActions)this.actionRegistry.register(n);this.eventProcessor=new uee.EventProcessor(this.world);let r={registerHandler:(n,i)=>{this.eventProcessor.registerHandler(n,(o,a)=>i(o))}};this.world.connectEventProcessor(r),(0,Fc.registerStandardChains)(this.world),this.platformEvents=(0,U.createSemanticEventSource)(),this.systemEventSource=(0,U.createGenericEventSource)(),this.systemEventSource.subscribe(n=>{this.emit("event",{id:n.id,timestamp:new Date(n.timestamp),type:`system.${n.type}`,data:n.data,sequence:0,turn:this.context.currentTurn,scope:"global"})}),this.pluginRegistry=new mee.PluginRegistry,this.random=(0,U.createSeededRandom)(),this.narrativeSettings=(0,uq.buildNarrativeSettings)(),this.vocabularyManager=(0,gee.createVocabularyManager)(),this.saveRestoreService=(0,hee.createSaveRestoreService)({maxSnapshots:this.config.maxUndoSnapshots??10}),this.turnEventProcessor=(0,yee.createTurnEventProcessor)(this.perceptionService),this.languageProvider=e.language,this.parser=e.parser,this.textService=(0,zR.createTextService)(this.languageProvider),this.actionRegistry.setLanguageProvider(this.languageProvider),this.parser&&(0,Cs.hasPlatformEventEmitter)(this.parser)&&this.parser.setPlatformEventEmitter(n=>{this.platformEvents.addEvent(n)}),this.commandExecutor=(0,pee.createCommandExecutor)(this.world,this.actionRegistry,this.eventProcessor,this.parser,this.systemEventSource)}setStory(e){let r=(0,U.createStoryLoadingEvent)(e.config.id);this.emitGameEvent(r),this.story=e,this.narrativeSettings=(0,uq.buildNarrativeSettings)(e.config.narrative),e.initializeWorld(this.world);let n=e.createPlayer(this.world);if(this.context.player=n,this.world.setPlayer(n.id),this.configureLanguageProviderNarrative(n),this.context.metadata.title=e.config.title,this.context.metadata.author=Array.isArray(e.config.author)?e.config.author.join(", "):e.config.author,this.context.metadata.version=e.config.version,this.context.implicitActions=e.config.implicitActions,e.getCustomActions){let o=e.getCustomActions();for(let a of o)this.actionRegistry.register(a)}e.initialize&&e.initialize();let i=(0,U.createStoryLoadedEvent)({id:e.config.id,title:e.config.title,author:this.context.metadata.author,version:e.config.version});if(this.emitGameEvent(i),e.getCustomVocabulary&&this.parser&&this.parser.registerVerbs){let o=e.getCustomVocabulary();o.verbs&&o.verbs.length>0&&this.parser.registerVerbs(o.verbs)}e.onEngineReady&&e.onEngineReady(this)}getParser(){return this.parser}getLanguageProvider(){return this.languageProvider}start(){if(this.running)throw new Error("Engine is already running");if(!this.parser)throw new Error("Engine must have a parser before starting");if(!this.languageProvider)throw new Error("Engine must have a language provider before starting");if(!this.textService)throw new Error("Engine must have a text service before starting");if(!this.commandExecutor)throw new Error("Engine must have a command executor before starting");if(!this.hasEmittedInitialized){let s=(0,U.createGameInitializedEvent)();this.emitGameEvent(s),this.hasEmittedInitialized=!0}let e=(0,U.createGameStartingEvent)({id:this.story?.config.id,title:this.context.metadata.title,author:this.context.metadata.author,version:this.context.metadata.version});this.emitGameEvent(e),this.running=!0,this.sessionStartTime=Date.now(),this.sessionTurns=0,this.sessionMoves=0;let n=this.world.findByTrait("storyInfo")[0]?.get("storyInfo"),i=n?.engineVersion||this.world.versionInfo?.engineVersion,o=n?.clientVersion||this.world.versionInfo?.clientVersion||this.world.clientVersion,a=(0,U.createGameStartedEvent)({id:this.story?.config.id,title:this.context.metadata.title,author:this.context.metadata.author,version:this.context.metadata.version,buildDate:this.story?.config.buildDate},this.sessionStartTime,i,o);this.emitGameEvent(a),this.emit("state:changed",this.context)}stop(e,r){if(!this.running)return;let n=(0,U.createGameEndingEvent)(e||"quit",{startTime:this.sessionStartTime,endTime:Date.now(),turns:this.sessionTurns,moves:this.sessionMoves});this.emitGameEvent(n),this.running=!1;let i={startTime:this.sessionStartTime,endTime:Date.now(),turns:this.sessionTurns,moves:this.sessionMoves};if(e==="victory"){let a=(0,U.createGameWonEvent)(i,r);this.emitGameEvent(a)}else if(e==="defeat"){let a=(0,U.createGameLostEvent)(r?.reason||"Game over",i);this.emitGameEvent(a)}else if(e==="quit"){let a=(0,U.createGameQuitEvent)(i);this.emitGameEvent(a)}else if(e==="abort"){let a=(0,U.createGameAbortedEvent)(r?.error||"Game aborted",i);this.emitGameEvent(a)}let o=(0,U.createGameEndedEvent)(e||"quit",i,r);this.emitGameEvent(o),this.emit("game:over",this.context)}async executeTurn(e){if(!this.running)throw new Error("Engine is not running");if(!this.commandExecutor)throw new Error("Engine must have a story set before executing turns");Fc.MetaCommandRegistry.isNonUndoable(e)||this.createUndoSnapshot();let r=this.world.getCapability("debug");r&&(r.debugParserEvents||r.debugValidationEvents||r.debugSystemEvents);let n=this.context.currentTurn;if(e==null){let i=lE.eventSequencer.sequence({type:"command.failed",data:{reason:"Input cannot be null or undefined",input:e}},n);return{turn:n,input:e,success:!1,events:[i],error:"Input cannot be null or undefined"}}this.emit("turn:start",n,e);try{if(this.parser){let m=this.world.getPlayer();if(m&&(0,Cs.hasWorldContext)(this.parser)){let g=this.world.getLocation(m.id)||"";this.parser.setWorldContext(this.world,m.id,g)}let f=this.parser.parse(e);if(f.success){let g=f.value,h=g.action;if(h&&Fc.MetaCommandRegistry.isMeta(h)){let y=await this.executeMetaCommand(e,g);return{type:"turn",turn:n,input:y.input,success:y.success,events:y.events.map(T=>lE.eventSequencer.sequence(T,n)),error:y.error,actionId:y.actionId}}}}let i=await this.commandExecutor.execute(e,this.world,this.context,this.config),o=this.world.getLocation(this.context.player.id),a={turn:n,playerId:this.context.player.id,locationId:o},s=i.events.map(m=>{let f=(0,KR.toSemanticEvent)(m);return(0,KR.processEvent)(f,a)});this.perceptionService&&(s=this.perceptionService.filterEvents(s,this.context.player,this.world));let c=this.turnEvents.get(n)||[];this.turnEvents.set(n,[...c,...s]);for(let m of s)this.eventSource.emit(m),(0,U.isPlatformRequestEvent)(m)&&this.pendingPlatformOps.push(m);if(i.success&&(this.updateCommandHistory(i,e,n),this.parser&&(0,Cs.hasPronounContext)(this.parser)&&i.validatedCommand&&this.parser.updatePronounContext(i.validatedCommand,n)),this.config.onEvent)for(let m of i.events)this.config.onEvent(m);let d=!1,u=null;for(let m of i.events)if(this.emit("event",m),m.type==="story.victory"){d=!0;let f=m.data;u={reason:f?.reason||"Story completed",score:f?.score||0}}if(i.success){let m=this.world.getLocation(this.context.player.id),f={world:this.world,turn:n,playerId:this.context.player.id,playerLocation:m||"",random:this.random,actionResult:{actionId:i.actionId||"",success:i.success,targetId:i.validatedCommand?.directObject?.entity?.id},actionEvents:s};for(let g of this.pluginRegistry.getAll()){let h=g.onAfterAction(f);h.length>0&&this.processPluginEvents(h,n,m)}}if(this.updateContext(i),this.sessionTurns++,i.success&&this.sessionMoves++,this.pendingPlatformOps.length>0){await this.processPlatformOperations(n);let m=this.turnEvents.get(n)||[];i.events=m}if(this.textService){let m=this.turnEvents.get(n)||[],f=this.textService.processTurn(m),g=(0,zR.renderToString)(f);g&&this.emit("text:output",g,n)}return this.turnEvents.set(n,[]),this.emit("turn:complete",i),d?(this.stop("victory",u),i):(this.isGameOver()&&this.stop("victory",{reason:"Story completed",score:0}),i)}catch(i){throw this.emit("turn:failed",i,n),i}}async executeMetaCommand(e,r){let n=[];try{let i=this.commandExecutor.validator.validate(r);if(!i.success){let f={id:`meta_error_${Date.now()}`,type:"if.event.command_error",timestamp:Date.now(),data:{messageId:`if.action.command.${i.error?.code||"validation_failed"}`,params:i.error?.details||{},blocked:!0,reason:i.error?.code||"validation_failed"},entities:{}};return n.push(f),this.processMetaEvents(n),{type:"meta",input:e,success:!1,events:n,error:i.error?.code||"Validation failed",actionId:r.action}}let o=i.value,a=this.actionRegistry.get(o.actionId);if(!a){let f={id:`meta_error_${Date.now()}`,type:"if.event.command_error",timestamp:Date.now(),data:{messageId:"if.action.command.action_not_found",params:{actionId:o.actionId},blocked:!0,reason:"action_not_found"},entities:{}};return n.push(f),this.processMetaEvents(n),{type:"meta",input:e,success:!1,events:n,error:`Action not found: ${o.actionId}`,actionId:o.actionId}}let s=(0,Fc.createScopeResolver)(this.world),c=(0,fee.createActionContext)(this.world,this.context,o,a,s),d=a.validate(c),u;d.valid?(a.execute(c),u=a.report?a.report(c):[]):u=a.blocked?a.blocked(c,d):[{id:`meta_blocked_${Date.now()}`,type:"if.event.command_error",timestamp:Date.now(),data:{messageId:`if.action.command.${d.error||"validation_failed"}`,params:d.params||{},blocked:!0,reason:d.error||"validation_failed"},entities:{}}],n.push(...u);let m=n.filter(U.isPlatformRequestEvent);for(let f of m){let g=await this.processMetaPlatformOperation(f);n.push(...g)}return this.processMetaEvents(n),{type:"meta",input:e,success:d.valid,events:n,actionId:o.actionId}}catch(i){let o={id:`meta_error_${Date.now()}`,type:"command.failed",timestamp:Date.now(),data:{reason:i.message,input:e},entities:{}};return n.push(o),this.processMetaEvents(n),{type:"meta",input:e,success:!1,events:n,error:i.message,actionId:r.action}}}processMetaEvents(e){if(!this.textService||e.length===0)return;for(let i of e)this.emit("event",i);let r=this.textService.processTurn(e),n=(0,zR.renderToString)(r);n&&this.emit("text:output",n,this.context.currentTurn)}async processMetaPlatformOperation(e){let r=[];switch(e.type){case U.PlatformEventType.SAVE_REQUESTED:{let n=e.payload.context;if(this.saveRestoreHooks?.onSaveRequested)try{let i=this.createSaveData();n?.saveName&&(i.metadata.description=n.saveName),n?.metadata&&Object.assign(i.metadata,n.metadata),await this.saveRestoreHooks.onSaveRequested(i),r.push((0,U.createSaveCompletedEvent)(!0))}catch(i){r.push((0,U.createSaveCompletedEvent)(!1,i.message))}else r.push((0,U.createSaveCompletedEvent)(!1,"No save handler registered"));break}case U.PlatformEventType.RESTORE_REQUESTED:{if(this.saveRestoreHooks?.onRestoreRequested)try{let n=await this.saveRestoreHooks.onRestoreRequested();n?(this.loadSaveData(n),r.push((0,U.createRestoreCompletedEvent)(!0))):r.push((0,U.createRestoreCompletedEvent)(!1,"No save data available"))}catch(n){r.push((0,U.createRestoreCompletedEvent)(!1,n.message))}else r.push((0,U.createRestoreCompletedEvent)(!1,"No restore handler registered"));break}case U.PlatformEventType.QUIT_REQUESTED:{let n=e.payload.context;this.saveRestoreHooks?.onQuitRequested?await this.saveRestoreHooks.onQuitRequested(n)?(this.stop("quit"),r.push((0,U.createQuitConfirmedEvent)())):r.push((0,U.createQuitCancelledEvent)()):r.push((0,U.createQuitConfirmedEvent)());break}case U.PlatformEventType.RESTART_REQUESTED:{let n=e.payload.context;this.saveRestoreHooks?.onRestartRequested?await this.saveRestoreHooks.onRestartRequested(n)&&this.story?(this.running&&this.stop(),this.parser&&(0,Cs.hasPronounContext)(this.parser)&&this.parser.resetPronounContext(),await this.setStory(this.story),this.start(),r.push((0,U.createRestartCompletedEvent)(!0))):r.push((0,U.createRestartCompletedEvent)(!1)):this.story&&(this.running&&this.stop(),this.parser&&(0,Cs.hasPronounContext)(this.parser)&&this.parser.resetPronounContext(),await this.setStory(this.story),this.start(),r.push((0,U.createRestartCompletedEvent)(!0)));break}case U.PlatformEventType.UNDO_REQUESTED:{this.undo()?r.push((0,U.createUndoCompletedEvent)(!0,this.context.currentTurn)):r.push((0,U.createUndoCompletedEvent)(!1,void 0,"Nothing to undo"));break}case U.PlatformEventType.AGAIN_REQUESTED:{let n=e.payload.context;if(!n?.command)r.push((0,U.createAgainFailedEvent)("No command to repeat"));else try{await this.executeTurn(n.command)}catch(i){r.push((0,U.createAgainFailedEvent)(i.message))}break}}return r}getContext(){return{...this.context}}getWorld(){return this.world}getStory(){return this.story}getEventSource(){return this.eventSource}getNarrativeSettings(){return this.narrativeSettings}configureLanguageProviderNarrative(e){if(!this.languageProvider||!("setNarrativeSettings"in this.languageProvider))return;let r={perspective:this.narrativeSettings.perspective};if(this.narrativeSettings.perspective==="3rd")if(this.narrativeSettings.playerPronouns)r.playerPronouns=this.narrativeSettings.playerPronouns;else{let n=e.get("actor");n?.pronouns&&(r.playerPronouns=Array.isArray(n.pronouns)?n.pronouns[0]:n.pronouns)}this.languageProvider.setNarrativeSettings(r)}getPluginRegistry(){return this.pluginRegistry}getEventProcessor(){return this.eventProcessor}getTextService(){return this.textService}setTextService(e){this.textService=e}registerSaveRestoreHooks(e){this.saveRestoreHooks=e}registerParsedCommandTransformer(e){this.commandExecutor.registerParsedCommandTransformer(e)}unregisterParsedCommandTransformer(e){return this.commandExecutor.unregisterParsedCommandTransformer(e)}async save(){if(!this.saveRestoreHooks)return!1;try{let e=this.createSaveData();return await this.saveRestoreHooks.onSaveRequested(e),!0}catch(e){return console.error("Save failed:",e),!1}}async restore(){if(!this.saveRestoreHooks)return!1;try{let e=await this.saveRestoreHooks.onRestoreRequested();return e?(this.loadSaveData(e),!0):!1}catch(e){return console.error("Restore failed:",e),!1}}createUndoSnapshot(){this.saveRestoreService.createUndoSnapshot(this.world,this.context.currentTurn)}undo(){let e=this.saveRestoreService.undo(this.world);return e?(this.context.currentTurn=e.turn,this.updateScopeVocabulary(),this.emit("state:changed",this.context),!0):!1}canUndo(){return this.saveRestoreService.canUndo()}getUndoLevels(){return this.saveRestoreService.getUndoLevels()}processPluginEvents(e,r,n){let i={turn:r,playerId:this.context.player.id,locationId:n??void 0},o=e.map(s=>(0,KR.processEvent)(s,i));this.perceptionService&&(o=this.perceptionService.filterEvents(o,this.context.player,this.world));let a=this.turnEvents.get(r)||[];this.turnEvents.set(r,[...a,...o]);for(let s of o)this.eventSource.emit(s),(0,U.isPlatformRequestEvent)(s)&&this.pendingPlatformOps.push(s);if(this.config.onEvent)for(let s of o)this.config.onEvent(s);for(let s of o)this.emit("event",s),this.dispatchEntityHandlers(s)}createSaveData(){return this.saveRestoreService.createSaveData(this)}loadSaveData(e){let r=this.saveRestoreService.loadSaveData(e,this);this.eventSource=r.eventSource,this.context.currentTurn=r.currentTurn,this.context.metadata.lastPlayed=new Date,this.context.history=this.saveRestoreService.deserializeTurnHistory(e.engineState.turnHistory,this.eventSource),this.parser&&(0,Cs.hasPronounContext)(this.parser)&&this.parser.resetPronounContext(),this.updateScopeVocabulary(),this.emit("state:changed",this.context)}getHistory(){return[...this.context.history]}getRecentEvents(e=10){let r=[],n=this.context.history.slice(-Math.ceil(e/5));for(let i of n)r.push(...i.events);return lE.EventSequenceUtils.sort(r).slice(-e)}updateEntityVocabulary(e,r){this.vocabularyManager.updateEntityVocabulary(e,r)}updateScopeVocabulary(){this.vocabularyManager.updateScopeVocabulary(this.world,this.context.player.id)}emitPlatformEvent(e){let r=typeof e.data=="object"&&e.data!==null?e.data:{},n={...e,id:`platform_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),data:{...r,turn:this.context.currentTurn}};this.platformEvents.addEvent(n)}updateContext(e){this.context.history.push(e),this.context.history.length>this.config.maxHistory&&(this.context.history=this.context.history.slice(-this.config.maxHistory)),this.context.currentTurn++,this.context.metadata.lastPlayed=new Date,this.updateScopeVocabulary(),this.emit("state:changed",this.context)}updateCommandHistory(e,r,n){let i=this.world.getCapability(lq.StandardCapabilities.COMMAND_HISTORY);if(!i)return;let o=e.actionId;if(!o)return;let a={verb:e.parsedCommand?.action||r.split(" ")[0]};if(e.parsedCommand){let d=e.parsedCommand;if(d.structure)a={verb:d.structure.verb?.text||d.action,directObject:d.structure.directObject?.text,preposition:d.structure.preposition?.text,indirectObject:d.structure.indirectObject?.text};else{let u=d;(u.directObject||u.indirectObject)&&(a={verb:d.action,directObject:u.directObject?.text,preposition:u.preposition,indirectObject:u.indirectObject?.text})}}let s={actionId:o,originalText:r,parsedCommand:a,turnNumber:n,timestamp:Date.now()};i.entries||(i.entries=[]),i.entries.push(s);let c=i.maxEntries||100;i.entries.length>c&&(i.entries=i.entries.slice(-c))}async processPlatformOperations(e){let r=e??this.context.currentTurn;this.turnEvents.has(r)||this.turnEvents.set(r,[]);let n=[...this.pendingPlatformOps];this.pendingPlatformOps=[];for(let i of n)try{switch(i.type){case U.PlatformEventType.SAVE_REQUESTED:{let o=i.payload.context;if(this.saveRestoreHooks?.onSaveRequested){let a=this.createSaveData();o?.saveName&&(a.metadata.description=o.saveName),o?.metadata&&Object.assign(a.metadata,o.metadata),await this.saveRestoreHooks.onSaveRequested(a);let s=(0,U.createSaveCompletedEvent)(!0);this.eventSource.emit(s),this.turnEvents.get(r)?.push(s),this.emit("event",s)}else{let a=(0,U.createSaveCompletedEvent)(!1,"No save handler registered");this.eventSource.emit(a),this.turnEvents.get(r)?.push(a),this.emit("event",a)}break}case U.PlatformEventType.RESTORE_REQUESTED:{let o=i.payload.context;if(this.saveRestoreHooks?.onRestoreRequested){let a=await this.saveRestoreHooks.onRestoreRequested();if(a){this.loadSaveData(a);let s=(0,U.createRestoreCompletedEvent)(!0);this.eventSource.emit(s),this.turnEvents.get(r)?.push(s),this.emit("event",s)}else{let s=(0,U.createRestoreCompletedEvent)(!1,"No save data available or restore cancelled");this.eventSource.emit(s),this.turnEvents.get(r)?.push(s),this.emit("event",s)}}else{let a=(0,U.createRestoreCompletedEvent)(!1,"No restore handler registered");this.eventSource.emit(a),this.turnEvents.get(r)?.push(a),this.emit("event",a)}break}case U.PlatformEventType.QUIT_REQUESTED:{let o=i.payload.context;if(this.saveRestoreHooks?.onQuitRequested)if(await this.saveRestoreHooks.onQuitRequested(o)){this.stop("quit");let s=(0,U.createQuitConfirmedEvent)();this.eventSource.emit(s);let c=this.turnEvents.get(r);c&&c.push(s),this.emit("event",s)}else{let s=(0,U.createQuitCancelledEvent)();this.eventSource.emit(s);let c=this.turnEvents.get(r);c&&c.push(s),this.emit("event",s)}else{let a=(0,U.createQuitConfirmedEvent)();this.eventSource.emit(a);let s=this.turnEvents.get(r);s&&s.push(a),this.emit("event",a)}break}case U.PlatformEventType.RESTART_REQUESTED:{let o=i.payload.context;if(this.saveRestoreHooks?.onRestartRequested)if(await this.saveRestoreHooks.onRestartRequested(o)){let s=(0,U.createRestartCompletedEvent)(!0);this.eventSource.emit(s),this.turnEvents.get(r)?.push(s),this.emit("event",s),this.story&&(this.running&&this.stop(),this.parser&&(0,Cs.hasPronounContext)(this.parser)&&this.parser.resetPronounContext(),await this.setStory(this.story),this.start())}else{let s=(0,U.createRestartCompletedEvent)(!1);this.eventSource.emit(s),this.turnEvents.get(r)?.push(s),this.emit("event",s)}else{let a=(0,U.createRestartCompletedEvent)(!0);this.eventSource.emit(a),this.turnEvents.get(r)?.push(a),this.emit("event",a),this.story&&(this.running&&this.stop(),this.parser&&(0,Cs.hasPronounContext)(this.parser)&&this.parser.resetPronounContext(),await this.setStory(this.story),this.start())}break}case U.PlatformEventType.UNDO_REQUESTED:{let o=this.context.currentTurn;if(this.undo()){let s=(0,U.createUndoCompletedEvent)(!0,this.context.currentTurn);this.eventSource.emit(s),this.turnEvents.get(r)?.push(s),this.emit("event",s)}else{let s=(0,U.createUndoCompletedEvent)(!1,void 0,"Nothing to undo");this.eventSource.emit(s),this.turnEvents.get(r)?.push(s),this.emit("event",s)}break}case U.PlatformEventType.AGAIN_REQUESTED:{let o=i.payload.context;if(!o?.command){let a=(0,U.createAgainFailedEvent)("No command to repeat");this.eventSource.emit(a),this.turnEvents.get(r)?.push(a),this.emit("event",a);break}try{let a=await this.executeTurn(o.command)}catch(a){let s=(0,U.createAgainFailedEvent)(a instanceof Error?a.message:"Failed to repeat command");this.eventSource.emit(s),this.turnEvents.get(r)?.push(s),this.emit("event",s)}break}}}catch(o){console.error(`Error processing platform operation ${i.type}:`,o);let a;switch(i.type){case U.PlatformEventType.SAVE_REQUESTED:a=(0,U.createSaveCompletedEvent)(!1,o instanceof Error?o.message:"Unknown error");break;case U.PlatformEventType.RESTORE_REQUESTED:a=(0,U.createRestoreCompletedEvent)(!1,o instanceof Error?o.message:"Unknown error");break;case U.PlatformEventType.QUIT_REQUESTED:a=(0,U.createQuitCancelledEvent)();break;case U.PlatformEventType.RESTART_REQUESTED:a=(0,U.createRestartCompletedEvent)(!1);break;case U.PlatformEventType.UNDO_REQUESTED:a=(0,U.createUndoCompletedEvent)(!1,void 0,o instanceof Error?o.message:"Unknown error");break;case U.PlatformEventType.AGAIN_REQUESTED:a=(0,U.createAgainFailedEvent)(o instanceof Error?o.message:"Unknown error");break;default:continue}this.eventSource.emit(a),this.turnEvents.get(r)?.push(a),this.emit("event",a)}}emitGameEvent(e){let r={type:e.type,data:{...typeof e.data=="object"&&e.data!==null?e.data:{},id:e.id,timestamp:e.timestamp,entities:e.entities||{}}},n=lE.eventSequencer.sequence(r,this.context.currentTurn);if(this.emit("event",n),this.context.currentTurn>0){let i=this.turnEvents.get(this.context.currentTurn)||[];i.push(e),this.turnEvents.set(this.context.currentTurn,i)}}emit(e,...r){let n=this.eventListeners.get(e);if(n)for(let i of n)try{i(...r)}catch(o){console.error(`Error in event listener for ${e}:`,o)}}dispatchEntityHandlers(e){let r=this.world.getAllEntities();for(let n of r){let i=n.on;if(!i||typeof i!="object")continue;let o=i[e.type];if(typeof o=="function")try{let a=o(e,this.world);if(Array.isArray(a)){let s=this.turnEvents.get(this.context.currentTurn)||[];for(let c of a)s.push(c),this.emit("event",c);this.turnEvents.set(this.context.currentTurn,s)}}catch(a){console.error(`Error in entity handler for ${n.id} on ${e.type}:`,a)}}}isGameOver(){return this.story&&this.story.isComplete?this.story.isComplete():!1}on(e,r){return this.eventListeners.has(e)||this.eventListeners.set(e,new Set),this.eventListeners.get(e).add(r),this}off(e,r){let n=this.eventListeners.get(e);return n&&n.delete(r),this}};uE.GameEngine=$R});var mq=p(fm=>{"use strict";Object.defineProperty(fm,"__esModule",{value:!0});fm.PlatformOperationHandler=void 0;fm.createPlatformOperationHandler=Tee;var qe=Ve(),XR=Tu(),mE=class{constructor(e,r,n,i){l(this,"saveRestoreHooks");l(this,"saveRestoreService");l(this,"stateProvider");l(this,"vocabularyManager");this.saveRestoreHooks=e,this.saveRestoreService=r,this.stateProvider=n,this.vocabularyManager=i}async processAll(e,r,n){r.turnEvents.has(r.currentTurn)||r.turnEvents.set(r.currentTurn,[]);for(let i of e)try{let o=await this.handleOperation(i,r,n);o&&(r.eventSource.emit(o),r.turnEvents.get(r.currentTurn)?.push(o),r.emitEvent(o))}catch(o){console.error(`Error processing platform operation ${i.type}:`,o);let a=this.createErrorEvent(i.type,o instanceof Error?o.message:"Unknown error");a&&(r.eventSource.emit(a),r.turnEvents.get(r.currentTurn)?.push(a),r.emitEvent(a))}}async handleOperation(e,r,n){switch(e.type){case qe.PlatformEventType.SAVE_REQUESTED:return this.handleSave(e);case qe.PlatformEventType.RESTORE_REQUESTED:return this.handleRestore(e,n);case qe.PlatformEventType.QUIT_REQUESTED:return this.handleQuit(e,r,n);case qe.PlatformEventType.RESTART_REQUESTED:return this.handleRestart(e,r,n);case qe.PlatformEventType.UNDO_REQUESTED:return this.handleUndo(n);default:return null}}async handleSave(e){if(!this.saveRestoreHooks?.onSaveRequested)return(0,qe.createSaveCompletedEvent)(!1,"No save handler registered");let r=e.payload.context,n=this.saveRestoreService.createSaveData(this.stateProvider);return r?.saveName&&(n.metadata.description=r.saveName),r?.metadata&&Object.assign(n.metadata,r.metadata),await this.saveRestoreHooks.onSaveRequested(n),(0,qe.createSaveCompletedEvent)(!0)}async handleRestore(e,r){if(!this.saveRestoreHooks?.onRestoreRequested)return(0,qe.createRestoreCompletedEvent)(!1,"No restore handler registered");let n=await this.saveRestoreHooks.onRestoreRequested();if(!n)return(0,qe.createRestoreCompletedEvent)(!1,"No save data available or restore cancelled");let i=this.saveRestoreService.loadSaveData(n,this.stateProvider);r.updateContext({currentTurn:i.currentTurn});let o=r.getParser();return o&&(0,XR.hasPronounContext)(o)&&o.resetPronounContext(),r.updateScopeVocabulary(),r.emitStateChanged(),(0,qe.createRestoreCompletedEvent)(!0)}async handleQuit(e,r,n){let i=e.payload.context;return this.saveRestoreHooks?.onQuitRequested?await this.saveRestoreHooks.onQuitRequested(i||{})?(n.stopEngine("quit"),(0,qe.createQuitConfirmedEvent)()):(0,qe.createQuitCancelledEvent)():(0,qe.createQuitConfirmedEvent)()}async handleRestart(e,r,n){let i=e.payload.context;if(this.saveRestoreHooks?.onRestartRequested)if(await this.saveRestoreHooks.onRestartRequested(i||{})){let a=n.getParser();return a&&(0,XR.hasPronounContext)(a)&&a.resetPronounContext(),await n.restartStory(),(0,qe.createRestartCompletedEvent)(!0)}else return(0,qe.createRestartCompletedEvent)(!1);else{let o=n.getParser();return o&&(0,XR.hasPronounContext)(o)&&o.resetPronounContext(),await n.restartStory(),(0,qe.createRestartCompletedEvent)(!0)}}handleUndo(e){let r=this.stateProvider.getWorld(),n=this.saveRestoreService.undo(r);return n?(e.updateContext({currentTurn:n.turn}),e.updateScopeVocabulary(),e.emitStateChanged(),(0,qe.createUndoCompletedEvent)(!0,n.turn)):(0,qe.createUndoCompletedEvent)(!1,void 0,"Nothing to undo")}createErrorEvent(e,r){switch(e){case qe.PlatformEventType.SAVE_REQUESTED:return(0,qe.createSaveCompletedEvent)(!1,r);case qe.PlatformEventType.RESTORE_REQUESTED:return(0,qe.createRestoreCompletedEvent)(!1,r);case qe.PlatformEventType.QUIT_REQUESTED:return(0,qe.createQuitCancelledEvent)();case qe.PlatformEventType.RESTART_REQUESTED:return(0,qe.createRestartCompletedEvent)(!1);case qe.PlatformEventType.UNDO_REQUESTED:return(0,qe.createUndoCompletedEvent)(!1,void 0,r);default:return null}}};fm.PlatformOperationHandler=mE;function Tee(t,e,r,n){return new mE(t,e,r,n)}});var gq=p(Le=>{"use strict";var Eee=Le&&Le.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),gn=Le&&Le.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&Eee(e,t,r)};Object.defineProperty(Le,"__esModule",{value:!0});Le.EventSequenceUtils=Le.eventSequencer=Le.createCommandExecutor=Le.CommandExecutor=Le.GameEngine=Le.PluginRegistry=void 0;gn(mM(),Le);gn(xb(),Le);gn(hM(),Le);gn(du(),Le);gn(WT(),Le);gn(dR(),Le);gn(Tu(),Le);gn(Mp(),Le);gn(QR(),Le);var vee=qR();Object.defineProperty(Le,"PluginRegistry",{enumerable:!0,get:function(){return vee.PluginRegistry}});gn(GR(),Le);gn(FR(),Le);gn(YR(),Le);gn(mq(),Le);var _ee=QR();Object.defineProperty(Le,"GameEngine",{enumerable:!0,get:function(){return _ee.GameEngine}});var pq=WT();Object.defineProperty(Le,"CommandExecutor",{enumerable:!0,get:function(){return pq.CommandExecutor}});Object.defineProperty(Le,"createCommandExecutor",{enumerable:!0,get:function(){return pq.createCommandExecutor}});var fq=du();Object.defineProperty(Le,"eventSequencer",{enumerable:!0,get:function(){return fq.eventSequencer}});Object.defineProperty(Le,"EventSequenceUtils",{enumerable:!0,get:function(){return fq.EventSequenceUtils}})});var hq=p(pE=>{"use strict";Object.defineProperty(pE,"__esModule",{value:!0});pE.EnglishPatternCompiler=void 0;var _a=jt(),ZR=class{compile(e){if(!e||e.trim().length===0)throw new _a.PatternSyntaxError("Pattern cannot be empty",e);if(!this.validate(e))throw new _a.PatternSyntaxError("Invalid pattern syntax",e);let r=[],n=new Map,o=this.expandOptionalElements(e).trim().split(/\s+/);for(let c=0;c<o.length;c++){let d=o[c];if(d==="[optional]"){if(c++,c>=o.length)throw new _a.PatternSyntaxError("Expected word after [optional] marker",e);let u=o[c];if(u.startsWith(":")){let m=u.substring(1),f=!1;if(m.endsWith("...")&&(m=m.slice(0,-3),f=!0),!m||!/^[a-zA-Z_]\w*$/.test(m))throw new _a.PatternSyntaxError(`Invalid slot name: ${u}`,e,e.indexOf(u));if(n.has(m))throw new _a.PatternSyntaxError(`Duplicate slot name: ${m}`,e,e.indexOf(u));n.set(m,r.length),r.push({type:"slot",value:m,optional:!0,greedy:f||void 0,slotType:f?_a.SlotType.TEXT_GREEDY:void 0})}else if(u.includes("|")){let m=u.split("|");r.push({type:"alternates",value:m[0],alternates:m,optional:!0})}else r.push({type:"literal",value:u,optional:!0})}else if(d.startsWith(":")){let u=d.substring(1),m=!1;if(u.endsWith("...")&&(u=u.slice(0,-3),m=!0),!u||!/^[a-zA-Z_]\w*$/.test(u))throw new _a.PatternSyntaxError(`Invalid slot name: ${d}`,e,e.indexOf(d));if(n.has(u))throw new _a.PatternSyntaxError(`Duplicate slot name: ${u}`,e,e.indexOf(d));n.set(u,r.length),r.push({type:"slot",value:u,greedy:m||void 0,slotType:m?_a.SlotType.TEXT_GREEDY:void 0})}else if(d.includes("|")){let u=d.split("|");r.push({type:"alternates",value:u[0],alternates:u})}else r.push({type:"literal",value:d})}let a=r.filter(c=>!c.optional&&(c.type==="slot"||c.type==="literal"||c.type==="alternates")).length,s=r.filter(c=>c.type==="slot"||c.type==="literal"||c.type==="alternates").length;return{tokens:r,slots:n,minTokens:a,maxTokens:s}}expandOptionalElements(e){let r=e,n=/\[([^\]]+)\]/g,i;for(;(i=n.exec(e))!==null;){let o=i[0],a=i[1];r=r.replace(o,`[optional] ${a}`)}return r}validate(e){if(!e||e.trim().length===0)return!1;let r=e.trim().split(/\s+/);for(let n of r){if(n.startsWith(":")){let i=n.substring(1);if(i.endsWith("...")&&(i=i.slice(0,-3)),!i||!/^[a-zA-Z_]\w*$/.test(i))return!1}if(n.includes("|")&&(n.endsWith("|")||n.includes("||")||n.split("|").some(o=>o.length===0)))return!1}return!0}extractSlots(e){let r=[],n=e.match(/:\w+(?:\.\.\.)?/g)||[];for(let i of n){let o=i.substring(1);o.endsWith("...")&&(o=o.slice(0,-3)),r.includes(o)||r.push(o)}return r}};pE.EnglishPatternCompiler=ZR});var yq=p(re=>{"use strict";Object.defineProperty(re,"__esModule",{value:!0});re.englishVerbs=re.IFActions=void 0;re.IFActions={GOING:"if.action.going",ENTERING:"if.action.entering",EXITING:"if.action.exiting",CLIMBING:"if.action.climbing",LOOKING:"if.action.looking",EXAMINING:"if.action.examining",READING:"if.action.reading",SEARCHING:"if.action.searching",LISTENING:"if.action.listening",SMELLING:"if.action.smelling",TOUCHING:"if.action.touching",TAKING:"if.action.taking",DROPPING:"if.action.dropping",PUTTING:"if.action.putting",INSERTING:"if.action.inserting",OPENING:"if.action.opening",CLOSING:"if.action.closing",LOCKING:"if.action.locking",UNLOCKING:"if.action.unlocking",SWITCHING_ON:"if.action.switching_on",SWITCHING_OFF:"if.action.switching_off",PUSHING:"if.action.pushing",PULLING:"if.action.pulling",TURNING:"if.action.turning",USING:"if.action.using",GIVING:"if.action.giving",SHOWING:"if.action.showing",THROWING:"if.action.throwing",ATTACKING:"if.action.attacking",TALKING:"if.action.talking",ASKING:"if.action.asking",TELLING:"if.action.telling",ANSWERING:"if.action.answering",WEARING:"if.action.wearing",TAKING_OFF:"if.action.taking_off",EATING:"if.action.eating",DRINKING:"if.action.drinking",INVENTORY:"if.action.inventory",WAITING:"if.action.waiting",SLEEPING:"if.action.sleeping",SAVING:"if.action.saving",RESTORING:"if.action.restoring",QUITTING:"if.action.quitting",HELP:"if.action.help",ABOUT:"if.action.about",SCORING:"if.action.scoring",TRACE:"author.trace"};re.englishVerbs=[{action:re.IFActions.GOING,verbs:["go","move","walk","run","head","travel"],requiresObject:!0},{action:re.IFActions.ENTERING,verbs:["enter","go in","go into"],requiresObject:!0},{action:re.IFActions.EXITING,verbs:["exit","leave","go out","get out"],requiresObject:!1},{action:re.IFActions.CLIMBING,verbs:["climb","scale","ascend"],requiresObject:!0},{action:re.IFActions.LOOKING,verbs:["look","l"],requiresObject:!1},{action:re.IFActions.EXAMINING,verbs:["examine","x","inspect","check","view","observe","look at"],requiresObject:!0},{action:re.IFActions.READING,verbs:["read","peruse","study"],requiresObject:!0},{action:re.IFActions.SEARCHING,verbs:["search","find","locate"],requiresObject:!0},{action:re.IFActions.LISTENING,verbs:["listen","hear"],requiresObject:!1},{action:re.IFActions.SMELLING,verbs:["smell","sniff"],requiresObject:!1},{action:re.IFActions.TOUCHING,verbs:["touch","feel"],requiresObject:!0},{action:re.IFActions.TAKING,verbs:["take","get","pick","grab","acquire","pick up","take up"],requiresObject:!0},{action:re.IFActions.DROPPING,verbs:["drop","put down","discard","throw away"],requiresObject:!0},{action:re.IFActions.PUTTING,verbs:["put","place","put in","put on"],requiresObject:!0,allowsIndirectObject:!0},{action:re.IFActions.INSERTING,verbs:["insert","insert into"],requiresObject:!0,allowsIndirectObject:!0},{action:re.IFActions.OPENING,verbs:["open","unwrap","uncover"],requiresObject:!0},{action:re.IFActions.CLOSING,verbs:["close","shut","cover"],requiresObject:!0},{action:re.IFActions.LOCKING,verbs:["lock","secure"],requiresObject:!0},{action:re.IFActions.UNLOCKING,verbs:["unlock","unsecure"],requiresObject:!0},{action:re.IFActions.SWITCHING_ON,verbs:["switch on","turn on","activate","start"],requiresObject:!0},{action:re.IFActions.SWITCHING_OFF,verbs:["switch off","turn off","deactivate","stop"],requiresObject:!0},{action:re.IFActions.PUSHING,verbs:["push","press","shove"],requiresObject:!0},{action:re.IFActions.PULLING,verbs:["pull","tug","drag"],requiresObject:!0},{action:re.IFActions.TURNING,verbs:["turn","rotate","twist"],requiresObject:!0},{action:re.IFActions.USING,verbs:["use","utilize","employ"],requiresObject:!0,allowsIndirectObject:!0},{action:re.IFActions.GIVING,verbs:["give","hand","offer"],requiresObject:!0,allowsIndirectObject:!0},{action:re.IFActions.SHOWING,verbs:["show","display","present"],requiresObject:!0,allowsIndirectObject:!0},{action:re.IFActions.THROWING,verbs:["throw","toss","hurl"],requiresObject:!0,allowsIndirectObject:!0},{action:re.IFActions.ATTACKING,verbs:["attack","hit","strike","fight","kill"],requiresObject:!0},{action:re.IFActions.WEARING,verbs:["wear","put on","don","equip"],requiresObject:!0},{action:re.IFActions.TAKING_OFF,verbs:["remove","take off","doff","unequip"],requiresObject:!0},{action:re.IFActions.EATING,verbs:["eat","consume","devour"],requiresObject:!0},{action:re.IFActions.DRINKING,verbs:["drink","sip","swallow","quaff"],requiresObject:!0},{action:re.IFActions.TALKING,verbs:["talk","speak","converse","chat","talk to"],requiresObject:!0},{action:re.IFActions.ASKING,verbs:["ask","inquire","question"],requiresObject:!0,allowsIndirectObject:!0},{action:re.IFActions.TELLING,verbs:["tell","inform","say"],requiresObject:!0,allowsIndirectObject:!0},{action:re.IFActions.ANSWERING,verbs:["answer","respond","reply"],requiresObject:!0},{action:re.IFActions.INVENTORY,verbs:["inventory","i","inv"],requiresObject:!1},{action:re.IFActions.WAITING,verbs:["wait","z"],requiresObject:!1},{action:re.IFActions.SLEEPING,verbs:["sleep","nap","doze","rest","slumber"],requiresObject:!1},{action:re.IFActions.SAVING,verbs:["save","save game"],requiresObject:!1},{action:re.IFActions.RESTORING,verbs:["restore","load","load game","restore game"],requiresObject:!1},{action:re.IFActions.QUITTING,verbs:["quit","q","exit game"],requiresObject:!1},{action:re.IFActions.HELP,verbs:["help","?","commands"],requiresObject:!1},{action:re.IFActions.ABOUT,verbs:["about","info","credits"],requiresObject:!1},{action:re.IFActions.SCORING,verbs:["score","points"],requiresObject:!1},{action:re.IFActions.TRACE,verbs:["trace"],requiresObject:!1}]});var JR=p(Gr=>{"use strict";Object.defineProperty(Gr,"__esModule",{value:!0});Gr.directionMap=Gr.ordinalNumbers=Gr.cardinalNumbers=Gr.abbreviations=Gr.irregularPlurals=Gr.englishWords=void 0;Gr.englishWords={articles:["a","an","the"],prepositions:["in","on","at","to","for","with","from","into","onto","under","over","behind","beside","between","through","across","against","around","beneath","inside","outside","within","about","above","after","along","among","before","below","beyond","by","down","during","near","of","off","out","past","toward","towards","up","upon","using"],commonNouns:["door","window","wall","floor","ceiling","table","chair","bed","desk","shelf","box","container","bag","chest","trunk","key","lock","handle","button","switch","book","paper","note","letter","sign","lamp","light","candle","torch","lantern","sword","knife","gun","weapon","tool","food","water","bottle","cup","plate","coin","money","treasure","gem","jewel","rope","chain","string","wire","cable"],pronouns:["it","them","him","her","me","us","you","this","that","these","those","all","everything","everyone","everybody","nothing","nobody","none","some","any","anyone","anybody","anything","here","there","everywhere"],conjunctions:["and","or","but","then","so","because","if","when","while","although","though","unless"],determiners:["my","your","his","her","its","our","their","this","that","these","those","each","every","either","neither","some","any","no","all","both","half","several","many","much","few","little","other","another","such","what","which"],directions:["north","south","east","west","northeast","northwest","southeast","southwest","up","down","in","out","left","right","forward","back","backward"],commonAdjectives:["big","large","small","tiny","huge","little","red","blue","green","yellow","black","white","brown","gray","grey","wooden","metal","stone","glass","plastic","paper","old","new","broken","open","closed","locked","empty","full","good","bad","nice","beautiful","ugly","clean","dirty","first","second","third","last","next","previous","same","different","other","main","important"],numberWords:["zero","one","two","three","four","five","six","seven","eight","nine","ten","first","second","third","fourth","fifth","sixth","seventh","eighth","ninth","tenth"],auxiliaryVerbs:["is","are","was","were","be","been","being","have","has","had","having","do","does","did","doing","will","would","shall","should","may","might","must","can","could","ought","need","dare"],ignoreWords:["please","kindly","just","simply","really","very","quite","rather","well","now","then","so"]};Gr.irregularPlurals=new Map([["children","child"],["people","person"],["men","man"],["women","woman"],["teeth","tooth"],["feet","foot"],["mice","mouse"],["geese","goose"],["oxen","ox"],["dice","die"],["pennies","penny"],["leaves","leaf"],["knives","knife"],["wives","wife"],["lives","life"],["shelves","shelf"],["wolves","wolf"],["halves","half"],["calves","calf"]]);Gr.abbreviations=new Map([["n","north"],["s","south"],["e","east"],["w","west"],["ne","northeast"],["nw","northwest"],["se","southeast"],["sw","southwest"],["u","up"],["d","down"],["l","look"],["x","examine"],["i","inventory"],["z","wait"],["g","again"],["q","quit"]]);Gr.cardinalNumbers={zero:0,one:1,two:2,three:3,four:4,five:5,six:6,seven:7,eight:8,nine:9,ten:10,eleven:11,twelve:12,thirteen:13,fourteen:14,fifteen:15,sixteen:16,seventeen:17,eighteen:18,nineteen:19,twenty:20,thirty:30,forty:40,fifty:50,sixty:60,seventy:70,eighty:80,ninety:90,hundred:100};Gr.ordinalNumbers={first:1,second:2,third:3,fourth:4,fifth:5,sixth:6,seventh:7,eighth:8,ninth:9,tenth:10,eleventh:11,twelfth:12,thirteenth:13,fourteenth:14,fifteenth:15,sixteenth:16,seventeenth:17,eighteenth:18,nineteenth:19,twentieth:20};Gr.directionMap={north:"north",south:"south",east:"east",west:"west",n:"north",s:"south",e:"east",w:"west",northeast:"northeast",northwest:"northwest",southeast:"southeast",southwest:"southwest",ne:"northeast",nw:"northwest",se:"southeast",sw:"southwest",up:"up",down:"down",u:"up",d:"down",in:"in",out:"out"}});var eC=p(fE=>{"use strict";Object.defineProperty(fE,"__esModule",{value:!0});fE.takingLanguage=void 0;fE.takingLanguage={actionId:"if.action.taking",patterns:["take [something]","get [something]","pick up [something]","grab [something]","acquire [something]","collect [something]"],messages:{no_target:"Take what?",cant_take_self:"{You} {can't} take {yourself}.",already_have:"{You} already {have} {item}.",cant_take_room:"{You} {can't} take {item}.",fixed_in_place:"{item} is fixed in place.",container_full:"{You're} carrying too much already.",too_heavy:"Your load is too heavy. You will have to leave something behind.",cannot_take:"{You} {can't} take {item}.",taken:"Taken.",taken_from:"{You} {take} {item} from {container}.",taken_multi:"{item}: Taken."},help:{description:"Pick up objects and add them to your inventory.",examples:"take book, get lamp, pick up the key, grab sword",summary:"TAKE/GET/PICK UP - Pick up objects and add them to your inventory. Example: TAKE LAMP"}}});var tC=p(gE=>{"use strict";Object.defineProperty(gE,"__esModule",{value:!0});gE.droppingLanguage=void 0;gE.droppingLanguage={actionId:"if.action.dropping",patterns:["drop [something]","put down [something]","discard [something]","release [something]","let go of [something]"],messages:{no_target:"Drop what?",not_held:"{You} aren't holding {item}.",nothing_to_drop:"{You} aren't carrying anything.",dropped:"Dropped.",dropped_in:"{You} {put} {item} in {container}.",dropped_on:"{You} {put} {item} on {surface}.",dropped_multi:"{item}: Dropped."},help:{description:"Drop objects from your inventory.",examples:"drop book, put down lamp, discard key",summary:"DROP/PUT DOWN - Drop objects from your inventory. Example: DROP SWORD"}}});var rC=p(hE=>{"use strict";Object.defineProperty(hE,"__esModule",{value:!0});hE.lookingLanguage=void 0;hE.lookingLanguage={actionId:"if.action.looking",patterns:["look","l","look around","look at [something]","examine [something]","x [something]"],messages:{room_description:`{name}
{description}`,room_dark:"It's pitch dark, and {you} {can't} see a thing.",exits:"Exits: {exits}",you_see:"{You} can {see} {items} here.",contents_list:"{You} can {see} {items} here.",nothing_special:"{You} {see} nothing special.",container_contents:"In {container} {you} {see} {items}.",surface_contents:"On {surface} {you} {see} {items}."},help:{description:"Look around the current location to see what is there.",examples:"look, l, look around",summary:"LOOK/L - Look around the current location to see what is there. Example: LOOK"}}});var nC=p(yE=>{"use strict";Object.defineProperty(yE,"__esModule",{value:!0});yE.inventoryLanguage=void 0;yE.inventoryLanguage={actionId:"if.action.inventory",patterns:["inventory","i","inv","take inventory","check inventory"],messages:{empty:"{You} aren't carrying anything.",inventory_empty:"{You} aren't carrying anything.",nothing_at_all:"{You} aren't carrying anything at all.",hands_empty:"{Your} hands are empty.",pockets_empty:"{Your} pockets are empty.",carrying:"{You} {be} carrying:",wearing:"{You} {be} wearing:",carrying_and_wearing:"{You} {be} carrying and wearing:",item_list:"  {item}",holding_list:"  {items}",worn_list:"  {items} (worn)",inventory_header:"{You} {be} carrying:",carrying_count:"{You} {be} carrying {holdingCount} item(s).",wearing_count:"{You} {be} wearing {wearingCount} item(s).",burden_light:"{You're} traveling light.",burden_heavy:"{You're} carrying quite a load.",burden_overloaded:"{You're} weighed down with everything {you're} carrying."},help:{description:"Check what you are carrying and wearing.",examples:"inventory, i, inv",summary:"INVENTORY/I - Check what you are carrying and wearing. Example: I"}}});var iC=p(TE=>{"use strict";Object.defineProperty(TE,"__esModule",{value:!0});TE.examiningLanguage=void 0;TE.examiningLanguage={actionId:"if.action.examining",patterns:["examine [something]","x [something]","look at [something]","inspect [something]","study [something]","read [something]"],messages:{no_target:"Examine what?",not_visible:"{You} {can't} see {item} here.",cant_see:"{You} {can't} see {item} here.",examined:"{description}",examined_self:"{description}",examined_container:"{description}",examined_supporter:"{description}",examined_readable:"{description}",examined_switchable:"{description}",examined_wearable:"{description}",examined_door:"{description}",nothing_special:"{You} {see} nothing special about {item}.",description:"{description}",brief_description:"{description}",no_description:"{You} {see} nothing special about {item}.",container_open:"{item} is open.",container_closed:"{item} is closed.",container_empty:"{item} is empty.",container_contents:"In {container} {you} {see} {items}.",surface_contents:"On {surface} {you} {see} {items}.",worn_by_you:"{You} {are} wearing {item}.",worn_by_other:"{actor} is wearing {item}."},help:{description:"Examine objects more closely.",examples:"examine book, x lamp, look at key, inspect door",summary:"EXAMINE/X/LOOK AT - Look closely at objects to see detailed descriptions. Example: X BOOK"}}});var oC=p(EE=>{"use strict";Object.defineProperty(EE,"__esModule",{value:!0});EE.goingLanguage=void 0;EE.goingLanguage={actionId:"if.action.going",patterns:["go [direction]","[direction]","walk [direction]","head [direction]","move [direction]","travel [direction]"],messages:{room_description:`{name}
{description}`,contents_list:"{You} can {see} {items} here.",no_exit:"{You} {can't} go that way.",no_exit_that_way:"{You} {can't} go that way.",door_closed:"The {door} is closed.",door_locked:"The {door} is locked.",too_dark:"It is pitch dark. You are likely to be eaten by a grue.",moved:"{You} {go} {direction}.",cant_go_through:"{You} {can't} go through {obstacle}.",already_there:"{You're} already there.",nowhere_to_go:"{You}'ll have to say which compass direction to go in.",no_direction:"{You}'ll have to say which direction to go.",not_in_room:"{You're} not in a place where {you} can go anywhere.",no_exits:"There are no obvious exits.",movement_blocked:"{message}",destination_not_found:"{You} {can't} go that way.",need_light:"It's too dark to go that way safely.",went:"{You} {go} {direction}.",arrived:"{You} {arrive}.",cant_go:"{You} {can't} go that way."},help:{description:"Move in compass directions or to connected locations.",examples:"go north, n, walk east, head south, go upstairs",summary:"GO/N/S/E/W - Move in compass directions or to connected locations. Example: GO NORTH or N"}}});var aC=p(vE=>{"use strict";Object.defineProperty(vE,"__esModule",{value:!0});vE.openingLanguage=void 0;vE.openingLanguage={actionId:"if.action.opening",patterns:["open [something]","open up [something]","unclose [something]"],messages:{no_target:"Open what?",not_openable:"{item} can't be opened.",already_open:"{item} is already open.",locked:"{item} is locked.",opened:"{You} {open} {item}.",revealing:"Opening {container} reveals {items}.",its_empty:"{You} {open} {container}, which is empty.",cant_reach:"{You} {can't} reach {item}."},help:{description:"Open containers or doors.",examples:"open door, open box, open chest",summary:"OPEN - Open doors, containers, and other openable objects. Example: OPEN DOOR"}}});var sC=p(_E=>{"use strict";Object.defineProperty(_E,"__esModule",{value:!0});_E.closingLanguage=void 0;_E.closingLanguage={actionId:"if.action.closing",patterns:["close [something]","shut [something]"],messages:{no_target:"Close what?",not_closable:"{item} can't be closed.",already_closed:"{item} is already closed.",closed:"{You} {close} {item}.",cant_reach:"{You} {can't} reach {item}.",prevents_closing:"{You} {can't} close {item} while {obstacle} is in the way."},help:{description:"Close containers or doors.",examples:"close door, shut box",summary:"CLOSE/SHUT - Close doors, containers, and other closeable objects. Example: CLOSE DOOR"}}});var cC=p(bE=>{"use strict";Object.defineProperty(bE,"__esModule",{value:!0});bE.puttingLanguage=void 0;bE.puttingLanguage={actionId:"if.action.putting",patterns:["put [something] in [something]","put [something] into [something]","put [something] on [something]","put [something] onto [something]","place [something] in [something]","place [something] on [something]","insert [something] in [something]","insert [something] into [something]"],messages:{no_target:"Put what?",no_destination:"Where do {you} want to put {item}?",not_held:"{You} {need} to be holding {item} first.",not_container:"{You} {can't} put things in {destination}.",not_surface:"{You} {can't} put things on {destination}.",container_closed:"{container} is closed.",already_there:"{item} is already {relation} {destination}.",put_in:"{You} {put} {item} in {container}.",put_on:"{You} {put} {item} on {surface}.",cant_put_in_itself:"{You} {can't} put {item} inside itself.",cant_put_on_itself:"{You} {can't} put {item} on itself.",no_room:"There's no room in {container}.",no_space:"There's no space on {surface}."},help:{description:"Put objects in or on other objects.",examples:"put book in box, put lamp on table, place key in drawer",summary:"PUT ON/IN - Place objects on surfaces or in containers. Example: PUT VASE ON TABLE"}}});var dC=p(IE=>{"use strict";Object.defineProperty(IE,"__esModule",{value:!0});IE.insertingLanguage=void 0;IE.insertingLanguage={actionId:"if.action.inserting",patterns:["insert [something] in [something]","insert [something] into [something]","stick [something] in [something]","push [something] in [something]"],messages:{no_target:"Insert what?",no_destination:"Insert {item} into what?",not_held:"{You} {need} to be holding {item} first.",not_insertable:"{item} can't be inserted into things.",not_container:"{You} {can't} insert things into {destination}.",already_there:"{item} is already in {destination}.",inserted:"{You} {insert} {item} into {container}.",wont_fit:"{item} won't fit in {container}.",container_closed:"{container} is closed."},help:{description:"Insert objects into containers.",examples:"insert coin in slot, insert key into lock",summary:"INSERT/PUT IN - Put objects inside containers. Example: PUT COIN IN SLOT"}}});var lC=p(OE=>{"use strict";Object.defineProperty(OE,"__esModule",{value:!0});OE.removingLanguage=void 0;OE.removingLanguage={actionId:"if.action.removing",patterns:["remove [something] from [something]","take [something] from [something]","take [something] out of [something]","get [something] from [something]","extract [something] from [something]"],messages:{no_target:"Remove what?",no_source:"Remove {item} from what?",not_in_container:"{item} isn't in {container}.",not_on_surface:"{item} isn't on {surface}.",container_closed:"{container} is closed.",removed_from:"{You} {take} {item} from {container}.",removed_from_surface:"{You} {take} {item} from {surface}.",cant_reach:"{You} {can't} reach {item}.",already_have:"{You} already {have} {item}."},help:{description:"Remove objects from containers or surfaces.",examples:"remove book from shelf, take coin from box, get apple from basket",summary:"REMOVE/TAKE FROM - Take objects out of containers. Example: TAKE BOOK FROM SHELF"}}});var uC=p(SE=>{"use strict";Object.defineProperty(SE,"__esModule",{value:!0});SE.wearingLanguage=void 0;SE.wearingLanguage={actionId:"if.action.wearing",patterns:["wear [something]","put on [something]","put [something] on","don [something]"],messages:{no_target:"Wear what?",not_wearable:"{You} {can't} wear {item}.",not_held:"{You} {need} to be holding {item} first.",already_wearing:"{You're} already wearing {item}.",worn:"{You} {put} on {item}.",cant_wear_that:"{You} {can't} wear {item}.",hands_full:"{You} {need} to have {your} hands free to put that on."},help:{description:"Wear clothing or accessories that you are carrying.",examples:"wear hat, put on coat, don gloves, put ring on",summary:"WEAR/PUT ON - Wear clothing or accessories that you are carrying. Example: WEAR HAT"}}});var mC=p(AE=>{"use strict";Object.defineProperty(AE,"__esModule",{value:!0});AE.takingOffLanguage=void 0;AE.takingOffLanguage={actionId:"if.action.taking_off",patterns:["take off [something]","take [something] off","remove [something]","doff [something]"],messages:{no_target:"Take off what?",not_wearing:"{You} aren't wearing {item}.",removed:"{You} {take} off {item}.",cant_remove:"{You} {can't} take off {item}.",prevents_removal:"{You}'ll need to take off {blocking} first."},help:{description:"Remove worn clothing or accessories.",examples:"take off hat, remove coat, doff gloves, take ring off",summary:"TAKE OFF/REMOVE - Remove worn clothing or accessories. Example: TAKE OFF COAT"}}});var pC=p(RE=>{"use strict";Object.defineProperty(RE,"__esModule",{value:!0});RE.lockingLanguage=void 0;RE.lockingLanguage={actionId:"if.action.locking",patterns:["lock [something]","lock [something] with [something]","secure [something]","secure [something] with [something]"],messages:{no_target:"Lock what?",not_lockable:"{item} can't be locked.",no_key:"What do {you} want to lock it with?",wrong_key:"{key} doesn't fit {item}.",already_locked:"{item} is already locked.",not_closed:"{You} {need} to close {item} first.",locked:"{You} {lock} {item}.",locked_with:"{You} {lock} {item} with {key}.",cant_reach:"{You} {can't} reach {item}.",key_not_held:"{You} {need} to be holding {key}."},help:{description:"Lock containers or doors.",examples:"lock door, lock chest with key",summary:"LOCK - Lock doors and containers with the appropriate key. Example: LOCK DOOR WITH KEY"}}});var fC=p(CE=>{"use strict";Object.defineProperty(CE,"__esModule",{value:!0});CE.unlockingLanguage=void 0;CE.unlockingLanguage={actionId:"if.action.unlocking",patterns:["unlock [something]","unlock [something] with [something]","open [something] with [something]"],messages:{no_target:"Unlock what?",not_lockable:"{item} can't be unlocked.",no_key:"What do {you} want to unlock it with?",wrong_key:"{key} doesn't fit {item}.",already_unlocked:"{item} is already unlocked.",unlocked:"{You} {unlock} {item}.",unlocked_with:"{You} {unlock} {item} with {key}.",cant_reach:"{You} {can't} reach {item}.",key_not_held:"{You} {need} to be holding {key}.",still_locked:"{item} is locked."},help:{description:"Unlock containers or doors.",examples:"unlock door, unlock chest with key",summary:"UNLOCK - Unlock doors and containers with the appropriate key. Example: UNLOCK CHEST WITH KEY"}}});var gC=p(wE=>{"use strict";Object.defineProperty(wE,"__esModule",{value:!0});wE.enteringLanguage=void 0;wE.enteringLanguage={actionId:"if.action.entering",patterns:["enter [something]","get in [something]","get into [something]","get on [something]","go in [something]","go into [something]","go inside [something]","board [something]","mount [something]","sit on [something]","sit in [something]","lie on [something]","lie in [something]","stand on [something]","stand in [something]","climb in [something]","climb into [something]","climb on [something]","climb onto [something]"],messages:{no_target:"Enter what?",not_enterable:"{You} {can't} enter {place}.",already_inside:"{You're} already in {place}.",container_closed:"{container} is closed.",too_full:"{place} is full (maximum {max} occupants).",entered:"{You} {get} into {place}.",entered_on:"{You} {get} onto {place}.",cant_enter:"{You} {can't} enter {place}: {reason}.",not_here:"{You} {don't} see {place} here.",too_small:"{place} is too small for {you} to enter.",occupied:"{place} is already occupied."},help:{description:"Enter containers, vehicles, or furniture that can hold you.",examples:"enter car, get in box, sit on chair, board ship",summary:"ENTER/GET IN - Enter containers, vehicles, or furniture that can hold you. Example: ENTER CAR"}}});var hC=p(NE=>{"use strict";Object.defineProperty(NE,"__esModule",{value:!0});NE.exitingLanguage=void 0;NE.exitingLanguage={actionId:"if.action.exiting",patterns:["exit","get out","get off","go out","go outside","leave","dismount","stand","stand up","climb out","climb off","disembark","alight"],messages:{already_outside:"{You're} not inside anything.",container_closed:"{container} is closed.",cant_exit:"{You} {can't} exit {place}.",exited:"{You} {get} out of {place}.",exited_from:"{You} {get} {preposition} {place}.",nowhere_to_go:"There's nowhere to go from here.",exit_blocked:"The way out is blocked.",must_stand_first:"{You}'ll need to stand up first."},help:{description:"Exit from containers, vehicles, or furniture you are inside.",examples:"exit, get out, leave, stand up",summary:"EXIT/LEAVE/GET OUT - Exit from containers, vehicles, or furniture you are inside. Example: EXIT"}}});var yC=p(DE=>{"use strict";Object.defineProperty(DE,"__esModule",{value:!0});DE.climbingLanguage=void 0;DE.climbingLanguage={actionId:"if.action.climbing",patterns:["climb","climb [something]","climb up","climb down","climb up [something]","climb down [something]","climb on [something]","climb onto [something]","climb over [something]","scale [something]","ascend","ascend [something]","descend","descend [something]","scramble up [something]","clamber up [something]","shin up [something]"],messages:{no_target:"What do {you} want to climb?",not_climbable:"{You} {can't} climb {object}.",cant_go_that_way:"{You} {can't} climb {direction} from here.",climbed_up:"{You} {climb} up.",climbed_down:"{You} {climb} down.",climbed_onto:"{You} {climb} onto {object}.",already_there:"{You're} already on {place}.",too_high:"That's too high to climb.",too_dangerous:"That looks too dangerous to climb.",need_equipment:"{You}'d need climbing equipment for that.",too_slippery:"It's too slippery to climb.",nothing_to_climb:"There's nothing to climb here."},help:{description:"Climb objects or move in vertical directions.",examples:"climb tree, climb up, climb down, climb ladder",summary:"CLIMB - Climb objects or move in vertical directions. Example: CLIMB LADDER"}}});var TC=p(LE=>{"use strict";Object.defineProperty(LE,"__esModule",{value:!0});LE.searchingLanguage=void 0;LE.searchingLanguage={actionId:"if.action.searching",patterns:["search [something]","look in [something]","look inside [something]","look through [something]","rummage [something]","rummage in [something]","rummage through [something]","examine [something] closely"],messages:{not_visible:"{You} {can't} see {target} to search it.",not_reachable:"{You} {can't} reach {target} to search it.",container_closed:"{target} is closed.",nothing_special:"{You} {find} nothing of interest.",found_items:"{You} {discover}: {items}.",empty_container:"{target} is empty.",container_contents:"In {target} {you} {see}: {items}.",supporter_contents:"On {target} {you} {see}: {items}.",searched_location:"{You} {search} around carefully.",searched_object:"{You} {search} {target} thoroughly.",found_concealed:"Hidden {where}, {you} {discover}: {items}."},help:{description:"Search objects or locations for hidden items or additional details.",examples:"search desk, look in drawer, rummage through bag, examine closely",summary:"SEARCH/LOOK IN - Search objects or locations for hidden items or additional details. Example: SEARCH DESK"}}});var EC=p(ME=>{"use strict";Object.defineProperty(ME,"__esModule",{value:!0});ME.listeningLanguage=void 0;ME.listeningLanguage={actionId:"if.action.listening",patterns:["listen","listen to [something]","hear [something]"],messages:{not_visible:"{You} {can't} see {target} well enough to focus on its sounds.",silence:"{You} {hear} nothing out of the ordinary.",ambient_sounds:"{You} {hear} the usual ambient sounds.",active_devices:"{You} can {hear} {devices} operating nearby.",no_sound:"{target} isn't making any sound.",device_running:"{target} is making a soft humming sound.",device_off:"{target} is silent.",container_sounds:"{You} {hear} faint sounds from inside {target}.",liquid_sounds:"{You} {hear} liquid sloshing in {target}.",listened_to:"{You} {listen} carefully to {target}.",listened_environment:"{You} {listen} carefully."},help:{description:"Listen for sounds in the environment or from specific objects.",examples:"listen, listen to radio, hear",summary:"LISTEN - Listen for sounds in the environment or from specific objects. Example: LISTEN TO RADIO"}}});var vC=p(PE=>{"use strict";Object.defineProperty(PE,"__esModule",{value:!0});PE.smellingLanguage=void 0;PE.smellingLanguage={actionId:"if.action.smelling",patterns:["smell","smell [something]","sniff [something]","sniff","inhale"],messages:{not_visible:"{You} {can't} see {target} to smell it.",too_far:"{target} is too far away to smell.",no_scent:"{You} {don't} smell anything unusual.",room_scents:"The air carries various scents.",food_nearby:"{You} {smell} food nearby.",smoke_detected:"{You} {detect} a faint smell of smoke.",no_particular_scent:"{target} has no particular smell.",food_scent:"{target} smells delicious.",drink_scent:"{target} has a pleasant aroma.",burning_scent:"{target} gives off a smoky smell.",container_food_scent:"{You} {smell} food inside {target}.",musty_scent:"{target} smells a bit musty.",fresh_scent:"{target} smells fresh and clean.",smelled:"{You} {smell} {target}.",smelled_environment:"{You} {sniff} the air."},help:{description:"Smell objects or detect scents in your current location.",examples:"smell, smell flower, sniff wine, inhale",summary:"SMELL/SNIFF - Smell objects or detect scents in your current location. Example: SMELL FLOWER"}}});var _C=p(kE=>{"use strict";Object.defineProperty(kE,"__esModule",{value:!0});kE.touchingLanguage=void 0;kE.touchingLanguage={actionId:"if.action.touching",patterns:["touch [something]","feel [something]","pat [something]","stroke [something]","poke [something]","prod [something]"],messages:{no_target:"Touch what?",not_visible:"{You} {can't} see {target} to touch it.",not_reachable:"{You} {can't} reach {target}.",feels_normal:"{target} feels as {you}'d expect.",feels_warm:"{target} feels warm to the touch.",feels_hot:"{target} is hot! {You} {pull} {your} hand back quickly.",feels_cold:"{target} feels cold.",feels_soft:"{target} feels soft.",feels_hard:"{target} feels hard and solid.",feels_smooth:"{target} feels smooth.",feels_rough:"{target} feels rough.",feels_wet:"{target} feels damp.",device_vibrating:"{target} is vibrating slightly.",immovable_object:"{target} is solid and immovable.",liquid_container:"{You} {feel} liquid sloshing inside {target}.",touched:"{You} {touch} {target}.",touched_gently:"{You} gently {touch} {target}.",poked:"{You} {poke} {target}.",prodded:"{You} {prod} {target}.",patted:"{You} {pat} {target}.",stroked:"{You} {stroke} {target}."},help:{description:"Touch objects to discover their texture, temperature, or other tactile properties.",examples:"touch wall, feel fabric, pat dog, poke button",summary:"TOUCH/FEEL - Touch objects to discover their texture, temperature, or other tactile properties. Example: TOUCH STONE"}}});var bC=p(BE=>{"use strict";Object.defineProperty(BE,"__esModule",{value:!0});BE.readingLanguage=void 0;BE.readingLanguage={actionId:"if.action.reading",patterns:["read [something]","peruse [something]"],messages:{what_to_read:"What do you want to read?",not_readable:"There's nothing written on {item}.",cannot_read_now:"{reason}",read_text:`{cap:item} reads:
{text}`,read_book:`{cap:item} reads:
{text}`,read_book_page:`{cap:item} (page {currentPage} of {totalPages}):
{text}`,read_sign:`{cap:item} says:
{text}`,read_inscription:`{cap:item} reads:
{text}`},help:{description:"Read text written on objects.",examples:"read book, read sign, read leaflet",summary:"READ - Read text on books, signs, notes, and inscriptions. Example: READ BOOK"}}});var IC=p(xE=>{"use strict";Object.defineProperty(xE,"__esModule",{value:!0});xE.switchingOnLanguage=void 0;xE.switchingOnLanguage={actionId:"if.action.switching_on",patterns:["switch on [something]","switch [something] on","turn on [something]","turn [something] on","activate [something]","start [something]","power on [something]","power [something] on"],messages:{no_target:"Switch on what?",not_visible:"{You} {can't} see {target}.",not_reachable:"{You} {can't} reach {target}.",not_switchable:"{target} isn't something {you} can switch on.",already_on:"{target} is already on.",no_power:"{target} has no power source.",switched_on:"{You} {switch} on {target}.",light_on:"{You} {switch} on {target}, illuminating the area.",device_humming:"{target} hums to life.",temporary_activation:"{target} switches on temporarily.",with_sound:"{You} {switch} on {target}. {sound}",door_opens:"{target} switches on and opens.",illuminates_darkness:"{the:cap:target} switches on, banishing the darkness."},help:{description:"Turn on devices, lights, and other switchable objects.",examples:"turn on lamp, switch radio on, activate machine, start engine",summary:"TURN ON/SWITCH ON - Turn on devices, lights, and other switchable objects. Example: TURN ON LAMP"}}});var OC=p(jE=>{"use strict";Object.defineProperty(jE,"__esModule",{value:!0});jE.switchingOffLanguage=void 0;jE.switchingOffLanguage={actionId:"if.action.switching_off",patterns:["switch off [something]","switch [something] off","turn off [something]","turn [something] off","deactivate [something]","stop [something]","power off [something]","power [something] off"],messages:{no_target:"Switch off what?",not_visible:"{You} {can't} see {target}.",not_reachable:"{You} {can't} reach {target}.",not_switchable:"{target} isn't something {you} can switch off.",already_off:"{target} is already off.",switched_off:"{You} {switch} off {target}.",light_off:"{You} {switch} off {target}, plunging the area into darkness.",light_off_still_lit:"{You} {switch} off {target}.",device_stops:"{target} powers down with a soft whir.",silence_falls:"{You} {switch} off {target}. Silence falls.",with_sound:"{You} {switch} off {target}. {sound}",door_closes:"{target} switches off and closes.",was_temporary:"{target} switches off (it had {remainingTime} seconds left)."},help:{description:"Turn off devices, lights, and other switchable objects.",examples:"turn off lamp, switch radio off, deactivate alarm, stop machine",summary:"TURN OFF/SWITCH OFF - Turn off devices, lights, and other switchable objects. Example: TURN OFF RADIO"}}});var SC=p(WE=>{"use strict";Object.defineProperty(WE,"__esModule",{value:!0});WE.pushingLanguage=void 0;WE.pushingLanguage={actionId:"if.action.pushing",patterns:["push [something]","push [something] [direction]","press [something]","shove [something]","shove [something] [direction]","move [something]","move [something] [direction]"],messages:{no_target:"Push what?",not_visible:"{You} {can't} see {target}.",not_reachable:"{You} {can't} reach {target}.",too_heavy:"{target} is far too heavy to push (weighs {weight}kg).",wearing_it:"{You} {can't} push {target} while wearing it.",button_pushed:"{You} {push} {target}.",button_clicks:"{You} {press} {target}. Click!",switch_toggled:"{You} {push} {target}, toggling it {newState}.",pushed_direction:"{You} {push} {target} {direction}.",pushed_nudged:"{You} {give} {target} a push, but it doesn't move far.",pushed_with_effort:"With considerable effort, {you} {push} {target} {direction}.",reveals_passage:"As {you} {push} {target} {direction}, it slides aside, revealing a hidden passage!",wont_budge:"{target} won't budge.",pushing_does_nothing:"Pushing {target} has no effect.",fixed_in_place:"{target} is fixed in place."},help:{description:"Push objects, press buttons, or move heavy items.",examples:"push button, push boulder north, press switch, shove crate",summary:"PUSH/PRESS - Push objects, press buttons, or move heavy items. Example: PUSH BUTTON"}}});var AC=p(UE=>{"use strict";Object.defineProperty(UE,"__esModule",{value:!0});UE.pullingLanguage=void 0;UE.pullingLanguage={actionId:"if.action.pulling",patterns:["pull [something]","pull [something] [direction]","tug [something]","tug on [something]","drag [something]","drag [something] [direction]","yank [something]","draw [something]"],messages:{no_target:"Pull what?",not_visible:"{You} {can't} see {target}.",not_reachable:"{You} {can't} reach {target}.",too_heavy:"{target} is too heavy to pull (weighs {weight}kg).",wearing_it:"{You} {can't} pull {target} while wearing it.",wont_budge:"{target} won't budge.",lever_pulled:"{You} {pull} {target}.",lever_clicks:"{You} {pull} {target} with a satisfying click.",lever_toggled:"{You} {pull} {target}, switching it {newState}.",cord_pulled:"{You} {pull} {target}.",bell_rings:"{You} {pull} {target}. A bell rings somewhere!",cord_activates:"{You} {give} {target} a firm tug.",comes_loose:"{You} {pull} {target} and it comes loose!",firmly_attached:"{You} {pull} {target}, but it's firmly attached.",tugging_useless:"Tugging on {target} accomplishes nothing.",pulled_direction:"{You} {pull} {target} {direction}.",pulled_nudged:"{You} {tug} at {target}, moving it slightly.",pulled_with_effort:"With effort, {you} {drag} {target} {direction}.",pulling_does_nothing:"Pulling {target} has no effect.",fixed_in_place:"{target} is fixed in place."},help:{description:"Pull objects, levers, cords, or drag heavy items.",examples:"pull lever, pull cord, drag chest south, tug rope, yank chain",summary:"PULL/DRAG - Pull objects, levers, cords, or drag heavy items. Example: PULL LEVER"}}});var RC=p(HE=>{"use strict";Object.defineProperty(HE,"__esModule",{value:!0});HE.turningLanguage=void 0;HE.turningLanguage={actionId:"if.action.turning",patterns:["turn [something]","turn [something] [direction]","turn [something] to [setting]","rotate [something]","rotate [something] [direction]","twist [something]","twist [something] [direction]","spin [something]","dial [something]","dial [something] to [setting]","crank [something]"],messages:{no_target:"Turn what?",not_visible:"{You} {can't} see {target}.",not_reachable:"{You} {can't} reach {target}.",wearing_it:"{You} {can't} turn {target} while wearing it.",cant_turn_that:"{target} isn't something {you} can turn.",dial_turned:"{You} {turn} {target}.",dial_set:"{You} {turn} {target} to {setting}.",dial_adjusted:"{You} {adjust} {target} {direction}.",knob_turned:"{You} {turn} {target}.",knob_clicks:"{You} {turn} {target} with a click.",knob_toggled:"{You} {turn} {target}, switching it {newState}.",wheel_turned:"{You} {turn} {target}.",crank_turned:"{You} {crank} {target}.",mechanism_grinds:"{You} {turn} {target}. Gears grind and machinery moves.",requires_more_turns:"{You} {turn} {target}. It seems to need more turning.",mechanism_activated:"As {you} {turn} {target}, {you} {hear} machinery activate!",valve_opened:"{You} {turn} {target}, opening the valve.",valve_closed:"{You} {turn} {target}, closing the valve.",flow_changes:"{You} {turn} {target}, adjusting the flow.",key_needs_lock:"{You} {need} to put {target} in a lock first.",key_turned:"{You} {turn} {target} in the lock.",turned:"{You} {turn} {target}.",rotated:"{You} {rotate} {target}.",spun:"{You} {spin} {target}.",nothing_happens:"{You} {turn} {target}, but nothing happens."},help:{description:"Turn dials, knobs, wheels, cranks, or keys to operate mechanisms.",examples:"turn dial to 11, rotate wheel clockwise, twist knob left, crank handle",summary:"TURN/ROTATE - Turn dials, knobs, wheels, cranks, or keys to operate mechanisms. Example: TURN DIAL TO 5"}}});var CC=p(qE=>{"use strict";Object.defineProperty(qE,"__esModule",{value:!0});qE.loweringLanguage=void 0;qE.loweringLanguage={actionId:"if.action.lowering",patterns:["lower [something]"],messages:{"if.lower.no_target":"Lower what?","if.lower.cant_lower_that":"{You} {can't} lower {target}.","if.lower.already_down":"That's already lowered.","if.lower.lowered":"{You} {lower} {target}."},help:{description:"Lower something that can be lowered.",examples:"lower basket, lower drawbridge, lower blinds",summary:"LOWER - Lower objects like baskets, drawbridges, or blinds. Example: LOWER BASKET"}}});var wC=p(GE=>{"use strict";Object.defineProperty(GE,"__esModule",{value:!0});GE.raisingLanguage=void 0;GE.raisingLanguage={actionId:"if.action.raising",patterns:["raise [something]","lift [something]"],messages:{"if.raise.no_target":"Raise what?","if.raise.cant_raise_that":"{You} {can't} raise {target}.","if.raise.already_up":"That's already raised.","if.raise.raised":"{You} {raise} {target}."},help:{description:"Raise or lift something.",examples:"raise basket, raise drawbridge, lift blinds",summary:"RAISE/LIFT - Raise or lift objects like baskets or drawbridges. Example: RAISE BASKET"}}});var NC=p(FE=>{"use strict";Object.defineProperty(FE,"__esModule",{value:!0});FE.givingLanguage=void 0;FE.givingLanguage={actionId:"if.action.giving",patterns:["give [something] to [someone]","give [someone] [something]","offer [something] to [someone]","offer [someone] [something]","hand [something] to [someone]","hand [someone] [something]","present [something] to [someone]","present [someone] [something]"],messages:{no_item:"Give what?",no_recipient:"Give it to whom?",not_holding:"{You} aren't holding {item}.",recipient_not_visible:"{You} {can't} see {recipient}.",recipient_not_reachable:"{recipient} is too far away.",not_actor:"{You} can only give things to people.",self:"{You} already {have} {item}!",inventory_full:`{recipient} says, "I can't carry any more."`,too_heavy:`{recipient} says, "That's too heavy for me."`,not_interested:"{recipient} doesn't seem interested in {item}.",refuses:"{recipient} politely declines.",given:"{You} {give} {item} to {recipient}.",accepts:"{recipient} accepts {item}.",gratefully_accepts:"{recipient} gratefully accepts {item}.",reluctantly_accepts:"{recipient} reluctantly takes {item}."},help:{description:"Give objects to other characters.",examples:"give sword to knight, give Bob the key, offer flower to princess",summary:"GIVE TO - Give objects to other characters. Example: GIVE FLOWER TO ALICE"}}});var DC=p(VE=>{"use strict";Object.defineProperty(VE,"__esModule",{value:!0});VE.showingLanguage=void 0;VE.showingLanguage={actionId:"if.action.showing",patterns:["show [something] to [someone]","show [someone] [something]","display [something] to [someone]","reveal [something] to [someone]","present [something] to [someone]"],messages:{no_item:"Show what?",no_viewer:"Show it to whom?",not_carrying:"{You} aren't carrying {item}.",viewer_not_visible:"{You} {can't} see {viewer}.",viewer_too_far:"{viewer} is too far away to see clearly.",not_actor:"{You} can only show things to people.",self:"{You} {examine} {item} closely.",shown:"{You} {show} {item} to {viewer}.",viewer_examines:"{viewer} examines {item} carefully.",viewer_nods:"{viewer} nods.",viewer_impressed:"{viewer} looks impressed.",viewer_unimpressed:"{viewer} seems unimpressed.",viewer_recognizes:"{viewer} recognizes {item}!",wearing_shown:"{You} {show} {viewer} that {you're} wearing {item}."},help:{description:"Show objects to other characters without giving them away.",examples:"show badge to guard, show merchant the gem, display painting to curator",summary:"SHOW TO - Show objects to other characters. Example: SHOW BADGE TO GUARD"}}});var LC=p(YE=>{"use strict";Object.defineProperty(YE,"__esModule",{value:!0});YE.talkingLanguage=void 0;YE.talkingLanguage={actionId:"if.action.talking",patterns:["talk to [someone]","talk [someone]","speak to [someone]","speak with [someone]","greet [someone]","say hello to [someone]","chat with [someone]"],messages:{no_target:"Talk to whom?",not_visible:"{You} {can't} see {target}.",too_far:"{target} is too far away for conversation.",not_actor:"{You} can only talk to people.",self:"Talking to {yourself} is a sign of madness.",not_available:"{target} doesn't want to talk right now.",talked:"{You} {greet} {target}.",no_response:"{target} doesn't respond.",acknowledges:"{target} acknowledges {you}.",first_meeting:"{You} {introduce} {yourself} to {target}.",greets_back:'{target} says, "Hello there!"',formal_greeting:'{target} says, "Good day to you."',casual_greeting:'{target} says, "Hey!"',greets_again:'{target} says, "Hello again."',remembers_you:`{target} says, "Ah, it's you again."`,friendly_greeting:"{target} smiles in recognition.",has_topics:"{target} seems willing to discuss various topics.",nothing_to_say:"{target} has nothing particular to say."},help:{description:"Start a conversation with another character.",examples:"talk to guard, greet merchant, speak with wizard, chat with innkeeper",summary:"TALK TO - Start a conversation with another character. Example: TALK TO MERCHANT"}}});var MC=p(zE=>{"use strict";Object.defineProperty(zE,"__esModule",{value:!0});zE.askingLanguage=void 0;zE.askingLanguage={actionId:"if.action.asking",patterns:["ask [someone] about [topic]","ask [someone] for [topic]","question [someone] about [topic]","inquire [someone] about [topic]","query [someone] about [topic]"],messages:{no_target:"Ask whom?",no_topic:"Ask about what?",not_visible:"{You} {can't} see {target}.",too_far:"{target} is too far away.",not_actor:"{You} can only ask questions of people.",unknown_topic:`{target} says, "I don't know anything about that."`,shrugs:"{target} shrugs.",no_idea:`{target} says, "No idea what you're talking about."`,confused:"{target} looks confused.",responds:"{target} tells you about {topic}.",explains:"{target} explains about {topic}.",already_told:'{target} says, "I already told you about that."',remembers:'{target} says, "Ah yes, about {topic}..."',not_yet:`{target} says, "I can't tell you about that yet."`,must_do_first:`{target} says, "There's something you need to do first."`,earned_trust:`{target} says, "Since you've proven yourself, I'll tell you..."`},help:{description:"Ask characters about specific topics to gather information.",examples:"ask guard about castle, ask wizard about magic, question merchant about prices",summary:"ASK ABOUT - Ask characters about specific topics to gather information. Example: ASK GUARD ABOUT CASTLE"}}});var PC=p(KE=>{"use strict";Object.defineProperty(KE,"__esModule",{value:!0});KE.tellingLanguage=void 0;KE.tellingLanguage={actionId:"if.action.telling",patterns:["tell [someone] about [topic]","inform [someone] about [topic]","notify [someone] about [topic]","say [topic] to [someone]"],messages:{no_target:"Tell whom?",no_topic:"Tell them about what?",not_visible:"{You} {can't} see {target}.",too_far:"{target} is too far away.",not_actor:"{You} can only tell things to people.",told:"{You} {tell} {target} about {topic}.",informed:"{You} {inform} {target} about {topic}.",interested:"{target} listens with interest.",very_interested:'{target} says, "Really? Tell me more!"',grateful:'{target} says, "Thank you for telling me!"',already_knew:`{target} says, "Yes, I'm aware of that."`,not_interested:"{target} doesn't seem interested.",bored:"{target} looks bored.",dismissive:'{target} says, "So what?"',ignores:"{target} ignores what {you're} saying."},help:{description:"Tell characters about topics or give them information.",examples:"tell guard about thief, inform king about danger, notify wizard about discovery",summary:"TELL ABOUT - Tell characters about topics or give them information. Example: TELL ALICE ABOUT KEY"}}});var kC=p($E=>{"use strict";Object.defineProperty($E,"__esModule",{value:!0});$E.answeringLanguage=void 0;$E.answeringLanguage={actionId:"if.action.answering",patterns:["answer [response]","reply [response]","respond [response]","say yes","say no","yes","no"],messages:{no_question:"There's nothing to answer.",no_one_asked:"No one asked {you} anything.",too_late:"It's too late to answer that.",answered:'{You} {answer}, "{response}"',answered_yes:'{You} {say}, "Yes."',answered_no:'{You} {say}, "No."',gave_answer:"{You} {respond} to the question.",accepted:"{Your} answer is accepted.",rejected:"{Your} answer is not what they wanted to hear.",noted:"{Your} response is noted.",confused_by_answer:"{Your} answer seems to confuse them.",invalid_response:"That's not a valid answer to the question.",needs_yes_or_no:"Please answer yes or no.",unclear_answer:"{Your} answer isn't clear. Try again."},help:{description:"Answer questions that have been asked of you.",examples:'answer yes, say no, reply "the password is xyzzy", yes',summary:"ANSWER/SAY - Answer questions that have been asked of you. Example: SAY YES"}}});var BC=p(QE=>{"use strict";Object.defineProperty(QE,"__esModule",{value:!0});QE.throwingLanguage=void 0;QE.throwingLanguage={actionId:"if.action.throwing",patterns:["throw [something]","throw [something] at [target]","throw [something] to [target]","throw [something] [direction]","hurl [something]","hurl [something] at [target]","toss [something]","toss [something] to [target]","chuck [something]","fling [something]","lob [something]"],messages:{no_item:"Throw what?",not_holding:"{You} aren't holding {item}.",target_not_visible:"{You} {can't} see {target}.",target_not_here:"{target} isn't here.",no_exit:"There's no exit {direction}.",too_heavy:"{item} is too heavy to throw far (weighs {weight}kg).",self:"{You} {can't} throw things at {yourself}.",thrown:"{You} {throw} {item}.",thrown_down:"{You} {toss} {item} to the ground.",thrown_gently:"{You} gently {toss} {item}.",thrown_at:"{You} {throw} {item} at {target}.",hits_target:"{You} {throw} {item} at {target}. It hits!",misses_target:"{You} {throw} {item} at {target}, but miss.",bounces_off:"{item} bounces off {target}.",lands_on:"{item} lands on {target}.",lands_in:"{item} lands in {target}.",thrown_direction:"{You} {throw} {item} {direction}.",sails_through:"{item} sails through the exit to the {direction}.",breaks_on_impact:"{item} shatters on impact!",breaks_against:"{item} smashes against {target}!",fragile_breaks:"The fragile {item} breaks into pieces.",target_ducks:"{target} ducks out of the way.",target_catches:"{target} catches {item}!",target_angry:"{target} doesn't appreciate being hit with {item}."},help:{description:"Throw objects at targets, in directions, or just drop them forcefully.",examples:"throw ball at window, throw rock north, toss coin to beggar, hurl spear at target",summary:"THROW AT - Throw objects at targets, in directions, or just drop them forcefully. Example: THROW ROCK AT WINDOW"}}});var xC=p(XE=>{"use strict";Object.defineProperty(XE,"__esModule",{value:!0});XE.usingLanguage=void 0;XE.usingLanguage={actionId:"if.action.using",patterns:["use [something]","use [something] with [target]","use [something] on [target]","operate [something]","employ [something]","utilize [something]","apply [something] to [target]"],messages:{no_target:"Use what?",not_visible:"{You} {can't} see {item}.",not_reachable:"{You} {can't} reach {item}.",target_not_visible:"{You} {can't} see {target}.",target_not_reachable:"{You} {can't} reach {target}.",nothing_to_use_with:"{You} {need} to specify what to use {item} with.",cant_use_together:"{You} {can't} use {item} with {target}.",device_used:"{You} {use} {item}.",device_activated:"{You} {activate} {item}.",device_toggled:"{You} {toggle} {item} {newState}.",tool_used:"{You} {use} {item} on {target}.",tool_applied:"{You} {apply} {item} to {target}.",tool_modifies:"Using {item} modifies {target}.",tool_fixes:"{You} {fix} {target} with {item}.",tool_breaks:"{You} {break} {target} with {item}.",consumed:"{You} {use} {item}.",potion_drunk:"{You} {drink} {item}.",medicine_taken:"{You} {take} {item}.",food_eaten:"{You} {eat} {item}.",key_used:"{You} {use} {item} on {target}.",unlocks:"{You} {unlock} {target} with {item}.",already_unlocked:"{target} is already unlocked.",wrong_key:"{item} doesn't fit {target}.",opens_item:"{You} {open} {item}.",reads_item:"{You} {read} {item}.",generic_use:"{You} {use} {item}.",nothing_happens:"Nothing obvious happens.",not_useful_here:"That doesn't seem useful here."},help:{description:"Use objects in various ways, or use one object with another.",examples:"use lamp, use key on door, use hammer with nail, apply bandage to wound",summary:"USE/OPERATE - Use objects in various ways, or use one object with another. Example: USE KEY ON DOOR"}}});var jC=p(ZE=>{"use strict";Object.defineProperty(ZE,"__esModule",{value:!0});ZE.eatingLanguage=void 0;ZE.eatingLanguage={actionId:"if.action.eating",patterns:["eat [something]","consume [something]","devour [something]","munch [something]","munch on [something]","nibble [something]","nibble on [something]","taste [something]"],messages:{no_item:"Eat what?",not_visible:"{You} {can't} see {item}.",not_reachable:"{You} {can't} reach {item}.",not_edible:"That's not something {you} can eat.",is_drink:"{You} should drink {item}, not eat it.",already_consumed:"There's nothing left of {item} to eat.",eaten:"{You} {eat} {item}.",eaten_all:"{You} {eat} all of {item}.",eaten_some:"{You} {eat} some of {item}.",eaten_portion:"{You} {eat} a portion of {item}.",delicious:"{You} {eat} {item}. Delicious!",tasty:"{You} {eat} {item}. It's quite tasty.",bland:"{You} {eat} {item}. It's rather bland.",awful:"{You} {eat} {item}. It tastes awful!",filling:"{You} {eat} {item}. That was filling.",still_hungry:"{You} {eat} {item}, but {you're} still hungry.",satisfying:"{You} {eat} {item}. Very satisfying!",poisonous:"{You} {eat} {item}. It tastes strange...",nibbled:"{You} {nibble} on {item}.",tasted:"{You} {taste} {item}.",devoured:"{You} {devour} {item} hungrily.",munched:"{You} {munch} on {item}."},help:{description:"Eat edible items to satisfy hunger or gain effects.",examples:"eat apple, consume bread, nibble cheese, taste soup",summary:"EAT - Eat edible items to satisfy hunger or gain effects. Example: EAT APPLE"}}});var WC=p(JE=>{"use strict";Object.defineProperty(JE,"__esModule",{value:!0});JE.drinkingLanguage=void 0;JE.drinkingLanguage={actionId:"if.action.drinking",patterns:["drink [something]","drink from [something]","sip [something]","sip from [something]","quaff [something]","imbibe [something]","swallow [something]"],messages:{no_item:"Drink what?",not_visible:"{You} {can't} see {item}.",not_reachable:"{You} {can't} reach {item}.",not_drinkable:"That's not something {you} can drink.",already_consumed:"There's nothing left to drink.",container_closed:"{You} {need} to open {item} first.",drunk:"{You} {drink} {item}.",drunk_all:"{You} {drink} all of {item}.",drunk_some:"{You} {drink} some of {item}.",drunk_from:"{You} {drink} from {item}.",refreshing:"{You} {drink} {item}. How refreshing!",satisfying:"{You} {drink} {item}. That hits the spot.",bitter:"{You} {drink} {item}. It's quite bitter.",sweet:"{You} {drink} {item}. It's sweet.",strong:"{You} {drink} {item}. It's strong!",thirst_quenched:"{You} {drink} {item}. {Your} thirst is quenched.",still_thirsty:"{You} {drink} {item}, but {you're} still thirsty.",magical_effects:"{You} {drink} {item}. {You} {feel} strange...",healing:"{You} {drink} {item}. {You} {feel} better!",from_container:"{You} {drink} the {liquidType} from {item}.",empty_now:"{You} {drink} the last of the {liquidType}.",some_remains:"{You} {drink} some {liquidType}. Some remains.",sipped:"{You} {take} a sip of {item}.",quaffed:"{You} {quaff} {item} heartily.",gulped:"{You} {gulp} down {item}."},help:{description:"Drink liquids to quench thirst or gain effects.",examples:"drink water, sip wine, drink from fountain, quaff potion",summary:"DRINK - Drink liquids to quench thirst or gain effects. Example: DRINK WATER"}}});var UC=p(ev=>{"use strict";Object.defineProperty(ev,"__esModule",{value:!0});ev.attackingLanguage=void 0;ev.attackingLanguage={actionId:"if.action.attacking",patterns:["attack [something]","attack [something] with [weapon]","hit [something]","hit [something] with [weapon]","strike [something]","strike [something] with [weapon]","fight [something]","kill [something]","break [something]","destroy [something]","smash [something]"],messages:{no_target:"Attack what?",not_visible:"{You} {can't} see {target}.",not_reachable:"{You} {can't} reach {target}.",self:"Violence against {yourself} isn't the answer.",not_holding_weapon:"{You} aren't holding {weapon}.",indestructible:"{target} is far too solid to damage.",need_weapon_to_damage:"{target} requires a weapon to damage.",wrong_weapon_type:"{target} can't be damaged with that type of weapon.",attack_ineffective:"{Your} attack has no effect on {target}.",already_dead:"{target} is already dead.",violence_not_the_answer:"Violence is not the answer.","combat.cannot_attack":"{You} {can't} attack {targetName}.","combat.already_dead":"{targetName} is already dead.","combat.not_hostile":"{targetName} isn't hostile.","combat.no_target":"Attack what?","combat.target_unconscious":"{targetName} is already unconscious.","combat.need_weapon":"{You} {need} a weapon to attack effectively.","combat.attack.missed":"{You} {swing} at {targetName} but miss!","combat.attack.hit":"{You} {hit} {targetName} for {damage} damage.","combat.attack.hit_light":"{You} {graze} {targetName}, doing {damage} damage.","combat.attack.hit_heavy":"{You} {land} a solid blow on {targetName}, dealing {damage} damage!","combat.attack.knocked_out":"{targetName} collapses, unconscious!","combat.attack.killed":"{You} {have} slain {targetName}!","combat.defend.blocked":"{targetName} blocks {your} attack!","combat.defend.parried":"{targetName} parries {your} attack!","combat.defend.dodged":"{targetName} dodges out of the way!","combat.health.healthy":"{targetName} appears uninjured.","combat.health.wounded":"{targetName} has been wounded.","combat.health.badly_wounded":"{targetName} is badly wounded.","combat.health.near_death":"{targetName} is barely clinging to life!","combat.health.unconscious":"{targetName} lies unconscious.","combat.health.dead":"{targetName} is dead.","combat.special.sword_glows":"{Your} sword glows brightly!","combat.special.sword_stops_glowing":"{Your} sword's glow fades.","combat.special.blessed_weapon":"{Your} blessed weapon burns the undead!","combat.started":"Combat has begun!","combat.ended":"The battle is over.","combat.player_died":"{You} {have} been slain!","combat.player_resurrected":"{You} {feel} life return to {your} body.",attacked:"{You} {attack} {target}.",attacked_with:"{You} {attack} {target} with {weapon}.",hit_target:"{You} {hit} {target}.",hit_blindly:"{You} {swing} wildly, hitting nothing.",hit_with:"{You} {hit} {target} with {weapon}.",struck:"{You} {strike} {target}!",struck_with:"{You} {strike} {target} with {weapon}!",punched:"{You} {punch} {target}.",kicked:"{You} {kick} {target}.",unarmed_attack:"{You} {attack} {target} with {your} bare hands.",target_broke:"{target} breaks!",target_shattered:"{target} shatters into pieces!",broke:"{You} {break} {target}!",smashed:"{You} {smash} {target} to pieces!",target_destroyed:"{target} is utterly destroyed!",destroyed:"{You} {destroy} {target}!",shattered:"{target} shatters!",target_damaged:"{target} shows signs of damage. ({damage} damage dealt)",killed_target:"{You} {have} defeated {target}!",killed_blindly:"Something dies in the darkness.",items_spilled:"{target}'s possessions spill onto the ground.",passage_revealed:"A hidden passage is revealed!",debris_created:"Debris from {target} litters the area.",defends:"{target} defends against {your} attack.",dodges:"{target} dodges {your} attack.",retaliates:"{target} fights back!",flees:"{target} flees from {you}!",peaceful_solution:"Violence isn't necessary here.",no_fighting:"Fighting won't solve this problem.",unnecessary_violence:"That seems unnecessarily violent."},help:{description:"Attack creatures or attempt to break objects.",examples:"attack troll, hit goblin with sword, break window, smash vase",summary:"ATTACK/HIT/FIGHT - Attack creatures or attempt to break objects. Example: ATTACK TROLL"}}});var HC=p(tv=>{"use strict";Object.defineProperty(tv,"__esModule",{value:!0});tv.waitingLanguage=void 0;tv.waitingLanguage={actionId:"if.action.waiting",patterns:["wait","z"],messages:{waited:"Time passes.",waited_patiently:"{You} {wait} patiently.",time_passes:"Time passes...",nothing_happens:"{You} {wait}. Nothing happens.",waited_in_vehicle:"{You} {wait} in {vehicle}.",waited_for_event:"{You} {wait} for something to happen.",waited_anxiously:"{You} {wait} anxiously.",waited_briefly:"{You} {wait} for a moment.",something_approaches:"As {you} {wait}, {you} {hear} something approaching.",time_runs_out:"{You}'ve waited too long!",patience_rewarded:"{Your} patience is rewarded.",grows_restless:"{You} {grow} restless from waiting."},help:{description:"Wait for time to pass without doing anything.",examples:"wait, z",summary:"WAIT/Z - Wait for time to pass without doing anything. Example: Z"}}});var qC=p(rv=>{"use strict";Object.defineProperty(rv,"__esModule",{value:!0});rv.sleepingLanguage=void 0;rv.sleepingLanguage={actionId:"if.action.sleeping",patterns:["sleep","nap","doze","rest","slumber","z"],messages:{slept:"{You} {sleep} for a while.",dozed_off:"{You} {doze} off for a bit.",fell_asleep:"{You} {fall} into a deep sleep.",brief_nap:"{You} {take} a brief nap.",deep_sleep:"{You} {fall} into a deep, restful sleep.",slept_fitfully:"{You} {sleep} fitfully.",cant_sleep_here:"{You} {can't} sleep in {location}.",too_dangerous_to_sleep:"It's too dangerous to sleep in {location}.",already_well_rested:"{You're} already well-rested and don't feel tired.",woke_refreshed:"{You} {wake} feeling refreshed.",disturbed_sleep:"{Your} sleep is disturbed.",nightmares:"{You} {have} unsettling dreams.",peaceful_sleep:"{You} {enjoy} a peaceful sleep."},help:{description:"Sleep or take a nap to pass time.",examples:"sleep, nap, doze, rest",summary:"SLEEP/NAP - Sleep or take a nap to pass time. May have different effects depending on location and circumstances. Example: SLEEP"}}});var GC=p(bl=>{"use strict";Object.defineProperty(bl,"__esModule",{value:!0});bl.scoringSystemMessages=bl.scoringLanguage=void 0;bl.scoringLanguage={actionId:"if.action.scoring",patterns:["score","points"],messages:{no_scoring:"This isn't that kind of game.",scoring_not_enabled:"There is no score in this game.",score_display:"{You} {have} scored {score} out of a possible {maxScore}, in {moves} turns.",score_simple:"{Your} score is {score} points.",score_with_rank:"{You} {have} scored {score} out of {maxScore}, earning {you} the rank of {rank}.",perfect_score:"{You} {have} achieved a perfect score of {maxScore} points!",rank_novice:"{You} {are} ranked as a Novice adventurer.",rank_amateur:"{You} {are} ranked as an Amateur adventurer.",rank_proficient:"{You} {are} ranked as a Proficient adventurer.",rank_expert:"{You} {are} ranked as an Expert adventurer.",rank_master:"{You} {are} ranked as a Master adventurer!",with_achievements:"{You} {have} earned the following achievements: {achievements}.",no_achievements:"{You} {have}n't earned any special achievements yet.",early_game:"{You're} just getting started!",mid_game:"{You're} making good progress.",late_game:"{You're} nearing the end of {your} adventure.",game_complete:"{You} {have} completed the game!"},help:{description:"Display your current score and game progress.",examples:"score, points",summary:"SCORE - Display your current score and game progress. Example: SCORE"}};bl.scoringSystemMessages={"if.score.gained":"{Your} score just increased by {points} points.","if.score.lost":"{You} just lost {points} points!","if.score.display":"{You} {have} scored {score} out of {maxScore}, earning {you} the rank of {rank}.","if.score.no_scoring":"This isn't that kind of game.","if.rank.beginner":"Beginner","if.rank.novice":"Novice","if.rank.amateur":"Amateur","if.rank.experienced":"Experienced","if.rank.proficient":"Proficient","if.rank.expert":"Expert","if.rank.master":"Master","if.rank.winner":"Winner"}});var FC=p(nv=>{"use strict";Object.defineProperty(nv,"__esModule",{value:!0});nv.helpLanguage=void 0;nv.helpLanguage={actionId:"if.action.help",patterns:["help","help [topic]","?","commands","h"],messages:{general_help:`Welcome to Interactive Fiction!

Basic commands:
- LOOK (L): Examine your surroundings
- INVENTORY (I): List what you're carrying
- EXAMINE (X) [object]: Look at something closely
- TAKE/DROP [object]: Pick up or put down items
- GO [direction] or just [direction]: Move around

For more help on a specific topic, type HELP [topic].`,help_topic:"Help on {topic}:",unknown_topic:"No help available on '{topic}'. Type HELP for general help.",help_movement:`Movement commands:
- GO NORTH/SOUTH/EAST/WEST (or just N/S/E/W)
- UP/DOWN (U/D)
- IN/OUT
- ENTER [place]
- EXIT`,help_objects:`Object commands:
- TAKE/GET [object]
- DROP [object]
- EXAMINE/LOOK AT [object]
- OPEN/CLOSE [object]
- PUT [object] IN/ON [container]
- WEAR/REMOVE [clothing]`,help_special:`Special commands:
- SAVE/RESTORE: Save and load your game
- SCORE: Check your progress
- WAIT (Z): Let time pass
- AGAIN (G): Repeat last command
- QUIT: Exit the game`,first_time_help:`New to Interactive Fiction? Try these commands to get started:
- LOOK to see where you are
- INVENTORY to see what you're carrying
- EXAMINE interesting objects
- Go in compass directions (NORTH, SOUTH, etc.)`,hints_available:"Hints are available. Type HINTS to see them.",hints_disabled:"Hints are not available in this game.",stuck_help:`If you're stuck, try:
- LOOK around carefully
- EXAMINE everything
- Check your INVENTORY
- Try different verbs with objects`,help_footer:"For a complete list of commands, consult the game documentation."},help:{description:"Get help on game commands and topics.",examples:"help, ?, help movement, help take, commands",summary:"HELP - Get help on game commands and topics. Example: HELP MOVEMENT"}}});var VC=p(iv=>{"use strict";Object.defineProperty(iv,"__esModule",{value:!0});iv.aboutLanguage=void 0;iv.aboutLanguage={actionId:"if.action.about",patterns:["about","info","credits"],messages:{about_header:"About {title}",game_info:`{title}
Version {version}
By {author}
Released: {releaseDate}`,game_info_simple:"{title} by {author}",description:"Description: {description}",copyright:"Copyright {copyright}",license:"License: {license}",website:"Website: {website}",contact:"Contact: {contact}",credits_header:"Credits:",credits_list:"{credits}",special_thanks:"Special Thanks: {specialThanks}",dedication:"Dedication: {dedication}",acknowledgments:"Acknowledgments: {acknowledgments}",engine_info:"Powered by {engine} version {engineVersion}",technical_info:`Technical Information:
Engine: {engine} v{engineVersion}
Platform: Interactive Fiction`,play_stats:`Current Session:
Time played: {playTime}
Moves made: {sessionMoves}`,session_info:"You've been playing for {playTime} and made {sessionMoves} moves.",about_footer:"Thank you for playing!",enjoy_game:"We hope you enjoy playing {title}!",about_compact:"{title} v{version} by {author}"},help:{description:"Display information about the game, including credits and version.",examples:"about, info, credits",summary:"ABOUT/INFO - Display information about the game, including credits and version. Example: ABOUT"}}});var YC=p(ov=>{"use strict";Object.defineProperty(ov,"__esModule",{value:!0});ov.versionLanguage=void 0;ov.versionLanguage={actionId:"if.action.version",patterns:["version"],messages:{version_full:`{storyTitle} v{storyVersion}
Sharpee Engine v{engineVersion}
Built: {buildDate}`,version_no_date:`{storyTitle} v{storyVersion}
Sharpee Engine v{engineVersion}`,version_compact:"{storyTitle} v{storyVersion} (Sharpee v{engineVersion})"},help:{description:"Display version information about the game and engine.",examples:"version",summary:"VERSION - Display version information about the game and engine. Example: VERSION"}}});var zC=p(av=>{"use strict";Object.defineProperty(av,"__esModule",{value:!0});av.savingLanguage=void 0;av.savingLanguage={actionId:"if.action.saving",patterns:["save","save game","save [name]","save as [name]","store","store game"],messages:{game_saved:"Game saved.",game_saved_as:"Game saved as '{saveName}'.",save_successful:"{Your} game has been saved successfully.",save_slot:"Game saved to slot {saveName}.",overwrite_save:"Previous save '{saveName}' has been overwritten.",save_details:`Saved: {saveName}
Score: {score}
Moves: {moves}`,quick_save:"Quick save completed.",auto_save:"Auto-saving game...",save_failed:"Failed to save game.",no_save_slots:"No save slots available.",invalid_save_name:"'{saveName}' is not a valid save name.",save_not_allowed:"{You} cannot save the game at this time.",save_in_progress:"Another save is already in progress.",confirm_overwrite:"A save named '{saveName}' already exists. Overwrite it?",save_reminder:"Don't forget to save {your} game regularly!",saved_locally:"Game saved to local storage.",saved_to_cloud:"Game saved to cloud storage.",save_exported:"Save file exported successfully."},help:{description:"Save your current game progress.",examples:'save, save game, save mysave, save as "Chapter 2"',summary:"SAVE - Save your current game progress. Example: SAVE"}}});var KC=p(sv=>{"use strict";Object.defineProperty(sv,"__esModule",{value:!0});sv.restoringLanguage=void 0;sv.restoringLanguage={actionId:"if.action.restoring",patterns:["restore","restore [name]","load","load [name]","load game","restore game"],messages:{game_restored:"Game restored.",game_loaded:"Game loaded from '{saveName}'.",restore_successful:"{Your} saved game has been restored successfully.",welcome_back:"Welcome back! Game restored from {saveName}.",restore_details:`Restored: {saveName}
Score: {score}
Moves: {moves}`,quick_restore:"Quick restore completed.",resuming_game:"Resuming {your} adventure...",restore_failed:"Failed to restore game.",save_not_found:"No save named '{saveName}' was found.",no_saves:"No saved games found.",corrupt_save:"The save file '{saveName}' appears to be corrupted.",incompatible_save:"This save file is from a different version and cannot be loaded.",restore_not_allowed:"{You} cannot restore a game at this time.",confirm_restore:"Restore game from '{saveName}'? Current progress will be lost.",unsaved_progress:"{You} {have} unsaved progress. Restore anyway?",available_saves:"Available saves: {saves}",no_saves_available:"No saved games available.",choose_save:"Which save would {you} like to restore?",import_save:"Import a save file to restore.",save_imported:"Save file imported successfully."},help:{description:"Restore a previously saved game.",examples:'restore, load, restore mysave, load "Chapter 2"',summary:"RESTORE/LOAD - Restore a previously saved game. Example: RESTORE"}}});var $C=p(cv=>{"use strict";Object.defineProperty(cv,"__esModule",{value:!0});cv.quittingLanguage=void 0;cv.quittingLanguage={actionId:"if.action.quitting",patterns:["quit","exit","bye","goodbye","end","stop","quit game","end game"],messages:{quit_confirm_query:"Are {you} sure {you} want to quit?",quit_save_query:"Would {you} like to save before quitting?",quit_unsaved_query:"{You} {have} unsaved progress. What would {you} like to do?",quit_confirmed:`Thanks for playing!

Final score: {finalScore} out of {maxScore}
Moves: {moves}`,quit_cancelled:"Quit cancelled.",quit_and_saved:`Game saved.

Thanks for playing!

Final score: {finalScore} out of {maxScore}
Moves: {moves}`,final_score:"{Your} final score was {finalScore} out of {maxScore}.",final_stats:`Final Statistics:
Score: {finalScore}/{maxScore}
Moves: {moves}
Time played: {playTime}`,achievements_earned:"{You} earned {count} achievements during {your} play!"},queryOptions:{quit:"Quit",cancel:"Return to game",save_and_quit:"Save and quit",quit_without_saving:"Quit without saving"},help:{description:"Quit the game. You will be asked to confirm.",examples:"quit, exit, bye, goodbye",summary:"QUIT/EXIT - Quit the game with confirmation"}}});var QC=p(dv=>{"use strict";Object.defineProperty(dv,"__esModule",{value:!0});dv.undoingLanguage=void 0;dv.undoingLanguage={actionId:"if.action.undoing",patterns:["undo"],messages:{undo_success:"Previous turn undone.",undo_to_turn:"Undone. (Now at turn {turn})",undo_failed:"Undo failed.",nothing_to_undo:"Nothing to undo."},help:{description:"Undo the previous turn.",examples:"undo",summary:"UNDO - Undo the previous turn. Example: UNDO"}}});var XC=p(lv=>{"use strict";Object.defineProperty(lv,"__esModule",{value:!0});lv.againLanguage=void 0;lv.againLanguage={actionId:"if.action.again",patterns:["again","g"],messages:{nothing_to_repeat:"There is nothing to repeat."},help:{description:"Repeat the last command.",examples:"again, g",summary:"AGAIN (G) - Repeat the last command. Example: G"}}});var ZC=p(Q=>{"use strict";var bee=Q&&Q.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),ne=Q&&Q.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&bee(e,t,r)};Object.defineProperty(Q,"__esModule",{value:!0});Q.standardActionLanguage=void 0;ne(eC(),Q);ne(tC(),Q);ne(rC(),Q);ne(nC(),Q);ne(iC(),Q);ne(oC(),Q);ne(aC(),Q);ne(sC(),Q);ne(cC(),Q);ne(dC(),Q);ne(lC(),Q);ne(uC(),Q);ne(mC(),Q);ne(pC(),Q);ne(fC(),Q);ne(gC(),Q);ne(hC(),Q);ne(yC(),Q);ne(TC(),Q);ne(EC(),Q);ne(vC(),Q);ne(_C(),Q);ne(bC(),Q);ne(IC(),Q);ne(OC(),Q);ne(SC(),Q);ne(AC(),Q);ne(RC(),Q);ne(CC(),Q);ne(wC(),Q);ne(NC(),Q);ne(DC(),Q);ne(LC(),Q);ne(MC(),Q);ne(PC(),Q);ne(kC(),Q);ne(BC(),Q);ne(xC(),Q);ne(jC(),Q);ne(WC(),Q);ne(UC(),Q);ne(HC(),Q);ne(qC(),Q);ne(GC(),Q);ne(FC(),Q);ne(VC(),Q);ne(YC(),Q);ne(zC(),Q);ne(KC(),Q);ne($C(),Q);ne(QC(),Q);ne(XC(),Q);var Iee=eC(),Oee=tC(),See=rC(),Aee=nC(),Ree=iC(),Cee=oC(),wee=aC(),Nee=sC(),Dee=cC(),Lee=dC(),Mee=lC(),Pee=uC(),kee=mC(),Bee=pC(),xee=fC(),jee=gC(),Wee=hC(),Uee=yC(),Hee=TC(),qee=EC(),Gee=vC(),Fee=_C(),Vee=bC(),Yee=IC(),zee=OC(),Kee=SC(),$ee=AC(),Qee=RC(),Xee=CC(),Zee=wC(),Jee=NC(),ete=DC(),tte=LC(),rte=MC(),nte=PC(),ite=kC(),ote=BC(),ate=xC(),ste=jC(),cte=WC(),dte=UC(),lte=HC(),ute=qC(),mte=GC(),pte=FC(),fte=VC(),gte=YC(),hte=zC(),yte=KC(),Tte=$C(),Ete=QC(),vte=XC();Q.standardActionLanguage=[Iee.takingLanguage,Oee.droppingLanguage,See.lookingLanguage,Aee.inventoryLanguage,Ree.examiningLanguage,Cee.goingLanguage,wee.openingLanguage,Nee.closingLanguage,Dee.puttingLanguage,Lee.insertingLanguage,Mee.removingLanguage,Pee.wearingLanguage,kee.takingOffLanguage,Bee.lockingLanguage,xee.unlockingLanguage,jee.enteringLanguage,Wee.exitingLanguage,Uee.climbingLanguage,Hee.searchingLanguage,qee.listeningLanguage,Gee.smellingLanguage,Fee.touchingLanguage,Vee.readingLanguage,Yee.switchingOnLanguage,zee.switchingOffLanguage,Kee.pushingLanguage,$ee.pullingLanguage,Qee.turningLanguage,Xee.loweringLanguage,Zee.raisingLanguage,Jee.givingLanguage,ete.showingLanguage,tte.talkingLanguage,rte.askingLanguage,nte.tellingLanguage,ite.answeringLanguage,ote.throwingLanguage,ate.usingLanguage,ste.eatingLanguage,cte.drinkingLanguage,dte.attackingLanguage,lte.waitingLanguage,ute.sleepingLanguage,mte.scoringLanguage,pte.helpLanguage,fte.aboutLanguage,gte.versionLanguage,hte.savingLanguage,yte.restoringLanguage,Tte.quittingLanguage,Ete.undoingLanguage,vte.againLanguage]});var Tq=p(uv=>{"use strict";Object.defineProperty(uv,"__esModule",{value:!0});uv.npcLanguage=void 0;uv.npcLanguage={messages:{"npc.enters":"{npcName} enters from the {direction}.","npc.leaves":"{npcName} leaves to the {direction}.","npc.arrives":"{npcName} arrives.","npc.departs":"{npcName} departs.","npc.notices_player":"{npcName} notices you.","npc.ignores_player":"{npcName} ignores you.","npc.takes":"{npcName} picks up {itemName}.","npc.drops":"{npcName} drops {itemName}.","npc.follows":"{npcName} follows you.","npc.guard.blocks":"{npcName} blocks your way!","npc.guard.attacks":"{npcName} attacks you!","npc.guard.defeated":"{npcName} is no longer a threat.","npc.attacks":"{npcName} attacks you!","npc.misses":"{npcName} swings at you but misses!","npc.hits":"{npcName} hits you for {damage} damage!","npc.killed":"{npcName} has been slain.","npc.unconscious":"{npcName} collapses, unconscious.","npc.combat.attack.missed":"The troll swings his axe, but it misses.","npc.combat.attack.hit":"The axe gets you right in the side. Ouch!","npc.combat.attack.hit_light":"The flat of the troll's axe skins across your forearm.","npc.combat.attack.hit_heavy":"The troll hits you with a glancing blow, and you are momentarily stunned.","npc.combat.attack.knocked_out":"The flat of the troll's axe hits you delicately on the head, knocking you out.","npc.combat.attack.killed":"The troll lands a killing blow. You are dead.","npc.speaks":'{npcName} says, "{text}"',"npc.shouts":'{npcName} shouts, "{text}"',"npc.whispers":'{npcName} whispers, "{text}"',"npc.mutters":'{npcName} mutters, "{text}"',"npc.laughs":"{npcName} laughs.","npc.growls":"{npcName} growls menacingly.","npc.cries":"{npcName} cries.","npc.sighs":"{npcName} sighs.","npc.greets":"{npcName} greets you.","npc.farewell":"{npcName} bids you farewell.","npc.no_response":"{npcName} doesn't respond.","npc.confused":"{npcName} looks confused."}}});var JC=p(Vc=>{"use strict";var _te=Vc&&Vc.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),bte=Vc&&Vc.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&_te(e,t,r)};Object.defineProperty(Vc,"__esModule",{value:!0});bte(Tq(),Vc)});var Sq=p(Tr=>{"use strict";Object.defineProperty(Tr,"__esModule",{value:!0});Tr.DEFAULT_NARRATIVE_CONTEXT=Tr.PRONOUNS=void 0;Tr.conjugateVerb=Oq;Tr.resolvePerspectivePlaceholders=Ote;Tr.PRONOUNS={HE_HIM:{subject:"he",object:"him",possessive:"his",possessiveAdj:"his",reflexive:"himself",verbForm:"singular"},SHE_HER:{subject:"she",object:"her",possessive:"hers",possessiveAdj:"her",reflexive:"herself",verbForm:"singular"},THEY_THEM:{subject:"they",object:"them",possessive:"theirs",possessiveAdj:"their",reflexive:"themselves",verbForm:"plural"}};Tr.DEFAULT_NARRATIVE_CONTEXT={perspective:"2nd"};var gm={be:["are","is","are"],have:["have","has","have"],do:["do","does","do"],go:["go","goes","go"],can:["can","can","can"],"can't":["can't","can't","can't"],cannot:["cannot","cannot","cannot"],will:["will","will","will"],"won't":["won't","won't","won't"],would:["would","would","would"],"wouldn't":["wouldn't","wouldn't","wouldn't"],could:["could","could","could"],"couldn't":["couldn't","couldn't","couldn't"],should:["should","should","should"],"shouldn't":["shouldn't","shouldn't","shouldn't"],must:["must","must","must"],"mustn't":["mustn't","mustn't","mustn't"],may:["may","may","may"],might:["might","might","might"]};function Eq(t){switch(t.perspective){case"1st":return"I";case"2nd":return"You";case"3rd":let e=t.playerPronouns||Tr.PRONOUNS.THEY_THEM;return e.subject.charAt(0).toUpperCase()+e.subject.slice(1)}}function vq(t){switch(t.perspective){case"1st":return"my";case"2nd":return"your";case"3rd":return(t.playerPronouns||Tr.PRONOUNS.THEY_THEM).possessiveAdj}}function _q(t){switch(t.perspective){case"1st":return"mine";case"2nd":return"yours";case"3rd":return(t.playerPronouns||Tr.PRONOUNS.THEY_THEM).possessive}}function bq(t){switch(t.perspective){case"1st":return"myself";case"2nd":return"yourself";case"3rd":return(t.playerPronouns||Tr.PRONOUNS.THEY_THEM).reflexive}}function Iq(t){switch(t.perspective){case"1st":return"I'm";case"2nd":return"You're";case"3rd":let e=t.playerPronouns||Tr.PRONOUNS.THEY_THEM,r=e.subject.charAt(0).toUpperCase()+e.subject.slice(1);return e.verbForm==="plural"?`${r}'re`:`${r}'s`}}function Oq(t,e){let r=t.toLowerCase();if(e.perspective==="1st"||e.perspective==="2nd")return gm[r]?gm[r][0]:t;let i=(e.playerPronouns||Tr.PRONOUNS.THEY_THEM).verbForm==="plural";return gm[r]?i?gm[r][2]:gm[r][1]:i?t:Ite(t)}function Ite(t){let e=t.toLowerCase();if(e.endsWith("s")||e.endsWith("sh")||e.endsWith("ch")||e.endsWith("x")||e.endsWith("z")||e.endsWith("o"))return t+"es";if(e.endsWith("y")&&e.length>1){let r=e[e.length-2];if(!["a","e","i","o","u"].includes(r))return t.slice(0,-1)+"ies"}return t+"s"}function Ote(t,e=Tr.DEFAULT_NARRATIVE_CONTEXT){t=t.replace(/\{You\}/g,Eq(e)),t=t.replace(/\{you\}/g,Eq(e).toLowerCase()),t=t.replace(/\{Your\}/g,mv(vq(e))),t=t.replace(/\{your\}/g,vq(e)),t=t.replace(/\{Yours\}/g,mv(_q(e))),t=t.replace(/\{yours\}/g,_q(e)),t=t.replace(/\{Yourself\}/g,mv(bq(e))),t=t.replace(/\{yourself\}/g,bq(e)),t=t.replace(/\{You're\}/g,Iq(e)),t=t.replace(/\{you're\}/g,Iq(e).toLowerCase());let r=new Set(["item","target","container","direction","destination","surface","key","door","actor","recipient","object","room","count","score","turns","reason","message","the","a","an","text","description","name"]);return t=t.replace(/\{([a-z][a-z']*)\}/gi,(n,i)=>{let o=i.toLowerCase();if(r.has(o))return n;if([/^(take|get|drop|put|open|close|lock|unlock|give|show|wear|remove)$/i,/^(eat|drink|touch|smell|listen|look|examine|search|read|attack)$/i,/^(push|pull|turn|switch|climb|enter|exit|go|wait|sleep|wake)$/i,/^(lift|carry|hold|throw|catch|break|fix|use|try|need|want)$/i,/^(see|hear|feel|find|know|think|say|tell|ask|answer)$/i,/^(be|have|do|can|can't|will|won't|would|could|should|must|may|might)$/i,/^[a-z]+'t$/i,/^(respond|greet|introduce|swing|graze|land|punch|kick|smash|destroy|strike)$/i,/^(quaff|gulp|sip|nibble|taste|devour|munch|doze|fall|enjoy)$/i,/^(sniff|detect|discover|insert|adjust|lower|raise|tug|drag|press)$/i,/^(inform|grow|toss|poke|prod|pat|stroke|crank|rotate|spin)$/i,/^(toggle|apply|activate|greet|acknowledge)$/i].some(c=>c.test(o))){let c=Oq(i,e);return i[0]===i[0].toUpperCase()?mv(c):c}return n}),t}function mv(t){return t&&t.charAt(0).toUpperCase()+t.slice(1)}});var ew=p(Xi=>{"use strict";Object.defineProperty(Xi,"__esModule",{value:!0});Xi.resolvePerspectivePlaceholders=Xi.conjugateVerb=Xi.DEFAULT_NARRATIVE_CONTEXT=Xi.PRONOUNS=void 0;var pv=Sq();Object.defineProperty(Xi,"PRONOUNS",{enumerable:!0,get:function(){return pv.PRONOUNS}});Object.defineProperty(Xi,"DEFAULT_NARRATIVE_CONTEXT",{enumerable:!0,get:function(){return pv.DEFAULT_NARRATIVE_CONTEXT}});Object.defineProperty(Xi,"conjugateVerb",{enumerable:!0,get:function(){return pv.conjugateVerb}});Object.defineProperty(Xi,"resolvePerspectivePlaceholders",{enumerable:!0,get:function(){return pv.resolvePerspectivePlaceholders}})});var rw=p(Fr=>{"use strict";Object.defineProperty(Fr,"__esModule",{value:!0});Fr.yourFormatter=Fr.someFormatter=Fr.theFormatter=Fr.aFormatter=void 0;function Ste(t){if(!t||t.length===0)return"a";let e=t.toLowerCase();if(e.startsWith("hour")||e.startsWith("honest")||e.startsWith("heir"))return"an";if(e.startsWith("uni")||e.startsWith("one"))return"a";let r=e[0];return["a","e","i","o","u"].includes(r)?"an":"a"}function Ate(t){return typeof t=="string"?t:t.name}function tw(t){return typeof t=="string"?{name:t}:t}var Rte=(t,e)=>{if(Array.isArray(t))return t.map(o=>(0,Fr.aFormatter)(o,e)).join(", ");let r=tw(t),n=r.name;switch(r.nounType??(r.properName?"proper":"common")){case"proper":return n;case"mass":return`some ${n}`;case"unique":return`the ${n}`;case"plural":return n;default:return r.article&&r.article!=="a"&&r.article!=="an"?`${r.article} ${n}`:`${Ste(n)} ${n}`}};Fr.aFormatter=Rte;var Cte=(t,e)=>{if(Array.isArray(t))return t.map(o=>(0,Fr.theFormatter)(o,e)).join(", ");let r=tw(t),n=r.name;return(r.nounType??(r.properName?"proper":"common"))==="proper"?n:`the ${n}`};Fr.theFormatter=Cte;var wte=(t,e)=>{if(Array.isArray(t))return t.map(o=>(0,Fr.someFormatter)(o,e)).join(", ");let r=tw(t),n=r.name;return(r.nounType??(r.properName?"proper":"common"))==="proper"?n:`some ${n}`};Fr.someFormatter=wte;var Nte=(t,e)=>Array.isArray(t)?t.map(n=>(0,Fr.yourFormatter)(n,e)).join(", "):`your ${Ate(t)}`;Fr.yourFormatter=Nte});var nw=p(Zi=>{"use strict";Object.defineProperty(Zi,"__esModule",{value:!0});Zi.countFormatter=Zi.commaListFormatter=Zi.orListFormatter=Zi.listFormatter=void 0;function Aq(t){return typeof t=="string"?t:t.name}function fv(t){return Array.isArray(t)?t.map(e=>Aq(e)):[Aq(t)]}var Dte=(t,e)=>{let r=fv(t);if(r.length===0)return"";if(r.length===1)return r[0];if(r.length===2)return`${r[0]} and ${r[1]}`;let n=r.slice(0,-1),i=r[r.length-1];return`${n.join(", ")}, and ${i}`};Zi.listFormatter=Dte;var Lte=(t,e)=>{let r=fv(t);if(r.length===0)return"";if(r.length===1)return r[0];if(r.length===2)return`${r[0]} or ${r[1]}`;let n=r.slice(0,-1),i=r[r.length-1];return`${n.join(", ")}, or ${i}`};Zi.orListFormatter=Lte;var Mte=(t,e)=>fv(t).join(", ");Zi.commaListFormatter=Mte;var Pte=(t,e)=>{let r=fv(t),n=r.length;return n===0?"nothing":n===1?`1 ${r[0]}`:`${n} items`};Zi.countFormatter=Pte});var iw=p(Vr=>{"use strict";Object.defineProperty(Vr,"__esModule",{value:!0});Vr.titleFormatter=Vr.lowerFormatter=Vr.upperFormatter=Vr.capFormatter=void 0;function gv(t){return typeof t=="string"?t:t.name}var kte=(t,e)=>{if(Array.isArray(t))return t.map(n=>(0,Vr.capFormatter)(n,e)).join(", ");let r=gv(t);return r?r.charAt(0).toUpperCase()+r.slice(1):""};Vr.capFormatter=kte;var Bte=(t,e)=>Array.isArray(t)?t.map(n=>(0,Vr.upperFormatter)(n,e)).join(", "):gv(t).toUpperCase();Vr.upperFormatter=Bte;var xte=(t,e)=>Array.isArray(t)?t.map(n=>(0,Vr.lowerFormatter)(n,e)).join(", "):gv(t).toLowerCase();Vr.lowerFormatter=xte;var jte=(t,e)=>{if(Array.isArray(t))return t.map(n=>(0,Vr.titleFormatter)(n,e)).join(", ");let r=gv(t);return r?r.split(" ").map(n=>n.charAt(0).toUpperCase()+n.slice(1).toLowerCase()).join(" "):""};Vr.titleFormatter=jte});var wq=p(Il=>{"use strict";Object.defineProperty(Il,"__esModule",{value:!0});Il.createFormatterRegistry=Wte;Il.parsePlaceholder=Rq;Il.applyFormatters=Cq;Il.formatMessage=Ute;var hm=rw(),hv=nw(),yv=iw();function Wte(){let t=new Map;return t.set("a",hm.aFormatter),t.set("an",hm.aFormatter),t.set("the",hm.theFormatter),t.set("some",hm.someFormatter),t.set("your",hm.yourFormatter),t.set("list",hv.listFormatter),t.set("or-list",hv.orListFormatter),t.set("comma-list",hv.commaListFormatter),t.set("count",hv.countFormatter),t.set("cap",yv.capFormatter),t.set("upper",yv.upperFormatter),t.set("lower",yv.lowerFormatter),t.set("title",yv.titleFormatter),t}function Rq(t){let e=t.split(":");if(e.length===1)return{formatters:[],name:e[0]};let r=e[e.length-1];return{formatters:e.slice(0,-1),name:r}}function Cq(t,e,r,n){let i=typeof t=="number"||typeof t=="boolean"?String(t):t;for(let o of e){let a=r.get(o);a&&(i=a(i,n))}return Array.isArray(i)?i.map(o=>typeof o=="string"?o:o.name).join(", "):typeof i=="string"?i:i.name}function Ute(t,e,r,n={}){return t.replace(/\{([^}]+)\}/g,(i,o)=>{let{formatters:a,name:s}=Rq(o),c=e[s];return c===void 0?i:a.length>0?Cq(c,a,r,n):Array.isArray(c)?c.map(d=>typeof d=="string"?d:d.name).join(", "):typeof c=="string"?c:typeof c=="number"||typeof c=="boolean"?String(c):c.name})}});var ow=p(be=>{"use strict";Object.defineProperty(be,"__esModule",{value:!0});be.titleFormatter=be.lowerFormatter=be.upperFormatter=be.capFormatter=be.countFormatter=be.commaListFormatter=be.orListFormatter=be.listFormatter=be.yourFormatter=be.someFormatter=be.theFormatter=be.aFormatter=be.formatMessage=be.applyFormatters=be.parsePlaceholder=be.createFormatterRegistry=void 0;var Tv=wq();Object.defineProperty(be,"createFormatterRegistry",{enumerable:!0,get:function(){return Tv.createFormatterRegistry}});Object.defineProperty(be,"parsePlaceholder",{enumerable:!0,get:function(){return Tv.parsePlaceholder}});Object.defineProperty(be,"applyFormatters",{enumerable:!0,get:function(){return Tv.applyFormatters}});Object.defineProperty(be,"formatMessage",{enumerable:!0,get:function(){return Tv.formatMessage}});var Ev=rw();Object.defineProperty(be,"aFormatter",{enumerable:!0,get:function(){return Ev.aFormatter}});Object.defineProperty(be,"theFormatter",{enumerable:!0,get:function(){return Ev.theFormatter}});Object.defineProperty(be,"someFormatter",{enumerable:!0,get:function(){return Ev.someFormatter}});Object.defineProperty(be,"yourFormatter",{enumerable:!0,get:function(){return Ev.yourFormatter}});var vv=nw();Object.defineProperty(be,"listFormatter",{enumerable:!0,get:function(){return vv.listFormatter}});Object.defineProperty(be,"orListFormatter",{enumerable:!0,get:function(){return vv.orListFormatter}});Object.defineProperty(be,"commaListFormatter",{enumerable:!0,get:function(){return vv.commaListFormatter}});Object.defineProperty(be,"countFormatter",{enumerable:!0,get:function(){return vv.countFormatter}});var _v=iw();Object.defineProperty(be,"capFormatter",{enumerable:!0,get:function(){return _v.capFormatter}});Object.defineProperty(be,"upperFormatter",{enumerable:!0,get:function(){return _v.upperFormatter}});Object.defineProperty(be,"lowerFormatter",{enumerable:!0,get:function(){return _v.lowerFormatter}});Object.defineProperty(be,"titleFormatter",{enumerable:!0,get:function(){return _v.titleFormatter}})});var aw=p(ym=>{"use strict";Object.defineProperty(ym,"__esModule",{value:!0});ym.EnglishLanguageProvider=void 0;var Hte=yq(),xn=JR(),bv=ZC(),Nq=JC(),Dq=ew(),Lq=ow(),Iv=class{constructor(){l(this,"languageCode","en-US");l(this,"languageName","English (US)");l(this,"textDirection","ltr");l(this,"messages",new Map);l(this,"customActionPatterns",new Map);l(this,"narrativeContext",Dq.DEFAULT_NARRATIVE_CONTEXT);l(this,"formatterRegistry");l(this,"entityLookup");this.formatterRegistry=(0,Lq.createFormatterRegistry)(),this.loadCoreMessages(),this.loadActionMessages(),this.loadNpcMessages()}loadCoreMessages(){let e={"core.entity_not_found":"You can't see any such thing.","core.ambiguous_reference":"Which do you mean?","core.disambiguation_prompt":"Which do you mean: {options}?","core.command_not_understood":"I don't understand that command.","core.command_failed":"I don't understand that.","game.started.banner":`{title}
By {author}

Type HELP for instructions.`};for(let[r,n]of Object.entries(e))this.messages.set(r,n)}setNarrativeSettings(e){this.narrativeContext=e}getNarrativeContext(){return this.narrativeContext}loadActionMessages(){for(let e of bv.standardActionLanguage)e.messages&&Object.entries(e.messages).forEach(([r,n])=>{let i=`${e.actionId}.${r}`;this.messages.set(i,n)})}loadNpcMessages(){if(Nq.npcLanguage.messages)for(let[e,r]of Object.entries(Nq.npcLanguage.messages))this.messages.set(e,r)}getMessage(e,r){let n=this.messages.get(e);if(!n)return e;if(n=(0,Dq.resolvePerspectivePlaceholders)(n,this.narrativeContext),r){let i={getEntity:this.entityLookup};n=(0,Lq.formatMessage)(n,r,this.formatterRegistry,i)}return n}setEntityLookup(e){this.entityLookup=e}registerFormatter(e,r){this.formatterRegistry.set(e,r)}getFormatterRegistry(){return this.formatterRegistry}hasMessage(e){return this.messages.has(e)}getActionPatterns(e){let r=this.customActionPatterns.get(e),i=bv.standardActionLanguage.find(o=>o.actionId===e)?.patterns;return r&&i?[...i,...r]:r||i}getActionHelp(e){let r=bv.standardActionLanguage.find(o=>o.actionId===e);if(!r)return;let n=[];r.patterns&&r.patterns.forEach(o=>{let a=o.match(/^(\w+)/);if(a){let s=a[1].toUpperCase();n.includes(s)||n.push(s)}});let i=[];return r.help?.examples&&(i=r.help.examples.split(",").map(o=>o.trim())),{description:r.help?.description||"No description available.",verbs:n,examples:i,summary:r.help?.summary}}getSupportedActions(){return bv.standardActionLanguage.map(e=>e.actionId)}getEntityName(e){if(!e)return"something";if(typeof e=="string")return e;if(e.name)return e.name;if(e.traits&&e.traits.get){let r=e.traits.get("IDENTITY");if(r&&r.name)return r.name}if(e.get&&typeof e.get=="function"){let r=e.get("IDENTITY");if(r&&r.name)return r.name}return e.id?e.id:"something"}getActionMessages(e){let r=new Map,n=`${e}.`;for(let[i,o]of this.messages)if(i.startsWith(n)){let a=i.substring(n.length);r.set(a,o)}return r.size>0?r:null}getVerbs(){return Hte.englishVerbs.map(e=>({actionId:e.action,verbs:e.verbs,pattern:e.requiresObject?e.allowsIndirectObject?"VERB_OBJ_PREP_OBJ":"VERB_OBJ":"VERB_ONLY",prepositions:e.allowsIndirectObject?["in","on","to","with"]:void 0}))}getDirections(){return[{direction:"north",words:["north"],abbreviations:["n"]},{direction:"south",words:["south"],abbreviations:["s"]},{direction:"east",words:["east"],abbreviations:["e"]},{direction:"west",words:["west"],abbreviations:["w"]},{direction:"northeast",words:["northeast"],abbreviations:["ne"]},{direction:"northwest",words:["northwest"],abbreviations:["nw"]},{direction:"southeast",words:["southeast"],abbreviations:["se"]},{direction:"southwest",words:["southwest"],abbreviations:["sw"]},{direction:"up",words:["up","upward","upwards"],abbreviations:["u"]},{direction:"down",words:["down","downward","downwards"],abbreviations:["d"]},{direction:"in",words:["in","inside"]},{direction:"out",words:["out","outside"]}]}getSpecialVocabulary(){return{articles:xn.englishWords.articles,pronouns:xn.englishWords.pronouns,allWords:["all","everything","every"],exceptWords:["except","but"]}}getCommonAdjectives(){return xn.englishWords.commonAdjectives}getCommonNouns(){return xn.englishWords.commonNouns||[]}getPrepositions(){return xn.englishWords.prepositions}getDeterminers(){return xn.englishWords.determiners||[]}getConjunctions(){return xn.englishWords.conjunctions||[]}getNumbers(){return xn.englishWords.numberWords||[]}getGrammarPatterns(){return[{name:"verb_noun_prep_noun",pattern:"VERB NOUN+ PREP NOUN+",example:"put ball in box",priority:100},{name:"verb_prep_noun",pattern:"VERB PREP NOUN+",example:"look at painting",priority:90},{name:"verb_noun",pattern:"VERB NOUN+",example:"take ball",priority:80},{name:"verb_only",pattern:"VERB",example:"look",priority:70},{name:"direction_only",pattern:"DIRECTION",example:"north",priority:60}]}lemmatize(e){if(!e)return"";let r=e.toLowerCase(),n=xn.irregularPlurals.get(r);return n||(r==="yes"||r==="ties"?r:r.endsWith("ies")&&r.length>4?r.slice(0,-3)+"y":r.endsWith("es")&&r.length>3?r==="yes"?r:r.slice(0,-2):r.endsWith("s")&&!r.endsWith("ss")&&r.length>2?r.slice(0,-1):r.endsWith("ed")&&r.length>3?r.length>4&&r[r.length-3]===r[r.length-4]?r.slice(0,-3):r.slice(0,-2):r.endsWith("ing")&&r.length>4&&!r.includes("-")?r.slice(0,-3):r)}expandAbbreviation(e){return xn.abbreviations.get(e.toLowerCase())||null}formatList(e,r="and"){if(e.length===0)return"";if(e.length===1)return e[0];if(e.length===2)return`${e[0]} ${r} ${e[1]}`;let n=e.slice(0,-1),i=e[e.length-1];return`${n.join(", ")}, ${r} ${i}`}getIndefiniteArticle(e){if(!e||e.length===0)return"a";let r=e[0].toLowerCase(),n=["a","e","i","o","u"];return e.toLowerCase().startsWith("hour")||e.toLowerCase().startsWith("honest")?"an":e.toLowerCase().startsWith("uni")||e.toLowerCase().startsWith("one")?"a":n.includes(r)?"an":"a"}pluralize(e){if(!e)return"s";let r=e.toLowerCase();for(let[n,i]of xn.irregularPlurals)if(i===r)return e===e.toUpperCase()?n.toUpperCase():e[0]===e[0].toUpperCase()?n[0].toUpperCase()+n.slice(1):n;return r.endsWith("s")||r.endsWith("x")||r.endsWith("z")||r.endsWith("ch")||r.endsWith("sh")?e+"es":r.endsWith("y")&&!["a","e","i","o","u"].includes(r[r.length-2])?e===e.toUpperCase()?e.slice(0,-1)+"IES":e.slice(0,-1)+"ies":r.endsWith("f")?e.slice(0,-1)+"ves":r.endsWith("fe")?e.slice(0,-2)+"ves":e+"s"}isIgnoreWord(e){return xn.englishWords.ignoreWords.includes(e.toLowerCase())}addMessage(e,r){this.messages.set(e,r)}addActionHelp(e,r){r.summary&&this.messages.set(`${e}.help.summary`,r.summary),r.description&&this.messages.set(`${e}.help.description`,r.description),r.examples&&r.examples.forEach((n,i)=>{this.messages.set(`${e}.help.example.${i}`,n)})}addActionPatterns(e,r){let i=[...this.customActionPatterns.get(e)||[]];for(let o of r)i.includes(o)||i.push(o);this.customActionPatterns.set(e,i)}};ym.EnglishLanguageProvider=Iv;ym.default=new Iv});var Mq=p(hn=>{"use strict";var qte=hn&&hn.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),Gte=hn&&hn.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&qte(e,t,r)};Object.defineProperty(hn,"__esModule",{value:!0});hn.EnglishGrammarUtils=hn.EnglishGrammarPatterns=hn.EnglishPartsOfSpeech=void 0;hn.EnglishPartsOfSpeech=Object.freeze({VERB:"verb",NOUN:"noun",ADJECTIVE:"adjective",ARTICLE:"article",PREPOSITION:"preposition",PRONOUN:"pronoun",DETERMINER:"determiner",CONJUNCTION:"conjunction",INTERJECTION:"interjection",DIRECTION:"direction",ADVERB:"adverb",AUXILIARY:"auxiliary"});hn.EnglishGrammarPatterns={VERB_ONLY:{name:"verb_only",elements:["VERB"],example:"look",description:"Simple intransitive verb"},VERB_NOUN:{name:"verb_noun",elements:["VERB","NOUN_PHRASE"],example:"take ball",description:"Transitive verb with direct object"},VERB_NOUN_PREP_NOUN:{name:"verb_noun_prep_noun",elements:["VERB","NOUN_PHRASE","PREP","NOUN_PHRASE"],example:"put ball in box",description:"Ditransitive verb with direct and indirect objects"},VERB_PREP_NOUN:{name:"verb_prep_noun",elements:["VERB","PREP","NOUN_PHRASE"],example:"look at painting",description:"Verb with prepositional phrase"},VERB_PARTICLE_NOUN:{name:"verb_particle_noun",elements:["VERB","PARTICLE","NOUN_PHRASE"],example:"pick up ball",description:"Phrasal verb with direct object"},VERB_NOUN_PARTICLE:{name:"verb_noun_particle",elements:["VERB","NOUN_PHRASE","PARTICLE"],example:"put ball down",description:"Phrasal verb with object before particle"},VERB_DIRECTION:{name:"verb_direction",elements:["VERB","DIRECTION"],example:"go north",description:"Movement verb with direction"},DIRECTION_ONLY:{name:"direction_only",elements:["DIRECTION"],example:"north",description:"Implicit movement command"}};hn.EnglishGrammarUtils={isArticle(t){return["a","an","the"].includes(t.toLowerCase())},isDeterminer(t){return["all","every","some","any","no","each","this","that","these","those","my","your","his","her","its","our","their","much","many","few","little","several"].includes(t.toLowerCase())},isPronoun(t){return["i","me","you","he","him","she","her","it","we","us","they","them","myself","yourself","himself","herself","itself","ourselves","yourselves","themselves","this","that","these","those","who","whom","whose","which","what"].includes(t.toLowerCase())},isConjunction(t){return["and","or","but","nor","for","yet","so","although","because","since","unless","while","when","where","if"].includes(t.toLowerCase())},getIndefiniteArticle(t){if(!t||t.length===0)throw new Error("Cannot determine article for empty string");let e=t.toLowerCase(),r=e[0],n=["a","e","i","o","u"],i={8:"an",11:"an",18:"an",80:"an",800:"an",1:"a",2:"a",3:"a",4:"a",5:"a",6:"a",7:"a",9:"a",10:"a",12:"a",13:"a",14:"a",15:"a",16:"a",17:"a",19:"a"};return t in i?i[t]:["hour","honest","honor","heir"].some(s=>e.startsWith(s))?"an":["unit","university","unique","uniform"].some(s=>e.startsWith(s))?"a":n.includes(r)?"an":"a"}};Gte(Tm(),hn)});var Pq=p(H=>{"use strict";Object.defineProperty(H,"__esModule",{value:!0});H.parserErrors=H.systemMessages=H.failureMessages=H.ActionFailureReason=void 0;H.getParserErrorMessage=Fte;H.ActionFailureReason={NOT_VISIBLE:"not_visible",NOT_REACHABLE:"not_reachable",NOT_IN_SCOPE:"not_in_scope",FIXED_IN_PLACE:"fixed_in_place",ALREADY_OPEN:"already_open",ALREADY_CLOSED:"already_closed",NOT_OPENABLE:"not_openable",LOCKED:"locked",NOT_LOCKABLE:"not_lockable",ALREADY_LOCKED:"already_locked",ALREADY_UNLOCKED:"already_unlocked",STILL_OPEN:"still_open",CONTAINER_FULL:"container_full",CONTAINER_CLOSED:"container_closed",NOT_A_CONTAINER:"not_a_container",NOT_A_SUPPORTER:"not_a_supporter",ALREADY_IN_CONTAINER:"already_in_container",NOT_IN_CONTAINER:"not_in_container",NOT_WEARABLE:"not_wearable",ALREADY_WEARING:"already_wearing",NOT_WEARING:"not_wearing",WORN_BY_OTHER:"worn_by_other",TOO_HEAVY:"too_heavy",CARRYING_TOO_MUCH:"carrying_too_much",WRONG_KEY:"wrong_key",NO_KEY_SPECIFIED:"no_key_specified",NOT_A_KEY:"not_a_key",NOT_HOLDING_KEY:"not_holding_key",ALREADY_ON:"already_on",ALREADY_OFF:"already_off",NOT_SWITCHABLE:"not_switchable",NO_POWER:"no_power",NO_EXIT_THAT_WAY:"no_exit_that_way",CANT_GO_THAT_WAY:"cant_go_that_way",DOOR_CLOSED:"door_closed",DOOR_LOCKED:"door_locked",TOO_DARK:"too_dark",CANT_TALK_TO_THAT:"cant_talk_to_that",NO_RESPONSE:"no_response",NOT_A_PERSON:"not_a_person",CANT_DO_THAT:"cant_do_that",NOT_IMPLEMENTED:"not_implemented",INVALID_TARGET:"invalid_target",AMBIGUOUS_TARGET:"ambiguous_target",NOTHING_HAPPENS:"nothing_happens",ACTOR_CANT_SEE:"actor_cant_see",ACTOR_CANT_REACH:"actor_cant_reach",ACTOR_BUSY:"actor_busy",NOT_EDIBLE:"not_edible",NOT_READABLE:"not_readable",NOTHING_WRITTEN:"nothing_written",WONT_ACCEPT:"wont_accept",CANT_GIVE_TO_SELF:"cant_give_to_self",CANT_USE_THAT:"cant_use_that",CANT_USE_TOGETHER:"cant_use_together",NOTHING_TO_USE_WITH:"nothing_to_use_with",CANT_PUSH_THAT:"cant_push_that",CANT_PULL_THAT:"cant_pull_that",CANT_TURN_THAT:"cant_turn_that",WONT_BUDGE:"wont_budge",WEARING_IT:"wearing_it",NO_TARGET:"no_target"};H.failureMessages={[H.ActionFailureReason.NOT_VISIBLE]:"You can't see any such thing.",[H.ActionFailureReason.NOT_REACHABLE]:"You can't reach that from here.",[H.ActionFailureReason.NOT_IN_SCOPE]:"That's not available right now.",[H.ActionFailureReason.FIXED_IN_PLACE]:"That's fixed in place.",[H.ActionFailureReason.ALREADY_OPEN]:"That's already open.",[H.ActionFailureReason.ALREADY_CLOSED]:"That's already closed.",[H.ActionFailureReason.NOT_OPENABLE]:"That's not something you can open.",[H.ActionFailureReason.LOCKED]:"It seems to be locked.",[H.ActionFailureReason.NOT_LOCKABLE]:"That doesn't have a lock.",[H.ActionFailureReason.ALREADY_LOCKED]:"It's already locked.",[H.ActionFailureReason.ALREADY_UNLOCKED]:"It's already unlocked.",[H.ActionFailureReason.STILL_OPEN]:"You can't do that while it's open.",[H.ActionFailureReason.CONTAINER_FULL]:"There's no more room inside.",[H.ActionFailureReason.CONTAINER_CLOSED]:"You'll need to open it first.",[H.ActionFailureReason.NOT_A_CONTAINER]:"That can't contain things.",[H.ActionFailureReason.NOT_A_SUPPORTER]:"You can't put things on top of that.",[H.ActionFailureReason.ALREADY_IN_CONTAINER]:"It's already there.",[H.ActionFailureReason.NOT_IN_CONTAINER]:"It's not in there.",[H.ActionFailureReason.NOT_WEARABLE]:"You can't wear that.",[H.ActionFailureReason.ALREADY_WEARING]:"You're already wearing that.",[H.ActionFailureReason.NOT_WEARING]:"You're not wearing that.",[H.ActionFailureReason.WORN_BY_OTHER]:"Someone else is wearing that.",[H.ActionFailureReason.TOO_HEAVY]:"That's too heavy to carry.",[H.ActionFailureReason.CARRYING_TOO_MUCH]:"You're carrying too much already.",[H.ActionFailureReason.WRONG_KEY]:"That doesn't seem to be the right key.",[H.ActionFailureReason.NO_KEY_SPECIFIED]:"You'll need to specify what to unlock it with.",[H.ActionFailureReason.NOT_A_KEY]:"That doesn't look like it would unlock anything.",[H.ActionFailureReason.NOT_HOLDING_KEY]:"You need to be holding the key.",[H.ActionFailureReason.ALREADY_ON]:"It's already on.",[H.ActionFailureReason.ALREADY_OFF]:"It's already off.",[H.ActionFailureReason.NOT_SWITCHABLE]:"That's not something you can switch.",[H.ActionFailureReason.NO_POWER]:"It doesn't seem to have any power.",[H.ActionFailureReason.NO_EXIT_THAT_WAY]:"You can't go that way.",[H.ActionFailureReason.CANT_GO_THAT_WAY]:"You can't go that way.",[H.ActionFailureReason.DOOR_CLOSED]:"The door is closed.",[H.ActionFailureReason.DOOR_LOCKED]:"The door is locked.",[H.ActionFailureReason.TOO_DARK]:"It's too dark to see where you're going.",[H.ActionFailureReason.CANT_TALK_TO_THAT]:"You can only talk to people.",[H.ActionFailureReason.NO_RESPONSE]:"There is no response.",[H.ActionFailureReason.NOT_A_PERSON]:"You can only do that to a person.",[H.ActionFailureReason.CANT_DO_THAT]:"You can't do that.",[H.ActionFailureReason.NOT_IMPLEMENTED]:"That action isn't available.",[H.ActionFailureReason.INVALID_TARGET]:"That's not a valid target.",[H.ActionFailureReason.AMBIGUOUS_TARGET]:"You'll need to be more specific.",[H.ActionFailureReason.NOTHING_HAPPENS]:"Nothing happens.",[H.ActionFailureReason.ACTOR_CANT_SEE]:"You can't see in the dark.",[H.ActionFailureReason.ACTOR_CANT_REACH]:"You can't reach that from your current position.",[H.ActionFailureReason.ACTOR_BUSY]:"You're too busy to do that right now.",[H.ActionFailureReason.NOT_EDIBLE]:"That's not something you can eat.",[H.ActionFailureReason.NOT_READABLE]:"There's nothing written on that.",[H.ActionFailureReason.NOTHING_WRITTEN]:"You see nothing special written there.",[H.ActionFailureReason.WONT_ACCEPT]:"They don't seem interested.",[H.ActionFailureReason.CANT_GIVE_TO_SELF]:"You can't give something to yourself.",[H.ActionFailureReason.CANT_USE_THAT]:"You can't use that.",[H.ActionFailureReason.CANT_USE_TOGETHER]:"You can't use those things together.",[H.ActionFailureReason.NOTHING_TO_USE_WITH]:"You need to specify what to use it with.",[H.ActionFailureReason.CANT_PUSH_THAT]:"You can't push that.",[H.ActionFailureReason.CANT_PULL_THAT]:"You can't pull that.",[H.ActionFailureReason.CANT_TURN_THAT]:"You can't turn that.",[H.ActionFailureReason.WONT_BUDGE]:"It won't budge.",[H.ActionFailureReason.WEARING_IT]:"You can't do that while wearing it.",[H.ActionFailureReason.NO_TARGET]:"What do you want to push?"};H.systemMessages={inventoryEmpty:"You are carrying nothing.",inventoryHeader:"You are carrying:",inventoryWearing:" (being worn)",locationDescription:"You are in {location}.",canSee:"You can see {items} here.",canAlsoSee:"You can also see {items} here.",nothingSpecial:"You see nothing special.",insideContainer:"In the {container}:",onSupporter:"On the {supporter}:",savePrompt:"Enter save game name:",saveSuccess:"Game saved.",saveFailed:"Failed to save game.",restorePrompt:"Enter save game name:",restoreSuccess:"Game restored.",restoreFailed:"Failed to restore game.",saving_game:"Saving game...",game_saved:"Game saved successfully.",save_failed:"Save failed: {error}",restoring_game:"Restoring game...",game_restored:"Game restored successfully.",restore_failed:"Restore failed: {error}",quitting_game:"Quitting game...",quit_confirmed:"Thanks for playing!",quit_cancelled:"Quit cancelled.",restarting_game:"Restarting game...",game_restarted:"Game restarted.",restart_cancelled:"Restart cancelled.",quitConfirm:"Are you sure you want to quit? (yes/no)",scoreDisplay:"Your score is {score} out of {maxScore}.",turnsDisplay:"You have taken {turns} turn(s).",unknownVerb:"I don't understand that verb.",unknownObject:"I don't know what '{object}' refers to.",ambiguousObject:"Which do you mean: {options}?",missingObject:"What do you want to {verb}?",missingIndirectObject:"What do you want to {verb} it {preposition}?",ok:"Okay.",done:"Done.",taken:"Taken.",dropped:"Dropped."};H.parserErrors={"parser.error.noInput":"I beg your pardon?","parser.error.unknownVerb":t=>t.verb?`I don't know the word "${t.verb}".`:"I don't understand that sentence.","parser.error.missingObject":t=>t.verb?`What do you want to ${t.verb}?`:"What do you want to do that to?","parser.error.missingIndirect":t=>t.verb&&t.slot?["container","location","destination"].includes(t.slot)?`Where do you want to ${t.verb} it?`:`What do you want to ${t.verb} it ${t.slot}?`:"I need more information to understand that.","parser.error.entityNotFound":t=>t.noun?`You can't see any "${t.noun}" here.`:"You can't see any such thing.","parser.error.scopeViolation":t=>t.noun?`You can't reach the ${t.noun}.`:"You can't reach that.","parser.error.ambiguous":t=>t.candidates&&t.candidates.length>0?`Which do you mean: ${t.candidates.join(", ")}?`:t.noun?`Which ${t.noun} do you mean?`:"Which do you mean?","parser.error.invalidSyntax":t=>t.extraWords?`I understood you as far as "${t.verb}" but got confused by "${t.extraWords}".`:"I don't understand that sentence."};function Fte(t,e={}){let r=H.parserErrors[t];return r?typeof r=="function"?r(e):r.replace(/\{(\w+)\}/g,(n,i)=>e[i]||""):"I don't understand that."}});var Tm=p(Ee=>{"use strict";var Vte=Ee&&Ee.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),Em=Ee&&Ee.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&Vte(e,t,r)},Yte=Ee&&Ee.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(Ee,"__esModule",{value:!0});Ee.getParserErrorMessage=Ee.parserErrors=Ee.irregularPlurals=Ee.abbreviations=Ee.englishWords=Ee.directionMap=Ee.ordinalNumbers=Ee.cardinalNumbers=Ee.LanguageProvider=Ee.default=Ee.EnglishLanguageProvider=void 0;var kq=aw();Object.defineProperty(Ee,"EnglishLanguageProvider",{enumerable:!0,get:function(){return kq.EnglishLanguageProvider}});Object.defineProperty(Ee,"default",{enumerable:!0,get:function(){return Yte(kq).default}});var zte=aw();Object.defineProperty(Ee,"LanguageProvider",{enumerable:!0,get:function(){return zte.EnglishLanguageProvider}});Em(Mq(),Ee);Em(ZC(),Ee);Em(JC(),Ee);Em(ew(),Ee);Em(ow(),Ee);var Ol=JR();Object.defineProperty(Ee,"cardinalNumbers",{enumerable:!0,get:function(){return Ol.cardinalNumbers}});Object.defineProperty(Ee,"ordinalNumbers",{enumerable:!0,get:function(){return Ol.ordinalNumbers}});Object.defineProperty(Ee,"directionMap",{enumerable:!0,get:function(){return Ol.directionMap}});Object.defineProperty(Ee,"englishWords",{enumerable:!0,get:function(){return Ol.englishWords}});Object.defineProperty(Ee,"abbreviations",{enumerable:!0,get:function(){return Ol.abbreviations}});Object.defineProperty(Ee,"irregularPlurals",{enumerable:!0,get:function(){return Ol.irregularPlurals}});var Bq=Pq();Object.defineProperty(Ee,"parserErrors",{enumerable:!0,get:function(){return Bq.parserErrors}});Object.defineProperty(Ee,"getParserErrorMessage",{enumerable:!0,get:function(){return Bq.getParserErrorMessage}})});var Sv=p(Ov=>{"use strict";Object.defineProperty(Ov,"__esModule",{value:!0});Ov.getNextPatternToken=Kte;Ov.isPatternDelimiter=$te;function Kte(t){return t.pattern.tokens[t.slotTokenIndex+1]}function $te(t,e){return e?!!(e.type==="literal"&&t.normalized===e.value||e.type==="alternates"&&e.alternates.includes(t.normalized)):!1}});var xq=p(Av=>{"use strict";Object.defineProperty(Av,"__esModule",{value:!0});Av.ScopeEvaluator=void 0;var sw=class{static getEntitiesInScope(e,r){if(!r.world)return[];let n=[];switch(e.base){case"all":n=this.getAllEntities(r);break;case"visible":n=this.getVisibleEntities(r);break;case"touchable":n=this.getTouchableEntities(r);break;case"carried":n=this.getCarriedEntities(r);break;case"nearby":n=this.getNearbyEntities(r);break;default:n=[]}for(let o of e.filters)n=n.filter(a=>this.matchesFilter(a,o,r));if(e.traitFilters&&e.traitFilters.length>0&&(n=n.filter(o=>e.traitFilters.every(a=>this.entityHasTrait(o,a)))),e.explicitEntities.length>0){let o=e.explicitEntities.map(a=>r.world.getEntity(a)).filter(Boolean);n=[...n,...o]}let i=new Set(n.map(o=>o.id));return n.filter((o,a,s)=>s.findIndex(c=>c.id===o.id)===a)}static entityMatchesScope(e,r,n){return this.getEntitiesInScope(r,n).some(o=>o.id===e.id)}static getAllEntities(e){return e.world?.getAllEntities?e.world.getAllEntities():[]}static getVisibleEntities(e){return e.world?.getVisibleEntities?e.world.getVisibleEntities(e.actorId,e.currentLocation):[]}static getTouchableEntities(e){return e.world?.getTouchableEntities?e.world.getTouchableEntities(e.actorId,e.currentLocation):[]}static getCarriedEntities(e){return e.world?.getCarriedEntities?e.world.getCarriedEntities(e.actorId):[]}static getNearbyEntities(e){return e.world?.getNearbyEntities?e.world.getNearbyEntities(e.actorId,e.currentLocation):this.getVisibleEntities(e)}static matchesFilter(e,r,n){if(typeof r=="function")return r(e,n);for(let[i,o]of Object.entries(r))if(e[i]!==o)return!1;return!0}static entityHasTrait(e,r){if(typeof e.has=="function")return e.has(r);if(typeof e.get=="function"){let n=e.get(r);return n!=null}return!1}static getEntityNames(e){let r=[];if(e.attributes&&(e.attributes.displayName&&r.push(String(e.attributes.displayName)),e.attributes.name&&r.push(String(e.attributes.name))),typeof e.get=="function"){let n=e.get("identity");n&&typeof n=="object"&&(n.name&&r.push(String(n.name)),Array.isArray(n.aliases)&&r.push(...n.aliases.map(String)))}return r}static findEntitiesByName(e,r,n){let i=this.getEntitiesInScope(r,n),o=e.toLowerCase(),a=i.filter(c=>c?this.getEntityNames(c).some(u=>u.toLowerCase()===o):!1);return a.length>0?a:i.filter(c=>c?this.getEntityNames(c).some(u=>u.toLowerCase().includes(o)):!1)}};Av.ScopeEvaluator=sw});var Rv=p(Yr=>{"use strict";Object.defineProperty(Yr,"__esModule",{value:!0});Yr.PronounContextManager=Yr.INANIMATE_THEM=Yr.INANIMATE_IT=Yr.RECOGNIZED_PRONOUNS=void 0;Yr.isRecognizedPronoun=Qte;Yr.setPronounContextManager=Xte;Yr.getPronounContextManager=Zte;Yr.RECOGNIZED_PRONOUNS=["it","them","him","her","xem","zir","hir","em","faer"];function Qte(t){return Yr.RECOGNIZED_PRONOUNS.includes(t.toLowerCase())}Yr.INANIMATE_IT={subject:"it",object:"it",possessive:"its",possessiveAdj:"its",reflexive:"itself",verbForm:"singular"};Yr.INANIMATE_THEM={subject:"they",object:"them",possessive:"theirs",possessiveAdj:"their",reflexive:"themselves",verbForm:"plural"};var jq=null;function Xte(t){jq=t}function Zte(){return jq}var cw=class{constructor(){l(this,"context");this.context=this.createEmptyContext()}createEmptyContext(){return{it:null,them:null,animateByPronoun:new Map,lastCommand:null}}reset(){this.context=this.createEmptyContext()}getContext(){return this.context}resolve(e){let r=e.toLowerCase();switch(r){case"it":return this.context.it?[this.context.it]:null;case"them":if(this.context.them&&this.context.them.length>0)return this.context.them;let n=this.context.animateByPronoun.get("them");return n?[n]:null;case"him":case"her":case"xem":case"zir":case"hir":case"em":case"faer":let i=this.context.animateByPronoun.get(r);return i?[i]:null;default:let o=this.context.animateByPronoun.get(r);return o?[o]:null}}updateFromCommand(e,r,n){this.context.lastCommand=e.parsed,e.directObject&&this.processValidatedReference(e.directObject,r,n),e.indirectObject&&this.processValidatedReference(e.indirectObject,r,n),e.instrument&&this.processValidatedReference(e.instrument,r,n)}processValidatedReference(e,r,n){let i=e.entity;if(!i)return;let o={entityId:i.id,text:e.parsed?.text||i.id,turnNumber:n},a=i.get("actor");if(a?.pronouns){let s=Array.isArray(a.pronouns)?a.pronouns[0]:a.pronouns;if(this.context.animateByPronoun.set(s.object,o),Array.isArray(a.pronouns))for(let c of a.pronouns)this.context.animateByPronoun.set(c.object,o)}else i.get("identity")?.grammaticalNumber==="plural"?this.context.them=[o]:this.context.it=o}registerEntity(e,r,n,i){let o=n.getEntity(e);if(!o)return;let a={entityId:e,text:r,turnNumber:i},s=o.get("actor");if(s?.pronouns){let c=Array.isArray(s.pronouns)?s.pronouns[0]:s.pronouns;if(this.context.animateByPronoun.set(c.object,a),Array.isArray(s.pronouns))for(let d of s.pronouns)this.context.animateByPronoun.set(d.object,a)}else o.get("identity")?.grammaticalNumber==="plural"?this.context.them=[a]:this.context.it=a}getLastCommand(){return this.context.lastCommand}};Yr.PronounContextManager=cw});var uw=p(Cv=>{"use strict";Object.defineProperty(Cv,"__esModule",{value:!0});Cv.EntitySlotConsumer=void 0;var dw=jt(),Jte=Sv(),ere=xq(),Wq=Rv(),lw=class{constructor(){l(this,"slotTypes",[dw.SlotType.ENTITY,dw.SlotType.INSTRUMENT])}consume(e){let{tokens:r,startIndex:n,slotType:i}=e,o=e.DEBUG||!1,a=(0,Jte.getNextPatternToken)(e);if(n<r.length){let s=r[n].normalized;if(o&&console.log(`consumeEntitySlot: startIndex=${n}, token.word='${r[n]?.word}', token.normalized='${s}'`),(0,Wq.isRecognizedPronoun)(s)){let c=this.tryResolvePronoun(e,s,o);if(c)return c;o&&console.log(`Pronoun '${s}' could not be resolved, trying standard entity resolution`)}}return n<r.length&&r[n].normalized==="all"?(o&&console.log('Detected "all" keyword, calling consumeAllSlot'),this.consumeAllSlot(e,a,o)):this.consumeEntityWithListDetection(e,o)}tryResolvePronoun(e,r,n){let{tokens:i,startIndex:o,slotType:a,context:s}=e,c=(0,Wq.getPronounContextManager)();if(!c)return n&&console.log("No pronoun context manager available"),null;let d=c.resolve(r);if(!d||d.length===0)return n&&console.log(`Pronoun '${r}' did not resolve to any entity`),null;if(n&&console.log(`Pronoun '${r}' resolved to: ${d.map(m=>m.entityId).join(", ")}`),d.length===1){let m=d[0],f={tokens:[o],text:m.text,confidence:1,slotType:a};return f.entityId=m.entityId,f.resolvedText=m.text,f.isPronoun=!0,f}let u={tokens:[o],text:r,confidence:1,slotType:a,isList:!0,items:d.map(m=>({tokens:[o],text:m.text,entityId:m.entityId}))};return u.isPronoun=!0,u}consumeAllSlot(e,r,n){let{tokens:i,startIndex:o,slotType:a}=e,s=[o],c=o+1,d=[];if(c<i.length){let u=i[c].normalized;if(u==="but"||u==="except"){s.push(c),c++;let m=this.consumeExcludedEntities(e,c,r,n);m&&(s.push(...m.tokens),d.push(...m.items))}}return n&&console.log(`Consumed "all" slot with ${d.length} exclusions`),{tokens:s,text:"all",confidence:1,slotType:a,isAll:!0,excluded:d.length>0?d:void 0}}consumeExcludedEntities(e,r,n,i){let{tokens:o}=e,a=[],s=[],c=r;for(;c<o.length;){if(n){let m=o[c].normalized;if(n.type==="literal"&&m===n.value||n.type==="alternates"&&n.alternates.includes(m))break}if(o[c].normalized==="and"){s.push(c),c++;continue}let d=[],u=[];for(;c<o.length;){let m=o[c].normalized;if(m==="and"||n?.type==="literal"&&m===n.value||n?.type==="alternates"&&n.alternates.includes(m))break;d.push(c),u.push(o[c].word),c++}d.length>0&&(a.push({tokens:d,text:u.join(" ")}),s.push(...d))}return a.length===0?null:{tokens:s,items:a}}consumeEntityWithListDetection(e,r){let{slotName:n,tokens:i,startIndex:o,pattern:a,slotTokenIndex:s,rule:c,context:d,slotType:u}=e,m=a.tokens[s+1],f=[],g=[],h=[],y=o,T=m?.type==="slot";for(;y<i.length;){if(m){let k=i[y].normalized;if(m.type==="literal"&&k===m.value||m.type==="alternates"&&m.alternates.includes(k))break}let S=[],R=[];if(T&&f.length===0){let k=c.slots.get(n),w=null;for(let Te=1;Te<=i.length-y;Te++){let Oe=[],ue=[];for(let le=0;le<Te&&y+le<i.length&&i[y+le].normalized!=="and";le++)Oe.push(y+le),ue.push(i[y+le].word);if(Oe.length===0)break;let mt=ue.join(" ");if(k&&k.constraints.length>0&&d.world){let le=this.evaluateSlotConstraints(mt,k,d);if(le>0){w={tokens:Oe,words:ue,confidence:le};break}}else{w={tokens:Oe,words:ue,confidence:1};break}}w&&(S.push(...w.tokens),R.push(...w.words),g.push(...w.tokens),h.push(...w.words),y+=w.tokens.length)}else for(;y<i.length;){let k=i[y].normalized;if(k==="and"||m?.type==="literal"&&k===m.value||m?.type==="alternates"&&m.alternates.includes(k))break;S.push(y),R.push(i[y].word),g.push(y),h.push(i[y].word),y++}if(S.length>0&&f.push({tokens:S,text:R.join(" ")}),y<i.length&&i[y].normalized==="and")g.push(y),h.push(i[y].word),y++;else break}if(g.length===0)return null;let I=c.slots.get(n),A=1;if(r&&(console.log(`Checking constraints for slot '${n}':`),console.log(`  slotConstraints exists: ${!!I}`),console.log(`  constraints count: ${I?.constraints?.length??0}`),console.log(`  context.world exists: ${!!d.world}`)),I&&I.constraints.length>0&&d.world){for(let S of f){let R=this.evaluateSlotConstraints(S.text,I,d);A=Math.min(A,R)}if(A===0)return r&&console.log(`Failed to consume slot '${n}'`),null}let L={tokens:g,text:h.join(" "),confidence:A,slotType:u};return f.length>1&&(L.isList=!0,L.items=f,r&&console.log(`Consumed list slot with ${f.length} items: ${f.map(S=>S.text).join(", ")}`)),L}evaluateSlotConstraints(e,r,n){let i=!1;for(let o of r.constraints)if(typeof o=="function")if(o.length===1){let a=new dw.ScopeBuilderImpl,c=o(a).build(),d=ere.ScopeEvaluator.findEntitiesByName(e,c,n);if(d.length>0){i=!0;let u=n.slots.get(e)||[];n.slots.set(e,[...u,...d])}}else console.warn("FunctionConstraint in slot constraints not yet supported");else console.warn("PropertyConstraint in slot constraints not yet supported");return i?1:0}};Cv.EntitySlotConsumer=lw});var pw=p(Nv=>{"use strict";Object.defineProperty(Nv,"__esModule",{value:!0});Nv.TextSlotConsumer=void 0;var ui=jt(),wv=Sv(),mw=class{constructor(){l(this,"slotTypes",[ui.SlotType.TEXT,ui.SlotType.TEXT_GREEDY,ui.SlotType.QUOTED_TEXT,ui.SlotType.TOPIC])}consume(e){let{slotType:r}=e;switch(r){case ui.SlotType.TEXT:return this.consumeText(e);case ui.SlotType.TEXT_GREEDY:return this.consumeGreedyText(e);case ui.SlotType.QUOTED_TEXT:return this.consumeQuotedText(e);case ui.SlotType.TOPIC:return this.consumeTopic(e);default:return null}}consumeText(e){let{tokens:r,startIndex:n,slotType:i}=e;if(n>=r.length)return null;let o=r[n];return{tokens:[n],text:o.word,confidence:1,slotType:i}}consumeGreedyText(e){let{tokens:r,startIndex:n,slotType:i}=e,o=(0,wv.getNextPatternToken)(e),a=[],s=[];for(let c=n;c<r.length;c++){let d=r[c];if((0,wv.isPatternDelimiter)(d,o))break;a.push(c),s.push(d.word)}return a.length===0?null:{tokens:a,text:s.join(" "),confidence:1,slotType:i}}consumeQuotedText(e){let{tokens:r,startIndex:n}=e;if(n>=r.length)return null;let o=r[n].word;if(!o.startsWith('"'))return null;if(o.endsWith('"')&&o.length>2)return{tokens:[n],text:o.slice(1,-1),confidence:1,slotType:ui.SlotType.QUOTED_TEXT};let a=[n],s=[o.slice(1)];for(let c=n+1;c<r.length;c++){let d=r[c];if(a.push(c),d.word.endsWith('"'))return s.push(d.word.slice(0,-1)),{tokens:a,text:s.join(" "),confidence:1,slotType:ui.SlotType.QUOTED_TEXT};s.push(d.word)}return null}consumeTopic(e){let{tokens:r,startIndex:n}=e;if(n>=r.length)return null;let i=(0,wv.getNextPatternToken)(e),o=[],a=[];for(let s=n;s<r.length;s++){let c=r[s];if((0,wv.isPatternDelimiter)(c,i))break;o.push(s),a.push(c.word)}return o.length===0?null:{tokens:o,text:a.join(" "),confidence:1,slotType:ui.SlotType.TOPIC}}};Nv.TextSlotConsumer=mw});var hw=p(Dv=>{"use strict";Object.defineProperty(Dv,"__esModule",{value:!0});Dv.TypedSlotConsumer=void 0;var zr=jt(),fw=Tm(),gw=class{constructor(){l(this,"slotTypes",[zr.SlotType.NUMBER,zr.SlotType.ORDINAL,zr.SlotType.TIME,zr.SlotType.DIRECTION])}consume(e){let{slotType:r}=e;switch(r){case zr.SlotType.NUMBER:return this.consumeNumber(e);case zr.SlotType.ORDINAL:return this.consumeOrdinal(e);case zr.SlotType.TIME:return this.consumeTime(e);case zr.SlotType.DIRECTION:return this.consumeDirection(e);default:return null}}consumeNumber(e){let{tokens:r,startIndex:n}=e;if(n>=r.length)return null;let i=r[n],o=i.normalized;return o in fw.cardinalNumbers?{tokens:[n],text:i.word,confidence:1,slotType:zr.SlotType.NUMBER}:/^\d+$/.test(o)?{tokens:[n],text:i.word,confidence:1,slotType:zr.SlotType.NUMBER}:null}consumeOrdinal(e){let{tokens:r,startIndex:n}=e;if(n>=r.length)return null;let i=r[n],o=i.normalized;return o in fw.ordinalNumbers?{tokens:[n],text:i.word,confidence:1,slotType:zr.SlotType.ORDINAL}:o.match(/^(\d+)(st|nd|rd|th)$/)?{tokens:[n],text:i.word,confidence:1,slotType:zr.SlotType.ORDINAL}:null}consumeTime(e){let{tokens:r,startIndex:n}=e;if(n>=r.length)return null;let o=r[n].word,a=o.match(/^(\d{1,2}):(\d{2})$/);if(a){let s=parseInt(a[1],10),c=parseInt(a[2],10);if(s>=0&&s<=23&&c>=0&&c<=59)return{tokens:[n],text:o,confidence:1,slotType:zr.SlotType.TIME}}return null}consumeDirection(e){let{tokens:r,startIndex:n}=e;if(n>=r.length)return null;let i=r[n];return i.normalized in fw.directionMap?{tokens:[n],text:i.word,confidence:1,slotType:zr.SlotType.DIRECTION}:null}};Dv.TypedSlotConsumer=gw});var Tw=p(Lv=>{"use strict";Object.defineProperty(Lv,"__esModule",{value:!0});Lv.VocabularySlotConsumer=void 0;var yn=jt(),tre=new Set(["carefully","quietly","quickly","slowly","forcefully","gently","loudly","softly","cautiously","boldly","stealthily","silently","hastily","deliberately","violently","tenderly"]),yw=class{constructor(){l(this,"slotTypes",[yn.SlotType.ADJECTIVE,yn.SlotType.NOUN,yn.SlotType.VOCABULARY,yn.SlotType.MANNER])}consume(e){let{slotType:r}=e;switch(r){case yn.SlotType.ADJECTIVE:return this.consumeAdjective(e);case yn.SlotType.NOUN:return this.consumeNoun(e);case yn.SlotType.VOCABULARY:return this.consumeVocabulary(e);case yn.SlotType.MANNER:return this.consumeManner(e);default:return null}}consumeAdjective(e){let{tokens:r,startIndex:n,context:i}=e;if(n>=r.length)return null;let o=r[n],a=o.normalized,s=this.getVocabulary(i,"adjectives");return s&&s.has(a)?{tokens:[n],text:o.word,confidence:1,slotType:yn.SlotType.ADJECTIVE}:null}consumeNoun(e){let{tokens:r,startIndex:n,context:i}=e;if(n>=r.length)return null;let o=r[n],a=o.normalized,s=this.getVocabulary(i,"nouns");return s&&s.has(a)?{tokens:[n],text:o.word,confidence:1,slotType:yn.SlotType.NOUN}:null}consumeVocabulary(e){let{tokens:r,startIndex:n,context:i,slotConstraints:o}=e,a=o?.vocabularyCategory;if(n>=r.length||!a)return null;let s=r[n],c=s.normalized,d=i.world;return d?.getGrammarVocabularyProvider&&d.getGrammarVocabularyProvider().match(a,c,i)?{tokens:[n],text:s.word,confidence:1,slotType:yn.SlotType.VOCABULARY,category:a,matchedWord:c}:null}consumeManner(e){let{tokens:r,startIndex:n,context:i}=e;if(n>=r.length)return null;let o=r[n],a=o.normalized;if(tre.has(a))return{tokens:[n],text:o.word,confidence:1,slotType:yn.SlotType.MANNER,manner:a};let s=i.world;return s?.getGrammarVocabularyProvider&&s.getGrammarVocabularyProvider().match("manner",a,i)?{tokens:[n],text:o.word,confidence:1,slotType:yn.SlotType.MANNER,manner:a}:null}getVocabulary(e,r){let n=e.world;if(!n)return null;let i=n.getVocabularyProvider?.();if(!i)return null;switch(r){case"adjectives":return i.getAdjectives?.()||null;case"nouns":return i.getNouns?.()||null;default:return null}}};Lv.VocabularySlotConsumer=yw});var Hq=p(Ht=>{"use strict";Object.defineProperty(Ht,"__esModule",{value:!0});Ht.SlotConsumerRegistry=Ht.VocabularySlotConsumer=Ht.TypedSlotConsumer=Ht.TextSlotConsumer=Ht.EntitySlotConsumer=Ht.isPatternDelimiter=Ht.getNextPatternToken=void 0;Ht.createDefaultRegistry=lre;var rre=uw(),nre=pw(),ire=hw(),ore=Tw(),Uq=Sv();Object.defineProperty(Ht,"getNextPatternToken",{enumerable:!0,get:function(){return Uq.getNextPatternToken}});Object.defineProperty(Ht,"isPatternDelimiter",{enumerable:!0,get:function(){return Uq.isPatternDelimiter}});var are=uw();Object.defineProperty(Ht,"EntitySlotConsumer",{enumerable:!0,get:function(){return are.EntitySlotConsumer}});var sre=pw();Object.defineProperty(Ht,"TextSlotConsumer",{enumerable:!0,get:function(){return sre.TextSlotConsumer}});var cre=hw();Object.defineProperty(Ht,"TypedSlotConsumer",{enumerable:!0,get:function(){return cre.TypedSlotConsumer}});var dre=Tw();Object.defineProperty(Ht,"VocabularySlotConsumer",{enumerable:!0,get:function(){return dre.VocabularySlotConsumer}});var Mv=class{constructor(){l(this,"consumers",new Map)}register(e){for(let r of e.slotTypes)this.consumers.set(r,e)}hasConsumer(e){return this.consumers.has(e)}consume(e){let r=this.consumers.get(e.slotType);if(!r)throw new Error(`No consumer registered for slot type: ${e.slotType}`);return r.consume(e)}getRegisteredTypes(){return Array.from(this.consumers.keys())}};Ht.SlotConsumerRegistry=Mv;function lre(){let t=new Mv;return t.register(new rre.EntitySlotConsumer),t.register(new nre.TextSlotConsumer),t.register(new ire.TypedSlotConsumer),t.register(new ore.VocabularySlotConsumer),t}});var qq=p(Pv=>{"use strict";Object.defineProperty(Pv,"__esModule",{value:!0});Pv.EnglishGrammarEngine=void 0;var Sl=jt(),ure=hq(),vm=Tm(),mre=Hq(),Ew=class extends Sl.GrammarEngine{constructor(r){super(new ure.EnglishPatternCompiler);l(this,"slotConsumerRegistry");l(this,"lastFailures",[]);this.slotConsumerRegistry=r||(0,mre.createDefaultRegistry)()}getLastFailures(){return this.lastFailures}findMatches(r,n,i={}){let o=[],a=[],{minConfidence:s=.1,maxMatches:c=10}=i;for(let d of this.rules){if(!d.compiledPattern)continue;let u=this.tryMatchRuleWithFailure(d,r,n);if(u.success){if(u.match.confidence>=s&&(o.push(u.match),o.length>=c))break}else a.push(u.failure)}return this.lastFailures=a,o.sort((d,u)=>u.confidence!==d.confidence?u.confidence-d.confidence:u.rule.priority-d.rule.priority),o}tryMatchRule(r,n,i){let o=r.compiledPattern,a=!1;if(a&&(console.log(`
Trying to match rule: ${r.pattern}`),console.log("Tokens:",n.map(g=>g.word).join(" "))),n.length<o.minTokens)return null;let s=new Map,c=0,d=1,u=0,m={};for(let g of o.tokens){if(c>=n.length){if(g.optional)continue;return null}let h=n[c];switch(g.type){case"literal":if(h.normalized===g.value)c===0&&(m.verb=h.normalized),c++;else if(g.optional){u++;continue}else return a&&console.log(`Literal mismatch at token ${c}: expected '${g.value}', got '${h.normalized}'`),null;break;case"alternates":if(g.alternates.includes(h.normalized))c===0&&(m.verb=h.normalized),a&&console.log(`Alternates match: token '${h.normalized}' matches alternates [${g.alternates.join(", ")}]`),c++;else if(g.optional){u++;continue}else return a&&console.log(`Alternates mismatch: token '${h.normalized}' not in alternates [${g.alternates.join(", ")}]`),null;break;case"slot":a&&console.log(`Consuming slot '${g.value}' starting at token ${c}`);let y=this.consumeSlot(g.value,n,c,o,r,i);if(!y)if(g.optional){u++;continue}else return a&&console.log(`Failed to consume slot '${g.value}'`),null;a&&console.log(`Consumed slot '${g.value}': "${y.text}"`),s.set(g.value,y),g.value==="direction"?m.direction=y.text:g.value==="preposition"&&(m.preposition=y.text),c=y.tokens[y.tokens.length-1]+1,d*=y.confidence||.9;break}}if(c!==n.length)return a&&console.log(`Pattern match failed: consumed ${c} tokens but have ${n.length} total`),null;d*=Math.pow(.9,u),r.experimentalConfidence&&(d*=r.experimentalConfidence),a&&console.log(`Pattern matched successfully! Skipped ${u} optional elements`);let f=this.buildSemantics(r,m);return{rule:r,confidence:d,slots:s,consumed:c,semantics:f,matchedTokens:m}}tryMatchRuleWithFailure(r,n,i){let o=r.compiledPattern,a=!1,s=o.tokens.length;if(n.length<o.minTokens)return{success:!1,failure:{pattern:r.pattern,action:r.action,progress:0,tokensConsumed:0,reason:"NOT_ENOUGH_TOKENS",expected:o.tokens[0]?.value}};let c=new Map,d=0,u=0,m=1,f=0,g={},h;for(let T of o.tokens){if(u++,d>=n.length){if(T.optional)continue;return{success:!1,failure:{pattern:r.pattern,action:r.action,progress:u/s,tokensConsumed:d,reason:"NOT_ENOUGH_TOKENS",matchedVerb:h,expected:T.type==="slot"?`:${T.value}`:T.value}}}let I=n[d];switch(T.type){case"literal":if(I.normalized===T.value)d===0&&(g.verb=I.normalized,h=I.normalized),d++;else if(T.optional){f++;continue}else{let L=d===0?"VERB_MISMATCH":"LITERAL_MISMATCH";return{success:!1,failure:{pattern:r.pattern,action:r.action,progress:u/s,tokensConsumed:d,reason:L,matchedVerb:h,failedAtToken:I.normalized,expected:T.value}}}break;case"alternates":if(T.alternates.includes(I.normalized))d===0&&(g.verb=I.normalized,h=I.normalized),d++;else if(T.optional){f++;continue}else{let L=d===0?"VERB_MISMATCH":"LITERAL_MISMATCH";return{success:!1,failure:{pattern:r.pattern,action:r.action,progress:u/s,tokensConsumed:d,reason:L,matchedVerb:h,failedAtToken:I.normalized,expected:T.alternates.join("/")}}}break;case"slot":let A=this.consumeSlot(T.value,n,d,o,r,i);if(!A){if(T.optional){f++;continue}let L=n.slice(d),S=L.map(R=>R.word).join(" ");return{success:!1,failure:{pattern:r.pattern,action:r.action,progress:u/s,tokensConsumed:d,reason:"SLOT_FAILED",matchedVerb:h,slotFailure:{slotName:T.value,attemptedText:S||"(nothing)",reason:"NO_MATCH",unknownWord:L[0]?.word}}}}c.set(T.value,A),T.value==="direction"?g.direction=A.text:T.value==="preposition"&&(g.preposition=A.text),d=A.tokens[A.tokens.length-1]+1,m*=A.confidence||.9;break}}if(d!==n.length)return{success:!1,failure:{pattern:r.pattern,action:r.action,progress:.9,tokensConsumed:d,reason:"LEFTOVER_TOKENS",matchedVerb:h,failedAtToken:n[d]?.word}};m*=Math.pow(.9,f),r.experimentalConfidence&&(m*=r.experimentalConfidence);let y=this.buildSemantics(r,g);return{success:!0,match:{rule:r,confidence:m,slots:c,consumed:d,semantics:y,matchedTokens:g}}}buildSemantics(r,n){let o={};if(r.defaultSemantics&&(o={...r.defaultSemantics}),r.semantics){if(r.semantics.verbs&&n.verb){let a=r.semantics.verbs[n.verb];a&&(o={...o,...a})}if(r.semantics.directions&&n.direction){let a=r.semantics.directions[n.direction];a&&(o.direction=a)}if(r.semantics.prepositions&&n.preposition){let a=r.semantics.prepositions[n.preposition];a&&(o.spatialRelation=a)}}return Object.keys(o).length>0?o:void 0}consumeSlot(r,n,i,o,a,s){let d=-1,u;for(let g=0;g<o.tokens.length;g++){let h=o.tokens[g];if(h.type==="slot"&&h.value===r){d=g,u=h;break}}if(d===-1)return null;let m=a.slots.get(r),f=m?.slotType||u?.slotType||Sl.SlotType.ENTITY;if(this.slotConsumerRegistry.hasConsumer(f)){let g={slotName:r,tokens:n,startIndex:i,pattern:o,slotTokenIndex:d,rule:a,context:s,slotType:f,slotConstraints:m,patternToken:u,DEBUG:!1};return this.slotConsumerRegistry.consume(g)}throw new Error(`Unknown slot type: ${f}`)}static extractNumberValue(r){if(r.slotType!==Sl.SlotType.NUMBER)return null;let n=r.text.toLowerCase();return n in vm.cardinalNumbers?vm.cardinalNumbers[n]:/^\d+$/.test(n)?parseInt(n,10):null}static extractOrdinalValue(r){if(r.slotType!==Sl.SlotType.ORDINAL)return null;let n=r.text.toLowerCase();if(n in vm.ordinalNumbers)return vm.ordinalNumbers[n];let i=n.match(/^(\d+)(st|nd|rd|th)$/);return i?parseInt(i[1],10):null}static extractDirectionValue(r){if(r.slotType!==Sl.SlotType.DIRECTION)return null;let n=r.text.toLowerCase();return vm.directionMap[n]||null}static extractTimeValue(r){if(r.slotType!==Sl.SlotType.TIME)return null;let n=r.text.match(/^(\d{1,2}):(\d{2})$/);return n?{hours:parseInt(n[1],10),minutes:parseInt(n[2],10)}:null}};Pv.EnglishGrammarEngine=Ew});var Gq=p(vw=>{"use strict";Object.defineProperty(vw,"__esModule",{value:!0});vw.defineGrammar=pre;var Me=E();function pre(t){t.forAction("if.action.looking").verbs(["look","l"]).build(),t.forAction("if.action.examining").verbs(["examine","x","inspect"]).pattern(":target").build(),t.define("look at :target").mapsTo("if.action.examining").withPriority(95).build(),t.define("look [carefully] at :target").mapsTo("if.action.examining_carefully").withPriority(96).build(),t.define("look [around]").mapsTo("if.action.looking").withPriority(101).build(),t.define("search [carefully]").mapsTo("if.action.searching").withPriority(100).build(),t.define("search :target").mapsTo("if.action.searching").withPriority(100).build(),t.define("look in|inside :target").mapsTo("if.action.searching").withPriority(100).build(),t.define("look through :target").mapsTo("if.action.searching").withPriority(100).build(),t.define("rummage in|through :target").mapsTo("if.action.searching").withPriority(95).build(),t.forAction("if.action.taking").verbs(["take","get","grab"]).pattern(":item").build(),t.define("pick up :item").mapsTo("if.action.taking").withPriority(100).build(),t.forAction("if.action.dropping").verbs(["drop","discard"]).pattern(":item").build(),t.define("put down :item").mapsTo("if.action.dropping").withPriority(100).build(),t.forAction("if.action.eating").verbs(["eat","consume","devour"]).pattern(":item").build(),t.forAction("if.action.drinking").verbs(["drink","sip","quaff"]).pattern(":item").build(),t.define("put :item in|into|inside :container").hasTrait("container",Me.TraitType.CONTAINER).mapsTo("if.action.inserting").withPriority(100).build(),t.define("insert :item in|into :container").hasTrait("container",Me.TraitType.CONTAINER).mapsTo("if.action.inserting").withPriority(100).build(),t.define("put :item on|onto :supporter").hasTrait("supporter",Me.TraitType.SUPPORTER).mapsTo("if.action.putting").withPriority(100).build(),t.define("hang :item on :hook").mapsTo("if.action.putting").withPriority(110).build(),t.forAction("if.action.reading").verbs(["read","peruse","study"]).pattern(":target").build(),t.forAction("if.action.inventory").verbs(["inventory","inv","i"]).build(),t.define("go :direction").where("direction",{type:"direction"}).mapsTo("if.action.going").withPriority(100).build(),t.forAction("if.action.going").directions({north:["north","n"],south:["south","s"],east:["east","e"],west:["west","w"],northeast:["northeast","ne"],northwest:["northwest","nw"],southeast:["southeast","se"],southwest:["southwest","sw"],up:["up","u"],down:["down","d"],in:["in"],out:["out"]}).build(),t.define("open :door").hasTrait("door",Me.TraitType.OPENABLE).mapsTo("if.action.opening").withPriority(100).build(),t.define("close :door").hasTrait("door",Me.TraitType.OPENABLE).mapsTo("if.action.closing").withPriority(100).build(),t.forAction("if.action.switching_on").verbs(["turn","switch","flip"]).pattern("on :device").hasTrait("device",Me.TraitType.SWITCHABLE).build(),t.forAction("if.action.switching_off").verbs(["turn","switch","flip"]).pattern("off :device").hasTrait("device",Me.TraitType.SWITCHABLE).build(),t.define("turn :device on").hasTrait("device",Me.TraitType.SWITCHABLE).mapsTo("if.action.switching_on").build(),t.define("turn :device off").hasTrait("device",Me.TraitType.SWITCHABLE).mapsTo("if.action.switching_off").build(),t.forAction("if.action.pushing").verbs(["push","press","shove","move"]).pattern(":target").build(),t.forAction("if.action.pulling").verbs(["pull","drag","yank"]).pattern(":target").build(),t.forAction("if.action.lowering").verbs(["lower"]).pattern(":target").build(),t.forAction("if.action.raising").verbs(["raise","lift"]).pattern(":target").build(),t.forAction("if.action.waiting").verbs(["wait","z"]).build(),t.define("save").mapsTo("if.action.saving").withPriority(100).build(),t.define("restore").mapsTo("if.action.restoring").withPriority(100).build(),t.define("restart").mapsTo("if.action.restarting").withPriority(100).build(),t.forAction("if.action.quitting").verbs(["quit","q"]).build(),t.define("undo").mapsTo("if.action.undoing").withPriority(100).build(),t.define("score").mapsTo("if.action.scoring").withPriority(100).build(),t.define("version").mapsTo("if.action.version").withPriority(100).build(),t.define("help").mapsTo("if.action.help").withPriority(100).build(),t.define("about").mapsTo("if.action.about").withPriority(100).build(),t.define("info").mapsTo("if.action.about").withPriority(100).build(),t.define("credits").mapsTo("if.action.about").withPriority(100).build(),t.define("trace").mapsTo("author.trace").withPriority(100).build(),t.define("trace on").mapsTo("author.trace").withPriority(100).build(),t.define("trace off").mapsTo("author.trace").withPriority(100).build(),t.define("trace parser on").mapsTo("author.trace").withPriority(100).build(),t.define("trace parser off").mapsTo("author.trace").withPriority(100).build(),t.define("trace validation on").mapsTo("author.trace").withPriority(100).build(),t.define("trace validation off").mapsTo("author.trace").withPriority(100).build(),t.define("trace system on").mapsTo("author.trace").withPriority(100).build(),t.define("trace system off").mapsTo("author.trace").withPriority(100).build(),t.define("trace all on").mapsTo("author.trace").withPriority(100).build(),t.define("trace all off").mapsTo("author.trace").withPriority(100).build(),t.define("give :item to :recipient").hasTrait("recipient",Me.TraitType.ACTOR).mapsTo("if.action.giving").withPriority(100).build(),t.define("give :recipient :item").hasTrait("recipient",Me.TraitType.ACTOR).mapsTo("if.action.giving").withPriority(95).build(),t.define("offer :item to :recipient").hasTrait("recipient",Me.TraitType.ACTOR).mapsTo("if.action.giving").withPriority(100).build(),t.define("show :item to :recipient").hasTrait("recipient",Me.TraitType.ACTOR).mapsTo("if.action.showing").withPriority(100).build(),t.define("show :recipient :item").hasTrait("recipient",Me.TraitType.ACTOR).mapsTo("if.action.showing").withPriority(95).build(),t.define("throw :item at :target").mapsTo("if.action.throwing").withPriority(100).build(),t.define("throw :item to :recipient").mapsTo("if.action.throwing").withPriority(100).build(),t.define("take :item from :container with :tool").mapsTo("if.action.taking_with").withPriority(110).build(),t.define("unlock :door with :key").mapsTo("if.action.unlocking").withPriority(110).build(),t.define("open :container with :tool").hasTrait("container",Me.TraitType.OPENABLE).mapsTo("if.action.opening_with").withPriority(110).build(),t.define("cut :object with :tool").mapsTo("if.action.cutting").withPriority(110).build(),t.forAction("if.action.attacking").verbs(["attack","kill","fight","slay","murder","hit","strike"]).pattern(":target").build(),t.define("attack :target with :weapon").mapsTo("if.action.attacking").withPriority(110).build(),t.define("kill :target with :weapon").mapsTo("if.action.attacking").withPriority(110).build(),t.define("hit :target with :weapon").mapsTo("if.action.attacking").withPriority(110).build(),t.define("strike :target with :weapon").mapsTo("if.action.attacking").withPriority(110).build(),t.define("dig :location with :tool").mapsTo("if.action.digging").withPriority(110).build(),t.define("say :message").mapsTo("if.action.saying").withPriority(100).build(),t.define("say :message to :recipient").hasTrait("recipient",Me.TraitType.ACTOR).mapsTo("if.action.saying_to").withPriority(105).build(),t.define("write :message").mapsTo("if.action.writing").withPriority(100).build(),t.define("write :message on :surface").mapsTo("if.action.writing_on").withPriority(105).build(),t.define("shout :message").mapsTo("if.action.shouting").withPriority(100).build(),t.define("whisper :message to :recipient").hasTrait("recipient",Me.TraitType.ACTOR).mapsTo("if.action.whispering").withPriority(100).build(),t.define("tell :recipient about :topic").hasTrait("recipient",Me.TraitType.ACTOR).mapsTo("if.action.telling").withPriority(100).build(),t.define("ask :recipient about :topic").hasTrait("recipient",Me.TraitType.ACTOR).mapsTo("if.action.asking").withPriority(100).build(),t.forAction("if.action.touching").verbs(["touch","rub","feel","pat","stroke","poke","prod"]).pattern(":target").build(),t.define("enter :portal").hasTrait("portal",Me.TraitType.ENTERABLE).mapsTo("if.action.entering").withPriority(100).build(),t.define("get in :portal").hasTrait("portal",Me.TraitType.ENTERABLE).mapsTo("if.action.entering").withPriority(100).build(),t.define("get into :portal").hasTrait("portal",Me.TraitType.ENTERABLE).mapsTo("if.action.entering").withPriority(100).build(),t.define("climb in :portal").hasTrait("portal",Me.TraitType.ENTERABLE).mapsTo("if.action.entering").withPriority(100).build(),t.define("climb into :portal").hasTrait("portal",Me.TraitType.ENTERABLE).mapsTo("if.action.entering").withPriority(100).build(),t.define("go in :portal").hasTrait("portal",Me.TraitType.ENTERABLE).mapsTo("if.action.entering").withPriority(100).build(),t.define("go into :portal").hasTrait("portal",Me.TraitType.ENTERABLE).mapsTo("if.action.entering").withPriority(100).build(),t.define("exit").mapsTo("if.action.exiting").withPriority(100).build(),t.define("get out").mapsTo("if.action.exiting").withPriority(100).build(),t.define("leave").mapsTo("if.action.exiting").withPriority(95).build(),t.define("climb out").mapsTo("if.action.exiting").withPriority(100).build(),t.define("board :vehicle").hasTrait("vehicle",Me.TraitType.ENTERABLE).mapsTo("if.action.entering").withPriority(100).build(),t.define("get on :vehicle").hasTrait("vehicle",Me.TraitType.ENTERABLE).mapsTo("if.action.entering").withPriority(100).build(),t.define("exit :container").hasTrait("container",Me.TraitType.ENTERABLE).mapsTo("if.action.exiting").withPriority(100).build(),t.define("disembark").mapsTo("if.action.exiting").withPriority(100).build(),t.define("disembark :vehicle").hasTrait("vehicle",Me.TraitType.ENTERABLE).mapsTo("if.action.exiting").withPriority(100).build(),t.define("get off :vehicle").hasTrait("vehicle",Me.TraitType.ENTERABLE).mapsTo("if.action.exiting").withPriority(100).build(),t.define("alight").mapsTo("if.action.exiting").withPriority(95).build(),t.define("again").mapsTo("if.action.again").withPriority(100).build(),t.define("g").mapsTo("if.action.again").withPriority(90).build()}});var Fq=p(Tn=>{"use strict";Object.defineProperty(Tn,"__esModule",{value:!0});Tn.DirectionAbbreviations=Tn.DirectionWords=void 0;Tn.parseDirection=fre;Tn.getDirectionWord=gre;var $e=E();Tn.DirectionWords={north:$e.Direction.NORTH,south:$e.Direction.SOUTH,east:$e.Direction.EAST,west:$e.Direction.WEST,northeast:$e.Direction.NORTHEAST,northwest:$e.Direction.NORTHWEST,southeast:$e.Direction.SOUTHEAST,southwest:$e.Direction.SOUTHWEST,up:$e.Direction.UP,down:$e.Direction.DOWN,in:$e.Direction.IN,inside:$e.Direction.IN,out:$e.Direction.OUT,outside:$e.Direction.OUT};Tn.DirectionAbbreviations={n:$e.Direction.NORTH,s:$e.Direction.SOUTH,e:$e.Direction.EAST,w:$e.Direction.WEST,ne:$e.Direction.NORTHEAST,nw:$e.Direction.NORTHWEST,se:$e.Direction.SOUTHEAST,sw:$e.Direction.SOUTHWEST,u:$e.Direction.UP,d:$e.Direction.DOWN};function fre(t){if(!t)return null;let e=t.toLowerCase().trim();return Tn.DirectionAbbreviations[e]?Tn.DirectionAbbreviations[e]:Tn.DirectionWords[e]?Tn.DirectionWords[e]:null}function gre(t){for(let[e,r]of Object.entries(Tn.DirectionWords))if(r===t){if(t===$e.Direction.IN&&e==="inside"||t===$e.Direction.OUT&&e==="outside")continue;return e}return t.toLowerCase()}});var bw=p(_w=>{"use strict";Object.defineProperty(_w,"__esModule",{value:!0});_w.analyzeBestFailure=hre;function hre(t,e,r){if(t.length===0)return e.trim()?{code:"UNKNOWN_VERB",messageId:"parser.error.unknownVerb",context:{verb:e.split(/\s+/)[0]}}:{code:"NO_VERB",messageId:"parser.error.noInput",context:{}};let i=[...t].sort((o,a)=>a.progress-o.progress)[0];if(i.matchedVerb&&i.slotFailure){let o=i.slotFailure;if(o.reason==="NO_MATCH")return{code:"ENTITY_NOT_FOUND",messageId:"parser.error.entityNotFound",context:{verb:i.matchedVerb,noun:o.unknownWord||o.attemptedText,slot:o.slotName}};if(o.reason==="SCOPE_VIOLATION")return{code:"SCOPE_VIOLATION",messageId:"parser.error.scopeViolation",context:{verb:i.matchedVerb,noun:o.attemptedText,slot:o.slotName}};if(o.reason==="AMBIGUOUS")return{code:"AMBIGUOUS_INPUT",messageId:"parser.error.ambiguous",context:{verb:i.matchedVerb,noun:o.attemptedText,candidates:o.candidates}}}if(i.matchedVerb&&i.reason==="NOT_ENOUGH_TOKENS"){if(i.expected?.startsWith(":")){let o=i.expected.slice(1);return o==="target"||o==="item"||o==="object"?{code:"MISSING_OBJECT",messageId:"parser.error.missingObject",context:{verb:i.matchedVerb}}:{code:"MISSING_INDIRECT",messageId:"parser.error.missingIndirect",context:{verb:i.matchedVerb,slot:o}}}return{code:"MISSING_OBJECT",messageId:"parser.error.missingObject",context:{verb:i.matchedVerb}}}return i.matchedVerb&&i.reason==="SLOT_FAILED"?{code:"MISSING_OBJECT",messageId:"parser.error.missingObject",context:{verb:i.matchedVerb}}:i.matchedVerb&&i.reason==="LEFTOVER_TOKENS"?{code:"INVALID_SYNTAX",messageId:"parser.error.invalidSyntax",context:{verb:i.matchedVerb,extraWords:i.failedAtToken}}:r?{code:"INVALID_SYNTAX",messageId:"parser.error.invalidSyntax",context:{}}:{code:"UNKNOWN_VERB",messageId:"parser.error.unknownVerb",context:{verb:e.split(/\s+/)[0]}}}});var Sw=p(kv=>{"use strict";Object.defineProperty(kv,"__esModule",{value:!0});kv.EnglishParser=void 0;var Ie=jt(),Er=E(),yre=qq(),Tre=Gq(),Iw=Fq(),Ere=bw(),Vq=Rv(),vre={allowPartial:!0,expandAbbreviations:!0,ignoreArticles:!1,minConfidence:.1};function _re(t){switch(t){case Ie.PartOfSpeech.VERB:return Er.PartOfSpeech.VERB;case Ie.PartOfSpeech.NOUN:return Er.PartOfSpeech.NOUN;case Ie.PartOfSpeech.ADJECTIVE:return Er.PartOfSpeech.ADJECTIVE;case Ie.PartOfSpeech.ARTICLE:return Er.PartOfSpeech.ARTICLE;case Ie.PartOfSpeech.PREPOSITION:return Er.PartOfSpeech.PREPOSITION;case Ie.PartOfSpeech.PRONOUN:return Er.PartOfSpeech.PRONOUN;case Ie.PartOfSpeech.SPECIAL:return Er.PartOfSpeech.DETERMINER;default:return Er.PartOfSpeech.UNKNOWN}}var Ow=class{constructor(e,r={}){l(this,"options");l(this,"language");l(this,"onDebugEvent");l(this,"platformEventEmitter");l(this,"grammarEngine");l(this,"worldContext",null);l(this,"pronounContext");this.language=e,this.options={...vre,...r},this.grammarEngine=new yre.EnglishGrammarEngine;let n=this.grammarEngine.createBuilder();(0,Tre.defineGrammar)(n),this.pronounContext=new Vq.PronounContextManager,(0,Vq.setPronounContextManager)(this.pronounContext),this.initializeVocabulary()}initializeVocabulary(){Ie.vocabularyRegistry.clear();let e=(0,Ie.adaptVerbVocabulary)(this.language);Ie.vocabularyRegistry.registerVerbs(e);let r=(0,Ie.adaptDirectionVocabulary)(this.language);Ie.vocabularyRegistry.registerDirections(r);let n=(0,Ie.adaptSpecialVocabulary)(this.language);Ie.vocabularyRegistry.registerSpecial(n);let i=this.language.getPrepositions();Ie.vocabularyRegistry.registerPrepositions(i);let o=this.language.getDeterminers();Ie.vocabularyRegistry.registerDeterminers(o);let a=this.language.getConjunctions();Ie.vocabularyRegistry.registerConjunctions(a);let s=this.language.getNumbers();Ie.vocabularyRegistry.registerNumbers(s)}setDebugCallback(e){this.onDebugEvent=e}setPlatformEventEmitter(e){this.platformEventEmitter=e}setWorldContext(e,r,n){this.worldContext={world:e,actorId:r,currentLocation:n}}emitPlatformEvent(e,r){this.platformEventEmitter&&this.platformEventEmitter({id:`parser_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),type:`platform.parser.${e}`,entities:{},payload:{subsystem:"parser",...r},tags:["platform","parser","debug"],priority:0,narrate:!1})}registerVerbs(e){Ie.vocabularyRegistry.registerDynamicVerbs(e,"story")}registerVocabulary(e){let r=[];for(let n of e)if(n.partOfSpeech===Ie.PartOfSpeech.VERB){let i=r.find(o=>o.actionId===n.mapsTo);i||(i={actionId:n.mapsTo,verbs:[],pattern:n.metadata?.pattern,prepositions:n.metadata?.prepositions},r.push(i)),i.verbs.push(n.word)}r.length>0&&this.registerVerbs(r)}parse(e){this.emitPlatformEvent("parse_start",{input:e});let r=this.tokenizeRich(e);if(this.emitPlatformEvent("tokenize_complete",{input:e,tokens:r.map(a=>({word:a.word,normalized:a.normalized,partOfSpeech:a.partOfSpeech,candidateCount:a.candidates.length}))}),this.onDebugEvent){let a=r.filter(s=>s.partOfSpeech.includes(Er.PartOfSpeech.UNKNOWN)||s.candidates.length===0).map(s=>s.word);this.onDebugEvent({id:`parser_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),subsystem:"parser",type:"tokenize",data:{input:e,tokens:r.map(s=>({word:s.word,normalized:s.normalized,position:s.position,length:s.length,partOfSpeech:s.partOfSpeech,candidateCount:s.candidates.length})),unknownWords:a}})}let n=this.findCommandStructures(r,e);if(this.emitPlatformEvent("pattern_matching_complete",{input:e,candidateCount:n.length,patterns:n.map(a=>({pattern:a.pattern,action:a.action,confidence:a.confidence}))}),this.onDebugEvent&&this.onDebugEvent({id:`parser_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),subsystem:"parser",type:"pattern_match",data:{input:e,patternsAttempted:n.map(a=>({name:a.pattern,matched:!0,confidence:a.confidence})),totalCandidates:n.length}}),n.length===0){let a=this.grammarEngine.getLastFailures(),s=r.some(u=>u.partOfSpeech.includes(Er.PartOfSpeech.VERB)),c=(0,Ere.analyzeBestFailure)(a,e,s);return this.emitPlatformEvent("parse_failed",{input:e,reason:"no_matching_patterns",tokenCount:r.length,hadVerb:s,errorCode:c.code,errorContext:c.context}),this.onDebugEvent&&this.onDebugEvent({id:`parser_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),subsystem:"parser",type:"parse_error",data:{input:e,errorType:c.code,errorDetails:{messageId:c.messageId,context:c.context,hadTokens:r.length>0,hadVerb:s,failureCount:a.length}}}),{success:!1,error:this.buildParseError(e,c)}}n.sort((a,s)=>s.confidence-a.confidence);let i=n[0];this.onDebugEvent&&this.onDebugEvent({id:`parser_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),subsystem:"parser",type:"candidate_selection",data:{input:e,candidates:n.map((a,s)=>({action:a.action,pattern:a.pattern,confidence:a.confidence,selected:s===0})),selectionReason:n.length===1?"only_candidate":"highest_confidence"}});let o={rawInput:e,tokens:i.tokens,structure:{verb:i.verb,directObject:i.directObject,preposition:i.preposition,indirectObject:i.indirectObject},pattern:i.pattern,confidence:i.confidence,action:i.action,textSlots:i.textSlots,instrument:i.instrument,excluded:i.excluded,vocabularySlots:i.vocabularySlots,manner:i.manner};if(i.direction){let a=(0,Iw.parseDirection)(i.direction);o.extras={direction:a||i.direction}}else if(i.extras){let a={...i.extras};if(a.direction&&typeof a.direction=="string"){let s=(0,Iw.parseDirection)(a.direction);s&&(a.direction=s)}o.extras=a}return this.emitPlatformEvent("parse_success",{input:e,action:o.action,pattern:o.pattern,confidence:o.confidence,structure:{verb:o.structure.verb?.text,directObject:o.structure.directObject?.text,preposition:o.structure.preposition?.text,indirectObject:o.structure.indirectObject?.text}}),{success:!0,value:o}}parseChain(e){let r=this.splitOnPeriods(e),n=[];for(let i of r){let o=this.splitOnCommasIfChain(i);n.push(...o)}return n.map(i=>this.parse(i))}splitOnCommasIfChain(e){let r=new Map,n=e,i=0;n=n.replace(/"[^"]*"/g,u=>{let m=`__COMMA_QUOTE_${i++}__`;return r.set(m,u),m}),n=n.replace(/'[^']*'/g,u=>{let m=`__COMMA_QUOTE_${i++}__`;return r.set(m,u),m});let o=n.indexOf(",");if(o===-1)return[e];let s=n.slice(o+1).trim().match(/^(\w+)/);if(!s)return[e];let c=s[1].toLowerCase();if(Ie.vocabularyRegistry.hasWord(c,Ie.PartOfSpeech.VERB)){let u=n.split(","),m=[];for(let f of u){let g=f;for(let[y,T]of r)g=g.replace(y,T);let h=g.trim();h.length>0&&m.push(h)}return m}return[e]}splitOnPeriods(e){let r=new Map,n=e,i=0;n=n.replace(/"[^"]*"/g,s=>{let c=`__PERIOD_QUOTE_${i++}__`;return r.set(c,s),c}),n=n.replace(/'[^']*'/g,s=>{let c=`__PERIOD_QUOTE_${i++}__`;return r.set(c,s),c});let o=n.split("."),a=[];for(let s of o){let c=s;for(let[u,m]of r)c=c.replace(u,m);let d=c.trim();d.length>0&&a.push(d)}return a}tokenizeRich(e){let r=[],n=0,i=[],o=e,a=/"([^"]*)"/g,s,c=0;for(;(s=a.exec(e))!==null;){let u=`__QUOTE_${c}__`,m=s[1],f=s.index;i.push({placeholder:u,content:m,position:f}),o=o.replace(s[0],u),c++}let d=o.trim().split(/(\s+)/);for(let u of d){if(/^\s+$/.test(u)){n+=u.length;continue}let m=i.find(T=>T.placeholder===u);if(m){r.push({word:`"${m.content}"`,normalized:m.content.toLowerCase(),position:n,length:m.content.length+2,partOfSpeech:[Er.PartOfSpeech.NOUN],candidates:[{id:"quoted_string",type:"noun",confidence:1}]}),n+=u.length;continue}let f=u.toLowerCase(),g=this.getTokenCandidates(f),h=g.map(T=>({id:T.mapsTo,type:T.partOfSpeech,confidence:T.priority||1})),y=Array.from(new Set(g.map(T=>_re(T.partOfSpeech))));y.length===0&&y.push(Er.PartOfSpeech.UNKNOWN),r.push({word:u,normalized:f,position:n,length:u.length,partOfSpeech:y,candidates:h}),n+=u.length}return r}findCommandStructures(e,r){let n={world:this.worldContext?.world||null,actorId:this.worldContext?.actorId||"player",currentLocation:this.worldContext?.currentLocation||"current",slots:new Map},i=e.map(s=>({word:s.word,normalized:s.normalized,position:s.position,candidates:s.candidates.map(c=>({partOfSpeech:c.type,mapsTo:c.id,priority:c.confidence||0}))})),o=this.grammarEngine.findMatches(i,n),a=[];for(let s of o){let c=this.convertGrammarMatch(s,e);c?a.push(c):r.includes("throw")&&console.log("Failed to convert match:",s.rule.pattern)}return a}convertGrammarMatch(e,r){let n=e.rule,i=[],o=0;for(let k=0;k<r.length&&r[k].partOfSpeech.includes(Er.PartOfSpeech.VERB);k++)i.push(k),o=k+1;let a={tokens:i,text:i.map(k=>r[k].word).join(" "),head:i.length>0?r[i[0]].normalized:""},s=Array.from(e.slots.entries());s.sort((k,w)=>(k[1].tokens[0]||0)-(w[1].tokens[0]||0));let c,d,u,m={},f=n.pattern.split(/\s+/),g={},h=0;for(let k of f)if(k.startsWith(":")){let w=k.substring(1);g[w]=h++}let y,T,I,A,L;for(let[k,w]of s){let Te=w.tokens.map(le=>r[le]),Oe=w.slotType;if(Oe===Ie.SlotType.TEXT||Oe===Ie.SlotType.TEXT_GREEDY){y||(y=new Map),y.set(k,w.text);continue}if(Oe===Ie.SlotType.VOCABULARY){let le=w;A||(A=new Map),A.set(k,{word:le.matchedWord||w.text.toLowerCase(),category:le.category||""});continue}if(Oe===Ie.SlotType.MANNER){L=w.manner||w.text.toLowerCase();continue}if(Oe===Ie.SlotType.DIRECTION){let le=w.text.toLowerCase(),Be=(0,Iw.parseDirection)(le);m.direction=Be||le;continue}let ue={tokens:w.tokens,text:w.text,head:Te[Te.length-1]?.normalized||w.text,modifiers:[],articles:[],determiners:[],candidates:[w.text]},mt=w;if(mt.isAll&&(ue.isAll=!0,mt.excluded&&mt.excluded.length>0&&(I=mt.excluded.map(le=>({tokens:le.tokens,text:le.text,head:le.text.split(" ").pop()||le.text,modifiers:[],articles:[],determiners:[],candidates:[le.text]})))),mt.isList&&mt.items&&(ue.isList=!0,ue.items=mt.items.map(le=>({tokens:le.tokens,text:le.text,head:le.text.split(" ").pop()||le.text,modifiers:[],articles:[],determiners:[],candidates:[le.text],entityId:le.entityId}))),mt.entityId&&(ue.entityId=mt.entityId),mt.isPronoun&&(ue.wasPronoun=!0),Oe===Ie.SlotType.INSTRUMENT){T=ue;continue}if(n.pattern.includes(" with :"+k))m[k]=ue;else if(n.pattern.includes("give :recipient :item"))k==="item"?c=ue:k==="recipient"&&(u=ue);else if(n.pattern.includes("give :item to :recipient"))k==="item"?c=ue:k==="recipient"&&(u=ue);else if(n.pattern.includes("show :recipient :item"))k==="item"?c=ue:k==="recipient"&&(u=ue);else if(n.pattern.includes("show :item to :recipient"))k==="item"?c=ue:k==="recipient"&&(u=ue);else if(n.pattern.includes(":item from :container"))k==="item"?c=ue:k==="container"&&(u=ue);else{let le=g[k];le===0&&!c?c=ue:le===1&&!u?u=ue:m[k]||(m[k]=ue)}}if(c&&u){let k=c.tokens[c.tokens.length-1],w=u.tokens[0];for(let Te=k+1;Te<w;Te++)if(r[Te].partOfSpeech.includes(Er.PartOfSpeech.PREPOSITION)){d={tokens:[Te],text:r[Te].word};break}}if(n.action==="if.action.going"&&!c){let k=r.find(w=>w.candidates.some(Te=>Te.type===Ie.PartOfSpeech.DIRECTION)||["north","south","east","west","up","down","in","out","n","s","e","w","u","d"].includes(w.normalized));if(k)return{tokens:r,verb:a,pattern:"DIRECTION_ONLY",confidence:e.confidence,action:n.action,direction:k.normalized}}let S="VERB_ONLY";c&&u?d?S="VERB_NOUN_PREP_NOUN":S="VERB_NOUN_NOUN":c&&(S="VERB_NOUN");let R={tokens:r,verb:a,directObject:c,preposition:d,indirectObject:u,pattern:S,confidence:e.confidence,action:n.action,textSlots:y,instrument:T,excluded:I,vocabularySlots:A,manner:L};return Object.keys(m).length>0&&(R.extras=m),R}registerGrammar(e,r,n){let i=this.grammarEngine.createBuilder().define(e).mapsTo(r);if(n)for(let[o,a]of Object.entries(n))i.where(o,a);i.build()}getStoryGrammar(){return this.grammarEngine.createBuilder()}getTokenCandidates(e){return Ie.vocabularyRegistry.lookup(e).map(n=>({partOfSpeech:n.partOfSpeech,mapsTo:n.mapsTo,priority:n.priority||0,source:n.source,metadata:n.metadata}))}tokenize(e){return this.tokenizeRich(e).map(n=>({word:n.word,normalized:n.normalized,position:n.position,candidates:this.getTokenCandidates(n.normalized)}))}parseWithErrors(e,r){let n={...this.options,...r},i=this.tokenizeRich(e),o=[];for(let d of i)d.partOfSpeech.includes(Er.PartOfSpeech.UNKNOWN)&&d.candidates.length===0&&o.push({type:Ie.ParseErrorType.UNKNOWN_WORD,message:`Unknown word: ${d.word}`,words:[d.word],position:d.position});let a=o.length>0;if(!(!a||n.allowPartial))return{candidates:[],errors:o,partial:!1};let c=this.parse(e);if(c.success){let d={action:c.value.action,originalInput:e,tokens:this.tokenize(e),pattern:c.value.pattern,confidence:c.value.confidence};c.value.structure.directObject&&(d.nounText=c.value.structure.directObject.text,d.nounCandidates=c.value.structure.directObject.candidates),c.value.structure.preposition&&(d.preposition=c.value.structure.preposition.text),c.value.structure.indirectObject&&(d.secondNounText=c.value.structure.indirectObject.text,d.secondNounCandidates=c.value.structure.indirectObject.candidates);let u=d.confidence||0;return{candidates:n.minConfidence!==void 0&&u<n.minConfidence?[]:[d],errors:o,partial:a&&n.allowPartial===!0}}else{if(o.length>0)return{candidates:[],errors:o,partial:n.allowPartial===!0};let d={type:Ie.ParseErrorType.PATTERN_MISMATCH,message:c.error.message,position:c.error.position};return{candidates:[],errors:[d],partial:!1}}}addVerb(e,r,n,i){let o={actionId:e,verbs:r,pattern:n||"VERB_ONLY",prepositions:i};Ie.vocabularyRegistry.registerDynamicVerbs([o],"story");let a=this.grammarEngine.createBuilder();for(let s of r)if(n==="VERB_OBJ"||n==="VERB_NOUN")a.define(`${s} :object`).mapsTo(e).withPriority(150).build();else if(n==="VERB_PREP_NOUN"&&i)for(let c of i)a.define(`${s} ${c} :object`).mapsTo(e).withPriority(150).build();else if(n==="VERB_NOUN_PREP_NOUN"&&i)for(let c of i)a.define(`${s} :object1 ${c} :object2`).mapsTo(e).withPriority(150).build();else a.define(s).mapsTo(e).withPriority(150).build();this.onDebugEvent&&this.onDebugEvent({id:`parser_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),subsystem:"parser",type:"vocabulary.add_verb",data:{actionId:e,verbs:r,pattern:n,prepositions:i}})}addNoun(e,r){this.onDebugEvent&&this.onDebugEvent({id:`parser_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),subsystem:"parser",type:"vocabulary.add_noun",data:{word:e,canonical:r}})}addAdjective(e){this.onDebugEvent&&this.onDebugEvent({id:`parser_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),subsystem:"parser",type:"vocabulary.add_adjective",data:{word:e}})}addPreposition(e){Ie.vocabularyRegistry.registerPrepositions([e]);let r=this.grammarEngine.createBuilder();r.define(`put :object ${e} :location`).mapsTo("if.action.putting").withPriority(150).build(),r.define(`place :object ${e} :location`).mapsTo("if.action.putting").withPriority(150).build(),this.onDebugEvent&&this.onDebugEvent({id:`parser_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,timestamp:Date.now(),subsystem:"parser",type:"vocabulary.add_preposition",data:{word:e}})}buildParseError(e,r){let{code:n,messageId:i,context:o}=r,a;switch(n){case"NO_VERB":a="I beg your pardon?";break;case"UNKNOWN_VERB":a=o.verb?`I don't know the verb "${o.verb}".`:"I don't understand that sentence.";break;case"MISSING_OBJECT":a=o.verb?`What do you want to ${o.verb}?`:"What do you want to do that to?";break;case"MISSING_INDIRECT":a=o.verb?`${bre(o.verb)} it where?`:"Where do you want to do that?";break;case"ENTITY_NOT_FOUND":a=o.noun?`I don't see any "${o.noun}" here.`:"I don't see that here.";break;case"SCOPE_VIOLATION":a=o.noun?`You can't reach the ${o.noun}.`:"You can't reach that.";break;case"AMBIGUOUS_INPUT":a=o.noun?`Which ${o.noun} do you mean?`:"Which do you mean?";break;default:a="I don't understand that."}return{type:"PARSE_ERROR",code:n,messageId:i,message:a,input:e,verb:o.verb,failedWord:o.noun||o.verb,slot:o.slot}}updatePronounContext(e,r){this.worldContext?.world&&this.pronounContext.updateFromCommand(e,this.worldContext.world,r)}registerPronounEntity(e,r,n){this.worldContext?.world&&this.pronounContext.registerEntity(e,r,this.worldContext.world,n)}resetPronounContext(){this.pronounContext.reset()}getLastCommand(){return this.pronounContext.getLastCommand()}getPronounContextManager(){return this.pronounContext}};kv.EnglishParser=Ow;function bre(t){return t.charAt(0).toUpperCase()+t.slice(1)}});var Yq=p(vt=>{"use strict";Object.defineProperty(vt,"__esModule",{value:!0});vt.metadata=vt.INANIMATE_THEM=vt.INANIMATE_IT=vt.RECOGNIZED_PRONOUNS=vt.isRecognizedPronoun=vt.PronounContextManager=vt.analyzeBestFailure=vt.Parser=vt.EnglishParser=void 0;var Ire=Sw();Object.defineProperty(vt,"EnglishParser",{enumerable:!0,get:function(){return Ire.EnglishParser}});var Ore=Sw();Object.defineProperty(vt,"Parser",{enumerable:!0,get:function(){return Ore.EnglishParser}});var Sre=bw();Object.defineProperty(vt,"analyzeBestFailure",{enumerable:!0,get:function(){return Sre.analyzeBestFailure}});var _m=Rv();Object.defineProperty(vt,"PronounContextManager",{enumerable:!0,get:function(){return _m.PronounContextManager}});Object.defineProperty(vt,"isRecognizedPronoun",{enumerable:!0,get:function(){return _m.isRecognizedPronoun}});Object.defineProperty(vt,"RECOGNIZED_PRONOUNS",{enumerable:!0,get:function(){return _m.RECOGNIZED_PRONOUNS}});Object.defineProperty(vt,"INANIMATE_IT",{enumerable:!0,get:function(){return _m.INANIMATE_IT}});Object.defineProperty(vt,"INANIMATE_THEM",{enumerable:!0,get:function(){return _m.INANIMATE_THEM}});vt.metadata={languageCode:"en-US",languageName:"English (United States)",parserVersion:"1.0.0",supportedPatterns:["VERB_ONLY","VERB_NOUN","VERB_PREP_NOUN","VERB_NOUN_PREP_NOUN","DIRECTION_ONLY"],features:["compound-verbs","articles","adjectives","abbreviations","multi-word-nouns"]}});var zq=p((Abe,Bv)=>{var Aw=(function(){var t=String.fromCharCode,e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$",n={};function i(a,s){if(!n[a]){n[a]={};for(var c=0;c<a.length;c++)n[a][a.charAt(c)]=c}return n[a][s]}var o={compressToBase64:function(a){if(a==null)return"";var s=o._compress(a,6,function(c){return e.charAt(c)});switch(s.length%4){default:case 0:return s;case 1:return s+"===";case 2:return s+"==";case 3:return s+"="}},decompressFromBase64:function(a){return a==null?"":a==""?null:o._decompress(a.length,32,function(s){return i(e,a.charAt(s))})},compressToUTF16:function(a){return a==null?"":o._compress(a,15,function(s){return t(s+32)})+" "},decompressFromUTF16:function(a){return a==null?"":a==""?null:o._decompress(a.length,16384,function(s){return a.charCodeAt(s)-32})},compressToUint8Array:function(a){for(var s=o.compress(a),c=new Uint8Array(s.length*2),d=0,u=s.length;d<u;d++){var m=s.charCodeAt(d);c[d*2]=m>>>8,c[d*2+1]=m%256}return c},decompressFromUint8Array:function(a){if(a==null)return o.decompress(a);for(var s=new Array(a.length/2),c=0,d=s.length;c<d;c++)s[c]=a[c*2]*256+a[c*2+1];var u=[];return s.forEach(function(m){u.push(t(m))}),o.decompress(u.join(""))},compressToEncodedURIComponent:function(a){return a==null?"":o._compress(a,6,function(s){return r.charAt(s)})},decompressFromEncodedURIComponent:function(a){return a==null?"":a==""?null:(a=a.replace(/ /g,"+"),o._decompress(a.length,32,function(s){return i(r,a.charAt(s))}))},compress:function(a){return o._compress(a,16,function(s){return t(s)})},_compress:function(a,s,c){if(a==null)return"";var d,u,m={},f={},g="",h="",y="",T=2,I=3,A=2,L=[],S=0,R=0,k;for(k=0;k<a.length;k+=1)if(g=a.charAt(k),Object.prototype.hasOwnProperty.call(m,g)||(m[g]=I++,f[g]=!0),h=y+g,Object.prototype.hasOwnProperty.call(m,h))y=h;else{if(Object.prototype.hasOwnProperty.call(f,y)){if(y.charCodeAt(0)<256){for(d=0;d<A;d++)S=S<<1,R==s-1?(R=0,L.push(c(S)),S=0):R++;for(u=y.charCodeAt(0),d=0;d<8;d++)S=S<<1|u&1,R==s-1?(R=0,L.push(c(S)),S=0):R++,u=u>>1}else{for(u=1,d=0;d<A;d++)S=S<<1|u,R==s-1?(R=0,L.push(c(S)),S=0):R++,u=0;for(u=y.charCodeAt(0),d=0;d<16;d++)S=S<<1|u&1,R==s-1?(R=0,L.push(c(S)),S=0):R++,u=u>>1}T--,T==0&&(T=Math.pow(2,A),A++),delete f[y]}else for(u=m[y],d=0;d<A;d++)S=S<<1|u&1,R==s-1?(R=0,L.push(c(S)),S=0):R++,u=u>>1;T--,T==0&&(T=Math.pow(2,A),A++),m[h]=I++,y=String(g)}if(y!==""){if(Object.prototype.hasOwnProperty.call(f,y)){if(y.charCodeAt(0)<256){for(d=0;d<A;d++)S=S<<1,R==s-1?(R=0,L.push(c(S)),S=0):R++;for(u=y.charCodeAt(0),d=0;d<8;d++)S=S<<1|u&1,R==s-1?(R=0,L.push(c(S)),S=0):R++,u=u>>1}else{for(u=1,d=0;d<A;d++)S=S<<1|u,R==s-1?(R=0,L.push(c(S)),S=0):R++,u=0;for(u=y.charCodeAt(0),d=0;d<16;d++)S=S<<1|u&1,R==s-1?(R=0,L.push(c(S)),S=0):R++,u=u>>1}T--,T==0&&(T=Math.pow(2,A),A++),delete f[y]}else for(u=m[y],d=0;d<A;d++)S=S<<1|u&1,R==s-1?(R=0,L.push(c(S)),S=0):R++,u=u>>1;T--,T==0&&(T=Math.pow(2,A),A++)}for(u=2,d=0;d<A;d++)S=S<<1|u&1,R==s-1?(R=0,L.push(c(S)),S=0):R++,u=u>>1;for(;;)if(S=S<<1,R==s-1){L.push(c(S));break}else R++;return L.join("")},decompress:function(a){return a==null?"":a==""?null:o._decompress(a.length,32768,function(s){return a.charCodeAt(s)})},_decompress:function(a,s,c){var d=[],u,m=4,f=4,g=3,h="",y=[],T,I,A,L,S,R,k,w={val:c(0),position:s,index:1};for(T=0;T<3;T+=1)d[T]=T;for(A=0,S=Math.pow(2,2),R=1;R!=S;)L=w.val&w.position,w.position>>=1,w.position==0&&(w.position=s,w.val=c(w.index++)),A|=(L>0?1:0)*R,R<<=1;switch(u=A){case 0:for(A=0,S=Math.pow(2,8),R=1;R!=S;)L=w.val&w.position,w.position>>=1,w.position==0&&(w.position=s,w.val=c(w.index++)),A|=(L>0?1:0)*R,R<<=1;k=t(A);break;case 1:for(A=0,S=Math.pow(2,16),R=1;R!=S;)L=w.val&w.position,w.position>>=1,w.position==0&&(w.position=s,w.val=c(w.index++)),A|=(L>0?1:0)*R,R<<=1;k=t(A);break;case 2:return""}for(d[3]=k,I=k,y.push(k);;){if(w.index>a)return"";for(A=0,S=Math.pow(2,g),R=1;R!=S;)L=w.val&w.position,w.position>>=1,w.position==0&&(w.position=s,w.val=c(w.index++)),A|=(L>0?1:0)*R,R<<=1;switch(k=A){case 0:for(A=0,S=Math.pow(2,8),R=1;R!=S;)L=w.val&w.position,w.position>>=1,w.position==0&&(w.position=s,w.val=c(w.index++)),A|=(L>0?1:0)*R,R<<=1;d[f++]=t(A),k=f-1,m--;break;case 1:for(A=0,S=Math.pow(2,16),R=1;R!=S;)L=w.val&w.position,w.position>>=1,w.position==0&&(w.position=s,w.val=c(w.index++)),A|=(L>0?1:0)*R,R<<=1;d[f++]=t(A),k=f-1,m--;break;case 2:return y.join("")}if(m==0&&(m=Math.pow(2,g),g++),d[k])h=d[k];else if(k===f)h=I+I.charAt(0);else return null;y.push(h),d[f++]=I+h.charAt(0),m--,I=h,m==0&&(m=Math.pow(2,g),g++)}}};return o})();typeof define=="function"&&define.amd?define(function(){return Aw}):typeof Bv<"u"&&Bv!=null?Bv.exports=Aw:typeof angular<"u"&&angular!=null&&angular.module("LZString",[]).factory("LZString",function(){return Aw})});var Iz=p(bz=>{"use strict";Object.defineProperty(bz,"__esModule",{value:!0})});var zL=p(Eb=>{"use strict";Object.defineProperty(Eb,"__esModule",{value:!0});Eb.createSeededRandom=void 0;var lle=Ve();Object.defineProperty(Eb,"createSeededRandom",{enumerable:!0,get:function(){return lle.createSeededRandom}})});var KL=p(fp=>{"use strict";Object.defineProperty(fp,"__esModule",{value:!0});fp.SchedulerService=void 0;fp.createSchedulerService=mle;var ule=zL(),vb=class{constructor(e){l(this,"daemons",new Map);l(this,"daemonStates",new Map);l(this,"fuses",new Map);l(this,"fuseStates",new Map);l(this,"random");l(this,"currentTurn",0);this.random=(0,ule.createSeededRandom)(e)}registerDaemon(e){if(this.daemons.has(e.id))throw new Error(`Daemon with id "${e.id}" already exists`);this.daemons.set(e.id,e),this.daemonStates.set(e.id,{id:e.id,isPaused:!1,runCount:0})}removeDaemon(e){this.daemons.delete(e),this.daemonStates.delete(e)}pauseDaemon(e){let r=this.daemonStates.get(e);r&&(r.isPaused=!0)}resumeDaemon(e){let r=this.daemonStates.get(e);r&&(r.isPaused=!1)}hasDaemon(e){return this.daemons.has(e)}setFuse(e){let r={...e,originalTurns:e.originalTurns??e.turns};this.fuses.set(e.id,r),this.fuseStates.set(e.id,{id:e.id,turnsRemaining:e.turns,isPaused:!1,entityId:e.entityId,skipNextTick:!0})}cancelFuse(e){let r=this.fuses.get(e),n=this.fuseStates.get(e);if(!r||!n)return[];let i=[];if(r.onCancel){let o=this.createContext(void 0,this.currentTurn,"");try{i=r.onCancel(o)}catch(a){console.error(`Error in fuse "${e}" onCancel:`,a)}}return this.fuses.delete(e),this.fuseStates.delete(e),i}getFuseRemaining(e){return this.fuseStates.get(e)?.turnsRemaining}adjustFuse(e,r){let n=this.fuseStates.get(e);n&&(n.turnsRemaining=Math.max(0,n.turnsRemaining+r))}pauseFuse(e){let r=this.fuseStates.get(e);r&&(r.isPaused=!0)}resumeFuse(e){let r=this.fuseStates.get(e);r&&(r.isPaused=!1)}hasFuse(e){return this.fuses.has(e)}tick(e,r,n){this.currentTurn=r;let i=[],o=[],a=[],s=e.getLocation(n)||"",c=this.createContext(e,r,s,n),d=this.getSortedDaemons();for(let f of d){let g=this.daemonStates.get(f.id);if(!(!g||g.isPaused)&&!(f.condition&&!f.condition(c)))try{let h=f.run(c);h.length>0&&(i.push(...h),a.push(f.id),g.runCount++,f.runOnce&&this.removeDaemon(f.id))}catch(h){console.error(`Error running daemon "${f.id}":`,h)}}let u=[],m=this.getSortedFuses();for(let f of m){let g=this.fuseStates.get(f.id);if(!(!g||g.isPaused)){if(g.skipNextTick){g.skipNextTick=!1;continue}if(!(f.tickCondition&&!f.tickCondition(c))&&(g.turnsRemaining--,g.turnsRemaining<=0))try{let h=f.trigger(c);i.push(...h),o.push(f.id),f.repeat&&f.originalTurns?g.turnsRemaining=f.originalTurns:u.push(f.id)}catch(h){console.error(`Error triggering fuse "${f.id}":`,h),u.push(f.id)}}}for(let f of u)this.fuses.delete(f),this.fuseStates.delete(f);return{events:i,fusesTriggered:o,daemonsRun:a}}getActiveDaemons(){let e=[];for(let[r,n]of this.daemons){let i=this.daemonStates.get(r);i&&e.push({id:n.id,name:n.name,isPaused:i.isPaused,runCount:i.runCount,priority:n.priority??0})}return e.sort((r,n)=>n.priority-r.priority)}getActiveFuses(){let e=[];for(let[r,n]of this.fuses){let i=this.fuseStates.get(r);i&&e.push({id:n.id,name:n.name,turnsRemaining:i.turnsRemaining,isPaused:i.isPaused,entityId:i.entityId,priority:n.priority??0,repeat:n.repeat??!1})}return e.sort((r,n)=>n.priority-r.priority)}getState(){let e=[],r=[];for(let n of this.daemonStates.values()){let o=this.daemons.get(n.id)?.getRunnerState?.();e.push({...n,...o!==void 0?{runnerState:o}:{}})}for(let n of this.fuseStates.values())r.push({...n});return{turn:this.currentTurn,daemons:e,fuses:r,randomSeed:this.random.getSeed()}}setState(e){this.currentTurn=e.turn,this.random.setSeed(e.randomSeed);for(let r of e.daemons)this.daemons.has(r.id)&&(this.daemonStates.set(r.id,{...r}),r.runnerState&&this.daemons.get(r.id)?.restoreRunnerState?.(r.runnerState));for(let r of e.fuses)this.fuses.has(r.id)&&this.fuseStates.set(r.id,{...r})}cleanupEntity(e){let r=[];for(let[n,i]of this.fuseStates)i.entityId===e&&r.push(...this.cancelFuse(n));return r}getRandom(){return this.random}createContext(e,r,n,i){return{world:e,turn:r,random:this.random,playerLocation:n,playerId:i||""}}getSortedDaemons(){return Array.from(this.daemons.values()).sort((e,r)=>(r.priority??0)-(e.priority??0))}getSortedFuses(){return Array.from(this.fuses.values()).sort((e,r)=>(r.priority??0)-(e.priority??0))}};fp.SchedulerService=vb;function mle(t){return new vb(t)}});var Oz=p(_b=>{"use strict";Object.defineProperty(_b,"__esModule",{value:!0});_b.SchedulerPlugin=void 0;var ple=KL(),$L=class{constructor(e){l(this,"id","sharpee.plugin.scheduler");l(this,"priority",50);l(this,"service");this.service=(0,ple.createSchedulerService)(e)}onAfterAction(e){return this.service.tick(e.world,e.turn,e.playerId).events}getState(){return this.service.getState()}setState(e){this.service.setState(e)}getScheduler(){return this.service}};_b.SchedulerPlugin=$L});var Sz=p(So=>{"use strict";var fle=So&&So.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),bb=So&&So.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&fle(e,t,r)};Object.defineProperty(So,"__esModule",{value:!0});bb(Iz(),So);bb(zL(),So);bb(KL(),So);bb(Oz(),So)});var Az=p(Ib=>{"use strict";Object.defineProperty(Ib,"__esModule",{value:!0});Ib.NpcPlugin=void 0;var QL=zi(),XL=class{constructor(){l(this,"id","sharpee.plugin.npc");l(this,"priority",100);l(this,"service");this.service=(0,QL.createNpcService)(),this.service.registerBehavior(QL.guardBehavior),this.service.registerBehavior(QL.passiveBehavior)}onAfterAction(e){return this.service.tick({world:e.world,turn:e.turn,random:e.random,playerLocation:e.playerLocation,playerId:e.playerId})}getState(){return{}}setState(e){}getNpcService(){return this.service}};Ib.NpcPlugin=XL});var Rz=p(Sd=>{"use strict";var gle=Sd&&Sd.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),hle=Sd&&Sd.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&gle(e,t,r)};Object.defineProperty(Sd,"__esModule",{value:!0});hle(Az(),Sd)});var wz=p(Cz=>{"use strict";Object.defineProperty(Cz,"__esModule",{value:!0})});var Ab=p(Sb=>{"use strict";Object.defineProperty(Sb,"__esModule",{value:!0});Sb.evaluateGuard=Ob;Sb.resolveRef=au;function Ob(t,e,r,n){switch(t.type){case"entity":return yle(t,e,r);case"state":return e.getStateValue(t.key)===t.value;case"location":return Tle(t,e,r,n);case"inventory":return Ele(t,e,r,n);case"and":return t.conditions.every(i=>Ob(i,e,r,n));case"or":return t.conditions.some(i=>Ob(i,e,r,n));case"not":return!t.conditions.every(i=>Ob(i,e,r,n));case"custom":return t.evaluate(e,r,n)}}function yle(t,e,r){let n=au(t.entityRef,r),i=e.getEntity(n);if(!i)return!1;let o=i.getTrait(t.trait);return o?o[t.property]===t.value:!1}function Tle(t,e,r,n){let i=t.actorRef?au(t.actorRef,r):n,o=au(t.roomRef,r);return e.getLocation(i)===o}function Ele(t,e,r,n){let i=t.actorRef?au(t.actorRef,r):n,o=au(t.entityRef,r);return e.getLocation(o)===i}function au(t,e){if(t.startsWith("$")){let r=e[t];if(!r)throw new Error(`Unresolved binding: ${t}`);return r}return t}});var eM=p(JL=>{"use strict";Object.defineProperty(JL,"__esModule",{value:!0});JL.executeEffects=vle;var gp=Ab(),ZL=0;function vle(t,e,r,n,i){let o=[];for(let a of t){let s=_le(a,e,r,n,i);o.push(...s)}return o}function _le(t,e,r,n,i){switch(t.type){case"move":{let o=(0,gp.resolveRef)(t.entityRef,r),a=(0,gp.resolveRef)(t.destinationRef,r);return e.moveEntity(o,a),[Rb("sm.entity_moved",i,{entityId:o,destination:a})]}case"remove":{let o=(0,gp.resolveRef)(t.entityRef,r);return e.removeEntity(o),[Rb("sm.entity_removed",i,{entityId:o})]}case"set_trait":{let o=(0,gp.resolveRef)(t.entityRef,r),a=e.getEntity(o);if(a){let s=a.getTrait(t.trait);s&&(s[t.property]=t.value)}return[]}case"set_state":return e.setStateValue(t.key,t.value),[];case"message":return[Rb(t.messageId,i,{...t.params||{},source:"state-machine"})];case"emit_event":{let o={};if(t.entities)for(let[a,s]of Object.entries(t.entities))s&&(o[a]=(0,gp.resolveRef)(s,r));return[{id:`sm-event-${++ZL}`,type:t.eventType,timestamp:Date.now(),entities:o,data:t.data}]}case"custom":{let o=t.execute(e,r,n),a=[];if(o.events)for(let s of o.events)a.push({id:`sm-custom-${++ZL}`,type:s.type,timestamp:Date.now(),entities:s.entities||{},data:s.data});if(o.messages)for(let s of o.messages)a.push(Rb(s.messageId,i,{...s.params||{},source:"state-machine"}));return a}}}function Rb(t,e,r){return{id:`sm-${++ZL}`,type:t,timestamp:Date.now(),entities:{},data:r,tags:["state-machine",e]}}});var nM=p(Cb=>{"use strict";Object.defineProperty(Cb,"__esModule",{value:!0});Cb.StateMachineRegistry=void 0;var Nz=Ab(),tM=eM(),rM=class{constructor(){l(this,"machines",new Map)}register(e,r={}){if(this.machines.has(e.id))throw new Error(`State machine already registered: ${e.id}`);if(!e.states[e.initialState])throw new Error(`Initial state '${e.initialState}' not found in machine '${e.id}'`);this.machines.set(e.id,{definition:e,bindings:{...r},currentState:e.initialState,history:[e.initialState]})}unregister(e){this.machines.delete(e)}getMachineState(e){return this.machines.get(e)?.currentState}getMachineHistory(e){return this.machines.get(e)?.history}evaluate(e){let r=[];for(let n of this.machines.values()){let i=n.definition.states[n.currentState];if(!i||i.terminal||!i.transitions?.length)continue;let o=this.findMatchingTransition(i.transitions,n,e);if(o){let a=this.executeTransition(n,o,e);r.push(...a)}}return r}findMatchingTransition(e,r,n){let i=[...e].sort((o,a)=>(a.priority??0)-(o.priority??0));for(let o of i)if(this.triggerMatches(o.trigger,r,n)&&!(o.guard&&!(0,Nz.evaluateGuard)(o.guard,n.world,r.bindings,n.playerId)))return o}triggerMatches(e,r,n){switch(e.type){case"action":{if(n.actionId!==e.actionId)return!1;if(e.targetEntity){let i=e.targetEntity.startsWith("$")?r.bindings[e.targetEntity]:e.targetEntity;if(n.actionTargetId!==i)return!1}return!0}case"event":return n.actionEvents?n.actionEvents.some(i=>{if(i.type!==e.eventId)return!1;if(e.filter&&i.data){let o=i.data;for(let[a,s]of Object.entries(e.filter)){let c=typeof s=="string"&&s.startsWith("$")?r.bindings[s]:s;if(o[a]!==c)return!1}}return!0}):!1;case"condition":return(0,Nz.evaluateGuard)(e.condition,n.world,r.bindings,n.playerId)}}executeTransition(e,r,n){let i=[],o=e.definition.states[e.currentState],a=e.definition.states[r.target];if(!a)throw new Error(`Target state '${r.target}' not found in machine '${e.definition.id}'`);return o?.onExit&&i.push(...(0,tM.executeEffects)(o.onExit,n.world,e.bindings,n.playerId,e.definition.id)),r.effects&&i.push(...(0,tM.executeEffects)(r.effects,n.world,e.bindings,n.playerId,e.definition.id)),e.currentState=r.target,e.history.push(r.target),a.onEnter&&i.push(...(0,tM.executeEffects)(a.onEnter,n.world,e.bindings,n.playerId,e.definition.id)),i.push({id:`sm-transition-${Date.now()}`,type:"sm.transition",timestamp:Date.now(),entities:{},data:{machineId:e.definition.id,from:e.history[e.history.length-2],to:r.target},tags:["state-machine",e.definition.id]}),i}getState(){let e=[];for(let r of this.machines.values())e.push({id:r.definition.id,currentState:r.currentState,history:[...r.history]});return{instances:e}}setState(e){for(let r of e.instances){let n=this.machines.get(r.id);n&&(n.currentState=r.currentState,n.history=[...r.history])}}};Cb.StateMachineRegistry=rM});var Dz=p(wb=>{"use strict";Object.defineProperty(wb,"__esModule",{value:!0});wb.StateMachinePlugin=void 0;var ble=nM(),iM=class{constructor(){l(this,"id","sharpee.plugin.state-machine");l(this,"priority",75);l(this,"registry");this.registry=new ble.StateMachineRegistry}onAfterAction(e){let r={world:e.world,playerId:e.playerId,playerLocation:e.playerLocation,turn:e.turn,actionId:e.actionResult?.actionId,actionTargetId:e.actionResult?.targetId,actionEvents:e.actionEvents?.map(n=>({type:n.type,data:n.data,entities:n.entities}))};return this.registry.evaluate(r)}getState(){return this.registry.getState()}setState(e){this.registry.setState(e)}getRegistry(){return this.registry}};wb.StateMachinePlugin=iM});var Mz=p(Nr=>{"use strict";var Ile=Nr&&Nr.__createBinding||(Object.create?(function(t,e,r,n){n===void 0&&(n=r);var i=Object.getOwnPropertyDescriptor(e,r);(!i||("get"in i?!e.__esModule:i.writable||i.configurable))&&(i={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,n,i)}):(function(t,e,r,n){n===void 0&&(n=r),t[n]=e[r]})),oM=Nr&&Nr.__exportStar||function(t,e){for(var r in t)r!=="default"&&!Object.prototype.hasOwnProperty.call(e,r)&&Ile(e,t,r)};Object.defineProperty(Nr,"__esModule",{value:!0});Nr.executeEffects=Nr.resolveRef=Nr.evaluateGuard=void 0;oM(wz(),Nr);oM(Dz(),Nr);oM(nM(),Nr);var Lz=Ab();Object.defineProperty(Nr,"evaluateGuard",{enumerable:!0,get:function(){return Lz.evaluateGuard}});Object.defineProperty(Nr,"resolveRef",{enumerable:!0,get:function(){return Lz.resolveRef}});var Ole=eM();Object.defineProperty(Nr,"executeEffects",{enumerable:!0,get:function(){return Ole.executeEffects}})});var eK=_(gq()),Mb=_(E()),tK=_(Yq()),rK=_(Tm()),nK=_(zi());var Yc=class{constructor(e){this.storageKey=e.storageKey,this.themes=e.themes,this.defaultTheme=e.defaultTheme}static applyEarlyTheme(e){try{let r=localStorage.getItem(e);r&&document.documentElement.setAttribute("data-theme",r)}catch{}}getSavedTheme(){try{return localStorage.getItem(this.storageKey)||this.defaultTheme}catch{return this.defaultTheme}}saveTheme(e){try{localStorage.setItem(this.storageKey,e)}catch{}}applyTheme(e){document.documentElement.setAttribute("data-theme",e),this.updateMenuCheckmarks(e),this.saveTheme(e),console.log("[theme] Applied:",e)}updateMenuCheckmarks(e){document.querySelectorAll(".theme-option").forEach(r=>{r.dataset.theme===e?r.classList.add("active"):r.classList.remove("active")})}getThemes(){return this.themes}getDefaultTheme(){return this.defaultTheme}};var ws=_(zq(),1);var Ji="autosave";var bm=class{constructor(e){this.baseline=null,this.storagePrefix=e.storagePrefix,this.indexKey=`${e.storagePrefix}saves-index`,this.savePrefix=`${e.storagePrefix}save-`,this.world=e.world,this.onStateChange=e.onStateChange}captureBaseline(){this.baseline=this.captureWorldState(),console.log("[save] Baseline captured:",Object.keys(this.baseline.locations).length,"entities")}getSaveIndex(){try{let e=localStorage.getItem(this.indexKey);return e?JSON.parse(e):[]}catch{return[]}}updateSaveIndex(e){let r=this.getSaveIndex(),n=r.findIndex(i=>i.name===e.name);n>=0?r[n]=e:r.push(e),r.sort((i,o)=>o.timestamp-i.timestamp),localStorage.setItem(this.indexKey,JSON.stringify(r))}getCurrentLocation(){try{let e=this.world.getPlayer();if(e){let r=this.world.getLocation(e.id);if(r){let n=this.world.getEntity(r);if(n)return n.name||"Unknown"}}}catch{}return"Unknown"}generateSaveName(e){let r=this.getCurrentLocation().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"").substring(0,15);return`turn-${e}-${r}`}sanitizeSaveName(e){return e.toLowerCase().replace(/[^a-z0-9-_]/g,"-").replace(/-+/g,"-").replace(/^-|-$/g,"").substring(0,30)||"save"}captureWorldState(){let e={},r={};for(let n of this.world.getAllEntities()){let i=this.world.getLocation(n.id);e[n.id]=i||null;let o={};for(let[a,s]of n.traits){let c={},d=s;for(let u of Object.keys(s)){let m=d[u];typeof m!="function"&&(c[u]=m)}o[a]=c}r[n.id]=o}return{locations:e,traits:r}}captureDelta(){let e=this.captureWorldState();if(!this.baseline)return e;let r={},n={};for(let[i,o]of Object.entries(e.locations))o!==this.baseline.locations[i]&&(r[i]=o);for(let[i,o]of Object.entries(e.traits)){let a=this.baseline.traits[i]||{};for(let[s,c]of Object.entries(o)){let d=a[s];(!d||!this.shallowEqual(c,d))&&(n[i]||(n[i]={}),n[i][s]=c)}}return{locations:r,traits:n}}shallowEqual(e,r){let n=Object.keys(e),i=Object.keys(r);if(n.length!==i.length)return!1;for(let o of n)if(e[o]!==r[o])return!1;return!0}restoreWorldState(e){for(let[r,n]of Object.entries(e.locations))n&&this.world.getEntity(r)&&this.world.moveEntity(r,n);for(let[r,n]of Object.entries(e.traits)){let i=this.world.getEntity(r);if(i)for(let[o,a]of Object.entries(n)){let s=i.get(o);if(s){let c=s;for(let[d,u]of Object.entries(a))d!=="type"&&typeof u!="function"&&(c[d]=u)}}}}performSave(e,r,n=!1){try{let{locations:i,traits:o}=this.captureDelta(),a=(0,ws.compressToUTF16)(r.transcriptHtml),s={version:"3.0.0-delta",timestamp:Date.now(),turnCount:r.turnCount,score:r.score,locations:i,traits:o,transcriptHtml:a},c=this.savePrefix+e,d=(0,ws.compressToUTF16)(JSON.stringify(s));localStorage.setItem(c,d);let u={name:e,timestamp:s.timestamp,turnCount:r.turnCount,location:this.getCurrentLocation()};return this.updateSaveIndex(u),console.log("[save] Game saved to",c,u),this.syncSavesToWorld(),this.onStateChange?.(),{success:!0}}catch(i){let o=i instanceof Error?i.message:String(i);return console.error("[save] Failed:",o),{success:!1,error:o}}}performAutoSave(e){try{let{locations:r,traits:n}=this.captureDelta(),i=(0,ws.compressToUTF16)(e.transcriptHtml),o={version:"3.0.0-delta",timestamp:Date.now(),turnCount:e.turnCount,score:e.score,locations:r,traits:n,transcriptHtml:i},a=this.savePrefix+Ji,s=(0,ws.compressToUTF16)(JSON.stringify(o));localStorage.setItem(a,s);let c={name:Ji,timestamp:Date.now(),turnCount:e.turnCount,location:this.getCurrentLocation()};this.updateSaveIndex(c),console.log("[autosave] Saved at turn",e.turnCount),this.syncSavesToWorld()}catch(r){console.error("[autosave] Failed:",r)}}loadAutosave(){return this.loadSaveSlot(Ji)}loadSaveSlot(e){try{let r=this.savePrefix+e,n=localStorage.getItem(r);if(!n)return null;let i;if(n.startsWith("{"))i=n;else{let o=(0,ws.decompressFromUTF16)(n);if(!o)return null;i=o}return JSON.parse(i)}catch(r){return console.error("[load] Failed to load slot:",e,r),null}}decompressTranscript(e){try{return(0,ws.decompressFromUTF16)(e)||""}catch{return""}}syncSavesToWorld(){let e=this.getSaveIndex();if(e.length===0)return;let r={};for(let n of e)r[n.name]={name:n.name,timestamp:n.timestamp,moves:n.turnCount};this.world.hasCapability("sharedData")?this.world.updateCapability("sharedData",{saves:r}):this.world.registerCapability("sharedData",{initialData:{saves:r}}),console.log("[sync] Synced",e.length,"saves to world sharedData")}clearAutosave(){try{let e=this.savePrefix+Ji;localStorage.removeItem(e);let r=this.getSaveIndex().filter(n=>n.name!==Ji);localStorage.setItem(this.indexKey,JSON.stringify(r)),console.log("[autosave] Cleared")}catch{}}checkForSavedGame(){let e=this.getSaveIndex();return e.length===0?null:e[0]}getUserSaves(){return this.getSaveIndex().filter(e=>e.name!==Ji)}};var Im=class{constructor(e){this._isDialogOpen=!1,this.selectedSaveSlot=null,this.pendingSaveResolve=null,this.pendingRestoreResolve=null,this.pendingStartupResolve=null,this.elements=e.elements,this.saveManager=e.saveManager,this.onDialogOpen=e.onDialogOpen,this.onDialogClose=e.onDialogClose,this.generateSaveName=e.generateSaveName,this.sanitizeSaveName=e.sanitizeSaveName,this.performSave=e.performSave}isDialogOpen(){return this._isDialogOpen}showSaveDialog(){return new Promise(e=>{console.log("[save-dialog] Opening save dialog...");let{modalOverlay:r,saveDialog:n,saveNameInput:i,saveSlotsListEl:o}=this.elements;if(!r||!n){console.error("[save-dialog] Modal elements not found!"),e(!1);return}this.pendingSaveResolve=e,this._isDialogOpen=!0,this.selectedSaveSlot=null,this.onDialogOpen?.(),this.populateSaveSlotsList(o,!0),i&&(i.value=this.generateSaveName(),i.select()),r.classList.remove("modal-hidden"),n.classList.remove("modal-hidden"),i?.focus()})}hideSaveDialog(e){let{modalOverlay:r,saveDialog:n}=this.elements;r?.classList.add("modal-hidden"),n?.classList.add("modal-hidden"),this._isDialogOpen=!1,this.onDialogClose?.(),this.pendingSaveResolve&&(this.pendingSaveResolve(e),this.pendingSaveResolve=null)}showRestoreDialog(){return new Promise(e=>{console.log("[restore-dialog] Opening restore dialog...");let{modalOverlay:r,restoreDialog:n,restoreSlotsListEl:i,noSavesMessage:o}=this.elements;if(!r||!n){console.error("[restore-dialog] Modal elements not found!"),e(null);return}this.pendingRestoreResolve=e,this._isDialogOpen=!0,this.selectedSaveSlot=null,this.onDialogOpen?.();let a=this.saveManager.getUserSaves();console.log("[restore-dialog] Available saves:",a),this.populateSaveSlotsList(i,!1),o&&(a.length===0?(o.classList.remove("modal-hidden"),i?.classList.add("modal-hidden")):(o.classList.add("modal-hidden"),i?.classList.remove("modal-hidden")));let s=document.getElementById("restore-confirm-btn");s&&(s.disabled=!0),r.classList.remove("modal-hidden"),n.classList.remove("modal-hidden"),a.length>0&&i?.querySelector(".save-slot")?.focus()})}hideRestoreDialog(e){let{modalOverlay:r,restoreDialog:n}=this.elements;r?.classList.add("modal-hidden"),n?.classList.add("modal-hidden"),this._isDialogOpen=!1,this.onDialogClose?.(),this.pendingRestoreResolve&&(this.pendingRestoreResolve(e),this.pendingRestoreResolve=null)}showStartupDialog(e){return new Promise(r=>{let{modalOverlay:n,startupDialog:i,startupSaveInfo:o}=this.elements;if(!n||!i){r(!1);return}if(this.pendingStartupResolve=r,this._isDialogOpen=!0,o){let s=new Date(e.timestamp),c=s.toLocaleDateString(),d=s.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});o.textContent=`Found "${e.name}" from ${c} ${d} (Turn ${e.turnCount}, ${e.location})`}n.classList.remove("modal-hidden"),i.classList.remove("modal-hidden"),document.getElementById("startup-continue-btn")?.focus()})}hideStartupDialog(e){let{modalOverlay:r,startupDialog:n}=this.elements;r?.classList.add("modal-hidden"),n?.classList.add("modal-hidden"),this._isDialogOpen=!1,this.pendingStartupResolve&&(this.pendingStartupResolve(e),this.pendingStartupResolve=null)}populateSaveSlotsList(e,r){if(!e)return;let n=this.saveManager.getSaveIndex(),i=r?n:n.filter(o=>o.name!==Ji);if(e.innerHTML="",i.length===0&&r){let o=document.createElement("div");o.className="no-saves-message",o.textContent="No existing saves",e.appendChild(o);return}for(let o of i){let a=document.createElement("div");a.className="save-slot",a.tabIndex=0,a.dataset.slotName=o.name;let s=document.createElement("span");s.className="save-slot-name",s.textContent=o.name;let c=document.createElement("span");c.className="save-slot-info";let d=new Date(o.timestamp),u=d.toLocaleDateString(),m=d.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});c.textContent=`Turn ${o.turnCount} | ${o.location} | ${u} ${m}`,a.appendChild(s),a.appendChild(c),a.addEventListener("click",()=>{this.selectSaveSlot(e,o.name,r)}),r||a.addEventListener("dblclick",()=>{this.hideRestoreDialog(o.name)}),a.addEventListener("keydown",f=>{f.key==="Enter"||f.key===" "?(f.preventDefault(),this.selectSaveSlot(e,o.name,r),r||this.selectedSaveSlot===o.name&&this.hideRestoreDialog(o.name)):f.key==="ArrowDown"?(f.preventDefault(),a.nextElementSibling?.focus()):f.key==="ArrowUp"&&(f.preventDefault(),a.previousElementSibling?.focus())}),e.appendChild(a)}}selectSaveSlot(e,r,n){if(e.querySelectorAll(".save-slot").forEach(o=>o.classList.remove("selected")),e.querySelector(`[data-slot-name="${r}"]`)?.classList.add("selected"),this.selectedSaveSlot=r,n&&this.elements.saveNameInput&&(this.elements.saveNameInput.value=r),!n){let o=document.getElementById("restore-confirm-btn");o&&(o.disabled=!1)}}setupHandlers(){let{saveNameInput:e,saveDialog:r,restoreDialog:n,startupDialog:i,modalOverlay:o}=this.elements,a=document.getElementById("save-confirm-btn"),s=document.getElementById("save-cancel-btn");a?.addEventListener("click",()=>{let f=this.sanitizeSaveName(e?.value||this.generateSaveName());f&&(this.performSave(f),this.hideSaveDialog(!0))}),s?.addEventListener("click",()=>{this.hideSaveDialog(!1)});let c=document.getElementById("restore-confirm-btn"),d=document.getElementById("restore-cancel-btn");c?.addEventListener("click",()=>{this.selectedSaveSlot&&this.hideRestoreDialog(this.selectedSaveSlot)}),d?.addEventListener("click",()=>{this.hideRestoreDialog(null)});let u=document.getElementById("startup-continue-btn"),m=document.getElementById("startup-new-btn");u?.addEventListener("click",()=>{this.hideStartupDialog(!0)}),m?.addEventListener("click",()=>{this.hideStartupDialog(!1)}),e?.addEventListener("keydown",f=>{if(f.key==="Enter"){f.preventDefault();let g=this.sanitizeSaveName(e?.value||this.generateSaveName());g&&(this.performSave(g),this.hideSaveDialog(!0))}else f.key==="Escape"&&this.hideSaveDialog(!1)}),document.addEventListener("keydown",f=>{f.key==="Escape"&&this._isDialogOpen&&(r&&!r.classList.contains("modal-hidden")?this.hideSaveDialog(!1):n&&!n.classList.contains("modal-hidden")?this.hideRestoreDialog(null):i&&!i.classList.contains("modal-hidden")&&this.hideStartupDialog(!1))}),o?.addEventListener("click",f=>{f.target===o&&(r&&!r.classList.contains("modal-hidden")?this.hideSaveDialog(!1):n&&!n.classList.contains("modal-hidden")?this.hideRestoreDialog(null):i&&!i.classList.contains("modal-hidden")&&this.hideStartupDialog(!1))})}};var Om=class{constructor(e){this.handlers=e.handlers}closeAllMenus(){document.querySelectorAll(".menu-dropdown").forEach(e=>{e.classList.remove("show")}),document.querySelectorAll(".menu-button").forEach(e=>{e.classList.remove("active")})}toggleMenu(e,r){let n=r.classList.contains("show");this.closeAllMenus(),n||(r.classList.add("show"),e.classList.add("active"))}setupHandlers(){let e=document.getElementById("file-menu-btn"),r=document.getElementById("file-menu"),n=document.getElementById("settings-menu-btn"),i=document.getElementById("settings-menu"),o=document.getElementById("help-menu-btn"),a=document.getElementById("help-menu");e?.addEventListener("click",s=>{s.stopPropagation(),r&&this.toggleMenu(e,r)}),n?.addEventListener("click",s=>{s.stopPropagation(),i&&this.toggleMenu(n,i)}),o?.addEventListener("click",s=>{s.stopPropagation(),a&&this.toggleMenu(o,a)}),document.addEventListener("click",s=>{s.target.closest(".menu-item")||this.closeAllMenus()}),document.addEventListener("keydown",s=>{s.key==="Escape"&&this.closeAllMenus()}),document.getElementById("menu-save")?.addEventListener("click",async()=>{this.closeAllMenus(),await this.handlers.onSave()}),document.getElementById("menu-restore")?.addEventListener("click",async()=>{this.closeAllMenus(),await this.handlers.onRestore()}),document.getElementById("menu-restart")?.addEventListener("click",async()=>{this.closeAllMenus(),await this.handlers.onRestart()}),document.getElementById("menu-quit")?.addEventListener("click",()=>{this.closeAllMenus(),this.handlers.onQuit()}),document.querySelectorAll(".theme-option").forEach(s=>{s.addEventListener("click",()=>{let c=s.dataset.theme;c&&(this.handlers.onThemeSelect(c),this.closeAllMenus())})}),document.getElementById("menu-help")?.addEventListener("click",()=>{this.closeAllMenus(),this.handlers.onHelp()}),document.getElementById("menu-about")?.addEventListener("click",()=>{this.closeAllMenus(),this.handlers.onAbout()}),console.log("[menu] Handlers set up")}};var Sm=class{constructor(e){this.commandHistory=[],this.historyIndex=-1,this.commandInput=e.commandInput,this.onCommand=e.onCommand,this.isDialogOpen=e.isDialogOpen}setupHandlers(){this.commandInput&&(this.commandInput.addEventListener("keydown",e=>{e.key==="Enter"?this.handleSubmit():e.key==="ArrowUp"?(e.preventDefault(),this.navigateHistory(-1)):e.key==="ArrowDown"&&(e.preventDefault(),this.navigateHistory(1))}),document.addEventListener("click",e=>{this.commandInput&&!this.commandInput.disabled&&!this.isDialogOpen()&&(e.target.closest(".modal-dialog")||this.commandInput.focus())}))}async handleSubmit(){if(!this.commandInput)return;let e=this.commandInput.value.trim();e&&(this.commandHistory.push(e),this.historyIndex=this.commandHistory.length,this.commandInput.value="",await this.onCommand(e))}navigateHistory(e){if(!this.commandInput)return;let r=this.historyIndex+e;if(!(r<0)){if(r>=this.commandHistory.length){this.historyIndex=this.commandHistory.length,this.commandInput.value="";return}this.historyIndex=r,this.commandInput.value=this.commandHistory[this.historyIndex],this.commandInput.setSelectionRange(this.commandInput.value.length,this.commandInput.value.length)}}clearInput(){this.commandInput&&(this.commandInput.value="")}focus(){this.commandInput?.focus()}disable(){this.commandInput&&(this.commandInput.disabled=!0)}enable(){this.commandInput&&(this.commandInput.disabled=!1)}getHistory(){return[...this.commandHistory]}};var Am=class{constructor(e){this.textContent=e.textContent,this.mainWindow=e.mainWindow}displayText(e){if(!this.textContent)return;let r=e.split(/\n\n+/);for(let n of r){let i=n.trim();if(i){let o=document.createElement("p");o.style.whiteSpace="pre-line",o.textContent=i,this.textContent.appendChild(o)}}this.scrollToBottom()}displayCommand(e){if(!this.textContent)return;let r=document.createElement("div");r.className="command-echo",r.textContent=`> ${e}`,this.textContent.appendChild(r),this.scrollToBottom()}clearScreen(){this.textContent&&(this.textContent.innerHTML="")}scrollToBottom(){this.mainWindow&&(this.mainWindow.scrollTop=this.mainWindow.scrollHeight)}getHTML(){return this.textContent?.innerHTML||""}setHTML(e){this.textContent&&(this.textContent.innerHTML=e,this.scrollToBottom())}};var Rm=class{constructor(e){this.statusLocation=e.statusLocation,this.statusScore=e.statusScore}update(e,r,n){this.setLocation(e),this.setScoreTurns(r,n)}setLocation(e){this.statusLocation&&(this.statusLocation.textContent=e)}setScoreTurns(e,r){this.statusScore&&(this.statusScore.textContent=`Score: ${e} | Turns: ${r}`)}};var Cm=class{constructor(){this.audioContext=null}beep(e=800,r=100){try{this.audioContext||(this.audioContext=new AudioContext);let n=this.audioContext.createOscillator(),i=this.audioContext.createGain();n.type="square",n.frequency.value=e,i.gain.value=.1,n.connect(i),i.connect(this.audioContext.destination),n.start(),n.stop(this.audioContext.currentTime+r/1e3)}catch{}}dispose(){this.audioContext&&(this.audioContext.close(),this.audioContext=null)}};var wm=class{constructor(e){this.currentTurn=0,this.currentScore=0,this.turnOffset=0,this.config={autoSave:!0,...e},this.audioManager=new Cm}initialize(e){this.elements=e,this.textDisplay=new Am({textContent:e.textContent,mainWindow:e.mainWindow}),this.statusLine=new Rm({statusLocation:e.statusLocation,statusScore:e.statusScore})}connectEngine(e,r){this.engine=e,this.world=r,this.saveManager=new bm({storagePrefix:this.config.storagePrefix,world:this.world,onStateChange:()=>this.updateStatusLine()}),this.dialogManager=new Im({elements:{modalOverlay:this.elements.modalOverlay,saveDialog:this.elements.saveDialog,restoreDialog:this.elements.restoreDialog,startupDialog:this.elements.startupDialog,saveNameInput:this.elements.saveNameInput,saveSlotsListEl:this.elements.saveSlotsListEl,restoreSlotsListEl:this.elements.restoreSlotsListEl,noSavesMessage:this.elements.noSavesMessage,startupSaveInfo:this.elements.startupSaveInfo},saveManager:this.saveManager,onDialogOpen:()=>this.inputManager?.disable(),onDialogClose:()=>{this.inputManager?.enable(),this.inputManager?.focus()},generateSaveName:()=>this.saveManager.generateSaveName(this.currentTurn),sanitizeSaveName:o=>this.saveManager.sanitizeSaveName(o),performSave:o=>this.performSave(o)}),this.themeManager=new Yc({storageKey:`${this.config.storagePrefix}theme`,themes:this.config.themes,defaultTheme:this.config.defaultTheme});let n={onSave:()=>this.handleSave(),onRestore:()=>this.handleRestore(),onRestart:()=>this.handleRestart(),onQuit:()=>this.handleQuit(),onThemeSelect:o=>this.themeManager.applyTheme(o),onHelp:()=>this.engine.executeTurn("help"),onAbout:()=>this.engine.executeTurn("about")};this.menuManager=new Om({menuBar:this.elements.menuBar,handlers:n}),this.inputManager=new Sm({commandInput:this.elements.commandInput,onCommand:o=>this.executeCommand(o),isDialogOpen:()=>this.dialogManager.isDialogOpen()}),this.setupEngineHandlers(),this.dialogManager.setupHandlers(),this.menuManager.setupHandlers(),this.inputManager.setupHandlers();let i=this.themeManager.getSavedTheme();this.themeManager.applyTheme(i),this.saveManager.syncSavesToWorld()}setupEngineHandlers(){this.engine.on("text:output",(e,r)=>{console.log("[text:output]",{text:e,turn:r,turnOffset:this.turnOffset}),this.textDisplay.displayText(e),this.currentTurn=r+this.turnOffset,this.updateStatusLine(),this.config.autoSave&&r>0&&this.saveManager.performAutoSave(this.getSaveContext())}),this.engine.on("event",e=>{if(console.log("[event]",e.type,e.data),!this.config.callbacks?.handleStoryEvent?.(e,this)){if((e.type==="command.failed"||e.type==="action.blocked"||e.type.includes(".blocked")||e.type==="game.player_death")&&this.beep(),e.type==="game.score_changed"&&e.data){let r=e.data;this.currentScore=r.newScore??this.currentScore,this.updateStatusLine(),(r.newScore??0)>(r.oldScore??0)&&this.beep(1e3,50)}if(e.type==="platform.save_failed"){let r=e.data;this.textDisplay.displayText(`[Save failed: ${r?.error||"Unknown error"}]`),this.beep()}else if(e.type==="platform.restore_failed"){let r=e.data;this.textDisplay.displayText(`[Restore failed: ${r?.error||"No saved game found"}]`),this.beep()}else if(e.type==="platform.restore_completed"){let r=e.data;r?.turnCount!==void 0&&(this.currentTurn=r.turnCount),this.updateStatusLine()}}})}async start(){console.log("=== BROWSER CLIENT START ===");try{if(this.world){let n=this.world.findByTrait("storyInfo")[0]?.get("storyInfo");n?n.clientVersion=this.config.storyInfo.version:this.world.clientVersion=this.config.storyInfo.version}await this.engine.start(),this.saveManager.captureBaseline(),this.saveManager.syncSavesToWorld();let e=this.saveManager.loadAutosave();if(e&&e.locations){console.log("[startup] Found autosave, restoring...");try{if(this.saveManager.restoreWorldState(e),this.currentTurn=e.turnCount||0,this.currentScore=e.score||0,this.turnOffset=this.currentTurn-1,e.transcriptHtml){let r=this.saveManager.decompressTranscript(e.transcriptHtml);this.textDisplay.setHTML(r)}console.log("[startup] Restored to turn",this.currentTurn,"score",this.currentScore,"offset",this.turnOffset),this.updateStatusLine(),this.textDisplay.displayText("[Session restored]"),this.textDisplay.scrollToBottom(),this.syncScoreFromWorld()}catch(r){console.error("[startup] Failed to restore autosave:",r),await this.engine.executeTurn("look")}}else console.log("Executing initial look command..."),await this.engine.executeTurn("look"),console.log("Initial look complete");this.inputManager?.focus()}catch(e){console.error("=== STARTUP ERROR ===",e),this.textDisplay.displayText(`[Startup Error: ${e}]`)}}async executeCommand(e){this.textDisplay.displayCommand(e);try{await this.engine.executeTurn(e),this.syncScoreFromWorld()}catch(r){let n=r instanceof Error?r.message:String(r);this.textDisplay.displayText(`[Error: ${n}]`)}}getSaveRestoreHooks(){return{onSaveRequested:async e=>{await this.dialogManager.showSaveDialog()||this.textDisplay.displayText("[Save cancelled]")},onRestoreRequested:async()=>{let e=await this.dialogManager.showRestoreDialog();if(!e)return this.textDisplay.displayText("[Restore cancelled]"),null;let r=this.saveManager.loadSaveSlot(e);if(!r)return this.textDisplay.displayText(`[No saved game found: ${e}]`),this.beep(),null;if(this.saveManager.restoreWorldState(r),this.currentTurn=r.turnCount||0,this.currentScore=r.score||0,this.turnOffset=this.currentTurn-1,r.transcriptHtml){let n=this.saveManager.decompressTranscript(r.transcriptHtml);this.textDisplay.setHTML(n)}return this.updateStatusLine(),this.textDisplay.displayText(`[Game restored from "${e}"]`),this.syncScoreFromWorld(),null},onRestartRequested:async e=>confirm("Are you sure you want to restart? All unsaved progress will be lost.")?(this.saveManager.clearAutosave(),window.location.reload(),!0):!1}}async handleSave(){await this.dialogManager.showSaveDialog()}async handleRestore(){await this.getSaveRestoreHooks().onRestoreRequested()}async handleRestart(){await this.getSaveRestoreHooks().onRestartRequested?.({})}handleQuit(){confirm("Are you sure you want to quit?")&&(window.close(),this.textDisplay.displayText("[Close this browser tab to quit]"))}displayText(e){this.textDisplay.displayText(e)}displayCommand(e){this.textDisplay.displayCommand(e)}clearScreen(){this.textDisplay.clearScreen()}beep(e=800,r=100){this.audioManager.beep(e,r)}getWorld(){return this.world}getCurrentTurn(){return this.currentTurn}getCurrentScore(){return this.currentScore}performSave(e){let r=this.saveManager.performSave(e,this.getSaveContext());r.success?this.textDisplay.displayText(`[Game saved as "${e}"]`):(this.textDisplay.displayText(`[Save failed: ${r.error}]`),this.beep())}getSaveContext(){return{turnCount:this.currentTurn,score:this.currentScore,transcriptHtml:this.textDisplay.getHTML()}}updateStatusLine(){let e=this.saveManager.getCurrentLocation();this.statusLine.update(e,this.currentScore,this.currentTurn)}syncScoreFromWorld(){let e=this.world.getCapability("scoring");if(e&&typeof e.scoreValue=="number"){let r=e.scoreValue;r!==this.currentScore&&(this.currentScore=r,this.updateStatusLine())}}};var $=_(E()),Ga=_(zi());var Kq={active:!1,immortal:!1,verbose:!1,trollDisabled:!1,thiefDisabled:!1,cyclopsDisabled:!1},Rw="gdt",eo="dungeo.action.gdt",vr="dungeo.action.gdt_command";var Nm={ENTERED:"dungeo.gdt.entered",EXITED:"dungeo.gdt.exited",OUTPUT:"dungeo.gdt.output",UNKNOWN_COMMAND:"dungeo.gdt.unknown_command"};var Dm=_(E());function Ns(t){let e=t.getStateValue(Rw);return{...Kq,...e}}function xv(t,e){t.setStateValue(Rw,e)}function Lm(t){return Ns(t).active}function Cw(t){let e=t.getPlayer();if(!e)throw new Error("No player entity found");let r=Ns(t),n=new Dm.AuthorModel(t.getDataStore(),t);return{world:t,player:e,flags:r,findEntity(i){let o=t.getEntity(i);if(o)return o;let a=i.toLowerCase();for(let s of t.getAllEntities()){let c=s.get("identity");if(c?.name?.toLowerCase()===a)return s;if(c?.aliases){for(let d of c.aliases)if(d.toLowerCase()===a)return s}}},findRoom(i){let o=this.findEntity(i);if(o&&o.has("room"))return o},listRooms(){return t.getAllEntities().filter(i=>i.has("room"))},listObjects(){return t.getAllEntities().filter(i=>i.type===Dm.EntityType.OBJECT||i.type===Dm.EntityType.CONTAINER)},getPlayerLocation(){let i=t.getLocation(e.id);if(i)return t.getEntity(i)},getInventory(){return t.getContents(e.id)},setFlag(i,o){let a=Ns(t);a[i]=o,xv(t,a),this.flags[i]=o},teleportPlayer(i){let o=this.findRoom(i);return o?(n.moveEntity(e.id,o.id),!0):!1},moveObject(i,o){let a=this.findEntity(i);if(!a)return!1;let s=o==="player"||o==="inventory"?e.id:o;return!this.findEntity(s)&&s!==e.id?!1:(n.moveEntity(a.id,s),!0)}}}var Are=new Set(["DA","DR","DO","DE","DC","DX","DH","DL","DV","DF","DS","DN","DM","DT","DP","D2","DZ","AH","AO","AR","AF","AC","AA","AX","AV","AN","AZ","NC","ND","NR","NT","RC","RD","RR","RT","TK","PD","HE","EX","PZ","TQ","KL","KO","WU","FO"]);function ww(t){let e=t.trim();if(!e)return null;let r=e.match(/^([A-Za-z]{2})(?:\s+(.*))?$/);if(!r)return null;let n=r[1].toUpperCase();if(!Are.has(n))return null;let o=(r[2]||"").split(/\s+/).filter(Boolean);return{code:n,args:o,raw:e}}var Nw={code:"HE",name:"Help",description:"Display list of GDT commands",execute(t,e){return{success:!0,output:["GDT COMMANDS:","","DISPLAY:","  DA  Display Adventurer    - Show player state","  DR  Display Room          - Show room properties","  DO  Display Object        - Show object properties","  DE  Describe Entity       - Full entity inspection","  DS  Display State         - Show game state","  DX  Display Exits         - Show room exits","  DC  Display Clock         - Show timer events","  DV  Display Villains      - Show NPC state","  DF  Display Flags         - Show game flags","","ALTER:","  AH  Alter Here            - Teleport to room","  AO  Alter Object          - Move object","  AF  Alter Flags           - Set game flag","","TOGGLE:","  ND  No Deaths             - Toggle immortality","  NT  No Troll              - Disable troll","  NR  No Robber             - Disable thief","  NC  No Cyclops            - Disable cyclops","  RD  Restore Deaths        - Enable deaths","  RT  Restore Troll         - Enable troll","  RR  Restore Robber        - Enable thief","  RC  Restore Cyclops       - Enable cyclops","","UTILITY:","  TK  Take                  - Acquire any object","  HE  Help                  - This message","  EX  Exit                  - Return to game"]}}};var Dw={code:"EX",name:"Exit",description:"Exit GDT and return to game",execute(t,e){return t.setFlag("active",!1),{success:!0,output:["Returning to game."]}}};var $q=_(E()),Lw={code:"DA",name:"Display Adventurer",description:"Show player state (location, score, inventory)",execute(t,e){let{world:r,player:n}=t,i=[];i.push("=== ADVENTURER ==="),i.push(""),i.push(`ID: ${n.id}`);let o=t.getPlayerLocation();if(o){let m=o.get("identity");i.push(`Location: ${m?.name??o.id} (${o.id})`)}else i.push("Location: <none>");let a=r.getScore(),s=r.getMaxScore(),d=r.getCapability($q.StandardCapabilities.SCORING)?.moves??0;i.push(`Score: ${a}/${s}`),i.push(`Moves: ${d}`);let u=t.getInventory();if(i.push(""),i.push("Inventory:"),u.length===0)i.push("  <empty>");else for(let m of u){let f=m.get("identity");i.push(`  - ${f?.name??m.id} (${m.id})`)}return i.push(""),i.push("GDT Flags:"),i.push(`  Immortal: ${t.flags.immortal?"YES":"no"}`),i.push(`  Troll disabled: ${t.flags.trollDisabled?"YES":"no"}`),i.push(`  Thief disabled: ${t.flags.thiefDisabled?"YES":"no"}`),i.push(`  Cyclops disabled: ${t.flags.cyclopsDisabled?"YES":"no"}`),{success:!0,output:i}}};var Mw={code:"DR",name:"Display Room",description:"Show room properties (DR [room-id])",execute(t,e){let r=[],n;if(e.length>0){if(n=t.findRoom(e[0]),!n)return{success:!1,output:[`Room not found: ${e[0]}`],error:"NOT_FOUND"}}else if(n=t.getPlayerLocation(),!n)return{success:!1,output:["Player has no location"],error:"NO_LOCATION"};let i=n.get("identity"),o=n.get("room");if(r.push("=== ROOM ==="),r.push(""),r.push(`ID: ${n.id}`),r.push(`Name: ${i?.name??"<unnamed>"}`),o&&(r.push(""),r.push("Properties:"),r.push(`  Visited: ${o.visited?"yes":"no"}`),r.push(`  Dark: ${o.isDark?"YES":"no"}`),r.push(`  Outdoors: ${o.isOutdoors?"yes":"no"}`),r.push(`  Underground: ${o.isUnderground?"yes":"no"}`),o.region&&r.push(`  Region: ${o.region}`),o.tags&&o.tags.length>0&&r.push(`  Tags: ${o.tags.join(", ")}`)),r.push(""),r.push("Exits:"),o?.exits){let s=Object.entries(o.exits);if(s.length===0)r.push("  <none>");else for(let[c,d]of s){let u=t.findRoom(d.destination),m=u?u.get("identity")?.name??d.destination:d.destination,f=`  ${c.toUpperCase()}: ${m}`;d.via&&(f+=` (via ${d.via})`),r.push(f)}}else r.push("  <none>");let a=t.world.getContents(n.id);if(r.push(""),r.push("Contents:"),a.length===0)r.push("  <empty>");else for(let s of a){let c=s.get("identity"),d=Array.from(s.traits.keys()).filter(m=>m!=="identity"),u=d.length>0?` [${d.join(", ")}]`:"";r.push(`  - ${c?.name??s.id} (${s.id})${u}`)}return{success:!0,output:r}}};var Pw={code:"DO",name:"Display Object",description:"Show object properties (DO <object-id>)",execute(t,e){let r=[];if(e.length===0)return{success:!1,output:["Usage: DO <object-id or name>"],error:"MISSING_ARG"};let n=t.findEntity(e.join(" "));if(!n)return{success:!1,output:[`Object not found: ${e.join(" ")}`],error:"NOT_FOUND"};let i=n.get("identity");r.push("=== OBJECT ==="),r.push(""),r.push(`ID: ${n.id}`),r.push(`Type: ${n.type}`),r.push(`Name: ${i?.name??"<unnamed>"}`),i?.aliases&&i.aliases.length>0&&r.push(`Aliases: ${i.aliases.join(", ")}`);let o=t.world.getLocation(n.id);if(o){let s=t.findEntity(o),c=s?s.get("identity")?.name??o:o;r.push(`Location: ${c} (${o})`)}else r.push("Location: <nowhere>");(i?.weight!==void 0||i?.volume!==void 0)&&(r.push(""),r.push("Physical:"),i.weight!==void 0&&r.push(`  Weight: ${i.weight}`),i.volume!==void 0&&r.push(`  Volume: ${i.volume}`)),r.push(""),r.push("Traits:");let a=Array.from(n.traits.keys());if(a.length===0)r.push("  <none>");else for(let s of a){let c=n.get(s);if(!c)continue;let d=Rre(s,c);d?r.push(`  ${s}: ${d}`):r.push(`  ${s}`)}if(n.has("container")||n.has("supporter")||n.has("room")){let s=t.world.getContents(n.id);if(r.push(""),r.push("Contents:"),s.length===0)r.push("  <empty>");else for(let c of s){let d=c.get("identity");r.push(`  - ${d?.name??c.id} (${c.id})`)}}return{success:!0,output:r}}};function Rre(t,e){switch(t){case"identity":return null;case"openable":return`isOpen=${e.isOpen}`;case"lockable":return`isLocked=${e.isLocked}, keyId=${e.keyId??"none"}`;case"switchable":return`isOn=${e.isOn}`;case"lightSource":return`lit=${e.lit}, brightness=${e.brightness??"default"}`;case"container":return`capacity=${e.capacity??"unlimited"}, transparent=${e.isTransparent}`;case"edible":return`portions=${e.portions??1}`;case"readable":return`text="${(e.text??"").substring(0,30)}${(e.text?.length??0)>30?"...":""}"`;case"wearable":case"clothing":return`worn=${e.worn}`;case"door":return`connects=${e.room1??"?"}<->${e.room2??"?"}`;case"scenery":return"fixed";case"room":return`visited=${e.visited}, dark=${e.isDark}`;default:return null}}var yi=_(E());var Mm=class Mm{constructor(e){l(this,"type",Mm.type);l(this,"position");l(this,"topRoomId");l(this,"bottomRoomId");this.topRoomId=e.topRoomId,this.bottomRoomId=e.bottomRoomId,this.position=e.initialPosition??"top"}getCurrentRoomId(){return this.position==="top"?this.topRoomId:this.bottomRoomId}getDestinationRoomId(){return this.position==="top"?this.bottomRoomId:this.topRoomId}};l(Mm,"type","dungeo.trait.basket_elevator"),l(Mm,"capabilities",["if.action.lowering","if.action.raising"]);var _r=Mm;var mi=_(E());var pi={LOWERED:"if.lower.lowered",ALREADY_DOWN:"if.lower.already_down",RAISED:"if.raise.raised",ALREADY_UP:"if.raise.already_up",PLAYER_TRANSPORTED:"dungeo.basket.player_transported"};function Qq(t,e,r){let n=e.getPlayer();return n&&e.getLocation(n.id)===t.id?(e.moveEntity(n.id,r),!0):!1}var kw={validate(t,e,r,n){let i=t.get(_r);return i?i.position==="bottom"?{valid:!1,error:pi.ALREADY_DOWN}:{valid:!0}:{valid:!1,error:"if.lower.cant_lower_that"}},execute(t,e,r,n){let i=t.get(_r);if(!i)return;i.position="bottom";let o=Qq(t,e,i.bottomRoomId);n.playerTransported=o},report(t,e,r,n){let i=[],o=n.playerTransported;return i.push((0,mi.createEffect)("if.event.lowered",{messageId:pi.LOWERED,targetId:t.id,targetName:t.name})),i.push((0,mi.createEffect)("action.success",{actionId:"if.action.lowering",messageId:pi.LOWERED,params:{target:t.name}})),o&&(i.push((0,mi.createEffect)("dungeo.basket.transported",{messageId:pi.PLAYER_TRANSPORTED,direction:"down"})),i.push((0,mi.createEffect)("if.event.auto_look",{reason:"transported"}))),i},blocked(t,e,r,n,i){return[(0,mi.createEffect)("action.blocked",{actionId:"if.action.lowering",messageId:n,params:{target:t.name}})]}},Bw={validate(t,e,r,n){let i=t.get(_r);return i?i.position==="top"?{valid:!1,error:pi.ALREADY_UP}:{valid:!0}:{valid:!1,error:"if.raise.cant_raise_that"}},execute(t,e,r,n){let i=t.get(_r);if(!i)return;i.position="top";let o=Qq(t,e,i.topRoomId);n.playerTransported=o},report(t,e,r,n){let i=[],o=n.playerTransported;return i.push((0,mi.createEffect)("if.event.raised",{messageId:pi.RAISED,targetId:t.id,targetName:t.name})),i.push((0,mi.createEffect)("action.success",{actionId:"if.action.raising",messageId:pi.RAISED,params:{target:t.name}})),o&&(i.push((0,mi.createEffect)("dungeo.basket.transported",{messageId:pi.PLAYER_TRANSPORTED,direction:"up"})),i.push((0,mi.createEffect)("if.event.auto_look",{reason:"transported"}))),i},blocked(t,e,r,n,i){return[(0,mi.createEffect)("action.blocked",{actionId:"if.action.raising",messageId:n,params:{target:t.name}})]}};var Al=class Al{constructor(e){l(this,"type",Al.type);l(this,"guardianId");this.guardianId=e.guardianId}};l(Al,"type","dungeo.trait.troll_axe"),l(Al,"interceptors",["if.action.taking"]),l(Al,"capabilities",["if.scope.visible"]);var En=Al;var xw=_(E());var jv={WHITE_HOT:"dungeo.troll.axe.white_hot",TAKEN:"taken"},jw={preValidate(t,e,r,n){let i=t.get(En);if(!i)return null;let o=e.getEntity(i.guardianId);if(o){let a=o.get(xw.TraitType.COMBATANT);if(a&&a.isAlive)return{valid:!1,error:jv.WHITE_HOT}}return null}},Ww={validate(t,e,r,n){let i=t.get(En);if(!i)return{valid:!0};let o=e.getEntity(i.guardianId);if(o){let a=o.get(xw.TraitType.COMBATANT);if(a&&a.isAlive&&!a.isConscious)return{valid:!1}}return{valid:!0}},execute(){},report(){return[]},blocked(){return[]}};var Wv=class Wv{constructor(e){l(this,"type",Wv.type);l(this,"roomId");l(this,"axeId");this.roomId=e.roomId,this.axeId=e.axeId}};l(Wv,"type","dungeo.trait.troll");var vn=Wv;var Xq=_(E());var Uw={SPITS_AT_PLAYER:"dungeo.troll.spits_at_player",CANT_HEAR_YOU:"dungeo.troll.cant_hear_you"};function Cre(t){let e=t.get?.(Xq.CombatantTrait);return e?!e.isAlive||!e.isConscious:!1}var Hw={preValidate(t,e,r,n){return t.get(vn)?{valid:!1,error:Uw.SPITS_AT_PLAYER}:null}},qw={preValidate(t,e,r,n){return t.get(vn)&&Cre(t)?{valid:!1,error:Uw.CANT_HEAR_YOU}:null}};var Pm=class Pm{constructor(e={}){l(this,"type",Pm.type);l(this,"hasBeenOpened");this.hasBeenOpened=e.hasBeenOpened??!1}};l(Pm,"type","dungeo.trait.egg"),l(Pm,"capabilities",["if.action.opening"]);var _n=Pm;var zc=_(E());var Rl={NO_EXPERTISE:"dungeo.egg.no_expertise",OPENED:"opened"},Gw={validate(t,e,r,n){if(!t.get(_n))return{valid:!0};let o=e.getEntity(r);if(o){let a=o.get(zc.TraitType.ACTOR);if(a&&a.isPlayer)return{valid:!1,error:Rl.NO_EXPERTISE}}return n.entityName=t.name,{valid:!0}},execute(t,e,r,n){let i=t.get(zc.TraitType.OPENABLE);i&&(i.isOpen=!0);let o=t.get(_n);o&&(o.hasBeenOpened=!0)},report(t,e,r,n){let i=[];return i.push((0,zc.createEffect)("if.event.opened",{messageId:Rl.OPENED,targetId:t.id,targetName:t.name})),i.push((0,zc.createEffect)("action.success",{actionId:"if.action.opening",messageId:Rl.OPENED,params:{item:t.name}})),i},blocked(t,e,r,n,i){return[(0,zc.createEffect)("action.blocked",{actionId:"if.action.opening",messageId:n,params:{target:t.name}})]}};var Uv=class Uv{constructor(e){l(this,"type",Uv.type);l(this,"trophyCaseValue");l(this,"trophyCaseDescription");this.trophyCaseValue=e.trophyCaseValue,this.trophyCaseDescription=e.trophyCaseDescription}};l(Uv,"type","dungeo.trait.treasure");var z=Uv;var Hv=class Hv{constructor(){l(this,"type",Hv.type)}};l(Hv,"type","dungeo.trait.trophy_case");var Ds=Hv;var Zq=_(E());var Fw={postExecute(t,e,r,n){let i=n.itemId;if(!i)return;let o=e.getEntity(i);if(!o)return;let a=o.get(z);if(!a?.trophyCaseValue)return;let s=o.get(Zq.IdentityTrait),c=a.trophyCaseDescription??`Placed the ${s?.name??"treasure"} in the trophy case`;e.awardScore(`trophy:${i}`,a.trophyCaseValue,c)}};var km=class km{constructor(e){l(this,"type",km.type);l(this,"isInflated");this.isInflated=e.isInflated}};l(km,"type","dungeo.trait.inflatable"),l(km,"interceptors",["if.action.entering"]);var et=km;var fi=_(E());var qv={PUNCTURED:"dungeo.boat.punctured",STICK_POKES:"dungeo.boat.stick_pokes"};function wre(t){return!!t.attributes?.puncturesBoat||!!t.attributes?.isPointy}function Nre(t){if(!t.get(et)?.isInflated)return!1;let r=t.get(fi.IdentityTrait);if(!r)return!1;let n=r.name?.toLowerCase()||"",i=r.aliases||[],o=["boat","raft"];return o.some(a=>n.includes(a))||i.some(a=>o.some(s=>a.toLowerCase().includes(s)))}var Vw={postValidate(t,e,r,n){if(!Nre(t))return null;let o=e.getContents(r).find(a=>wre(a));return o&&(n.willPuncture=!0,n.punctureItemId=o.id,n.punctureItemName=o.get(fi.IdentityTrait)?.name||"sharp object"),null},postExecute(t,e,r,n){if(!n.willPuncture)return;let i=e.getLocation(t.id);i&&e.moveEntity(r,i);let o=t.get(et);o&&(o.isInflated=!1);let a=t.get(fi.IdentityTrait);a&&(a.name="pile of plastic",a.article="a",a.description="There is a folded pile of plastic here which has a small valve attached. It appears to have been punctured."),t.attributes?.displayName&&(t.attributes.displayName="pile of plastic"),t.has(fi.TraitType.ENTERABLE)&&t.remove(fi.TraitType.ENTERABLE),t.has(fi.TraitType.VEHICLE)&&t.remove(fi.TraitType.VEHICLE),n.punctured=!0},postReport(t,e,r,n){return n.punctured?[(0,fi.createEffect)("game.message",{messageId:"dungeo.boat.punctured",params:{item:n.punctureItemName}})]:[]}};var Gv=class Gv{constructor(e){l(this,"type",Gv.type);l(this,"melted");l(this,"westDestination");l(this,"glacierRoomId");l(this,"torchDestination");this.melted=e.melted??!1,this.westDestination=e.westDestination,this.glacierRoomId=e.glacierRoomId,this.torchDestination=e.torchDestination}};l(Gv,"type","dungeo.trait.glacier");var Kr=Gv;var br=_(E());var jn={GLACIER_MELTS:"dungeo.glacier.melts",THROW_COLD:"dungeo.glacier.throw_cold",THROW_WRONG_ITEM:"dungeo.glacier.throw_wrong_item",MELT_DEATH:"dungeo.glacier.melt_death",MELT_NO_FLAME:"dungeo.glacier.melt_no_flame",MELT_NOTHING:"dungeo.glacier.melt_nothing",MELT_NO_INSTRUMENT:"dungeo.glacier.melt_no_instrument"};function Dre(t){let e=t.get(br.IdentityTrait);return e?(e.name?.toLowerCase()||"").includes("torch"):!1}function Lre(t){return t.get(br.LightSourceTrait)?.isLit??!1}var Yw={preValidate(t,e,r,n){let i=t.get(Kr);if(!i||i.melted)return null;let o=n.itemId;if(!o)return null;let a=e.getEntity(o);return a?Dre(a)?Lre(a)?null:{valid:!1,error:"glacier_cold_torch"}:{valid:!1,error:"glacier_wrong_item"}:null},onBlocked(t,e,r,n,i){return n==="glacier_wrong_item"?[(0,br.createEffect)("game.message",{messageId:jn.THROW_WRONG_ITEM,params:{}})]:n==="glacier_cold_torch"?[(0,br.createEffect)("game.message",{messageId:jn.THROW_COLD,params:{}})]:null},postExecute(t,e,r,n){let i=t.get(Kr);if(!i||i.melted)return;let o=n.itemId;if(!o)return;let a=e.getEntity(o);if(!a)return;n.glacierMelted=!0,i.melted=!0;let s=t.get(br.IdentityTrait);s&&(s.description="A pool of water remains where the massive glacier once stood. A passageway leads west.");let c=e.getEntity(i.glacierRoomId);if(c){let m=c.get(br.RoomTrait);m&&(m.exits[br.Direction.WEST]={destination:i.westDestination})}let d=a.get(br.LightSourceTrait);d&&(d.isLit=!1);let u=a.get(br.IdentityTrait);u&&(u.name="dead torch",u.description="A burned out ivory torch.",u.aliases=["torch","ivory torch","dead torch","ivory"]),e.moveEntity(o,i.torchDestination)},postReport(t,e,r,n){return n.glacierMelted?[(0,br.createEffect)("game.message",{messageId:jn.GLACIER_MELTS,params:{}})]:[]}};var Fv=class Fv{constructor(e){l(this,"type",Fv.type);l(this,"burnableType");l(this,"isBurning");l(this,"burnedOut");l(this,"burnTurnsRemaining");l(this,"size");this.burnableType=e.burnableType,this.isBurning=e.isBurning??!1,this.burnedOut=e.burnedOut??!1,this.burnTurnsRemaining=e.burnTurnsRemaining??0,this.size=e.size??1}};l(Fv,"type","dungeo.trait.burnable");var ye=Fv;var Vv=class Vv{constructor(e){l(this,"type",Vv.type);l(this,"isWaterRoom");l(this,"riverPosition");l(this,"canLaunchBoat");l(this,"launchDestination");l(this,"isRainbowRoom");this.isWaterRoom=e.isWaterRoom??!1,this.riverPosition=e.riverPosition??0,this.canLaunchBoat=e.canLaunchBoat??!1,this.launchDestination=e.launchDestination??null,this.isRainbowRoom=e.isRainbowRoom??!1}};l(Vv,"type","dungeo.trait.river_navigation");var nt=Vv;var Yv=class Yv{constructor(e){l(this,"type",Yv.type);l(this,"tetheredTo");l(this,"burningObject");l(this,"daemonEnabled");this.tetheredTo=e.tetheredTo,this.burningObject=e.burningObject,this.daemonEnabled=e.daemonEnabled}};l(Yv,"type","dungeo.trait.balloon_state");var kt=Yv;function Kc(t){return t==="ledg2"||t==="ledg3"||t==="ledg4"}function Bm(t){return t==="vair1"||t==="vair2"||t==="vair3"||t==="vair4"}function zv(t){return{vlbot:"vair1",vair1:"vair2",vair2:"vair3",vair3:"vair4",vair4:null,ledg2:"vair2",ledg3:"vair3",ledg4:"vair4"}[t]}function Kv(t){return{vlbot:null,vair1:"vlbot",vair2:"vair1",vair3:"vair2",vair4:"vair3",ledg2:"vair2",ledg3:"vair3",ledg4:"vair4"}[t]}var $v=class $v{constructor(e){l(this,"type",$v.type);l(this,"balloonId");this.balloonId=e.balloonId}};l($v,"type","dungeo.trait.balloon_receptacle");var to=$v;var xm=_(E());var Jq={BALLOON_INFLATES:"dungeo.balloon.inflating",PUT_IN_RECEPTACLE:"dungeo.balloon.put_in_receptacle"},Mre="dungeo.balloon.burningObject",Pre="dungeo.balloon.inflated";function kre(t,e,r){let i=t.getContents(e).find(o=>o.get(xm.IdentityTrait)?.name==="cloth bag");if(i){let o=i.get(et);o&&(o.isInflated=r);let a=i.get(xm.IdentityTrait);a&&(r?a.description="The silk bag billows overhead, filled with hot air.":a.description="The cloth bag is draped over the basket.")}}var zw={postValidate(t,e,r,n){let i=t.get(to);if(!i)return null;let o=n.itemId;if(!o)return null;let a=e.getEntity(o);if(!a)return null;let c=a.get(ye)?.isBurning===!0;return n.receptacleTarget=!0,n.itemIsBurning=c,n.balloonId=i.balloonId,null},postExecute(t,e,r,n){if(!n.receptacleTarget)return;let i=n.balloonId;if(!i)return;let o=e.getEntity(i);if(!o)return;let a=o.get(kt);if(!a)return;let s=n.itemId;n.itemIsBurning&&s&&(a.burningObject=s,e.setStateValue(Mre,s),e.setStateValue(Pre,!0),kre(e,i,!0),n.balloonJustInflated=!0,e.setStateValue("dungeo.balloon.just_inflated",!0))},postReport(t,e,r,n){let i=[];return n.balloonJustInflated&&i.push((0,xm.createEffect)("game.message",{messageId:Jq.BALLOON_INFLATES,params:{}})),i}};var Qv=class Qv{constructor(e){l(this,"type",Qv.type);l(this,"keyInLock");l(this,"matUnderDoor");l(this,"keyOnMat");l(this,"connectsRooms");l(this,"blocksDirection");this.keyInLock=e.keyInLock,this.matUnderDoor=e.matUnderDoor,this.keyOnMat=e.keyOnMat,this.connectsRooms=e.connectsRooms,this.blocksDirection=e.blocksDirection}};l(Qv,"type","dungeo.trait.tiny_room_door");var Bt=Qv;var Xv=class Xv{constructor(e){l(this,"type",Xv.type);l(this,"isHidden");this.isHidden=e.isHidden}};l(Xv,"type","dungeo.trait.tiny_room_key");var Ls=Xv;var Zv=class Zv{constructor(e){l(this,"type",Zv.type);l(this,"isUnderDoor");this.isUnderDoor=e.isUnderDoor}};l(Zv,"type","dungeo.trait.under_door");var ba=Zv;var Jv=class Jv{constructor(e){l(this,"type",Jv.type);l(this,"isActivated");this.isActivated=e.isActivated}};l(Jv,"type","dungeo.trait.machine_state");var Ms=Jv;var e_=class e_{constructor(e){l(this,"type",e_.type);l(this,"isFixed");this.isFixed=e.isFixed}};l(e_,"type","dungeo.trait.round_room");var Ia=e_;var t_=class t_{constructor(e){l(this,"type",t_.type);l(this,"ropeAttached");l(this,"hasRailing");l(this,"torchRoomId");this.ropeAttached=e.ropeAttached,this.hasRailing=e.hasRailing,this.torchRoomId=e.torchRoomId}};l(t_,"type","dungeo.trait.rope_state");var Oa=t_;var r_=class r_{constructor(e){l(this,"type",r_.type);l(this,"riddleSolved");this.riddleSolved=e.riddleSolved}};l(r_,"type","dungeo.trait.riddle_room");var ro=r_;var n_=class n_{constructor(e){l(this,"type",n_.type);l(this,"hasWater");this.hasWater=e.hasWater}};l(n_,"type","dungeo.trait.bucket");var gi=n_;var i_=class i_{constructor(e){l(this,"type",i_.type);l(this,"spiritsBlocking");this.spiritsBlocking=e.spiritsBlocking}};l(i_,"type","dungeo.trait.hades_entry");var $c=i_;var o_=class o_{constructor(){l(this,"type",o_.type)}};l(o_,"type","dungeo.trait.frame_piece");var Ps=o_;var Kw=_(E());var a_=class a_{constructor(e){l(this,"type",a_.type);l(this,"basinState");this.basinState=e.basinState}};l(a_,"type","dungeo.trait.basin_room");var hi=a_;var no=_(E());function eG(t){let e=t.createEntity("empty frame",no.EntityType.ITEM);return e.add(new no.IdentityTrait({name:"empty frame",aliases:["frame","picture frame","ornate frame","empty picture frame"],description:"An ornate but empty picture frame. The craftsmanship is exquisite, though the canvas it once held is missing. There appears to be something carved on the back.",properName:!1,article:"an",weight:5})),e.attributes.isEmptyFrame=!0,e.attributes.isBreakable=!0,e.attributes.backDescription='Carved into the back of the frame in rough letters: "Only devotion can reveal my location."',e}function tG(t){let e=t.createEntity("frame piece",no.EntityType.ITEM);return e.add(new no.IdentityTrait({name:"frame piece",aliases:["piece","carved piece","piece of frame","frame fragment"],description:'A piece of the broken frame bearing a carved inscription: "Only devotion can reveal my location."',properName:!1,article:"a",weight:2})),e.add(new Ps),e}function rG(t){let e=t.createEntity("incense",no.EntityType.ITEM);return e.add(new no.IdentityTrait({name:"incense",aliases:["incense","incense stick","stick of incense","joss stick"],description:"A stick of ancient incense, still fragrant after all these years. It was clutched in the skeleton's bony fingers.",properName:!1,article:"a",weight:5})),e.add(new ye({burnableType:"incense",isBurning:!1,burnedOut:!1})),e}function nG(t){let e=t.createEntity("rolled up canvas",no.EntityType.ITEM);return e.add(new no.IdentityTrait({name:"rolled up canvas",aliases:["canvas","rolled canvas","painting","thief's canvas","portrait"],description:"The thief apparently had a superior artistic streak, for this is one of the greatest creations in all of Zork. It is a faithful rendering of The Implementors, the mythical Gods remembered by all inhabitants.",properName:!1,article:"a",weight:5,points:10})),e.add(new z({trophyCaseValue:24})),e}var $w={GHOST_APPEARS:"dungeo.ghost.appears",CANVAS_SPAWNS:"dungeo.ghost.canvas_spawns"},Cl={GHOST_APPEARS:"dungeo.ghost.appears",CANVAS_SPAWNS:"dungeo.ghost.canvas_spawns",WRONG_ITEM:"dungeo.ghost.wrong_item",NOT_BLESSED:"dungeo.ghost.not_blessed"},Qw={postValidate(t,e,r,n){let i=e.getStateValue("dungeo.ghost_ritual.basin_room_id");if(!i||(e.getContainingRoom(r)?.id||e.getLocation(r))!==i)return null;let s=e.getEntity(i);return!s||s.get(hi)?.basinState!=="disarmed"||(n.willCompleteRitual=!0),null},postExecute(t,e,r,n){if(!n.willCompleteRitual)return;let i=e.getStateValue("dungeo.ghost_ritual.gallery_id");if(!i)return;e.removeEntity(t.id);let o=nG(e);e.moveEntity(o.id,i),e.setStateValue("dungeo.ghost_ritual.complete",!0),e.setStateValue("dungeo.ghost_ritual.canvas_id",o.id),n.ritualCompleted=!0},postReport(t,e,r,n){return n.ritualCompleted?[(0,Kw.createEffect)("game.message",{messageId:$w.GHOST_APPEARS}),(0,Kw.createEffect)("game.message",{messageId:$w.CANVAS_SPAWNS})]:[]}};var s_=class s_{constructor(e){l(this,"type",s_.type);l(this,"grid");l(this,"playerPos");l(this,"cardTaken");l(this,"hasExited");l(this,"inPuzzle");l(this,"pushCount");this.grid=[...e.grid],this.playerPos=e.playerPos,this.cardTaken=e.cardTaken,this.hasExited=e.hasExited,this.inPuzzle=e.inPuzzle,this.pushCount=e.pushCount}};l(s_,"type","dungeo.trait.royal_puzzle");var wl=s_;var jm=class jm{constructor(e){l(this,"type",jm.type);l(this,"dingyClosetId");this.dingyClosetId=e.dingyClosetId}};l(jm,"type","dungeo.trait.sphere"),l(jm,"interceptors",["if.action.taking"]);var io=jm;var We=_(E());var c_="dungeo.cage.solved",ks="dungeo.cage.trapped",Qc="dungeo.cage.turns",iG="dungeo.cage.dingy_closet_id";var it={CAGE_FALLS:"dungeo.cage.falls",CAGE_RAISED:"dungeo.cage.raised",POISON_DEATH:"dungeo.cage.poison_death",ROBOT_CRUSH:"dungeo.cage.robot_crush",GAS_WARNING:"dungeo.cage.gas_warning",POISON_GAS_ROOM:"dungeo.cage.poison_gas_room"};function Bre(t,e){let r=t.getContents(e);for(let n of r)if(n.get(We.NpcTrait)?.behaviorId==="robot")return n;return null}function xre(t,e){let r=t.getEntity(e);if(!r)return;let n="The cage is too strong to escape.";We.RoomBehavior.blockExit(r,We.Direction.NORTH,n),We.RoomBehavior.blockExit(r,We.Direction.SOUTH,n),We.RoomBehavior.blockExit(r,We.Direction.EAST,n),We.RoomBehavior.blockExit(r,We.Direction.WEST,n),We.RoomBehavior.blockExit(r,We.Direction.UP,n),We.RoomBehavior.blockExit(r,We.Direction.DOWN,n),We.RoomBehavior.blockExit(r,We.Direction.NORTHEAST,n),We.RoomBehavior.blockExit(r,We.Direction.NORTHWEST,n),We.RoomBehavior.blockExit(r,We.Direction.SOUTHEAST,n),We.RoomBehavior.blockExit(r,We.Direction.SOUTHWEST,n)}var Xw={preValidate(t,e,r,n){let i=t.get(io);if(!i||e.getStateValue(c_))return null;if(e.getStateValue(ks))return{valid:!1,error:it.CAGE_FALLS};let o=e.getLocation(t.id);return o?Bre(e,o)?(xre(e,i.dingyClosetId),e.setStateValue(ks,!0),e.setStateValue(Qc,0),n.cageTrapped=!0,{valid:!1,error:it.CAGE_FALLS}):(e.setStateValue("dungeo.player.dead",!0),e.setStateValue("dungeo.player.death_cause","cage_poison"),n.cagePoisonDeath=!0,{valid:!1,error:it.POISON_DEATH}):null},onBlocked(t,e,r,n,i){let o=[];return i.cageTrapped?o.push((0,We.createEffect)("game.message",{messageId:it.CAGE_FALLS})):i.cagePoisonDeath&&(o.push((0,We.createEffect)("game.message",{messageId:it.POISON_GAS_ROOM})),o.push((0,We.createEffect)("game.message",{messageId:it.POISON_DEATH})),o.push((0,We.createEffect)("emit",{type:"game.player_death",data:{cause:"cage_poison",messageId:it.POISON_DEATH}}))),o.length>0?o:null}};var d_=class d_{constructor(){l(this,"type",d_.type)}};l(d_,"type","dungeo.trait.gas_room");var Bs=d_;var Nl=_(E()),oG={EXPLOSION_DEATH:"dungeo.gas.explosion_death"};function jre(t,e){if(!t.getEntity(e))return!1;let n=t.getContents(e);for(let i of n)if(i.has(Nl.TraitType.LIGHT_SOURCE)&&Nl.LightSourceBehavior.isLit(i)&&i.attributes.isFlame)return!0;return!1}var Zw={preValidate(t,e,r,n){return jre(e,r)?{valid:!1,error:"dungeo.gas_room.explosion"}:null},onBlocked(t,e,r,n,i){return n!=="dungeo.gas_room.explosion"?null:(e.setStateValue("dungeo.player.dead",!0),e.setStateValue("dungeo.player.death_cause","gas_explosion"),[(0,Nl.createEffect)("if.event.player.died",{messageId:oG.EXPLOSION_DEATH,cause:"gas_explosion"})])}};var l_=class l_{constructor(){l(this,"type",l_.type)}};l(l_,"type","dungeo.trait.safe");var oo=l_;var Jw={RUSTED_SHUT:"dungeo.safe.rusted_shut",NO_DOOR:"dungeo.safe.no_door"},eN={preValidate(t,e,r,n){return t.attributes.rustedShut===!0?{valid:!1,error:Jw.RUSTED_SHUT}:null}},tN={preValidate(t,e,r,n){return t.attributes.safeBlownOpen===!0?{valid:!1,error:Jw.NO_DOOR}:null}};var rN={code:"DE",name:"Describe Entity",description:"Full entity inspection (DE <entity-id or name>)",execute(t,e){let r=[];if(e.length===0)return{success:!1,output:["Usage: DE <entity-id or name>"],error:"MISSING_ARG"};let n=t.findEntity(e.join(" "));if(!n)return{success:!1,output:[`Entity not found: ${e.join(" ")}`],error:"NOT_FOUND"};r.push("\u2554\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2557"),r.push(`\u2551 ENTITY: ${n.id.padEnd(53)} \u2551`),r.push("\u255A\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u255D"),r.push(""),r.push("\u250C\u2500 BASIC INFO \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510"),r.push(`\u2502 ID:   ${n.id}`),r.push(`\u2502 Type: ${n.type}`);let i=n.get("identity");i&&(r.push(`\u2502 Name: ${i.name??"<unnamed>"}`),i.aliases?.length>0&&r.push(`\u2502 Aliases: ${i.aliases.join(", ")}`),i.article&&r.push(`\u2502 Article: "${i.article}"`)),r.push("\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518"),r.push(""),r.push("\u250C\u2500 LOCATION \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510");let o=t.world.getLocation(n.id);if(o){let h=t.findEntity(o)?.get("identity");r.push(`\u2502 In: ${h?.name??o} (${o})`)}else r.push("\u2502 In: <nowhere>");r.push("\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518"),r.push(""),r.push("\u250C\u2500 COMPUTED PROPERTIES \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510");let a=n.get(z),s=[["enterable",n.enterable],["portable",n.portable],["isOpen",n.isOpen],["isLocked",n.isLocked],["isOn",n.isOn],["isSwitchable",n.isSwitchable],["isInflated",n.isInflated],["isTreasure",a!==void 0]];for(let[g,h]of s)h!==void 0&&r.push(`\u2502 ${g}: ${h}`);r.push("\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518"),r.push(""),r.push("\u250C\u2500 TRAITS \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510");let c=Array.from(n.traits.keys());if(c.length===0)r.push("\u2502 <none>");else for(let g of c){let h=n.get(g);if(!h)continue;r.push("\u2502"),r.push(`\u2502 \u25B8 ${g.toUpperCase()}`);let y=Object.entries(h).filter(([T])=>!T.startsWith("_"));if(y.length>0)for(let[T,I]of y){let A=Dl(I);r.push(`\u2502   ${T}: ${A}`)}}r.push("\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518"),r.push(""),r.push("\u250C\u2500 TRAIT TYPE CHECKS \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510");let d=[["ENTERABLE",n.has(yi.TraitType.ENTERABLE)],["VEHICLE",n.has(yi.TraitType.VEHICLE)],["CONTAINER",n.has(yi.TraitType.CONTAINER)],["SUPPORTER",n.has(yi.TraitType.SUPPORTER)],["OPENABLE",n.has(yi.TraitType.OPENABLE)],["LOCKABLE",n.has(yi.TraitType.LOCKABLE)],["SWITCHABLE",n.has(yi.TraitType.SWITCHABLE)],["LIGHT_SOURCE",n.has(yi.TraitType.LIGHT_SOURCE)],["SCENERY",n.has(yi.TraitType.SCENERY)]],u=d.filter(([g,h])=>h),m=d.filter(([g,h])=>!h);r.push(`\u2502 Present: ${u.map(([g])=>g).join(", ")||"<none>"}`),r.push(`\u2502 Absent:  ${m.map(([g])=>g).join(", ")}`),r.push("\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518"),r.push(""),r.push("\u250C\u2500 ATTRIBUTES \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510");let f=Object.entries(n.attributes||{});if(f.length===0)r.push("\u2502 <none>");else for(let[g,h]of f)r.push(`\u2502 ${g}: ${Dl(h)}`);if(r.push("\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518"),r.push(""),n.has("container")||n.has("supporter")||n.has("room")||n.has(yi.TraitType.VEHICLE)){r.push("\u250C\u2500 CONTENTS \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510");let g=t.world.getContents(n.id);if(g.length===0)r.push("\u2502 <empty>");else for(let h of g){let y=h.get("identity");r.push(`\u2502 \u2022 ${y?.name??h.id} (${h.id})`)}r.push("\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518")}return{success:!0,output:r}}};function Dl(t){if(t===null)return"null";if(t===void 0)return"undefined";if(typeof t=="string")return`"${t}"`;if(typeof t=="boolean")return t?"true":"false";if(typeof t=="number")return String(t);if(Array.isArray(t))return t.length===0?"[]":t.length<=5?`[${t.map(e=>Dl(e)).join(", ")}]`:`[${t.slice(0,3).map(e=>Dl(e)).join(", ")}, ... (${t.length} items)]`;if(typeof t=="object"){let e=Object.keys(t);return e.length===0?"{}":e.length<=3?`{${e.map(r=>`${r}: ${Dl(t[r])}`).join(", ")}}`:`{${e.slice(0,2).map(r=>`${r}: ${Dl(t[r])}`).join(", ")}, ... (${e.length} keys)}`}return String(t)}var aG=_(E()),nN={code:"DS",name:"Display State",description:"Show game state (turn count, score, phase). Use DS LEDGER for full score breakdown.",execute(t,e){let{world:r}=t;if(e.length>0&&e[0].toLowerCase()==="ledger")return Ure(r);let n=[];n.push("=== GAME STATE ==="),n.push("");let i=r.getScore(),o=r.getMaxScore(),s=r.getCapability(aG.StandardCapabilities.SCORING)?.moves??r.getStateValue("moves")??0,c=r.getStateValue("turnCount")??s;n.push(`Turn: ${c}`),n.push(`Moves: ${s}`),n.push(`Score: ${i}/${o}`);let d=r.getStateValue("gamePhase")??"playing",u=r.getStateValue("gameOver")??!1;n.push(""),n.push(`Phase: ${d}`),n.push(`Game Over: ${u?"YES":"no"}`),n.push(""),n.push("Story State:");let m=["lampTurns","candleTurns","thirstLevel","hungerLevel","trollState","thiefState","cyclopsState","damGateOpen","loudRoomState","coalMineState","volcanoState"],f=!1;for(let T of m){let I=r.getStateValue(T);I!==void 0&&(n.push(`  ${T}: ${JSON.stringify(I)}`),f=!0)}f||n.push("  <no story-specific flags set>"),n.push(""),n.push("Entity Counts:");let g=t.listRooms(),h=t.listObjects(),y=r.getAllEntities();return n.push(`  Rooms: ${g.length}`),n.push(`  Objects: ${h.length}`),n.push(`  Total entities: ${y.length}`),n.push(""),n.push("GDT Flags:"),n.push(`  Immortal: ${t.flags.immortal?"YES":"no"}`),n.push(`  Troll disabled: ${t.flags.trollDisabled?"YES":"no"}`),n.push(`  Thief disabled: ${t.flags.thiefDisabled?"YES":"no"}`),n.push(`  Cyclops disabled: ${t.flags.cyclopsDisabled?"YES":"no"}`),{success:!0,output:n}}};function Ure(t){let e=t.getScoreEntries(),r=t.getScore(),n=t.getMaxScore(),i=[];if(i.push("=== SCORE LEDGER ==="),i.push(""),e.length===0)return i.push("  <no score entries>"),i.push(""),i.push(`Total: 0/${n}`),{success:!0,output:i};let o=new Map;for(let d of e){let u=d.id.indexOf(":"),m=u>=0?d.id.substring(0,u):"bonus";o.has(m)||o.set(m,{entries:[],subtotal:0});let f=o.get(m);f.entries.push(d),f.subtotal+=d.points}let a=["treasure","trophy","room"],s=[...o.keys()].filter(d=>!a.includes(d)).sort(),c=[...a.filter(d=>o.has(d)),...s];for(let d of c){let u=o.get(d);i.push(`${d.toUpperCase()} (${u.subtotal} pts):`),u.entries.sort((m,f)=>f.points-m.points||m.id.localeCompare(f.id));for(let m of u.entries){let f=m.points>=0?"+":"",g=m.description?` - ${m.description}`:"";i.push(`  ${m.id} = ${f}${m.points}${g}`)}i.push("")}return i.push(`Total: ${r}/${n} (${e.length} entries)`),{success:!0,output:i}}var iN={code:"DX",name:"Display Exits",description:"Show room exits in detail (DX [room-id])",execute(t,e){let r=[],n;if(e.length>0){if(n=t.findRoom(e[0]),!n)return{success:!1,output:[`Room not found: ${e[0]}`],error:"NOT_FOUND"}}else if(n=t.getPlayerLocation(),!n)return{success:!1,output:["Player has no location"],error:"NO_LOCATION"};let i=n.get("identity"),o=n.get("room");r.push("=== EXITS ==="),r.push(""),r.push(`Room: ${i?.name??n.id} (${n.id})`),r.push("");let a=["NORTH","SOUTH","EAST","WEST","NORTHEAST","NORTHWEST","SOUTHEAST","SOUTHWEST","UP","DOWN","IN","OUT"],s=o?.exits??{},c=o?.blockedExits??{};for(let u of a){let m=s[u],f=c[u];if(m){let y=t.findRoom(m.destination)?.get("identity")?.name??m.destination,T=`  ${u.padEnd(10)} -> ${y} (${m.destination})`;if(m.via){let I=t.findEntity(m.via),L=I?.get("identity")?.name??m.via;if(T+=` [via: ${L}]`,I){let S=I.get("openable"),R=I.get("lockable");S&&(T+=S.isOpen?" (open)":" (closed)"),R?.isLocked&&(T+=" (LOCKED)")}}r.push(T)}else f&&r.push(`  ${u.padEnd(10)} -> BLOCKED: ${f}`)}let d=Object.keys(s).length;return r.push(""),r.push(`Total exits: ${d}`),{success:!0,output:r}}};var oN={code:"AH",name:"Alter Here",description:"Teleport player to room (AH <room-id>)",execute(t,e){if(e.length===0){let a=t.listRooms(),s=["Usage: AH <room-id>","","Available rooms:"],c=new Map;for(let u of a){let m=u.get("identity"),g=u.get("room")?.region??"Other";c.has(g)||c.set(g,[]),c.get(g).push({id:u.id,name:m?.name??u.id})}let d=Array.from(c.keys()).sort();for(let u of d){s.push(`  [${u}]`);let m=c.get(u);for(let f of m.slice(0,10))s.push(`    ${f.id}: ${f.name}`);m.length>10&&s.push(`    ... and ${m.length-10} more`)}return{success:!0,output:s}}let r=e.join(" "),n=t.findRoom(r);return n?t.teleportPlayer(n.id)?{success:!0,output:[`Teleported to: ${n.get("identity")?.name??n.id} (${n.id})`]}:{success:!1,output:[`Failed to teleport to: ${n.id}`],error:"TELEPORT_FAILED"}:{success:!1,output:[`Room not found: ${r}`],error:"NOT_FOUND"}}};var aN={code:"TK",name:"Take",description:"Acquire any object (TK <object-id>)",execute(t,e){if(e.length===0)return{success:!1,output:["Usage: TK <object-id or name>"],error:"MISSING_ARG"};let r=e.join(" "),n=t.findEntity(r);return n?n.has("room")?{success:!1,output:[`Cannot take a room: ${r}`],error:"INVALID_TARGET"}:t.moveObject(n.id,"player")?{success:!0,output:[`Taken: ${n.get("identity")?.name??n.id} (${n.id})`]}:{success:!1,output:[`Failed to take: ${n.id}`],error:"MOVE_FAILED"}:{success:!1,output:[`Object not found: ${r}`],error:"NOT_FOUND"}}};var sN={code:"AO",name:"Alter Object",description:"Move object to location (AO <object-id> <location-id>)",execute(t,e){if(e.length<2)return{success:!1,output:["Usage: AO <object-name> <location-name>","","Special locations:","  player - Move to player inventory","  here   - Move to current room","  <room-name> - Move to specific room","  <object-name> - Move into container/supporter"],error:"MISSING_ARGS"};let r=e[e.length-1],n=e.slice(0,-1).join(" "),i=t.findEntity(n);if(!i)return{success:!1,output:[`Object not found: ${n}`],error:"OBJECT_NOT_FOUND"};if(r==="here"){let c=t.getPlayerLocation();if(!c)return{success:!1,output:["Player has no current location"],error:"NO_LOCATION"};r=c.id}let o=r;if(r!=="player"&&r!=="inventory"){let c=t.findEntity(r);if(!c)return{success:!1,output:[`Location not found: ${r}`],error:"LOCATION_NOT_FOUND"};o=c.get("identity")?.name??c.id,r=c.id}else o="player inventory";return t.moveObject(i.id,r)?{success:!0,output:[`Moved: ${i.get("identity")?.name??i.id} -> ${o}`]}:{success:!1,output:[`Failed to move ${i.id} to ${r}`],error:"MOVE_FAILED"}}};var cN={code:"DF",name:"Display Flags",description:"Deprecated - use DO instead",execute(t,e){return{success:!0,output:["DF (Display Flags) was used in the FORTRAN/MDL versions of Zork","where objects had bit flags (TAKEBIT, OPENBIT, LIGHTBIT, etc.).","","Sharpee uses trait-based composition instead.","Use DO <entity> to view entity state and traits."]}}};var dN={code:"AF",name:"Alter Flags",description:"Deprecated - use game commands instead",execute(t,e){return{success:!0,output:["AF (Alter Flags) was used in the FORTRAN/MDL versions of Zork","where objects had bit flags that could be directly toggled.","","Sharpee uses trait-based composition instead.","To modify entity state, use:","  - Game commands (open, close, turn on, etc.)","  - AO to move objects","  - AH to teleport the player"]}}};var lN={code:"ND",name:"No Deaths",description:"Enable immortality mode",execute(t,e){return t.flags.immortal?{success:!0,output:["Immortality already enabled."]}:(t.setFlag("immortal",!0),{success:!0,output:["Immortality ENABLED. You cannot die."]})}};var uN={code:"RD",name:"Restore Deaths",description:"Disable immortality mode",execute(t,e){return t.flags.immortal?(t.setFlag("immortal",!1),{success:!0,output:["Immortality DISABLED. You can die again."]}):{success:!0,output:["Immortality already disabled."]}}};var RG=_(E());var ke={APPEARS:"dungeo.thief.appears",LEAVES:"dungeo.thief.leaves",LURKS:"dungeo.thief.lurks",STEALS_FROM_PLAYER:"dungeo.thief.steals_from_player",STEALS_FROM_ROOM:"dungeo.thief.steals_from_room",NOTICES_VALUABLES:"dungeo.thief.notices_valuables",GLOATS:"dungeo.thief.gloats",OPENS_EGG:"dungeo.thief.opens_egg",ATTACKS:"dungeo.thief.attacks",COUNTERATTACKS:"dungeo.thief.counterattacks",DODGES:"dungeo.thief.dodges",WOUNDED:"dungeo.thief.wounded",FLEES:"dungeo.thief.flees",DIES:"dungeo.thief.dies",DROPS_LOOT:"dungeo.thief.drops_loot",BLACK_FOG:"dungeo.thief.black_fog",BOOTY_REMAINS:"dungeo.thief.booty_remains",TREASURES_REAPPEAR:"dungeo.thief.treasures_reappear",FRAME_SPAWNS:"dungeo.thief.frame_spawns"};var Jt=_(E());function sG(t){return{state:"WANDERING",lairRoomId:t,turnsWithEgg:0,turnsInRoom:0,lastKnownPlayerRoom:null,stealCooldown:0,hasBeenAttacked:!1}}function mN(t,e,r=[]){let n=t.createEntity("thief",Jt.EntityType.ACTOR);n.add(new Jt.IdentityTrait({name:"seedy-looking thief",aliases:["thief","robber","seedy thief","seedy gentleman","gentleman","man"],description:"A seedy-looking gentleman, shabbily dressed but with an air of confidence. His eyes dart about, assessing everything of value.",properName:!1,article:"a"})),n.add(new Jt.ActorTrait({isPlayer:!1})),n.add(new Jt.NpcTrait({behaviorId:"thief",isHostile:!1,canMove:!0,forbiddenRooms:r,customProperties:sG(e)})),n.add(new Jt.CombatantTrait({health:25,maxHealth:25,skill:70,baseDamage:4,armor:0,hostile:!1,canRetaliate:!0,dropsInventory:!0,deathMessage:"The thief falls to the ground, a look of surprise frozen on his face."})),n.add(new Jt.ContainerTrait({capacity:{maxItems:50,maxWeight:500}})),t.moveEntity(n.id,e);let i=Hre(t,n.id);return n.attributes.stilettoId=i.id,n}function Hre(t,e){let r=t.createEntity("stiletto",Jt.EntityType.ITEM);return r.add(new Jt.IdentityTrait({name:"nasty stiletto",aliases:["stiletto","knife","dagger","nasty knife","thief knife"],description:"A long, thin, wickedly sharp knife. The kind of weapon favored by cutthroats and thieves.",properName:!1,article:"a"})),r.add(new Jt.WeaponTrait({damage:6,skillBonus:10,weaponType:"piercing"})),t.moveEntity(r.id,e),r}var Ei=_(E());var kl=_(E());var v={MISSED:0,UNCONSCIOUS:1,KILLED:2,LIGHT_WOUND:3,SERIOUS_WOUND:4,STAGGER:5,LOSE_WEAPON:6,HESITATE:7,SITTING_DUCK:8},pN=[v.MISSED,v.MISSED,v.MISSED,v.MISSED,v.STAGGER,v.STAGGER,v.UNCONSCIOUS,v.UNCONSCIOUS,v.KILLED,v.KILLED,v.KILLED,v.KILLED,v.KILLED],qre=[v.MISSED,v.MISSED,v.MISSED,v.MISSED,v.MISSED,v.STAGGER,v.STAGGER,v.LIGHT_WOUND,v.LIGHT_WOUND,v.UNCONSCIOUS],fN=[v.MISSED,v.MISSED,v.MISSED,v.STAGGER,v.STAGGER,v.LIGHT_WOUND,v.LIGHT_WOUND,v.LIGHT_WOUND,v.UNCONSCIOUS,v.KILLED,v.KILLED,v.KILLED],cG=[v.MISSED,v.MISSED,v.MISSED,v.MISSED,v.MISSED,v.STAGGER,v.STAGGER,v.LIGHT_WOUND,v.LIGHT_WOUND,v.SERIOUS_WOUND,v.SERIOUS_WOUND],dG=[v.MISSED,v.MISSED,v.MISSED,v.STAGGER,v.STAGGER,v.LIGHT_WOUND,v.LIGHT_WOUND,v.LIGHT_WOUND,v.SERIOUS_WOUND,v.SERIOUS_WOUND,v.SERIOUS_WOUND],Gre=[v.MISSED,v.STAGGER,v.STAGGER,v.LIGHT_WOUND,v.LIGHT_WOUND,v.LIGHT_WOUND,v.LIGHT_WOUND,v.SERIOUS_WOUND,v.SERIOUS_WOUND,v.SERIOUS_WOUND],Fre=9;function Wn(t,e){return t.slice(e,e+Fre)}var Vre=[Wn(pN,0),Wn(pN,1),Wn(pN,2)],Yre=[Wn(qre,0),Wn(fN,0),Wn(fN,1),Wn(fN,2)],zre=[Wn(cG,0),Wn(cG,1),Wn(dG,0),Wn(dG,1),Wn(Gre,0)];function lG(t,e){if(e===1){let i=Math.min(t,3)-1;return Vre[Math.max(0,i)]}if(e===2){let i=Math.min(t,4)-1;return Yre[Math.max(0,i)]}let n=Math.max(-2,Math.min(2,t-e))+2;return zre[n]}var uG=2,Kre=7,$re=616,Wm=30,Ll={TROLL:2,THIEF:5,CYCLOPS:1e4},Qre=[{villainName:"troll",weaponName:"sword",penalty:1},{villainName:"thief",weaponName:"knife",penalty:1}];function Sa(t,e=0,r=!0){let n=uG+Math.floor(.5+(Kre-uG)*(t/$re));return r?n+e:n}function u_(t,e=!1,r=!1,n=1){let i=t;return i<=0?0:(e&&(i=Math.min(i,2)),r&&(i=Math.max(1,i-n)),i)}function mG(t,e){return Qre.find(n=>t.includes(n.villainName)&&e.includes(n.weaponName))?.penalty??0}function m_(t,e,r,n,i){t=Math.max(1,t);let o={outcome:v.MISSED,newDefenderStrength:e,defenderStaggered:!1,defenderLostWeapon:!1,defenderKilled:!1,defenderUnconscious:!1};if(e<0)return o.outcome=v.KILLED,o.newDefenderStrength=0,o.defenderKilled=!0,o;if(e===0)return o.outcome=v.MISSED,o;let a=lG(t,e),s=i.int(0,a.length-1),c=a[s];switch(n&&(c===v.STAGGER?c=v.HESITATE:c=v.SITTING_DUCK),c===v.STAGGER&&i.chance(.25)&&(c=v.LOSE_WEAPON),o.outcome=c,c){case v.MISSED:case v.HESITATE:break;case v.UNCONSCIOUS:r&&(o.newDefenderStrength=-e),o.defenderUnconscious=!0;break;case v.KILLED:case v.SITTING_DUCK:o.newDefenderStrength=0,o.defenderKilled=!0;break;case v.LIGHT_WOUND:o.newDefenderStrength=Math.max(0,e-1),o.newDefenderStrength===0&&(o.defenderKilled=!0);break;case v.SERIOUS_WOUND:o.newDefenderStrength=Math.max(0,e-2),o.newDefenderStrength===0&&(o.defenderKilled=!0);break;case v.STAGGER:o.defenderStaggered=!0;break;case v.LOSE_WEAPON:o.defenderLostWeapon=!0;break}return o}function gN(t,e){return Sa(t,e,!0)<=0}function hN(t,e,r){return e.defenderKilled?-1e4:e.newDefenderStrength-r}function pG(t){if(t>0)return{newWoundAdjust:0,healed:!0};if(t<0){let e=t+1;return{newWoundAdjust:e,healed:e>=0}}return{newWoundAdjust:0,healed:!0}}function fG(t,e,r,n){let i=Sa(t,0,!1),o=e<0?-e:0,a=i+e,s=o===0?0:(o-1)*Wm+r;return{woundDepth:o,remainingStrength:a,turnsToHeal:s,deaths:n}}function gG(t){let{villainStrength:e,heroFightStrength:r,random:n}=t,i=e-r,o,a;return i>3?(o=90,a=100):i>0?(o=75,a=85):i===0?(o=50,a=30):e>1?(o=25,a=0):(o=10,a=0),{shouldAttack:n.int(1,100)<=o,shouldStay:n.int(1,100)<=a}}var hG=_(E());var pe={WOUND_ADJUST:"meleeWoundAdjust",STAGGERED:"meleeStaggered",VILLAIN_STAGGERED:"meleeVillainStaggered",VILLAIN_UNCONSCIOUS:"meleeVillainUnconscious",VILLAIN_OSTRENGTH:"meleeOstrength"},Ml={TICKS:"dungeo.cure.ticks"};function Pl(t){let r=t.get(hG.TraitType.IDENTITY)?.name?.toLowerCase()??"";return r.includes("troll")?Ll.TROLL:r.includes("thief")?Ll.THIEF:r.includes("cyclops")?Ll.CYCLOPS:3}var yG="dungeo.thief.disabled";function TG(t){return t.get(z)!==void 0}function yN(t){let e=t.get(kl.IdentityTrait),r=t.get(z),n=e?.points??0,i=r?.trophyCaseValue??0;return n+i}function TN(t,e){return t.getEntity(e)?t.getContents(e).filter(i=>TG(i)?!i.get(kl.IdentityTrait)?.concealed:!1).sort((i,o)=>yN(o)-yN(i)):[]}function Bl(t){let e=t.world.getPlayer();return e?TN(t.world,e.id):[]}function p_(t){return TN(t.world,t.npcLocation)}function EN(t){return t.npcInventory.some(e=>(e.get(kl.IdentityTrait)?.name?.toLowerCase()??"").includes("egg"))}function Ti(t){let e=t.get(kl.NpcTrait);if(e?.customProperties)return e.customProperties}function Um(t){let e=Ti(t.npc);return e?t.npcLocation===e.lairRoomId:!1}function f_(t){return t.npcInventory.filter(e=>{let r=e.get(z);return r!==void 0&&r.trophyCaseValue>0})}function g_(t){return t.getDataStore().state[yG]===!0}function Hm(t,e){let r=t.getDataStore();r.state[yG]=e}function EG(t){t.stealCooldown>0&&t.stealCooldown--}function Xre(t){return t.getScore()}function Zre(t){let e=t.attributes[pe.VILLAIN_OSTRENGTH];return typeof e=="number"?e:Ll.THIEF}function Jre(t){let e=Xre(t),n=t.getPlayer()?.attributes?.[pe.WOUND_ADJUST]??0;return Sa(e,n)}function vN(t){let e=Zre(t.npc),r=Jre(t.world);return gG({villainStrength:e,heroFightStrength:r,random:t.random})}function vG(t){if(!t.playerVisible)return!1;let{shouldAttack:e}=vN(t);return e}var ene=.33,tne=.4,_G=5,bG=3;var _N={id:"thief",name:"Thief Behavior",onTurn(t){let e=Ti(t.npc);if(!e)return[];if(g_(t.world))return[];if(e.state==="DISABLED")return[];EG(e);let r=one(t,e);if(r.length>0)return r;if(e.state==="FIGHTING")return IG(t,e);if(EN(t)?t.npc.attributes.thiefEngrossed=!0:t.npc.attributes.thiefEngrossed=!1,vG(t)&&!e.hasBeenAttacked)return e.state="FIGHTING",IG(t,e);switch(e.state){case"WANDERING":return rne(t,e);case"STALKING":return OG(t,e);case"STEALING":return bN(t,e);case"RETURNING":return nne(t,e);case"FLEEING":return ine(t,e);default:return[]}},onPlayerEnters(t){let e=Ti(t.npc);return!e||e.state==="DISABLED"?[]:g_(t.world)?[]:(e.lastKnownPlayerRoom=t.playerLocation,Bl(t).length>0&&t.random.chance(.5)?[{type:"emote",messageId:ke.NOTICES_VALUABLES,data:{npcName:t.npc.name}}]:[{type:"emote",messageId:ke.APPEARS,data:{npcName:t.npc.name}}])},onPlayerLeaves(t){let e=Ti(t.npc);return!e||e.state==="DISABLED"?[]:(e.lastKnownPlayerRoom=t.playerLocation,[])},onAttacked(t,e){let r=Ti(t.npc);if(!r)return[];r.hasBeenAttacked=!0,r.state="FIGHTING";let n=t.npc.get(Ei.CombatantTrait);return n&&(n.hostile=!0),[{type:"emote",messageId:ke.COUNTERATTACKS,data:{npcName:t.npc.name}},{type:"attack",target:e.id}]},getState(t){return t.get(Ei.NpcTrait)?.customProperties??{}},setState(t,e){let r=t.get(Ei.NpcTrait);r&&(r.customProperties=e)}};function rne(t,e){let r=[];if(t.playerVisible&&Bl(t).length>0)return e.state="STALKING",e.lastKnownPlayerRoom=t.playerLocation,OG(t,e);if(p_(t).length>0&&!t.playerVisible)return e.state="STEALING",bN(t,e);if(t.random.chance(ene)){let i=t.getAvailableExits();if(i.length>0){let o=t.random.pick(i);r.push({type:"move",direction:o.direction}),e.turnsInRoom=0}}else e.turnsInRoom++;return r}function OG(t,e){if(t.playerVisible)return e.lastKnownPlayerRoom=t.playerLocation,Bl(t).length>0&&e.stealCooldown<=0&&t.random.chance(tne)?(e.state="STEALING",bN(t,e)):t.random.chance(.2)?[{type:"emote",messageId:ke.GLOATS,data:{npcName:t.npc.name}}]:[];if(e.lastKnownPlayerRoom&&e.lastKnownPlayerRoom!==t.npcLocation){let n=t.getAvailableExits().find(i=>i.destination===e.lastKnownPlayerRoom);if(n)return[{type:"move",direction:n.direction}]}return e.state="WANDERING",e.lastKnownPlayerRoom=null,[]}function bN(t,e){let r=[];if(t.playerVisible){let i=Bl(t);if(i.length>0){let o=i[0],s=o.get(Ei.IdentityTrait)?.name??"item";return r.push({type:"take",target:o.id}),r.push({type:"speak",messageId:ke.STEALS_FROM_PLAYER,data:{itemName:s}}),e.stealCooldown=_G,f_(t).length>=bG?e.state="RETURNING":e.state="WANDERING",r}}let n=p_(t);if(n.length>0){let i=n[0];if(r.push({type:"take",target:i.id}),t.playerVisible){let a=i.get(Ei.IdentityTrait);r.push({type:"emote",messageId:ke.STEALS_FROM_ROOM,data:{itemName:a?.name??"something"}})}return e.stealCooldown=_G,f_(t).length>=bG?e.state="RETURNING":e.state="WANDERING",r}return e.state="WANDERING",[]}function nne(t,e){if(Um(t))return e.state="WANDERING",[];let r=t.getAvailableExits();if(r.length>0){let n=r.find(o=>o.destination===e.lairRoomId);return n?[{type:"move",direction:n.direction}]:[{type:"move",direction:t.random.pick(r).direction}]}return[]}function IG(t,e){if(t.playerVisible){let{shouldAttack:r,shouldStay:n}=vN(t),i=t.npcLocation===e.lairRoomId;if(!n&&!i){let o=[{type:"emote",messageId:ke.FLEES,data:{npcName:t.npc.name}}],a=t.getAvailableExits();if(a.length>0){let c=a.find(d=>d.destination===e.lairRoomId)??t.random.pick(a);o.push({type:"move",direction:c.direction})}return e.state="WANDERING",o}if(r){let o=t.world.getPlayer();if(o)return[{type:"emote",messageId:ke.ATTACKS,data:{npcName:t.npc.name}},{type:"attack",target:o.id}]}return[]}if(e.lastKnownPlayerRoom&&e.lastKnownPlayerRoom!==t.npcLocation){let n=t.getAvailableExits().find(i=>i.destination===e.lastKnownPlayerRoom);if(n)return[{type:"move",direction:n.direction}]}return e.state="WANDERING",[]}function ine(t,e){let r=[];if(e.state!=="FLEEING"&&r.push({type:"emote",messageId:ke.FLEES,data:{npcName:t.npc.name}}),Um(t))return e.state="WANDERING",r;let n=t.getAvailableExits();if(n.length>0){let i=n.find(o=>o.destination===e.lairRoomId);if(i)r.push({type:"move",direction:i.direction});else if(t.playerVisible){let o=t.random.pick(n);r.push({type:"move",direction:o.direction})}else{let o=t.random.pick(n);r.push({type:"move",direction:o.direction})}}return r}function one(t,e){if(!Um(t)||t.playerVisible)return[];let r=f_(t);return r.length===0?[]:[{type:"custom",handler:()=>{for(let n of r){let i=n.get(_n);if(i&&!i.hasBeenOpened){let a=n.get(Ei.OpenableTrait);a&&!a.isOpen&&(a.isOpen=!0),i.hasBeenOpened=!0}t.world.moveEntity(n.id,t.npcLocation);let o=n.get(Ei.IdentityTrait);o&&(o.concealed=!0)}return t.npc.attributes.thiefEngrossed=!1,[]}}]}var SG=_(E());function AG(t,e,r,n=[]){t.registerBehavior(_N);let i=mN(e,r,n),a=e.getContents(r).find(s=>s.get(SG.IdentityTrait)?.name==="silver chalice");return a&&e.moveEntity(a.id,i.id),i}var IN={code:"NR",name:"No Robber",description:"Disable the thief NPC",execute(t,e){if(t.flags.thiefDisabled)return{success:!0,output:["Thief already disabled."]};let r=t.world.getAllEntities().find(i=>i.get(RG.NpcTrait)?.behaviorId==="thief");if(!r)return{success:!1,output:["Thief not found in world."],error:"NOT_FOUND"};let n=Ti(r);return n&&(n.state="DISABLED"),t.setFlag("thiefDisabled",!0),Hm(t.world,!0),{success:!0,output:["Thief DISABLED.","The thief will not wander, steal, or attack.","Use RR to restore thief behavior."]}}};var CG=_(E());var ON={code:"RR",name:"Restore Robber",description:"Re-enable the thief NPC",execute(t,e){if(!t.flags.thiefDisabled)return{success:!0,output:["Thief already enabled."]};let r=t.world.getAllEntities().find(i=>i.get(CG.NpcTrait)?.behaviorId==="thief");if(!r)return{success:!1,output:["Thief not found in world."],error:"NOT_FOUND"};let n=Ti(r);return n&&(n.state="WANDERING"),t.setFlag("thiefDisabled",!1),Hm(t.world,!1),{success:!0,output:["Thief RESTORED to active duty.","The thief will resume wandering and stealing."]}}};var SN="dungeo.scheduler.ref";function ane(t){return t.world.getCapability(SN)}var AN={code:"DC",name:"Display Clock",description:"Show active daemons and fuses (timed events)",execute(t,e){let r=[];r.push("=== CLOCK EVENTS (ADR-071) ==="),r.push("");let n=ane(t);if(!n)return r.push("ERROR: Scheduler not available"),r.push("(Scheduler reference not set in world capability)"),{success:!1,output:r,error:"NO_SCHEDULER"};r.push("DAEMONS (persistent):");let i=n.getActiveDaemons();if(i.length===0)r.push("  <no daemons registered>");else for(let a of i){let s=a.isPaused?"paused":"active",c=a.priority??0;r.push(`  [${s}] ${a.id} - "${a.name}" (priority: ${c})`)}r.push(""),r.push("FUSES (countdown):");let o=n.getActiveFuses();if(o.length===0)r.push("  <no fuses active>");else for(let a of o){let s=a.isPaused?"paused ":"running",c=a.priority??0,d=a.repeat?" [repeating]":"",u=a.entityId?` (entity: ${a.entityId})`:"";r.push(`  [${s}] ${a.id} - "${a.name}" turns: ${a.turnsRemaining} (priority: ${c})${d}${u}`)}if(r.push(""),r.push(`Total: ${i.length} daemons, ${o.length} fuses`),e.length>0){let a=e[0].toLowerCase();r.push(""),r.push(`Filter: "${a}"`);let s=i.filter(d=>d.id.toLowerCase().includes(a)||d.name.toLowerCase().includes(a)),c=o.filter(d=>d.id.toLowerCase().includes(a)||d.name.toLowerCase().includes(a));s.length>0||c.length>0?r.push(`Matched: ${s.length} daemons, ${c.length} fuses`):r.push("No matches found.")}return{success:!0,output:r}}};function RN(t,e){if(typeof t.registerCapability=="function")try{t.registerCapability(SN,{initialData:e})}catch{let r=t.getCapability(SN);r&&Object.assign(r,e)}}var UG=_(E());var ot=_(E());var sne=1,ao=0,h_=-1,Aa=-2,NG=-3,js={north:-8,south:8,east:1,west:-1,northeast:-7,northwest:-9,southeast:9,southwest:7},DG=[1,1,1,1,1,1,1,1,1,0,-1,0,0,-1,0,1,1,-1,0,1,0,-2,0,1,1,0,0,0,0,1,0,1,1,-3,0,0,-1,-1,0,1,1,0,0,-1,0,0,0,1,1,1,1,0,0,0,1,1,1,1,1,1,1,1,1,1],vi=9,jl=10;function cne(t){let e=t.createEntity("Royal Puzzle Controller",ot.EntityType.OBJECT);return e.add(new ot.IdentityTrait({name:"Royal Puzzle Controller",aliases:[],description:"Puzzle state controller (not visible to player)",properName:!0,article:"the"})),e.add(new wl({grid:[...DG],playerPos:vi,cardTaken:!1,hasExited:!1,inPuzzle:!1,pushCount:0})),e}function Ir(t){let e=t.get(wl);if(!e)throw new Error("Royal Puzzle Controller missing RoyalPuzzleTrait");return e}function LG(t){let e=Ir(t);e.grid=[...DG],e.playerPos=vi,e.cardTaken=!1,e.hasExited=!1,e.inPuzzle=!1,e.pushCount=0}function dne(t){return Math.floor(t/8)}function lne(t){return t%8}function xs(t){return t>=0&&t<64}function xl(t,e){let r=lne(t),n=dne(t);switch(e){case"east":case"northeast":case"southeast":return r===7;case"west":case"northwest":case"southwest":return r===0;case"north":return n===0;case"south":return n===7;default:return!1}}function une(t,e){if(xl(t.playerPos,e))return!1;let r=t.playerPos+js[e];return xs(r)?t.grid[r]===ao:!1}function mne(t,e){if(xl(t.playerPos,e))return!1;let r=t.playerPos+js[e];if(!xs(r)||t.grid[r]!==ao)return!1;let n,i;switch(e){case"northeast":n=1,i=-8;break;case"northwest":n=-1,i=-8;break;case"southeast":n=1,i=8;break;case"southwest":n=-1,i=8;break}let o=t.playerPos+n,a=t.playerPos+i,s=xs(o)&&t.grid[o]===ao,c=xs(a)&&t.grid[a]===ao;return s||c}function wN(t,e){return["north","south","east","west"].includes(e)?une(t,e):mne(t,e)}function MG(t,e){t.playerPos=t.playerPos+js[e]}function PG(t,e){let r=js[e];if(xl(t.playerPos,e))return"boundary";let n=t.playerPos+r;if(!xs(n))return"boundary";let i=t.grid[n];if(i===ao)return"no-wall";if(i===sne)return"immovable";if(xl(n,e))return"no-room";let o=n+r;return!xs(o)||t.grid[o]!==ao?"no-room":"success"}function kG(t,e){let r=js[e],n=t.playerPos+r,i=n+r;t.grid[i]=t.grid[n],t.grid[n]=ao,t.playerPos=n,t.pushCount++}function y_(t){return t.playerPos!==vi?!1:t.grid[jl]===Aa}function Wl(t){if(t.cardTaken)return!1;for(let e of["north","south","east","west"]){if(xl(t.playerPos,e))continue;let r=t.playerPos+js[e];if(xs(r)&&t.grid[r]===NG)return!0}return!1}function BG(t){let e=t.grid.indexOf(NG);e!==-1&&(t.grid[e]=h_,t.cardTaken=!0)}function pne(t){let e=[];for(let r of Object.keys(js))wN(t,r)&&e.push(r);return y_(t)&&e.push("up"),e}function NN(t){for(let e of["north","south","east","west"]){if(xl(t.playerPos,e))continue;let r=t.playerPos+js[e];if(xs(r)&&t.grid[r]===Aa)return!0}return!1}function fne(t){return t.length===0?"nowhere":t.length===1?t[0]:t.length===2?`${t[0]} and ${t[1]}`:t.slice(0,-1).join(", ")+", and "+t[t.length-1]}function Xc(t){let e=["You are in a maze of sandstone walls."],r=pne(t);if(r.length>0){let n=r.map(i=>{switch(i){case"north":return"north";case"south":return"south";case"east":return"east";case"west":return"west";case"northeast":return"northeast";case"northwest":return"northwest";case"southeast":return"southeast";case"southwest":return"southwest";case"up":return"up";default:return i}});e.push(`Passages lead ${fne(n)}.`)}return t.playerPos===vi&&(y_(t)?e.push("Above you is a hole in the ceiling. A wooden ladder on the eastern wall reaches up to it."):e.push("Above you is a hole in the ceiling, but there is no way to reach it.")),NN(t)&&t.playerPos!==vi&&e.push("One of the sandstone walls has a wooden ladder attached to it."),Wl(t)&&e.push("Set into one wall is a small depression. Within it rests a gold card, embossed with the royal crest."),e.join(" ")}function CN(t,e,r,n=[],i=!0){let o=t.createEntity(e,ot.EntityType.ROOM);return o.add(new ot.RoomTrait({exits:{},isDark:i,isOutdoors:!1})),o.add(new ot.IdentityTrait({name:e,aliases:n,description:r,properName:!0,article:"the"})),o}function wG(t,e){let r=t.get(ot.RoomTrait);if(r)for(let[n,i]of Object.entries(e))r.exits[n]={destination:i}}function xG(t){let e=CN(t,"Square Room","This is a small square room, with passages leading west and down.",["square room","small square room"]),r=CN(t,"Puzzle Room","This is a small room with a hole in the floor. Through the hole, you can see a sandstone room below.",["puzzle room","royal puzzle entrance","puzzle entrance"]),n=CN(t,"Room in a Puzzle","You are in a maze of sandstone walls.",["room in puzzle","puzzle room","sandstone room"],!1),i=cne(t),o={squareRoom:e.id,puzzleRoom:r.id,roomInPuzzle:n.id,puzzleController:i.id,goldCard:"",warningNote:""},a=Tne(t,{puzzleRoom:r.id,roomInPuzzle:n.id});return o.goldCard=a.goldCard.id,o.warningNote=a.warningNote.id,gne(t,o),o}function gne(t,e){let r=t.getEntity(e.squareRoom);r&&wG(r,{[ot.Direction.DOWN]:e.puzzleRoom});let n=t.getEntity(e.puzzleRoom);n&&wG(n,{[ot.Direction.UP]:e.squareRoom,[ot.Direction.DOWN]:e.roomInPuzzle});let i=t.getEntity(e.roomInPuzzle);if(i){let o=i.get(ot.RoomTrait);o&&(o.exits={})}}function jG(t,e,r){let n=t.getEntity(e.squareRoom);if(n){let o=n.get(ot.RoomTrait);o&&(o.exits[ot.Direction.WEST]={destination:r})}let i=t.getEntity(r);if(i){let o=i.get(ot.RoomTrait);o&&(o.exits[ot.Direction.EAST]={destination:e.squareRoom})}}function hne(t){let e=t.createEntity("gold card",ot.EntityType.ITEM);return e.add(new ot.IdentityTrait({name:"gold card",aliases:["card","royal card","gold","golden card"],description:"This is an ornate gold card, beautifully embossed with the royal crest of the Great Underground Empire.",properName:!1,article:"a",weight:2,points:15})),e.add(new z({trophyCaseValue:10})),e}function yne(t,e){let r=t.createEntity("warning note",ot.EntityType.ITEM);return r.add(new ot.IdentityTrait({name:"warning note",aliases:["note","warning","small note"],description:"This is a small yellowed note with faded writing.",properName:!1,article:"a",weight:2})),r.add(new ot.ReadableTrait({text:`Warning:

The Royal Puzzle is dangerous. Many who have entered
have never returned, trapped forever within its confines.
If you do enter, be warned: there is only one way out,
and that requires pushing the sandstone walls.

The treasure within is yours for the taking, but only
if you can find your way back.`})),t.moveEntity(r.id,e),r}function Tne(t,e){let r=hne(t),n=yne(t,e.puzzleRoom);return t.moveEntity(r.id,e.roomInPuzzle),{goldCard:r,warningNote:n}}var Ene="dungeo.royal_puzzle.controllerId",WG="dungeo.royal_puzzle.roomInPuzzleId";function vne(t){let e=t.world.getStateValue(Ene);return e?t.world.getEntity(e):t.world.getAllEntities().find(n=>n.get(UG.IdentityTrait)?.name==="Royal Puzzle Controller")}function Zc(t){let e=["Royal Puzzle State:",`  In Puzzle: ${t.inPuzzle}`,`  Player Position: ${t.playerPos} (row ${Math.floor(t.playerPos/8)}, col ${t.playerPos%8})`,`  Card Taken: ${t.cardTaken}`,`  Has Exited: ${t.hasExited}`,`  Push Count: ${t.pushCount}`,""],r=t.grid.indexOf(Aa);e.push(`  Ladder Position: ${r>=0?`${r} (row ${Math.floor(r/8)}, col ${r%8})`:"N/A"}`),e.push(`  Exit Position: ${jl} (ladder must be here to exit)`),e.push(`  Entry Position: ${vi} (player must be here to exit)`),e.push(""),e.push("Grid (M=marble, .=empty, S=sand, L=ladder, C=card):");for(let n=0;n<8;n++){let i="  ";for(let o=0;o<8;o++){let a=n*8+o,s=t.grid[a],c;switch(s){case 1:c="M";break;case 0:c=a===t.playerPos?"@":".";break;case-1:c="S";break;case-2:c="L";break;case-3:c="C";break;default:c="?"}i+=c+" "}e.push(i)}return e}var DN={code:"PZ",name:"Puzzle",description:"Manipulate Royal Puzzle state for testing",execute(t,e){let r=vne(t);if(!r)return{success:!1,output:["Royal Puzzle controller not found."],error:"NO_CONTROLLER"};let n=Ir(r),i=e[0]?.toUpperCase();if(!i)return{success:!0,output:Zc(n)};switch(i){case"RESET":return LG(r),{success:!0,output:["Puzzle reset to initial state.",...Zc(Ir(r))]};case"ENTER":n.inPuzzle=!0,n.playerPos=vi;let o=t.world.getStateValue(WG),a=t.world.getPlayer();return o&&a&&t.world.moveEntity(a.id,o),{success:!0,output:["Entered puzzle at entry position.",...Zc(n)]};case"EXIT":n.inPuzzle=!0,n.playerPos=vi;let s=n.grid.indexOf(Aa);s>=0&&(n.grid[s]=ao),n.grid[jl]===h_?n.grid[jl]=Aa:n.grid[jl]=Aa;let c=t.world.getStateValue(WG),d=t.world.getPlayer();return c&&d&&t.world.moveEntity(d.id,c),{success:!0,output:["Set up for exit: player at entry, ladder at exit position.",...Zc(n)]};case"L":case"LADDER":let u=parseInt(e[1],10);if(isNaN(u)||u<0||u>=64)return{success:!1,output:["Invalid position. Use PZ L <0-63>"],error:"INVALID_POSITION"};let m=n.grid.indexOf(Aa);return m>=0&&(n.grid[m]=ao),n.grid[u]=Aa,{success:!0,output:[`Ladder moved to position ${u}.`,...Zc(n)]};case"P":case"PLAYER":let f=parseInt(e[1],10);return isNaN(f)||f<0||f>=64?{success:!1,output:["Invalid position. Use PZ P <0-63>"],error:"INVALID_POSITION"}:(n.playerPos=f,n.inPuzzle=!0,{success:!0,output:[`Player moved to position ${f}.`,...Zc(n)]});case"CARD":n.cardTaken=!0;let g=n.grid.indexOf(-3);return g>=0&&(n.grid[g]=h_),{success:!0,output:["Card marked as taken.",...Zc(n)]};default:return{success:!1,output:["Unknown subcommand. Usage:","  PZ          - Display puzzle state","  PZ RESET    - Reset puzzle","  PZ ENTER    - Enter puzzle at entry","  PZ EXIT     - Set up for exit test","  PZ L <pos>  - Move ladder","  PZ P <pos>  - Move player","  PZ CARD     - Take card"],error:"UNKNOWN_SUBCOMMAND"}}}};var Ws=_(E());var X={DESCRIPTION:"dungeo.dm.description",APPEARS_AT_DOOR:"dungeo.dm.appears_at_door",QUESTION_0:"dungeo.dm.question_0",QUESTION_1:"dungeo.dm.question_1",QUESTION_2:"dungeo.dm.question_2",QUESTION_3:"dungeo.dm.question_3",QUESTION_4:"dungeo.dm.question_4",QUESTION_5:"dungeo.dm.question_5",QUESTION_6:"dungeo.dm.question_6",QUESTION_7:"dungeo.dm.question_7",CORRECT_ANSWER:"dungeo.dm.correct_answer",WRONG_ANSWER_1:"dungeo.dm.wrong_answer_1",WRONG_ANSWER_2:"dungeo.dm.wrong_answer_2",WRONG_ANSWER_3:"dungeo.dm.wrong_answer_3",WRONG_ANSWER_4:"dungeo.dm.wrong_answer_4",WRONG_ANSWER_5:"dungeo.dm.wrong_answer_5",TRIVIA_PASSED:"dungeo.dm.trivia_passed",TRIVIA_FAILED:"dungeo.dm.trivia_failed",DOOR_OPENS:"dungeo.dm.door_opens",NO_ANSWER_YET:"dungeo.dm.no_answer_yet",ALREADY_PASSED:"dungeo.dm.already_passed",FOLLOWING:"dungeo.dm.following",STAYING:"dungeo.dm.staying",SETS_DIAL:"dungeo.dm.sets_dial",PUSHES_BUTTON:"dungeo.dm.pushes_button",CANNOT_DO_THAT:"dungeo.dm.cannot_do_that"};var Ul=[{id:0,messageId:X.QUESTION_0,answers:["temple"]},{id:1,messageId:X.QUESTION_1,answers:["forest","the forest","clearing"]},{id:2,messageId:X.QUESTION_2,answers:["30003","30,003"]},{id:3,messageId:X.QUESTION_3,answers:["flask","bottle","glass bottle","the flask","the bottle"]},{id:4,messageId:X.QUESTION_4,answers:["rub","fondle","caress","touch","rub it","rub mirror"]},{id:5,messageId:X.QUESTION_5,answers:["bones","body","skeleton","skull","the skeleton","the bones"]},{id:6,messageId:X.QUESTION_6,answers:["rusty knife","nasty knife","knife","the rusty knife","the knife"]},{id:7,messageId:X.QUESTION_7,answers:["none","no","nowhere","never","nope","not at all"]}];function HG(t){let e=Math.floor(Math.random()*8);return{...t,currentQuestion:e,questionsAnswered:0,wrongAttempts:0,isComplete:!1,passed:!1}}function _ne(t){return(t+3)%8}function bne(t,e){let r=Ul[t];if(!r)return!1;let n=e.toLowerCase().trim();return r.answers.some(i=>n===i.toLowerCase())}function qG(t,e){if(t.isComplete)return{state:t,isCorrect:!1,message:t.passed?X.ALREADY_PASSED:X.TRIVIA_FAILED};if(t.currentQuestion===-1)return{state:t,isCorrect:!1,message:X.NO_ANSWER_YET};if(bne(t.currentQuestion,e)){let n=t.questionsAnswered+1;return n>=3?{state:{...t,questionsAnswered:n,isComplete:!0,passed:!0},isCorrect:!0,message:X.TRIVIA_PASSED}:{state:{...t,questionsAnswered:n,currentQuestion:_ne(t.currentQuestion)},isCorrect:!0,message:X.CORRECT_ANSWER}}else{let n=t.wrongAttempts+1;if(n>=5)return{state:{...t,wrongAttempts:n,isComplete:!0,passed:!1},isCorrect:!1,message:X.TRIVIA_FAILED};{let i=[X.WRONG_ANSWER_1,X.WRONG_ANSWER_2,X.WRONG_ANSWER_3,X.WRONG_ANSWER_4];return{state:{...t,wrongAttempts:n},isCorrect:!1,message:i[n-1]}}}}function qm(t){return t.currentQuestion===-1||t.isComplete?null:Ul[t.currentQuestion]?.messageId||null}var so=_(E());function Ine(){return{state:"GUARDING_DOOR",triviaPassed:!1,triviaStarted:!1,doorOpen:!1}}function GG(t,e){let r=t.createEntity("dungeon-master",so.EntityType.ACTOR);return r.add(new so.IdentityTrait({name:"Dungeon Master",aliases:["dungeon master","master","dm","old man","elderly man","strange man","man"],description:"A strange old man with a long, flowing beard and penetrating eyes. He carries himself with an air of quiet authority, as one who has seen much and knows more.",properName:!0,article:"the"})),r.add(new so.ActorTrait({isPlayer:!1})),r.add(new so.NpcTrait({behaviorId:"dungeon-master",isHostile:!1,canMove:!0,forbiddenRooms:[],customProperties:Ine()})),t.setStateValue("trivia.questionsAnswered",0),t.setStateValue("trivia.wrongAttempts",0),t.setStateValue("trivia.currentQuestion",-1),t.setStateValue("trivia.isComplete",!1),t.setStateValue("trivia.passed",!1),t.setStateValue("dungeonMaster.doorOpen",!1),t.setStateValue("dungeonMaster.state","GUARDING_DOOR"),t.moveEntity(r.id,e),r}function Gm(t){return t.getAllEntities().find(r=>r.get(so.IdentityTrait)?.name==="Dungeon Master")}function LN(t){return t.getStateValue("dungeonMaster.state")??"GUARDING_DOOR"}function Jc(t,e){t.setStateValue("dungeonMaster.state",e);let r=Gm(t);if(r){let n=r.get(so.NpcTrait);n&&n.customProperties&&(n.customProperties.state=e)}}function One(t){let e=t.world;return{questionsAnswered:e.getStateValue("trivia.questionsAnswered")??0,wrongAttempts:e.getStateValue("trivia.wrongAttempts")??0,currentQuestion:e.getStateValue("trivia.currentQuestion")??-1,isComplete:e.getStateValue("trivia.isComplete")??!1,passed:e.getStateValue("trivia.passed")??!1}}function Fm(t,e){let r=t.world;r.setStateValue("trivia.questionsAnswered",e.questionsAnswered),r.setStateValue("trivia.wrongAttempts",e.wrongAttempts),r.setStateValue("trivia.currentQuestion",e.currentQuestion),r.setStateValue("trivia.isComplete",e.isComplete),r.setStateValue("trivia.passed",e.passed)}function Hl(t){let e=["Trivia State:",`  Started: ${t.currentQuestion!==-1}`,`  Current Question: ${t.currentQuestion} (${t.currentQuestion>=0?Ul[t.currentQuestion]?.answers[0]:"N/A"})`,`  Correct Answers: ${t.questionsAnswered}/3`,`  Wrong Attempts: ${t.wrongAttempts}/5`,`  Complete: ${t.isComplete}`,`  Passed: ${t.passed}`,""];if(t.currentQuestion>=0&&t.currentQuestion<Ul.length){let r=Ul[t.currentQuestion];e.push(`Current Question ${r.id}: "${r.messageId}"`),e.push(`  Answers: ${r.answers.join(", ")}`)}return e}function FG(t,e){for(let r of t.world.getAllEntities())if(r.get(Ws.IdentityTrait)?.name===e)return r.id;return null}function Sne(t){let e=FG(t,"Dungeon Entrance"),r=FG(t,"Narrow Corridor");if(!e||!r)return;let n=t.world.getEntity(e);if(!n)return;let i=n.get(Ws.RoomTrait);i&&(i.exits[Ws.Direction.NORTH]={destination:r})}function VG(t){let e=t.world;e.setStateValue("dungeonMaster.doorOpen",!0),Jc(e,"FOLLOWING"),Sne(t);let r=Gm(e);if(r){let n=r.get(Ws.NpcTrait);if(n?.customProperties){let i=n.customProperties;i.triviaPassed=!0,i.doorOpen=!0,i.state="FOLLOWING"}}}var MN={code:"TQ",name:"Trivia Questions",description:"Manipulate Dungeon Master trivia for testing",execute(t,e){let r=One(t),n=e[0]?.toUpperCase();if(!n)return{success:!0,output:Hl(r)};switch(n){case"RESET":let i={questionsAnswered:0,wrongAttempts:0,currentQuestion:0,isComplete:!1,passed:!1};return Fm(t,i),{success:!0,output:["Trivia reset to question 0.",...Hl(i)]};case"SOLVE":let o={questionsAnswered:3,wrongAttempts:0,currentQuestion:-1,isComplete:!0,passed:!0};return Fm(t,o),VG(t),{success:!0,output:["Trivia auto-solved. Door is now open.",...Hl(o)]};case"Q":case"QUESTION":let a=parseInt(e[1],10);if(isNaN(a)||a<0||a>=8)return{success:!1,output:["Invalid question number. Use TQ Q <0-7>"],error:"INVALID_QUESTION"};let s={...r,currentQuestion:a,isComplete:!1,passed:!1};return Fm(t,s),{success:!0,output:[`Current question set to ${a}.`,...Hl(s)]};case"PASS":let c={questionsAnswered:3,wrongAttempts:r.wrongAttempts,currentQuestion:-1,isComplete:!0,passed:!0};return Fm(t,c),VG(t),{success:!0,output:["Trivia marked as passed. Door is now open.",...Hl(c)]};case"FAIL":let d={questionsAnswered:r.questionsAnswered,wrongAttempts:5,currentQuestion:-1,isComplete:!0,passed:!1};return Fm(t,d),{success:!0,output:["Trivia marked as failed.",...Hl(d)]};default:return{success:!1,output:["Unknown subcommand. Usage:","  TQ          - Display trivia state","  TQ RESET    - Reset to question 0","  TQ SOLVE    - Auto-solve trivia","  TQ Q <n>    - Set current question (0-7)","  TQ PASS     - Mark as passed","  TQ FAIL     - Mark as failed"],error:"UNKNOWN_SUBCOMMAND"}}}};var co=_(E());function ql(t){let e=t.world;return{dialSetting:e.getStateValue("parapet.dialSetting")??1,activatedCell:e.getStateValue("parapet.activatedCell")??0,bronzeDoorVisible:e.getStateValue("prisonCell.bronzeDoorVisible")??!1,bronzeDoorOpen:e.getStateValue("prisonCell.bronzeDoorOpen")??!1}}function Gl(t){return["Dial State:",`  Dial Setting: ${t.dialSetting}`,`  Activated Cell: ${t.activatedCell||"None (button not pushed)"}`,`  Bronze Door Visible: ${t.bronzeDoorVisible}`,`  Bronze Door Open: ${t.bronzeDoorOpen}`,"","Cell 4 required for bronze door to be visible.","Bronze door leads to Treasury of Zork."]}function T_(t,e){for(let r of t.world.getAllEntities())if(r.get(co.IdentityTrait)?.name===e)return r.id;return null}function YG(t,e){let r=t.world;r.setStateValue("parapet.activatedCell",e),r.setStateValue("prisonCell.currentCell",e),e===4?r.setStateValue("prisonCell.bronzeDoorVisible",!0):r.setStateValue("prisonCell.bronzeDoorVisible",!1);let n=T_(t,"Prison Cell"),i=T_(t,"Parapet");if(n&&i){let o=r.getEntity(i);if(o){let s=o.get(co.RoomTrait);s&&(s.exits[co.Direction.DOWN]={destination:n})}let a=r.getEntity(n);if(a){let s=a.get(co.RoomTrait);s&&(s.exits[co.Direction.UP]={destination:i})}}}function Ane(t){let e=t.world;e.setStateValue("prisonCell.bronzeDoorOpen",!0);let r=T_(t,"Prison Cell"),n=T_(t,"Treasury of Zork");if(r&&n){let i=e.getEntity(r);if(i){let o=i.get(co.RoomTrait);o&&(o.exits[co.Direction.SOUTH]={destination:n})}}}var PN={code:"DL",name:"Dial",description:"Manipulate Parapet dial puzzle for testing",execute(t,e){let r=ql(t),n=e[0]?.toUpperCase();if(!n)return{success:!0,output:Gl(r)};switch(n){case"SET":let i=parseInt(e[1],10);return isNaN(i)||i<1||i>8?{success:!1,output:["Invalid dial setting. Use DL SET <1-8>"],error:"INVALID_DIAL"}:(t.world.setStateValue("parapet.dialSetting",i),{success:!0,output:[`Dial set to ${i}.`,...Gl(ql(t))]});case"PUSH":let o=t.world.getStateValue("parapet.dialSetting")??1;return YG(t,o),{success:!0,output:[`Button pushed. Cell ${o} activated.`,...Gl(ql(t))]};case"CELL":let a=parseInt(e[1],10);return isNaN(a)||a<1||a>8?{success:!1,output:["Invalid cell number. Use DL CELL <1-8>"],error:"INVALID_CELL"}:(YG(t,a),{success:!0,output:[`Cell ${a} activated directly.`,...Gl(ql(t))]});case"DOOR":let s=t.world.getStateValue("prisonCell.bronzeDoorVisible")??!1;return t.world.setStateValue("prisonCell.bronzeDoorVisible",!s),{success:!0,output:[`Bronze door visibility toggled to ${!s}.`,...Gl(ql(t))]};case"OPEN":return Ane(t),{success:!0,output:["Bronze door opened. Treasury is now accessible via S from Prison Cell.",...Gl(ql(t))]};case"ENDGAME":return t.world.setStateValue("game.endgameStarted",!0),{success:!0,output:["Endgame mode activated. Victory will trigger when entering Treasury."]};default:return{success:!1,output:["Unknown subcommand. Usage:","  DL          - Display dial state","  DL SET <n>  - Set dial to n (1-8)","  DL PUSH     - Push button (activate cell)","  DL CELL <n> - Directly set active cell (1-8)","  DL DOOR     - Toggle bronze door visibility","  DL OPEN     - Open bronze door to Treasury","  DL ENDGAME  - Activate endgame mode (for victory testing)"],error:"UNKNOWN_SUBCOMMAND"}}}};var ed=_(E()),kN=null;function BN(t){kN=t}var xN={code:"KL",name:"Kill Entity",description:"Kill an NPC or entity (usage: KL <name-or-id>)",execute(t,e){let{world:r}=t,n=[];if(e.length===0)return{success:!1,output:["Usage: KL <entity-name-or-id>"],error:"MISSING_ARGUMENT"};let i=e.join(" ").toLowerCase(),o=r.getAllEntities(),a=null;if(a=o.find(g=>g.id.toLowerCase()===i),a||(a=o.find(g=>{if(!g.has("actor"))return!1;let h=g.get(ed.IdentityTrait);return h?(h.name?.toLowerCase()||"")===i:!1})),a||(a=o.find(g=>{if(!g.has("actor"))return!1;let h=g.get(ed.IdentityTrait);return h?(h.name?.toLowerCase()||"").includes(i):!1})),a||(a=o.filter(h=>!h.has("room")).find(h=>{let y=h.get(ed.IdentityTrait);if(!y)return!1;let T=y.name?.toLowerCase()||"";return T===i||T.includes(i)})),!a)return{success:!1,output:[`Entity not found: ${e.join(" ")}`],error:"ENTITY_NOT_FOUND"};let c=a.get(ed.IdentityTrait)?.name||a.id,d=a.on,u=d&&typeof d["if.event.death"]=="function",m={id:`gdt-kill-${a.id}-${Date.now()}`,type:"if.event.death",timestamp:Date.now(),entities:{target:a.id},data:{entityId:a.id,entityName:c,cause:"gdt",killedBy:"GDT command"}};a.isDead=!0,a.isAlive=!1;let f=a.get(ed.TraitType.COMBATANT);if(f&&(f.health=0,f.isAlive=!1,f.isConscious=!1),kN)try{let g=kN.getEventProcessor();g&&g.process([m],r,t.player)}catch{if(u)try{d["if.event.death"](m,r)}catch{}}else if(u)try{d["if.event.death"](m,r)}catch{}return n.push(`Killed: ${c} (${a.id})`),u&&n.push("Death handler triggered."),{success:!0,output:n}}};var Fl=_(E()),jN={code:"KO",name:"Knock Out Entity",description:"Knock out an NPC (unconscious but alive) (usage: KO <name-or-id>)",execute(t,e){let{world:r}=t,n=[];if(e.length===0)return{success:!1,output:["Usage: KO <entity-name-or-id>"],error:"MISSING_ARGUMENT"};let i=e.join(" ").toLowerCase(),o=r.getAllEntities(),a=null;if(a=o.find(m=>m.id.toLowerCase()===i),a||(a=o.find(m=>{if(!m.has("actor"))return!1;let f=m.get(Fl.IdentityTrait);return f?(f.name?.toLowerCase()||"")===i:!1})),a||(a=o.find(m=>{if(!m.has("actor"))return!1;let f=m.get(Fl.IdentityTrait);return f?(f.name?.toLowerCase()||"").includes(i):!1})),!a)return{success:!1,output:[`Entity not found: ${e.join(" ")}`],error:"ENTITY_NOT_FOUND"};let c=a.get(Fl.IdentityTrait)?.name||a.id,d=a.get(Fl.TraitType.COMBATANT);if(!d)return{success:!1,output:[`${c} doesn't have CombatantTrait - cannot knock out`],error:"NOT_COMBATANT"};if(!d.isAlive)return{success:!1,output:[`${c} is already dead`],error:"ALREADY_DEAD"};if(!d.isConscious)return{success:!1,output:[`${c} is already unconscious`],error:"ALREADY_UNCONSCIOUS"};d.knockOut(),n.push(`Knocked out: ${c} (${a.id})`),n.push(`isAlive: ${d.isAlive}, isConscious: ${d.isConscious}`);let u=a.on;if(u&&typeof u["if.event.knocked_out"]=="function"){let m={id:`gdt-knockout-${Date.now()}`,type:"if.event.knocked_out",timestamp:Date.now(),entities:{target:a.id},data:{source:"gdt"}};u["if.event.knocked_out"](m,r),n.push("(triggered entity knocked_out handler)")}return{success:!0,output:n}}};var Vl=_(E()),WN={code:"WU",name:"Wake Up Entity",description:"Wake up an unconscious NPC (usage: WU <name-or-id>)",execute(t,e){let{world:r}=t,n=[];if(e.length===0)return{success:!1,output:["Usage: WU <entity-name-or-id>"],error:"MISSING_ARGUMENT"};let i=e.join(" ").toLowerCase(),o=r.getAllEntities(),a=null;if(a=o.find(u=>u.id.toLowerCase()===i),a||(a=o.find(u=>{if(!u.has("actor"))return!1;let m=u.get(Vl.IdentityTrait);return m?(m.name?.toLowerCase()||"")===i:!1})),a||(a=o.find(u=>{if(!u.has("actor"))return!1;let m=u.get(Vl.IdentityTrait);return m?(m.name?.toLowerCase()||"").includes(i):!1})),!a)return{success:!1,output:[`Entity not found: ${e.join(" ")}`],error:"ENTITY_NOT_FOUND"};let c=a.get(Vl.IdentityTrait)?.name||a.id,d=a.get(Vl.TraitType.COMBATANT);return d?d.isAlive?d.isConscious?{success:!1,output:[`${c} is already conscious`],error:"ALREADY_CONSCIOUS"}:(d.wakeUp(),n.push(`Woke up: ${c} (${a.id})`),n.push(`isAlive: ${d.isAlive}, isConscious: ${d.isConscious}`),{success:!0,output:n}):{success:!1,output:[`${c} is dead - cannot wake up`],error:"IS_DEAD"}:{success:!1,output:[`${c} doesn't have CombatantTrait - cannot wake up`],error:"NOT_COMBATANT"}}};var Yl=_(E()),UN={code:"FO",name:"Force Open",description:"Force open a container, bypassing restrictions (usage: FO <name-or-id>)",execute(t,e){let{world:r}=t,n=[];if(e.length===0)return{success:!1,output:["Usage: FO <entity-name-or-id>"],error:"MISSING_ARGUMENT"};let i=e.join(" ").toLowerCase(),o=r.getAllEntities(),a=null;if(a=o.find(u=>u.id.toLowerCase()===i),a||(a=o.find(u=>{let m=u.get(Yl.IdentityTrait);return m?(m.name?.toLowerCase()||"")===i:!1})),a||(a=o.find(u=>{let m=u.get(Yl.IdentityTrait);return m?(m.name?.toLowerCase()||"").includes(i):!1})),!a)return{success:!1,output:[`Entity not found: ${e.join(" ")}`],error:"ENTITY_NOT_FOUND"};let c=a.get(Yl.IdentityTrait)?.name||a.id,d=a.get(Yl.TraitType.OPENABLE);return d?d.isOpen?{success:!0,output:[`${c} is already open`]}:(d.isOpen=!0,n.push(`Force opened: ${c} (${a.id})`),n.push(`isOpen: ${d.isOpen}`),{success:!0,output:n}):{success:!1,output:[`${c} doesn't have OpenableTrait - cannot open`],error:"NOT_OPENABLE"}}};var Qe=new Map;Qe.set("HE",Nw);Qe.set("EX",Dw);Qe.set("DA",Lw);Qe.set("DR",Mw);Qe.set("DO",Pw);Qe.set("DE",rN);Qe.set("DS",nN);Qe.set("DX",iN);Qe.set("AH",oN);Qe.set("TK",aN);Qe.set("AO",sN);Qe.set("DF",cN);Qe.set("AF",dN);Qe.set("ND",lN);Qe.set("RD",uN);Qe.set("NR",IN);Qe.set("RR",ON);Qe.set("DC",AN);Qe.set("PZ",DN);Qe.set("TQ",MN);Qe.set("DL",PN);Qe.set("KL",xN);Qe.set("KO",jN);Qe.set("WU",WN);Qe.set("FO",UN);function HN(t,e,r){let n=Qe.get(t);return n?n.execute(e,r):{success:!1,output:[`Command ${t} not yet implemented.`],error:"NOT_IMPLEMENTED"}}var qN={id:eo,group:"debug",validate(t){return{valid:!0}},execute(t){let e=t.world,r=Ns(e);r.active=!0,xv(e,r)},blocked(t,e){return[t.event("action.blocked",{actionId:eo,messageId:e.error,reason:e.error,params:e.params||{}})]},report(t){let e=['A BOOMING VOICE CALLS OUT, "WHO SUMMONS THE GAME DEBUGGING TOOL?"',"","GDT ready. Type HE for help, EX to exit."].join(`
`);return[t.event("action.success",{actionId:eo,messageId:"gdt_entered",message:e})]}};function GN(t){return t.sharedData}var FN={id:vr,group:"debug",validate(t){if(!Lm(t.world))return{valid:!1,error:"not_in_gdt_mode",params:{}};let e=t.command.parsed.rawInput||"",r=ww(e);if(!r)return{valid:!1,error:"invalid_gdt_command",params:{input:e}};let n=GN(t);return n.code=r.code,n.args=r.args,n.rawInput=e,{valid:!0}},execute(t){let e=GN(t),r=e.code,n=e.args,i=Cw(t.world),o=HN(r,i,n);e.result=o},blocked(t,e){return e.error==="not_in_gdt_mode"?[t.event("action.blocked",{actionId:vr,messageId:"not_in_gdt_mode",message:"GDT mode is not active.",params:{}})]:[t.event("action.blocked",{actionId:vr,messageId:"invalid_gdt_command",message:"Unknown GDT command. Type HE for help.",params:{}})]},report(t){let e=GN(t),r=e.result,n=e.code;return[t.event("action.success",{actionId:vr,messageId:`gdt_${n.toLowerCase()}`,message:r.output.join(`
`)})]}};var zG=[qN,FN];var Un="walk_through",VN="dungeo.bank.puzzle",KG={curtainLeadsToViewingRoom:!1},Hn={WALK_THROUGH:"dungeo.bank.walk_through",NO_WALL:"dungeo.bank.no_wall",CANT_WALK_THROUGH:"dungeo.bank.cant_walk_through"};var YN=_(E());var Rne="dungeo.bank.roomIds";function $G(t){return t.getStateValue(VN)||{...KG}}function Cne(t,e){t.setStateValue(VN,e)}function QG(t){return t.getStateValue(Rne)}function XG(t){let e=t.command,r=e.parsed?.rawInput?.toLowerCase()||"";if(r.includes("north wall")||r.includes("n wall"))return"north_wall";if(r.includes("south wall")||r.includes("s wall"))return"south_wall";if(r.includes("curtain"))return"curtain";if(e.directObject?.entity){let o=e.directObject.entity.get(YN.IdentityTrait);if(o){let a=o.name.toLowerCase();if(a.includes("curtain")||a.includes("light"))return"curtain";if(a.includes("north wall"))return"north_wall";if(a.includes("south wall"))return"south_wall"}}let i=(e.parsed?.extras||{}).arg?.toLowerCase()||"";if(i.includes("north wall")||i.includes("north"))return"north_wall";if(i.includes("south wall")||i.includes("south"))return"south_wall";if(i.includes("curtain")||i.includes("light"))return"curtain"}function ZG(t,e,r,n){let i=t.currentLocation.id;return i===r.safetyDeposit?e==="curtain"?n.curtainLeadsToViewingRoom?{destination:r.viewingRoom,updateState:{curtainLeadsToViewingRoom:!1}}:{destination:r.smallRoom}:e==="north_wall"?{destination:r.vault}:{error:Hn.NO_WALL}:i===r.smallRoom?e==="south_wall"?{destination:r.safetyDeposit,updateState:{curtainLeadsToViewingRoom:!0}}:{error:Hn.NO_WALL}:i===r.vault?e==="north_wall"?{destination:r.safetyDeposit}:{error:Hn.NO_WALL}:{error:Hn.CANT_WALK_THROUGH}}var JG={id:Un,group:"movement",validate(t){let e=QG(t.world);if(!e)return{valid:!1,error:Hn.CANT_WALK_THROUGH};let r=XG(t);if(!r)return{valid:!1,error:Hn.CANT_WALK_THROUGH};let n=$G(t.world),i=ZG(t,r,e,n);return"error"in i?{valid:!1,error:i.error,params:{direction:r.replace("_"," ")}}:{valid:!0}},execute(t){let e=QG(t.world),r=XG(t),n=$G(t.world),i=ZG(t,r,e,n);if(!("error"in i)){if(t.sharedData.previousLocation=t.currentLocation.id,t.sharedData.destination=i.destination,i.updateState){let o={...n,...i.updateState};Cne(t.world,o)}t.world.moveEntity(t.player.id,i.destination)}},blocked(t,e){let r=e.params?.direction||"that";return[t.event("action.blocked",{actionId:Un,messageId:e.error,reason:e.error,params:{direction:r}})]},report(t){let r=t.world.getEntity(t.sharedData.destination)?.get(YN.IdentityTrait),n=r?.name||"somewhere",i=r?.description||"";return[t.event("action.success",{actionId:Un,messageId:Hn.WALK_THROUGH,message:"You feel somewhat disoriented as you pass through..."}),t.event("player.moved",{destination:t.sharedData.destination,destinationName:n}),t.event("if.event.room.description",{roomId:t.sharedData.destination,roomName:n,roomDescription:i,includeContents:!0,verbose:!0})]}};var e1=[JG];var Rt="dungeo.say",at={NOTHING_TO_SAY:"dungeo.say.nothing",SAY_TO_AIR:"dungeo.say.to_air",NPC_RESPONDS:"dungeo.say.npc_responds",LOUD_ROOM_ECHO_DEATH:"dungeo.loud_room.echo_death",LOUD_ROOM_ECHO_SAFE:"dungeo.loud_room.echo_safe",LOUD_ROOM_ACOUSTICS:"dungeo.loud_room.acoustics",RIDDLE_CORRECT:"dungeo.riddle.correct",RIDDLE_WRONG:"dungeo.riddle.wrong",RIDDLE_ALREADY_SOLVED:"dungeo.riddle.already_solved"};var bn=_(E());var pt=_(E());function t1(t){return{state:"GUARDING",roomId:t}}function zN(t,e){let r=t.createEntity("cyclops",pt.EntityType.ACTOR);return r.add(new pt.IdentityTrait({name:"huge cyclops",aliases:["cyclops","giant","monster","one-eyed giant","one-eyed monster"],description:"A huge cyclops stands here, blocking the northern passage. Its single eye glares at you menacingly.",properName:!1,article:"a"})),r.add(new pt.ActorTrait({isPlayer:!1})),r.add(new pt.NpcTrait({behaviorId:"cyclops",isHostile:!0,canMove:!1,customProperties:t1(e)})),r.add(new pt.CombatantTrait({health:30,maxHealth:30,skill:60,baseDamage:8,armor:2,hostile:!0,canRetaliate:!0,dropsInventory:!1,deathMessage:"The cyclops crashes to the ground with a tremendous thud!"})),t.moveEntity(r.id,e),r}function Vm(t,e,r){let n=[],i=t.getEntity(r);i&&pt.RoomBehavior.unblockExit(i,pt.Direction.NORTH);let o=i?.get(pt.RoomTrait)?.exits[pt.Direction.NORTH]?.destination;if(o){let c=t.getEntity(o)?.get(pt.RoomTrait)?.exits[pt.Direction.EAST]?.destination;if(c){let d=t.getEntity(c);if(d){let u=d.get(pt.RoomTrait);u&&(u.exits[pt.Direction.WEST]={destination:o})}}}let a=e.get(pt.NpcTrait);return a?.customProperties&&(a.customProperties.state="FLED"),t.moveEntity(e.id,"void"),n}var tt={BLOCKS:"dungeo.cyclops.blocks",GROWLS:"dungeo.cyclops.growls",IGNORES:"dungeo.cyclops.ignores",PANICS:"dungeo.cyclops.panics",FLEES:"dungeo.cyclops.flees",PASSAGE_OPENS:"dungeo.cyclops.passage_opens",ATTACKS:"dungeo.cyclops.attacks",COUNTERATTACKS:"dungeo.cyclops.counterattacks",WOUNDED:"dungeo.cyclops.wounded",DIES:"dungeo.cyclops.dies"};function r1(t){let e=t.command,r=e.parsed?.rawInput?.toLowerCase()||"";if(["echo","ulysses","odysseus","xyzzy"].includes(r))return r;let i=r.match(/^say\s+(?:to\s+\w+\s+)?["']?(.+?)["']?$/);if(i)return i[1].trim();let o=e.parsed?.extras||{};if(o.message)return String(o.message);if(o.arg)return String(o.arg);let a=r.replace(/^say\s*/,"");if(a)return a}function wne(t){let e=t.currentLocation.get(bn.IdentityTrait);return e&&e.name?.toLowerCase().includes("loud room")||!1}function Nne(t){let e=t.currentLocation.get(bn.IdentityTrait);return e&&e.name?.toLowerCase().includes("riddle room")||!1}function Dne(t){let e=t.player;if(!e)return!1;let r=t.world.getContents(e.id);for(let n of r){let i=n.get(bn.IdentityTrait);if(i&&(i.name?.toLowerCase().includes("platinum bar")||i.aliases?.some(o=>o.toLowerCase().includes("platinum"))))return!0}return!1}function Lne(t){let e=[],r=t.currentLocation;return r.echoSolved?(e.push(t.event("action.success",{actionId:Rt,messageId:at.LOUD_ROOM_ACOUSTICS})),e):(Dne(t)?e.push(t.event("player.died",{actionId:Rt,messageId:at.LOUD_ROOM_ECHO_DEATH,cause:"echo_reverberations"})):(r.echoSolved=!0,e.push(t.event("action.success",{actionId:Rt,messageId:at.LOUD_ROOM_ECHO_SAFE}))),e)}function Mne(t,e){let r=[],n=t.currentLocation.get(ro);if(n?.riddleSolved)return r.push(t.event("action.success",{actionId:Rt,messageId:at.RIDDLE_ALREADY_SOLVED})),r;let i=e.toLowerCase().trim();if(i=i.replace(/^(answer|say|reply)\s+/,""),i=i.replace(/^["']|["']$/g,""),i==="well"||i==="a well"){n&&(n.riddleSolved=!0);let o=t.currentLocation.get(bn.RoomTrait);if(o){let s=t.world.getAllEntities().find(c=>c.get(bn.IdentityTrait)?.name?.toLowerCase()==="pearl room");s&&(o.exits[bn.Direction.EAST]={destination:s.id})}r.push(t.event("action.success",{actionId:Rt,messageId:at.RIDDLE_CORRECT}))}else r.push(t.event("action.success",{actionId:Rt,messageId:at.RIDDLE_WRONG}));return r}function Pne(t){let e=t.currentLocation.id;return t.world.getAllEntities().filter(n=>n.get(bn.NpcTrait)?t.world.getLocation(n.id)===e:!1)}function kne(t){let e=t.get(bn.IdentityTrait);return e?e.name?.toLowerCase().includes("cyclops"):!1}function n1(t){let e=t.get(bn.NpcTrait);return e?.customProperties?e.customProperties:null}function Bne(t,e,r){let n=[],i=r.toLowerCase();if(i.includes("odysseus")||i.includes("ulysses")){let o=n1(e);if(o?.state==="FLED")return[];let a=o?.roomId||t.currentLocation.id;n.push(t.event("npc.emoted",{npc:e.id,messageId:tt.PANICS,npcName:"cyclops"})),n.push(t.event("npc.emoted",{npc:e.id,messageId:tt.FLEES,npcName:"cyclops"}));let s=Vm(t.world,e,a);return n.push(...s),n.push(t.event("game.message",{messageId:tt.PASSAGE_OPENS})),n}return n.push(t.event("npc.emoted",{npc:e.id,messageId:tt.IGNORES,npcName:"cyclops"})),n}var i1={id:Rt,group:"communication",validate(t){let e=r1(t);return!e||e.trim().length===0?{valid:!1,error:at.NOTHING_TO_SAY}:{valid:!0}},execute(t){let e=r1(t)||"";t.sharedData.spokenWords=e;let r=e.toLowerCase();if(wne(t)&&r==="echo"){t.sharedData.isLoudRoomEcho=!0;return}if(Nne(t)){t.sharedData.isRiddleAnswer=!0;return}let n=Pne(t);t.sharedData.npcsInRoom=n,t.sharedData.npcResponses=[];let i=n.find(kne);i&&n1(i)?.state!=="FLED"&&(t.sharedData.hasCyclops=!0,t.sharedData.cyclops=i)},blocked(t,e){return[t.event("action.blocked",{actionId:Rt,messageId:e.error||at.NOTHING_TO_SAY,reason:e.error})]},report(t){let e=[],r=t.sharedData.spokenWords;if(t.sharedData.isLoudRoomEcho)return Lne(t);if(t.sharedData.isRiddleAnswer)return Mne(t,r);let n=t.sharedData.npcsInRoom;if(t.sharedData.hasCyclops&&t.sharedData.cyclops){let i=Bne(t,t.sharedData.cyclops,r);return e.push(...i),e}return!n||n.length===0?(e.push(t.event("action.success",{actionId:Rt,messageId:at.SAY_TO_AIR,message:`You say "${r}" but nobody is here to listen.`})),e):(e.push(t.event("action.success",{actionId:Rt,messageId:"npc.no_response",message:`You say "${r}".`})),e)}};var o1=[i1];var E_=_(E());var Us="DUNGEO_RING",qn={RING_SUCCESS:"dungeo.ring.success",RING_BELL:"dungeo.ring.bell",NOT_RINGABLE:"dungeo.ring.not_ringable",NO_TARGET:"dungeo.ring.no_target"};function KN(t){let e=t.get(E_.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=e.aliases||[];return r.includes("bell")||n.some(i=>i.toLowerCase().includes("bell"))}function xne(t){let{world:e,player:r}=t,n=e.getContents(r.id);for(let o of n)if(KN(o))return o;let i=e.getLocation(r.id);if(i){let o=e.getContents(i);for(let a of o)if(KN(a))return a}}function jne(t){let e=t.command.parsed?.structure;if(!e?.directObject)return;let r=e.directObject.text||"";return{entity:t.world.getAllEntities().find(i=>{let o=i.get(E_.IdentityTrait);if(!o)return!1;let a=o.name?.toLowerCase()||"",s=o.aliases||[],c=r.toLowerCase();return a===c||s.some(d=>d.toLowerCase()===c)}),text:r}}var $N={id:Us,group:"manipulation",validate(t){let e=jne(t);if(!e||!e.text){let n=xne(t);return n?(t.sharedData.ringTarget=n,{valid:!0}):{valid:!1,error:qn.NO_TARGET}}let r=e.entity;return r?KN(r)?(t.sharedData.ringTarget=r,{valid:!0}):{valid:!1,error:qn.NOT_RINGABLE}:{valid:!1,error:"stdlib.errors.not_visible"}},execute(t){let{world:e,player:r,sharedData:n}=t,i=n.ringTarget;if(!i)return;let o=e.getLocation(r.id)||"",a=i.attributes?.exorcismRole==="bell";a&&(e.setStateValue("dungeo.exorcism.bell_rung_location",o),e.setStateValue("dungeo.exorcism.bell_rung_turn",Date.now())),n.isExorcismBell=a,n.playerLocation=o},blocked(t,e){return[t.event("action.blocked",{actionId:Us,messageId:e.error||qn.NO_TARGET,reason:e.error})]},report(t){let{player:e,sharedData:r}=t,n=[],i=r.ringTarget;if(!i)return n;let a=i.get(E_.IdentityTrait)?.name||"item",s=r.isExorcismBell,c=r.playerLocation;return n.push(t.event("game.message",{messageId:s?qn.RING_BELL:qn.RING_SUCCESS,target:a,isExorcismItem:s,location:c})),n}};var td="dungeo.action.push_wall",dt={NOT_IN_PUZZLE:"dungeo.push_wall.not_in_puzzle",NO_DIRECTION:"dungeo.push_wall.no_direction",INVALID_DIRECTION:"dungeo.push_wall.invalid_direction",NO_WALL:"dungeo.push_wall.no_wall",IMMOVABLE:"dungeo.push_wall.immovable",NO_ROOM:"dungeo.push_wall.no_room",BOUNDARY:"dungeo.push_wall.boundary",SUCCESS:"dungeo.push_wall.success",SUCCESS_FIRST:"dungeo.push_wall.success_first",LADDER_VISIBLE:"dungeo.push_wall.ladder_visible",CARD_VISIBLE:"dungeo.push_wall.card_visible"};var Hs=_(E());var Wne={[Hs.Direction.NORTH]:"north",[Hs.Direction.SOUTH]:"south",[Hs.Direction.EAST]:"east",[Hs.Direction.WEST]:"west"};function a1(t){let e=t.command.parsed?.extras?.direction;if(e)return Wne[e]}function Une(t){let e=t.currentLocation.get(Hs.IdentityTrait);return e?e.name==="Room in a Puzzle":!1}function s1(t){return t.world.getAllEntities().find(r=>r.get(Hs.IdentityTrait)?.name==="Royal Puzzle Controller")}var QN={id:td,group:"puzzle",validate(t){let e=a1(t);if(!e)return{valid:!1,error:dt.NO_DIRECTION};if(!Une(t))return{valid:!1,error:dt.NOT_IN_PUZZLE};let r=s1(t);if(!r)return{valid:!1,error:dt.NOT_IN_PUZZLE};let n=Ir(r),i=PG(n,e);return i!=="success"?{valid:!1,error:{"no-wall":dt.NO_WALL,immovable:dt.IMMOVABLE,"no-room":dt.NO_ROOM,boundary:dt.BOUNDARY}[i]||dt.NO_ROOM}:{valid:!0}},execute(t){let e=s1(t),r=Ir(e),n=a1(t),i=r.pushCount===0;t.sharedData.isFirstPush=i,t.sharedData.direction=n,t.sharedData.oldPosition=r.playerPos,kG(r,n),t.sharedData.newPosition=r.playerPos,t.sharedData.ladderVisible=NN(r),t.sharedData.cardVisible=Wl(r),t.sharedData.newDescription=Xc(r)},blocked(t,e){return[t.event("action.blocked",{actionId:td,messageId:e.error,reason:e.error})]},report(t){let e=[],r=t.sharedData.isFirstPush?dt.SUCCESS_FIRST:dt.SUCCESS;return e.push(t.event("action.success",{actionId:td,messageId:r,direction:t.sharedData.direction})),e.push(t.event("game.message",{messageId:"dungeo.puzzle.room_description",text:t.sharedData.newDescription})),e}};var c1=[QN];var XN=_(E());var st={ENTER_PUZZLE:"dungeo.puzzle.enter",EXIT_PUZZLE:"dungeo.puzzle.exit",CANT_EXIT:"dungeo.puzzle.cant_exit",MOVE_BLOCKED:"dungeo.puzzle.move_blocked",MOVE_SUCCESS:"dungeo.puzzle.move_success",ROOM_DESCRIPTION:"dungeo.puzzle.room_description",TAKE_CARD:"dungeo.puzzle.take_card",CANT_TAKE_CARD:"dungeo.puzzle.cant_take_card",PUSH_SUCCESS:"dungeo.puzzle.push_success",PUSH_NO_WALL:"dungeo.puzzle.push_no_wall",PUSH_IMMOVABLE:"dungeo.puzzle.push_immovable",PUSH_NO_ROOM:"dungeo.puzzle.push_no_room"},d1="dungeo.royal_puzzle.controllerId",ZN="dungeo.royal_puzzle.roomInPuzzleId",JN="dungeo.royal_puzzle.puzzleRoomId",l1="dungeo.royal_puzzle.goldCardId",Hne=0;function lo(){return`royal-puzzle-${Date.now()}-${++Hne}`}function v_(t){let e=t.getStateValue(d1);return e?t.getEntity(e):t.getAllEntities().find(n=>n.get(XN.IdentityTrait)?.name==="Royal Puzzle Controller")}function qne(t){let e=t.getStateValue(ZN);if(!e)return!1;let r=t.getPlayer();return r?t.getLocation(r.id)===e:!1}function Gne(t){let e=t.toLowerCase().replace(/[^a-z]/g,"");return{n:"north",north:"north",s:"south",south:"south",e:"east",east:"east",w:"west",west:"west",ne:"northeast",northeast:"northeast",nw:"northwest",northwest:"northwest",se:"southeast",southeast:"southeast",sw:"southwest",southwest:"southwest",u:"up",up:"up",d:"down",down:"down"}[e]||null}function u1(t,e){let r=v_(t);if(!r)return null;let n=Ir(r);if(!n.inPuzzle)return null;let i=Gne(e);if(!i)return null;let o=[];if(i==="up")if(y_(n)){n.inPuzzle=!1,n.hasExited=!0;let s=t.getStateValue(JN),c=t.getPlayer();if(s&&c&&t.moveEntity(c.id,s),o.push({id:lo(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:st.EXIT_PUZZLE},narrate:!0}),s){let u=t.getEntity(s)?.get(XN.IdentityTrait);o.push({id:lo(),type:"if.event.room.description",timestamp:Date.now(),entities:{},data:{roomId:s,roomName:u?.name||"Puzzle Room",roomDescription:u?.description||"",includeContents:!0,verbose:!0},narrate:!0})}return o}else return o.push({id:lo(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:st.CANT_EXIT},narrate:!0}),o;if(i==="down")return o.push({id:lo(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:st.MOVE_BLOCKED,direction:"down"},narrate:!0}),o;let a=i;return wN(n,a)?(MG(n,a),o.push({id:lo(),type:"action.success",timestamp:Date.now(),entities:{},data:{actionId:"dungeo.puzzle.move",messageId:"puzzle_move_description",message:Xc(n)},narrate:!0}),o):(o.push({id:lo(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:st.MOVE_BLOCKED,direction:i},narrate:!0}),o)}function m1(t){let e=v_(t);if(!e)return null;let r=Ir(e);if(!r.inPuzzle)return null;let n=[];if(Wl(r)){BG(r);let i=t.getStateValue(l1),o=t.getPlayer();return i&&o&&t.moveEntity(i,o.id),n.push({id:lo(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:st.TAKE_CARD},narrate:!0}),n.push({id:lo(),type:"if.event.taken",timestamp:Date.now(),entities:{target:i||"gold-card"},data:{targetId:i,targetName:"gold card"},narrate:!1}),n}return null}function Fne(t){let e=t.rawInput?.toLowerCase()||"",r=t.structure?.directObject?.head?.toLowerCase()||"";return!!(["card","gold card","golden card","royal card"].some(i=>r.includes(i.split(" ")[0]))||e.includes("card"))}function p1(){return(t,e)=>{if(!qne(e))return t;let r=t.action?.toLowerCase();if(r==="look"||r==="looking"||r==="if.action.looking")return{...t,action:"dungeo.puzzle.look",extras:{...t.extras,originalAction:r,isPuzzleLook:!0}};if(r==="take"||r==="taking"||r==="if.action.taking"||r==="get"){if(Fne(t)){let i=v_(e);if(i){let o=Ir(i);return o.cardTaken?t:Wl(o)?{...t,action:"dungeo.puzzle.take_card",extras:{...t.extras,originalAction:r,isPuzzleTakeCard:!0}}:{...t,action:"dungeo.puzzle.take_card_blocked",extras:{...t.extras,originalAction:r,isPuzzleTakeCardBlocked:!0}}}}return t}if(r!=="go"&&r!=="going"&&r!=="if.action.going")return t;let n;return t.extras?.direction?n=String(t.extras.direction):t.structure?.directObject?.head&&(n=t.structure.directObject.head),n?{...t,action:"dungeo.puzzle.move",extras:{...t.extras,direction:n,originalAction:r,isPuzzleMove:!0}}:t}}function Vne(t){let e=Ir(t);e.inPuzzle=!0,e.playerPos=vi}function f1(t,e){let r={id:"dungeo-royal-puzzle-entry",name:"Royal Puzzle Entry",priority:80,condition:i=>{let o=i.world.getStateValue("dungeo.royal_puzzle.prevLocation"),a=i.world.getStateValue(JN),s=i.world.getStateValue(ZN);return o===a&&i.playerLocation===s},run:i=>{let{world:o}=i,a=[],s=v_(o);if(!s)return a;Vne(s),a.push({id:lo(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:st.ENTER_PUZZLE},narrate:!0});let c=Ir(s);return a.push({id:lo(),type:"action.success",timestamp:Date.now(),entities:{},data:{actionId:"dungeo.puzzle.entry",messageId:"puzzle_entry_description",message:Xc(c)},narrate:!0}),a}},n={id:"dungeo-royal-puzzle-tracking",name:"Royal Puzzle Location Tracking",priority:-100,condition:i=>!0,run:i=>(i.world.setStateValue("dungeo.royal_puzzle.prevLocation",i.playerLocation),[])};t.registerDaemon(r),t.registerDaemon(n)}function g1(t,e){t.setStateValue(d1,e.puzzleController),t.setStateValue(ZN,e.roomInPuzzle),t.setStateValue(JN,e.puzzleRoom),t.setStateValue(l1,e.goldCard)}var Yne=0;function h1(){return`puzzle-move-${Date.now()}-${++Yne}`}var eD={id:"dungeo.puzzle.move",requiredMessages:[],metadata:{requiresDirectObject:!1,requiresIndirectObject:!1},validate(t){let e=t.command.parsed.extras?.direction;return e?(t.sharedData.direction=e,{valid:!0}):{valid:!1,error:"action.going.no_direction"}},execute(t){let e=t.sharedData.direction,r=u1(t.world,e);t.sharedData.puzzleEvents=r},report(t){let e=t.sharedData.puzzleEvents;return e&&e.length>0?e:[{id:h1(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:st.MOVE_BLOCKED,direction:t.sharedData.direction||"unknown"},narrate:!0}]},blocked(t,e){return[{id:h1(),type:"action.error",timestamp:Date.now(),entities:{},data:{actionId:"dungeo.puzzle.move",messageId:e.error||"action.going.no_direction",params:e.params||{}}}]}};var tD="dungeo.puzzle.take_card",zne=0;function y1(){return`puzzle-take-card-${Date.now()}-${++zne}`}var rD={id:tD,requiredMessages:[],metadata:{requiresDirectObject:!1,requiresIndirectObject:!1},validate(t){return{valid:!0}},execute(t){let e=m1(t.world);t.sharedData.takeCardEvents=e},report(t){let e=t.sharedData.takeCardEvents;return e&&e.length>0?e:[{id:y1(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:st.CANT_TAKE_CARD},narrate:!0}]},blocked(t,e){return[{id:y1(),type:"action.error",timestamp:Date.now(),entities:{},data:{actionId:tD,messageId:e.error||st.CANT_TAKE_CARD,params:e.params||{}}}]}};var __="dungeo.puzzle.take_card_blocked",b_={CANT_REACH:"dungeo.puzzle.cant_reach_card"},Kne=0;function T1(){return`puzzle-take-card-blocked-${Date.now()}-${++Kne}`}var nD={id:__,requiredMessages:[b_.CANT_REACH],metadata:{requiresDirectObject:!1,requiresIndirectObject:!1},validate(t){return{valid:!0}},execute(t){},report(t){return[{id:T1(),type:"action.success",timestamp:Date.now(),entities:{},data:{actionId:__,messageId:b_.CANT_REACH,message:"You can see the gold card set in a depression in one of the sandstone walls, but you can't reach it from here."},narrate:!0}]},blocked(t,e){return[{id:T1(),type:"action.error",timestamp:Date.now(),entities:{},data:{actionId:__,messageId:b_.CANT_REACH}}]}};var E1=_(E());var I_="dungeo.puzzle.look",$ne=0;function iD(){return`puzzle-look-${Date.now()}-${++$ne}`}var Qne="dungeo.royal_puzzle.controllerId";function Xne(t){let e=t.getStateValue(Qne);return e?t.getEntity(e):t.getAllEntities().find(n=>n.get(E1.IdentityTrait)?.name==="Royal Puzzle Controller")}var oD={id:I_,requiredMessages:[],metadata:{requiresDirectObject:!1,requiresIndirectObject:!1},validate(t){return{valid:!0}},execute(t){},report(t){let e=Xne(t.world);if(!e)return[{id:iD(),type:"if.event.room.description",timestamp:Date.now(),entities:{},data:{roomName:"Room in a Puzzle",roomDescription:"You are in a maze of sandstone walls."},narrate:!0}];let r=Ir(e),n=Xc(r);return[{id:iD(),type:"action.success",timestamp:Date.now(),entities:{},data:{actionId:I_,messageId:"puzzle_look_description",message:`Room in a Puzzle
${n}`},narrate:!0}]},blocked(t,e){return[{id:iD(),type:"action.error",timestamp:Date.now(),entities:{},data:{actionId:I_,messageId:"puzzle_look_error"}}]}};var sD=_(E());var rd="DUNGEO_BREAK",$r={BREAK_SUCCESS:"dungeo.break.success",BREAK_FRAME:"dungeo.break.frame",CANT_BREAK:"dungeo.break.cant_break",NO_TARGET:"dungeo.break.no_target",NOT_VISIBLE:"dungeo.break.not_visible"};function aD(t){return t.attributes?.isBreakable===!0}function Zne(t){return t.attributes?.isEmptyFrame===!0}function Jne(t){let e=t.command.parsed?.structure;if(!e?.directObject)return;let r=e.directObject.text||"";return{entity:t.world.getAllEntities().find(i=>{let o=i.get(sD.IdentityTrait);if(!o)return!1;let a=o.name?.toLowerCase()||"",s=o.aliases||[],c=r.toLowerCase();return a.includes(c)||c.includes(a)||s.some(d=>d.toLowerCase().includes(c)||c.includes(d.toLowerCase()))}),text:r}}function eie(t){let{world:e,player:r}=t,n=e.getContents(r.id);for(let o of n)if(aD(o))return o;let i=e.getLocation(r.id);if(i){let o=e.getContents(i);for(let a of o)if(aD(a))return a}}var cD={id:rd,group:"manipulation",validate(t){let e=Jne(t);if(!e||!e.text){let n=eie(t);return n?(t.sharedData.breakTarget=n,{valid:!0}):{valid:!1,error:$r.NO_TARGET}}let r=e.entity;return r?aD(r)?(t.sharedData.breakTarget=r,{valid:!0}):{valid:!1,error:$r.CANT_BREAK,params:{target:e.text}}:{valid:!1,error:$r.NOT_VISIBLE}},execute(t){let{world:e,player:r,sharedData:n}=t,i=n.breakTarget;if(!i)return;let o=e.getLocation(r.id)||"";if(Zne(i)){e.removeEntity(i.id);let s=tG(e);e.moveEntity(s.id,o),n.isFrame=!0,n.framePieceId=s.id}n.playerLocation=o},blocked(t,e){return[t.event("action.blocked",{actionId:rd,messageId:e.error||$r.NO_TARGET,reason:e.error,params:e.params})]},report(t){let{sharedData:e}=t,r=[],n=e.breakTarget;if(!n)return r;let o=n.get(sD.IdentityTrait)?.name||"item",a=e.isFrame;return r.push(t.event("game.message",{messageId:a?$r.BREAK_FRAME:$r.BREAK_SUCCESS,target:o,framePieceId:e.framePieceId})),r}};var kD=_(E());var nd="DUNGEO_BURN",ft={BURN_SUCCESS:"dungeo.burn.success",BURN_INCENSE:"dungeo.burn.incense",BURN_FUSE:"dungeo.burn.fuse",ALREADY_BURNING:"dungeo.burn.already_burning",BURNED_OUT:"dungeo.burn.burned_out",CANT_BURN:"dungeo.burn.cant_burn",NO_TARGET:"dungeo.burn.no_target",NOT_VISIBLE:"dungeo.burn.not_visible"};var j={LANTERN_DIM:"dungeo.lantern.dim",LANTERN_FLICKERS:"dungeo.lantern.flickers",LANTERN_DIES:"dungeo.lantern.dies",LANTERN_DEAD:"dungeo.lantern.dead",CANDLES_LOW:"dungeo.candles.low",CANDLES_FLICKER:"dungeo.candles.flicker",CANDLES_OUT:"dungeo.candles.out",MATCH_BURNING:"dungeo.match.burning",MATCH_OUT:"dungeo.match.out",DAM_GATES_OPEN:"dungeo.dam.gates_open",DAM_GATES_CLOSE:"dungeo.dam.gates_close",DAM_DRAINING:"dungeo.dam.draining",DAM_NEARLY_EMPTY:"dungeo.dam.nearly_empty",DAM_EMPTY:"dungeo.dam.empty",DAM_TRUNK_REVEALED:"dungeo.dam.trunk_revealed",FOREST_BIRD:"dungeo.forest.bird",FOREST_RUSTLE:"dungeo.forest.rustle",FOREST_BREEZE:"dungeo.forest.breeze",FOREST_BRANCH:"dungeo.forest.branch",UNDERGROUND_DRIP:"dungeo.underground.drip",UNDERGROUND_ECHO:"dungeo.underground.echo",UNDERGROUND_CREAK:"dungeo.underground.creak",INCENSE_BURNING:"dungeo.incense.burning",INCENSE_BURNS_OUT:"dungeo.incense.burns_out",BALLOON_RISING:"dungeo.balloon.rising",BALLOON_FALLING:"dungeo.balloon.falling",BALLOON_AT_LEDGE:"dungeo.balloon.at_ledge",BALLOON_LANDED:"dungeo.balloon.landed",BALLOON_CRASH:"dungeo.balloon.crash",BALLOON_HOOK_VISIBLE:"dungeo.balloon.hook_visible",BALLOON_INFLATING:"dungeo.balloon.inflating",BALLOON_DEFLATING:"dungeo.balloon.deflating",TROLL_KNOCKED_OUT:"dungeo.troll.knocked_out",TROLL_WAKES_UP:"dungeo.troll.wakes_up",FUSE_STARTS:"dungeo.fuse.starts",FUSE_FIZZLES:"dungeo.fuse.fizzles",SAFE_BLOWN_OPEN:"dungeo.explosion.safe_blown_open",BRICK_KILLS_PLAYER:"dungeo.explosion.brick_kills_player",DISTANT_EXPLOSION:"dungeo.explosion.distant",SAFE_COLLAPSE_DEATH:"dungeo.safe_collapse.death",SAFE_COLLAPSE_RUMBLE:"dungeo.safe_collapse.rumble",LEDGE_COLLAPSE_DEATH:"dungeo.ledge_collapse.death",LEDGE_COLLAPSE_NARROW_ESCAPE:"dungeo.ledge_collapse.narrow_escape"};var qs=_(E());var O_="dungeo.lantern.battery",S_="dungeo.lantern.warning.dim",A_="dungeo.lantern.warning.flicker",b1=330,v1=50,_1=20;function tie(t){return{id:O_,name:"Lantern Battery",turns:b1,entityId:t,priority:10,tickCondition:e=>{let r=e.world.getEntity(t);return r?r.get(qs.LightSourceTrait)?.isLit===!0:!1},trigger:e=>{let r=e.world.getEntity(t);if(!r)return[];let n=r.get(qs.LightSourceTrait),i=r.get(qs.SwitchableTrait);return n&&(n.isLit=!1,n.fuelRemaining=0),i&&(i.isOn=!1),[{id:`lantern-dies-${e.turn}`,type:"scheduler.fuse.triggered",timestamp:Date.now(),entities:{target:t},data:{messageId:j.LANTERN_DIES,fuseId:O_,isLightSource:!0,willDarkenLocation:!0}}]}}}function rie(t,e,r){r>v1&&t.setFuse({id:S_,name:"Lantern Dim Warning",turns:r-v1,entityId:e,priority:5,tickCondition:n=>{let i=n.world.getEntity(e);return i?i.get(qs.LightSourceTrait)?.isLit===!0:!1},trigger:n=>[{id:`lantern-dim-${n.turn}`,type:"scheduler.fuse.triggered",timestamp:Date.now(),entities:{target:e},data:{messageId:j.LANTERN_DIM,fuseId:S_}}]}),r>_1&&t.setFuse({id:A_,name:"Lantern Flicker Warning",turns:r-_1,entityId:e,priority:5,tickCondition:n=>{let i=n.world.getEntity(e);return i?i.get(qs.LightSourceTrait)?.isLit===!0:!1},trigger:n=>[{id:`lantern-flicker-${n.turn}`,type:"scheduler.fuse.triggered",timestamp:Date.now(),entities:{target:e},data:{messageId:j.LANTERN_FLICKERS,fuseId:A_}}]})}function dD(t,e){let r=e.getAllEntities().find(a=>a.get("identity")?.name==="brass lantern");if(!r){console.warn("Lantern not found - lantern fuse not registered");return}let n=r.id,o=r.get(qs.LightSourceTrait)?.fuelRemaining??b1;t.setFuse(tie(n)),rie(t,n,o),e.registerEventHandler("if.event.switched_on",(a,s)=>{a.data?.target===n&&(t.resumeFuse(O_),t.resumeFuse(S_),t.resumeFuse(A_))}),e.registerEventHandler("if.event.switched_off",(a,s)=>{a.data?.target===n&&(t.pauseFuse(O_),t.pauseFuse(S_),t.pauseFuse(A_))})}var uo=_(E());var R_="dungeo.candles.burn",C_="dungeo.candles.warning.low",w_="dungeo.candles.warning.flicker",S1=50,I1=15,O1=5;function nie(t){return{id:R_,name:"Candle Burning",turns:S1,entityId:t,priority:10,tickCondition:e=>{let r=e.world.getEntity(t);return r?r.get(uo.LightSourceTrait)?.isLit===!0:!1},trigger:e=>{let r=e.world.getEntity(t);if(!r)return[];let n=r.get(uo.LightSourceTrait),i=r.get(uo.SwitchableTrait),o=r.get(uo.IdentityTrait);n&&(n.isLit=!1,n.fuelRemaining=0),i&&(i.isOn=!1),o&&(o.description="A pair of burned-out candle stubs.",o.name="burned-out candles");let a=r.get(ye);return a&&(a.burnedOut=!0,a.isBurning=!1),[{id:`candles-out-${e.turn}`,type:"scheduler.fuse.triggered",timestamp:Date.now(),entities:{target:t},data:{messageId:j.CANDLES_OUT,fuseId:R_,isLightSource:!0,willDarkenLocation:!0}}]}}}function iie(t,e,r){r>I1&&t.setFuse({id:C_,name:"Candle Low Warning",turns:r-I1,entityId:e,priority:5,tickCondition:n=>{let i=n.world.getEntity(e);return i?i.get(uo.LightSourceTrait)?.isLit===!0:!1},trigger:n=>[{id:`candles-low-${n.turn}`,type:"scheduler.fuse.triggered",timestamp:Date.now(),entities:{target:e},data:{messageId:j.CANDLES_LOW,fuseId:C_}}]}),r>O1&&t.setFuse({id:w_,name:"Candle Flicker Warning",turns:r-O1,entityId:e,priority:5,tickCondition:n=>{let i=n.world.getEntity(e);return i?i.get(uo.LightSourceTrait)?.isLit===!0:!1},trigger:n=>[{id:`candles-flicker-${n.turn}`,type:"scheduler.fuse.triggered",timestamp:Date.now(),entities:{target:e},data:{messageId:j.CANDLES_FLICKER,fuseId:w_}}]})}function lD(t,e){let r=e.getAllEntities().find(a=>a.get("identity")?.name==="pair of candles");if(!r){console.warn("Candles not found - candle fuse not registered");return}let n=r.id,o=r.get(uo.LightSourceTrait)?.fuelRemaining??S1;t.setFuse(nie(n)),iie(t,n,o),e.registerEventHandler("if.event.switched_on",(a,s)=>{if(a.data?.target===n){if(s.getEntity(n)?.get(ye)?.burnedOut)return;t.resumeFuse(R_),t.resumeFuse(C_),t.resumeFuse(w_)}}),e.registerEventHandler("if.event.switched_off",(a,s)=>{a.data?.target===n&&(t.pauseFuse(R_),t.pauseFuse(C_),t.pauseFuse(w_))})}var zl="dungeo.dam.state";function uD(t){t.registerCapability(zl,{initialData:{isDrained:!1,buttonPressed:!1}})}function mD(t){return t.getCapability(zl)?.isDrained??!1}function N_(t,e){let r=t.getCapability(zl);r&&(r.isDrained=e)}function pD(t){return t.getCapability(zl)?.buttonPressed??!1}function Ym(t,e){let r=t.getCapability(zl);r&&(r.buttonPressed=e)}function fD(t){t.registerEventHandler("dungeo.button.yellow.pressed",(e,r)=>{Ym(r,!0)})}var R1=_(E()),L_="dungeo.maintenance.flooding.state",D_="dungeo.maintenance.flooding",A1=16,Ue={LEAK_STARTED:"dungeo.flooding.leak_started",WATER_ANKLES:"dungeo.flooding.water_ankles",WATER_SHINS:"dungeo.flooding.water_shins",WATER_KNEES:"dungeo.flooding.water_knees",WATER_HIPS:"dungeo.flooding.water_hips",WATER_WAIST:"dungeo.flooding.water_waist",WATER_CHEST:"dungeo.flooding.water_chest",WATER_NECK:"dungeo.flooding.water_neck",WATER_HEAD:"dungeo.flooding.water_head",ROOM_FLOODED:"dungeo.flooding.room_flooded",DROWNED:"dungeo.flooding.drowned",BUTTON_JAMMED:"dungeo.flooding.button_jammed"};function oie(t){switch(Math.floor((t-1)/2)){case 0:return Ue.WATER_ANKLES;case 1:return Ue.WATER_SHINS;case 2:return Ue.WATER_KNEES;case 3:return Ue.WATER_HIPS;case 4:return Ue.WATER_WAIST;case 5:return Ue.WATER_CHEST;case 6:return Ue.WATER_NECK;default:return Ue.WATER_HEAD}}function gD(t,e,r,n){let i=e.getCapability(L_);if(i||(i={floodingLevel:0,isFlooded:!1},e.registerCapability(L_,{initialData:i})),i.floodingLevel>0||i.isFlooded)return[{id:`flooding-jammed-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:Ue.BUTTON_JAMMED}}];if(i.floodingLevel=1,i.floodingJustStarted=!0,n){let o=e.getEntity(n);o&&(o.attributes.isHidden=!1)}return t.registerDaemon({id:D_,name:"Maintenance Room Flooding",priority:20,run:o=>{let a=o.world.getCapability(L_);if(!a||a.floodingLevel===0)return[];if(a.floodingJustStarted)return a.floodingJustStarted=!1,[];let s=[],c=o.world.getPlayer();if(!c)return[];let d=c.id,m=o.world.getLocation(d)===r;if(m&&a.floodingLevel>0&&s.push({id:`flooding-level-${o.turn}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:oie(a.floodingLevel),daemonId:D_,floodingLevel:a.floodingLevel}}),a.floodingLevel+=2,a.floodingLevel>A1){t.removeDaemon(D_),a.isFlooded=!0,a.floodingLevel=A1+1;let f=o.world.getEntity(r);if(f){let g=f.get(R1.IdentityTrait);g&&(g.description="The room is full of water and cannot be entered.")}m&&(s.push({id:`flooding-drowned-${o.turn}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:Ue.DROWNED}}),s.push({id:`flooding-death-${o.turn}`,type:"player.died",timestamp:Date.now(),entities:{actor:d},data:{cause:"drowning",daemonId:D_}}))}return s}}),[{id:`flooding-started-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:Ue.LEAK_STARTED}}]}var w1=_(E());var C1="dungeo.forest.ambience",aie=.15,N1=new Set,hD=[{messageId:j.FOREST_BIRD,weight:4},{messageId:j.FOREST_RUSTLE,weight:3},{messageId:j.FOREST_BREEZE,weight:2},{messageId:j.FOREST_BRANCH,weight:1}];function sie(t){let e=hD.reduce((n,i)=>n+i.weight,0),r=t.random.next()*e;for(let n of hD)if(r-=n.weight,r<=0)return n.messageId;return hD[0].messageId}function cie(t,e){if(N1.has(t))return!0;let r=e.getEntity(t);if(!r||!r.get(w1.RoomTrait)?.isOutdoors)return!1;let i=r.get("identity");if(!i)return!1;let o=i.name?.toLowerCase()||"",a=i.aliases||[];return o.includes("forest")||o.includes("clearing")||o.includes("tree")||a.some(s=>s.toLowerCase().includes("forest"))}function die(){return{id:C1,name:"Forest Ambience",priority:1,condition:t=>cie(t.playerLocation,t.world),run:t=>{if(!t.random.chance(aie))return[];let e=sie(t);return[{id:`forest-ambience-${t.turn}`,type:"ambient",timestamp:Date.now(),entities:{},data:{messageId:e,daemonId:C1,isAmbient:!0}}]}}}function yD(t,e){N1=new Set(e),t.registerDaemon(die())}var er=_(E());var lie=["portrait","zorkmid bills"],TD="An alarm rings briefly, and an invisible force prevents you from leaving.",ED="dungeo.bank.alarm.active";function uie(t,e){if(!t.getEntity(e))return!1;let n=t.getContents(e);for(let i of n){if(!i.get(z))continue;let s=i.get(er.IdentityTrait)?.name?.toLowerCase()??"";if(lie.some(c=>s.includes(c)))return!0}return!1}function vD(t,e,r){let n=r.safetyDeposit,i={id:"bank-alarm",name:"Bank of Zork Alarm System",priority:100,condition:o=>o.playerLocation===n,run:o=>{let{world:a,playerId:s,playerLocation:c}=o,d=a.getStateValue(ED)||!1,u=uie(a,s),m=a.getEntity(n);return m?(u&&!d?(er.RoomBehavior.blockExit(m,er.Direction.EAST,TD),er.RoomBehavior.blockExit(m,er.Direction.WEST,TD),er.RoomBehavior.blockExit(m,er.Direction.SOUTH,TD),a.setStateValue(ED,!0)):!u&&d&&(er.RoomBehavior.unblockExit(m,er.Direction.EAST),er.RoomBehavior.unblockExit(m,er.Direction.WEST),er.RoomBehavior.unblockExit(m,er.Direction.SOUTH),a.setStateValue(ED,!1)),[]):[]}};t.registerDaemon(i)}var _D=_(E());var D1="dungeo.incense.burn",mie=3;function pie(t,e){return{id:D1,name:"Incense Burning",turns:mie,entityId:t,priority:10,tickCondition:r=>{let n=r.world.getEntity(t);return n?n.get(ye)?.isBurning===!0:!1},trigger:r=>{let n=r.world.getEntity(t);if(!n)return[];let i=n.get(ye);i&&(i.isBurning=!1,i.burnedOut=!0);let o=n.get(_D.IdentityTrait);o&&(o.description="A pile of ash that was once fragrant incense.",o.name="ash");let s=r.world.getEntity(e)?.get(hi);return s?.basinState==="disarmed"&&(s.basinState="normal"),r.world.setStateValue("dungeo.incense.burning_id",null),[{id:`incense-out-${r.turn}`,type:"scheduler.fuse.triggered",timestamp:Date.now(),entities:{target:t},data:{messageId:j.INCENSE_BURNS_OUT,fuseId:D1}}]}}}function bD(t,e){let r=e.getAllEntities().find(i=>i.get(ye)?.burnableType==="incense");if(!r){console.warn("Incense not found - incense fuse not registered");return}let n=e.getAllEntities().find(i=>i.get(_D.IdentityTrait)?.name==="Basin Room");if(!n){console.warn("Basin Room not found - incense fuse not registered");return}t.setFuse(pie(r.id,n.id))}var id=_(E());var M_="dungeo.balloon.movement",fie=3,ID=0,Or=null,P_=null;function gie(t){if(!P_)return!1;let e=t.getEntity(P_);return!e||!e.get(id.OpenableTrait)?.isOpen?!1:t.getContents(P_).some(i=>i.get(ye)?.isBurning===!0)}function L1(t){if(!Or)return null;let e=t.getEntity(Or);if(!e)return null;let r=e.get(kt);return r?{entity:e,state:r}:null}function hie(t){if(!Or)return null;let e=t.getEntity(Or);return e&&e.get(id.VehicleTrait)?.currentPosition||null}function M1(t){if(!Or)return!1;let e=t.getPlayer();return e?t.getLocation(e.id)===Or:!1}function yie(t,e){return t==="vair4"?j.BALLOON_CRASH:t==="vlbot"?j.BALLOON_LANDED:Kc(t)?j.BALLOON_AT_LEDGE:e?j.BALLOON_RISING:j.BALLOON_FALLING}function Tie(t,e){let r=[],n=M1(t);if(r.push({id:`balloon-crash-${e.turn}`,type:"if.event.player.died",timestamp:Date.now(),entities:{target:Or||""},data:{messageId:j.BALLOON_CRASH,daemonId:M_,cause:"balloon_crash",balloonId:Or}}),n&&(t.setStateValue("dungeo.player.dead",!0),t.setStateValue("dungeo.player.death_cause","balloon_crash")),Or){let i=t.getEntity(Or);if(i){let o=i.get(kt);o&&(o.daemonEnabled=!1)}}return r}function Eie(){return{id:M_,name:"Balloon Movement",priority:5,condition:t=>{let e=L1(t.world);return!(!e||!e.state.daemonEnabled||t.turn-ID<fie)},run:t=>{let e=[],r=L1(t.world);if(!r)return e;let{state:n}=r,i=hie(t.world);if(!i)return e;let o=gie(t.world),a=M1(t.world),s=null;if(o?s=zv(i):s=Kv(i),s===null&&o&&i==="vair4")return ID=t.turn,Tie(t.world,t);if(s===null)return e;ID=t.turn;let d=r.entity.get(id.VehicleTrait)?.positionRooms?.[s];if(d&&(0,id.moveVehicle)(t.world,Or,d),a){let u=yie(s,o);e.push({id:`balloon-move-${t.turn}`,type:"daemon.message",timestamp:Date.now(),entities:{target:Or||""},data:{messageId:u,daemonId:M_,oldPosition:i,newPosition:s,isRising:o,balloonId:Or,params:{from:i,to:s}}}),(Kc(s)||s==="vair2"||s==="vair4")&&e.push({id:`balloon-ledge-${t.turn}`,type:"daemon.message",timestamp:Date.now(),entities:{},data:{messageId:j.BALLOON_HOOK_VISIBLE,daemonId:M_,balloonId:Or}})}return e}}}function OD(t,e,r,n){Or=r,P_=n,t.registerDaemon(Eie())}var Ra=_(E());var vie="dungeo.balloon.burningObject",_ie="dungeo.balloon.inflated",k_={PUT_IN_RECEPTACLE:"dungeo.balloon.put_in_receptacle",RECEPTACLE_EMPTY:"dungeo.balloon.receptacle_empty",NOT_BURNING:"dungeo.balloon.not_burning",OBJECT_BURNED_OUT:"dungeo.balloon.object_burned_out"},P1="dungeo.balloon.burn";var In=null,k1=null;function bie(t){if(!In)return null;let e=t.getEntity(In);return e&&e.get(kt)||null}function Iie(t,e){if(!In)return;let n=t.getContents(In).find(i=>i.get(Ra.IdentityTrait)?.name==="cloth bag");if(n){let i=n.get(et);i&&(i.isInflated=e);let o=n.get(Ra.IdentityTrait);o&&(e?o.description="The silk bag billows overhead, filled with hot air.":o.description="The cloth bag is draped over the basket.")}}function Oie(){return{id:P1,name:"Balloon Burn Timer",priority:10,condition:t=>!0,run:t=>{let e=[],r=t.world,n=r.getAllEntities();for(let i of n){let o=i.get(ye);if(!o?.isBurning)continue;let a=o.burnTurnsRemaining;if(typeof a!="number"||a<=0)continue;let s=a-1;if(o.burnTurnsRemaining=s,s<=0){if(o.isBurning=!1,o.burnTurnsRemaining=0,o.burnedOut=!0,r.getLocation(i.id)===k1){let u=bie(r);u&&u.burningObject===i.id&&(u.burningObject=null,r.setStateValue(vie,null),r.setStateValue(_ie,!1),Iie(r,!1),e.push({id:`burn-fuse-${t.turn}`,type:"daemon.message",timestamp:Date.now(),entities:{target:i.id},data:{messageId:j.BALLOON_DEFLATING,daemonId:P1,burnedOutItem:i.id}}))}let d=i.get(Ra.IdentityTrait);e.push({id:`burned-out-${i.id}-${t.turn}`,type:"daemon.message",timestamp:Date.now(),entities:{target:i.id},data:{messageId:k_.OBJECT_BURNED_OUT,itemName:d?.name||"object",entityId:i.id}})}}return e}}}function B1(t,e){In=t,k1=e}function SD(t){t.registerDaemon(Oie())}var od="dungeo.action.balloon-exit",zm={EXIT_SUCCESS:"dungeo.balloon.exit_success",EXIT_BLOCKED_MIDAIR:"dungeo.balloon.exit_blocked_midair",EXIT_TO_LEDGE:"dungeo.balloon.exit_to_ledge"};function x1(){return(t,e)=>{if(t.action!=="if.action.exiting"||!In)return t;let r=e.getPlayer();if(!r||e.getLocation(r.id)!==In)return t;let i=e.getEntity(In);if(!i)return t;let o=i.get(Ra.VehicleTrait);if(!o)return t;let a=o.currentPosition;return Bm(a)?{...t,action:od,structure:t.structure}:{...t,action:od,structure:t.structure}}}var j1={id:od,group:"movement",validate(t){let e=t.player,r=t.world.getLocation(e.id);if(!In||r!==In)return{valid:!1,error:"not_in_balloon"};let n=t.world.getEntity(In);if(!n)return{valid:!1,error:"balloon_not_found"};let i=n.get(Ra.VehicleTrait);if(!i)return{valid:!1,error:"balloon_state_not_found"};let o=i.currentPosition,a={vair2:!0,vair4:!0};return Bm(o)&&!a[o]?{valid:!1,error:zm.EXIT_BLOCKED_MIDAIR}:(t.sharedData.balloonPosition=o,t.sharedData.balloonId=In,{valid:!0})},execute(t){let e=t.sharedData.balloonPosition,r=t.world.getEntity(In);if(!r)return;let n=r.get(Ra.VehicleTrait);if(!n?.positionRooms)return;let i=n.positionRooms[e];i&&(t.world.moveEntity(t.player.id,i),t.sharedData.exitedToRoom=i,t.sharedData.exitSuccess=!0)},blocked(t,e){return e.error===zm.EXIT_BLOCKED_MIDAIR?[t.event("action.blocked",{actionId:od,messageId:zm.EXIT_BLOCKED_MIDAIR,reason:"You are too high in the air to exit safely!"})]:[t.event("action.blocked",{actionId:od,messageId:e.error||"action_failed"})]},report(t){if(!t.sharedData.exitSuccess)return[];let e=[];e.push(t.event("if.event.exited",{fromLocation:t.sharedData.balloonId,toLocation:t.sharedData.exitedToRoom,preposition:"out of"}));let n=t.world.getEntity(t.sharedData.exitedToRoom)?.get(Ra.IdentityTrait)?.name||"the ledge";return e.push(t.event("action.success",{actionId:od,messageId:zm.EXIT_TO_LEDGE,params:{roomName:n}})),e}};var On=_(E());var W1="dungeo.troll.recovery",Sie="A nasty-looking troll stands here, wielding a bloody axe. He blocks the northern passage.",Gs=null,Km=null;function Aie(t){let e=t.getAllEntities();for(let r of e)if(r.get(On.IdentityTrait)?.name?.toLowerCase().includes("troll")&&r.get(On.CombatantTrait))return r.id;return null}function Rie(){return{id:W1,name:"Troll Recovery",priority:10,condition:t=>{if(Gs||(Gs=Aie(t.world)),!Gs)return!1;let e=t.world.getEntity(Gs);if(!e)return!1;let r=e.get(On.CombatantTrait);return r?r.isAlive&&!r.isConscious&&r.recoveryTurns!==void 0:!1},run:t=>{if(!Gs)return[];let e=t.world.getEntity(Gs);if(!e)return[];let r=e.get(On.CombatantTrait);if(!r||r.recoveryTurns===void 0)return[];let n=[];if(r.recoveryTurns--,r.recoveryTurns<=0){r.wakeUp();let i=e.get(On.NpcTrait);i&&(i.isConscious=!0);let o=e.get(On.IdentityTrait);if(o&&(o.description=Sie),Km){let a=t.world.getEntity(Km);a&&On.RoomBehavior.blockExit(a,On.Direction.NORTH,"The troll blocks your way.")}Km&&t.playerLocation===Km&&n.push({id:`troll-wakeup-${t.turn}`,type:"game.message",timestamp:Date.now(),entities:{target:Gs},data:{messageId:j.TROLL_WAKES_UP,daemonId:W1},narrate:!0})}return n}}}function AD(t,e){Km=e,Gs=null,t.registerDaemon(Rie())}var Ca=_(E()),U1="dungeo.sword.glow",Fs={GLOW_BRIGHT:"dungeo.sword.glow_bright",GLOW_FAINT:"dungeo.sword.glow_faint",GLOW_OFF:"dungeo.sword.glow_off"},B_=0,q1=1,G1=2,Kl=B_,ad=null,$l=null;function Cie(t){let e=t.getAllEntities();for(let r of e)if(r.get(Ca.IdentityTrait)?.name?.toLowerCase().includes("elvish sword"))return r.id;return null}function wie(t){let e=t.getAllEntities();for(let r of e)if(r.get(Ca.ActorTrait)?.isPlayer)return r.id;return null}function Nie(t,e){let r=t.get?.(Ca.IdentityTrait);if(!r)return!1;let n=r.name?.toLowerCase()||"",i=t.get?.(Ca.CombatantTrait);return i&&!i.isAlive?!1:n.includes("troll")||n.includes("thief")||n.includes("cyclops")}function H1(t,e){let r=e.getContents(t);for(let n of r)if(Nie(n,e))return!0;return!1}function Die(t,e){let r=e.getEntity(t);if(!r)return[];let n=r.get(Ca.RoomTrait);if(!n)return[];let i=[],o=n.exits||{};for(let[a,s]of Object.entries(o))typeof s=="string"?i.push(s):s&&typeof s=="object"&&"destination"in s&&i.push(s.destination);return i}function Lie(t){return!ad||!$l?!1:t.getLocation(ad)===$l}function Mie(t,e){if(H1(e,t))return G1;let r=Die(e,t);for(let n of r)if(H1(n,t))return q1;return B_}function Pie(){return{id:U1,name:"Sword Glow",priority:5,getRunnerState:()=>({currentGlowLevel:Kl}),restoreRunnerState:t=>{Kl=t.currentGlowLevel??B_},condition:t=>(ad||(ad=Cie(t.world)),$l||($l=wie(t.world)),!ad||!$l?!1:Lie(t.world)),run:t=>{let e=[],r=t.playerLocation;if(!r)return e;let n=Mie(t.world,r);if(n!==Kl){let i;switch(n){case G1:i=Fs.GLOW_BRIGHT;break;case q1:i=Fs.GLOW_FAINT;break;default:i=Fs.GLOW_OFF;break}e.push({id:`sword-glow-${t.turn}`,type:"game.message",timestamp:Date.now(),entities:{instrument:ad},data:{messageId:i,daemonId:U1,previousLevel:Kl,newLevel:n},narrate:!0}),Kl=n}return e}}}function RD(t){Kl=B_,ad=null,$l=null,t.registerDaemon(Pie())}var CD="dungeo.cage.poison",F1=10;function wD(t,e,r){let n={id:CD,name:"Cage Poison Gas",priority:20,condition:i=>e.getStateValue(ks)===!0,run:i=>{let o=[],s=(e.getStateValue(Qc)||0)+1;if(e.setStateValue(Qc,s),(s===3||s===6||s===9)&&o.push({id:`cage-gas-warning-${i.turn}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:it.GAS_WARNING,daemonId:CD,turnsRemaining:F1-s}}),s>=F1){e.setStateValue(ks,!1),e.setStateValue(Qc,0),e.setStateValue("dungeo.player.dead",!0),e.setStateValue("dungeo.player.death_cause","cage_poison"),o.push({id:`cage-poison-room-${i.turn}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:it.POISON_GAS_ROOM}}),o.push({id:`cage-poison-death-${i.turn}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:it.POISON_DEATH}});let c=i.world.getPlayer();o.push({id:`cage-poison-died-${i.turn}`,type:"game.player_death",timestamp:Date.now(),entities:{actor:c?.id||""},data:{cause:"cage_poison",messageId:it.POISON_DEATH}})}return o}};t.registerDaemon(n)}var V1="dungeo.cure.daemon";function kie(){return{id:V1,name:"Wound Healing",priority:5,condition:t=>{let e=t.world.getPlayer();return e?(e.attributes[pe.WOUND_ADJUST]??0)<0:!1},run:t=>{let e=t.world.getPlayer();if(!e)return[];let n=(t.world.getStateValue(Ml.TICKS)||0)+1;if(n>=Wm){let i=e.attributes[pe.WOUND_ADJUST]??0,o=pG(i);e.attributes[pe.WOUND_ADJUST]=o.newWoundAdjust,t.world.setStateValue(Ml.TICKS,0)}else t.world.setStateValue(Ml.TICKS,n);return[]}}}function ND(t){t.registerDaemon(kie())}var _t=_(E());var K1="dungeo.brick.explosion",Bie="dungeo.safe.collapse",xie="dungeo.ledge.collapse",jie=2,Wie=5,Uie=8;function $m(t,e){let r=t.getEntity(e);if(!r)return;let n=r.get(_t.RoomTrait);if(!n)return;r.attributes.isMunged=!0;let i="The way is blocked by debris from the recent explosion.";for(let a of Object.keys(n.exits))delete n.exits[a],n.blockedExits||(n.blockedExits={}),n.blockedExits[a]=i;let o=t.getContents(e);for(let a of o)if(a.get(_t.SceneryTrait)){let s=a.get(_t.IdentityTrait);s&&(s.concealed=!0)}}function mo(t,e,r,n,i){return{id:`${t}-${r}`,type:e,timestamp:Date.now(),entities:i?{target:i}:{},data:{messageId:n}}}function Hie(t,e){return{id:K1,name:"Brick Explosion",turns:jie,entityId:t.brickId,priority:20,tickCondition:r=>{let n=r.world.getEntity(t.fuseWireId);return n?n.get(ye)?.isBurning===!0:!1},trigger:r=>{let{world:n}=r,i=[],o=n.getEntity(t.fuseWireId);if(o){let f=o.get(ye);f&&(f.isBurning=!1,f.burnedOut=!0);let g=o.get(_t.IdentityTrait);g&&(g.description="A burnt piece of wire.",g.concealed=!0)}let a=n.getLocation(t.fuseWireId),s=n.getLocation(t.brickId),c=s===t.slotId,d=s===t.dustyRoomId,u=s===r.playerLocation,m=s===r.playerId;if(c){let f=n.getEntity(t.safeId);if(f){f.attributes.safeBlownOpen=!0,f.attributes.rustedShut=!1;let y=f.get(_t.OpenableTrait);y&&(y.isOpen=!0);let T=f.get(_t.IdentityTrait);T&&(T.description="On the far wall is a rusty box, whose door has been blown off.")}let g=n.getEntity(t.slotId);if(g){let y=g.get(_t.IdentityTrait);y&&(y.concealed=!0)}let h=n.getEntity(t.brickId);if(h){let y=h.get(_t.IdentityTrait);y&&(y.concealed=!0)}e.setFuse(Y1(t)),e.setFuse(z1(t)),r.playerLocation===t.dustyRoomId?i.push(mo("safe-explosion","scheduler.fuse.triggered",r.turn,j.SAFE_BLOWN_OPEN,t.brickId)):i.push(mo("distant-explosion","scheduler.fuse.triggered",r.turn,j.DISTANT_EXPLOSION))}else if(u||m){n.setStateValue("dungeo.player.death_cause","brick_explosion");let f=n.getEntity(t.brickId);if(f){let g=f.get(_t.IdentityTrait);g&&(g.concealed=!0)}r.playerLocation&&$m(n,r.playerLocation),i.push(mo("brick-death","if.event.player.died",r.turn,j.BRICK_KILLS_PLAYER,t.brickId))}else if(d){$m(n,t.dustyRoomId);let f=n.getEntity(t.brickId);if(f){let g=f.get(_t.IdentityTrait);g&&(g.concealed=!0)}e.setFuse(Y1(t)),e.setFuse(z1(t)),r.playerLocation===t.dustyRoomId?(n.setStateValue("dungeo.player.death_cause","brick_explosion"),i.push(mo("brick-death","if.event.player.died",r.turn,j.BRICK_KILLS_PLAYER,t.brickId))):i.push(mo("distant-explosion","scheduler.fuse.triggered",r.turn,j.DISTANT_EXPLOSION))}else{s&&$m(n,s);let f=n.getEntity(t.brickId);if(f){let g=f.get(_t.IdentityTrait);g&&(g.concealed=!0)}i.push(mo("room-munged","scheduler.fuse.triggered",r.turn,j.DISTANT_EXPLOSION))}return i}}}function Y1(t){return{id:Bie,name:"Safe Room Collapse",turns:Wie,priority:20,trigger:e=>{let{world:r}=e,n=[],i=r.getEntity(t.dustyRoomId);i&&!i.attributes.isMunged&&$m(r,t.dustyRoomId);let a=r.getEntity(t.wideLedgeId)?.get(_t.RoomTrait);return a?.exits?.[_t.Direction.SOUTH]&&(delete a.exits[_t.Direction.SOUTH],a.blockedExits||(a.blockedExits={}),a.blockedExits[_t.Direction.SOUTH]="The way is blocked by debris from the recent explosion."),e.playerLocation===t.dustyRoomId?(r.setStateValue("dungeo.player.death_cause","safe_collapse"),n.push(mo("safe-collapse-death","if.event.player.died",e.turn,j.SAFE_COLLAPSE_DEATH))):n.push(mo("safe-collapse-rumble","scheduler.fuse.triggered",e.turn,j.SAFE_COLLAPSE_RUMBLE)),n}}}function z1(t){return{id:xie,name:"Wide Ledge Collapse",turns:Uie,priority:20,trigger:e=>{let{world:r}=e,n=[];$m(r,t.wideLedgeId);let i=r.getEntity(t.wideLedgeId);return i&&(i.attributes.ledgeCollapsed=!0),e.playerLocation===t.wideLedgeId?(r.setStateValue("dungeo.player.death_cause","ledge_collapse"),n.push(mo("ledge-collapse-death","if.event.player.died",e.turn,j.LEDGE_COLLAPSE_DEATH))):n.push(mo("ledge-collapse-escape","scheduler.fuse.triggered",e.turn,j.LEDGE_COLLAPSE_NARROW_ESCAPE)),n}}}function DD(t,e){t.setFuse(Hie(e,t))}function $1(t,e,r,n,i,o){dD(t,e),lD(t,e),uD(e),fD(e);let a=Object.values(r);yD(t,a),vD(t,e,i),bD(t,e),o&&(OD(t,e,o.balloonId,o.receptacleId),B1(o.balloonId,o.receptacleId)),SD(t),RD(t)}var LD=null,MD=null;function BD(t,e){LD=t,MD=e}function PD(t){return!!t.get(ye)}function Q1(t){return t.get(ye)?.isBurning===!0}function X1(t){return t.get(ye)?.burnedOut===!0}function qie(t){let e=t.command.parsed?.structure;if(!e?.directObject)return;let r=e.directObject.text||"";return{entity:t.world.getAllEntities().find(i=>{let o=i.get(kD.IdentityTrait);if(!o)return!1;let a=o.name?.toLowerCase()||"",s=o.aliases||[],c=r.toLowerCase();return a.includes(c)||c.includes(a)||s.some(d=>d.toLowerCase().includes(c)||c.includes(d.toLowerCase()))}),text:r}}function Gie(t){let{world:e,player:r}=t,n=e.getContents(r.id);for(let o of n)if(PD(o))return o;let i=e.getLocation(r.id);if(i){let o=e.getContents(i);for(let a of o)if(PD(a))return a}}var xD={id:nd,group:"manipulation",validate(t){let e=qie(t);if(!e||!e.text){let n=Gie(t);return n?Q1(n)?{valid:!1,error:ft.ALREADY_BURNING}:X1(n)?{valid:!1,error:ft.BURNED_OUT}:(t.sharedData.burnTarget=n,{valid:!0}):{valid:!1,error:ft.NO_TARGET}}let r=e.entity;return r?PD(r)?Q1(r)?{valid:!1,error:ft.ALREADY_BURNING}:X1(r)?{valid:!1,error:ft.BURNED_OUT}:(t.sharedData.burnTarget=r,{valid:!0}):{valid:!1,error:ft.CANT_BURN,params:{target:e.text}}:{valid:!1,error:ft.NOT_VISIBLE}},execute(t){let{world:e,sharedData:r}=t,n=r.burnTarget;if(!n)return;let i=n.get(ye);if(i){if(i.isBurning=!0,i.burnableType==="incense"){e.setStateValue("dungeo.incense.burning_id",n.id),r.incenseId=n.id;let o=e.getLocation(t.player.id);if(o){let s=e.getEntity(o)?.get(hi);s&&(s.basinState="disarmed",r.basinDisarmed=!0)}}else i.burnableType==="fuse"&&(LD&&MD&&DD(LD,MD),r.fuseId=n.id);r.burnableType=i.burnableType}},blocked(t,e){return[t.event("action.blocked",{actionId:nd,messageId:e.error||ft.NO_TARGET,reason:e.error,params:e.params})]},report(t){let{sharedData:e}=t,r=[],n=e.burnTarget;if(!n)return r;let o=n.get(kD.IdentityTrait)?.name||"item";return e.burnableType==="fuse"?r.push(t.event("game.message",{messageId:ft.BURN_FUSE,target:o,fuseId:e.fuseId})):e.burnableType==="flammable"?r.push(t.event("game.message",{messageId:ft.BURN_SUCCESS,target:o})):r.push(t.event("game.message",{messageId:ft.BURN_INCENSE,target:o,incenseId:e.incenseId})),r}};var jD=_(E());var Vs="DUNGEO_PRAY",po={PRAY_GENERIC:"dungeo.pray.generic",PRAY_TELEPORT:"dungeo.pray.teleport"};function Fie(t){return t.currentLocation.get(jD.IdentityTrait)?.name==="Altar"}function Vie(t){return t.world.getAllEntities().find(r=>{let n=r.get(jD.IdentityTrait);return n?.name==="Forest Path"&&n?.aliases?.includes("forest path 1")})?.id}var WD={id:Vs,group:"communication",validate(t){let e=Fie(t);if(t.sharedData.atAltar=e,e){let r=Vie(t);r?t.sharedData.forestId=r:t.sharedData.forestNotFound=!0}return{valid:!0}},execute(t){let{world:e,player:r,sharedData:n}=t;if(!n.atAltar){n.resultMessage=po.PRAY_GENERIC;return}if(n.forestNotFound){n.resultMessage=po.PRAY_GENERIC;return}let i=n.forestId;e.moveEntity(r.id,i),n.teleported=!0,n.resultMessage=po.PRAY_TELEPORT},blocked(t,e){return[]},report(t){let{sharedData:e}=t,r=[],n=e.resultMessage||po.PRAY_GENERIC;return r.push(t.event("game.message",{messageId:n,teleported:e.teleported||!1})),e.teleported&&e.forestId&&r.push(t.event("player.teleported",{actionId:Vs,destination:e.forestId,messageId:po.PRAY_TELEPORT})),r}};var Qm="dungeo:incant",wa={success:"dungeo.incant.success",failure:"dungeo.incant.failure",syntax:"dungeo.incant.syntax"};var Z1=_(E());function J1(t){let e="ECORMS",r=t.toUpperCase().padEnd(6," ").substring(0,6),n=e.split("").map(m=>m.charCodeAt(0)-64),i=[],o=0,a=r.trim()||" ";for(let m=0;m<6;m++){let f=o<r.length?r[o]:" ";f.charCodeAt(0)<=64&&(o=0,f=a[0]),i.push(f.charCodeAt(0)-64),o=(o+1)%a.length}let s=i.reduce((m,f)=>m+f,0),c=n.reduce((m,f)=>m+f,0),d=s%8+8*(c%8),u=[];for(let m=0;m<6;m++){let f=(i[m]^n[m]^d)&31;d=(d+1)%32,f>26&&(f=f%26),f=Math.max(1,f),u.push(String.fromCharCode(f+64))}return u.join("")}function Yie(t){let e=t.command.parsed?.textSlots;if(e){let r=e.get("challenge"),n=e.get("response");if(r&&n)return{challenge:r.toUpperCase(),response:n.toUpperCase()}}return null}var UD={id:Qm,group:"meta",validate(t){let e=Yie(t);if(!e)return{valid:!1,error:wa.syntax};let r=J1(e.challenge);return e.response!==r?{valid:!1,error:wa.failure}:{valid:!0}},execute(t){let{world:e,player:r}=t;e.setStateValue("game.endgameStarted",!0),e.setStateValue("game.savingDisabled",!0),e.setStateValue("scoring.endgameScore",15),e.setStateValue("scoring.endgameMaxScore",100);let i=e.getAllEntities().find(a=>{let s=a.get(Z1.IdentityTrait);return s?.name?.toLowerCase().includes("elvish sword")||s?.aliases?.some(c=>c.toLowerCase().includes("elvish sword"))});i&&(e.getContents(r.id).some(c=>c.id===i.id)||e.moveEntity(i.id,r.id));let o=e.getStateValue("endgame.topOfStairsId");o?e.moveEntity(r.id,o):e.setStateValue("endgame.pendingTeleport",!0),t.sharedData.incantSuccess=!0},blocked(t,e){return[t.event("action.blocked",{actionId:Qm,messageId:e.error||wa.failure,reason:e.error})]},report(t){let{sharedData:e}=t,r=[];return e.incantSuccess&&r.push(t.event("game.message",{messageId:wa.success})),r}};var uF=_(E());var Na="DUNGEO_LIFT",Qr={LIFT_SUCCESS:"dungeo.lift.success",LIFT_POLE:"dungeo.mirror.pole_raised",POLE_ALREADY_RAISED:"dungeo.mirror.pole_already_raised",CANT_LIFT:"dungeo.lift.cant_lift",NO_TARGET:"dungeo.lift.no_target",NOT_VISIBLE:"dungeo.lift.not_visible",NOT_IN_MIRROR:"dungeo.lift.not_in_mirror"};var Zm=_(E()),ge={POLE_RAISED:"dungeo.mirror.pole_raised",POLE_LOWERED_CHANNEL:"dungeo.mirror.pole_lowered_channel",POLE_LOWERED_FLOOR:"dungeo.mirror.pole_lowered_floor",POLE_ALREADY_RAISED:"dungeo.mirror.pole_already_raised",POLE_ALREADY_LOWERED:"dungeo.mirror.pole_already_lowered",POLE_CANT_LOWER:"dungeo.mirror.pole_cant_lower",BOX_ROTATES:"dungeo.mirror.box_rotates",BOX_MOVES:"dungeo.mirror.box_moves",BOX_CANT_ROTATE:"dungeo.mirror.box_cant_rotate",BOX_CANT_MOVE_UNLOCKED:"dungeo.mirror.box_cant_move_unlocked",BOX_CANT_MOVE_ORIENTATION:"dungeo.mirror.box_cant_move_orientation",BOX_AT_END:"dungeo.mirror.box_at_end",ENTER_MIRROR:"dungeo.mirror.enter",EXIT_MIRROR:"dungeo.mirror.exit",CANT_EXIT:"dungeo.mirror.cant_exit",NO_MIRROR_HERE:"dungeo.mirror.no_mirror_here",TBAR_DIRECTION:"dungeo.mirror.tbar_direction"},rF="insideMirror.direction",nF="insideMirror.position",U_="insideMirror.poleState",x_="insideMirror.poleJustRaised",Xm="insideMirror.poleJustLowered",j_="insideMirror.boxJustRotated",W_="insideMirror.boxJustMoved",HD="insideMirror.justEntered",qD="insideMirror.justExited",GD="insideMirror.actionBlocked",eF="insideMirror.blockedMessage",H_=0,iF=1,tF=2,FD=0,zie=45,Kie=90,$ie=135,oF=180,Qie=225,Xie=270,Zie=315;function _i(t){return{direction:t.getStateValue(rF)||0,position:t.getStateValue(nF)||0,poleState:t.getStateValue(U_)??iF}}function aF(t){return t===FD||t===oF}function Jie(t){let e=_i(t);return e.position===3&&e.direction===FD}function eoe(t){return{[FD]:"north",[zie]:"northeast",[Kie]:"east",[$ie]:"southeast",[oF]:"south",[Qie]:"southwest",[Xie]:"west",[Zie]:"northwest"}[t]||"north"}function sF(t){return _i(t).poleState===tF?{success:!1,message:ge.POLE_ALREADY_RAISED}:(t.setStateValue(U_,tF),t.setStateValue(x_,!0),{success:!0,message:ge.POLE_RAISED})}function cF(t){let e=_i(t);return e.poleState===H_?{success:!1,message:ge.POLE_ALREADY_LOWERED}:aF(e.direction)?(t.setStateValue(U_,H_),t.setStateValue(Xm,"channel"),{success:!0,message:ge.POLE_LOWERED_CHANNEL}):(t.setStateValue(U_,iF),t.setStateValue(Xm,"floor"),{success:!0,message:ge.POLE_LOWERED_FLOOR})}function VD(t,e){let r=_i(t);if(r.poleState===H_)return{success:!1,message:ge.BOX_CANT_ROTATE};let n=e?45:-45,i=(r.direction+n)%360;return i<0&&(i+=360),t.setStateValue(rF,i),t.setStateValue(j_,eoe(i)),{success:!0,message:ge.BOX_ROTATES}}function YD(t,e){let r=_i(t);if(r.poleState!==H_)return{success:!1,message:ge.BOX_CANT_MOVE_UNLOCKED};if(!aF(r.direction))return{success:!1,message:ge.BOX_CANT_MOVE_ORIENTATION};let n=e?1:-1,i=r.position+n;return i<0||i>3?{success:!1,message:ge.BOX_AT_END}:(t.setStateValue(nF,i),t.setStateValue(W_,i),{success:!0,message:ge.BOX_MOVES})}function dF(t,e,r,n,i,o){function a(){let s=e.getEntity(n);if(!s)return;let c=s.get(Zm.RoomTrait);c&&(c.exits={[Zm.Direction.OUT]:{destination:r}},Jie(e)&&(c.exits[Zm.Direction.NORTH]={destination:i}))}if(o){let s={id:"dungeo-inside-mirror-feedback",name:"Inside Mirror Feedback",priority:30,condition:c=>{let{world:d}=c;return d.getStateValue(x_)===!0||d.getStateValue(Xm)!==void 0||d.getStateValue(j_)!==void 0||d.getStateValue(W_)!==void 0||d.getStateValue(HD)===!0||d.getStateValue(qD)===!0||d.getStateValue(GD)===!0},run:c=>{let{world:d}=c,u=[];a(),d.getStateValue(x_)&&(u.push({id:`mirror-pole-raised-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:ge.POLE_RAISED}}),d.setStateValue(x_,void 0));let m=d.getStateValue(Xm);if(m){let h=m==="channel"?ge.POLE_LOWERED_CHANNEL:ge.POLE_LOWERED_FLOOR;u.push({id:`mirror-pole-lowered-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:h}}),d.setStateValue(Xm,void 0)}let f=d.getStateValue(j_);f&&(u.push({id:`mirror-box-rotated-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:ge.BOX_ROTATES,params:{direction:f}}}),u.push({id:`mirror-tbar-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:ge.TBAR_DIRECTION,params:{direction:f}}}),d.setStateValue(j_,void 0));let g=d.getStateValue(W_);if(g!==void 0&&(u.push({id:`mirror-box-moved-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:ge.BOX_MOVES,params:{position:g}}}),d.setStateValue(W_,void 0)),d.getStateValue(HD)&&(u.push({id:`mirror-entered-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:ge.ENTER_MIRROR}}),d.setStateValue(HD,void 0)),d.getStateValue(qD)&&(u.push({id:`mirror-exited-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:ge.EXIT_MIRROR}}),d.setStateValue(qD,void 0)),d.getStateValue(GD)){let h=d.getStateValue(eF);u.push({id:`mirror-blocked-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:h||ge.CANT_EXIT}}),d.setStateValue(GD,void 0),d.setStateValue(eF,void 0)}return u}};o.registerDaemon(s)}a()}var lF=2;function mF(t){return t.attributes?.poleType==="short"}function toe(t){let e=t.command.parsed?.structure;if(!e?.directObject)return;let r=e.directObject.text||"";return{entity:t.world.getAllEntities().find(i=>{let o=i.get(uF.IdentityTrait);if(!o)return!1;let a=o.name?.toLowerCase()||"",s=o.aliases||[],c=r.toLowerCase();return a.includes(c)||c.includes(a)||s.some(d=>d.toLowerCase().includes(c)||c.includes(d.toLowerCase()))}),text:r}}function roe(t){let{world:e,player:r}=t,n=e.getLocation(r.id);if(!n)return;let i=e.getContents(n);for(let o of i)if(mF(o))return o}var zD={id:Na,group:"manipulation",validate(t){let{world:e,player:r}=t,n=toe(t),i=e.getStateValue("endgame.insideMirrorId");if(e.getLocation(r.id)!==i)return{valid:!1,error:Qr.NOT_IN_MIRROR};if(!n||!n.text){let c=roe(t);return c?_i(e).poleState===lF?{valid:!1,error:Qr.POLE_ALREADY_RAISED}:(t.sharedData.liftTarget=c,{valid:!0}):{valid:!1,error:Qr.NO_TARGET}}let a=n.entity;return a?mF(a)?_i(e).poleState===lF?{valid:!1,error:Qr.POLE_ALREADY_RAISED}:(t.sharedData.liftTarget=a,{valid:!0}):{valid:!1,error:Qr.CANT_LIFT,params:{target:n.text}}:{valid:!1,error:Qr.NOT_VISIBLE}},execute(t){let{world:e,sharedData:r}=t;if(!r.liftTarget)return;let i=sF(e);r.liftResult=i},blocked(t,e){return[t.event("action.blocked",{actionId:Na,messageId:e.error||Qr.NO_TARGET,reason:e.error,params:e.params})]},report(t){let{sharedData:e}=t,r=[],n=e.liftResult;return!n||!n.success||r.push(t.event("if.event.lifted",{messageId:n.message,targetId:e.liftTarget?.id})),r}};var fF=_(E());var sd="DUNGEO_LOWER",Xr={LOWER_SUCCESS:"dungeo.lower.success",LOWER_POLE_CHANNEL:"dungeo.mirror.pole_lowered_channel",LOWER_POLE_FLOOR:"dungeo.mirror.pole_lowered_floor",POLE_ALREADY_LOWERED:"dungeo.mirror.pole_already_lowered",CANT_LOWER:"dungeo.lower.cant_lower",NO_TARGET:"dungeo.lower.no_target",NOT_VISIBLE:"dungeo.lower.not_visible",NOT_IN_MIRROR:"dungeo.lower.not_in_mirror"};var pF=0;function gF(t){return t.attributes?.poleType==="short"}function noe(t){let e=t.command.parsed?.structure;if(!e?.directObject)return;let r=e.directObject.text||"";return{entity:t.world.getAllEntities().find(i=>{let o=i.get(fF.IdentityTrait);if(!o)return!1;let a=o.name?.toLowerCase()||"",s=o.aliases||[],c=r.toLowerCase();return a.includes(c)||c.includes(a)||s.some(d=>d.toLowerCase().includes(c)||c.includes(d.toLowerCase()))}),text:r}}function ioe(t){let{world:e,player:r}=t,n=e.getLocation(r.id);if(!n)return;let i=e.getContents(n);for(let o of i)if(gF(o))return o}var KD={id:sd,group:"manipulation",validate(t){let{world:e,player:r}=t,n=noe(t),i=e.getStateValue("endgame.insideMirrorId");if(e.getLocation(r.id)!==i)return{valid:!1,error:Xr.NOT_IN_MIRROR};if(!n||!n.text){let c=ioe(t);return c?_i(e).poleState===pF?{valid:!1,error:Xr.POLE_ALREADY_LOWERED}:(t.sharedData.lowerTarget=c,{valid:!0}):{valid:!1,error:Xr.NO_TARGET}}let a=n.entity;return a?gF(a)?_i(e).poleState===pF?{valid:!1,error:Xr.POLE_ALREADY_LOWERED}:(t.sharedData.lowerTarget=a,{valid:!0}):{valid:!1,error:Xr.CANT_LOWER,params:{target:n.text}}:{valid:!1,error:Xr.NOT_VISIBLE}},execute(t){let{world:e,sharedData:r}=t;if(!r.lowerTarget)return;let i=cF(e);r.lowerResult=i},blocked(t,e){return[t.event("action.blocked",{actionId:sd,messageId:e.error||Xr.NO_TARGET,reason:e.error,params:e.params})]},report(t){let{sharedData:e}=t,r=[],n=e.lowerResult;return!n||!n.success||r.push(t.event("if.event.lowered",{messageId:n.message,targetId:e.lowerTarget?.id})),r}};var hF=_(E());var bt="dungeo.action.push_panel",bi={BOX_ROTATES:"dungeo.mirror.box_rotates",BOX_MOVES:"dungeo.mirror.box_moves",NOT_IN_MIRROR:"dungeo.push_panel.not_in_mirror",NO_TARGET:"dungeo.push_panel.no_target",NOT_VISIBLE:"dungeo.push_panel.not_visible",NOT_A_PANEL:"dungeo.push_panel.not_a_panel",BOX_CANT_ROTATE:"dungeo.mirror.box_cant_rotate",BOX_CANT_MOVE_UNLOCKED:"dungeo.mirror.box_cant_move_unlocked",BOX_CANT_MOVE_ORIENTATION:"dungeo.mirror.box_cant_move_orientation",BOX_AT_END:"dungeo.mirror.box_at_end"};var ooe=["red","yellow","mahogany","pine"];function yF(t){return t.attributes?.isPanel===!0}function TF(t){return t.attributes?.panelType}function aoe(t){let e=t.toLowerCase();for(let r of ooe)if(e.includes(r))return r}function soe(t,e){let{world:r,player:n}=t,i=r.getLocation(n.id);if(!i)return;let o=r.getContents(i);for(let a of o)if(yF(a)&&TF(a)===e)return a}function coe(t,e){let{world:r,player:n}=t,i=r.getLocation(n.id);if(!i)return;let o=r.getContents(i),a=e.toLowerCase();for(let s of o){if(!yF(s))continue;let c=s.get(hF.IdentityTrait);if(!c)continue;let d=c.name?.toLowerCase()||"",u=c.aliases||[];if(d.includes(a)||a.includes(d)||u.some(m=>m.toLowerCase().includes(a)||a.includes(m.toLowerCase())))return s}}function doe(t){return t.command.parsed?.structure?.directObject?.text}var $D={id:bt,group:"manipulation",validate(t){let{world:e,player:r}=t,n=e.getStateValue("endgame.insideMirrorId");if(e.getLocation(r.id)!==n)return{valid:!1,error:bi.NOT_IN_MIRROR};let o=doe(t),a=t.command.parsed?.rawInput||"",s=aoe(a),c,d;return s?(c=soe(t,s),d=s):o&&(c=coe(t,o),c&&(d=TF(c))),!c||!d?{valid:!1,error:bi.NOT_VISIBLE,params:{target:o||s||"panel"}}:(t.sharedData.pushTarget=c,t.sharedData.panelType=d,{valid:!0})},execute(t){let{world:e,sharedData:r}=t,n=r.panelType;if(!n)return;let i;n==="red"?i=VD(e,!0):n==="yellow"?i=VD(e,!1):n==="mahogany"?i=YD(e,!0):n==="pine"?i=YD(e,!1):i={success:!1,message:bi.NOT_A_PANEL},r.pushResult=i},blocked(t,e){return[t.event("action.blocked",{actionId:bt,messageId:e.error||bi.NO_TARGET,reason:e.error,params:e.params})]},report(t){let{sharedData:e}=t,r=[],n=e.pushResult;if(!n)return r;let i=e.pushTarget,o=e.panelType;return n.success?r.push(t.event("if.event.pushed",{messageId:n.message,targetId:i?.id,panelType:o})):r.push(t.event("action.blocked",{actionId:bt,messageId:n.message,reason:n.message,params:{target:i?.name}})),r}};var Ys="dungeo.knock",Sr={KNOCK_GENERIC:"dungeo.knock.generic",KNOCK_DOOR:"dungeo.knock.door",DM_APPEARS:"dungeo.knock.dm_appears",DM_ALREADY_APPEARED:"dungeo.knock.dm_already_appeared",TRIVIA_ALREADY_PASSED:"dungeo.knock.trivia_already_passed",TRIVIA_ALREADY_FAILED:"dungeo.knock.trivia_already_failed",NOTHING_TO_KNOCK:"dungeo.knock.nothing_to_knock"};var EF=_(E());function loe(t){let{world:e,player:r}=t,n=e.getLocation(r.id);if(!n)return!1;let i=e.getEntity(n);return i?i.get(EF.IdentityTrait)?.name==="Dungeon Entrance":!1}function uoe(t){let{world:e}=t;return{questionsAnswered:e.getStateValue("trivia.questionsAnswered")??0,wrongAttempts:e.getStateValue("trivia.wrongAttempts")??0,currentQuestion:e.getStateValue("trivia.currentQuestion")??-1,isComplete:e.getStateValue("trivia.isComplete")??!1,passed:e.getStateValue("trivia.passed")??!1}}function moe(t,e){let{world:r}=t;r.setStateValue("trivia.questionsAnswered",e.questionsAnswered),r.setStateValue("trivia.wrongAttempts",e.wrongAttempts),r.setStateValue("trivia.currentQuestion",e.currentQuestion),r.setStateValue("trivia.isComplete",e.isComplete),r.setStateValue("trivia.passed",e.passed)}var vF={id:Ys,group:"interaction",validate(t){let e=loe(t);if(t.sharedData.atDungeonEntrance=e,e){let r=uoe(t);t.sharedData.triviaState=r}return{valid:!0}},execute(t){let{sharedData:e}=t;if(!e.atDungeonEntrance){e.resultMessage=Sr.KNOCK_GENERIC;return}let r=e.triviaState;if(r.isComplete){r.passed?e.resultMessage=Sr.TRIVIA_ALREADY_PASSED:e.resultMessage=Sr.TRIVIA_ALREADY_FAILED;return}if(r.currentQuestion!==-1){e.resultMessage=Sr.DM_ALREADY_APPEARED,e.questionMessageId=qm(r);return}let n=HG(r);moe(t,n),e.newTriviaState=n,e.resultMessage=Sr.DM_APPEARS,e.questionMessageId=qm(n)},blocked(t,e){return[]},report(t){let{sharedData:e}=t,r=[],n=e.resultMessage||Sr.KNOCK_GENERIC;return r.push(t.event("game.message",{messageId:n,atDungeonEntrance:e.atDungeonEntrance})),e.questionMessageId&&r.push(t.event("game.message",{messageId:e.questionMessageId})),r}};var Jm="dungeo.answer",Gn={NO_QUESTION:"dungeo.answer.no_question",NO_ANSWER_GIVEN:"dungeo.answer.no_answer_given",TRIVIA_NOT_STARTED:"dungeo.answer.trivia_not_started",TRIVIA_ALREADY_PASSED:"dungeo.answer.trivia_already_passed",TRIVIA_ALREADY_FAILED:"dungeo.answer.trivia_already_failed"};var Sn=_(E());function poe(t){let{world:e,player:r}=t,n=e.getLocation(r.id);if(!n)return!1;let i=e.getEntity(n);return i?i.get(Sn.IdentityTrait)?.name==="Dungeon Entrance":!1}function foe(t){let e=t.currentLocation.get(Sn.IdentityTrait);return e&&e.name?.toLowerCase().includes("riddle room")||!1}function goe(t){return t.currentLocation.get(ro)?.riddleSolved===!0}function hoe(t,e){let{world:r}=t;for(let n of r.getAllEntities())if(n.get(Sn.IdentityTrait)?.name===e)return n.id;return null}function yoe(t){let{world:e,player:r}=t,n=e.getLocation(r.id);if(!n)return;let i=e.getEntity(n);if(!i)return;let o=hoe(t,"Narrow Corridor");if(!o)return;let a=i.get(Sn.RoomTrait);a&&(a.exits[Sn.Direction.NORTH]={destination:o})}function Toe(t){let{world:e}=t;return{questionsAnswered:e.getStateValue("trivia.questionsAnswered")??0,wrongAttempts:e.getStateValue("trivia.wrongAttempts")??0,currentQuestion:e.getStateValue("trivia.currentQuestion")??-1,isComplete:e.getStateValue("trivia.isComplete")??!1,passed:e.getStateValue("trivia.passed")??!1}}function Eoe(t,e){let{world:r}=t;r.setStateValue("trivia.questionsAnswered",e.questionsAnswered),r.setStateValue("trivia.wrongAttempts",e.wrongAttempts),r.setStateValue("trivia.currentQuestion",e.currentQuestion),r.setStateValue("trivia.isComplete",e.isComplete),r.setStateValue("trivia.passed",e.passed)}function voe(t){let{command:e}=t,r=e.parsed?.textSlots;if(r&&r.size>0){let o=r.get("text");if(o)return o;for(let a of r.values())return a}let i=(e.rawInput||"").match(/^answer\s+(.+)$/i);return i?i[1].trim():""}var _F={id:Jm,group:"communication",validate(t){let e=voe(t);if(t.sharedData.answerText=e,!e)return{valid:!1,error:Gn.NO_ANSWER_GIVEN};let r=foe(t);if(t.sharedData.inRiddleRoom=r,r)return t.sharedData.riddleAlreadySolved=goe(t),{valid:!0};let n=poe(t);t.sharedData.atDungeonEntrance=n;let i=Toe(t);return t.sharedData.triviaState=i,i.currentQuestion===-1?{valid:!1,error:Gn.TRIVIA_NOT_STARTED}:i.isComplete?i.passed?{valid:!1,error:Gn.TRIVIA_ALREADY_PASSED}:{valid:!1,error:Gn.TRIVIA_ALREADY_FAILED}:{valid:!0}},execute(t){let{sharedData:e,world:r}=t,n=e.answerText;if(e.inRiddleRoom){if(e.riddleAlreadySolved){e.resultMessage=at.RIDDLE_ALREADY_SOLVED;return}let a=n.toLowerCase().trim();if(a=a.replace(/^["']|["']$/g,""),a==="well"||a==="a well"){let s=t.currentLocation.get(ro);s&&(s.riddleSolved=!0);let c=t.currentLocation.get(Sn.RoomTrait);if(c){let u=r.getAllEntities().find(m=>{let g=m.get(Sn.IdentityTrait)?.name?.toLowerCase()||"";return g.includes("pearl")||g.includes("broom closet")});u&&(c.exits[Sn.Direction.EAST]={destination:u.id})}e.riddleCorrect=!0,e.resultMessage=at.RIDDLE_CORRECT}else e.riddleCorrect=!1,e.resultMessage=at.RIDDLE_WRONG;return}let i=e.triviaState,o=qG(i,n);if(Eoe(t,o.state),e.newTriviaState=o.state,e.isCorrect=o.isCorrect,e.resultMessage=o.message,o.state.passed){r.setStateValue("dungeonMaster.doorOpen",!0),Jc(r,"FOLLOWING"),yoe(t);let a=Gm(r);if(a){let s=a.get(Sn.NpcTrait);if(s?.customProperties){let c=s.customProperties;c.triviaPassed=!0,c.doorOpen=!0,c.state="FOLLOWING"}}}o.state.isComplete||(e.nextQuestionMessageId=qm(o.state))},blocked(t,e){let r=[];return r.push(t.event("game.message",{messageId:e.error||Gn.NO_QUESTION})),r},report(t){let{sharedData:e}=t,r=[],n=e.resultMessage;return e.inRiddleRoom?(r.push(t.event("action.success",{actionId:Jm,messageId:n})),r):(r.push(t.event("game.message",{messageId:n,isCorrect:e.isCorrect,questionsAnswered:e.newTriviaState?.questionsAnswered,wrongAttempts:e.newTriviaState?.wrongAttempts})),e.newTriviaState?.passed&&r.push(t.event("game.message",{messageId:X.DOOR_OPENS})),e.nextQuestionMessageId&&r.push(t.event("game.message",{messageId:e.nextQuestionMessageId})),r)}};var cd="dungeo.set-dial",fo={SET_DIAL:"dungeo.dial.set",DIAL_MUST_BE_1_TO_8:"dungeo.dial.must_be_1_to_8",NOT_AT_PARAPET:"dungeo.dial.not_at_parapet",NO_DIAL_HERE:"dungeo.dial.no_dial_here"};var bF=_(E());function _oe(t){let{world:e,player:r}=t,n=e.getLocation(r.id);if(!n)return!1;let i=e.getEntity(n);return i?i.get(bF.IdentityTrait)?.name==="Parapet":!1}function boe(t){let{command:e}=t,r=e.parsed?.textSlots;if(r&&r.size>0){let o=r.get("number");if(o){let a=parseInt(o,10);if(!isNaN(a))return a}}let i=(e.rawInput||"").match(/(?:set|turn)\s+(?:dial|indicator)\s+to\s+(\d+)/i);if(i){let o=parseInt(i[1],10);if(!isNaN(o))return o}return null}var QD={id:cd,group:"manipulation",validate(t){let e=_oe(t);if(t.sharedData.atParapet=e,!e)return{valid:!1,error:fo.NOT_AT_PARAPET};let r=boe(t);return t.sharedData.dialValue=r,r===null||r<1||r>8?{valid:!1,error:fo.DIAL_MUST_BE_1_TO_8}:{valid:!0}},execute(t){let{world:e,sharedData:r}=t,n=r.dialValue,i=e.getStateValue("parapet.dialSetting")??1;r.previousDialValue=i,e.setStateValue("parapet.dialSetting",n)},blocked(t,e){return[t.event("action.blocked",{messageId:e.error||fo.NOT_AT_PARAPET})]},report(t){let{sharedData:e}=t,r=e.dialValue;return[t.event("game.message",{messageId:fo.SET_DIAL,params:{dialValue:r}})]}};var Da="dungeo.push-dial-button",Ii={PUSH_BUTTON:"dungeo.dial.push_button",MACHINERY_SOUNDS:"dungeo.dial.machinery_sounds",CELL_ROTATES:"dungeo.dial.cell_rotates",NOT_AT_PARAPET:"dungeo.dial.not_at_parapet",NO_BUTTON:"dungeo.dial.no_button"};var go=_(E());function Ioe(t){let{world:e,player:r}=t,n=e.getLocation(r.id);if(!n)return!1;let i=e.getEntity(n);return i?i.get(go.IdentityTrait)?.name==="Parapet":!1}function Ooe(t){let{world:e}=t;for(let r of e.getAllEntities())if(r.get(go.IdentityTrait)?.name==="Prison Cell")return r.id;return null}function Soe(t){let{world:e}=t;for(let r of e.getAllEntities())if(r.get(go.IdentityTrait)?.name==="Parapet")return r.id;return null}var XD={id:Da,group:"manipulation",validate(t){let e=Ioe(t);return t.sharedData.atParapet=e,e?{valid:!0}:{valid:!1,error:Ii.NOT_AT_PARAPET}},execute(t){let{world:e,sharedData:r}=t,n=e.getStateValue("parapet.dialSetting")??1,i=e.getStateValue("parapet.activatedCell")??0;r.dialSetting=n,r.previousCell=i,e.setStateValue("parapet.activatedCell",n),e.setStateValue("prisonCell.currentCell",n);let o=Ooe(t),a=Soe(t);if(r.prisonCellId=o,n===4?(e.setStateValue("prisonCell.bronzeDoorVisible",!0),r.bronzeDoorNowVisible=!0):i===4&&(e.setStateValue("prisonCell.bronzeDoorVisible",!1),r.bronzeDoorNowVisible=!1),o&&a){let s=e.getEntity(a);if(s){let d=s.get(go.RoomTrait);d&&(d.exits[go.Direction.DOWN]={destination:o})}let c=e.getEntity(o);if(c){let d=c.get(go.RoomTrait);d&&(d.exits[go.Direction.UP]={destination:a})}}},blocked(t,e){return[t.event("action.blocked",{messageId:e.error||Ii.NOT_AT_PARAPET})]},report(t){let{sharedData:e}=t,r=e.dialSetting,n=[];return n.push(t.event("game.message",{messageId:Ii.PUSH_BUTTON})),n.push(t.event("game.message",{messageId:Ii.MACHINERY_SOUNDS,params:{dialSetting:r}})),n}};var dd="dungeo.action.wave",tr={SUCCESS:"dungeo.wave.success",RAINBOW_APPEARS:"dungeo.wave.rainbow_appears",RAINBOW_GONE:"dungeo.wave.rainbow_gone",NO_EFFECT:"dungeo.wave.no_effect",NO_TARGET:"dungeo.wave.no_target",NOT_HOLDING:"dungeo.wave.not_holding"};var ep=_(E());var zs=_(E()),q_="dungeo.event.rainbow.solidified",G_="dungeo.event.rainbow.dismissed",Aoe="The rainbow is beautiful, but it looks far too insubstantial to walk on.";function Roe(){return{type:"custom",execute:(t,e,r)=>{let n=t.getEntity(e.$aragainFalls),i=e.$onTheRainbow;if(n&&i){let o=n.get(zs.RoomTrait);o&&(o.exits[zs.Direction.EAST]={destination:i},o.blockedExits&&delete o.blockedExits[zs.Direction.EAST])}return{}}}}function Coe(){return{type:"custom",execute:(t,e,r)=>{let n=t.getEntity(e.$aragainFalls);if(n){let i=n.get(zs.RoomTrait);i&&(delete i.exits[zs.Direction.EAST],i.blockedExits||(i.blockedExits={}),i.blockedExits[zs.Direction.EAST]=Aoe)}return{}}}}function IF(){return{id:"dungeo.rainbow",description:"Tracks rainbow solid/insubstantial state at Aragain Falls",initialState:"inactive",states:{inactive:{description:"Rainbow is insubstantial \u2014 cannot walk on it",transitions:[{target:"active",trigger:{type:"event",eventId:q_},effects:[{type:"set_state",key:"dungeo.rainbow.active",value:!0},Roe()]}]},active:{description:"Rainbow is solid \u2014 player can walk east",transitions:[{target:"inactive",trigger:{type:"event",eventId:G_},effects:[{type:"set_state",key:"dungeo.rainbow.active",value:!1},Coe()]}]}}}}var woe=["aragain falls","on the rainbow","end of rainbow","rainbow"];function Noe(t){if(t.attributes?.isSceptre)return!0;let e=t.get(ep.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"";return r.includes("stick")||r.includes("sharp stick")}function Doe(t,e){return t.world.getContents(t.player.id).some(n=>n.id===e.id)}function Loe(t){let e=t.command.parsed?.structure;if(!e?.directObject)return;let r=e.directObject.text||"";return r?t.world.getAllEntities().find(i=>{let o=i.get(ep.IdentityTrait);if(!o)return!1;let a=o.name?.toLowerCase()||"",s=o.aliases||[],c=r.toLowerCase();return a===c||a.includes(c)||s.some(d=>d.toLowerCase()===c||d.toLowerCase().includes(c))}):void 0}var OF={id:dd,group:"manipulation",validate(t){let e=Loe(t);return e?Doe(t,e)?(t.sharedData.waveTarget=e,t.sharedData.isStick=Noe(e),{valid:!0}):{valid:!1,error:tr.NOT_HOLDING}:{valid:!1,error:tr.NO_TARGET}},execute(t){let{world:e,player:r,sharedData:n}=t,i=n.waveTarget,o=n.isStick,a=e.getLocation(r.id)||"";n.playerLocation=a;let d=e.getEntity(a)?.get(ep.IdentityTrait)?.name?.toLowerCase()||"",u=woe.some(m=>d.includes(m)||a.toLowerCase().includes(m.replace(/\s+/g,"-")));o&&u&&(e.getStateValue("dungeo.rainbow.active")||!1?(n.rainbowDismissed=!0,n.rainbowEvent=G_):(n.rainbowCreated=!0,n.rainbowEvent=q_))},blocked(t,e){return[t.event("action.blocked",{actionId:dd,messageId:e.error||tr.NO_TARGET,reason:e.error})]},report(t){let{sharedData:e}=t,r=[],n=e.waveTarget;if(!n)return r;let o=n.get(ep.IdentityTrait)?.name||"item";return e.rainbowCreated?(r.push(t.event(q_,{})),r.push(t.event("game.message",{messageId:tr.RAINBOW_APPEARS,params:{target:o}}))):e.rainbowDismissed?(r.push(t.event(G_,{})),r.push(t.event("game.message",{messageId:tr.RAINBOW_GONE,params:{target:o}}))):e.isStick?r.push(t.event("game.message",{messageId:tr.NO_EFFECT,params:{target:o}})):r.push(t.event("game.message",{messageId:tr.SUCCESS,params:{target:o}})),r}};var La="dungeo.action.dig",rr={SUCCESS:"dungeo.dig.success",FOUND_STATUE:"dungeo.dig.found_statue",KEEP_DIGGING:"dungeo.dig.keep_digging",NOTHING_HERE:"dungeo.dig.nothing_here",NO_SHOVEL:"dungeo.dig.no_shovel",CANT_DIG_HERE:"dungeo.dig.cant_dig_here"};var F_=_(E());var SF={"sandy-beach":{treasure:"statue",digsRequired:4}};function Moe(t){let e=t.get(F_.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=e.aliases||[];return r.includes("shovel")||n.some(i=>i.toLowerCase().includes("shovel"))}function Poe(t){return t.world.getContents(t.player.id).find(r=>Moe(r))}function koe(t,e){let r=t.getEntity(e);if(!r)return;let i=r.get(F_.IdentityTrait)?.name?.toLowerCase()||"";for(let o of Object.keys(SF)){let a=o.replace(/-/g," ");if(e.toLowerCase().includes(o)||e.toLowerCase().includes(a)||i.includes(a)||i.includes(o))return o}}var AF={id:La,group:"manipulation",validate(t){let{world:e,player:r}=t,n=Poe(t);if(!n)return{valid:!1,error:rr.NO_SHOVEL};let i=e.getLocation(r.id)||"",o=koe(e,i);return o?(t.sharedData.shovel=n,t.sharedData.roomKey=o,t.sharedData.playerLocation=i,{valid:!0}):{valid:!1,error:rr.CANT_DIG_HERE}},execute(t){let{world:e,sharedData:r}=t,n=r.roomKey,i=SF[n];if(!i)return;let o=`dungeo.dig.${n}.count`,s=(e.getStateValue(o)||0)+1;e.setStateValue(o,s);let c=`dungeo.dig.${n}.found`;if(e.getStateValue(c)||!1){r.alreadyFound=!0;return}if(s>=i.digsRequired){e.setStateValue(c,!0),r.foundTreasure=i.treasure,r.digCount=s;let u=e.getStateValue("dungeo.statue.locationId"),m=e.getAllEntities().find(f=>f.get(F_.IdentityTrait)?.name?.toLowerCase().includes("statue"));m&&u&&e.moveEntity(m.id,u),e.setStateValue(`dungeo.${i.treasure}.revealed`,!0)}else r.keepDigging=!0,r.digCount=s,r.digsRemaining=i.digsRequired-s},blocked(t,e){return[t.event("action.blocked",{actionId:La,messageId:e.error||rr.CANT_DIG_HERE,reason:e.error})]},report(t){let{sharedData:e}=t,r=[];return e.alreadyFound?r.push(t.event("game.message",{messageId:rr.NOTHING_HERE})):e.foundTreasure?r.push(t.event("game.message",{messageId:rr.FOUND_STATUE,treasure:e.foundTreasure})):e.keepDigging?r.push(t.event("game.message",{messageId:rr.KEEP_DIGGING,digCount:e.digCount,digsRemaining:e.digsRemaining})):r.push(t.event("game.message",{messageId:rr.SUCCESS})),r}};var ld="dungeo.action.wind",Ct={SUCCESS:"dungeo.wind.success",CANARY_SINGS:"dungeo.wind.canary_sings",BAUBLE_APPEARS:"dungeo.wind.bauble_appears",NOT_IN_FOREST:"dungeo.wind.not_in_forest",NO_TARGET:"dungeo.wind.no_target",NOT_WINDABLE:"dungeo.wind.not_windable",NOT_HOLDING:"dungeo.wind.not_holding",ALREADY_WOUND:"dungeo.wind.already_wound"};var Ks=_(E());var Boe=["forest","clearing","path"];function xoe(t){let e=t.get(Ks.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=e.aliases||[];return r.includes("canary")||n.some(i=>i.toLowerCase().includes("canary"))}function joe(t,e){return t.world.getContents(t.player.id).some(n=>n.id===e.id)}function Woe(t){let{world:e,player:r}=t,n=e.getLocation(r.id)||"",i=e.getEntity(n);if(!i)return!1;let a=i.get(Ks.IdentityTrait)?.name?.toLowerCase()||"";return Boe.some(s=>n.toLowerCase().includes(s)||a.includes(s))}function Uoe(t){let e=t.command.parsed?.structure;if(!e?.directObject)return;let r=e.directObject.text||"";return r?t.world.getAllEntities().find(i=>{let o=i.get(Ks.IdentityTrait);if(!o)return!1;let a=o.name?.toLowerCase()||"",s=o.aliases||[],c=r.toLowerCase();return a===c||a.includes(c)||s.some(d=>d.toLowerCase()===c||d.toLowerCase().includes(c))}):void 0}var RF={id:ld,group:"manipulation",validate(t){let e=Uoe(t);return e?joe(t,e)?xoe(e)?(t.sharedData.windTarget=e,t.sharedData.isCanary=!0,{valid:!0}):{valid:!1,error:Ct.NOT_WINDABLE}:{valid:!1,error:Ct.NOT_HOLDING}:{valid:!1,error:Ct.NO_TARGET}},execute(t){let{world:e,player:r,sharedData:n}=t;if(!n.isCanary)return;if(e.getStateValue("dungeo.canary.bauble_produced")||!1){n.alreadyWound=!0;return}let a=Woe(t);if(n.inForest=a,a){e.setStateValue("dungeo.canary.bauble_produced",!0),e.setStateValue("dungeo.bauble.revealed",!0),n.baubleAppeared=!0;let s=e.getLocation(r.id);if(s){let c=e.createEntity("brass bauble",Ks.EntityType.ITEM);c.add(new Ks.IdentityTrait({name:"brass bauble",aliases:["bauble","shiny bauble","brass ball","ball"],description:"A shiny brass bauble, dropped by an unseen songbird in response to the canary's tune.",properName:!1,article:"a",points:1})),c.add(new z({trophyCaseValue:1})),e.moveEntity(c.id,s)}}},blocked(t,e){return[t.event("action.blocked",{actionId:ld,messageId:e.error||Ct.NO_TARGET,reason:e.error})]},report(t){let{sharedData:e}=t,r=[],n=e.windTarget;if(!n)return r;let o=n.get(Ks.IdentityTrait)?.name||"item";return e.alreadyWound?r.push(t.event("game.message",{messageId:Ct.ALREADY_WOUND,params:{target:o}})):e.baubleAppeared?r.push(t.event("game.message",{messageId:Ct.BAUBLE_APPEARS,params:{target:o}})):e.isCanary?r.push(t.event("game.message",{messageId:Ct.CANARY_SINGS,params:{target:o}})):r.push(t.event("game.message",{messageId:Ct.SUCCESS,params:{target:o}})),r}};var Zr=_(E());var ho="dungeo.action.send",Fn={SEND_FOR_BROCHURE:"dungeo.send.brochure",ALREADY_SENT:"dungeo.send.already_sent",NO_TARGET:"dungeo.send.no_target",BROCHURE_KNOCK:"dungeo.send.knock"};function Hoe(t){let{world:e}=t,r=e.getAllEntities().find(s=>s.get(Zr.IdentityTrait)?.name?.toLowerCase().includes("mailbox"));if(!r)return;let n=e.createEntity("brochure",Zr.EntityType.CONTAINER);n.add(new Zr.IdentityTrait({name:"large brochure",aliases:["brochure","MIT brochure","pamphlet","free brochure"],description:"A large brochure from the MIT Tech Correspondence School. It contains pictures of wealthy graduates and a small stamp.",properName:!1,article:"a"})),n.add(new Zr.ContainerTrait({capacity:{maxItems:1}})),n.add(new Zr.OpenableTrait({isOpen:!0})),n.add(new Zr.ReadableTrait({text:`*** MIT TECH CORRESPONDENCE SCHOOL ***

Congratulations on your interest in our fine institution!

Our graduates have gone on to careers in:
  - Paper shuffling
  - Bit twiddling
  - Yak shaving
  - GRUEsome occupations

Enclosed please find a valuable collector's stamp as a FREE gift!

      ** ENROLL TODAY! **`}));let i=e.createEntity("stamp",Zr.EntityType.ITEM);i.add(new Zr.IdentityTrait({name:"Don Woods stamp",aliases:["stamp","woods stamp","postage stamp","spelunker's stamp"],description:`A small postage stamp depicting a spelunker with a lamp. The caption reads:

   SPELUNKER TODAY
   ---------------
   |    ___      |
   |   (o o)     |
   |   /| |\\     |
   |   / \\       |
   ---------------
   Don Woods, Editor

   1 Zorkmid`,properName:!1,article:"a"})),i.add(new z({trophyCaseValue:1})),e.moveEntity(i.id,n.id);let o=r.get(Zr.OpenableTrait),a=o?.isOpen??!1;o&&(o.isOpen=!0),e.moveEntity(n.id,r.id),o&&!a&&(o.isOpen=!1)}var ZD={id:ho,group:"communication",validate(t){let{world:e}=t;return e.getStateValue("dungeo.brochure.ordered")||!1?{valid:!1,error:Fn.ALREADY_SENT}:{valid:!0}},execute(t){let{world:e}=t;e.setStateValue("dungeo.brochure.ordered",!0),Hoe(t)},blocked(t,e){return[t.event("action.blocked",{actionId:ho,messageId:e.error||Fn.NO_TARGET,reason:e.error})]},report(t){return[t.event("game.message",{messageId:Fn.SEND_FOR_BROCHURE}),t.event("game.message",{messageId:Fn.BROCHURE_KNOCK})]}};var CF="dungeo.rainbow.blocked",JD={BLOCKED:"dungeo.rainbow.blocked"};var qoe=0;function Goe(){return`rainbow-blocked-${Date.now()}-${++qoe}`}var wF={id:CF,group:"movement",validate(t){return{valid:!1,error:JD.BLOCKED}},execute(t){},blocked(t,e){return[{id:Goe(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:JD.BLOCKED,message:"The rainbow is beautiful, but it looks far too insubstantial to walk on."},narrate:!0}]},report(t){return[]}};var qt="dungeo.action.pour",wt={SUCCESS:"dungeo.pour.success",INTO_BUCKET:"dungeo.pour.into_bucket",BUCKET_RISES:"dungeo.pour.bucket_rises",BUCKET_AT_TOP:"dungeo.pour.bucket_at_top",NO_WATER:"dungeo.pour.no_water",NO_TARGET:"dungeo.pour.no_target",NOTHING_HAPPENS:"dungeo.pour.nothing_happens",NOT_IN_BUCKET:"dungeo.pour.not_in_bucket"};var $s=_(E()),ud=_(E());function Foe(t){let{world:e,player:r}=t,n=e.getContents(r.id);for(let i of n){if(i.get($s.IdentityTrait)?.name?.toLowerCase().includes("water"))return{water:i,container:void 0};let a=e.getContents(i.id);for(let s of a)if(s.get($s.IdentityTrait)?.name?.toLowerCase().includes("water"))return{water:s,container:i}}return{water:void 0,container:void 0}}function Voe(t){let{world:e,player:r}=t,n=(0,ud.getActorVehicle)(e,r.id);if(n&&n.get($s.IdentityTrait)?.name?.toLowerCase().includes("bucket"))return n;let i=e.getLocation(r.id);if(!i)return;let o=n?e.getLocation(n.id):i;if(!o)return;let a=e.getContents(o);for(let s of a)if(s.get($s.IdentityTrait)?.name?.toLowerCase().includes("bucket"))return s}var NF={id:qt,group:"manipulation",validate(t){let{water:e,container:r}=Foe(t);if(!e)return{valid:!1,error:wt.NO_WATER};let n=Voe(t);return t.sharedData.water=e,t.sharedData.waterContainer=r,t.sharedData.bucket=n,{valid:!0}},execute(t){let{world:e,player:r,sharedData:n}=t,i=n.water,o=n.waterContainer,a=n.bucket,s=!1;if(s&&(console.log("[POUR] water:",i?.id),console.log("[POUR] bucket:",a?.id),a&&console.log("[POUR] bucket traits:",Array.from(a._traits?.keys?.()||[]))),a){let c=a.get($s.VehicleTrait);if(s&&(console.log("[POUR] vehicleTrait:",c),console.log("[POUR] vehicleType:",c?.vehicleType),console.log("[POUR] currentPosition:",c?.currentPosition)),c&&c.vehicleType==="counterweight"){e.moveEntity(i.id,a.id);let d=a.get(gi);if(d&&(d.hasWater=!0),n.pouredIntoBucket=!0,c.currentPosition==="bottom"&&c.positionRooms){let u=c.positionRooms.top;if(u){let m=e.getLocation(a.id);(0,ud.moveVehicle)(e,a.id,u),c.currentPosition="top",n.bucketRose=!0,(0,ud.isActorInVehicle)(e,r.id)&&(n.playerRose=!0,n.fromRoomId=m,n.toRoomId=u)}}else c.currentPosition==="top"&&(n.bucketAlreadyAtTop=!0);return}}i&&(e.moveEntity(i.id,"limbo"),n.pouredOnGround=!0)},blocked(t,e){return[t.event("action.blocked",{actionId:qt,messageId:e.error||wt.NO_WATER,reason:e.error})]},report(t){let{sharedData:e,world:r,player:n}=t,i=[];if(e.bucketRose&&e.playerRose){i.push(t.event("action.success",{actionId:qt,messageId:wt.BUCKET_RISES})),e.fromRoomId&&e.toRoomId&&i.push(t.event("if.event.actor_moved",{actor:{id:n.id},direction:"UP",fromRoom:e.fromRoomId,toRoom:e.toRoomId,oppositeDirection:"DOWN",firstVisit:!0}));let o=(0,ud.getActorVehicle)(r,n.id),a=o?r.getLocation(o.id):void 0;if(a){let c=r.getEntity(a)?.get($s.IdentityTrait);i.push(t.event("room.described",{roomId:a,roomName:c?.name||"Top of Well"}))}}else e.bucketRose?i.push(t.event("action.success",{actionId:qt,messageId:wt.BUCKET_RISES})):e.bucketAlreadyAtTop&&e.pouredIntoBucket?i.push(t.event("action.success",{actionId:qt,messageId:wt.BUCKET_AT_TOP})):e.pouredIntoBucket?i.push(t.event("action.success",{actionId:qt,messageId:wt.INTO_BUCKET})):e.pouredOnGround?i.push(t.event("action.success",{actionId:qt,messageId:wt.SUCCESS})):i.push(t.event("action.success",{actionId:qt,messageId:wt.NOTHING_HAPPENS}));return i}};var nr="dungeo.action.fill",yt={SUCCESS:"dungeo.fill.success",FROM_BUCKET:"dungeo.fill.from_bucket",BUCKET_DESCENDS:"dungeo.fill.bucket_descends",BUCKET_AT_BOTTOM:"dungeo.fill.bucket_at_bottom",NO_BOTTLE:"dungeo.fill.no_bottle",BOTTLE_FULL:"dungeo.fill.bottle_full",NO_SOURCE:"dungeo.fill.no_source",NO_WATER_IN_BUCKET:"dungeo.fill.no_water_in_bucket",NOTHING_HAPPENS:"dungeo.fill.nothing_happens"};var Oi=_(E()),md=_(E());function Yoe(t){let{world:e,player:r}=t,n=e.getContents(r.id);for(let i of n)if(i.get(Oi.IdentityTrait)?.name?.toLowerCase().includes("bottle"))return i}function zoe(t,e){let r=t.world.getContents(e.id);for(let n of r)if(n.get(Oi.IdentityTrait)?.name?.toLowerCase().includes("water"))return!0;return!1}function Koe(t){let{world:e,player:r}=t,n=(0,md.getActorVehicle)(e,r.id);if(n&&n.get(Oi.IdentityTrait)?.name?.toLowerCase().includes("bucket")&&n.get(gi)?.hasWater)return n;let i=e.getLocation(r.id);if(!i)return;let o=n?e.getLocation(n.id):i;if(!o)return;let a=e.getContents(o);for(let s of a)if(s.get(Oi.IdentityTrait)?.name?.toLowerCase().includes("bucket")&&s.get(gi)?.hasWater)return s}function $oe(t,e){let r=t.world.getContents(e.id);for(let n of r)if(n.get(Oi.IdentityTrait)?.name?.toLowerCase().includes("water"))return n}var DF={id:nr,group:"manipulation",validate(t){let e=Yoe(t);if(!e)return{valid:!1,error:yt.NO_BOTTLE};if(zoe(t,e))return{valid:!1,error:yt.BOTTLE_FULL};let r=Koe(t);return t.sharedData.bottle=e,t.sharedData.bucket=r,{valid:!0}},execute(t){let{world:e,player:r,sharedData:n}=t,i=n.bottle,o=n.bucket;if(o){let a=o.get(Oi.VehicleTrait),s=$oe(t,o);if(a&&a.vehicleType==="counterweight"&&s){let c=i.get(Oi.OpenableTrait),d=c?.isOpen??!0;c&&(c.isOpen=!0),e.moveEntity(s.id,i.id),c&&(c.isOpen=d);let u=o.get(gi);if(u&&(u.hasWater=!1),n.filledFromBucket=!0,a.currentPosition==="top"&&a.positionRooms){let m=a.positionRooms.bottom;m&&((0,md.moveVehicle)(e,o.id,m),a.currentPosition="bottom",n.bucketDescended=!0,(0,md.isActorInVehicle)(e,r.id)&&(n.playerDescended=!0))}else a.currentPosition==="bottom"&&(n.bucketAlreadyAtBottom=!0);return}}n.noSource=!0},blocked(t,e){return[t.event("action.blocked",{actionId:nr,messageId:e.error||yt.NO_BOTTLE,reason:e.error})]},report(t){let{sharedData:e,world:r,player:n}=t,i=[];if(e.bucketDescended&&e.playerDescended){i.push(t.event("action.success",{actionId:nr,messageId:yt.BUCKET_DESCENDS}));let o=(0,md.getActorVehicle)(r,n.id),a=o?r.getLocation(o.id):void 0;if(a){let c=r.getEntity(a)?.get(Oi.IdentityTrait);i.push(t.event("room.described",{roomId:a,roomName:c?.name||"Well Bottom"}))}}else e.bucketDescended?i.push(t.event("action.success",{actionId:nr,messageId:yt.BUCKET_DESCENDS})):e.bucketAlreadyAtBottom&&e.filledFromBucket?i.push(t.event("action.success",{actionId:nr,messageId:yt.BUCKET_AT_BOTTOM})):e.filledFromBucket?i.push(t.event("action.success",{actionId:nr,messageId:yt.FROM_BUCKET})):e.noSource?i.push(t.event("action.success",{actionId:nr,messageId:yt.NO_SOURCE})):i.push(t.event("action.success",{actionId:nr,messageId:yt.NOTHING_HAPPENS}));return i}};var Qs="dungeo.action.light",Gt={SUCCESS:"dungeo.light.success",NO_FIRE_SOURCE:"dungeo.light.no_fire_source",NOT_FLAMMABLE:"dungeo.light.not_flammable",ALREADY_BURNING:"dungeo.light.already_burning",GUIDEBOOK_LIT:"dungeo.light.guidebook_lit",IN_RECEPTACLE:"dungeo.light.in_receptacle"};var pd=_(E());var Qoe=["guidebook","book","newspaper","leaves","paper","coal"],Xoe=["match","matches","matchbook","candle","candles","torch","lantern"];function Zoe(t){let e=t.get(pd.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=(e.aliases||[]).map(i=>i.toLowerCase());return Qoe.some(i=>r.includes(i)||n.some(o=>o.includes(i)))}function Joe(t){let e=t.get(pd.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=(e.aliases||[]).map(i=>i.toLowerCase());return Xoe.some(i=>r.includes(i)||n.some(o=>o.includes(i)))}function eae(t){let e=t.get(pd.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=(e.aliases||[]).map(i=>i.toLowerCase());return r.includes("guidebook")||n.some(i=>i.includes("guidebook")||i.includes("guide book"))}function LF(t,e){if(!e)return;let r=e.toLowerCase();return t.world.getAllEntities().find(n=>{let i=n.get(pd.IdentityTrait);if(!i)return!1;let o=i.name?.toLowerCase()||"",a=i.aliases||[];return o===r||o.includes(r)||a.some(s=>s.toLowerCase()===r||s.toLowerCase().includes(r))})}function tae(t){let e=t.command.parsed?.structure;if(!e?.directObject)return;let r=e.directObject.text||"";return LF(t,r)}function rae(t){let e=t.command.parsed?.structure;if(!e?.indirectObject)return;let r=e.indirectObject.text||"";return LF(t,r)}var MF={id:Qs,group:"manipulation",validate(t){let e=tae(t),r=rae(t);if(!e)return{valid:!1,error:Gt.NOT_FLAMMABLE};let n=e.get(ye);return n?.isBurning?{valid:!1,error:Gt.ALREADY_BURNING}:!n&&!Zoe(e)?{valid:!1,error:Gt.NOT_FLAMMABLE}:r?Joe(r)?(t.sharedData.lightTarget=e,t.sharedData.lightTool=r,t.sharedData.isGuidebook=eae(e),{valid:!0}):{valid:!1,error:Gt.NO_FIRE_SOURCE}:{valid:!1,error:Gt.NO_FIRE_SOURCE}},execute(t){let e=t.sharedData.lightTarget;if(!e)return;let r=e.get(ye);if(!r){let i=e.get(pd.IdentityTrait)?.weight??2;e.add(new ye({burnableType:"flammable",isBurning:!1,burnedOut:!1,size:i})),r=e.get(ye)}r.isBurning=!0,r.burnTurnsRemaining=r.size*20,t.sharedData.lightSuccess=!0},blocked(t,e){return[t.event("action.blocked",{actionId:Qs,messageId:e.error||Gt.NOT_FLAMMABLE,reason:e.error})]},report(t){let e=[],r=t.sharedData.lightTarget;if(!r||!t.sharedData.lightSuccess)return e;let i=r.get(pd.IdentityTrait)?.name||"object";return t.sharedData.isGuidebook?e.push(t.event("game.message",{messageId:Gt.GUIDEBOOK_LIT,params:{target:i}})):e.push(t.event("game.message",{messageId:Gt.SUCCESS,params:{target:i}})),e}};var Ma="dungeo.action.tie",lt={SUCCESS:"dungeo.tie.success",NO_ROPE:"dungeo.tie.no_rope",NOT_AT_LEDGE:"dungeo.tie.not_at_ledge",ALREADY_TIED:"dungeo.tie.already_tied",NO_HOOK:"dungeo.tie.no_hook",NOT_IN_BALLOON:"dungeo.tie.not_in_balloon",ROPE_TIED_TO_RAILING:"dungeo.tie.rope_to_railing",ROPE_ALREADY_TIED:"dungeo.tie.rope_already_tied",NO_RAILING:"dungeo.tie.no_railing",NEED_ROPE:"dungeo.tie.need_rope"};var Ar=_(E());var eL={vair2:"ledg2",vair4:"ledg4"};function nae(t){return Kc(t)||t in eL}function iae(t){let e=t.get(Ar.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=(e.aliases||[]).map(i=>i.toLowerCase());return r.includes("wire")||r.includes("braided")||n.some(i=>i.includes("wire")||i.includes("braided"))}function oae(t){let e=t.get(Ar.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=(e.aliases||[]).map(i=>i.toLowerCase());return r.includes("hook")||n.some(i=>i.includes("hook"))}function aae(t){let e=t.get(Ar.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=(e.aliases||[]).map(i=>i.toLowerCase());return r.includes("balloon")||r.includes("basket")||n.some(i=>i.includes("balloon")||i.includes("basket"))}function sae(t){let e=t.get(Ar.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=(e.aliases||[]).map(i=>i.toLowerCase());return r.includes("rope")||r.includes("coil")||n.some(i=>i.includes("rope")||i.includes("coil"))}function cae(t){return t.get(Oa)?.hasRailing===!0}function dae(t){return t.get(Oa)?.ropeAttached===!0}function lae(t){let{world:e,player:r}=t,n=e.getLocation(r.id);if(!n)return null;let i=e.getEntity(n);if(!i||!aae(i))return null;let o=i,a=o.get(kt),s=o.get(Ar.VehicleTrait),c=s?.currentPosition||"vlbot";if(!a||!nae(c))return{valid:!1,error:lt.NOT_AT_LEDGE};if(a.tetheredTo)return{valid:!1,error:lt.ALREADY_TIED};let u=e.getContents(o.id).find(y=>iae(y));if(!u)return{valid:!1,error:lt.NO_ROPE};let m=eL[c]||c,f=s?.positionRooms?.[m],h=(f?e.getContents(f):[]).find(y=>oae(y));return h?(t.sharedData.tieScenario="balloon",t.sharedData.tieBalloon=o,t.sharedData.tieWire=u,t.sharedData.tieHook=h,{valid:!0}):{valid:!1,error:lt.NO_HOOK}}function uae(t){let{world:e,player:r}=t,n=e.getLocation(r.id);if(!n)return null;let i=e.getEntity(n);if(!i||!cae(i))return null;if(dae(i))return{valid:!1,error:lt.ROPE_ALREADY_TIED};let a=e.getContents(r.id).find(s=>sae(s));return a?(t.sharedData.tieScenario="railing",t.sharedData.tieRoom=i,t.sharedData.tieRope=a,{valid:!0}):{valid:!1,error:lt.NEED_ROPE}}var PF={id:Ma,group:"manipulation",validate(t){let e=lae(t);if(e!==null)return e;let r=uae(t);return r!==null?r:{valid:!1,error:lt.NO_RAILING}},execute(t){let e=t.sharedData.tieScenario;if(e==="balloon"){let r=t.sharedData.tieBalloon,n=t.sharedData.tieHook;if(!r||!n)return;let i=r.get(kt),o=r.get(Ar.VehicleTrait),a=n.attributes?.hookId||"hook1";if(!i)return;let s=o?.currentPosition||"vlbot",c=eL[s];if(c){let d=o?.positionRooms?.[c];d&&(0,Ar.moveVehicle)(t.world,r.id,d)}i.tetheredTo=a,i.daemonEnabled=!1,t.sharedData.tieSuccess=!0}else if(e==="railing"){let r=t.sharedData.tieRoom,n=t.sharedData.tieRope,{world:i}=t;if(!r||!n)return;let o=r.get(Oa);o&&(o.ropeAttached=!0),i.moveEntity(n.id,r.id);let a=n.get(Ar.IdentityTrait);if(a&&(a.description="A rope is tied to the railing, dangling down into the darkness below."),o?.torchRoomId){let s=r.get(Ar.RoomTrait);s&&(s.exits[Ar.Direction.DOWN]={destination:o.torchRoomId})}t.sharedData.tieSuccess=!0,t.sharedData.tieRailingSuccess=!0}},blocked(t,e){return[t.event("action.blocked",{actionId:Ma,messageId:e.error||lt.NO_RAILING,reason:e.error})]},report(t){let e=[];return t.sharedData.tieSuccess&&(t.sharedData.tieRailingSuccess?e.push(t.event("game.message",{messageId:lt.ROPE_TIED_TO_RAILING,params:{}})):e.push(t.event("game.message",{messageId:lt.SUCCESS,params:{}}))),e}};var Pa="dungeo.action.untie",Vn={SUCCESS:"dungeo.untie.success",NOT_TIED:"dungeo.untie.not_tied",NO_ROPE:"dungeo.untie.no_rope"};var tL=_(E());function mae(t){let e=t.get(tL.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=(e.aliases||[]).map(i=>i.toLowerCase());return r.includes("wire")||r.includes("braided")||n.some(i=>i.includes("wire")||i.includes("braided"))}function pae(t){let e=t.get(tL.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=(e.aliases||[]).map(i=>i.toLowerCase());return r.includes("balloon")||r.includes("basket")||n.some(i=>i.includes("balloon")||i.includes("basket"))}var kF={id:Pa,group:"manipulation",validate(t){let{world:e,player:r}=t,n=e.getLocation(r.id);if(!n)return{valid:!1,error:Vn.NO_ROPE};let i=e.getEntity(n);if(!i||!pae(i))return{valid:!1,error:Vn.NO_ROPE};let o=i,a=o.get(kt);if(!a||!a.tetheredTo)return{valid:!1,error:Vn.NOT_TIED};let c=e.getContents(o.id).find(d=>mae(d));return c?(t.sharedData.untieBalloon=o,t.sharedData.untieWire=c,{valid:!0}):{valid:!1,error:Vn.NO_ROPE}},execute(t){let e=t.sharedData.untieBalloon;if(!e)return;let r=e.get(kt);r&&(r.tetheredTo=null,r.daemonEnabled=!0,t.sharedData.untieSuccess=!0)},blocked(t,e){return[t.event("action.blocked",{actionId:Pa,messageId:e.error||Vn.NO_ROPE,reason:e.error})]},report(t){let e=[];return t.sharedData.untieSuccess&&e.push(t.event("game.message",{messageId:Vn.SUCCESS,params:{}})),e}};var tp=_(E());var fd="DUNGEO_PRESS_BUTTON",It={CLICK:"dungeo.button.click",NOT_A_BUTTON:"dungeo.button.not_a_button",LIGHTS_ON:"dungeo.button.lights_on",LIGHTS_OFF:"dungeo.button.lights_off",BLUE_JAMMED:"dungeo.button.blue_jammed",BLUE_LEAK_STARTED:"dungeo.button.blue_leak_started"};var rL=null,nL="",BF;function V_(t,e,r){rL=t,nL=e,BF=r}function fae(t){return t.get(tp.TraitType.BUTTON)?.color!==void 0}function gae(t){return t.get(tp.TraitType.BUTTON)?.color}var iL={id:fd,group:"manipulation",validate(t){let e=t.command.directObject?.entity;return e?fae(e)?(t.sharedData.buttonTarget=e,t.sharedData.buttonColor=gae(e),{valid:!0}):{valid:!1,error:It.NOT_A_BUTTON}:{valid:!1,error:It.NOT_A_BUTTON}},execute(t){let{world:e,sharedData:r}=t,n=r.buttonColor,i=r.buttonTarget;if(!(!n||!i))switch(n){case"yellow":Ym(e,!0),r.resultMessage=It.CLICK;break;case"brown":Ym(e,!1),r.resultMessage=It.CLICK;break;case"red":let o=e.getLocation(t.player.id);if(o){let a=e.getEntity(o);if(a){let s=a.get(tp.RoomTrait);if(s){let c=!s.isDark;s.isDark=c,r.resultMessage=c?It.LIGHTS_OFF:It.LIGHTS_ON}}}break;case"blue":if(rL&&nL){let a=gD(rL,e,nL,BF),s=a[0]?.data;a.length>0&&s?.messageId===Ue.BUTTON_JAMMED?r.resultMessage=Ue.BUTTON_JAMMED:(r.resultMessage=Ue.LEAK_STARTED,r.floodingEvents=a)}else r.resultMessage=It.BLUE_JAMMED;break;default:r.resultMessage=It.CLICK}},blocked(t,e){return[t.event("action.blocked",{actionId:fd,messageId:e.error||It.NOT_A_BUTTON,reason:e.error})]},report(t){let{sharedData:e}=t,r=[],n=e.resultMessage||It.CLICK,i=e.buttonColor||"unknown";return r.push(t.event("game.message",{messageId:n,buttonColor:i})),r}};var Xs="dungeo.action.turn_bolt",Rr={NOT_A_BOLT:"dungeo.turn_bolt.not_a_bolt",WONT_TURN:"dungeo.turn_bolt.wont_turn",NO_TOOL:"dungeo.turn_bolt.no_tool",WRONG_TOOL:"dungeo.turn_bolt.wrong_tool",GATES_OPEN:"dungeo.turn_bolt.gates_open",GATES_CLOSE:"dungeo.turn_bolt.gates_close",NO_BOLT:"dungeo.turn_bolt.not_a_bolt",GATE_LOCKED:"dungeo.turn_bolt.wont_turn",NO_WRENCH:"dungeo.turn_bolt.no_tool",DAM_OPENED:"dungeo.turn_bolt.gates_open",DAM_CLOSED:"dungeo.turn_bolt.gates_close",DAM_ALREADY_OPEN:"dungeo.turn_bolt.gates_open"};var He=_(E());var Y_="",rp="",z_="";function jF(t){Y_=t.reservoirSouth,rp=t.reservoir,z_=t.reservoirNorth}function oL(t){let e=t.getEntity(Y_),r=t.getEntity(rp),n=t.getEntity(z_);e&&He.RoomBehavior.blockExit(e,He.Direction.NORTH,"The reservoir is full of water. You cannot walk that way."),r&&(He.RoomBehavior.blockExit(r,He.Direction.NORTH,"The reservoir is full of water. You cannot continue north."),He.RoomBehavior.blockExit(r,He.Direction.SOUTH,"The reservoir is full of water. You cannot continue south.")),n&&He.RoomBehavior.blockExit(n,He.Direction.SOUTH,"The reservoir is full of water. You cannot walk that way.")}function hae(t){let e=t.getEntity(Y_),r=t.getEntity(rp),n=t.getEntity(z_);e&&He.RoomBehavior.unblockExit(e,He.Direction.NORTH),r&&(He.RoomBehavior.unblockExit(r,He.Direction.NORTH),He.RoomBehavior.unblockExit(r,He.Direction.SOUTH)),n&&He.RoomBehavior.unblockExit(n,He.Direction.SOUTH)}function xF(t,e){let r=t.getEntity(Y_),n=t.getEntity(rp),i=t.getEntity(z_);if(e){if(r){let o=r.get(He.IdentityTrait);o&&(o.description="You are on the southern edge of what was once a reservoir. The water has drained away, leaving a muddy expanse stretching north. A path leads south.")}if(n){let o=n.get(He.IdentityTrait);o&&(o.description="You are on the muddy bottom of a drained reservoir. The exposed lake bed stretches in all directions. Various objects that were once submerged are now visible.")}if(i){let o=i.get(He.IdentityTrait);o&&(o.description="You are at the north end of a drained reservoir. The muddy bottom extends to the south, and a dark passage leads north.")}}else{if(r){let o=r.get(He.IdentityTrait);o&&(o.description="You are on the southern shore of a large reservoir. The water extends north as far as you can see. A path leads south.")}if(n){let o=n.get(He.IdentityTrait);o&&(o.description="You are on what used to be a large reservoir, now drained. The muddy bottom is exposed, and you can see various objects that were once submerged.")}if(i){let o=i.get(He.IdentityTrait);o&&(o.description="You are at the north end of a large reservoir. A passage leads north into darkness, and the reservoir extends to the south.")}}}function yae(t){let e=t.getAllEntities().find(r=>r.get(He.IdentityTrait)?.name==="trunk");e&&(e.attributes.revealed=!0)}function Tae(t){let e=t.getAllEntities().find(r=>r.get(He.IdentityTrait)?.name==="trunk");e&&t.getLocation(e.id)===rp&&(e.attributes.revealed=!1)}function Eae(t){let e=t.get(He.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"";return r==="bolt"||r.includes("bolt")}function vae(t){let e=t.get(He.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=e.aliases||[];return r.includes("wrench")||n.some(i=>i.toLowerCase().includes("wrench"))}function _ae(t){let{world:e,player:r}=t,n=e.getLocation(r.id);return n?e.getContents(n).find(o=>Eae(o)):void 0}function bae(t){let{world:e,player:r}=t;return e.getContents(r.id).some(i=>vae(i))}var WF={id:Xs,group:"manipulation",validate(t){let e=_ae(t);if(!e)return{valid:!1,error:Rr.NO_BOLT};if(!bae(t))return{valid:!1,error:Rr.NO_WRENCH};if(!pD(t.world))return{valid:!1,error:Rr.GATE_LOCKED};let r=mD(t.world);return t.sharedData.bolt=e,t.sharedData.alreadyDrained=r,{valid:!0}},execute(t){let{world:e,sharedData:r}=t,n=e;r.alreadyDrained?(N_(n,!1),oL(n),xF(n,!1),Tae(n),r.closedDam=!0):(N_(n,!0),hae(n),xF(n,!0),yae(n),r.closedDam=!1)},blocked(t,e){return[t.event("action.blocked",{actionId:Xs,messageId:e.error||Rr.NO_BOLT,reason:e.error})]},report(t){let{sharedData:e}=t,n=e.closedDam?Rr.DAM_CLOSED:Rr.DAM_OPENED;return[t.event("game.message",{messageId:n})]}};var Ql=_(E());var Yn="dungeo.action.turn_switch",An={NO_SWITCH:"dungeo.turn_switch.no_switch",NO_COAL:"dungeo.turn_switch.no_coal",ALREADY_USED:"dungeo.turn_switch.already_used",SUCCESS:"dungeo.turn_switch.success",DIAMOND_CREATED:"dungeo.turn_switch.diamond_created"};function Iae(t){let e=t.get(Ql.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"";return r==="machine"||r.includes("coal machine")}function Oae(t){let e=t.get(Ql.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=e.aliases||[];return r.includes("coal")||n.some(i=>i.toLowerCase()==="coal")}function Sae(t){let{world:e,player:r}=t,n=e.getLocation(r.id);return n?e.getContents(n).find(o=>Iae(o)):void 0}function Aae(t,e){let{world:r}=t;return r.getContents(e).find(i=>Oae(i))}function Rae(t,e){let{world:r}=t,n=r.createEntity("huge diamond",Ql.EntityType.ITEM);return n.add(new Ql.IdentityTrait({name:"huge diamond",aliases:["diamond","large diamond","gem"],description:"This is an enormous diamond, perfectly cut and dazzlingly brilliant. It must be worth a fortune.",properName:!1,article:"a",points:10})),n.add(new z({trophyCaseValue:6})),r.moveEntity(n.id,e),n}var aL={id:Yn,group:"manipulation",validate(t){let e=Sae(t);if(!e)return{valid:!1,error:An.NO_SWITCH};if(e.get(Ms)?.isActivated)return{valid:!1,error:An.ALREADY_USED};let n=Aae(t,e.id);return n?(t.sharedData.machine=e,t.sharedData.coal=n,{valid:!0}):{valid:!1,error:An.NO_COAL}},execute(t){let{world:e,sharedData:r}=t,n=r.machine,i=r.coal;if(!n||!i)return;e.removeEntity(i.id);let o=Rae(t,n.id);r.diamond=o;let a=n.get(Ms);a&&(a.isActivated=!0)},blocked(t,e){return[t.event("action.blocked",{actionId:Yn,messageId:e.error||An.NO_SWITCH,reason:e.error})]},report(t){return[t.event("game.message",{messageId:An.SUCCESS})]}};var Zs="dungeo.action.put_under",ka={MAT_PLACED:"dungeo.tiny_room.mat_placed",MAT_NOT_HELD:"dungeo.tiny_room.mat_not_held",MAT_ALREADY_PLACED:"dungeo.tiny_room.mat_already_placed",NO_DOOR_HERE:"dungeo.tiny_room.no_door_here",GENERIC_FAIL:"dungeo.put_under.generic_fail"};var ip=_(E());var np="dungeo.action.door_blocked",Xl={DOOR_LOCKED:"dungeo.tiny_room.door_locked"};var Cae=0;function wae(){return`door-blocked-${Date.now()}-${++Cae}`}var UF={id:np,group:"movement",validate(t){return{valid:!1,error:Xl.DOOR_LOCKED}},execute(t){},blocked(t,e){return[{id:wae(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:Xl.DOOR_LOCKED,message:"The door is locked, and there is no keyhole on this side."},narrate:!0}]},report(t){return[]}};var Zl="dungeo.action.pull_mat",gd={MAT_PULLED:"dungeo.tiny_room.mat_pulled",MAT_PULLED_WITH_KEY:"dungeo.tiny_room.mat_pulled_with_key",MAT_NOT_UNDER_DOOR:"dungeo.tiny_room.mat_not_under_door",NO_DOOR_HERE:"dungeo.tiny_room.no_door_here"};var he={MAT_PLACED:"dungeo.tiny_room.mat_placed",MAT_NOT_HELD:"dungeo.tiny_room.mat_not_held",MAT_ALREADY_PLACED:"dungeo.tiny_room.mat_already_placed",NO_DOOR_HERE:"dungeo.tiny_room.no_door_here",KEY_PUSHED:"dungeo.tiny_room.key_pushed",KEY_PUSHED_NO_MAT:"dungeo.tiny_room.key_pushed_no_mat",KEY_ALREADY_PUSHED:"dungeo.tiny_room.key_already_pushed",NO_SCREWDRIVER:"dungeo.tiny_room.no_screwdriver",MAT_PULLED:"dungeo.tiny_room.mat_pulled",MAT_PULLED_WITH_KEY:"dungeo.tiny_room.mat_pulled_with_key",MAT_NOT_UNDER_DOOR:"dungeo.tiny_room.mat_not_under_door",DOOR_LOCKED:"dungeo.tiny_room.door_locked",DOOR_UNLOCKED:"dungeo.tiny_room.door_unlocked",WRONG_KEY:"dungeo.tiny_room.wrong_key",KEYHOLE_BLOCKED:"dungeo.tiny_room.keyhole_blocked",LOOK_AT_DOOR:"dungeo.tiny_room.look_at_door",LOOK_AT_DOOR_WITH_MAT:"dungeo.tiny_room.look_at_door_with_mat",LOOK_AT_DOOR_KEY_ON_MAT:"dungeo.tiny_room.look_at_door_key_on_mat",LOOK_AT_DOOR_UNLOCKED:"dungeo.tiny_room.look_at_door_unlocked"};function Si(t,e){let n=t.getContents(e).find(o=>o.get(Bt)!==void 0);if(n)return n;let i=t.findWhere(o=>o.get(Bt)!==void 0);if(i.length>0)return n=i.find(o=>t.getLocation(o.id)===e),n||i[0]}function Nae(t){let e=t.findWhere(r=>r.get(Ls)!==void 0);return e.length>0?e[0]:void 0}function sL(t,e){let r=t.getContents(e);for(let n of r){let i=n.get(ip.IdentityTrait);if(i){let o=i.name?.toLowerCase()||"",a=i.aliases||[];if(o.includes("mat")||a.some(s=>s.toLowerCase().includes("mat")))return n}}}function cL(t,e){let r=t.getContents(e);for(let n of r){let i=n.get(ip.IdentityTrait);if(i){let o=i.name?.toLowerCase()||"",a=i.aliases||[];if(o.includes("screwdriver")||a.some(s=>s.toLowerCase().includes("screwdriver")))return n}}}function HF(t,e,r){let n=Si(t,r);if(!n)return{success:!1,messageId:he.NO_DOOR_HERE,events:[]};let i=sL(t,e);if(!i)return{success:!1,messageId:he.MAT_NOT_HELD,events:[]};let o=n.get(Bt);if(!o)return{success:!1,messageId:he.NO_DOOR_HERE,events:[]};if(o.matUnderDoor)return{success:!1,messageId:he.MAT_ALREADY_PLACED,events:[]};o.matUnderDoor=!0,t.moveEntity(i.id,r);let a=i.get(ba);return a&&(a.isUnderDoor=!0),{success:!0,messageId:he.MAT_PLACED,events:[{id:`tiny-room-mat-placed-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:he.MAT_PLACED}}]}}function qF(t,e,r){let n=Si(t,r);if(!n)return{success:!1,messageId:he.NO_DOOR_HERE,events:[]};if(!cL(t,e))return{success:!1,messageId:he.NO_SCREWDRIVER,events:[]};let o=n.get(Bt);return o?o.keyInLock?(o.keyInLock=!1,o.matUnderDoor?(o.keyOnMat=!0,{success:!0,messageId:he.KEY_PUSHED,events:[{id:`tiny-room-key-pushed-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:he.KEY_PUSHED}}]}):{success:!0,messageId:he.KEY_PUSHED_NO_MAT,events:[{id:`tiny-room-key-lost-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:he.KEY_PUSHED_NO_MAT}}]}):{success:!1,messageId:he.KEY_ALREADY_PUSHED,events:[]}:{success:!1,messageId:he.NO_DOOR_HERE,events:[]}}function GF(t,e,r){let n=Si(t,r);if(!n)return{success:!1,messageId:he.NO_DOOR_HERE,events:[]};let i=n.get(Bt);if(!i)return{success:!1,messageId:he.NO_DOOR_HERE,events:[]};if(!i.matUnderDoor)return{success:!1,messageId:he.MAT_NOT_UNDER_DOOR,events:[]};let a=t.getContents(r).find(c=>c.get(ba)?.isUnderDoor===!0);if(!a)return{success:!1,messageId:he.MAT_NOT_UNDER_DOOR,events:[]};i.matUnderDoor=!1;let s=a.get(ba);if(s&&(s.isUnderDoor=!1),t.moveEntity(a.id,e),i.keyOnMat){i.keyOnMat=!1;let c=Nae(t);if(c){let d=c.get(Ls);d&&(d.isHidden=!1),t.moveEntity(c.id,e)}return{success:!0,messageId:he.MAT_PULLED_WITH_KEY,events:[{id:`tiny-room-mat-key-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:he.MAT_PULLED_WITH_KEY}}]}}return{success:!0,messageId:he.MAT_PULLED,events:[{id:`tiny-room-mat-pulled-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:he.MAT_PULLED}}]}}function FF(t){let e=t.getPlayer();if(!e)return!1;let r=t.getLocation(e.id);if(!r)return!1;let n=t.getEntity(r);return n?(n.get(ip.IdentityTrait)?.name||"")==="Tiny Room":!1}function Dae(t){let e=t.action?.toLowerCase();if(e!=="go"&&e!=="going"&&e!=="if.action.going")return!1;let r;return t.extras?.direction?r=String(t.extras.direction).toLowerCase():t.structure?.directObject?.head&&(r=t.structure.directObject.head.toLowerCase()),r==="north"||r==="n"}function Lae(t){let e=t.getPlayer();if(!e)return!1;let r=t.getLocation(e.id);if(!r)return!1;let n=Si(t,r);return n?n.isLocked:!1}function VF(){return(t,e)=>!FF(e)||!Dae(t)||!Lae(e)?t:{...t,action:np,extras:{...t.extras,originalAction:t.action,isDoorBlocked:!0}}}function Mae(t){if(t.action!=="if.action.taking")return!1;let e=t.structure?.directObject?.head?.toLowerCase();return e==="mat"||e==="welcome mat"}function Pae(t){let e=t.getPlayer();if(!e)return!1;let r=t.getLocation(e.id);if(!r)return!1;let n=Si(t,r);return n?n.get(Bt)?.matUnderDoor===!0:!1}function YF(){return(t,e)=>!FF(e)||!Mae(t)||!Pae(e)?t:{...t,action:Zl,extras:{...t.extras,originalAction:t.action,isPullingMatFromDoor:!0}}}var kae=0;function zF(){return`put-under-${Date.now()}-${++kae}`}var KF={id:Zs,group:"manipulation",validate(t){let{world:e}=t,r=e.getPlayer();if(!r)return{valid:!1,error:"error.no_player"};let n=e.getLocation(r.id);if(!n)return{valid:!1,error:"error.no_location"};let i=Si(e,n);return i?i.get(Bt)?.matUnderDoor?{valid:!1,error:ka.MAT_ALREADY_PLACED}:sL(e,r.id)?{valid:!0}:{valid:!1,error:ka.MAT_NOT_HELD}:{valid:!1,error:ka.NO_DOOR_HERE}},execute(t){let{world:e}=t,r=e.getPlayer();if(!r)return;let n=e.getLocation(r.id);n&&HF(e,r.id,n)},blocked(t,e){return[{id:zF(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:e.error||ka.GENERIC_FAIL},narrate:!0}]},report(t){return[{id:zF(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:ka.MAT_PLACED},narrate:!0}]}};var yo="dungeo.action.push_key",hd={KEY_PUSHED:"dungeo.tiny_room.key_pushed",KEY_PUSHED_NO_MAT:"dungeo.tiny_room.key_pushed_no_mat",KEY_ALREADY_PUSHED:"dungeo.tiny_room.key_already_pushed",NO_SCREWDRIVER:"dungeo.tiny_room.no_screwdriver",NO_DOOR_HERE:"dungeo.tiny_room.no_door_here"};var Bae=0;function $F(){return`push-key-${Date.now()}-${++Bae}`}var dL,QF={id:yo,group:"manipulation",validate(t){let{world:e}=t,r=e.getPlayer();if(!r)return{valid:!1,error:"error.no_player"};let n=e.getLocation(r.id);if(!n)return{valid:!1,error:"error.no_location"};let i=Si(e,n);return i?cL(e,r.id)?i.get(Bt)?.keyInLock?{valid:!0}:{valid:!1,error:hd.KEY_ALREADY_PUSHED}:{valid:!1,error:hd.NO_SCREWDRIVER}:{valid:!1,error:hd.NO_DOOR_HERE}},execute(t){let{world:e}=t,r=e.getPlayer();if(!r)return;let n=e.getLocation(r.id);n&&(dL=qF(e,r.id,n))},blocked(t,e){return[{id:$F(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:e.error||hd.NO_DOOR_HERE},narrate:!0}]},report(t){let e=dL?.messageId||hd.KEY_PUSHED;return dL=void 0,[{id:$F(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:e},narrate:!0}]}};var xae=0;function XF(){return`pull-mat-${Date.now()}-${++xae}`}var lL={id:Zl,group:"manipulation",validate(t){let{world:e}=t,r=e.getPlayer();if(!r)return{valid:!1,error:"error.no_player"};let n=e.getLocation(r.id);if(!n)return{valid:!1,error:"error.no_location"};let i=Si(e,n);return i?i.get(Bt)?.matUnderDoor?{valid:!0}:{valid:!1,error:gd.MAT_NOT_UNDER_DOOR}:{valid:!1,error:gd.NO_DOOR_HERE}},execute(t){let{world:e,sharedData:r}=t,n=e.getPlayer();if(!n)return;let i=e.getLocation(n.id);if(!i)return;let o=GF(e,n.id,i);r.pullMatResult=o},blocked(t,e){return[{id:XF(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:e.error||gd.MAT_NOT_UNDER_DOOR},narrate:!0}]},report(t){let e=t.sharedData.pullMatResult;return e&&e.events&&e.events.length>0?e.events:[{id:XF(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:gd.MAT_PULLED},narrate:!0}]}};var Ba="dungeo.action.inflate",Rn={SUCCESS:"dungeo.inflate.success",NO_PUMP:"dungeo.inflate.no_pump",ALREADY_INFLATED:"dungeo.inflate.already_inflated",NOT_INFLATABLE:"dungeo.inflate.not_inflatable",CANT_REACH:"dungeo.inflate.cant_reach"};var Ai=_(E());function ZF(t){let e=t.get(Ai.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=e.aliases||[],i=["boat","raft","plastic","pile"];return i.some(o=>r.includes(o))||n.some(o=>i.some(a=>o.toLowerCase().includes(a)))}function jae(t){let e=t.get(Ai.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=e.aliases||[];return r.includes("pump")||n.some(i=>i.toLowerCase().includes("pump"))}function Wae(t){return t.world.getContents(t.player.id).find(r=>jae(r))}function Uae(t){let{world:e,player:r}=t,n=e.getLocation(r.id),o=e.getContents(r.id).find(a=>ZF(a));if(o)return o;if(n){let s=e.getContents(n).find(c=>ZF(c));if(s)return s}}var JF={id:Ba,group:"manipulation",validate(t){let e=Uae(t);if(!e)return{valid:!1,error:Rn.NOT_INFLATABLE};if(e.get(et)?.isInflated)return{valid:!1,error:Rn.ALREADY_INFLATED};let n=Wae(t);return n?(t.sharedData.boat=e,t.sharedData.pump=n,{valid:!0}):{valid:!1,error:Rn.NO_PUMP}},execute(t){let{sharedData:e}=t,r=e.boat,n=r.get(et);n&&(n.isInflated=!0);let i=r.get(Ai.IdentityTrait);i&&(i.name="magic boat",i.article="a",i.description="The boat is a seaworthy craft approximately eight feet long. A pair of oars is affixed to the side."),r.attributes.displayName="magic boat",r.has(Ai.TraitType.ENTERABLE)||r.add(new Ai.EnterableTrait({preposition:"in"})),r.has(Ai.TraitType.VEHICLE)||r.add(new Ai.VehicleTrait({vehicleType:"watercraft",blocksWalkingMovement:!1,requiresExitBeforeLeaving:!1,isOperational:!0,transparent:!0}))},blocked(t,e){return[t.event("action.blocked",{actionId:Ba,messageId:e.error||Rn.NOT_INFLATABLE,reason:e.error})]},report(t){return[t.event("game.message",{messageId:Rn.SUCCESS})]}};var Js="dungeo.action.deflate",Ri={SUCCESS:"dungeo.deflate.success",ALREADY_DEFLATED:"dungeo.deflate.already_deflated",NOT_DEFLATABLE:"dungeo.deflate.not_deflatable",CANT_REACH:"dungeo.deflate.cant_reach"};var ec=_(E());function uL(t){let e=t.get(ec.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=e.aliases||[],i=["boat","raft","plastic","pile"];return i.some(o=>r.includes(o))||n.some(o=>i.some(a=>o.toLowerCase().includes(a)))}function Hae(t){let{world:e,player:r}=t,n=e.getLocation(r.id),o=e.getContents(r.id).find(a=>uL(a));if(o)return o;if(n){let a=e.getEntity(n);if(a&&uL(a))return a;let c=e.getContents(n).find(d=>uL(d));if(c)return c}}var eV={id:Js,group:"manipulation",validate(t){let e=Hae(t);return e?e.get(et)?.isInflated?(t.sharedData.boat=e,{valid:!0}):{valid:!1,error:Ri.ALREADY_DEFLATED}:{valid:!1,error:Ri.NOT_DEFLATABLE}},execute(t){let{sharedData:e,world:r,player:n}=t,i=e.boat;if(r.getLocation(n.id)===i.id){let c=r.getLocation(i.id);c&&(r.moveEntity(n.id,c),e.wasEjected=!0)}let a=i.get(et);a&&(a.isInflated=!1);let s=i.get(ec.IdentityTrait);s&&(s.name="pile of plastic",s.article="a",s.description="There is a folded pile of plastic here which has a small valve attached."),i.attributes.displayName="pile of plastic",i.has(ec.TraitType.ENTERABLE)&&i.remove(ec.TraitType.ENTERABLE),i.has(ec.TraitType.VEHICLE)&&i.remove(ec.TraitType.VEHICLE)},blocked(t,e){return[t.event("action.blocked",{actionId:Js,messageId:e.error||Ri.NOT_DEFLATABLE,reason:e.error})]},report(t){return[t.event("game.message",{messageId:Ri.SUCCESS})]}};var op="dungeo.action.river_blocked",K_={NO_BOAT:"dungeo.river.no_boat"};var qae=0;function Gae(){return`river-blocked-${Date.now()}-${++qae}`}var tV={id:op,group:"movement",validate(t){return{valid:!1,error:K_.NO_BOAT}},execute(t){},blocked(t,e){return[{id:Gae(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:K_.NO_BOAT},narrate:!0}]},report(t){return[]}};var xa=_(E());var yd="dungeo.action.launch",Cr={SUCCESS:"dungeo.launch.success",NOT_IN_BOAT:"dungeo.launch.not_in_boat",NOT_AT_SHORE:"dungeo.launch.not_at_shore",BOAT_NOT_INFLATED:"dungeo.launch.boat_not_inflated",ALREADY_ON_RIVER:"dungeo.launch.already_on_river"};function Fae(t){let{world:e,player:r}=t,n=e.getLocation(r.id);if(!n)return{boat:null,isInBoat:!1};let i=e.getEntity(n);if(!i)return{boat:null,isInBoat:!1};if(!i.has(xa.TraitType.VEHICLE))return{boat:null,isInBoat:!1};let o=i.get(xa.VehicleTrait);return!o||o.vehicleType!=="watercraft"?{boat:null,isInBoat:!1}:{boat:i,isInBoat:!0}}function Vae(t){let{world:e,player:r}=t,n=e.getContainingRoom(r.id);if(!n)return null;let i=n.get(nt);if(!i?.canLaunchBoat)return null;if(i.launchDestination)return i.launchDestination;let o=n.get(xa.RoomTrait);if(!o)return null;for(let a of[xa.Direction.EAST,xa.Direction.WEST]){let s=o.exits[a];if(s?.destination){let c=e.getEntity(s.destination),d=c?.get(nt);if(c&&d?.isWaterRoom)return s.destination}}return null}var mL={id:yd,group:"movement",validate(t){let{world:e,player:r}=t,{boat:n,isInBoat:i}=Fae(t);if(!i||!n)return{valid:!1,error:Cr.NOT_IN_BOAT};if(!n.get(et)?.isInflated)return{valid:!1,error:Cr.BOAT_NOT_INFLATED};let a=e.getContainingRoom(r.id),s=a?.get(nt);if(a&&s?.isWaterRoom)return{valid:!1,error:Cr.ALREADY_ON_RIVER};let c=Vae(t);return c?(t.sharedData.boat=n,t.sharedData.destination=c,{valid:!0}):{valid:!1,error:Cr.NOT_AT_SHORE}},execute(t){let{world:e}=t,{boat:r,destination:n}=t.sharedData;e.moveEntity(r.id,n)},blocked(t,e){return[t.event("action.blocked",{actionId:yd,messageId:e.error||Cr.NOT_IN_BOAT,reason:e.error})]},report(t){let{world:e,player:r}=t,i=e.getContainingRoom(r.id)?.name||"the river";return[t.event("game.message",{messageId:Cr.SUCCESS}),t.event("if.event.actor_moved",{actorId:r.id,currentLocation:t.sharedData.destination})]}};var pL="dungeo.action.falls_death",fL={DEATH:"dungeo.falls.death"};var rV={id:pL,group:"special",validate(t){return{valid:!0}},execute(t){t.world.setStateValue("dungeo.player.dead",!0),t.world.setStateValue("dungeo.player.death_cause","falls")},blocked(t,e){return[]},report(t){return[t.event("if.event.player.died",{messageId:fL.DEATH,cause:"aragain_falls"})]}};var gL="dungeo.action.gas_explosion",Td={DEATH:"dungeo.gas.explosion_death",LIGHT_DEATH:"dungeo.gas.light_death"};var nV={id:gL,group:"special",validate(t){return{valid:!0}},execute(t){t.world.setStateValue("dungeo.player.dead",!0),t.world.setStateValue("dungeo.player.death_cause","gas_explosion")},blocked(t,e){return[]},report(t){let r=(t.command.parsed.extras?.explosionType||"enter")==="light"?Td.LIGHT_DEATH:Td.DEATH;return[t.event("if.event.player.died",{messageId:r,cause:"gas_explosion"})]}};var tc="dungeo.action.grue_death",Ed={WALKED_INTO_GRUE:"dungeo.grue.walked_into",SLITHERED_INTO_ROOM:"dungeo.grue.slithered_into",PITCH_DARK_WARNING:"dungeo.grue.pitch_dark_warning"};var iV={id:tc,group:"special",validate(t){return{valid:!0}},execute(t){t.world.setStateValue("dungeo.player.dead",!0),t.world.setStateValue("dungeo.player.death_cause","grue")},blocked(t,e){return[]},report(t){let e=t.command.parsed.extras?.grueDeathType||"walked_into",r=e==="slithered"?Ed.SLITHERED_INTO_ROOM:Ed.WALKED_INTO_GRUE;return[t.event("if.event.player.died",{messageId:r,cause:"grue",deathType:e})]}};var rc="dungeo.chimney.blocked",To={TOO_MUCH_BAGGAGE:"dungeo.chimney.too_much_baggage",EMPTY_HANDED:"dungeo.chimney.empty_handed"};var Yae=0;function zae(){return`chimney-blocked-${Date.now()}-${++Yae}`}var hL={id:rc,group:"movement",validate(t){return{valid:!1,error:t.command.parsed?.extras?.chimneyBlockReason==="empty"?To.EMPTY_HANDED:To.TOO_MUCH_BAGGAGE}},execute(t){},blocked(t,e){let r=t.command.parsed?.extras?.chimneyBlockReason,n,i;return r==="empty"?(n=To.EMPTY_HANDED,i="Going up empty-handed is a bad idea."):(n=To.TOO_MUCH_BAGGAGE,i="The chimney is too narrow for you and all of your baggage."),[{id:zae(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:n,message:i},narrate:!0}]},report(t){return[]}};var Ne=_(E());var Ge={NO_TARGET:"dungeo.commanding.no_target",CANT_COMMAND:"dungeo.commanding.cant_command",CANT_SEE:"dungeo.commanding.cant_see",WHIRR_BUZZ_CLICK:"dungeo.commanding.whirr_buzz_click",STUPID_ROBOT:"dungeo.commanding.stupid_robot"},ja="dungeo.action.commanding";var Xe={DESCRIPTION:"dungeo.robot.description",FOLLOWS:"dungeo.robot.follows",WAITS:"dungeo.robot.waits",COMMAND_UNDERSTOOD:"dungeo.robot.command_understood",COMMAND_UNKNOWN:"dungeo.robot.command_unknown",PUSHES_BUTTON:"dungeo.robot.pushes_button",NO_BUTTON:"dungeo.robot.no_button",ALREADY_PUSHED:"dungeo.robot.already_pushed",ARRIVES:"dungeo.robot.arrives",TAKES_OBJECT:"dungeo.robot.takes_object",DROPS_OBJECT:"dungeo.robot.drops_object",RAISES_CAGE:"dungeo.robot.raises_cage",CAROUSEL_FIXED:"dungeo.robot.carousel_fixed"};var ap=_(E());function sp(t){let e=t.get(ap.NpcTrait);return e?.customProperties?e.customProperties:null}function $_(t,e,r){let n=[],i=sp(e);if(!i)return n;i.buttonPushed=!0;let o=t.getEntity(r);if(o){let a=o.get(Ia);a&&(a.isFixed=!0)}return t.setStateValue("dungeo.carousel.active",!0),n.push({id:`robot-push-button-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{actor:e.id},data:{npc:e.id,messageId:Xe.PUSHES_BUTTON,npcName:"robot"},narrate:!0}),n.push({id:`carousel-fixed-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:Xe.CAROUSEL_FIXED},narrate:!0}),n}var Kae=["walk","go","north","south","east","west","up","down","n","s","e","w","u","d","ne","nw","se","sw","northeast","northwest","southeast","southwest","take","get","pick","drop","put","push","press","throw","turn","raise","lift","leap","jump"],yL={n:"NORTH",north:"NORTH",s:"SOUTH",south:"SOUTH",e:"EAST",east:"EAST",w:"WEST",west:"WEST",u:"UP",up:"UP",d:"DOWN",down:"DOWN",ne:"NORTHEAST",northeast:"NORTHEAST",nw:"NORTHWEST",northwest:"NORTHWEST",se:"SOUTHEAST",southeast:"SOUTHEAST",sw:"SOUTHWEST",southwest:"SOUTHWEST"};function $ae(t){if(!t)return!1;let e=t.get?.(Ne.IdentityTrait);return e?e.name==="Machine Room"&&e.description?.includes("triangular button"):!1}function Qae(t){let e=t.world.getAllEntities();for(let r of e)if(r.get(Ne.IdentityTrait)?.name==="Round Room")return r;return null}function oV(t,e,r){let n=[],i=t.world.getLocation(e.id);if(!i)return n.push(t.event("game.message",{messageId:Ge.WHIRR_BUZZ_CLICK})),n;let o=t.world.getEntity(i);if(!o)return n.push(t.event("game.message",{messageId:Ge.WHIRR_BUZZ_CLICK})),n;let s=o.get(Ne.RoomTrait)?.exits||{},c=yL[r],u=s[c]?.destination;return u?(t.world.moveEntity(e.id,u),n.push(t.event("game.message",{messageId:Ge.WHIRR_BUZZ_CLICK})),t.world.getLocation(t.player.id)===u&&n.push(t.event("game.message",{messageId:Xe.ARRIVES})),n):(n.push(t.event("game.message",{messageId:Ge.WHIRR_BUZZ_CLICK})),n)}function Xae(t,e,r){let n=[],i=t.world.getLocation(e.id);if(!i)return n.push(t.event("game.message",{messageId:Ge.WHIRR_BUZZ_CLICK})),n;let o=t.world.getContents(i),a=null;for(let s of o){if(s.id===e.id)continue;let c=s.get(Ne.IdentityTrait);if(!c)continue;let d=c.name?.toLowerCase()||"",u=c.aliases?.map(m=>m.toLowerCase())||[];if(d.includes(r)||u.some(m=>m.includes(r))){a=s;break}}if(n.push(t.event("game.message",{messageId:Ge.WHIRR_BUZZ_CLICK})),a){let s=a.get(Ne.IdentityTrait);if(s?.name==="white crystal sphere"&&!t.world.getStateValue(c_))return tse(t,e);a.portable!==!1&&(t.world.moveEntity(a.id,e.id),n.push(t.event("game.message",{messageId:Xe.TAKES_OBJECT,objectName:s?.name||"object"})))}return n}function Zae(t,e,r){let n=[],i=t.world.getLocation(e.id);if(!i)return n.push(t.event("game.message",{messageId:Ge.WHIRR_BUZZ_CLICK})),n;let o=t.world.getContents(e.id),a=null;for(let s of o){let c=s.get(Ne.IdentityTrait);if(!c)continue;let d=c.name?.toLowerCase()||"",u=c.aliases?.map(m=>m.toLowerCase())||[];if(d.includes(r)||u.some(m=>m.includes(r))){a=s;break}}return n.push(t.event("game.message",{messageId:Ge.WHIRR_BUZZ_CLICK})),a&&(t.world.moveEntity(a.id,i),n.push(t.event("game.message",{messageId:Xe.DROPS_OBJECT,objectName:a.get(Ne.IdentityTrait)?.name||"object"}))),n}function Jae(t,e){let r=t.getEntity(e);r&&(Ne.RoomBehavior.unblockExit(r,Ne.Direction.NORTH),Ne.RoomBehavior.unblockExit(r,Ne.Direction.SOUTH),Ne.RoomBehavior.unblockExit(r,Ne.Direction.EAST),Ne.RoomBehavior.unblockExit(r,Ne.Direction.WEST),Ne.RoomBehavior.unblockExit(r,Ne.Direction.UP),Ne.RoomBehavior.unblockExit(r,Ne.Direction.DOWN),Ne.RoomBehavior.unblockExit(r,Ne.Direction.NORTHEAST),Ne.RoomBehavior.unblockExit(r,Ne.Direction.NORTHWEST),Ne.RoomBehavior.unblockExit(r,Ne.Direction.SOUTHEAST),Ne.RoomBehavior.unblockExit(r,Ne.Direction.SOUTHWEST))}function ese(t,e){let r=[];if(!t.world.getStateValue(ks))return r.push(t.event("game.message",{npc:e.id,messageId:Ge.WHIRR_BUZZ_CLICK,npcName:"robot"})),r;t.world.setStateValue(ks,!1),t.world.setStateValue(c_,!0),t.world.setStateValue(Qc,0);let i=t.world.getStateValue(iG);return i&&Jae(t.world,i),r.push(t.event("game.message",{npc:e.id,messageId:it.CAGE_RAISED,npcName:"robot"})),r}function tse(t,e){let r=[];return r.push(t.event("game.message",{messageId:it.ROBOT_CRUSH})),t.world.setStateValue("dungeo.player.dead",!0),t.world.setStateValue("dungeo.player.death_cause","robot_crush"),r.push(t.event("game.player_death",{cause:"robot_crush",messageId:it.ROBOT_CRUSH})),r}function rse(t,e,r){let n=[],i=sp(e);if(!i)return[t.event("action.blocked",{actionId:ja,messageId:Ge.CANT_COMMAND})];let o=r.split(/\s+/),a=o[0]||"";if((a==="push"||a==="press")&&r.includes("button")){if(i.buttonPushed)return n.push(t.event("game.message",{npc:e.id,messageId:Xe.ALREADY_PUSHED,npcName:"robot"})),n;let s=t.world.getLocation(e.id),c=s?t.world.getEntity(s):null;if(!$ae(c))return n.push(t.event("game.message",{npc:e.id,messageId:Xe.NO_BUTTON,npcName:"robot"})),n;n.push(t.event("game.message",{npc:e.id,messageId:Ge.WHIRR_BUZZ_CLICK,npcName:"robot"}));let d=Qae(t);if(d){let u=$_(t.world,e,d.id);n.push(...u)}else n.push(t.event("game.message",{npc:e.id,messageId:Xe.PUSHES_BUTTON,npcName:"robot"}));return n}if((a==="raise"||a==="lift")&&r.includes("cage"))return ese(t,e);if(a==="walk"||a==="go"){let s=o[1]||"";if(yL[s])return oV(t,e,s)}if(yL[a])return oV(t,e,a);if(a==="take"||a==="get"||a==="pick"){let s=o.slice(a==="pick"?2:1).join(" ");return s?Xae(t,e,s):(n.push(t.event("game.message",{messageId:Ge.WHIRR_BUZZ_CLICK})),n)}if(a==="drop"){let s=o.slice(1).join(" ");return s?Zae(t,e,s):(n.push(t.event("game.message",{messageId:Ge.WHIRR_BUZZ_CLICK})),n)}return Kae.includes(a)?(n.push(t.event("game.message",{npc:e.id,messageId:Ge.WHIRR_BUZZ_CLICK,npcName:"robot"})),n):(n.push(t.event("game.message",{npc:e.id,messageId:Ge.STUPID_ROBOT,npcName:"robot"})),n)}var TL={id:ja,group:"communication",validate(t){let e=t.command.directObject?.entity;return e?e.get(Ne.IdentityTrait)?.name!=="robot"?{valid:!1,error:Ge.CANT_COMMAND}:t.canSee(e)?{valid:!0}:{valid:!1,error:Ge.CANT_SEE}:{valid:!1,error:Ge.NO_TARGET}},execute(t){let e=t.command.directObject.entity,r=t.command.parsed?.textSlots?.get("command")||"";t.sharedData.robot=e,t.sharedData.command=r.toLowerCase().trim()},blocked(t,e){return[t.event("game.message",{actionId:ja,messageId:e.error||Ge.CANT_COMMAND})]},report(t){let{robot:e,command:r}=t.sharedData;return rse(t,e,r)}};var sV=_(E()),Wa="dungeo.action.talk_to_troll",Jl={CANT_HEAR_YOU:"dungeo.troll.cant_hear_you",GROWLS:"dungeo.troll.growls_at_player"};function aV(t){return t.sharedData}var EL={id:Wa,group:"communication",validate(t){let e=aV(t),r=t.world.getAllEntities().find(a=>!!(a.name.toLowerCase()==="troll"||a.get("identity")?.aliases?.some(c=>c.toLowerCase()==="troll")));if(!r)return{valid:!1,error:"no_troll",params:{}};let n=t.world.getLocation(r.id),i=t.world.getLocation(t.player.id);if(n!==i)return{valid:!1,error:"troll_not_here",params:{}};e.trollId=r.id;let o=r.get(sV.CombatantTrait);return e.isIncapacitated=o&&(!o.isAlive||!o.isConscious),{valid:!0}},execute(t){},report(t){let r=aV(t).isIncapacitated?Jl.CANT_HEAR_YOU:Jl.GROWLS;return[t.event("action.success",{actionId:Wa,messageId:r})]},blocked(t,e){return e.error==="troll_not_here"||e.error==="no_troll"?[t.event("action.blocked",{actionId:Wa,messageId:"core.entity_not_found"})]:[]}};var vd="dungeo.action.diagnose",Ce={PERFECT_HEALTH:"dungeo.diagnose.perfect_health",LIGHT_WOUND:"dungeo.diagnose.light_wound",SERIOUS_WOUND:"dungeo.diagnose.serious_wound",SEVERAL_WOUNDS:"dungeo.diagnose.several_wounds",WOUNDS_CURE:"dungeo.diagnose.wounds_cure",LIGHT_WOUND_CURE:"dungeo.diagnose.light_wound_cure",SERIOUS_WOUND_CURE:"dungeo.diagnose.serious_wound_cure",SEVERAL_WOUNDS_CURE:"dungeo.diagnose.several_wounds_cure",SERIOUS_WOUNDS_CURE:"dungeo.diagnose.serious_wounds_cure",DEATHS_DOOR:"dungeo.diagnose.deaths_door",ONE_MORE_WOUND:"dungeo.diagnose.one_more_wound",SERIOUS_WOUND_KILL:"dungeo.diagnose.serious_wound_kill",SURVIVE_SERIOUS:"dungeo.diagnose.survive_serious",STRONG:"dungeo.diagnose.strong",KILLED_ONCE:"dungeo.diagnose.killed_once",KILLED_TWICE:"dungeo.diagnose.killed_twice",KILLED_MANY:"dungeo.diagnose.killed_many"};function cV(t){return t.sharedData}var vL={id:vd,group:"meta",validate(t){return{valid:!0}},execute(t){let{world:e}=t,r=e.getPlayer(),n=cV(t);if(!r){n.woundLevel=0,n.strengthLevel=4,n.deaths=0,n.turnsToHeal=0;return}let i=r.attributes[pe.WOUND_ADJUST]??0,o=e.getScore(),a=e.getStateValue(Ml.TICKS)||0,s=i<0?Wm-a:0,c=e.getStateValue("dungeo.player.deaths")||0,d=fG(o,i,s,c);n.woundLevel=d.woundDepth,n.strengthLevel=d.remainingStrength,n.turnsToHeal=d.turnsToHeal,n.deaths=d.deaths},blocked(t,e){return[t.event("action.blocked",{actionId:this.id,messageId:e.error,reason:e.error,params:e.params||{}})]},report(t){let e=cV(t),r=[],{woundLevel:n,strengthLevel:i,deaths:o,turnsToHeal:a}=e;if(n===0)r.push(t.event("game.message",{messageId:Ce.PERFECT_HEALTH}));else{let c;switch(n){case 1:c=Ce.LIGHT_WOUND_CURE;break;case 2:c=Ce.SERIOUS_WOUND_CURE;break;case 3:c=Ce.SEVERAL_WOUNDS_CURE;break;default:c=Ce.SERIOUS_WOUNDS_CURE;break}r.push(t.event("game.message",{messageId:c,params:{turns:a}}))}let s;switch(i){case 0:s=Ce.DEATHS_DOOR;break;case 1:s=Ce.ONE_MORE_WOUND;break;case 2:s=Ce.SERIOUS_WOUND_KILL;break;case 3:s=Ce.SURVIVE_SERIOUS;break;default:s=Ce.STRONG;break}return r.push(t.event("game.message",{messageId:s})),o===1?r.push(t.event("game.message",{messageId:Ce.KILLED_ONCE})):o===2?r.push(t.event("game.message",{messageId:Ce.KILLED_TWICE})):o>2&&r.push(t.event("game.message",{messageId:Ce.KILLED_MANY,params:{count:o}})),r}};var Eo="dungeo.action.melt",nc={DEATH:"dungeo.glacier.melt_death",NO_FLAME:"dungeo.glacier.melt_no_flame",NOTHING:"dungeo.glacier.melt_nothing",NO_INSTRUMENT:"dungeo.glacier.melt_no_instrument"};var eu=_(E());function nse(t){let e=t.world.getLocation(t.player.id)||"";return t.world.getContents(e).find(n=>!!n.get(Kr))}function ise(t){return t.attributes.isFlame?t.get(eu.LightSourceTrait)?.isLit??!1:!1}var dV={id:Eo,group:"manipulation",validate(t){let e=t.command.directObject?.entity||nse(t),r=t.command.instrument?.entity??t.command.indirectObject?.entity;return!e||!e.get(Kr)?{valid:!1,error:nc.NOTHING}:e.get(Kr)?.melted?{valid:!1,error:nc.NOTHING}:r?(t.sharedData.target=e,t.sharedData.instrument=r,{valid:!0}):{valid:!1,error:nc.NO_INSTRUMENT}},execute(t){let e=t.sharedData.instrument;if(!e)return;if(!ise(e)){let n=e.get(eu.IdentityTrait);t.sharedData.instrumentName=n?.name||"that",t.sharedData.noFlame=!0;return}if(t.sharedData.death=!0,t.world.setStateValue("dungeo.glacier.partial_melt",!0),e.get(eu.IdentityTrait)?.name?.toLowerCase().includes("torch")){let n=e.get(eu.LightSourceTrait);n&&(n.isLit=!1)}t.world.setStateValue("dungeo.player.dead",!0),t.world.setStateValue("dungeo.player.death_cause","glacier_melt")},blocked(t,e){return[t.event("action.blocked",{actionId:Eo,messageId:e.error||nc.NOTHING,reason:e.error})]},report(t){return t.sharedData.noFlame?[t.event("game.message",{messageId:nc.NO_FLAME,instrument:t.sharedData.instrumentName})]:t.sharedData.death?[t.event("if.event.player.died",{messageId:nc.DEATH,cause:"glacier_melt"})]:[]}};var _d="dungeo.action.room",bd="dungeo.action.rname",ic="dungeo.action.objects",_L={NO_OBJECTS:"dungeo.room_info.no_objects"};var lV=_(E());var uV={id:_d,group:"observation",validate(t){return{valid:!0}},execute(t){},blocked(t,e){return[t.event("action.blocked",{actionId:this.id,messageId:e.error,reason:e.error,params:e.params||{}})]},report(t){let e=[],{world:r,player:n}=t,i=r.getContainingRoom(n.id);if(!i)return e;let o=i.get(lV.TraitType.ROOM),a=i.description||"You see nothing special.";return e.push(t.event("if.event.room.description",{roomId:i.id,roomName:i.name,description:a,isVisited:o?.visited||!1})),e}};var mV={id:bd,group:"observation",validate(t){return{valid:!0}},execute(t){},blocked(t,e){return[t.event("action.blocked",{actionId:this.id,messageId:e.error,reason:e.error,params:e.params||{}})]},report(t){let e=[],{world:r,player:n}=t,i=r.getContainingRoom(n.id);return i&&e.push(t.event("dungeo.event.rname",{roomId:i.id,roomName:i.name})),e}};var cp=_(E());var pV={id:ic,group:"observation",validate(t){return{valid:!0}},execute(t){},blocked(t,e){return[t.event("action.blocked",{actionId:this.id,messageId:e.error,reason:e.error,params:e.params||{}})]},report(t){let e=[],{world:r,player:n}=t,i=r.getContainingRoom(n.id);if(!i)return e;let o=r.getContents(i.id),a=[],s=[];for(let c of o)if(c.id!==n.id&&!c.hasTrait(cp.TraitType.SCENERY)){if(c.hasTrait("npc")){let d=c.get("npc");if(d&&d.state==="DISABLED")continue}if(a.push({id:c.id,name:c.name,description:c.description}),c.hasTrait(cp.TraitType.CONTAINER)&&c.get(cp.TraitType.OPENABLE)?.isOpen){let u=r.getContents(c.id);if(u.length>0){let m=u.map(f=>({id:f.id,name:f.name}));s.push({containerId:c.id,containerName:c.name,preposition:"in",items:m})}}if(c.hasTrait(cp.TraitType.SUPPORTER)){let d=r.getContents(c.id);if(d.length>0){let u=d.map(m=>({id:m.id,name:m.name}));s.push({containerId:c.id,containerName:c.name,preposition:"on",items:u})}}}return e.push(t.event("dungeo.event.objects",{roomId:i.id,items:a,containerContents:s,hasItems:a.length>0})),e}};var fV=[uV,mV,pV];var gV=[...zG,...e1,...o1,$N,...c1,eD,rD,nD,oD,cD,xD,WD,UD,zD,KD,$D,vF,_F,QD,XD,OF,AF,RF,ZD,wF,NF,DF,MF,PF,kF,j1,iL,WF,aL,KF,QF,UF,lL,JF,eV,tV,rV,nV,iV,hL,TL,mL,EL,vL,dV,...fV];var Nt=_(E()),bL={MIRROR_RUBBED:"dungeo.mirror_room.rubbed",ROOM_SHAKES:"dungeo.mirror_room.shakes"},IL="dungeo.mirror_room.state";function ose(t){return t.getStateValue(IL)==="B"?"B":"A"}function ase(t,e){let r=t==="A"?"B":"A",n=[];n.push({type:"set_state",key:IL,value:r});let i=r==="A"?e.stateA:e.stateB;return n.push({type:"update_exits",roomId:e.mirrorRoomId,exits:{[Nt.Direction.NORTH]:{destination:i.north},[Nt.Direction.WEST]:{destination:i.west},[Nt.Direction.EAST]:{destination:i.east}}}),r==="A"?(n.push({type:"update_exits",roomId:e.stateA.north,exits:{[Nt.Direction.SOUTHWEST]:{destination:e.mirrorRoomId}}}),n.push({type:"update_exits",roomId:e.stateA.west,exits:{[Nt.Direction.EAST]:{destination:e.mirrorRoomId}}}),n.push({type:"update_exits",roomId:e.stateA.east,exits:{[Nt.Direction.WEST]:{destination:e.mirrorRoomId}}}),n.push({type:"update_exits",roomId:e.stateB.north,exits:{[Nt.Direction.SOUTH]:null}}),n.push({type:"update_exits",roomId:e.stateB.west,exits:{[Nt.Direction.EAST]:null}}),n.push({type:"update_exits",roomId:e.stateB.east,exits:{[Nt.Direction.NORTH]:null}})):(n.push({type:"update_exits",roomId:e.stateB.north,exits:{[Nt.Direction.SOUTH]:{destination:e.mirrorRoomId}}}),n.push({type:"update_exits",roomId:e.stateB.west,exits:{[Nt.Direction.EAST]:{destination:e.mirrorRoomId}}}),n.push({type:"update_exits",roomId:e.stateB.east,exits:{[Nt.Direction.NORTH]:{destination:e.mirrorRoomId}}}),n.push({type:"update_exits",roomId:e.stateA.north,exits:{[Nt.Direction.SOUTHWEST]:null}}),n.push({type:"update_exits",roomId:e.stateA.west,exits:{[Nt.Direction.EAST]:null}}),n.push({type:"update_exits",roomId:e.stateA.east,exits:{[Nt.Direction.WEST]:null}})),n.push({type:"message",id:bL.ROOM_SHAKES,data:{newState:r}}),n}function hV(t){return(e,r)=>{let n=e.data;if(!n?.target)return[];if(n.target!==t.mirrorId)return[];let i=ose(r);return ase(i,t)}}function yV(t,e){t.setStateValue(IL,"A");let r=e.stateA;t.updateEntity(e.mirrorRoomId,n=>{let i=n.get("room");i&&(i.exits||(i.exits={}),i.exits[Nt.Direction.NORTH]={destination:r.north},i.exits[Nt.Direction.WEST]={destination:r.west},i.exits[Nt.Direction.EAST]={destination:r.east})})}var oe=_(E());var sse=0;function cse(){return`evt-${Date.now()}-${++sse}`}function Q_(t,e,r,n=[]){let i=t.createEntity(e,oe.EntityType.ROOM);return i.add(new oe.RoomTrait({exits:{},isDark:!1,isOutdoors:!0})),i.add(new oe.IdentityTrait({name:e,aliases:n,description:r,properName:!0,article:""})),i}function X_(t,e){let r=t.get(oe.RoomTrait);if(r)for(let[n,i]of Object.entries(e))r.exits[n]={destination:i}}function TV(t){let e=Q_(t,"West of House","This is an open field west of a white house with a boarded front door.",["west of house","field","open field"]),r=Q_(t,"North of House","You are facing the north side of a white house. There is no door here, and all the windows are barred.",["north of house","north side"]),n=Q_(t,"South of House","You are facing the south side of a white house. There is no door here, and all the windows are barred.",["south of house","south side"]),i=Q_(t,"Behind House","You are behind the white house. In one corner of the house there is a small window which is slightly ajar.",["behind house","back of house","east of house"]),o={westOfHouse:e.id,northOfHouse:r.id,southOfHouse:n.id,behindHouse:i.id};return dse(t,o),o}function dse(t,e){let r=t.getEntity(e.westOfHouse);r&&X_(r,{[oe.Direction.NORTH]:e.northOfHouse,[oe.Direction.SOUTH]:e.southOfHouse});let n=t.getEntity(e.northOfHouse);n&&X_(n,{[oe.Direction.WEST]:e.westOfHouse,[oe.Direction.EAST]:e.behindHouse});let i=t.getEntity(e.southOfHouse);i&&X_(i,{[oe.Direction.WEST]:e.westOfHouse,[oe.Direction.EAST]:e.behindHouse});let o=t.getEntity(e.behindHouse);o&&X_(o,{[oe.Direction.NORTH]:e.northOfHouse,[oe.Direction.SOUTH]:e.southOfHouse})}function EV(t,e,r){let n=lse(t),i=use(t);t.moveEntity(n.id,e.westOfHouse);let o=n.get(oe.OpenableTrait);o&&(o.isOpen=!0,t.moveEntity(i.id,n.id),o.isOpen=!1);let a=mse(t);t.moveEntity(a.id,e.westOfHouse);let s=fse(t);t.moveEntity(s.id,e.westOfHouse);let c=pse(t);if(t.moveEntity(c.id,e.behindHouse),r){let d=t.getEntity(e.behindHouse),u=t.getEntity(r);d&&u&&(oe.RoomBehavior.setExit(d,oe.Direction.WEST,r,c.id),oe.RoomBehavior.setExit(d,oe.Direction.IN,r,c.id),oe.RoomBehavior.setExit(u,oe.Direction.EAST,e.behindHouse,c.id))}gse(t,e)}function lse(t){let e=t.createEntity("small mailbox",oe.EntityType.CONTAINER);return e.add(new oe.IdentityTrait({name:"small mailbox",aliases:["mailbox","box","mail box"],description:"It's a small mailbox.",properName:!1,article:"a"})),e.add(new oe.ContainerTrait({capacity:{maxItems:5}})),e.add(new oe.OpenableTrait({isOpen:!1})),e.add(new oe.SceneryTrait),e}function use(t){let e=t.createEntity("leaflet",oe.EntityType.ITEM);return e.add(new oe.IdentityTrait({name:"leaflet",aliases:["paper","pamphlet","advertisement","ad"],description:"A small leaflet with some writing on it.",properName:!1,article:"a",weight:2})),e.add(new oe.ReadableTrait({text:`                         WELCOME TO DUNGEON

      DUNGEON is a game of adventure, danger, and low cunning.  In it you
  will explore some of the most amazing territory ever seen by mortal
  man.  Hardened adventurers have run screaming from the terrors
  contained within!

      In DUNGEON the intrepid explorer delves into the forgotten secrets
  of a lost labyrinth deep in the bowels of the earth, searching for
  vast treasures long hidden from prying eyes, treasures guarded by
  fearsome monsters and diabolical traps!

      No system should be without one!

      DUNGEON was created at the MIT Laboratory for Computer Science, by
  Tim Anderson, Marc Blank, Bruce Daniels, and Dave Lebling.  It was
  inspired by the ADVENTURE game of Crowther and Woods, and the long
  tradition of fantasy and science fiction adventure.  DUNGEON is written
  in Sharpee. This version was translated from the paranoid
  FORTRAN implementation by a DEC engineer to Sharpee by a less paranoid
  developer, David Cornelson.

      In-game information may be available using the HELP and INFO
  commands.`,isReadable:!0})),e}function mse(t){let e=t.createEntity("front door",oe.EntityType.SCENERY);return e.add(new oe.IdentityTrait({name:"front door",aliases:["door","boarded door","entrance"],description:"The door is boarded and you can't remove the boards.",properName:!1,article:"the"})),e.add(new oe.SceneryTrait),e}function pse(t){let e=t.createEntity("window",oe.EntityType.SCENERY);return e.add(new oe.IdentityTrait({name:"window",aliases:["small window","kitchen window"],description:"The window is slightly ajar, but not enough to allow entry.",properName:!1,article:"the"})),e.add(new oe.SceneryTrait),e.add(new oe.OpenableTrait({isOpen:!1})),e.on={"if.event.opened":r=>{let n=e.get(oe.IdentityTrait);return n&&(n.description="The window is open."),[{id:cse(),type:"game.message",entities:{actor:r.entities.actor,target:e.id},data:{messageId:"dungeo.window.opened"},timestamp:Date.now(),narrate:!0}]},"if.event.closed":r=>{let n=e.get(oe.IdentityTrait);return n&&(n.description="The window is slightly ajar, but not enough to allow entry."),[]}},e}function fse(t){let e=t.createEntity("welcome mat",oe.EntityType.ITEM);return e.add(new oe.IdentityTrait({name:"welcome mat",aliases:["mat","rubber mat"],description:'A rubber mat saying "Welcome to Dungeon!"',properName:!1,article:"a",weight:5})),e.add(new ba({isUnderDoor:!1})),e}function gse(t,e){let r=[e.westOfHouse,e.northOfHouse,e.southOfHouse,e.behindHouse];for(let n of r){let i=t.createEntity("white house",oe.EntityType.SCENERY);i.add(new oe.IdentityTrait({name:"white house",aliases:["house","building"],description:"The house is a beautiful colonial house which is painted white. It is clear that the owners must have been extremely wealthy.",properName:!1,article:"the"})),i.add(new oe.SceneryTrait),t.moveEntity(i.id,n)}}var W=_(E());var hse=0;function vV(){return`evt-${Date.now()}-${++hse}`}function OL(t,e,r,n=!1){let i=t.createEntity(e,W.EntityType.ROOM);return i.add(new W.RoomTrait({exits:{},isDark:n,isOutdoors:!1})),i.add(new W.IdentityTrait({name:e,description:r,properName:!0,article:"the"})),i}function SL(t,e){let r=t.get(W.RoomTrait);if(r)for(let[n,i]of Object.entries(e))r.exits[n]={destination:i}}function _V(t){let e=OL(t,"Kitchen","This is the kitchen of the white house. A table seems to have been used recently for the preparation of food. A passage leads to the west, and a dark staircase can be seen leading upward. To the east is a small window which is open."),r=OL(t,"Living Room","This is the living room. There is a door to the east. To the west is a wooden door with strange gothic lettering, which appears to be nailed shut."),n=OL(t,"Attic","This is the attic. The only exit is stairs that lead down.",!0);return SL(e,{[W.Direction.WEST]:r.id,[W.Direction.UP]:n.id}),SL(r,{[W.Direction.EAST]:e.id}),SL(n,{[W.Direction.DOWN]:e.id}),{kitchen:e.id,livingRoom:r.id,attic:n.id}}function bV(t,e,r){yse(t,e.kitchen),Tse(t,e.livingRoom,r),Ese(t,e.attic)}function yse(t,e){let r=t.createEntity("kitchen table",W.EntityType.SCENERY);r.add(new W.IdentityTrait({name:"kitchen table",aliases:["table","wooden table"],description:"A sturdy wooden table used for food preparation.",properName:!1,article:"a"})),r.add(new W.SceneryTrait),t.moveEntity(r.id,e);let n=t.createEntity("brown sack",W.EntityType.CONTAINER);n.add(new W.IdentityTrait({name:"elongated brown sack",aliases:["sack","brown sack","bag","brown bag"],description:"A brown sack smelling of hot peppers.",properName:!1,article:"an",weight:5})),n.add(new W.ContainerTrait({capacity:{maxItems:10}})),n.add(new W.OpenableTrait({isOpen:!0})),t.moveEntity(n.id,e);let i=t.createEntity("lunch",W.EntityType.ITEM);i.add(new W.IdentityTrait({name:"lunch",aliases:["food","meal","provisions"],description:"A hearty lunch.",properName:!1,article:"a",weight:5})),t.moveEntity(i.id,n.id);let o=t.createEntity("garlic",W.EntityType.ITEM);o.add(new W.IdentityTrait({name:"clove of garlic",aliases:["garlic","clove"],description:"A clove of garlic. Its strong smell might ward off something...",properName:!1,article:"a",weight:3})),t.moveEntity(o.id,n.id);let a=t.createEntity("glass bottle",W.EntityType.CONTAINER);a.add(new W.IdentityTrait({name:"glass bottle",aliases:["bottle","clear bottle","water bottle"],description:"A clear glass bottle containing water.",properName:!1,article:"a",weight:5})),a.add(new W.ContainerTrait({capacity:{maxItems:1}})),a.add(new W.OpenableTrait({isOpen:!1})),t.moveEntity(a.id,e);let s=t.createEntity("water",W.EntityType.ITEM);s.add(new W.IdentityTrait({name:"quantity of water",aliases:["water"],description:"Clear, fresh water.",properName:!1,article:"a"}));let c=a.get(W.OpenableTrait);c&&(c.isOpen=!0,t.moveEntity(s.id,a.id),c.isOpen=!1)}function Tse(t,e,r){let n=t.createEntity("trophy case",W.EntityType.CONTAINER);n.add(new W.IdentityTrait({name:"trophy case",aliases:["case","glass case","display case"],description:"A handsome trophy case with a glass front.",properName:!1,article:"a"})),n.add(new W.ContainerTrait({capacity:{maxItems:40}})),n.add(new W.OpenableTrait({isOpen:!1})),n.add(new W.SceneryTrait),n.add(new Ds),t.moveEntity(n.id,e);let i=t.createEntity("elvish sword",W.EntityType.ITEM);i.add(new W.IdentityTrait({name:"elvish sword",aliases:["sword","elvish blade","blade","antique sword"],description:"An elvish sword of great antiquity. Its blade glows faintly blue.",properName:!1,article:"an",weight:10})),i.add(new W.WeaponTrait({damage:3,skillBonus:10,weaponType:"blade"})),t.moveEntity(i.id,e);let o=t.createEntity("brass lantern",W.EntityType.ITEM);o.add(new W.IdentityTrait({name:"brass lantern",aliases:["lantern","lamp","light","brass lamp"],description:"A battery-powered brass lantern.",properName:!1,article:"a",weight:5})),o.add(new W.LightSourceTrait({isLit:!1,brightness:3,fuelRemaining:330,maxFuel:330,fuelConsumptionRate:1})),o.add(new W.SwitchableTrait({isOn:!1})),t.moveEntity(o.id,e);let a=t.createEntity("trap door",W.EntityType.SCENERY);a.add(new W.IdentityTrait({name:"trap door",aliases:["trapdoor","door"],adjectives:["trap"],description:"The dusty cover of a closed trap door.",properName:!1,article:"a"})),a.add(new W.OpenableTrait({isOpen:!1})),a.add(new W.SceneryTrait),a.on={"if.event.opened":d=>{let u=a.get(W.IdentityTrait);return u&&(u.description="The trap door is open, revealing a rickety staircase descending into darkness."),[{id:vV(),type:"game.message",entities:{actor:d.entities.actor,target:a.id},data:{messageId:"dungeo.trapdoor.opened"},timestamp:Date.now(),narrate:!0}]},"if.event.closed":d=>{let u=a.get(W.IdentityTrait);return u&&(u.description="The dusty cover of a closed trap door."),[]}};let s=t.createEntity("oriental rug",W.EntityType.SCENERY);s.add(new W.IdentityTrait({name:"large oriental rug",aliases:["rug","oriental rug","carpet","large rug"],description:"A large oriental rug in the center of the room.",properName:!1,article:"a"})),s.add(new W.SceneryTrait),s.add(new W.PushableTrait({pushType:"moveable",repeatable:!1,state:"default"})),s.on={"if.event.pushed":d=>{let u=s.get(W.PushableTrait);if(u&&u.state==="pushed")return[];if(t.moveEntity(a.id,e),r){let m=t.getEntity(e);m&&W.RoomBehavior.setExit(m,W.Direction.DOWN,r,a.id);let f=t.getEntity(r);f&&W.RoomBehavior.setExit(f,W.Direction.UP,e,a.id)}return u&&(u.state="pushed"),[{id:vV(),type:"game.message",entities:{actor:d.entities.actor,target:a.id,location:e},data:{messageId:"dungeo.rug.moved.reveal_trapdoor"},timestamp:Date.now(),narrate:!0}]}},t.moveEntity(s.id,e);let c=t.createEntity("wooden door",W.EntityType.SCENERY);c.add(new W.IdentityTrait({name:"wooden door",aliases:["door","west door","gothic door"],description:"A wooden door with strange gothic lettering. It appears to be nailed shut.",properName:!1,article:"a"})),c.add(new W.SceneryTrait),t.moveEntity(c.id,e)}function Ese(t,e){let r=t.createEntity("attic table",W.EntityType.SCENERY);r.add(new W.IdentityTrait({name:"table",aliases:["table","small table"],description:"A small table in the corner of the attic.",properName:!1,article:"a"})),r.add(new W.SceneryTrait),t.moveEntity(r.id,e);let n=t.createEntity("rope",W.EntityType.ITEM);n.add(new W.IdentityTrait({name:"large coil of rope",aliases:["rope","coil","coil of rope"],description:"A large coil of sturdy rope.",brief:"A large coil of rope is lying in the corner.",properName:!1,article:"a",weight:5})),t.moveEntity(n.id,e);let i=t.createEntity("nasty knife",W.EntityType.ITEM);i.add(new W.IdentityTrait({name:"nasty knife",aliases:["knife","nasty-looking knife","blade"],description:"A nasty-looking knife. It appears quite sharp.",brief:"On a table is a nasty-looking knife.",properName:!1,article:"a",weight:4})),i.add(new W.WeaponTrait({damage:2,skillBonus:5,weaponType:"blade"})),t.moveEntity(i.id,e);let o=t.createEntity("brick",W.EntityType.ITEM);o.add(new W.IdentityTrait({name:"brick",aliases:["red brick","clay brick","explosive"],description:"A square brick of calciumite with some fuse wire wrapped around it.",brief:"There is a square brick here which feels like clay.",properName:!1,article:"a",weight:5})),o.attributes.isExplosive=!0,o.attributes.fuseAttached=!0,t.moveEntity(o.id,e);let a=t.createEntity("shiny wire",W.EntityType.ITEM);a.add(new W.IdentityTrait({name:"shiny wire",aliases:["wire","thin wire","metal wire","fuse wire"],adjectives:["shiny"],description:"A thin piece of shiny wire, suitable as a fuse or for various mechanical uses.",properName:!1,article:"a",weight:5})),a.add(new ye({burnableType:"fuse",isBurning:!1,burnedOut:!1})),t.moveEntity(a.id,e)}var V=_(E());function Z_(t,e,r){let n=t.createEntity(e,V.EntityType.ROOM);return n.add(new V.RoomTrait({exits:{},isDark:!1,isOutdoors:!0})),n.add(new V.IdentityTrait({name:e,description:r,properName:!0,article:""})),n}function Ua(t,e){let r=t.get(V.RoomTrait);if(r)for(let[n,i]of Object.entries(e))r.exits[n]={destination:i}}function IV(t){let e=t.createEntity("Forest-Path-1",V.EntityType.ROOM);e.add(new V.RoomTrait({exits:{},isDark:!1,isOutdoors:!0})),e.add(new V.IdentityTrait({name:"Forest Path",aliases:["forest path","path","forest path 1"],description:"This is a path winding through a dimly lit forest. The path heads north-south here. One particularly large tree with some low branches stands at the side of the path.",properName:!0,article:""}));let r=t.createEntity("Forest-2",V.EntityType.ROOM);r.add(new V.RoomTrait({exits:{},isDark:!1,isOutdoors:!0})),r.add(new V.IdentityTrait({name:"Forest",aliases:["forest","woods","trees"],description:"This is a dimly lit forest, with large trees all around.",properName:!0,article:"the"}));let n=t.createEntity("Forest Path-3",V.EntityType.ROOM);n.add(new V.RoomTrait({exits:{},isDark:!1,isOutdoors:!0})),n.add(new V.IdentityTrait({name:"Forest Path",aliases:["forest path","path"],description:"The forest thins out, and the path becomes clearer.",properName:!0,article:""}));let i=t.createEntity("Twisting Path",V.EntityType.ROOM);i.add(new V.RoomTrait({exits:{},isDark:!1,isOutdoors:!0})),i.add(new V.IdentityTrait({name:"Twisting Path",aliases:["twisting path","path","forest path"],description:"You are on a twisting path through a dense forest. The path splits here.",properName:!0,article:""}));let o=t.createEntity("Clearing",V.EntityType.ROOM);o.add(new V.RoomTrait({exits:{},isDark:!1,isOutdoors:!0})),o.add(new V.IdentityTrait({name:"Clearing",aliases:["clearing","forest clearing"],description:"You are in a clearing, with a forest surrounding you on all sides. A path leads south. On the ground is a pile of leaves.",properName:!0,article:"the"}));let a=Z_(t,"Up a Tree","You are about ten feet above the ground nestled among some large branches. The nearest branch above you is beyond your reach. On one of the branches is a small bird's nest."),s=Z_(t,"Canyon View","You are at the top of the Great Canyon, on its west wall. From here there is a marvelous view of the canyon and parts of the Frigid River upstream. Across the canyon, the walls of the White Cliffs join the mighty ramparts of the Flathead Mountains to the east. Following the Canyon, you can see a small path at the bottom of the canyon. There is a path here which goes west into the forest."),c=Z_(t,"Rocky Ledge","You are on a ledge about halfway up the wall of the river canyon. You can see from here that the path continues from the bottom of the canyon up to the cliff above. There is a small path going down."),d=Z_(t,"Canyon Bottom","You are beneath the walls of the river canyon which may be climbed here. The canyon runs north-south along the river. You can see the massive walls of the White Cliffs rising to the east.");return Ua(e,{[V.Direction.NORTH]:o.id,[V.Direction.UP]:a.id}),Ua(r,{[V.Direction.WEST]:o.id,[V.Direction.EAST]:n.id}),Ua(n,{[V.Direction.WEST]:r.id,[V.Direction.SOUTH]:i.id,[V.Direction.EAST]:s.id}),Ua(i,{[V.Direction.NORTH]:n.id}),Ua(o,{[V.Direction.SOUTH]:e.id,[V.Direction.EAST]:r.id}),Ua(a,{[V.Direction.DOWN]:e.id}),Ua(s,{[V.Direction.WEST]:n.id,[V.Direction.DOWN]:c.id}),Ua(c,{[V.Direction.UP]:s.id,[V.Direction.DOWN]:d.id}),Ua(d,{[V.Direction.UP]:c.id}),{forestPath1:e.id,forestPath2:r.id,forestPath3:n.id,forestPath4:i.id,clearing:o.id,upATree:a.id,canyonView:s.id,rockyLedge:c.id,canyonBottom:d.id}}function OV(t,e,r,n){let i=t.getEntity(e.forestPath1);i&&(i.get(V.RoomTrait).exits[V.Direction.SOUTH]={destination:r});let o=t.getEntity(r);o&&(o.get(V.RoomTrait).exits[V.Direction.NORTH]={destination:e.forestPath1});let a=t.getEntity(n);a&&(a.get(V.RoomTrait).exits[V.Direction.EAST]={destination:e.clearing})}function SV(t,e){vse(t,e.forestPath1),_se(t,e.clearing),bse(t,e.upATree)}function vse(t,e){let r=t.createEntity("large tree",V.EntityType.SCENERY);r.add(new V.IdentityTrait({name:"large tree",aliases:["tree","big tree","tall tree"],description:"A particularly large tree with some low branches. It looks climbable.",properName:!1,article:"a"})),r.add(new V.SceneryTrait),t.moveEntity(r.id,e)}function _se(t,e){let r=t.createEntity("pile of leaves",V.EntityType.SCENERY);r.add(new V.IdentityTrait({name:"pile of leaves",aliases:["leaves","pile","leaf pile"],description:"A large pile of dead leaves. They rustle in the wind.",properName:!1,article:"a"})),r.add(new V.SceneryTrait),t.moveEntity(r.id,e);let n=t.createEntity("grating",V.EntityType.SCENERY);n.add(new V.IdentityTrait({name:"grating",aliases:["grate","iron grating","metal grating"],description:"A grating firmly fixed into the ground. It appears to lead underground.",properName:!1,article:"a"})),n.add(new V.OpenableTrait({isOpen:!1})),n.add(new V.SceneryTrait),t.moveEntity(n.id,e)}function bse(t,e){let r=t.createEntity("nest",V.EntityType.CONTAINER);r.add(new V.IdentityTrait({name:"small bird's nest",aliases:["nest","bird nest","birds nest"],description:"A small bird's nest tucked among the branches.",properName:!1,article:"a"})),r.add(new V.ContainerTrait({capacity:{maxItems:3}})),r.add(new V.SceneryTrait),t.moveEntity(r.id,e);let n=t.createEntity("jewel-encrusted egg",V.EntityType.CONTAINER);n.add(new V.IdentityTrait({name:"jewel-encrusted egg",aliases:["egg","jeweled egg","beautiful egg","faberge egg"],description:"A beautiful jewel-encrusted egg. It appears to open somehow.",properName:!1,article:"a",weight:2,points:5})),n.add(new V.ContainerTrait({capacity:{maxItems:1}})),n.add(new V.OpenableTrait({isOpen:!1})),n.add(new _n),n.add(new z({trophyCaseValue:5})),t.moveEntity(n.id,r.id);let i=t.createEntity("golden canary",V.EntityType.ITEM);i.add(new V.IdentityTrait({name:"golden clockwork canary",aliases:["canary","bird","clockwork canary","golden bird"],description:"A beautiful golden clockwork canary. It sings when wound.",properName:!1,article:"a",weight:10,points:6})),i.add(new z({trophyCaseValue:2}));let o=n.get(V.OpenableTrait);o&&(o.isOpen=!0,t.moveEntity(i.id,n.id),o.isOpen=!1)}var M=_(E());var J_=_(zi()),dp=_(E());var ct={RECOVERS_AXE:"dungeo.troll.recovers_axe",COWERS:"dungeo.troll.cowers",CATCHES_ITEM:"dungeo.troll.catches_item",EATS_ITEM:"dungeo.troll.eats_item",THROWS_KNIFE_BACK:"dungeo.troll.throws_knife_back",SPITS_AT_PLAYER:"dungeo.troll.spits_at_player",MOCKS_UNARMED_ATTACK:"dungeo.troll.mocks_unarmed_attack",CANT_HEAR_YOU:"dungeo.troll.cant_hear_you",KNOCKED_OUT:"dungeo.troll.knocked_out",KILL_UNCONSCIOUS:"dungeo.troll.kill_unconscious",SMOKE_DISAPPEAR:"dungeo.troll.smoke_disappear",DEATH_PASSAGE_CLEAR:"dungeo.troll.death.passage_clear"};function Ise(t){return t.npcInventory.some(r=>r.has&&r.has(dp.TraitType.WEAPON))}function Ose(t){let e=t.getEntitiesInRoom();for(let r of e){if(!r.get)continue;let n=r.get(dp.IdentityTrait);if(!n)continue;let i=n.name?.toLowerCase()||"",o=n.aliases||[];if([i,...o.map(s=>s.toLowerCase())].some(s=>s.includes("axe"))&&t.world.getLocation(r.id)===t.npcLocation)return r.id}return null}var AL={id:"troll",name:"Troll Behavior",onTurn(t){let e=t.npc.get(dp.TraitType.COMBATANT);if(e&&(!e.isAlive||!e.isConscious))return[];if(!Ise(t)){let n=Ose(t);return n&&t.random.chance(.75)?[{type:"take",target:n},{type:"emote",messageId:ct.RECOVERS_AXE,data:{npcName:t.npc.name}}]:[{type:"emote",messageId:ct.COWERS,data:{npcName:t.npc.name}}]}return J_.guardBehavior.onTurn(t)},onPlayerEnters(t){return J_.guardBehavior.onPlayerEnters?.(t)||[]},onAttacked(t,e){return J_.guardBehavior.onAttacked?.(t,e)||[]},getState(t){return{}},setState(t,e){}};function AV(t){t.registerBehavior(AL)}function Jr(t,e,r,n=!0){let i=t.createEntity(e,M.EntityType.ROOM);return i.add(new M.RoomTrait({exits:{},isDark:n,isOutdoors:!1})),i.add(new M.IdentityTrait({name:e,description:r,properName:!0,article:"the"})),i}function Cn(t,e){let r=t.get(M.RoomTrait);if(r)for(let[n,i]of Object.entries(e))r.exits[n]={destination:i}}function RV(t){let e=Jr(t,"Cellar","This is a dark and damp cellar with a narrow passageway leading east, and a crawlway to the south. To the west is the bottom of a steep metal ramp which is unclimbable."),r=Jr(t,"West of Chasm","You are on the west edge of a chasm, the walls of which are too steep to climb. A passage leads north."),n=Jr(t,"Gallery","This is an art gallery. Most of the paintings have been stolen by vandals with exceptional taste. The vandals left through either the north or west exits."),i=Jr(t,"North/South Crawlway","This is a north-south crawlway; a passage also goes to the east. There is a hole above, but it provides no opportunities for climbing."),o=Jr(t,"Troll Room","This is a small room with passages off in all directions. Bloodstains and deep scratches (perhaps made by an axe) mar the walls."),a=Jr(t,"East-West Passage","This is a narrow east-west passageway. There is a narrow stairway leading down at the north end of the room."),s=Jr(t,"Deep Ravine","You are in a deep ravine at a point where a crack opens to the east. A passage leads south, and a steep trail leads down."),c=Jr(t,"Rocky Crawl","This is a crawlway with a low ceiling. A passage goes to the east, and a narrow opening leads west."),d=Jr(t,"Dome Room","This is the periphery of a large dome, which forms the ceiling of another room below. Protecting you from a precipitous drop is a wooden railing which circles the dome."),u=Jr(t,"Tiny Room","This is a tiny room with passages leading east and west."),m=Jr(t,"Dreary Room","This is a dreary room with passages leading north and east."),f=Jr(t,"Chasm","A chasm runs southwest to northeast. You are on the east edge."),g=Jr(t,"Studio","This is what appears to have been an artist's studio. The walls and floors are splattered with paints of 69 different colors. Strangely enough, nothing of value is hanging here. At the north and northwest of the room are open doors (also covered with paint). An extremely dark and narrow chimney leads up from a fireplace; although you might be able to get up it, it seems unlikely you could get back down."),h=Jr(t,"Torch Room","This is a large room with a prominent doorway leading to a down staircase. To the west is a narrow twisting tunnel, covered with a thin layer of dust. Above you is a large dome painted with scenes depicting elfin hacking rites. Up around the edge of the dome (20 feet up) is a wooden railing. In the center of the room there is a white marble pedestal.");return d.add(new Oa({ropeAttached:!1,hasRailing:!0,torchRoomId:h.id})),Cn(e,{[M.Direction.EAST]:o.id}),Cn(o,{[M.Direction.WEST]:e.id,[M.Direction.NORTH]:a.id,[M.Direction.EAST]:i.id}),M.RoomBehavior.blockExit(o,M.Direction.NORTH,"The troll blocks your way."),Cn(a,{[M.Direction.WEST]:o.id,[M.Direction.NORTH]:s.id,[M.Direction.DOWN]:s.id}),Cn(i,{[M.Direction.EAST]:o.id,[M.Direction.SOUTH]:g.id,[M.Direction.UP]:h.id}),Cn(g,{[M.Direction.NORTHWEST]:n.id,[M.Direction.NORTH]:i.id}),Cn(n,{[M.Direction.SOUTH]:g.id}),Cn(s,{[M.Direction.SOUTH]:a.id,[M.Direction.WEST]:c.id,[M.Direction.EAST]:f.id}),Cn(f,{[M.Direction.SOUTH]:s.id}),Cn(c,{[M.Direction.WEST]:s.id,[M.Direction.EAST]:d.id}),Cn(d,{[M.Direction.EAST]:c.id}),Cn(h,{[M.Direction.UP]:d.id,[M.Direction.DOWN]:i.id,[M.Direction.WEST]:u.id}),Cn(u,{[M.Direction.EAST]:h.id,[M.Direction.NORTH]:m.id}),Cn(m,{[M.Direction.SOUTH]:u.id}),{cellar:e.id,westOfChasm:r.id,gallery:n.id,northSouthCrawlway:i.id,trollRoom:o.id,eastWestPassage:a.id,deepRavine:s.id,rockyCrawl:c.id,domeRoom:d.id,tinyRoom:u.id,drearyRoom:m.id,chasm:f.id,studio:g.id,torchRoom:h.id}}function CV(t,e,r){let n=t.getEntity(e.studio);if(n){let i=n.get(M.RoomTrait);i&&(i.exits[M.Direction.UP]={destination:r})}}var Sse=0;function tu(){return`evt-${Date.now()}-${++Sse}`}function wV(t,e){Ase(t,e.cellar),Nse(t,e.trollRoom),Dse(t,e.gallery),Lse(t,e.studio),Mse(t,e.domeRoom),Pse(t,e.torchRoom),kse(t,e.tinyRoom,e.drearyRoom),Bse(t,e.drearyRoom)}function Ase(t,e){let r=t.createEntity("metal ramp",M.EntityType.SCENERY);r.add(new M.IdentityTrait({name:"steep metal ramp",aliases:["ramp","metal ramp","steep ramp"],description:"A steep metal ramp leading up. It's too slippery to climb.",properName:!1,article:"a"})),r.add(new M.SceneryTrait),t.moveEntity(r.id,e)}var Rse="A nasty-looking troll stands here, wielding a bloody axe. He blocks the northern passage.",Cse="An unconscious troll is sprawled on the floor. All passages out of the room are open.",wse=4;function Nse(t,e){let r=t.createEntity("bloody axe",M.EntityType.ITEM);r.add(new M.IdentityTrait({name:"bloody axe",aliases:["axe","troll axe","bloody weapon"],description:"A large, bloody axe. It looks like it has seen plenty of use.",properName:!1,article:"a",weight:25})),r.add(new M.WeaponTrait({damage:5,weaponType:"blade",attackMessage:"The troll swings the bloody axe viciously!"}));let n=t.createEntity("troll",M.EntityType.ACTOR);n.add(new M.IdentityTrait({name:"nasty-looking troll",aliases:["troll","nasty troll","ugly troll"],description:Rse,properName:!1,article:"a"})),n.add(new M.ActorTrait({isPlayer:!1})),n.add(new M.NpcTrait({behaviorId:"troll",isHostile:!0,canMove:!1})),n.add(new M.CombatantTrait({health:10,maxHealth:10,skill:40,baseDamage:5,armor:0,hostile:!0,canRetaliate:!0,dropsInventory:!0,deathMessage:"The troll lets out a final grunt and collapses!"})),n.add(new vn({roomId:e,axeId:r.id})),t.moveEntity(n.id,e),r.add(new En({guardianId:n.id})),t.moveEntity(r.id,n.id);let i=t.getEntity(e);function o(a){if(!a)return!1;let s=a.get?.(M.IdentityTrait);if(!s)return!1;let c=s.name?.toLowerCase()||"",d=(s.aliases||[]).map(u=>u.toLowerCase());return[c,...d].some(u=>u.includes("knife")||u.includes("stiletto"))}n.on={"if.event.knocked_out":(a,s)=>{let c=[],d=n.get(M.IdentityTrait);d&&(d.description=Cse),i&&M.RoomBehavior.unblockExit(i,M.Direction.NORTH);let u=n.get(M.CombatantTrait);u&&(u.recoveryTurns=wse);let m=n.get(M.NpcTrait);return m&&(m.isConscious=!1),c},"if.event.death":(a,s)=>{let c=[];return a.data?.target!==n.id||(i&&M.RoomBehavior.unblockExit(i,M.Direction.NORTH),s.awardScore("troll-killed",10,"Defeated the troll"),c.push({id:tu(),type:"game.message",entities:{},data:{messageId:ct.SMOKE_DISAPPEAR},timestamp:Date.now(),narrate:!0}),t.removeEntity(r.id),t.removeEntity(n.id)),c},"if.event.given":(a,s)=>{let c=[],d=a.data;if(d.recipient!==n.id)return c;let u=s.getEntity(d.item);return u&&(o(u)?(t.moveEntity(u.id,e),c.push({id:tu(),type:"game.message",entities:{target:n.id,instrument:u.id},data:{messageId:ct.THROWS_KNIFE_BACK,itemName:u.name},timestamp:Date.now(),narrate:!0})):(t.removeEntity(u.id),c.push({id:tu(),type:"game.message",entities:{target:n.id,instrument:u.id},data:{messageId:ct.EATS_ITEM,itemName:u.name},timestamp:Date.now(),narrate:!0}))),c},"if.event.thrown":(a,s)=>{let c=[],d=a.data;if(d.target!==n.id||d.throwType!=="at_target")return c;let u=s.getEntity(d.item);return u&&(c.push({id:tu(),type:"game.message",entities:{target:n.id,instrument:u.id},data:{messageId:ct.CATCHES_ITEM,itemName:u.name},timestamp:Date.now(),narrate:!0}),o(u)?(t.moveEntity(u.id,e),c.push({id:tu(),type:"game.message",entities:{target:n.id,instrument:u.id},data:{messageId:ct.THROWS_KNIFE_BACK,itemName:u.name},timestamp:Date.now(),narrate:!0})):(t.removeEntity(u.id),c.push({id:tu(),type:"game.message",entities:{target:n.id,instrument:u.id},data:{messageId:ct.EATS_ITEM,itemName:u.name},timestamp:Date.now(),narrate:!0}))),c}}}function Dse(t,e){let r=t.createEntity("painting",M.EntityType.ITEM);r.add(new M.IdentityTrait({name:"painting",aliases:["painting","picture","art","artwork","canvas"],description:"A painting of remarkable beauty, depicting a woodland scene. It is the only painting remaining in the gallery.",properName:!1,article:"a",weight:20,points:4})),r.add(new z({trophyCaseValue:7})),t.moveEntity(r.id,e)}function Lse(t,e){let r=t.createEntity("chimney",M.EntityType.SCENERY);r.add(new M.IdentityTrait({name:"chimney",aliases:["chimney","dark chimney","fireplace chimney","narrow chimney","fireplace"],description:"The chimney is very dark and narrow. You might be able to climb up it, but it seems unlikely you could get back down.",properName:!1,article:"a"})),r.add(new M.SceneryTrait),t.moveEntity(r.id,e);let n=t.createEntity("paint",M.EntityType.SCENERY);n.add(new M.IdentityTrait({name:"paint",aliases:["paint","paints","splatter","splatters","paint splatters","colors"],description:"The walls and floors are splattered with paints of 69 different colors. It looks like the work of a very messy artist.",properName:!1,article:"some"})),n.add(new M.SceneryTrait),t.moveEntity(n.id,e)}function Mse(t,e){let r=t.createEntity("railing",M.EntityType.SCENERY);r.add(new M.IdentityTrait({name:"railing",aliases:["rail","iron railing","sturdy railing"],description:"A sturdy iron railing surrounds a deep shaft in the center of the room. Looking down, you can see only darkness.",properName:!1,article:"a"})),r.add(new M.SceneryTrait),t.moveEntity(r.id,e)}function Pse(t,e){let r=t.createEntity("ivory torch",M.EntityType.ITEM);r.add(new M.IdentityTrait({name:"ivory torch",aliases:["torch","ivory","white torch"],description:"A beautiful torch of polished ivory, its flame burning brightly.",properName:!1,article:"an",weight:5,points:14})),r.add(new M.LightSourceTrait({isLit:!0,brightness:3,fuelRemaining:1e3,maxFuel:1e3,fuelConsumptionRate:0})),r.attributes.isFlame=!0,r.add(new z({trophyCaseValue:6})),t.moveEntity(r.id,e)}function kse(t,e,r){let n=t.createEntity("small door",M.EntityType.DOOR);n.add(new M.IdentityTrait({name:"small door",aliases:["door","north door","wooden door","tiny door"],description:"A small wooden door leads north. There is a keyhole at eye level.",properName:!1,article:"a"})),n.add(new M.OpenableTrait({isOpen:!1})),n.add(new M.SceneryTrait),n.add(new M.LockableTrait({isLocked:!0})),n.add(new Bt({keyInLock:!0,matUnderDoor:!1,keyOnMat:!1,connectsRooms:[e,r],blocksDirection:{[e]:"NORTH",[r]:"SOUTH"}})),t.moveEntity(n.id,e);let i=t.createEntity("small key",M.EntityType.ITEM);i.add(new M.IdentityTrait({name:"small key",aliases:["key","brass key","tiny key"],description:"A small brass key.",properName:!1,article:"a",weight:25})),i.add(new Ls({isHidden:!0})),t.moveEntity(i.id,e)}function Bse(t,e){let r=t.createEntity("blue crystal sphere",M.EntityType.ITEM);r.add(new M.IdentityTrait({name:"blue crystal sphere",aliases:["sphere","crystal sphere","blue sphere","crystal","blue crystal","ball"],adjectives:["blue"],description:"A beautiful sphere of blue crystal. It seems to glow with an inner light.",properName:!1,article:"a",weight:5,points:10})),r.add(new z({trophyCaseValue:5})),t.moveEntity(r.id,e)}var N=_(E());function Ci(t,e,r,n=!0){let i=t.createEntity(e,N.EntityType.ROOM);return i.add(new N.RoomTrait({exits:{},isDark:n,isOutdoors:!1})),i.add(new N.IdentityTrait({name:e,description:r,properName:!0,article:"the"})),i}function wi(t,e){let r=t.get(N.RoomTrait);if(r)for(let[n,i]of Object.entries(e))r.exits[n]={destination:i}}function NV(t){let e=Ci(t,"Deep Canyon","You are in a deep canyon with sheer walls rising on all sides. A narrow path leads north."),r=Ci(t,"Dam Lobby","This is a large, echoing hall. A passage leads south, and doors lead north and east."),n=Ci(t,"Flood Control Dam #3","You are standing on the top of the Flood Control Dam #3, which was quite a tourist attraction in times far distant. From here, a wide passage leads north and south."),i=Ci(t,"Dam Base","You are at the base of the dam. A stairway leads up."),o=Ci(t,"Maintenance Room","This is a small maintenance room. Various tools line the walls."),a=Ci(t,"Reservoir South","You are at the south end of a huge reservoir. The water is murky and cold."),s=Ci(t,"Reservoir","You are in the middle of a large reservoir. The water level is quite low."),c=Ci(t,"Reservoir North","You are at the north end of a large reservoir."),d=Ci(t,"Stream View","You are standing at a point where a stream emerges from underground."),u=Ci(t,"Small Cave","This is a small cave above the Atlantis Room. A stairway leads down."),m=Ci(t,"Atlantis Room","This is a large room with a vaulted ceiling. Ancient murals depicting undersea life cover the walls.");return wi(e,{[N.Direction.NORTHWEST]:a.id,[N.Direction.EAST]:n.id}),wi(r,{[N.Direction.SOUTH]:n.id,[N.Direction.NORTH]:o.id,[N.Direction.EAST]:o.id}),wi(n,{[N.Direction.SOUTH]:e.id,[N.Direction.NORTH]:r.id,[N.Direction.DOWN]:i.id}),wi(i,{[N.Direction.UP]:n.id}),wi(o,{[N.Direction.SOUTH]:r.id,[N.Direction.WEST]:r.id}),wi(a,{[N.Direction.UP]:e.id,[N.Direction.NORTH]:s.id,[N.Direction.WEST]:d.id}),wi(s,{[N.Direction.SOUTH]:a.id,[N.Direction.NORTH]:c.id}),wi(c,{[N.Direction.SOUTH]:s.id,[N.Direction.NORTH]:m.id}),wi(m,{[N.Direction.SOUTHEAST]:c.id,[N.Direction.UP]:u.id}),wi(u,{[N.Direction.DOWN]:m.id}),wi(d,{[N.Direction.EAST]:a.id}),{deepCanyon:e.id,damLobby:r.id,dam:n.id,damBase:i.id,maintenanceRoom:o.id,reservoirSouth:a.id,reservoir:s.id,reservoirNorth:c.id,streamView:d.id,smallCave:u.id,atlantisRoom:m.id}}function DV(t,e,r){let n=t.getEntity(e.damBase);n&&(n.get(N.RoomTrait).exits[N.Direction.NORTH]={destination:r})}function LV(t,e,r){let n=t.getEntity(e.streamView),i=t.getEntity(r);n&&(n.get(N.RoomTrait).exits[N.Direction.NORTH]={destination:r}),i&&(i.get(N.RoomTrait).exits[N.Direction.NORTH]={destination:e.streamView})}function MV(t,e){xse(t,e.damLobby),jse(t,e.maintenanceRoom),Wse(t,e.dam),Use(t,e.reservoir),Hse(t,e.reservoirNorth),qse(t,e.damBase),Gse(t,e.atlantisRoom)}function xse(t,e){let r=t.createEntity("guidebook",N.EntityType.ITEM);r.add(new N.IdentityTrait({name:"guidebook",aliases:["guide book","guide","book","brochure","pamphlet"],description:'This is a guidebook entitled "Flood Control Dam #3" with a picture of the dam on the cover.',properName:!1,article:"a",weight:5})),r.add(new N.ReadableTrait({text:`FLOOD CONTROL DAM #3

Constructed in Year 783 of the Great Underground Empire, Flood Control Dam #3 was a major engineering achievement. The dam is 400 feet tall and holds back the mighty Frigid River.

The dam is controlled from the Maintenance Room. In case of emergency, the control panel can be used to open or close the sluice gates.

NOTICE: Opening the sluice gates will drain the reservoir. This is not reversible without significant effort.`})),r.add(new ye({burnableType:"flammable",size:10})),t.moveEntity(r.id,e);let n=t.createEntity("matchbook",N.EntityType.ITEM);n.add(new N.IdentityTrait({name:"matchbook",aliases:["matches","book of matches","match book"],description:'A matchbook advertising MIT Tech. The cover says "STRADDLING THE CUTTING EDGE OF NOTHING".',properName:!1,article:"a",weight:5})),n.add(new N.ReadableTrait({text:`   *** MIT TECH CORRESPONDENCE SCHOOL ***

"My income soared after I received my degree!" - Mr. TAA of Muddle, Mass.

"I got a great job in paper shuffling!" - Mr. MARC of Boston

Straddling the cutting edge of nothing! Earn your MDL degree at home!

       *** SEND FOR OUR FREE BROCHURE TODAY! ***`})),t.moveEntity(n.id,e)}function jse(t,e){let r=t.createEntity("control panel",N.EntityType.ITEM);r.add(new N.IdentityTrait({name:"control panel",aliases:["panel","controls","buttons","switches","levers"],description:'The control panel has a row of buttons in various colors. There is also a large bolt holding a cover in place, and a yellow button labeled "DANGER".',properName:!1,article:"a"})),r.add(new N.SceneryTrait),r.attributes.boltLoose=!1,t.moveEntity(r.id,e);let n=t.createEntity("wrench",N.EntityType.ITEM);n.add(new N.IdentityTrait({name:"wrench",aliases:["spanner","tool"],description:"This is a heavy wrench, suitable for loosening large bolts.",properName:!1,article:"a",weight:5})),t.moveEntity(n.id,e);let i=t.createEntity("screwdriver",N.EntityType.ITEM);i.add(new N.IdentityTrait({name:"screwdriver",aliases:["screwdriver","tool"],description:"This is a large flathead screwdriver.",properName:!1,article:"a",weight:10})),t.moveEntity(i.id,e);let o=t.createEntity("yellow button",N.EntityType.SCENERY);o.add(new N.IdentityTrait({name:"yellow button",aliases:["danger button","danger","button"],adjectives:["yellow"],description:'A yellow button labeled "DANGER".',properName:!1,article:"a"})),o.add(new N.SceneryTrait),o.add(new N.ButtonTrait({color:"yellow",label:"DANGER"})),t.moveEntity(o.id,e);let a=t.createEntity("brown button",N.EntityType.SCENERY);a.add(new N.IdentityTrait({name:"brown button",aliases:["button"],adjectives:["brown"],description:"A brown button.",properName:!1,article:"a"})),a.add(new N.SceneryTrait),a.add(new N.ButtonTrait({color:"brown"})),t.moveEntity(a.id,e);let s=t.createEntity("red button",N.EntityType.SCENERY);s.add(new N.IdentityTrait({name:"red button",aliases:["button"],adjectives:["red"],description:"A red button.",properName:!1,article:"a"})),s.add(new N.SceneryTrait),s.add(new N.ButtonTrait({color:"red"})),t.moveEntity(s.id,e);let c=t.createEntity("blue button",N.EntityType.SCENERY);c.add(new N.IdentityTrait({name:"blue button",aliases:["button"],adjectives:["blue"],description:"A blue button.",properName:!1,article:"a"})),c.add(new N.SceneryTrait),c.add(new N.ButtonTrait({color:"blue"})),t.moveEntity(c.id,e)}function Wse(t,e){let r=t.createEntity("bolt",N.EntityType.SCENERY);r.add(new N.IdentityTrait({name:"bolt",aliases:["large bolt","metal bolt"],description:"A large metal bolt on the control panel. Above it is a small green plastic bubble.",properName:!1,article:"a"})),r.add(new N.SceneryTrait),r.attributes.turnable=!0,t.moveEntity(r.id,e)}function Use(t,e){let r=t.createEntity("trunk",N.EntityType.ITEM);r.add(new N.IdentityTrait({name:"trunk",aliases:["trunk of jewels","treasure trunk","chest"],description:"This is an old trunk, covered in mud. It appears to contain a fortune in jewels!",properName:!1,article:"a",weight:5,points:15})),r.add(new N.ContainerTrait({capacity:{maxItems:10,maxWeight:50}})),r.add(new N.OpenableTrait({isOpen:!0})),r.add(new z({trophyCaseValue:8})),t.moveEntity(r.id,e)}function Hse(t,e){let r=t.createEntity("hand pump",N.EntityType.ITEM);r.add(new N.IdentityTrait({name:"hand pump",aliases:["pump","air pump","hand pump","rubber pump"],description:"This is a small hand-held air pump.",properName:!1,article:"a",weight:5})),t.moveEntity(r.id,e)}function qse(t,e){let r=t.createEntity("pile of plastic",N.EntityType.ITEM);r.add(new N.IdentityTrait({name:"pile of plastic",aliases:["boat","rubber boat","raft","inflatable boat","inflatable raft","plastic","pile"],description:"There is a folded pile of plastic here which has a small valve attached.",properName:!1,article:"a",weight:2})),r.add(new N.ContainerTrait({capacity:{maxItems:10,maxWeight:100}})),r.add(new et({isInflated:!1})),t.moveEntity(r.id,e);let n=t.createEntity("tan label",N.EntityType.ITEM);n.add(new N.IdentityTrait({name:"tan label",aliases:["label","tan label","instructions"],description:"A tan label attached to the boat.",properName:!1,article:"a",weight:0})),n.add(new N.ReadableTrait({text:`    !!!! FROBOZZ MAGIC BOAT COMPANY !!!!

Hello, sailor!

Instructions for use:

To get into the boat, say "BOARD"
To leave the boat, say "DISEMBARK"
To get into a body of water, say "LAUNCH"
To get to shore, say "LAND"

Warranty:

This boat is guaranteed against all defects in parts and workmanship for a period of 76 milliseconds from date of purchase or until first used, whichever comes first.

Warning: This boat is made of plastic.

Good luck!`})),t.moveEntity(n.id,r.id);let i=t.createEntity("sharp stick",N.EntityType.ITEM);i.add(new N.IdentityTrait({name:"sharp stick",aliases:["stick","broken stick","sharp stick","broken sharp stick","pointed stick"],description:"A sharp stick, which appears to have been broken at one end, is here.",properName:!1,article:"a",weight:5})),i.attributes.isPointy=!0,i.attributes.puncturesBoat=!0,i.attributes.isSceptre=!0,t.moveEntity(i.id,e);let o=t.createEntity("river-dam-base",N.EntityType.ITEM);o.add(new N.IdentityTrait({name:"Frigid River",aliases:["river","water","frigid river","stream"],description:"The Frigid River is flowing by here. Across the river are the White Cliffs, which seem to form a giant wall stretching from north to south along the east shore of the river as it winds its way downstream.",properName:!0,article:"the"})),o.add(new N.SceneryTrait),o.attributes.isWaterBody=!0,t.moveEntity(o.id,e)}function Gse(t,e){let r=t.createEntity("crystal trident",N.EntityType.ITEM);r.add(new N.IdentityTrait({name:"crystal trident",aliases:["trident","poseidon trident","poseidons trident","crystal"],description:"On the shore lies Poseidon's own crystal trident.",properName:!1,article:"a",weight:5,points:4})),r.add(new z({trophyCaseValue:11})),t.moveEntity(r.id,e)}var b=_(E());function Ft(t,e,r,n=!0){let i=t.createEntity(e,b.EntityType.ROOM);return i.add(new b.RoomTrait({exits:{},isDark:n,isOutdoors:!1})),i.add(new b.IdentityTrait({name:e,description:r,properName:!0,article:"the"})),i}function Fe(t,e){let r=t.get(b.RoomTrait);if(r)for(let[n,i]of Object.entries(e))r.exits[n]={destination:i}}function PV(t){let e=Ft(t,"Cold Passage","You are in a cold, damp passage. The air here is noticeably colder than elsewhere in the underground. Passages lead in several directions."),r=Ft(t,"Steep Crawlway","You are in a steep, narrow crawlway. The passage slopes steeply here, making movement difficult."),n=Ft(t,"Slide Room","You are in a room with a steep slide leading down into darkness. The slide appears to be one-way - once you go down, there may be no coming back up. Passages lead north and east."),i=t.createEntity("Slide-1",b.EntityType.ROOM);i.add(new b.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),i.add(new b.IdentityTrait({name:"Slide",aliases:["slide","chute"],description:"You are on a steep slide, sliding downward. The walls are too smooth to grab onto. You continue to slide down...",properName:!0,article:"the"}));let o=t.createEntity("Slide-2",b.EntityType.ROOM);o.add(new b.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),o.add(new b.IdentityTrait({name:"Slide",aliases:["slide","chute"],description:"You continue sliding down the steep chute. There is no way to stop or go back up.",properName:!0,article:"the"}));let a=t.createEntity("Slide-3",b.EntityType.ROOM);a.add(new b.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),a.add(new b.IdentityTrait({name:"Slide",aliases:["slide","chute"],description:"You are at the bottom of a long slide. There is a small ledge to the east where you might be able to stop. Otherwise, you will continue sliding down into the depths below.",properName:!0,article:"the"}));let s=Ft(t,"Slide Ledge","You are on a small ledge beside a steep slide. The ledge is barely wide enough to stand on. A passage leads south."),c=Ft(t,"Sooty Room","You are in a room covered with a thick layer of coal dust and soot. Everything here is coated in black grime. A passage leads north."),d=Ft(t,"Mine Entrance","You are at the entrance to an old coal mine. Wooden support beams frame the entrance, and you can see passages leading in several directions. The air smells of dust and old coal."),u=Ft(t,"Squeaky Room","You are in a room with a wooden floor that squeaks loudly with every step you take. The floorboards are old and warped."),m=Ft(t,"Small Room","This is a small, cramped room carved out of the rock. A passage leads east."),f=Ft(t,"Shaft Room","This is a small room near the top of a deep shaft. A rusty iron basket hangs from a chain here, suspended over the darkness below. An opening leads west."),g=Ft(t,"Wooden Tunnel","You are in a tunnel reinforced with wooden beams and supports. The timbers creak ominously as you pass through."),h=Ft(t,"Smelly Room","You are in a room with a strong, unpleasant odor. The smell of natural gas is unmistakable. A hole in the floor leads down."),y=Ft(t,"Gas Room","This room has a strong, unpleasant smell. The air feels heavy and slightly nauseating. It would be very dangerous to bring an open flame here. Passages lead north and east.");y.add(new Bs);let T="You are in a maze of twisty little passages, all alike.",I=t.createEntity("Mine Maze-1",b.EntityType.ROOM);I.add(new b.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),I.add(new b.IdentityTrait({name:"Maze",aliases:["maze","mine maze"],description:T,properName:!1,article:"a"}));let A=t.createEntity("Mine Maze-2",b.EntityType.ROOM);A.add(new b.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),A.add(new b.IdentityTrait({name:"Maze",aliases:["maze","mine maze"],description:T,properName:!1,article:"a"}));let L=t.createEntity("Mine Maze-3",b.EntityType.ROOM);L.add(new b.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),L.add(new b.IdentityTrait({name:"Maze",aliases:["maze","mine maze"],description:T,properName:!1,article:"a"}));let S=t.createEntity("Mine Maze-4",b.EntityType.ROOM);S.add(new b.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),S.add(new b.IdentityTrait({name:"Maze",aliases:["maze","mine maze"],description:T,properName:!1,article:"a"}));let R=t.createEntity("Mine Maze-5",b.EntityType.ROOM);R.add(new b.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),R.add(new b.IdentityTrait({name:"Maze",aliases:["maze","mine maze"],description:T,properName:!1,article:"a"}));let k=t.createEntity("Mine Maze-6",b.EntityType.ROOM);k.add(new b.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),k.add(new b.IdentityTrait({name:"Maze",aliases:["maze","mine maze"],description:T,properName:!1,article:"a"}));let w=t.createEntity("Mine Maze-7",b.EntityType.ROOM);w.add(new b.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),w.add(new b.IdentityTrait({name:"Maze",aliases:["maze","mine maze"],description:T,properName:!1,article:"a"}));let Te=Ft(t,"Ladder Top","You are at the top of a rickety wooden ladder that descends into darkness. A passage leads north."),Oe=Ft(t,"Ladder Bottom","You are at the bottom of a rickety wooden ladder. A passage leads south into an area with a strange smell. You can climb up the ladder."),ue=t.createEntity("Coal Mine Dead End",b.EntityType.ROOM);ue.add(new b.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),ue.add(new b.IdentityTrait({name:"Dead End",aliases:["dead end"],description:"You have reached a dead end in the coal mine. The passage ends abruptly here.",properName:!1,article:"a"}));let mt=Ft(t,"Timber Room","This room is supported by massive wooden beams that creak ominously. The timber looks old but sturdy. Passages lead north, west, and south."),le=Ft(t,"Bottom of Shaft","You are at the bottom of a deep shaft. The walls rise up into darkness above you. Passages lead east and northeast."),Be=Ft(t,"Machine Room","This is a large room full of old mining equipment. In the center stands a massive coal-powered machine with a prominent slot. The walls are blackened with soot. A passage leads west.");return Fe(e,{[b.Direction.WEST]:n.id,[b.Direction.NORTH]:r.id}),Fe(r,{[b.Direction.SOUTHWEST]:e.id}),Fe(n,{[b.Direction.DOWN]:i.id,[b.Direction.EAST]:e.id,[b.Direction.NORTH]:d.id}),Fe(i,{[b.Direction.DOWN]:o.id}),Fe(o,{[b.Direction.DOWN]:a.id}),Fe(a,{[b.Direction.EAST]:s.id}),Fe(s,{[b.Direction.UP]:o.id,[b.Direction.SOUTH]:c.id}),Fe(c,{[b.Direction.NORTH]:s.id}),Fe(d,{[b.Direction.SOUTH]:n.id,[b.Direction.NORTHWEST]:u.id,[b.Direction.NORTHEAST]:f.id}),Fe(u,{[b.Direction.SOUTH]:d.id,[b.Direction.WEST]:m.id}),Fe(m,{[b.Direction.EAST]:u.id}),Fe(f,{[b.Direction.WEST]:d.id,[b.Direction.NORTH]:g.id}),Fe(g,{[b.Direction.SOUTH]:f.id,[b.Direction.WEST]:h.id,[b.Direction.NORTHEAST]:I.id}),Fe(h,{[b.Direction.EAST]:g.id,[b.Direction.DOWN]:y.id}),Fe(y,{[b.Direction.UP]:h.id}),Fe(I,{[b.Direction.NORTH]:S.id,[b.Direction.SOUTHWEST]:A.id,[b.Direction.EAST]:g.id}),Fe(A,{[b.Direction.SOUTH]:I.id,[b.Direction.WEST]:R.id,[b.Direction.UP]:L.id,[b.Direction.NORTHEAST]:S.id}),Fe(L,{[b.Direction.WEST]:A.id,[b.Direction.NORTHEAST]:R.id,[b.Direction.EAST]:R.id}),Fe(S,{[b.Direction.UP]:R.id,[b.Direction.NORTHEAST]:k.id,[b.Direction.SOUTH]:I.id,[b.Direction.WEST]:A.id}),Fe(R,{[b.Direction.DOWN]:k.id,[b.Direction.NORTH]:w.id,[b.Direction.WEST]:A.id,[b.Direction.SOUTH]:L.id,[b.Direction.UP]:L.id,[b.Direction.EAST]:S.id}),Fe(k,{[b.Direction.SOUTHEAST]:S.id,[b.Direction.UP]:R.id,[b.Direction.NORTHWEST]:w.id}),Fe(w,{[b.Direction.EAST]:I.id,[b.Direction.WEST]:R.id,[b.Direction.DOWN]:Te.id,[b.Direction.SOUTH]:k.id}),Fe(Te,{[b.Direction.UP]:w.id,[b.Direction.DOWN]:Oe.id}),Fe(Oe,{[b.Direction.UP]:Te.id,[b.Direction.SOUTH]:mt.id,[b.Direction.NORTHEAST]:ue.id}),Fe(ue,{[b.Direction.SOUTH]:Oe.id}),Fe(mt,{[b.Direction.NORTH]:Oe.id,[b.Direction.SOUTHWEST]:le.id}),Fe(le,{[b.Direction.EAST]:Be.id,[b.Direction.NORTHEAST]:mt.id}),Fe(Be,{[b.Direction.NORTHWEST]:le.id}),{coldPassage:e.id,steepCrawlway:r.id,slideRoom:n.id,slide1:i.id,slide2:o.id,slide3:a.id,slideLedge:s.id,sootyRoom:c.id,mineEntrance:d.id,squeakyRoom:u.id,smallRoom:m.id,shaftRoom:f.id,woodenTunnel:g.id,smellyRoom:h.id,gasRoom:y.id,mineMaze1:I.id,mineMaze2:A.id,mineMaze3:L.id,mineMaze4:S.id,mineMaze5:R.id,mineMaze6:k.id,mineMaze7:w.id,ladderTop:Te.id,ladderBottom:Oe.id,coalMineDeadEnd:ue.id,timberRoom:mt.id,bottomOfShaft:le.id,machineRoom:Be.id}}function kV(t,e,r){let n=t.getEntity(e.slide3);n&&(n.get(b.RoomTrait).exits[b.Direction.DOWN]={destination:r})}function BV(t,e){Fse(t,e.shaftRoom,e.bottomOfShaft),Vse(t,e.coalMineDeadEnd),Yse(t,e.machineRoom),zse(t,e.squeakyRoom),Kse(t,e.squeakyRoom),$se(t,e.gasRoom),Qse(t,e.sootyRoom),Xse(t,e.timberRoom)}function Fse(t,e,r){let n=t.createEntity("basket",b.EntityType.CONTAINER);return n.add(new b.IdentityTrait({name:"rusty iron basket",aliases:["basket","iron basket","rusty basket"],description:"A rusty iron basket hangs from a sturdy chain. It looks large enough to hold a person and some items. There is a wheel mechanism nearby to lower and raise it.",properName:!1,article:"a"})),n.add(new b.ContainerTrait({capacity:{maxItems:10,maxWeight:100}})),n.add(new b.EnterableTrait),n.add(new b.SceneryTrait),n.add(new _r({topRoomId:e,bottomRoomId:r,initialPosition:"top"})),t.moveEntity(n.id,e),n}function Vse(t,e){let r=t.createEntity("coal",b.EntityType.ITEM);return r.add(new b.IdentityTrait({name:"pile of coal",aliases:["coal","black coal","lump of coal"],description:"A pile of black coal. It would make excellent fuel for a machine.",properName:!1,article:"a",weight:10})),t.moveEntity(r.id,e),r}function Yse(t,e){let r=t.createEntity("machine",b.EntityType.CONTAINER);return r.add(new b.IdentityTrait({name:"machine",aliases:["machine","coal machine","big machine","coal-powered machine"],description:"This is a massive machine with a lid on top and a switch on the side. The lid is open, revealing a small compartment inside. It looks like it could exert enormous pressure.",properName:!1,article:"a"})),r.add(new b.ContainerTrait({capacity:{maxItems:1,maxWeight:10}})),r.add(new b.OpenableTrait({isOpen:!0})),r.add(new b.SceneryTrait),r.add(new Ms({isActivated:!1})),t.moveEntity(r.id,e),r}function zse(t,e){let r=t.createEntity("vampire bat",b.EntityType.ACTOR);return r.add(new b.IdentityTrait({name:"vampire bat",aliases:["bat","giant bat","large bat"],description:"A giant vampire bat hangs from the ceiling, watching you with beady eyes. It looks strong enough to carry a person.",properName:!1,article:"a"})),r.add(new b.ActorTrait({isPlayer:!1})),r.add(new b.NpcTrait({behaviorId:"bat",isHostile:!1,canMove:!0})),r.attributes.repelledBy="garlic",t.moveEntity(r.id,e),r}function Kse(t,e){let r=t.createEntity("jade figurine",b.EntityType.ITEM);return r.add(new b.IdentityTrait({name:"jade figurine",aliases:["figurine","jade","statue","jade statue"],description:"A beautiful jade figurine of an oriental dragon. It is exquisitely carved.",properName:!1,article:"a",weight:5,points:5})),r.add(new z({trophyCaseValue:5})),t.moveEntity(r.id,e),r}function $se(t,e){let r=t.createEntity("sapphire bracelet",b.EntityType.ITEM);return r.add(new b.IdentityTrait({name:"sapphire bracelet",aliases:["bracelet","sapphire","blue bracelet"],description:"A delicate bracelet set with brilliant blue sapphires.",properName:!1,article:"a",weight:5,points:5})),r.add(new z({trophyCaseValue:3})),t.moveEntity(r.id,e),r}function Qse(t,e){let r=t.createEntity("red crystal sphere",b.EntityType.ITEM);return r.add(new b.IdentityTrait({name:"red crystal sphere",aliases:["sphere","crystal sphere","red sphere","crystal","red crystal","ball"],adjectives:["red"],description:"A beautiful sphere of red crystal. It seems to glow with an inner light.",properName:!1,article:"a",weight:5,points:10})),r.add(new z({trophyCaseValue:5})),t.moveEntity(r.id,e),r}function Xse(t,e){let r=t.createEntity("timber",b.EntityType.ITEM);return r.add(new b.IdentityTrait({name:"wooden timber",aliases:["timber","beam","wooden beam","lumber","wood"],description:"A large, sturdy piece of timber. It could be useful for propping things up.",properName:!1,article:"a",weight:20})),t.moveEntity(r.id,e),r}var x=_(E());function en(t,e,r,n=!0){let i=t.createEntity(e,x.EntityType.ROOM);return i.add(new x.RoomTrait({exits:{},isDark:n,isOutdoors:!1})),i.add(new x.IdentityTrait({name:e,description:r,properName:!0,article:"the"})),i}function tn(t,e){let r=t.get(x.RoomTrait);if(r)for(let[n,i]of Object.entries(e))r.exits[n]={destination:i}}function xV(t){let e=en(t,"Temple","This is the interior of a large temple of ancient construction. Flickering torches cast shadows on the walls. A stairway leads down."),r=en(t,"Altar","This is the altar room of the temple. A large stone altar dominates the room."),n=en(t,"North/South Passage","This is a wide passage running north and south. The walls are damp and cold."),i=en(t,"Grail Room","You are in a small chamber with walls of granite. A narrow passage exits to the west."),o=en(t,"Winding Passage","This is a winding passage through the rock. It leads northwest and east."),a=en(t,"Mirror Room","You are in a large room with a great mirror on the wall. Passages lead northeast and west."),s=en(t,"Narrow Crawlway","This is a narrow crawlway. Passages lead north, south, and southwest."),c=en(t,"Loud Room","This is a large room with a ceiling which cannot be detected from the ground. A narrow passage leads east; a stairway leads up. The room is extremely noisy."),d=en(t,"Damp Cave","This cave is extremely damp. A stairway leads down."),u=en(t,"Ancient Chasm","You are at the edge of an ancient chasm. Passages lead in several directions."),m=en(t,"Basin Room","You are in a small room with a stone basin in the center.");m.add(new hi({basinState:"normal"}));let f=en(t,"Dead End","You are at a dead end in the passage."),g=en(t,"Dead End","You are at a dead end in the passage."),h=en(t,"Small Cave","This is a small cave. A passage leads west.");return tn(e,{[x.Direction.EAST]:r.id,[x.Direction.DOWN]:i.id}),tn(r,{[x.Direction.WEST]:e.id}),tn(i,{[x.Direction.UP]:e.id,[x.Direction.EAST]:s.id}),tn(n,{[x.Direction.NORTHEAST]:c.id}),tn(c,{[x.Direction.WEST]:n.id,[x.Direction.UP]:d.id,[x.Direction.EAST]:u.id}),tn(d,{[x.Direction.DOWN]:c.id,[x.Direction.SOUTH]:c.id}),tn(u,{[x.Direction.WEST]:c.id,[x.Direction.NORTH]:g.id,[x.Direction.EAST]:h.id,[x.Direction.SOUTH]:m.id}),tn(m,{[x.Direction.NORTH]:u.id}),tn(f,{[x.Direction.EAST]:u.id}),tn(g,{[x.Direction.SOUTH]:u.id}),tn(h,{[x.Direction.WEST]:u.id}),tn(s,{[x.Direction.WEST]:i.id,[x.Direction.SOUTHWEST]:a.id,[x.Direction.SOUTH]:o.id}),tn(a,{[x.Direction.NORTHEAST]:s.id,[x.Direction.WEST]:o.id}),tn(o,{[x.Direction.EAST]:a.id,[x.Direction.NORTH]:s.id}),{temple:e.id,altar:r.id,northSouthPassage:n.id,grailRoom:i.id,windingPassage:o.id,mirrorRoom:a.id,narrowCrawlway:s.id,loudRoom:c.id,dampCave:d.id,ancientChasm:u.id,basinRoom:m.id,deadEnd1:f.id,deadEnd2:g.id,smallCave:h.id}}function jV(t,e,r){let n=t.getEntity(e.northSouthPassage),i=t.getEntity(r);n&&(n.get(x.RoomTrait).exits[x.Direction.NORTH]={destination:r}),i&&(i.get(x.RoomTrait).exits[x.Direction.EAST]={destination:e.northSouthPassage})}function WV(t,e,r){let n=t.getEntity(e.mirrorRoom),i=t.getEntity(r);n&&(n.get(x.RoomTrait).exits[x.Direction.EAST]={destination:r}),i&&(i.get(x.RoomTrait).exits[x.Direction.WEST]={destination:e.mirrorRoom})}function UV(t,e,r){let n=t.getEntity(e.dampCave),i=t.getEntity(r);n&&(n.get(x.RoomTrait).exits[x.Direction.EAST]={destination:r}),i&&(i.get(x.RoomTrait).exits[x.Direction.EAST]={destination:e.dampCave})}function HV(t,e,r){let n=t.getEntity(e.smallCave),i=t.getEntity(r);n&&(n.get(x.RoomTrait).exits[x.Direction.NORTHWEST]={destination:r}),i&&(i.get(x.RoomTrait).exits[x.Direction.SOUTHEAST]={destination:e.smallCave})}var Zse="dungeo-mirror";function qV(t,e){Jse(t,e.altar),ece(t,e.grailRoom),tce(t,e.mirrorRoom),rce(t,e.smallCave),nce(t,e.basinRoom),ice(t,e.loudRoom)}function Jse(t,e){let r=t.createEntity("stone altar",x.EntityType.SCENERY);r.add(new x.IdentityTrait({name:"stone altar",aliases:["altar","massive altar"],description:"A massive stone altar covered in ancient runes. It radiates an aura of ancient power.",properName:!1,article:"a"})),r.add(new x.SceneryTrait),t.moveEntity(r.id,e);let n=t.createEntity("brass bell",x.EntityType.ITEM);n.add(new x.IdentityTrait({name:"brass bell",aliases:["bell","brass","small bell"],description:"A brass bell with strange symbols engraved around its rim.",properName:!1,article:"a",weight:5})),n.attributes.isExorcismItem=!0,n.attributes.exorcismRole="bell",t.moveEntity(n.id,e);let i=t.createEntity("black book",x.EntityType.ITEM);i.add(new x.IdentityTrait({name:"black book",aliases:["book","ancient book","leather book"],description:"An ancient book bound in black leather. Strange symbols cover the cover.",properName:!1,article:"a",weight:5})),i.add(new x.ReadableTrait({text:`The book is written in a strange language, but one passage stands out:

"To banish the spirits of the dead, one must perform the Ritual of Exorcism:
Ring the bell, read the book aloud, light the candles with a flame.
Only then shall the gates of Hades be opened to the living."`})),i.attributes.isExorcismItem=!0,i.attributes.exorcismRole="book",t.moveEntity(i.id,e);let o=t.createEntity("pair of candles",x.EntityType.ITEM);o.add(new x.IdentityTrait({name:"pair of candles",aliases:["candles","candle","white candles"],description:"A pair of white wax candles.",properName:!1,article:"a",weight:20})),o.add(new x.LightSourceTrait({isLit:!1,brightness:2,fuelRemaining:50,maxFuel:50,fuelConsumptionRate:1})),o.add(new x.SwitchableTrait({isOn:!1})),o.attributes.isFlame=!0,o.add(new ye({burnableType:"candle",isBurning:!1,burnedOut:!1})),o.attributes.isExorcismItem=!0,o.attributes.exorcismRole="candles",t.moveEntity(o.id,e)}function ece(t,e){let r=t.createEntity("pedestal",x.EntityType.SCENERY);r.add(new x.IdentityTrait({name:"stone pedestal",aliases:["pedestal","stone pedestal","altar"],description:"A stone pedestal stands in the center of the room, carved with ancient symbols.",properName:!1,article:"a"})),r.add(new x.SceneryTrait),t.moveEntity(r.id,e);let n=t.createEntity("grail",x.EntityType.ITEM);n.add(new x.IdentityTrait({name:"grail",aliases:["grail","holy grail","cup","goblet","sacred grail"],description:"A plain wooden grail, yet it radiates an aura of ancient holiness. Its simple appearance belies its true value.",properName:!1,article:"a",weight:5,points:2})),n.add(new z({trophyCaseValue:5})),t.moveEntity(n.id,e)}function tce(t,e){let r=t.createEntity("mirror",x.EntityType.SCENERY);r.attributes.customId=Zse,r.add(new x.IdentityTrait({name:"enormous mirror",aliases:["mirror","enormous mirror","south mirror","wall mirror","large mirror"],description:"An enormous mirror fills the entire south wall of the room. Its surface is flawless and seems to shimmer with an otherworldly quality.",properName:!1,article:"an"})),r.add(new x.SceneryTrait),t.moveEntity(r.id,e)}function rce(t,e){let r=t.createEntity("shovel",x.EntityType.ITEM);r.add(new x.IdentityTrait({name:"shovel",aliases:["shovel","spade"],description:"A sturdy shovel with a wooden handle and metal blade.",properName:!1,article:"a",weight:5})),t.moveEntity(r.id,e)}function nce(t,e){let r=t.createEntity("stone basin",x.EntityType.ITEM);r.add(new x.IdentityTrait({name:"stone basin",aliases:["basin","carved basin","gargoyle basin"],description:"The basin is carved from a single block of dark stone, surrounded by gargoyles and serpent figures. It is filled with what can only be described as a mystical fog.",properName:!1,article:"a"})),r.add(new x.SceneryTrait),r.attributes.isRitualBasin=!0,t.moveEntity(r.id,e)}function ice(t,e){let r=t.createEntity("platinum bar",x.EntityType.ITEM);r.add(new x.IdentityTrait({name:"platinum bar",aliases:["bar","platinum","ingot","metal bar"],description:'This is a large bar of platinum, stamped "FROBOZZ MAGIC COMPANY".',properName:!1,article:"a",weight:20,points:12})),r.add(new z({trophyCaseValue:10})),t.moveEntity(r.id,e)}var C=_(E());function rn(t,e,r,n=!0){let i=t.createEntity(e,C.EntityType.ROOM);return i.add(new C.RoomTrait({exits:{},isDark:n,isOutdoors:!1})),i.add(new C.IdentityTrait({name:e,description:r,properName:!0,article:"the"})),i}function vo(t,e){let r=t.get(C.RoomTrait);if(r)for(let[n,i]of Object.entries(e))r.exits[n]={destination:i}}function GV(t){let e=rn(t,"Egyptian Room","This is a room which looks like an Egyptian tomb. There is an ascending staircase in the room as well as doors, east and south."),r=rn(t,"Glacier Room","You are in a large room, with a passage to the north and a dark, forbidding staircase leading down to the east. On the west is a small passageway which opens up quickly to the south."),n=rn(t,"Volcano View","You are on a ledge in the middle of a large volcano. Below you the volcano bottom can be seen and above is the rim of the volcano. A couple of ledges can be seen on the other side of the volcano; it appears that this ledge is intermediate in elevation between those on the other side. The exit from this room is to the east."),i=rn(t,"Ruby Room","This is a small chamber behind the remains of the Great Glacier. To the south and west are small passageways."),o=rn(t,"Lava Room","This is a small room, whose walls are formed by an old lava flow. There are exits here to the west and the south."),a=rn(t,"Volcano Bottom","You are at the bottom of a large dormant volcano. High above you light may be seen entering from the cone of the volcano. The only exit here is to the north."),s=rn(t,"Wide Ledge","You are on a wide ledge overlooking the volcano interior."),c=rn(t,"Narrow Ledge","You are on a narrow ledge overlooking the inside of an old dormant volcano. This ledge appears to be about in the middle between the floor below and the rim above. There is an exit here to the south."),d=rn(t,"Dusty Room","This is a dusty room that appears to have been abandoned long ago."),u=rn(t,"Library","This is a room which must have been a large library, probably for the royal family. All of the shelves appear to have been gnawed to pieces by unfriendly gnomes. To the north is an exit."),m=rn(t,"Volcano Near Wide Ledge","You are in the middle of the volcano, near a wide ledge.",!1),f=rn(t,"Volcano Near Viewing Ledge","You are in the middle of the volcano, near a viewing ledge.",!1),g=rn(t,"Volcano Near Small Ledge","You are in the middle of the volcano, near a small ledge.",!1),h=rn(t,"Volcano Core","You are about one hundred feet above the bottom of the volcano. The top of the volcano is clearly visible here.",!1);vo(e,{[C.Direction.UP]:r.id,[C.Direction.SOUTH]:n.id}),vo(r,{[C.Direction.EAST]:e.id}),vo(n,{[C.Direction.EAST]:e.id});{let y=n.get(C.RoomTrait);y&&(y.blockedExits={[C.Direction.DOWN]:"I wouldn't try that."})}vo(i,{[C.Direction.WEST]:o.id,[C.Direction.SOUTH]:r.id}),vo(o,{[C.Direction.SOUTH]:a.id,[C.Direction.WEST]:i.id}),vo(a,{[C.Direction.NORTH]:o.id}),vo(s,{[C.Direction.SOUTH]:d.id});{let y=s.get(C.RoomTrait);y&&(y.blockedExits={[C.Direction.DOWN]:"It's a long way down."})}vo(c,{[C.Direction.SOUTH]:u.id});{let y=c.get(C.RoomTrait);y&&(y.blockedExits={[C.Direction.DOWN]:"I wouldn't jump from here."})}return vo(d,{[C.Direction.NORTH]:s.id}),vo(u,{[C.Direction.NORTH]:c.id}),{egyptianRoom:e.id,glacierRoom:r.id,volcanoView:n.id,rubyRoom:i.id,lavaRoom:o.id,volcanoBottom:a.id,wideLedge:s.id,narrowLedge:c.id,dustyRoom:d.id,library:u.id,volcanoCore:h.id,volcanoNearWideLedge:m.id,volcanoNearViewingLedge:f.id,volcanoNearSmallLedge:g.id}}function FV(t,e,r){let n=t.getEntity(e.egyptianRoom),i=t.getEntity(r);n&&(n.get(C.RoomTrait).exits[C.Direction.EAST]={destination:r}),i&&(i.get(C.RoomTrait).exits[C.Direction.NORTHWEST]={destination:e.egyptianRoom})}function VV(t,e){return oce(t,e.egyptianRoom),ace(t,e.glacierRoom),sce(t,e.dustyRoom),cce(t,e.rubyRoom),dce(t,e.library),lce(t,e)}function oce(t,e){let r=t.createEntity("gold coffin",C.EntityType.ITEM);r.add(new C.IdentityTrait({name:"gold coffin",aliases:["coffin","golden coffin","sarcophagus","casket"],description:"The solid gold coffin used for the burial of Ramses II is here.",properName:!1,article:"a",weight:10,points:3})),r.add(new z({trophyCaseValue:7})),t.moveEntity(r.id,e)}function ace(t,e){let r=t.createEntity("glacier",C.EntityType.SCENERY);r.add(new C.IdentityTrait({name:"glacier",aliases:["ice","massive glacier","ice wall","wall of ice","mass of ice"],description:"A mass of ice fills the western half of the room.",properName:!1,article:"a"})),r.add(new C.SceneryTrait),t.moveEntity(r.id,e)}function sce(t,e){let r=t.createEntity("safe",C.EntityType.ITEM);r.add(new C.IdentityTrait({name:"safe",aliases:["safe","box","rusty box","old box"],description:"Imbedded in the far wall is a rusty box. An oblong hole has been chipped out of the front of it.",properName:!1,article:"a"})),r.add(new C.ContainerTrait({capacity:{maxItems:5}})),r.add(new C.OpenableTrait({isOpen:!1})),r.add(new C.SceneryTrait),r.add(new oo),r.attributes.rustedShut=!0,r.attributes.safeBlownOpen=!1,t.moveEntity(r.id,e);let n=t.createEntity("slot",C.EntityType.SCENERY);n.add(new C.IdentityTrait({name:"hole",aliases:["slot","hole","oblong hole"],description:"An oblong hole has been chipped out of the front of the box.",properName:!1,article:"an"})),n.add(new C.ContainerTrait({capacity:{maxItems:1}})),n.add(new C.OpenableTrait({isOpen:!0})),n.add(new C.SceneryTrait),t.moveEntity(n.id,e);let i=t.createEntity("crown",C.EntityType.ITEM);i.add(new C.IdentityTrait({name:"crown",aliases:["crown","gaudy crown","lord dimwit's crown","flathead crown"],description:"The excessively gaudy crown of Lord Dimwit Flathead. It is encrusted with diamonds, rubies, and other precious gems, all in questionable taste.",properName:!1,article:"a",weight:10,points:15})),i.add(new z({trophyCaseValue:10}));let o=new C.AuthorModel(t.getDataStore(),t);o.moveEntity(i.id,r.id);let a=t.createEntity("card",C.EntityType.ITEM);a.add(new C.IdentityTrait({name:"card",aliases:["card","warning","note","warning card"],description:"A small card with printing on it.",properName:!1,article:"a",weight:1})),a.add(new C.ReadableTrait({text:`WARNING:
  This room was constructed over very weak rock strata. Detonation of explosives in this room is strictly prohibited!
    -- Frobozz Magic Cave Company
       per M. Agrippa, foreman`})),o.moveEntity(a.id,r.id)}function cce(t,e){let r=t.createEntity("ruby",C.EntityType.ITEM);r.add(new C.IdentityTrait({name:"ruby",aliases:["large ruby","red gem","gem","jewel"],description:"This is an enormous ruby, the size of a robin's egg. It sparkles brilliantly in the light.",properName:!1,article:"a",weight:5,points:15})),r.add(new z({trophyCaseValue:8})),t.moveEntity(r.id,e)}function dce(t,e){let r=t.createEntity("purple book",C.EntityType.ITEM);r.add(new C.IdentityTrait({name:"purple book",aliases:["book","purple volume","volume"],description:'This is an old book bound in purple leather. The title reads "The History of the Great Underground Empire".',properName:!1,article:"a",weight:5})),r.add(new C.ReadableTrait({text:`THE HISTORY OF THE GREAT UNDERGROUND EMPIRE

This volume chronicles the rise and fall of the Flathead dynasty. Lord Dimwit Flathead the Excessive was the most extravagant of the Flatheads, known for his grandiose projects including Flood Control Dam #3.

A stamp falls out of the book as you read it.`})),r.add(new C.ContainerTrait({capacity:{maxItems:5,maxWeight:10}})),t.moveEntity(r.id,e);let n=t.createEntity("stamp",C.EntityType.ITEM);n.add(new C.IdentityTrait({name:"stamp",aliases:["flathead stamp","postage stamp","lord dimwit flathead stamp"],description:"This is a rare stamp depicting Lord Dimwit Flathead. It is quite valuable to collectors.",properName:!1,article:"a",weight:2,points:4})),n.add(new z({trophyCaseValue:10})),t.moveEntity(n.id,r.id)}function lce(t,e){let r=t.createEntity("balloon",C.EntityType.ITEM);r.add(new C.IdentityTrait({name:"balloon",aliases:["wicker basket","basket","hot air balloon","balloon basket"],description:"This is a large and extremely heavy wicker basket. An enormous cloth bag is draped over the side and is firmly attached to the basket. A metal receptacle is fastened to the center of the basket. Dangling from the basket is a piece of braided wire.",properName:!1,article:"a"})),r.add(new C.ContainerTrait({capacity:{maxItems:10,maxWeight:100}})),r.add(new C.EnterableTrait),r.add(new C.VehicleTrait({vehicleType:"aircraft",transparent:!0,blocksWalkingMovement:!0,requiresExitBeforeLeaving:!0,currentPosition:"vlbot",isOperational:!1,notOperationalReason:"The balloon is not inflated.",positionRooms:{vlbot:e.volcanoBottom,vair1:e.volcanoCore,vair2:e.volcanoNearSmallLedge,vair3:e.volcanoNearViewingLedge,vair4:e.volcanoNearWideLedge,ledg2:e.narrowLedge,ledg3:e.volcanoView,ledg4:e.wideLedge}})),r.add(new kt({tetheredTo:null,burningObject:null,daemonEnabled:!0})),t.moveEntity(r.id,e.volcanoBottom);let n=t.createEntity("receptacle",C.EntityType.ITEM);n.add(new C.IdentityTrait({name:"receptacle",aliases:["brazier","burner","fire holder"],description:"This is a metal receptacle designed to hold burning objects. It has an opening that can be covered to control the heat.",properName:!1,article:"a"})),n.add(new C.ContainerTrait({capacity:{maxItems:1,maxWeight:10},enterable:!1})),n.add(new C.OpenableTrait({isOpen:!1})),n.add(new C.SceneryTrait),n.add(new to({balloonId:r.id})),t.moveEntity(n.id,r.id);let i=t.createEntity("cloth bag",C.EntityType.SCENERY);i.add(new C.IdentityTrait({name:"cloth bag",aliases:["silk bag","balloon bag","silk balloon","bag"],description:"The cloth bag is draped over the basket.",properName:!1,article:"a"})),i.add(new C.SceneryTrait),i.add(new et({isInflated:!1})),t.moveEntity(i.id,r.id);let o=t.createEntity("hook1",C.EntityType.SCENERY);o.add(new C.IdentityTrait({name:"hook",aliases:["metal hook","small hook"],description:"A small hook is embedded in the rock face.",properName:!1,article:"a"})),o.add(new C.SceneryTrait),o.attributes.hookId="hook1",o.setMinimumScope(3,[e.volcanoNearSmallLedge]),t.moveEntity(o.id,e.narrowLedge);let a=t.createEntity("zorkmid coin",C.EntityType.ITEM);a.add(new C.IdentityTrait({name:"zorkmid coin",aliases:["coin","zorkmid","gold coin"],description:"A large gold zorkmid coin. One side shows a portrait of Lord Dimwit Flathead; the other depicts the great underground dam.",properName:!1,article:"a",weight:5,points:10})),a.add(new z({trophyCaseValue:12})),a.add(new C.ReadableTrait({text:"GOLD ZORKMID -- In Frobs We Trust"})),t.moveEntity(a.id,e.narrowLedge);let s=t.createEntity("hook2",C.EntityType.SCENERY);s.add(new C.IdentityTrait({name:"hook",aliases:["metal hook","small hook"],description:"A small hook is embedded in the rock face.",properName:!1,article:"a"})),s.add(new C.SceneryTrait),s.attributes.hookId="hook2",s.setMinimumScope(3,[e.volcanoNearWideLedge]),t.moveEntity(s.id,e.wideLedge);let c=t.createEntity("braided wire",C.EntityType.SCENERY);c.add(new C.IdentityTrait({name:"braided wire",aliases:["wire","braided rope","rope","cord","line","tether"],adjectives:["braided"],description:"A piece of braided wire dangles from the basket.",properName:!1,article:"a"})),c.add(new C.SceneryTrait),t.moveEntity(c.id,r.id);let d=t.createEntity("dead balloon",C.EntityType.SCENERY);return d.add(new C.IdentityTrait({name:"dead balloon",aliases:["crashed balloon","destroyed balloon","wreckage"],description:"The remains of the balloon lie scattered about. The basket is smashed and the silk is torn beyond repair.",properName:!1,article:"a"})),d.add(new C.SceneryTrait),{balloonId:r.id,receptacleId:n.id,hook1Id:o.id,hook2Id:s.id}}var G=_(E());function Ni(t,e,r,n=!0){let i=t.createEntity(e,G.EntityType.ROOM);return i.add(new G.RoomTrait({exits:{},isDark:n,isOutdoors:!1})),i.add(new G.IdentityTrait({name:e,description:r,properName:!0,article:"the"})),i}function Ha(t,e){let r=t.get(G.RoomTrait);if(r)for(let[n,i]of Object.entries(e))r.exits[n]={destination:i}}function zV(t){let e=Ni(t,"East of Chasm","You are on the east edge of a great chasm. A wooden bridge once spanned the gap, but it has long since collapsed. Far below, you can hear the faint sound of rushing water. A narrow ledge runs along the north wall of the chasm."),r=Ni(t,"West of Chasm","You are on the west edge of a great chasm. The remains of a collapsed bridge dangle into the darkness below. A narrow ledge runs along the north wall of the chasm, providing precarious passage to the east. To the south, an ornate doorway leads into what appears to be a building."),n=Ni(t,"Bank Entrance",'You are in the grand entrance hall of the Bank of Zork. Marble columns rise to a vaulted ceiling decorated with gold leaf. A brass plaque on the wall reads "BANK OF ZORK - Securing Your Treasures Since 668 GUE". The main lobby lies to the south.',!1),i=Ni(t,"Bank Lobby",'You are in the main lobby of the Bank of Zork. Teller windows line the east and west walls, though they have long been abandoned. Dust covers the once-polished marble floor. A velvet rope blocks access to the south, where a sign reads "Employees Only". The entrance is to the north.',!1),o=Ni(t,"West Teller's Room",`This is a small square room, which was used by a bank officer whose job it was to retrieve safety deposit boxes for the customer. On the north side of the room is a sign which reads "Viewing Room". On the west side of the room, above an open door, is a sign reading

            BANK PERSONNEL ONLY`,!1),a=Ni(t,"East Teller","You are behind the eastern teller window. This area is much like the western side, with a dusty counter and abandoned paperwork. A passage leads west, and a door to the south leads to the back offices.",!1),s=Ni(t,"Chairman's Office","You are in the opulent office of the Bank's former chairman. A massive mahogany desk dominates the room, and the walls are lined with bookshelves containing leather-bound volumes. A painting hangs on the north wall. Doors lead north and east.",!1),c=Ni(t,"Safety Depository",'This is a large rectangular room. The east and west walls here were used for storing safety deposit boxes. As might be expected, all have been carefully removed by evil persons. To the east, west, and south of the room are large doorways. The northern "wall" of the room is a shimmering curtain of light. In the center of the room is a large stone cube, about 10 feet on a side. Engraved on the side of the cube is some lettering.',!1),d=Ni(t,"Vault","This is the Vault of the Bank of Zork, in which there are no doors.",!1),u=Ni(t,"Viewing Room",`This is a room used by holders of safety deposit boxes to view their contents. On the north side of the room is a sign which says

REMAIN HERE WHILE THE BANK OFFICER RETRIEVES YOUR DEPOSIT BOX
WHEN YOU ARE FINISHED, LEAVE THE BOX, AND EXIT TO THE SOUTH
AN ADVANCED PROTECTIVE DEVICE PREVENTS ALL CUSTOMERS FROM
REMOVING ANY SAFETY DEPOSIT BOX FROM THIS VIEWING AREA!
Thank you for banking at the Zork!`,!1),m=Ni(t,"Small Room","This is a small bare room with no distinguishing features. There are no exits from this room.",!1);return Ha(e,{[G.Direction.WEST]:r.id}),Ha(r,{[G.Direction.EAST]:e.id}),Ha(n,{[G.Direction.NORTHWEST]:o.id,[G.Direction.NORTHEAST]:a.id}),Ha(i,{[G.Direction.NORTH]:n.id,[G.Direction.WEST]:o.id,[G.Direction.EAST]:a.id}),Ha(o,{[G.Direction.WEST]:c.id,[G.Direction.SOUTHEAST]:n.id}),Ha(a,{[G.Direction.WEST]:o.id,[G.Direction.SOUTH]:s.id}),Ha(s,{[G.Direction.NORTH]:a.id,[G.Direction.WEST]:u.id,[G.Direction.EAST]:c.id}),Ha(c,{[G.Direction.EAST]:o.id,[G.Direction.WEST]:o.id,[G.Direction.SOUTH]:s.id}),Ha(u,{[G.Direction.SOUTH]:n.id}),{eastOfChasm:e.id,westOfChasm:r.id,bankEntrance:n.id,bankLobby:i.id,westTeller:o.id,eastTeller:a.id,chairmansOffice:s.id,safetyDeposit:c.id,vault:d.id,viewingRoom:u.id,smallRoom:m.id}}function KV(t,e,r,n,i){let o=t.getEntity(r);o&&(o.get(G.RoomTrait).exits[G.Direction.SOUTH]={destination:e.westOfChasm});let a=t.getEntity(e.westOfChasm);if(a){let d=a.get(G.RoomTrait);d.exits[G.Direction.WEST]={destination:r},d.exits[G.Direction.SOUTH]={destination:n},i&&(d.exits[G.Direction.NORTH]={destination:i})}if(i){let d=t.getEntity(i);d&&(d.get(G.RoomTrait).exits[G.Direction.NORTH]={destination:e.westOfChasm})}let s=t.getEntity(n);if(s){let d=s.get(G.RoomTrait);d.exits[G.Direction.NORTH]={destination:e.westOfChasm},d.exits[G.Direction.WEST]={destination:e.bankEntrance}}let c=t.getEntity(e.bankEntrance);c&&(c.get(G.RoomTrait).exits[G.Direction.EAST]={destination:n})}function $V(t,e){uce(t,e.chairmansOffice),mce(t,e.vault),pce(t,e.safetyDeposit),fce(t,e.safetyDeposit),gce(t,e.viewingRoom),hce(t,e.chairmansOffice),yce(t,e.bankEntrance),Tce(t,e.safetyDeposit),YV(t,e.safetyDeposit,"safety-north-wall"),YV(t,e.vault,"vault-north-wall"),Ece(t,e.smallRoom)}function uce(t,e){let r=t.createEntity("portrait",G.EntityType.ITEM);return r.add(new G.IdentityTrait({name:"portrait",aliases:["portrait","flathead portrait"],description:"A magnificent oil portrait of J. Pierpont Flathead, founder of the Bank of Zork. The ornate gilded frame alone must be worth a fortune.",properName:!1,article:"a",weight:20,points:10})),r.add(new z({trophyCaseValue:5})),t.moveEntity(r.id,e),r}function mce(t,e){let r=t.createEntity("stack of zorkmid bills",G.EntityType.ITEM);return r.add(new G.IdentityTrait({name:"stack of zorkmid bills",aliases:["zorkmid bills","bills","zorkmids","stack of bills","money","currency"],description:"A thick stack of crisp zorkmid bills in various denominations. The bills bear the stern likeness of Lord Dimwit Flathead.",properName:!1,article:"a",weight:20,points:10})),r.add(new z({trophyCaseValue:15})),t.moveEntity(r.id,e),r}function pce(t,e){let r=t.createEntity("stone cube",G.EntityType.ITEM);return r.add(new G.IdentityTrait({name:"stone cube",aliases:["cube","large cube","large stone cube","lettering","engraving"],description:"A large stone cube, about 10 feet on a side. Engraved on the side of the cube is some lettering.",properName:!1,article:"a"})),r.add(new G.SceneryTrait),r.add(new G.ReadableTrait({text:`             Bank of Zork
              VAULT
            *722 GUE*
     Frobozz Magic Vault Company`})),t.moveEntity(r.id,e),r}function fce(t,e){let r=t.createEntity("shimmering curtain",G.EntityType.ITEM);return r.add(new G.IdentityTrait({name:"shimmering curtain",aliases:["curtain","curtain of light","shimmering curtain of light","light"],description:'The northern "wall" of the room is a shimmering curtain of light. It seems almost tangible, yet ethereal at the same time.',properName:!1,article:"a"})),r.add(new G.SceneryTrait),r.attributes.isPassable=!0,t.moveEntity(r.id,e),r}function gce(t,e){let r=t.createEntity("velvet curtain",G.EntityType.ITEM);return r.add(new G.IdentityTrait({name:"velvet curtain",aliases:["curtain","heavy curtain","drape"],description:"A heavy velvet curtain in deep burgundy. It hangs from ceiling to floor on the south wall.",properName:!1,article:"a"})),r.add(new G.SceneryTrait),r.add(new G.OpenableTrait({isOpen:!1})),t.moveEntity(r.id,e),r}function hce(t,e){let r=t.createEntity("mahogany desk",G.EntityType.ITEM);return r.add(new G.IdentityTrait({name:"mahogany desk",aliases:["desk","massive desk","chairman desk"],description:"A massive mahogany desk that must weigh several hundred pounds. Its surface is covered with a layer of dust.",properName:!1,article:"a"})),r.add(new G.SceneryTrait),t.moveEntity(r.id,e),r}function yce(t,e){let r=t.createEntity("brass plaque",G.EntityType.ITEM);return r.add(new G.IdentityTrait({name:"brass plaque",aliases:["plaque","sign"],description:'The brass plaque reads: "BANK OF ZORK - Securing Your Treasures Since 668 GUE".',properName:!1,article:"a"})),r.add(new G.SceneryTrait),t.moveEntity(r.id,e),r}function Tce(t,e){let r=t.createEntity("vault door",G.EntityType.ITEM);return r.add(new G.IdentityTrait({name:"vault door",aliases:["massive door","steel door","vault"],description:"A massive circular vault door made of reinforced steel. It stands slightly ajar, its intricate locking mechanism long since broken.",properName:!1,article:"a"})),r.add(new G.SceneryTrait),r.add(new G.OpenableTrait({isOpen:!0})),t.moveEntity(r.id,e),r}function YV(t,e,r){let n=t.createEntity(r,G.EntityType.SCENERY);return n.add(new G.IdentityTrait({name:"north wall",aliases:["north wall","n wall","northern wall"],description:"The north wall looks solid but somehow insubstantial.",properName:!1,article:"the"})),n.add(new G.SceneryTrait),t.moveEntity(n.id,e),n}function Ece(t,e){let r=t.createEntity("south wall",G.EntityType.SCENERY);return r.add(new G.IdentityTrait({name:"south wall",aliases:["south wall","s wall","southern wall"],description:"The south wall looks solid but somehow insubstantial.",properName:!1,article:"the"})),r.add(new G.SceneryTrait),t.moveEntity(r.id,e),r}var P=_(E());function zn(t,e,r,n=!0){let i=t.createEntity(e,P.EntityType.ROOM);return i.add(new P.RoomTrait({exits:{},isDark:n,isOutdoors:!1})),i.add(new P.IdentityTrait({name:e,description:r,properName:!0,article:"the"})),i}function Kn(t,e){let r=t.get(P.RoomTrait);if(r)for(let[n,i]of Object.entries(e))r.exits[n]={destination:i}}function XV(t){let e=zn(t,"Engravings Cave","You are in a cave with strange engravings on the walls. A passage leads north, and stairs lead down."),r=zn(t,"Riddle Room",`This is a room which is bare on all sides. There is an exit down. To the east is a great door made of stone. Above the stone, the following words are written: 'No man shall enter this room without solving this riddle:

What is tall as a house,
round as a cup,
and all the king's horses can't draw it up?'

(Reply via 'ANSWER "answer"')`);r.add(new ro({riddleSolved:!1}));let n=zn(t,"Broom Closet","This is a former broom closet. The exits are to the east and west."),i=zn(t,"Well Bottom","You are at the bottom of a well. The walls are too smooth to climb."),o=zn(t,"Top of Well","You are at the top of a well. A bucket hangs from a rope here."),a=zn(t,"Low Room","This is a low room with passages leading in several directions."),s=zn(t,"Machine Room","This is a large room filled with strange machinery. A small triangular button is set into the wall. A passage leads west."),c=s.get(P.IdentityTrait);c&&(c.aliases=["button machine room","carousel machine room"]);let d=zn(t,"Dingy Closet","This is a small, dingy closet. A door leads north."),u=zn(t,"Tea Room","This is a small room with a table. On the table are cakes of various sorts. Passages lead to the west, northwest, and east."),m=zn(t,"Posts Room","This is a room with very large and very tall wooden posts in each corner. The room is otherwise featureless."),f=zn(t,"Pool Room","This is a large room, one half of which is depressed. There is a large leak in the ceiling through which brown colored goop is falling. The only exit is to the west."),g=zn(t,"Cave","This is a tiny cave with entrances west and north, and a dark, forbidding staircase leading down.");return Kn(e,{[P.Direction.SOUTHEAST]:r.id,[P.Direction.DOWN]:r.id}),Kn(r,{[P.Direction.UP]:e.id}),Kn(n,{[P.Direction.WEST]:r.id,[P.Direction.EAST]:i.id}),Kn(i,{[P.Direction.UP]:o.id}),Kn(o,{[P.Direction.DOWN]:i.id,[P.Direction.EAST]:u.id}),Kn(a,{[P.Direction.SOUTHEAST]:u.id,[P.Direction.EAST]:s.id}),Kn(s,{[P.Direction.WEST]:a.id,[P.Direction.SOUTH]:d.id}),Kn(u,{[P.Direction.WEST]:o.id,[P.Direction.NORTHWEST]:a.id,[P.Direction.EAST]:m.id}),Kn(d,{[P.Direction.NORTH]:s.id}),Kn(m,{[P.Direction.WEST]:u.id,[P.Direction.EAST]:f.id}),Kn(f,{[P.Direction.WEST]:m.id}),Kn(g,{}),{engravingsCave:e.id,riddleRoom:r.id,pearlRoom:n.id,wellBottom:i.id,topOfWell:o.id,lowRoom:a.id,machineRoom:s.id,dingyCloset:d.id,teaRoom:u.id,postsRoom:m.id,poolRoom:f.id,cave:g.id}}function ZV(t,e,r){let n=t.getEntity(e.cave),i=t.getEntity(r);n&&(n.get(P.RoomTrait).exits[P.Direction.DOWN]={destination:r}),i&&(i.get(P.RoomTrait).exits[P.Direction.UP]={destination:e.cave})}function JV(t,e){QV(t,e.topOfWell),QV(t,e.wellBottom),vce(t,e.wellBottom,e.topOfWell,e.wellBottom),_ce(t,e.pearlRoom),bce(t,e.riddleRoom),Ice(t,e.teaRoom),t.setStateValue("dungeo.tea_room.id",e.teaRoom),t.setStateValue("dungeo.posts_room.id",e.postsRoom),Oce(t,e.poolRoom),Sce(t,e.lowRoom),Ace(t,e.machineRoom),Rce(t,e.dingyCloset),t.setStateValue("dungeo.cage.dingy_closet_id",e.dingyCloset),t.setStateValue("dungeo.carousel.active",!1)}function QV(t,e){let r=t.createEntity("well",P.EntityType.ITEM);return r.add(new P.IdentityTrait({name:"well",aliases:["deep well","stone well"],description:"The well is constructed of ancient fitted stones. It descends into darkness, and you cannot see the bottom. A rope is attached to a windlass above the well.",properName:!1,article:"a"})),r.add(new P.SceneryTrait),t.moveEntity(r.id,e),r}function vce(t,e,r,n){let i=t.createEntity("bucket",P.EntityType.ITEM);return i.add(new P.IdentityTrait({name:"bucket",aliases:["wooden bucket","pail"],description:"A wooden bucket attached to a rope wound around a windlass.",properName:!1,article:"a",weight:5})),i.add(new P.ContainerTrait({capacity:{maxItems:5,maxWeight:20}})),i.add(new P.EnterableTrait),i.add(new P.OpenableTrait({isOpen:!0})),i.add(new P.VehicleTrait({vehicleType:"counterweight",blocksWalkingMovement:!0,requiresExitBeforeLeaving:!0,currentPosition:"bottom",positionRooms:{top:r,bottom:n},isOperational:!0})),i.add(new gi({hasWater:!1})),t.moveEntity(i.id,e),i}function _ce(t,e){let r=t.createEntity("pearl necklace",P.EntityType.ITEM);return r.add(new P.IdentityTrait({name:"pearl necklace",aliases:["necklace","pearls","string of pearls"],description:"A pearl necklace with hundreds of large pearls. It must be worth a fortune.",properName:!1,article:"a",weight:5,points:9})),r.add(new z({trophyCaseValue:5})),t.moveEntity(r.id,e),r}function bce(t,e){let r=t.createEntity("riddle inscription",P.EntityType.ITEM);return r.add(new P.IdentityTrait({name:"riddle inscription",aliases:["inscription","riddle","writing","carved writing","symbols"],description:'The inscription reads: "What has roots as nobody sees, is taller than trees, up, up it goes, and yet never grows?"',properName:!1,article:"a"})),r.add(new P.SceneryTrait),t.moveEntity(r.id,e),r}function Ice(t,e){let r=t.createEntity("dusty table",P.EntityType.ITEM);r.add(new P.IdentityTrait({name:"dusty table",aliases:["table","tea table"],description:"A small wooden table, covered in a thick layer of dust. It appears to have been used for serving tea long ago.",properName:!1,article:"a"})),r.add(new P.SceneryTrait),t.moveEntity(r.id,e);let n=t.createEntity("green paper",P.EntityType.ITEM);n.add(new P.IdentityTrait({name:"piece of paper",aliases:["paper","green paper","note","piece of green paper"],description:"A small piece of green paper with some writing on it.",properName:!1,article:"a",weight:2})),n.attributes.readText=`
     ============================================
              FROBOZZ MAGIC BOAT COMPANY
     ============================================

     Hello, Sailor!

     Instructions for use:

     To Inflate: Apply pump to valve.
     To Deflate: Open valve.
     To Patch: Apply patch to boat.

     WARNING: Boat should be properly deflated before
     leaving water as sharp objects may puncture it.

     ============================================`,t.moveEntity(n.id,e);let i=t.createEntity("eat-me cake",P.EntityType.ITEM);i.add(new P.IdentityTrait({name:"eat-me cake",aliases:["cake","eat me","eat-me","eat me cake","eat-me cake"],adjectives:["eat-me"],description:'A cake with "Eat Me" written on it in icing. You can make out a capital E on the icing.',properName:!1,article:"an",weight:5})),i.add(new P.EdibleTrait({servings:1,taste:"tasty"})),i.attributes.cakeType="eat-me",t.moveEntity(i.id,e);let o=t.createEntity("blue cake",P.EntityType.ITEM);o.add(new P.IdentityTrait({name:"blue cake",aliases:["cake","blue","blue-icing","blue icing cake","blue-icing cake"],adjectives:["blue"],description:"A cake with blue icing. You can make out a capital E on the icing.",properName:!1,article:"a",weight:5})),o.add(new P.EdibleTrait({servings:1,taste:"tasty"})),o.attributes.cakeType="blue-icing",t.moveEntity(o.id,e);let a=t.createEntity("red cake",P.EntityType.ITEM);a.add(new P.IdentityTrait({name:"red cake",aliases:["cake","red","red-icing","red icing cake","red-icing cake"],adjectives:["red"],description:"A cake with red icing. You can make out a capital E on the icing.",properName:!1,article:"a",weight:5})),a.add(new P.EdibleTrait({servings:1,taste:"awful"})),a.attributes.cakeType="red-icing",t.moveEntity(a.id,e);let s=t.createEntity("orange cake",P.EntityType.ITEM);s.add(new P.IdentityTrait({name:"orange cake",aliases:["cake","orange","orange-icing","orange icing cake","orange-icing cake"],adjectives:["orange"],description:"A cake with orange icing. You can make out a capital E on the icing.",properName:!1,article:"an",weight:5})),s.add(new P.EdibleTrait({servings:1,effects:["explode"]})),s.attributes.cakeType="orange-icing",t.moveEntity(s.id,e)}function Oce(t,e){let r=t.createEntity("pool of goop",P.EntityType.ITEM);r.add(new P.IdentityTrait({name:"pool of goop",aliases:["pool","goop","brown goop","brown stuff","leak"],description:"A pool of brown goop covers the depressed half of the room. It appears to be dripping from a leak in the ceiling.",properName:!1,article:"a"})),r.add(new P.SceneryTrait),t.moveEntity(r.id,e);let n=t.createEntity("tin of spices",P.EntityType.ITEM);n.add(new P.IdentityTrait({name:"tin of spices",aliases:["tin","spices","saffron","rare spices","tin of rare spices"],description:"A tin of rare spices. The aroma is exotic and enticing.",properName:!1,article:"a",weight:8,concealed:!0,points:5})),n.add(new z({trophyCaseValue:5})),t.moveEntity(n.id,e),t.setStateValue("dungeo.pool_room.pool_id",r.id),t.setStateValue("dungeo.pool_room.spices_id",n.id),t.setStateValue("dungeo.pool_room.room_id",e),t.setStateValue("dungeo.pool.dissolved",!1)}function Sce(t,e){let r=t.createEntity("robot",P.EntityType.ACTOR);return r.add(new P.IdentityTrait({name:"robot",aliases:["robot","mechanical man","machine","mechanical device"],description:"A metallic robot with a hinged panel on its chest. It appears to be waiting for instructions.",properName:!1,article:"a"})),r.add(new P.ActorTrait({isPlayer:!1})),r.add(new P.NpcTrait({behaviorId:"robot",isHostile:!1,canMove:!0,customProperties:{following:!1,buttonPushed:!1,homeRoomId:e}})),t.moveEntity(r.id,e),r}function Ace(t,e){let r=t.createEntity("triangular button",P.EntityType.ITEM);return r.add(new P.IdentityTrait({name:"triangular button",aliases:["button","small button","triangle button"],description:"A small triangular button set into the wall. It is too small for your finger to push.",properName:!1,article:"a"})),r.add(new P.SceneryTrait),t.moveEntity(r.id,e),r}function Rce(t,e){let r=t.createEntity("metal cage",P.EntityType.ITEM);r.add(new P.IdentityTrait({name:"metal cage",aliases:["cage","iron cage","wire cage"],description:"A strange wire cage with bars too close together to reach through. Something glows beneath it.",properName:!1,article:"a"})),r.add(new P.SceneryTrait),t.moveEntity(r.id,e);let n=t.createEntity("white crystal sphere",P.EntityType.ITEM);n.add(new P.IdentityTrait({name:"white crystal sphere",aliases:["sphere","crystal sphere","white sphere","crystal ball","crystal"],adjectives:["white"],description:"A perfectly smooth sphere of white crystal. It glows with an inner light.",properName:!1,article:"a",weight:5,points:6})),n.add(new z({trophyCaseValue:6})),n.add(new io({dingyClosetId:e})),t.moveEntity(n.id,e)}var ce=_(E());function eY(t){let e=t.createEntity("Round Room",ce.EntityType.ROOM);return e.add(new ce.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),e.add(new ce.IdentityTrait({name:"Round Room",aliases:["round room","circular room"],description:"You are in a circular room with passages off in eight directions.",properName:!0,article:"the"})),e.add(new Ia({isFixed:!1})),{roundRoom:e.id}}function tY(t,e){let r=t.createEntity("steel box",ce.EntityType.ITEM);r.add(new ce.IdentityTrait({name:"steel box",aliases:["box","steel box","dented box","dented steel box"],description:"A dented steel box. It appears to have survived quite a fall.",properName:!1,article:"a",weight:40})),r.add(new ce.ContainerTrait({capacity:{maxItems:5}})),r.add(new ce.OpenableTrait({isOpen:!1})),t.moveEntity(r.id,e.roundRoom);let n=t.createEntity("violin",ce.EntityType.ITEM);n.add(new ce.IdentityTrait({name:"violin",aliases:["violin","stradivarius","strad","fancy violin"],description:"A Stradivarius! This exquisite instrument is in perfect condition despite its surroundings. It must be worth a fortune.",properName:!1,article:"a",weight:10,points:10})),n.add(new z({trophyCaseValue:10})),new ce.AuthorModel(t.getDataStore(),t).moveEntity(n.id,r.id)}function rY(t,e,r){let n=t.getEntity(e.roundRoom),i=t.getEntity(r);n&&i&&(n.get(ce.RoomTrait).exits[ce.Direction.WEST]={destination:r},i.get(ce.RoomTrait).exits[ce.Direction.EAST]={destination:e.roundRoom})}function nY(t,e,r){let n=t.getEntity(e.roundRoom);if(n){let s=n.get(ce.RoomTrait);s.exits[ce.Direction.NORTHEAST]={destination:r.northSouthPassage},s.exits[ce.Direction.EAST]={destination:r.grailRoom},s.exits[ce.Direction.SOUTHEAST]={destination:r.windingPassage}}let i=t.getEntity(r.northSouthPassage);i&&(i.get(ce.RoomTrait).exits[ce.Direction.SOUTHWEST]={destination:e.roundRoom});let o=t.getEntity(r.grailRoom);o&&(o.get(ce.RoomTrait).exits[ce.Direction.WEST]={destination:e.roundRoom});let a=t.getEntity(r.windingPassage);a&&(a.get(ce.RoomTrait).exits[ce.Direction.NORTHWEST]={destination:e.roundRoom})}function iY(t,e,r){let n=t.getEntity(e.roundRoom),i=t.getEntity(r);if(n){let o=n.get(ce.RoomTrait);o.exits[ce.Direction.SOUTH]={destination:r},o.exits[ce.Direction.NORTH]={destination:r}}i&&(i.get(ce.RoomTrait).exits[ce.Direction.NORTH]={destination:e.roundRoom})}function oY(t,e,r){let n=t.getEntity(e.roundRoom),i=t.getEntity(r);n&&(n.get(ce.RoomTrait).exits[ce.Direction.NORTHWEST]={destination:r}),i&&(i.get(ce.RoomTrait).exits[ce.Direction.SOUTHEAST]={destination:e.roundRoom})}function aY(t,e,r){let n=t.getEntity(e.roundRoom),i=t.getEntity(r);n&&(n.get(ce.RoomTrait).exits[ce.Direction.SOUTHWEST]={destination:r}),i&&(i.get(ce.RoomTrait).exits[ce.Direction.NORTHEAST]={destination:e.roundRoom})}var D=_(E());function ru(t,e,r,n=!1,i=!0){let o=t.createEntity(e,D.EntityType.ROOM);return o.add(new D.RoomTrait({exits:{},isDark:n,isOutdoors:i})),o.add(new D.IdentityTrait({name:e,description:r,properName:!0,article:"the"})),o}function nn(t,e){let r=t.get(D.RoomTrait);if(r)for(let[n,i]of Object.entries(e))r.exits[n]={destination:i}}function sY(t){let e=t.createEntity("Frigid River-1",D.EntityType.ROOM);e.add(new D.RoomTrait({exits:{},isDark:!1,isOutdoors:!0})),e.add(new D.IdentityTrait({name:"Frigid River",aliases:["frigid river","river"],description:"You are on the Frigid River in the vicinity of the dam. The river flows quietly here. There is a landing on the west shore.",properName:!0,article:"the"})),e.add(new nt({isWaterRoom:!0,riverPosition:1}));let r=t.createEntity("Frigid River-2",D.EntityType.ROOM);r.add(new D.RoomTrait({exits:{},isDark:!1,isOutdoors:!0})),r.add(new D.IdentityTrait({name:"Frigid River",aliases:["frigid river","river"],description:"The river turns a corner here making it impossible to see the dam. The White Cliffs loom on the east bank, and large rocks prevent landing on the west.",properName:!0,article:"the"})),r.add(new nt({isWaterRoom:!0,riverPosition:2}));let n=t.createEntity("Frigid River-3",D.EntityType.ROOM);n.add(new D.RoomTrait({exits:{},isDark:!1,isOutdoors:!0})),n.add(new D.IdentityTrait({name:"Frigid River",aliases:["frigid river","river"],description:"The river descends here into a valley. There is a narrow beach on the east below the cliffs, and there is some shore on the west which may be suitable. In the distance a faint rumbling can be heard.",properName:!0,article:"the"})),n.add(new nt({isWaterRoom:!0,riverPosition:3}));let i=t.createEntity("Frigid River-4",D.EntityType.ROOM);i.add(new D.RoomTrait({exits:{},isDark:!1,isOutdoors:!0})),i.add(new D.IdentityTrait({name:"Frigid River",aliases:["frigid river","river"],description:"The river is running faster here, and the sound ahead appears to be that of rushing water. On the west shore is a sandy beach. A small area of beach can also be seen below the cliffs.",properName:!0,article:"the"})),i.add(new nt({isWaterRoom:!0,riverPosition:4}));let o=t.createEntity("Frigid River-5",D.EntityType.ROOM);o.add(new D.RoomTrait({exits:{},isDark:!1,isOutdoors:!0})),o.add(new D.IdentityTrait({name:"Frigid River",aliases:["frigid river","river"],description:"The sound of rushing water is nearly unbearable here. On the west shore is a large landing area.",properName:!0,article:"the"})),o.add(new nt({isWaterRoom:!0,riverPosition:5}));let a=ru(t,"Rocky Shore","This is the west shore of the river. An entrance to a cave is to the northwest. The shore is very rocky here.");a.add(new nt({canLaunchBoat:!0}));let s=ru(t,"Small Cave","This is a small cave whose exits are on the south and northwest.",!0,!1),c=ru(t,"White Cliffs Beach","This is a rocky, narrow strip of beach beside the cliffs. A narrow path leads north along the shore.");c.add(new nt({canLaunchBoat:!0}));let d=t.createEntity("White Cliffs Beach-2",D.EntityType.ROOM);d.add(new D.RoomTrait({exits:{},isDark:!1,isOutdoors:!0})),d.add(new D.IdentityTrait({name:"White Cliffs Beach",aliases:["white cliffs beach","beach","cliffs beach"],description:"This is a narrow strip of beach which runs along the base of the White Cliffs. The only path here is a narrow one, heading south along the cliffs.",properName:!0,article:""})),d.add(new nt({canLaunchBoat:!0}));let u=ru(t,"Sandy Beach","This is a large sandy beach at the shore of the river, which is flowing quickly by. A path runs beside the river to the south here.");u.add(new nt({canLaunchBoat:!0}));let m=ru(t,"Shore","This is the shore of the river. The river here seems somewhat treacherous. A path travels from north to south here, the south end quickly turning around a sharp corner.");m.add(new nt({canLaunchBoat:!0}));let f=t.createEntity("Aragain Falls",D.EntityType.ROOM);f.add(new D.RoomTrait({exits:{},isDark:!1,isOutdoors:!0,blockedExits:{[D.Direction.EAST]:"The rainbow is beautiful, but it looks far too insubstantial to walk on."}})),f.add(new D.IdentityTrait({name:"Aragain Falls",aliases:["aragain falls","falls","waterfall"],description:"You are at the top of Aragain Falls, an enormous waterfall with a drop of about 450 feet. The only path here is on the north end.",properName:!0,article:""}));let g=t.createEntity("On the Rainbow",D.EntityType.ROOM);g.add(new D.RoomTrait({exits:{},isDark:!1,isOutdoors:!0})),g.add(new D.IdentityTrait({name:"On the Rainbow",aliases:["on the rainbow","rainbow"],description:"You are on top of a rainbow (I bet you never thought you would walk on a rainbow), with a magnificent view of the falls. The rainbow travels east-west here.",properName:!0,article:""})),g.add(new nt({isRainbowRoom:!0}));let h=ru(t,"End of Rainbow","You are on a small, rocky beach on the continuation of the Frigid River past the falls. The beach is narrow due to the presence of the White Cliffs. The river canyon opens here, and sunlight shines in from above. A rainbow crosses over the falls to the west, and a narrow path continues to the southeast.");return h.add(new nt({isRainbowRoom:!0})),nn(e,{[D.Direction.DOWN]:r.id}),nn(r,{[D.Direction.DOWN]:n.id}),nn(n,{[D.Direction.DOWN]:i.id,[D.Direction.WEST]:a.id,[D.Direction.EAST]:c.id}),nn(i,{[D.Direction.DOWN]:o.id,[D.Direction.WEST]:u.id,[D.Direction.EAST]:d.id}),nn(o,{[D.Direction.WEST]:m.id}),nn(a,{[D.Direction.NORTHWEST]:s.id,[D.Direction.EAST]:n.id}),nn(s,{[D.Direction.SOUTH]:a.id}),nn(c,{[D.Direction.WEST]:n.id,[D.Direction.SOUTH]:d.id}),nn(d,{[D.Direction.WEST]:i.id,[D.Direction.NORTH]:c.id}),nn(u,{[D.Direction.EAST]:i.id,[D.Direction.SOUTH]:m.id}),nn(m,{[D.Direction.NORTH]:u.id,[D.Direction.SOUTH]:f.id,[D.Direction.EAST]:o.id}),nn(f,{[D.Direction.NORTH]:m.id}),nn(g,{[D.Direction.WEST]:f.id,[D.Direction.EAST]:h.id}),nn(h,{[D.Direction.WEST]:g.id}),{frigidRiver1:e.id,frigidRiver2:r.id,frigidRiver3:n.id,frigidRiver4:i.id,frigidRiver5:o.id,rockyShore:a.id,whiteCliffsBeach1:c.id,whiteCliffsBeach2:d.id,sandyBeach:u.id,shore:m.id,aragainFalls:f.id,onTheRainbow:g.id,endOfRainbow:h.id,smallCave:s.id}}function cY(t,e,r){let n=t.getEntity(r);n&&n.add(new nt({canLaunchBoat:!0,launchDestination:e.frigidRiver1}))}function dY(t,e,r){let n=t.getEntity(e.endOfRainbow);n&&(n.get(D.RoomTrait).exits[D.Direction.SOUTHEAST]={destination:r});let i=t.getEntity(r);i&&(i.get(D.RoomTrait).exits[D.Direction.NORTH]={destination:e.endOfRainbow})}function lY(t,e){Cce(t,e.endOfRainbow),wce(t,e.frigidRiver2),Nce(t,e.sandyBeach),Dce(t,e.smallCave),Lce(t,e.aragainFalls),Mce(t,e.aragainFalls),RL(t,e.rockyShore),RL(t,e.sandyBeach),RL(t,e.shore)}function Cce(t,e){let r=t.createEntity("pot of gold",D.EntityType.ITEM);return r.add(new D.IdentityTrait({name:"pot of gold",aliases:["pot","gold","gold coins","treasure pot"],description:"A small iron pot filled to the brim with gold coins. It is surprisingly heavy for its size.",properName:!1,article:"a",weight:5,points:10})),r.add(new z({trophyCaseValue:10})),t.moveEntity(r.id,e),r}function wce(t,e){let r=t.createEntity("buoy",D.EntityType.ITEM);r.add(new D.IdentityTrait({name:"red buoy",aliases:["buoy","red buoy","floating buoy","warning buoy"],description:"There is a red buoy here (probably a warning).",properName:!1,article:"a",weight:10})),r.add(new D.ContainerTrait({capacity:{maxItems:1,maxWeight:5}})),r.add(new D.OpenableTrait({isOpen:!1})),t.moveEntity(r.id,e);let n=t.createEntity("emerald",D.EntityType.ITEM);return n.add(new D.IdentityTrait({name:"large emerald",aliases:["emerald","green gem","large emerald","gem"],description:"A large emerald of exceptional clarity and color.",properName:!1,article:"a",weight:5,points:5})),n.add(new z({trophyCaseValue:10})),new D.AuthorModel(t.getDataStore(),t).moveEntity(n.id,r.id),r}function Nce(t,e){let r=t.createEntity("statue",D.EntityType.ITEM);return r.add(new D.IdentityTrait({name:"beautiful statue",aliases:["statue","sculpture","figure","figurine","small statue"],description:"A beautiful statue of an ancient adventurer, carved from a single piece of white marble. The craftsmanship is exquisite.",properName:!1,article:"a",weight:2,points:10})),r.add(new z({trophyCaseValue:13})),t.setStateValue("dungeo.statue.locationId",e),r}function Dce(t,e){let r=t.createEntity("shovel",D.EntityType.ITEM);r.add(new D.IdentityTrait({name:"shovel",aliases:["shovel","spade","large shovel"],description:"This is a large shovel, suitable for digging in sand or soft earth.",properName:!1,article:"a",weight:5})),t.moveEntity(r.id,e);let n=t.createEntity("guano",D.EntityType.ITEM);n.add(new D.IdentityTrait({name:"guano",aliases:["guano","bat guano","hunk of guano","bat droppings"],description:"There is a hunk of bat guano here.",properName:!1,article:"a",weight:5})),t.moveEntity(n.id,e)}function Lce(t,e){let r=t.createEntity("rainbow",D.EntityType.ITEM);return r.add(new D.IdentityTrait({name:"rainbow",aliases:["beautiful rainbow","arc"],description:"A beautiful rainbow can be seen over the falls and to the east.",properName:!1,article:"a"})),r.add(new D.SceneryTrait),t.moveEntity(r.id,e),r}function Mce(t,e){let r=t.createEntity("barrel",D.EntityType.ITEM);return r.add(new D.IdentityTrait({name:"barrel",aliases:["barrel","wooden barrel","man-sized barrel"],description:"There is a man-sized barrel here, which you might be able to enter.",properName:!1,article:"a"})),r.add(new D.ContainerTrait({capacity:{maxItems:1,maxWeight:200}})),t.moveEntity(r.id,e),r}function RL(t,e){let r=t.createEntity("river-"+e,D.EntityType.ITEM);return r.add(new D.IdentityTrait({name:"Frigid River",aliases:["river","water","frigid river","stream"],description:"The Frigid River flows swiftly past, its icy waters dark and cold.",properName:!0,article:"the"})),r.add(new D.SceneryTrait),r.attributes.isWaterBody=!0,r.attributes.displayName="Frigid River",t.moveEntity(r.id,e),r}var O=_(E());function eb(t,e,r,n=[]){let i=t.createEntity(e,O.EntityType.ROOM);return i.add(new O.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),i.add(new O.IdentityTrait({name:e,aliases:n,description:r,properName:!0,article:"the"})),i}function wr(t,e){let r=t.createEntity("Maze",O.EntityType.ROOM);return r.add(new O.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),r.add(new O.IdentityTrait({name:"Maze",aliases:["maze",`maze ${e}`,`maze${e}`],description:"You are in a maze of twisty little passages, all alike.",properName:!1,article:"the"})),r}function tb(t,e){let r=t.createEntity(`Dead End ${e}`,O.EntityType.ROOM);return r.add(new O.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),r.add(new O.IdentityTrait({name:"Dead End",aliases:["dead end",`dead end ${e}`,`deadend${e}`],description:"You have come to a dead end in the maze.",properName:!0,article:"the"})),r}function ut(t,e){let r=t.get(O.RoomTrait);if(r)for(let[n,i]of Object.entries(e))r.exits[n]={destination:i}}function uY(t){let e=eb(t,"Grating Room","You are in a small room near the surface. A metal grating in the ceiling leads upward.",["grating room","small room","room near surface"]),r=wr(t,1),n=wr(t,2),i=wr(t,3),o=wr(t,4),a=wr(t,5),s=wr(t,6),c=wr(t,7),d=wr(t,8),u=wr(t,9),m=wr(t,10),f=wr(t,11),g=wr(t,12),h=wr(t,13),y=wr(t,14),T=wr(t,15),I=tb(t,1),A=tb(t,2),L=tb(t,3),S=tb(t,4),R=eb(t,"Cyclops Room","This room has an exit on the northwest, and a staircase leading up.",["cyclops room"]),k=eb(t,"Strange Passage","This is a long passage. To the south is one entrance. On the east there is an old wooden door, with a large hole in it (about cyclops sized).",["strange passage","passage"]),w=eb(t,"Treasure Room","This is a large room, whose north wall is solid marble. A doorway leads south, and a narrow chimney leads up.",["treasure room","thief lair","thiefs lair"]),Te={gratingRoom:e.id,maze1:r.id,maze2:n.id,maze3:i.id,maze4:o.id,maze5:a.id,maze6:s.id,maze7:c.id,maze8:d.id,maze9:u.id,maze10:m.id,maze11:f.id,maze12:g.id,maze13:h.id,maze14:y.id,maze15:T.id,deadEnd1:I.id,deadEnd2:A.id,deadEnd3:L.id,deadEnd4:S.id,cyclopsRoom:R.id,strangePassage:k.id,treasureRoom:w.id};return Pce(t,Te),Te}function Pce(t,e){let r=t.getEntity(e.maze1);r&&ut(r,{[O.Direction.NORTH]:e.maze1,[O.Direction.SOUTH]:e.maze2,[O.Direction.EAST]:e.maze4});let n=t.getEntity(e.maze2);n&&ut(n,{[O.Direction.SOUTH]:e.maze1,[O.Direction.NORTH]:e.maze4,[O.Direction.EAST]:e.maze3});let i=t.getEntity(e.maze3);i&&ut(i,{[O.Direction.WEST]:e.maze2,[O.Direction.NORTH]:e.maze4,[O.Direction.UP]:e.maze5});let o=t.getEntity(e.maze4);o&&ut(o,{[O.Direction.WEST]:e.maze3,[O.Direction.NORTH]:e.maze1,[O.Direction.EAST]:e.deadEnd1});let a=t.getEntity(e.maze5);a&&ut(a,{[O.Direction.EAST]:e.deadEnd2,[O.Direction.NORTH]:e.maze3,[O.Direction.SOUTHWEST]:e.maze6});let s=t.getEntity(e.maze6);s&&ut(s,{[O.Direction.DOWN]:e.maze5,[O.Direction.EAST]:e.maze7,[O.Direction.WEST]:e.maze6,[O.Direction.UP]:e.maze9});let c=t.getEntity(e.maze7);c&&ut(c,{[O.Direction.UP]:e.maze14,[O.Direction.WEST]:e.maze6,[O.Direction.NORTHEAST]:e.deadEnd1,[O.Direction.EAST]:e.maze8,[O.Direction.SOUTH]:e.maze15});let d=t.getEntity(e.maze8);d&&ut(d,{[O.Direction.NORTHEAST]:e.maze7,[O.Direction.WEST]:e.maze8,[O.Direction.SOUTHEAST]:e.deadEnd3});let u=t.getEntity(e.maze9);u&&ut(u,{[O.Direction.NORTH]:e.maze6,[O.Direction.EAST]:e.maze11,[O.Direction.DOWN]:e.maze10,[O.Direction.SOUTH]:e.maze13,[O.Direction.WEST]:e.maze12,[O.Direction.NORTHWEST]:e.maze9});let m=t.getEntity(e.maze10);m&&ut(m,{[O.Direction.EAST]:e.maze9,[O.Direction.WEST]:e.maze13,[O.Direction.UP]:e.maze11});let f=t.getEntity(e.maze11);f&&ut(f,{[O.Direction.NORTHEAST]:e.gratingRoom,[O.Direction.DOWN]:e.maze10,[O.Direction.NORTHWEST]:e.maze13,[O.Direction.SOUTHWEST]:e.maze12});let g=t.getEntity(e.maze12);g&&ut(g,{[O.Direction.WEST]:e.maze5,[O.Direction.SOUTHWEST]:e.maze11,[O.Direction.EAST]:e.maze13,[O.Direction.UP]:e.maze9,[O.Direction.NORTH]:e.deadEnd4});let h=t.getEntity(e.maze13);h&&ut(h,{[O.Direction.EAST]:e.maze9,[O.Direction.DOWN]:e.maze12,[O.Direction.SOUTH]:e.maze10,[O.Direction.WEST]:e.maze11});let y=t.getEntity(e.maze14);y&&ut(y,{[O.Direction.WEST]:e.maze15,[O.Direction.NORTHWEST]:e.maze14,[O.Direction.NORTHEAST]:e.maze7,[O.Direction.SOUTH]:e.maze7});let T=t.getEntity(e.maze15);T&&ut(T,{[O.Direction.WEST]:e.maze14,[O.Direction.SOUTH]:e.maze7,[O.Direction.NORTHEAST]:e.cyclopsRoom});let I=t.getEntity(e.deadEnd1);I&&ut(I,{[O.Direction.SOUTH]:e.maze4});let A=t.getEntity(e.deadEnd2);A&&ut(A,{[O.Direction.WEST]:e.maze5});let L=t.getEntity(e.deadEnd3);L&&ut(L,{[O.Direction.NORTH]:e.maze8});let S=t.getEntity(e.deadEnd4);S&&ut(S,{[O.Direction.SOUTH]:e.maze12});let R=t.getEntity(e.gratingRoom);R&&ut(R,{[O.Direction.SOUTHWEST]:e.maze11});let k=t.getEntity(e.cyclopsRoom);k&&ut(k,{[O.Direction.WEST]:e.maze15,[O.Direction.UP]:e.treasureRoom});let w=t.getEntity(e.strangePassage);w&&ut(w,{[O.Direction.SOUTH]:e.cyclopsRoom});let Te=t.getEntity(e.treasureRoom);Te&&ut(Te,{[O.Direction.DOWN]:e.cyclopsRoom})}function mY(t,e,r){let n=t.getEntity(e.gratingRoom);if(n){let o=n.get(O.RoomTrait);o&&(o.exits[O.Direction.UP]={destination:r})}let i=t.getEntity(r);if(i){let o=i.get(O.RoomTrait);o&&(o.exits[O.Direction.DOWN]={destination:e.gratingRoom})}}function pY(t,e,r){let n=t.getEntity(e.cyclopsRoom);if(n){let o=n.get(O.RoomTrait);o&&(o.exits[O.Direction.NORTH]={destination:e.strangePassage})}let i=t.getEntity(e.strangePassage);if(i){let o=i.get(O.RoomTrait);o&&(o.exits[O.Direction.EAST]={destination:r})}}function fY(t,e,r){let n=t.getEntity(e.maze1);if(n){let o=n.get(O.RoomTrait);o&&(o.exits[O.Direction.WEST]={destination:r})}let i=t.getEntity(r);if(i){let o=i.get(O.RoomTrait);o&&(o.exits[O.Direction.SOUTH]={destination:e.maze1})}}function gY(t,e,r){let n=t.getEntity(r);if(n){let o=n.get(O.RoomTrait);o&&(o.exits[O.Direction.SOUTHWEST]={destination:e.maze1})}let i=t.getEntity(e.maze1);if(i){let o=i.get(O.RoomTrait);o&&(o.exits[O.Direction.NORTHEAST]={destination:r})}}function hY(t,e){kce(t,e.gratingRoom),Bce(t,e.maze5),xce(t,e.treasureRoom)}function kce(t,e){let r=t.createEntity("metal grating",O.EntityType.SCENERY);r.add(new O.IdentityTrait({name:"metal grating",aliases:["grating","grate","metal grate","iron grating"],description:"A metal grating is set into the ceiling, leading up to the surface. It appears to be locked.",properName:!1,article:"a"})),r.add(new O.SceneryTrait),r.add(new O.OpenableTrait({isOpen:!1})),r.add(new O.LockableTrait({startsLocked:!0,isLocked:!0})),t.moveEntity(r.id,e)}function Bce(t,e){let r=t.createEntity("skeleton",O.EntityType.SCENERY);r.add(new O.IdentityTrait({name:"skeleton",aliases:["skeleton","bones","remains","adventurer skeleton","dead adventurer"],description:"A skeleton lies here, the remains of some unfortunate adventurer who lost their way in this maze long ago.",properName:!1,article:"a"})),r.add(new O.SceneryTrait),t.moveEntity(r.id,e);let n=t.createEntity("bag of coins",O.EntityType.CONTAINER);n.add(new O.IdentityTrait({name:"leather bag of coins",aliases:["bag","leather bag","bag of coins","coins","coin bag"],description:"A leather bag containing a quantity of coins of various denominations.",properName:!1,article:"a",weight:5,points:10})),n.add(new O.ContainerTrait({capacity:{maxItems:10}})),n.add(new z({trophyCaseValue:5})),t.moveEntity(n.id,e);let i=t.createEntity("skeleton key",O.EntityType.ITEM);i.add(new O.IdentityTrait({name:"skeleton key",aliases:["key","skeleton key","rusty key","old key"],description:"An old skeleton key, probably dropped by the unfortunate adventurer whose remains lie nearby.",properName:!1,article:"a",weight:25})),i.attributes.unlocksId="metal grating",t.moveEntity(i.id,e);let o=t.createEntity("rusty knife",O.EntityType.ITEM);o.add(new O.IdentityTrait({name:"rusty knife",aliases:["knife","rusty knife","old knife"],description:"A rusty knife. It is almost totally rusted and quite useless as a weapon.",properName:!1,article:"a",weight:10})),t.moveEntity(o.id,e);let a=rG(t);t.moveEntity(a.id,e)}function xce(t,e){let r=t.createEntity("silver chalice",O.EntityType.ITEM);r.add(new O.IdentityTrait({name:"silver chalice",aliases:["chalice","silver cup","cup","goblet"],description:"A beautiful silver chalice, tarnished with age but still valuable. It bears an inscription in an ancient language.",properName:!1,article:"a",weight:40,points:10})),r.add(new z({trophyCaseValue:10})),t.moveEntity(r.id,e)}var q=_(E());var jce="dungeo.exorcism.spirits_block";function _o(t,e,r,n=!1){let i=t.createEntity(e,q.EntityType.ROOM);return i.add(new q.RoomTrait({exits:{},isDark:n,isOutdoors:!1})),i.add(new q.IdentityTrait({name:e,description:r,properName:!1,article:"the"})),i}function bo(t,e){let r=t.get(q.RoomTrait);if(r)for(let[n,i]of Object.entries(e))r.exits[n]={destination:i}}function yY(t){let e=_o(t,"Top of Stairs","This is a room with an exit on the west side, and a staircase leading up."),r=_o(t,"Stone Room","This is a small stone room with passages leading north and south. Set into one wall is a stone button."),n=_o(t,"Small Room","This is a small room, with narrow passages exiting to the north and south. A narrow red beam of light crosses the room at the north end, inches above the floor.");t.setStateValue("endgame.laserBeamActive",!0);let i=_o(t,"Hallway",`This is part of the long hallway. The east and west walls are dressed stone. In the center of the hall is a shallow stone channel. In the center of the room the channel widens into a large hole around which is engraved a compass rose. Sitting in the center of the room is a strange wooden structure.

Identical stone statues face each other from pedestals on opposite sides of the corridor. The statues represent Guardians of Zork, a military order of ancient lineage. They are portrayed as heavily armored warriors standing at ease, hands clasped around formidable bludgeons.`),o=_o(t,"Inside Mirror",`You are inside a rectangular box of wood whose structure is rather complicated. Four sides and the roof are filled in, and the floor is open.

As you face the side opposite the entrance, two short sides of carved and polished wood are to your left and right. The left panel is mahogany, the right pine. The wall you face is red on its left half and black on its right. On the entrance side, the wall is white opposite the red part of the wall it faces, and yellow opposite the black section. The painted walls are at least twice the length of the unpainted ones. The ceiling is painted blue.

In the floor is a stone channel about six inches wide and a foot deep. The channel is oriented in a north-south direction. In the exact center of the room the channel widens into a circular depression perhaps two feet wide. Incised in the stone around this area is a compass rose.

Running from one short wall to the other at about waist height is a wooden bar, carefully carved and drilled. This bar is pierced in two places. Through each hole runs a wooden pole.`);t.setStateValue("insideMirror.direction",0),t.setStateValue("insideMirror.position",0),t.setStateValue("insideMirror.poleState",1);let a=_o(t,"Dungeon Entrance","This is a north-south hallway which ends in a large wooden door. The wooden door has a barred panel in it at about head height.");t.setStateValue("trivia.questionsAnswered",0),t.setStateValue("trivia.wrongAttempts",0),t.setStateValue("trivia.currentQuestion",-1);let s=_o(t,"Narrow Corridor","This is a narrow north-south corridor. At the south end is a door and at the north end is an east-west corridor.");s.attributes.awardsPointsOnEntry=20;let c=_o(t,"East-West Corridor","This is a large east-west corridor which opens out to a northern parapet at its center. You can see flames and smoke as you peer towards the parapet. The corridor turns south at its east and west ends, and due south is a massive wooden door. In the door is a small window barred with iron."),d=_o(t,"Parapet",`You are standing behind a stone retaining wall which rims a large parapet overlooking a fiery pit. It is difficult to see through the smoke and flame which fills the pit, but it seems to be more or less bottomless. It also extends upwards out of sight. The pit itself is of roughly dressed stone and is circular in shape. It is about two hundred feet in diameter. The flames generate considerable heat, so it is rather uncomfortable standing here.

There is an object here which looks like a sundial. On it are an indicator arrow and (in the center) a large button. On the face of the dial are numbers "one" through "eight".`);t.setStateValue("parapet.dialSetting",1);let u=_o(t,"Prison Cell","This is a featureless prison cell. You can see only the flames and smoke of the pit out of the small window in a closed wooden door in front of you.");t.setStateValue("prisonCell.currentCell",null),t.setStateValue("prisonCell.bronzeDoorVisible",!1);let m=t.createEntity("Treasury of Zork",q.EntityType.ROOM);m.add(new q.RoomTrait({exits:{},isDark:!1,isOutdoors:!1})),m.add(new q.IdentityTrait({name:"Treasury of Zork",aliases:["treasury","treasury of zork"],description:"This is the Treasury of Zork. You have reached the end of your journey! Untold riches surround you - gold, gems, and artifacts beyond measure.",properName:!0,article:"the"})),m.attributes.isVictoryRoom=!0,m.attributes.awardsPointsOnEntry=35;let f=t.createEntity("Entrance to Hades",q.EntityType.ROOM);f.add(new q.RoomTrait({exits:{},isDark:!0,isOutdoors:!1,blockedExits:{[q.Direction.EAST]:jce}})),f.add(new q.IdentityTrait({name:"Entrance to Hades",aliases:["entrance to hades","hades entrance","gates of hades"],description:"You are at the entrance to Hades, the land of the dead. An eerie mist swirls around you. Ghostly figures seem to hover in the air, blocking passage to the east. A corridor leads north.",properName:!0,article:"the"})),f.add(new $c({spiritsBlocking:!0}));let g=t.createEntity("Land of the Dead",q.EntityType.ROOM);g.add(new q.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),g.add(new q.IdentityTrait({name:"Land of the Dead",aliases:["land of dead","land of the dead","hades"],description:"You have entered the Land of the Dead. The air is cold and still. Ghostly shapes drift silently in the darkness. This is not a place for the living. A faint glow emanates from the north.",properName:!0,article:"the"}));let h=t.createEntity("Tomb of the Unknown Implementer",q.EntityType.ROOM);return h.add(new q.RoomTrait({exits:{},isDark:!0,isOutdoors:!1})),h.add(new q.IdentityTrait({name:"Tomb of the Unknown Implementer",aliases:["tomb","tomb of unknown implementer","tomb of the unknown implementer"],description:`This is the Tomb of the Unknown Implementer. A hollow voice says, "That's not a bug, it's a feature!" In the north wall of the room is the Crypt of the Implementers. It is made of the finest marble and is apparently large enough for four headless corpses. Above the entrance is the cryptic inscription: "Feel Free". To the south is a small opening, apparently of recent origin.`,properName:!0,article:"the"})),bo(e,{[q.Direction.WEST]:r.id}),bo(r,{[q.Direction.EAST]:e.id,[q.Direction.SOUTH]:n.id}),bo(n,{[q.Direction.NORTH]:r.id,[q.Direction.SOUTH]:i.id}),bo(i,{[q.Direction.NORTH]:n.id,[q.Direction.SOUTH]:a.id,[q.Direction.IN]:o.id}),bo(s,{[q.Direction.SOUTH]:a.id,[q.Direction.NORTH]:c.id}),bo(c,{[q.Direction.SOUTH]:s.id,[q.Direction.NORTH]:d.id}),bo(d,{[q.Direction.SOUTH]:c.id}),bo(f,{[q.Direction.EAST]:g.id}),bo(g,{[q.Direction.WEST]:f.id,[q.Direction.EAST]:h.id}),bo(h,{[q.Direction.WEST]:g.id}),t.setStateValue("endgame.topOfStairsId",e.id),t.setStateValue("endgame.insideMirrorId",o.id),{topOfStairs:e.id,stoneRoom:r.id,smallRoom:n.id,hallway:i.id,insideMirror:o.id,dungeonEntrance:a.id,narrowCorridor:s.id,eastWestCorridor:c.id,parapet:d.id,prisonCell:u.id,treasury:m.id,entryToHades:f.id,landOfDead:g.id,tomb:h.id}}function TY(t,e){Wce(t,e.smallRoom),Uce(t,e.stoneRoom),Hce(t,e.parapet),qce(t,e.parapet),Gce(t,e.insideMirror),Fce(t,e.insideMirror),Vce(t,e.insideMirror),Yce(t,e.insideMirror),zce(t,e.insideMirror),Kce(t,e.insideMirror),$ce(t,e.prisonCell)}function Wce(t,e){let r=t.createEntity("laser beam",q.EntityType.SCENERY);return r.add(new q.IdentityTrait({name:"laser beam",aliases:["beam","red beam","light beam","narrow beam","beam of light"],description:"A narrow red beam of light crosses the room at the north end, inches above the floor.",article:"a"})),r.add(new q.SceneryTrait),t.moveEntity(r.id,e),r.attributes.isLaserBeam=!0,r}function Uce(t,e){let r=t.createEntity("stone button",q.EntityType.OBJECT);return r.add(new q.IdentityTrait({name:"stone button",aliases:["button","stone button"],description:"A stone button is set into the wall. It looks like it can be pushed.",article:"a"})),r.add(new q.SceneryTrait),t.moveEntity(r.id,e),r.attributes.isPushable=!0,r.attributes.buttonType="stone",r}function Hce(t,e){let r=t.createEntity("sundial",q.EntityType.OBJECT);return r.add(new q.IdentityTrait({name:"sundial",aliases:["sundial","dial","sun dial"],description:'An object that looks like a sundial. On it are an indicator arrow and (in the center) a large button. On the face of the dial are numbers "one" through "eight".',article:"a"})),r.add(new q.SceneryTrait),t.moveEntity(r.id,e),r.attributes.isDial=!0,r}function qce(t,e){let r=t.createEntity("dial button",q.EntityType.OBJECT);return r.add(new q.IdentityTrait({name:"button",aliases:["button","dial button","large button"],description:"A large button in the center of the dial.",article:"a"})),r.add(new q.SceneryTrait),t.moveEntity(r.id,e),r.attributes.isPushable=!0,r.attributes.buttonType="dial",r}function Gce(t,e){let r=t.createEntity("short pole",q.EntityType.OBJECT);return r.add(new q.IdentityTrait({name:"short pole",aliases:["short pole","pole","left pole"],description:"The pole at the left end of the bar is short, extending about a foot above the bar, and ends in a hand grip.",article:"a"})),r.add(new q.SceneryTrait),t.moveEntity(r.id,e),r.attributes.isPole=!0,r.attributes.poleType="short",r}function Fce(t,e){let r=t.createEntity("long pole",q.EntityType.OBJECT);return r.add(new q.IdentityTrait({name:"long pole",aliases:["long pole","pole","center pole","t-bar"],description:"The long pole at the center of the bar extends from the ceiling through the bar to the circular area in the stone channel. The bottom end of this pole has a T-bar a bit less than two feet long attached to it. On the T-bar is carved an arrow.",article:"a"})),r.add(new q.SceneryTrait),t.moveEntity(r.id,e),r.attributes.isPole=!0,r.attributes.poleType="long",r}function Vce(t,e){let r=t.createEntity("mahogany panel",q.EntityType.OBJECT);return r.add(new q.IdentityTrait({name:"mahogany panel",aliases:["mahogany panel","mahogany wall","mahogany","left panel","left wall"],description:"The mahogany panel is smooth and well-polished. It forms one of the short walls of the structure.",article:"a"})),r.add(new q.SceneryTrait),t.moveEntity(r.id,e),r.attributes.isPanel=!0,r.attributes.panelType="mahogany",r}function Yce(t,e){let r=t.createEntity("pine panel",q.EntityType.OBJECT);return r.add(new q.IdentityTrait({name:"pine panel",aliases:["pine panel","pine wall","pine","right panel","right wall","pine door"],description:"The pine panel is sturdy but plain. It forms one of the short walls of the structure.",article:"a"})),r.add(new q.SceneryTrait),t.moveEntity(r.id,e),r.attributes.isPanel=!0,r.attributes.panelType="pine",r}function zce(t,e){let r=t.createEntity("red panel",q.EntityType.OBJECT);return r.add(new q.IdentityTrait({name:"red panel",aliases:["red panel","red wall","red","red section"],description:"The red panel is painted a deep crimson. It forms part of the long wall opposite the entrance.",article:"a"})),r.add(new q.SceneryTrait),t.moveEntity(r.id,e),r.attributes.isPanel=!0,r.attributes.panelType="red",r}function Kce(t,e){let r=t.createEntity("yellow panel",q.EntityType.OBJECT);return r.add(new q.IdentityTrait({name:"yellow panel",aliases:["yellow panel","yellow wall","yellow","yellow section"],description:"The yellow panel is painted a bright gold color. It forms part of the wall on the entrance side.",article:"a"})),r.add(new q.SceneryTrait),t.moveEntity(r.id,e),r.attributes.isPanel=!0,r.attributes.panelType="yellow",r}function $ce(t,e){let r=t.createEntity("bronze door",q.EntityType.OBJECT);return r.add(new q.IdentityTrait({name:"bronze door",aliases:["bronze door","door"],description:"A heavy bronze door.",article:"a"})),r.add(new q.SceneryTrait),r.add(new q.OpenableTrait({isOpen:!1})),t.moveEntity(r.id,e),r.attributes.isTreasuryDoor=!0,r}var on=_(E()),OY=_(Ve());var wn={HERO_ATTACK:"dungeo.melee.hero_attack",VILLAIN_ATTACK:"dungeo.melee.villain_attack",STILL_RECOVERING:"dungeo.melee.still_recovering",UNARMED_ATTACK:"dungeo.melee.unarmed_attack",BACKUP_WEAPON:"dungeo.melee.backup_weapon",VILLAIN_DISARMED:"dungeo.melee.villain_disarmed"},Qce={[v.MISSED]:["Your swing misses the {villain} by an inch.","A mighty blow, but it misses the {villain} by a mile.","You charge, but the {villain} jumps nimbly aside.","Clang! Crash! The {villain} parries.","A good stroke, but it's too slow; the {villain} dodges."],[v.UNCONSCIOUS]:["Your sword crashes down, knocking the {villain} into dreamland.","The {villain} is battered into unconsciousness.","A furious exchange, and the {villain} is knocked out!"],[v.KILLED]:["It's curtains for the {villain} as your sword removes his head.","The fatal blow strikes the {villain} square in the heart: He dies.","The {villain} takes a final blow and slumps to the floor dead."],[v.LIGHT_WOUND]:["The {villain} is struck on the arm; blood begins to trickle down.","Your sword pinks the {villain} on the wrist, but it's not serious.","Your stroke lands, but it was only the flat of the blade.","The blow lands, making a shallow gash in the {villain}'s arm!"],[v.SERIOUS_WOUND]:["The {villain} receives a deep gash in his side.","A savage blow on the thigh! The {villain} is stunned but can still fight!","Slash! Your blow lands! That one hit an artery; it could be serious!"],[v.STAGGER]:["The {villain} is staggered, and drops to his knees.","The {villain} is momentarily disoriented and can't fight back.","The force of your blow knocks the {villain} back, stunned."],[v.LOSE_WEAPON]:["The {villain}'s weapon is knocked to the floor, leaving him unarmed."],[v.HESITATE]:[],[v.SITTING_DUCK]:[]},EY={[v.MISSED]:["Your stab misses the {villain} by an inch.","A good slash, but it misses the {villain} by a mile.","You charge, but the {villain} jumps nimbly aside.","A quick stroke, but the {villain} is on guard.","A good stroke, but it's too slow; the {villain} dodges."],[v.UNCONSCIOUS]:["The haft of your knife knocks out the {villain}.","The {villain} drops to the floor, unconscious.","The {villain} is knocked out!"],[v.KILLED]:["The end for the {villain} as your knife severs his jugular.","The fatal thrust strikes the {villain} square in the heart: He dies.","The {villain} takes a final blow and slumps to the floor dead."],[v.LIGHT_WOUND]:["The {villain} is slashed on the arm; blood begins to trickle down.","Your knife point pinks the {villain} on the wrist, but it's not serious.","Your stroke lands, but it was only the flat of the blade.","The blow lands, making a shallow gash in the {villain}'s arm!"],[v.SERIOUS_WOUND]:["The {villain} receives a deep gash in his side.","A savage cut on the leg stuns the {villain}, but he can still fight!","Slash! Your stroke connects! The {villain} could be in serious trouble!"],[v.STAGGER]:["The {villain} drops to his knees, staggered.","The {villain} is confused and can't fight back.","The quickness of your thrust knocks the {villain} back, stunned."],[v.LOSE_WEAPON]:["The {villain} is disarmed by a subtle feint past his guard."],[v.HESITATE]:[],[v.SITTING_DUCK]:[]},Xce={[v.MISSED]:["The Cyclops misses, but the backwash almost knocks you over.","The Cyclops rushes you, but runs into the wall.","The Cyclops trips over his feet trying to get at you.","The Cyclops unleashes a roundhouse punch, but you have time to dodge."],[v.UNCONSCIOUS]:["The Cyclops knocks you unconscious.","The Cyclops sends you crashing to the floor, unconscious."],[v.KILLED]:["The Cyclops raises his arms and crushes your skull.","The Cyclops has just essentially ripped you to shreds.","The Cyclops decks you. In fact, you are dead.","The Cyclops breaks your neck with a massive smash."],[v.LIGHT_WOUND]:["A quick punch, but it was only a glancing blow.","The Cyclops grabs but you twist free, leaving part of your cloak.","A glancing blow from the Cyclops' fist.","The Cyclops chops at you with the side of his hand, and it connects, but not solidly."],[v.SERIOUS_WOUND]:["The Cyclops gets a good grip and breaks your arm.","The monster smashes his huge fist into your chest, breaking several ribs.","The Cyclops almost knocks the wind out of you with a quick punch.","A flying drop kick breaks your jaw.","The Cyclops breaks your leg with a staggering blow."],[v.STAGGER]:["The Cyclops knocks you silly, and you reel back.","The Cyclops lands a punch that knocks the wind out of you.","Heedless of your weapons, the Cyclops tosses you against the rock wall of the room.","The Cyclops grabs you, and almost strangles you before you wiggle free, breathless."],[v.LOSE_WEAPON]:["The Cyclops grabs you by the arm, and you drop your {weapon}.","The Cyclops kicks your {weapon} out of your hand.","The Cyclops grabs your {weapon}, tastes it, and throws it to the ground in disgust.","The monster grabs you on the wrist, squeezes, and you drop your {weapon} in pain."],[v.HESITATE]:["The Cyclops is so excited by his success that he neglects to kill you.","The Cyclops, momentarily overcome by remorse, holds back.","The Cyclops seems unable to decide whether to broil or stew his dinner."],[v.SITTING_DUCK]:["The Cyclops, no sportsman, dispatches his unconscious victim."]},vY={[v.MISSED]:["The troll swings his axe, but it misses.","The troll's axe barely misses your ear.","The axe sweeps past as you jump aside.","The axe crashes against the rock, throwing sparks!"],[v.UNCONSCIOUS]:["The flat of the troll's axe hits you delicately on the head, knocking you out."],[v.KILLED]:["The troll lands a killing blow. You are dead.","The troll neatly removes your head.","The troll's axe stroke cleaves you from the nave to the chops.","The troll's axe removes your head."],[v.LIGHT_WOUND]:["The axe gets you right in the side. Ouch!","The flat of the troll's axe skins across your forearm.","The troll's swing almost knocks you over as you barely parry in time.","The troll swings his axe, and it nicks your arm as you dodge."],[v.SERIOUS_WOUND]:["The troll charges, and his axe slashes you on your {weapon} arm.","An axe stroke makes a deep wound in your leg.","The troll's axe swings down, gashing your shoulder.","The troll sees a hole in your defense, and a lightning stroke opens a wound in your left side."],[v.STAGGER]:["The troll hits you with a glancing blow, and you are momentarily stunned.","The troll swings; the blade turns on your armor but crashes broadside into your head.","You stagger back under a hail of axe strokes.","The troll's mighty blow drops you to your knees."],[v.LOSE_WEAPON]:["The axe hits your {weapon} and knocks it spinning.","The troll swings, you parry, but the force of his blow disarms you.","The axe knocks your {weapon} out of your hand. It falls to the floor.","Your {weapon} is knocked out of your hands, but you parried the blow."],[v.HESITATE]:["The troll strikes at your unconscious form, but misses in his rage.","The troll hesitates, fingering his axe.","The troll scratches his head ruminatively: Might you be magically protected, he wonders?","The troll seems afraid to approach your crumpled form."],[v.SITTING_DUCK]:["Conquering his fears, the troll puts you to death."]},Zce={[v.MISSED]:["The thief stabs nonchalantly with his stiletto and misses.","You dodge as the thief comes in low.","You parry a lightning thrust, and the thief salutes you with a grim nod.","The thief tries to sneak past your guard, but you twist away."],[v.UNCONSCIOUS]:["Shifting in the midst of a thrust, the thief knocks you unconscious with the haft of his stiletto.","The thief knocks you out."],[v.KILLED]:["Finishing you off, a lightning throw right to the heart.","The stiletto severs your jugular. It looks like the end.","The thief comes in from the side, feints, and inserts the blade into your ribs.","The thief bows formally, raises his stiletto, and with a wry grin, ends the battle and your life."],[v.LIGHT_WOUND]:["A quick thrust pinks your left arm, and blood starts to trickle down.","The thief draws blood, raking his stiletto across your arm.","The stiletto flashes faster than you can follow, and blood wells from your leg.","The thief slowly approaches, strikes like a snake, and leaves you wounded."],[v.SERIOUS_WOUND]:["The thief strikes like a snake! The resulting wound is serious.","The thief stabs a deep cut in your upper arm.","The stiletto touches your forehead, and the blood obscures your vision.","The thief strikes at your wrist, and suddenly your grip is slippery with blood."],[v.STAGGER]:["The butt of his stiletto cracks you on the skull, and you stagger back.","You are forced back, and trip over your own feet, falling heavily to the floor.","The thief rams the haft of his blade into your stomach, leaving you out of breath.","The thief attacks, and you fall back desperately."],[v.LOSE_WEAPON]:["A long, theatrical slash. You catch it on your {weapon}, but the thief twists his knife, and the {weapon} goes flying.","The thief neatly flips your {weapon} out of your hands, and it drops to the floor.","You parry a low thrust, and your {weapon} slips out of your hand.","Avoiding the thief's stiletto, you stumble to the floor, dropping your {weapon}."],[v.HESITATE]:["The thief, a man of good breeding, refrains from attacking a helpless opponent.","The thief amuses himself by searching your pockets.","The thief entertains himself by rifling your pack."],[v.SITTING_DUCK]:["The thief, noticing you begin to stir, reluctantly finishes you off.","The thief, forgetting his essentially genteel upbringing, cuts your throat.","The thief, who is essentially a pragmatist, dispatches you as a threat to his livelihood."]},Jce={sword:Qce,knife:EY},ede={troll:vY,thief:Zce,cyclops:Xce};function _Y(t,e,r,n){let i=t.toLowerCase().includes("sword")?"sword":"knife",a=(Jce[i]??EY)[e];return!a||a.length===0?void 0:n(a).replace(/\{villain\}/g,r)}function bY(t,e,r,n){let o=(ede[t]??vY)[e];return!o||o.length===0?void 0:n(o).replace(/\{weapon\}/g,r)}var tde=(0,OY.createSeededRandom)();function SY(t){let r=t.get(on.TraitType.IDENTITY)?.name?.toLowerCase()??"";return r.includes("troll")?"troll":r.includes("thief")?"thief":r.includes("cyclops")?"cyclops":"troll"}function rde(t){return SY(t)}function nde(t){return!t||t.toLowerCase().includes("sword")?"sword":"knife"}function ide(t){return t.getScore()}function IY(t){let e=t.attributes[pe.VILLAIN_OSTRENGTH];if(typeof e=="number")return e;let r=Pl(t);return t.attributes[pe.VILLAIN_OSTRENGTH]=r,r}function ode(t,e,r,n){let i=r.getLocation(e.id),o=i?r.getEntity(i):void 0;switch(t){case"troll":{o&&on.RoomBehavior.unblockExit(o,on.Direction.NORTH);let a=r.getContents(e.id);for(let s of a)r.removeEntity(s.id);return r.removeEntity(e.id),!0}case"thief":{let a=e.attributes.stilettoId,s=r.getContents(e.id),c=!1;for(let g of s)g.id!==a&&(r.moveEntity(g.id,i??null),c=!0);r.setMaxScore(650),r.getDataStore().state["dungeo.thief.dead"]=!0,r.getDataStore().state["dungeo.reality_altered_pending"]=!0;let u=e.get(on.TraitType.NPC)?.customProperties?.lairRoomId??i,m=eG(r);if(r.moveEntity(m.id,u),u){let g=r.getContents(u);for(let h of g){let y=h.get(on.TraitType.IDENTITY);y?.concealed&&(y.concealed=!1)}}r.getDataStore().state["dungeo.thief.disabled"]=!0,a&&r.removeEntity(a),r.removeEntity(e.id);let f=[];return c&&f.push("The thief's ill-gotten gains scatter across the floor."),f.push("Almost as soon as the thief breathes his last breath, a cloud of sinister black fog envelops him, and when the fog lifts, the carcass has disappeared."),n.deathMessages=f,!0}}return!1}var AY={preValidate(t,e,r,n){let i=e.getEntity(r);return i&&i.attributes[pe.STAGGERED]?(i.attributes[pe.STAGGERED]=!1,{valid:!1,error:wn.STILL_RECOVERING}):null},postExecute(t,e,r,n){let i=e.getEntity(r);if(!i)return;let o=tde,a=n.weaponName,s=SY(t),c=rde(t),d=ide(e),u=i.attributes[pe.WOUND_ADJUST]??0,m=Math.max(1,Sa(d,u)),f=IY(t),g=t.attributes.thiefEngrossed===!0,h=mG(s,a??""),y=u_(f,g,h>0,h),T=t.attributes[pe.VILLAIN_UNCONSCIOUS]===!0,A=m_(m,T?f:y,!0,T,o),L=!1,S=!1,R=[];switch(A.outcome){case v.KILLED:case v.SITTING_DUCK:L=!0,t.attributes[pe.VILLAIN_OSTRENGTH]=0,t.attributes[pe.VILLAIN_UNCONSCIOUS]=!1;break;case v.UNCONSCIOUS:S=!0,t.attributes[pe.VILLAIN_UNCONSCIOUS]=!0,t.attributes[pe.VILLAIN_OSTRENGTH]=-f;break;case v.LIGHT_WOUND:t.attributes[pe.VILLAIN_OSTRENGTH]=A.newDefenderStrength,A.defenderKilled&&(L=!0);break;case v.SERIOUS_WOUND:t.attributes[pe.VILLAIN_OSTRENGTH]=A.newDefenderStrength,A.defenderKilled&&(L=!0);break;case v.STAGGER:t.attributes[pe.VILLAIN_STAGGERED]=!0;break;case v.LOSE_WEAPON:{let Te=e.getContents(t.id),Oe=e.getLocation(t.id)??null;for(let ue of Te)if(ue.has(on.TraitType.WEAPON)){e.moveEntity(ue.id,Oe),R.push(ue.id);break}}break}if(L){let Te=t.get(on.TraitType.COMBATANT);if(Te&&(Te.health=0,Te.isAlive=!1,Te.isConscious=!1),!ode(s,t,e,n)){let Oe=e.getContents(t.id),ue=e.getLocation(t.id)??null;for(let mt of Oe)e.moveEntity(mt.id,ue),R.push(mt.id)}}let k=nde(a),w=_Y(k,A.outcome,c,Te=>o.pick(Te))??"You attack.";n.attackResult={success:!0,type:L?"killed":S?"knocked_out":A.outcome===v.MISSED?"missed":"hit",damage:0,remainingHitPoints:IY(t),targetDestroyed:!1,targetKilled:L,targetKnockedOut:S,itemsDropped:R.length>0?R:void 0},n.customMessage=wn.HERO_ATTACK,n.usedCombatService=!1,n.meleeMessage=w,n.meleeOutcome=A.outcome,n.meleeTargetKilled=L},postReport(t,e,r,n){let i=[],o=n.meleeMessage;o&&i.push((0,on.createEffect)("game.message",{messageId:wn.HERO_ATTACK,text:o}));let a=n.deathMessages;if(a)for(let s of a)i.push((0,on.createEffect)("game.message",{text:s}));return i},onBlocked(t,e,r,n,i){return n===wn.STILL_RECOVERING?[(0,on.createEffect)("game.message",{messageId:wn.STILL_RECOVERING,text:"You are still recovering from a staggering blow."})]:null}};var RY=_(Ve()),CY=_(E()),wY=_(zi());var ade=(0,RY.createSeededRandom)();function sde(t){return`${t}_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}function rb(t,e,r){return{id:sde("npc_melee"),type:t,timestamp:Date.now(),entities:r?{actor:r}:{},data:e}}function cde(t){let r=t.get(CY.TraitType.IDENTITY)?.name?.toLowerCase()??"";return r.includes("troll")?"troll":r.includes("thief")?"thief":r.includes("cyclops")?"cyclops":"troll"}function dde(t){return t.getScore()}function lde(t){let e=t.attributes[pe.VILLAIN_OSTRENGTH];if(typeof e=="number")return e;let r=Pl(t);return t.attributes[pe.VILLAIN_OSTRENGTH]=r,r}function NY(t,e,r,n){if(!e.isPlayer)return[];let i=ade,o=cde(t),a=[];if(t.attributes[pe.VILLAIN_STAGGERED])return t.attributes[pe.VILLAIN_STAGGERED]=!1,a.push(rb("game.message",{messageId:"dungeo.melee.villain_recovers",text:`The ${o} slowly regains his composure.`},t.id)),a;let s=lde(t);if(s<=0)return[];let c=t.attributes.thiefEngrossed===!0,d=u_(s,c),u=dde(r),m=e.attributes[pe.WOUND_ADJUST]??0,f=Math.max(1,Sa(u,m)),g=e.attributes[pe.STAGGERED]===!0,h=m_(d,f,!1,g,i),y=(0,wY.findWieldedWeapon)(e,r),T=y?.name??"weapon",I=Sa(u,0,!1);switch(h.outcome){case v.MISSED:case v.HESITATE:break;case v.STAGGER:e.attributes[pe.STAGGERED]=!0;break;case v.LIGHT_WOUND:{let L=hN(m,h,I);e.attributes[pe.WOUND_ADJUST]=L,gN(u,L)&&CL(a,t,e);break}case v.SERIOUS_WOUND:{let L=hN(m,h,I);e.attributes[pe.WOUND_ADJUST]=L,gN(u,L)&&CL(a,t,e);break}case v.LOSE_WEAPON:if(y){let L=r.getLocation(e.id);L&&r.moveEntity(y.id,L)}break;case v.UNCONSCIOUS:break;case v.KILLED:case v.SITTING_DUCK:CL(a,t,e);break}let A=bY(o,h.outcome,T,L=>i.pick(L))??`The ${o} attacks!`;return a.unshift(rb("game.message",{messageId:"dungeo.melee.villain_attack",text:A},t.id)),a.push(rb("npc.attacked",{npc:t.id,target:e.id,outcome:h.outcome},t.id)),a}function CL(t,e,r){t.push(rb("if.event.death",{target:r.id,targetName:r.name,killedBy:e.id},e.id))}var nb="0.9.90-beta",ib="2026-02-17T07:07:21Z",ob="0.9.90-beta",lp={version:nb,buildDate:ib,engineVersion:ob};function DY(t){t.define("gdt").mapsTo(eo).withPriority(200).build();let e=["da","he","ex","nd","rd","nc","rc","nr","rr","nt","rt"],r=["dr","dx","do","de","dv","dc","dh","dl","df","dn","dm","ds","dt","dp","d2","dz","ah","tk","ar","af","ac","aa","ax","av","an","az","pd","kl","ko","wu","fo"],n=["ao","pz","tq"];for(let i of e)t.define(i).mapsTo(vr).withPriority(250).build();for(let i of r)t.define(i).mapsTo(vr).withPriority(250).build(),t.define(`${i} :arg...`).mapsTo(vr).withPriority(251).build();for(let i of n)t.define(i).mapsTo(vr).withPriority(250).build(),t.define(`${i} :arg...`).mapsTo(vr).withPriority(251).build()}function LY(t){t.define("say :arg").mapsTo(Rt).withPriority(150).build(),t.define("say odysseus").mapsTo(Rt).withPriority(155).build(),t.define("say ulysses").mapsTo(Rt).withPriority(155).build(),t.define("echo").mapsTo(Rt).withPriority(155).build(),t.define("ulysses").mapsTo(Rt).withPriority(155).build(),t.define("odysseus").mapsTo(Rt).withPriority(155).build(),t.define("xyzzy").mapsTo(Rt).withPriority(155).build(),t.define("tell :npc to :command...").mapsTo(ja).withPriority(150).build(),t.define("order :npc to :command...").mapsTo(ja).withPriority(150).build(),t.define("talk to troll").mapsTo(Wa).withPriority(200).build(),t.define("talk to the troll").mapsTo(Wa).withPriority(200).build(),t.define("hello troll").mapsTo(Wa).withPriority(200).build(),t.define("knock").mapsTo(Ys).withPriority(150).build(),t.define("knock on :target").mapsTo(Ys).withPriority(155).build(),t.define("knock on door").mapsTo(Ys).withPriority(160).build(),t.define("knock on the door").mapsTo(Ys).withPriority(160).build(),t.define("knock door").mapsTo(Ys).withPriority(155).build(),t.define("answer :text...").mapsTo(Jm).withPriority(150).build()}function MY(t){t.define("walk through :target").mapsTo(Un).withPriority(150).build(),t.define("go through :target").mapsTo(Un).withPriority(150).build(),t.define("pass through :target").mapsTo(Un).withPriority(150).build(),t.define("walk through south wall").mapsTo(Un).withPriority(155).build(),t.define("walk through north wall").mapsTo(Un).withPriority(155).build(),t.define("go through south wall").mapsTo(Un).withPriority(155).build(),t.define("go through north wall").mapsTo(Un).withPriority(155).build(),t.define("push :direction wall").direction("direction").mapsTo(td).withPriority(160).build(),t.define("push the :direction wall").direction("direction").mapsTo(td).withPriority(160).build(),t.define("push red panel").mapsTo(bt).withPriority(170).build(),t.define("push red wall").mapsTo(bt).withPriority(170).build(),t.define("push red").mapsTo(bt).withPriority(170).build(),t.define("push yellow panel").mapsTo(bt).withPriority(170).build(),t.define("push yellow wall").mapsTo(bt).withPriority(170).build(),t.define("push yellow").mapsTo(bt).withPriority(170).build(),t.define("push mahogany panel").mapsTo(bt).withPriority(170).build(),t.define("push mahogany wall").mapsTo(bt).withPriority(170).build(),t.define("push mahogany").mapsTo(bt).withPriority(170).build(),t.define("push pine panel").mapsTo(bt).withPriority(170).build(),t.define("push pine wall").mapsTo(bt).withPriority(170).build(),t.define("push pine").mapsTo(bt).withPriority(170).build(),t.define("lift pole").mapsTo(Na).withPriority(155).build(),t.define("raise pole").mapsTo(Na).withPriority(155).build(),t.define("lift short pole").mapsTo(Na).withPriority(156).build(),t.define("raise short pole").mapsTo(Na).withPriority(156).build(),t.define("lower pole").mapsTo(sd).withPriority(155).build(),t.define("lower short pole").mapsTo(sd).withPriority(156).build(),t.define("set dial to :number").text("number").mapsTo(cd).withPriority(150).build(),t.define("turn dial to :number").text("number").mapsTo(cd).withPriority(150).build(),t.define("set indicator to :number").text("number").mapsTo(cd).withPriority(150).build(),t.define("turn indicator to :number").text("number").mapsTo(cd).withPriority(150).build(),t.define("push dial button").mapsTo(Da).withPriority(165).build(),t.define("press dial button").mapsTo(Da).withPriority(165).build(),t.define("push the dial button").mapsTo(Da).withPriority(165).build(),t.define("press the dial button").mapsTo(Da).withPriority(165).build(),t.define("push sundial button").mapsTo(Da).withPriority(165).build(),t.define("press sundial button").mapsTo(Da).withPriority(165).build(),t.define("press :target").mapsTo(fd).withPriority(150).build(),t.define("turn bolt").mapsTo(Xs).withPriority(150).build(),t.define("turn the bolt").mapsTo(Xs).withPriority(150).build(),t.define("turn bolt with :instrument").instrument("instrument").mapsTo(Xs).withPriority(155).build(),t.define("turn switch").mapsTo(Yn).withPriority(150).build(),t.define("turn the switch").mapsTo(Yn).withPriority(150).build(),t.define("flip switch").mapsTo(Yn).withPriority(150).build(),t.define("flip the switch").mapsTo(Yn).withPriority(150).build(),t.define("activate machine").mapsTo(Yn).withPriority(150).build(),t.define("activate the machine").mapsTo(Yn).withPriority(150).build(),t.define("put :item under :target").mapsTo(Zs).withPriority(160).build(),t.define("slide :item under :target").mapsTo(Zs).withPriority(160).build(),t.define("put mat under door").mapsTo(Zs).withPriority(165).build(),t.define("slide mat under door").mapsTo(Zs).withPriority(165).build(),t.define("push key with :tool").mapsTo(yo).withPriority(160).build(),t.define("push key with screwdriver").mapsTo(yo).withPriority(165).build(),t.define("use :tool on keyhole").mapsTo(yo).withPriority(160).build(),t.define("use screwdriver on keyhole").mapsTo(yo).withPriority(165).build(),t.define("poke key with :tool").mapsTo(yo).withPriority(160).build(),t.define("push key through keyhole").mapsTo(yo).withPriority(165).build(),t.define("dig").mapsTo(La).withPriority(150).build(),t.define("dig with :tool").mapsTo(La).withPriority(155).build(),t.define("dig :target").mapsTo(La).withPriority(150).build(),t.define("dig in :target").mapsTo(La).withPriority(150).build(),t.define("send for brochure").mapsTo(ho).withPriority(150).build(),t.define("send for free brochure").mapsTo(ho).withPriority(155).build(),t.define("order brochure").mapsTo(ho).withPriority(150).build(),t.define("mail order").mapsTo(ho).withPriority(145).build(),t.define("melt glacier with :instrument").instrument("instrument").mapsTo(Eo).withPriority(160).build(),t.define("melt ice with :instrument").instrument("instrument").mapsTo(Eo).withPriority(160).build(),t.define("melt glacier").mapsTo(Eo).withPriority(150).build(),t.define("melt ice").mapsTo(Eo).withPriority(150).build(),t.define("melt :target").mapsTo(Eo).withPriority(145).build()}function PY(t){t.define("ring :target").mapsTo(Us).withPriority(150).build(),t.define("ring bell").mapsTo(Us).withPriority(155).build(),t.define("ring the bell").mapsTo(Us).withPriority(155).build(),t.define("break :target").mapsTo(rd).withPriority(150).build(),t.define("smash :target").mapsTo(rd).withPriority(150).build(),t.define("burn :target").mapsTo(nd).withPriority(150).build(),t.define("light :target").mapsTo(nd).withPriority(145).build(),t.define("pray").mapsTo(Vs).withPriority(150).build(),t.define("pray at :target").mapsTo(Vs).withPriority(155).build(),t.define("pray to :target").mapsTo(Vs).withPriority(155).build(),t.define("incant :challenge :response").text("challenge").text("response").mapsTo(Qm).withPriority(200).build(),t.define("wave :target").mapsTo(dd).withPriority(150).build(),t.define("wave :target at :location").mapsTo(dd).withPriority(155).build(),t.define("wind :target").mapsTo(ld).withPriority(150).build(),t.define("wind up :target").mapsTo(ld).withPriority(155).build()}function kY(t){t.define("pour :target").mapsTo(qt).withPriority(150).build(),t.define("pour water").mapsTo(qt).withPriority(155).build(),t.define("pour water in :container").mapsTo(qt).withPriority(160).build(),t.define("pour water into :container").mapsTo(qt).withPriority(160).build(),t.define("pour :target in :container").mapsTo(qt).withPriority(155).build(),t.define("pour :target into :container").mapsTo(qt).withPriority(155).build(),t.define("fill :target").mapsTo(nr).withPriority(150).build(),t.define("fill bottle").mapsTo(nr).withPriority(155).build(),t.define("fill :target from :source").mapsTo(nr).withPriority(160).build(),t.define("fill bottle from bucket").mapsTo(nr).withPriority(165).build(),t.define("fill bottle with water").mapsTo(nr).withPriority(160).build(),t.define("light :object with :tool").mapsTo(Qs).withPriority(160).build(),t.define("set fire to :object with :tool").mapsTo(Qs).withPriority(160).build(),t.define("ignite :object with :tool").mapsTo(Qs).withPriority(160).build(),t.define("tie :object to :target").mapsTo(Ma).withPriority(150).build(),t.define("tie :object").mapsTo(Ma).withPriority(145).build(),t.define("fasten :object to :target").mapsTo(Ma).withPriority(150).build(),t.define("attach :object to :target").mapsTo(Ma).withPriority(150).build(),t.define("untie :object").mapsTo(Pa).withPriority(150).build(),t.define("untie :object from :target").mapsTo(Pa).withPriority(155).build(),t.define("unfasten :object").mapsTo(Pa).withPriority(150).build(),t.define("detach :object").mapsTo(Pa).withPriority(150).build()}var BY=_(E());function xY(t){t.define("inflate :target").mapsTo(Ba).withPriority(150).build(),t.define("inflate :target with :tool").mapsTo(Ba).withPriority(155).build(),t.define("pump :target").mapsTo(Ba).withPriority(150).build(),t.define("pump up :target").mapsTo(Ba).withPriority(155).build(),t.define("deflate :target").mapsTo(Js).withPriority(150).build(),t.define("open valve").mapsTo(Js).withPriority(155).build(),t.define("let air out of :target").mapsTo(Js).withPriority(155).build(),t.define("board :target").hasTrait("target",BY.TraitType.ENTERABLE).mapsTo("if.action.entering").withPriority(150).build(),t.define("disembark").mapsTo("if.action.exiting").withPriority(150).build(),t.define("leave boat").mapsTo("if.action.exiting").withPriority(150).build(),t.define("get out of boat").mapsTo("if.action.exiting").withPriority(155).build(),t.define("launch").mapsTo(yd).withPriority(150).build()}function jY(t){t.define("diagnose").mapsTo(vd).withPriority(150).build(),t.define("room").mapsTo(_d).withPriority(150).build(),t.define("rname").mapsTo(bd).withPriority(150).build(),t.define("objects").mapsTo(ic).withPriority(150).build(),t.define("object").mapsTo(ic).withPriority(150).build()}function WY(t){let e=t.getStoryGrammar();t.addPreposition("under"),t.addPreposition("beneath"),DY(e),LY(e),MY(e),PY(e),kY(e),xY(e),jY(e)}var nu=_(E());function UY(t){let e=t.get(nu.NpcTrait);return e?.customProperties?e.customProperties:null}function ab(t){return UY(t)?.state==="FLED"}var wL={id:"cyclops",name:"Cyclops Behavior",onTurn(t){return ab(t.npc)?[]:t.playerVisible&&t.random.chance(.15)?[{type:"emote",messageId:tt.GROWLS,data:{npcName:t.npc.name}}]:[]},onPlayerEnters(t){return ab(t.npc)?[]:[{type:"emote",messageId:tt.BLOCKS,data:{npcName:t.npc.name}}]},onSpokenTo(t,e){if(ab(t.npc))return[];let r=e.toLowerCase();if(r.includes("odysseus")||r.includes("ulysses")){let i=UY(t.npc)?.roomId??t.npcLocation;return[{type:"emote",messageId:tt.PANICS,data:{npcName:t.npc.name}},{type:"emote",messageId:tt.FLEES,data:{npcName:t.npc.name}},{type:"custom",handler:()=>{let o=Vm(t.world,t.npc,i);return o.push({id:`cyclops-flee-${Date.now()}`,type:"game.message",entities:{},data:{messageId:tt.PASSAGE_OPENS},timestamp:Date.now(),narrate:!0}),o}}]}return[{type:"emote",messageId:tt.IGNORES,data:{npcName:t.npc.name}}]},onAttacked(t,e){if(ab(t.npc))return[];let r=t.npc.get(nu.CombatantTrait);return r&&(r.hostile=!0),[{type:"emote",messageId:tt.COUNTERATTACKS,data:{npcName:t.npc.name}},{type:"attack",target:e.id}]},getState(t){return t.get(nu.NpcTrait)?.customProperties??{}},setState(t,e){let r=t.get(nu.NpcTrait);r&&(r.customProperties=e)}};var sb=_(E());function HY(t,e,r){t.registerBehavior(wL);let n=e.getEntity(r);return n&&sb.RoomBehavior.blockExit(n,sb.Direction.NORTH,"The cyclops blocks your way north!"),zN(e,r)}var qY=_(E());var Id=_(E());var ude=0;function FY(){return`dm-evt-${Date.now()}-${++ude}`}function GY(t){let e=t.get(Id.NpcTrait);return e?.customProperties?e.customProperties:null}function VY(t){return t?t.get(Id.IdentityTrait)?.name==="Parapet":!1}var YY={id:"dungeon-master",name:"Dungeon Master Behavior",onTurn(t){if(LN(t.world)!=="FOLLOWING")return[];if(t.playerLocation!==t.npcLocation){let n=t.world.getEntity(t.npcLocation)?.get(Id.RoomTrait);if(n?.exits){for(let[i,o]of Object.entries(n.exits))if(o&&"destination"in o&&o.destination===t.playerLocation)return t.world.moveEntity(t.npc.id,t.playerLocation),[{type:"emote",messageId:X.FOLLOWING,data:{npcName:"Dungeon Master"}}]}}return[]},onSpokenTo(t,e){let r=GY(t.npc);if(!r)return[];let n=e.toLowerCase().trim(),i=LN(t.world);if(n.includes("follow")||n==="come"||n==="come with me")return r.triviaPassed?(Jc(t.world,"FOLLOWING"),[{type:"emote",messageId:X.FOLLOWING,data:{npcName:"Dungeon Master"}}]):[{type:"emote",messageId:X.NO_ANSWER_YET,data:{npcName:"Dungeon Master"}}];if(n==="stay"||n==="wait"||n.includes("stay here")||n.includes("wait here"))return Jc(t.world,"WAITING"),[{type:"emote",messageId:X.STAYING,data:{npcName:"Dungeon Master"}}];let o=n.match(/(?:set|turn)\s+dial\s+to\s+(\d)/);return o?mde(t,parseInt(o[1],10)):n.includes("push button")||n.includes("press button")||n.includes("push the button")||n.includes("press the button")?pde(t):[{type:"emote",messageId:X.CANNOT_DO_THAT,data:{npcName:"Dungeon Master"}}]},getState(t){let e=GY(t);return e?{...e}:{}},setState(t,e){let r=t.get(Id.NpcTrait);r&&(r.customProperties=e)}};function mde(t,e){if(e<1||e>8)return[{type:"emote",messageId:X.CANNOT_DO_THAT,data:{npcName:"Dungeon Master"}}];let r=t.world.getEntity(t.npcLocation);return VY(r)?(t.world.setStateValue("parapet.dialSetting",e),[{type:"custom",handler:()=>[{id:FY(),type:"game.message",entities:{actor:t.npc.id},data:{messageId:X.SETS_DIAL,params:{dialValue:e}},timestamp:Date.now(),narrate:!0}]}]):[{type:"emote",messageId:X.CANNOT_DO_THAT,data:{npcName:"Dungeon Master"}}]}function pde(t){let e=t.world.getEntity(t.npcLocation);if(!VY(e))return[{type:"emote",messageId:X.CANNOT_DO_THAT,data:{npcName:"Dungeon Master"}}];let r=t.world.getStateValue("parapet.dialSetting")??1,n=t.world.getStateValue("parapet.activatedCell")??0;return t.world.setStateValue("parapet.activatedCell",r),[{type:"custom",handler:()=>{let i=[];return i.push({id:FY(),type:"game.message",entities:{actor:t.npc.id},data:{messageId:X.PUSHES_BUTTON,params:{dialValue:r}},timestamp:Date.now(),narrate:!0}),r===4?t.world.setStateValue("prisonCell.bronzeDoorVisible",!0):n===4&&t.world.setStateValue("prisonCell.bronzeDoorVisible",!1),i}}]}function zY(t,e,r){return t.registerBehavior(YY),GG(e,r)}function NL(t){t.addMessage(ct.KNOCKED_OUT,"The troll is battered into unconsciousness."),t.addMessage(ct.KILL_UNCONSCIOUS,"The unconscious troll cannot defend himself: he dies."),t.addMessage(ct.SMOKE_DISAPPEAR,"Almost as soon as the troll breathes his last, a cloud of sinister black smoke envelops him, and when the fog lifts, the carcass has disappeared."),t.addMessage(ct.DEATH_PASSAGE_CLEAR,"With the troll dispatched, the passage to the north is now clear."),t.addMessage(ct.RECOVERS_AXE,"The troll, now worried about this encounter, recovers his bloody axe."),t.addMessage(ct.COWERS,"The troll, disarmed, cowers in terror, pleading for his life in the guttural tongue of the trolls."),t.addMessage(ct.CATCHES_ITEM,"The troll, who is remarkably coordinated, catches the {itemName}."),t.addMessage(ct.EATS_ITEM,"The troll, not having the most discriminating tastes, gleefully eats the {itemName}."),t.addMessage(ct.THROWS_KNIFE_BACK,"Being for the moment sated, the troll throws it back. Fortunately, the troll has poor control, and the knife falls to the floor. He does not look pleased."),t.addMessage(ct.SPITS_AT_PLAYER,'The troll spits in your face, saying "Better luck next time."'),t.addMessage(ct.MOCKS_UNARMED_ATTACK,"The troll laughs at your puny gesture."),t.addMessage(ct.CANT_HEAR_YOU,"Unfortunately, the troll can't hear you."),t.addMessage(jv.WHITE_HOT,"The troll's axe seems white-hot. You can't hold on to it."),t.addMessage(Jl.GROWLS,"The troll growls menacingly at you."),t.addMessage(ke.APPEARS,"A seedy-looking gentleman sidles into view."),t.addMessage(ke.LEAVES,"The thief slinks away into the shadows."),t.addMessage(ke.LURKS,"The thief lurks in the shadows, watching."),t.addMessage(ke.STEALS_FROM_PLAYER,'"My, what a lovely {itemName}!" The thief snatches it away.'),t.addMessage(ke.STEALS_FROM_ROOM,"The thief pockets the {itemName}."),t.addMessage(ke.NOTICES_VALUABLES,"The thief's eyes gleam as he notices your possessions."),t.addMessage(ke.GLOATS,"The thief grins smugly at you."),t.addMessage(ke.OPENS_EGG,"The thief, eyeing the jeweled egg with professional interest, skillfully opens it and reveals a clockwork canary!"),t.addMessage(ke.ATTACKS,"The thief lunges at you with his stiletto!"),t.addMessage(ke.COUNTERATTACKS,"The thief parries and counterattacks!"),t.addMessage(ke.DODGES,"The thief deftly dodges your attack."),t.addMessage(ke.WOUNDED,"The thief staggers from your blow."),t.addMessage(ke.FLEES,"The thief, badly wounded, stumbles away into the darkness."),t.addMessage(ke.DIES,"The thief falls to the ground, a look of surprise frozen on his face."),t.addMessage(ke.DROPS_LOOT,"The thief's ill-gotten gains scatter across the floor."),t.addMessage(ke.BLACK_FOG,"Almost as soon as the thief breathes his last breath, a cloud of sinister black fog envelops him, and when the fog lifts, the carcass has disappeared."),t.addMessage(ke.BOOTY_REMAINS,"His booty remains."),t.addMessage(ke.TREASURES_REAPPEAR,"As the thief dies, the power of his magic decreases, and his treasures reappear:"),t.addMessage("dungeo.thief.frame_spawns","As the thief falls, an ornate but empty picture frame crashes to the ground."),t.addMessage("dungeo.treasure_room.thief_summoned","You hear a scream of anguish as you violate the robber's hideaway. Using passages unknown to you, he rushes to its defense."),t.addMessage(tt.BLOCKS,"A huge cyclops stands before you, blocking the northern passage!"),t.addMessage(tt.GROWLS,"The cyclops growls menacingly."),t.addMessage(tt.IGNORES,"The cyclops ignores your words."),t.addMessage(tt.PANICS,"The cyclops, hearing that dreaded name, panics!"),t.addMessage(tt.FLEES,"The cyclops runs away in terror, revealing a hidden passage!"),t.addMessage(tt.PASSAGE_OPENS,"A passage north to the Strange Passage is now clear."),t.addMessage(tt.ATTACKS,"The cyclops swings at you with massive fists!"),t.addMessage(tt.COUNTERATTACKS,"The cyclops roars and swings back at you!"),t.addMessage(tt.WOUNDED,"The cyclops staggers from your blow."),t.addMessage(tt.DIES,"The cyclops crashes to the ground with a tremendous thud!"),t.addMessage(Xe.DESCRIPTION,"A metallic robot with a hinged panel on its chest."),t.addMessage(Xe.FOLLOWS,"The robot follows you."),t.addMessage(Xe.WAITS,"The robot will wait here."),t.addMessage(Xe.COMMAND_UNDERSTOOD,"The robot beeps in acknowledgment."),t.addMessage(Xe.COMMAND_UNKNOWN,"The robot whirs confusedly."),t.addMessage(Xe.PUSHES_BUTTON,"The robot extends a thin metal finger and pushes the triangular button."),t.addMessage(Xe.NO_BUTTON,"The robot looks around but sees no button to push."),t.addMessage(Xe.ALREADY_PUSHED,"The robot has already pushed the button."),t.addMessage(Xe.ARRIVES,"The robot enters."),t.addMessage(Xe.TAKES_OBJECT,"The robot takes the {objectName}."),t.addMessage(Xe.DROPS_OBJECT,"The robot drops the {objectName}."),t.addMessage(Xe.CAROUSEL_FIXED,"You hear a grinding noise from somewhere nearby. The carousel mechanism has stopped spinning!"),t.addMessage(Xe.RAISES_CAGE,"The robot reaches up and lifts the cage."),t.addMessage(it.CAGE_FALLS,"As you reach for the sphere, a steel cage falls from the ceiling to entrap you. To make matters worse, poisonous gas starts coming into the room."),t.addMessage(it.CAGE_RAISED,"The cage shakes and is hurled across the room."),t.addMessage(it.POISON_DEATH,"Time passes...and you die from some obscure poisoning."),t.addMessage(it.ROBOT_CRUSH,"As the robot reaches for the sphere, a steel cage falls from the ceiling. The robot attempts to fend it off, but is trapped below it. Alas, the robot short-circuits in his vain attempt to escape, and crushes the sphere beneath him as he falls to the floor."),t.addMessage(it.GAS_WARNING,"The gas is getting thicker."),t.addMessage(it.POISON_GAS_ROOM,"You are stopped by a cloud of poisonous gas."),t.addMessage(Ge.NO_TARGET,"Command whom?"),t.addMessage(Ge.CANT_COMMAND,"You cannot command that."),t.addMessage(Ge.CANT_SEE,"You don't see that here."),t.addMessage(Ge.WHIRR_BUZZ_CLICK,'"Whirr, buzz, click!"'),t.addMessage(Ge.STUPID_ROBOT,'"I am only a stupid robot and cannot perform that command."'),t.addMessage(X.DESCRIPTION,"A strange old man with a long, flowing beard and penetrating eyes."),t.addMessage(X.APPEARS_AT_DOOR,"The barred panel in the door slides open, revealing a strange old man with a long, flowing beard and penetrating eyes. He speaks in a deep, resonant voice."),t.addMessage(X.FOLLOWING,"The Dungeon Master follows you."),t.addMessage(X.STAYING,"The Dungeon Master nods and remains where he is."),t.addMessage(X.SETS_DIAL,"The Dungeon Master turns the dial to {dialValue}."),t.addMessage(X.PUSHES_BUTTON,"The Dungeon Master pushes the button. You hear machinery grinding somewhere below."),t.addMessage(X.CANNOT_DO_THAT,"The Dungeon Master shakes his head slowly."),t.addMessage(X.QUESTION_0,'"What room can one enter, but yet not enter, and reach the lair of the thief?"'),t.addMessage(X.QUESTION_1,'"Where, besides the temple, can one end up after going through the altar?"'),t.addMessage(X.QUESTION_2,'"What is the minimum total value of the zorkmid treasures in the game?"'),t.addMessage(X.QUESTION_3,'"What item enables one to determine the function of the various cakes?"'),t.addMessage(X.QUESTION_4,'"What is a useful thing to do with the mirror?"'),t.addMessage(X.QUESTION_5,'"What body part offends the spirits in the land of the dead?"'),t.addMessage(X.QUESTION_6,'"What object in the game is haunted?"'),t.addMessage(X.QUESTION_7,`"Is the phrase 'hello sailor' useful anywhere in the game?"`),t.addMessage(X.CORRECT_ANSWER,'The old man nods approvingly. "Correct."'),t.addMessage(X.WRONG_ANSWER_1,'The old man frowns. "That is not correct. Think carefully."'),t.addMessage(X.WRONG_ANSWER_2,'The old man shakes his head. "Wrong again. You have three more chances."'),t.addMessage(X.WRONG_ANSWER_3,'The old man sighs. "Still incorrect. Two chances remain."'),t.addMessage(X.WRONG_ANSWER_4,'The old man looks disappointed. "Wrong. This is your last chance."'),t.addMessage(X.WRONG_ANSWER_5,'The old man waves his hand dismissively. "You have failed. The door shall remain closed to you forever."'),t.addMessage(X.TRIVIA_PASSED,'The old man smiles warmly. "You have proven your knowledge. Enter, friend, and face the final challenge."'),t.addMessage(X.TRIVIA_FAILED,"The panel slides shut. You are not worthy to continue."),t.addMessage(X.DOOR_OPENS,"The wooden door swings open with a creak."),t.addMessage(X.NO_ANSWER_YET,"You must first knock on the door to begin the challenge."),t.addMessage(X.ALREADY_PASSED,"You have already passed the challenge. The door is open."),t.addMessage("npc.guard.blocks","The {npcName} growls menacingly, blocking your way."),t.addMessage("npc.guard.attacks","The {npcName} swings at you!"),t.addMessage("npc.guard.defeated","The {npcName} has been defeated!"),t.addMessage("npc.attacks","The {npcName} attacks!"),t.addMessage("npc.misses","The {npcName} misses."),t.addMessage("npc.hits","The {npcName} hits you!"),t.addMessage("npc.killed","The {npcName} is dead."),t.addMessage("npc.unconscious","The {npcName} slumps to the ground, unconscious."),t.addMessage("npc.enters","A {npcName} enters."),t.addMessage("npc.leaves","The {npcName} leaves."),t.addMessage("npc.notices_player","The {npcName} notices you."),t.addMessage("npc.no_response","The {npcName} does not respond."),t.addMessage(Rl.NO_EXPERTISE,"You have neither the tools nor the expertise."),t.addMessage(wn.HERO_ATTACK,""),t.addMessage(wn.VILLAIN_ATTACK,""),t.addMessage(wn.STILL_RECOVERING,"You are still recovering from a staggering blow."),t.addMessage(wn.UNARMED_ATTACK,"Fighting unarmed is suicide."),t.addMessage(wn.BACKUP_WEAPON,""),t.addMessage(wn.VILLAIN_DISARMED,"")}function DL(t){t.addMessage(j.LANTERN_DIM,"Your lantern is getting dim."),t.addMessage(j.LANTERN_FLICKERS,"Your lantern flickers ominously."),t.addMessage(j.LANTERN_DIES,"Your lantern flickers and goes out."),t.addMessage(j.LANTERN_DEAD,"The lantern is dead. You need a new battery."),t.addMessage(j.CANDLES_LOW,"The candles are burning low."),t.addMessage(j.CANDLES_FLICKER,"The candles flicker."),t.addMessage(j.CANDLES_OUT,"The candles sputter and go out."),t.addMessage(j.MATCH_BURNING,"The match sputters."),t.addMessage(j.MATCH_OUT,"The match goes out."),t.addMessage(j.DAM_GATES_OPEN,"The sluice gates open and water pours through the dam."),t.addMessage(j.DAM_GATES_CLOSE,"The sluice gates close and water starts to collect behind the dam."),t.addMessage(j.DAM_TRUNK_REVEALED,"As the mud settles, a trunk becomes visible in the reservoir bed!"),t.addMessage(Ue.LEAK_STARTED,"There is a rumbling sound, and a stream of water appears to burst from the east wall of the room (apparently, a leak has occurred in a pipe)."),t.addMessage(Ue.WATER_ANKLES,"The water level is now up to your ankles."),t.addMessage(Ue.WATER_SHINS,"The water level is now up to your shins."),t.addMessage(Ue.WATER_KNEES,"The water level is now up to your knees."),t.addMessage(Ue.WATER_HIPS,"The water level is now up to your hips."),t.addMessage(Ue.WATER_WAIST,"The water level is now up to your waist."),t.addMessage(Ue.WATER_CHEST,"The water level is now up to your chest."),t.addMessage(Ue.WATER_NECK,"The water level is now up to your neck."),t.addMessage(Ue.WATER_HEAD,"The water level is now over your head."),t.addMessage(Ue.ROOM_FLOODED,"The room is full of water and cannot be entered."),t.addMessage(Ue.DROWNED,"I'm afraid you have done drowned yourself."),t.addMessage(Ue.BUTTON_JAMMED,"The blue button appears to be jammed."),t.addMessage(j.BALLOON_RISING,"The balloon rises slowly."),t.addMessage(j.BALLOON_FALLING,"The balloon sinks slowly."),t.addMessage(j.BALLOON_AT_LEDGE,"The balloon drifts near a ledge."),t.addMessage(j.BALLOON_LANDED,"The balloon settles to the ground."),t.addMessage(j.BALLOON_CRASH,"The balloon rises too high and hits the jagged ceiling of the volcano! The bag is torn apart and the balloon plunges to the ground far below."),t.addMessage(j.BALLOON_HOOK_VISIBLE,"You can see a hook on the rock face here."),t.addMessage(j.BALLOON_INFLATING,"Hot air fills the balloon and it begins to rise."),t.addMessage(j.BALLOON_DEFLATING,"The balloon deflates as the heat source dies."),t.addMessage(k_.OBJECT_BURNED_OUT,"The {itemName} has burned out completely.");let e={EXIT_SUCCESS:"dungeo.balloon.exit_success",EXIT_BLOCKED_MIDAIR:"dungeo.balloon.exit_blocked_midair",EXIT_TO_LEDGE:"dungeo.balloon.exit_to_ledge"};t.addMessage(e.EXIT_SUCCESS,"You climb out of the balloon."),t.addMessage(e.EXIT_BLOCKED_MIDAIR,"You are too high in the air to exit safely! The balloon is floating in mid-air."),t.addMessage(e.EXIT_TO_LEDGE,"You carefully climb out of the balloon onto the {roomName}."),t.addMessage(j.FOREST_BIRD,"A songbird chirps in the distance."),t.addMessage(j.FOREST_RUSTLE,"Leaves rustle in the undergrowth."),t.addMessage(j.FOREST_BREEZE,"A gentle breeze stirs the branches."),t.addMessage(j.FOREST_BRANCH,"A branch cracks somewhere in the forest."),t.addMessage(j.UNDERGROUND_DRIP,"Water drips somewhere in the darkness."),t.addMessage(j.UNDERGROUND_ECHO,"A distant echo reaches your ears."),t.addMessage(j.UNDERGROUND_CREAK,"The timbers creak ominously."),t.addMessage(Fs.GLOW_BRIGHT,"Your sword has begun to glow very brightly."),t.addMessage(Fs.GLOW_FAINT,"Your sword is glowing with a faint blue glow."),t.addMessage(Fs.GLOW_OFF,"Your sword is no longer glowing."),t.addMessage(j.INCENSE_BURNING,"The incense continues to smolder."),t.addMessage(j.INCENSE_BURNS_OUT,"The incense sputters and burns out completely, leaving only ash."),t.addMessage(j.TROLL_KNOCKED_OUT,"The troll is battered into unconsciousness."),t.addMessage(j.TROLL_WAKES_UP,"The troll stirs, quickly resuming a fighting stance."),t.addMessage(j.FUSE_STARTS,"The wire starts to burn."),t.addMessage(j.FUSE_FIZZLES,"The wire rapidly burns into nothingness."),t.addMessage(j.SAFE_BLOWN_OPEN,"There is a tremendous explosion, and the door of the box is blown off!"),t.addMessage(j.BRICK_KILLS_PLAYER,"Now you've done it. It seems that the brick has other properties than weight, namely the ability to blow you to smithereens."),t.addMessage(j.DISTANT_EXPLOSION,"You hear a distant explosion."),t.addMessage(j.SAFE_COLLAPSE_DEATH,"The room trembles and 50,000 pounds of rock fall on you, turning you into a pancake."),t.addMessage(j.SAFE_COLLAPSE_RUMBLE,"You may recall that recent explosion. Well, probably as a result of that, you hear an ominous rumbling, as if one of the rooms in the dungeon had collapsed."),t.addMessage(j.LEDGE_COLLAPSE_DEATH,"The force of the explosion has caused the ledge to collapse belatedly."),t.addMessage(j.LEDGE_COLLAPSE_NARROW_ESCAPE,"The ledge collapses, giving you a narrow escape.")}function LL(t){t.addMessage("if.action.dropping.dropped_in","You drop the {item} in the {container}."),t.addMessage(at.NOTHING_TO_SAY,"You need to say something."),t.addMessage(at.SAY_TO_AIR,"You speak, but nobody is here to listen."),t.addMessage(at.NPC_RESPONDS,"{npcName} responds to your words."),t.addMessage(at.LOUD_ROOM_ECHO_DEATH,"The acoustics of the room cause your voice to echo back with increasing volume. The reverberations are deafening! CRASH! The room collapses around you!"),t.addMessage(at.LOUD_ROOM_ECHO_SAFE,'The platinum bar seems to absorb the sound, preventing dangerous reverberations. The acoustics of the room cause your voice to echo: "echo...echo...echo..."'),t.addMessage(at.LOUD_ROOM_ACOUSTICS,'The acoustics of the room cause your voice to echo: "echo...echo...echo..."'),t.addMessage(at.RIDDLE_CORRECT,"There is a loud rumble as the stone door swings open, revealing a passage to the east!"),t.addMessage(at.RIDDLE_WRONG,'A hollow voice intones: "Wrong, adventurer! Think more carefully about the riddle..."'),t.addMessage(at.RIDDLE_ALREADY_SOLVED,"The stone door is already open. You may proceed east."),t.addMessage(qn.RING_SUCCESS,"Ding!"),t.addMessage(qn.RING_BELL,"The bell produces a clear, resonant tone."),t.addMessage(qn.NOT_RINGABLE,"That doesn't make a sound when rung."),t.addMessage(qn.NO_TARGET,"Ring what?"),t.addMessage($r.BREAK_SUCCESS,"You break the {target}."),t.addMessage($r.BREAK_FRAME,'The frame shatters! Among the debris, you find a carved piece bearing strange symbols: "Only devotion can reveal my location."'),t.addMessage($r.CANT_BREAK,"You can't break that."),t.addMessage($r.NO_TARGET,"Break what?"),t.addMessage($r.NOT_VISIBLE,"You don't see that here."),t.addMessage(ft.BURN_SUCCESS,"You burn the {target}."),t.addMessage(ft.BURN_INCENSE,"The incense begins to smolder, releasing fragrant smoke that fills the room."),t.addMessage(ft.BURN_FUSE,"The wire starts to burn."),t.addMessage(ft.ALREADY_BURNING,"It is already burning."),t.addMessage(ft.BURNED_OUT,"It has already burned out."),t.addMessage(ft.CANT_BURN,"You can't burn that."),t.addMessage(ft.NO_TARGET,"Burn what?"),t.addMessage(ft.NOT_VISIBLE,"You don't see that here."),t.addMessage(po.PRAY_GENERIC,"If you pray hard enough, your prayers may be answered."),t.addMessage(po.PRAY_TELEPORT,"In a shocking development, your prayer is answered!"),t.addMessage(wa.success,'A hollow voice speaks: "Greetings, Implementor." You feel disoriented as reality shifts around you...'),t.addMessage(wa.failure,"Nothing happens."),t.addMessage(wa.syntax,"The spell fizzles. (Usage: INCANT <challenge> <response>)"),t.addMessage(Qr.CANT_LIFT,"You can't lift that."),t.addMessage(Qr.NO_TARGET,"Lift what?"),t.addMessage(Qr.NOT_VISIBLE,"You don't see that here."),t.addMessage(Qr.NOT_IN_MIRROR,"There is nothing here to lift."),t.addMessage(Xr.CANT_LOWER,"You can't lower that."),t.addMessage(Xr.NO_TARGET,"Lower what?"),t.addMessage(Xr.NOT_VISIBLE,"You don't see that here."),t.addMessage(Xr.NOT_IN_MIRROR,"There is nothing here to lower."),t.addMessage(dt.NOT_IN_PUZZLE,"There are no walls to push here."),t.addMessage(dt.NO_DIRECTION,"Push which wall?"),t.addMessage(dt.INVALID_DIRECTION,"That is not a valid direction."),t.addMessage(dt.NO_WALL,"There is no wall in that direction."),t.addMessage(dt.IMMOVABLE,"That wall is solid marble. It will not budge."),t.addMessage(dt.NO_ROOM,"There is no room for the wall to slide."),t.addMessage(dt.BOUNDARY,"You cannot push walls at the edge."),t.addMessage(dt.SUCCESS,"The sandstone wall slides into the space beyond."),t.addMessage(dt.SUCCESS_FIRST,"The sandstone wall slides into the space beyond. You step into the vacated space."),t.addMessage(dt.LADDER_VISIBLE,"One of the sandstone walls has a wooden ladder attached to it."),t.addMessage(dt.CARD_VISIBLE,"Set into one wall is a small depression. Within it rests a gold card."),t.addMessage(bi.NOT_IN_MIRROR,"There are no panels to push here."),t.addMessage(bi.NO_TARGET,"Push which panel?"),t.addMessage(bi.NOT_VISIBLE,"You don't see a {target} here."),t.addMessage(bi.NOT_A_PANEL,"That isn't a panel you can push."),t.addMessage(tr.SUCCESS,"You wave the {target}."),t.addMessage(tr.RAINBOW_APPEARS,"Suddenly, the rainbow appears to become solid and, I venture, walkable (I think the giveaway was the stairs and bannister)."),t.addMessage(tr.RAINBOW_GONE,"The rainbow seems to have become somewhat run of the mill."),t.addMessage(tr.NO_EFFECT,"You wave the {target}, but nothing happens."),t.addMessage(tr.NO_TARGET,"Wave what?"),t.addMessage(tr.NOT_HOLDING,"You're not holding that."),t.addMessage(rr.SUCCESS,"You dig for a while."),t.addMessage(rr.FOUND_STATUE,"Your shovel strikes something solid! Digging more carefully, you uncover a beautiful statue."),t.addMessage(rr.KEEP_DIGGING,"You dig some sand away. You could swear the sand looks a bit different here."),t.addMessage(rr.NOTHING_HERE,"You've already dug up everything here."),t.addMessage(rr.NO_SHOVEL,"You have nothing to dig with."),t.addMessage(rr.CANT_DIG_HERE,"The ground is too hard to dig here."),t.addMessage(Ct.SUCCESS,"You wind the {target}."),t.addMessage(Ct.CANARY_SINGS,"The canary begins to sing a beautiful song."),t.addMessage(Ct.BAUBLE_APPEARS,"The canary begins to sing. From somewhere nearby, an answering song is heard. Suddenly, a shiny brass bauble drops at your feet!"),t.addMessage(Ct.NOT_IN_FOREST,"The canary sings, but there is no response."),t.addMessage(Ct.NO_TARGET,"Wind what?"),t.addMessage(Ct.NOT_WINDABLE,"That doesn't have a winding mechanism."),t.addMessage(Ct.NOT_HOLDING,"You're not holding that."),t.addMessage(Ct.ALREADY_WOUND,"The canary seems content and doesn't need winding."),t.addMessage(Fn.SEND_FOR_BROCHURE,"Ok, but you know how strapped the postal service is lately..."),t.addMessage(Fn.ALREADY_SENT,"You've already sent for the brochure."),t.addMessage(Fn.NO_TARGET,"Send for what?"),t.addMessage(Fn.BROCHURE_KNOCK,"There is a knocking sound from the front of the house. The postal service must be getting faster!"),t.addMessage(wt.SUCCESS,"The water spills on the ground and evaporates."),t.addMessage(wt.INTO_BUCKET,"The water splashes into the bucket."),t.addMessage(wt.BUCKET_RISES,"The bucket becomes heavy with water and slowly rises to the top of the well, carrying you with it!"),t.addMessage(wt.BUCKET_AT_TOP,"The water splashes into the bucket, but it is already at the top of the well."),t.addMessage(wt.NO_WATER,"You don't have any water to pour."),t.addMessage(wt.NO_TARGET,"Pour what?"),t.addMessage(wt.NOTHING_HAPPENS,"Nothing happens."),t.addMessage(wt.NOT_IN_BUCKET,"You're not in the bucket."),t.addMessage(yt.SUCCESS,"You fill the bottle."),t.addMessage(yt.FROM_BUCKET,"You fill the bottle from the bucket."),t.addMessage(yt.BUCKET_DESCENDS,"As the water leaves the bucket, it becomes lighter and slowly descends to the bottom of the well, carrying you with it!"),t.addMessage(yt.BUCKET_AT_BOTTOM,"You fill the bottle from the bucket, but it is already at the bottom of the well."),t.addMessage(yt.NO_BOTTLE,"You don't have a bottle to fill."),t.addMessage(yt.BOTTLE_FULL,"The bottle is already full."),t.addMessage(yt.NO_SOURCE,"There is no water source here."),t.addMessage(yt.NO_WATER_IN_BUCKET,"The bucket is empty."),t.addMessage(yt.NOTHING_HAPPENS,"Nothing happens."),t.addMessage(Gt.SUCCESS,"The {target} catches fire."),t.addMessage(Gt.NO_FIRE_SOURCE,"You don't have a way to light that."),t.addMessage(Gt.NOT_FLAMMABLE,"That won't burn."),t.addMessage(Gt.ALREADY_BURNING,"It is already burning."),t.addMessage(Gt.GUIDEBOOK_LIT,"The guidebook catches fire and begins to burn brightly."),t.addMessage(Gt.IN_RECEPTACLE,"You place the burning {target} in the receptacle. The balloon begins to rise!"),t.addMessage(lt.SUCCESS,"The balloon is now anchored."),t.addMessage(lt.NO_ROPE,"You don't have anything to tie with."),t.addMessage(lt.NOT_AT_LEDGE,"There is nothing to tie the rope to here."),t.addMessage(lt.ALREADY_TIED,"The rope is already tied to a hook."),t.addMessage(lt.NO_HOOK,"There is no hook to tie the rope to."),t.addMessage(lt.NOT_IN_BALLOON,"You're not in the balloon."),t.addMessage(lt.ROPE_TIED_TO_RAILING,"The rope is now securely fastened to the railing, dangling down into the darkness below."),t.addMessage(lt.ROPE_ALREADY_TIED,"The rope is already tied to the railing."),t.addMessage(lt.NO_RAILING,"There is nothing here to tie the rope to."),t.addMessage(lt.NEED_ROPE,"You don't have any rope."),t.addMessage(Vn.SUCCESS,"You untie the rope."),t.addMessage(Vn.NOT_TIED,"The rope isn't tied to anything."),t.addMessage(Vn.NO_ROPE,"There's no rope here to untie."),t.addMessage(It.CLICK,"Click."),t.addMessage(It.NOT_A_BUTTON,"That's not a button."),t.addMessage(It.LIGHTS_ON,"The lights come on."),t.addMessage(It.LIGHTS_OFF,"The lights go out."),t.addMessage(It.BLUE_JAMMED,"The blue button appears to be jammed."),t.addMessage(It.BLUE_LEAK_STARTED,"There is a rumbling sound from below, and water begins to leak into the room!"),t.addMessage(Rr.NOT_A_BOLT,"You can't turn that."),t.addMessage(Rr.WONT_TURN,"The bolt won't turn. Perhaps the control panel has something to do with it."),t.addMessage(Rr.NO_TOOL,"You can't turn the bolt with your bare hands."),t.addMessage(Rr.WRONG_TOOL,"The wrench won't fit on that."),t.addMessage(Rr.GATES_OPEN,"The sluice gates open and water pours through the dam."),t.addMessage(Rr.GATES_CLOSE,"The sluice gates close, stopping the flow of water."),t.addMessage(An.NO_SWITCH,"There's no switch here."),t.addMessage(An.NO_COAL,"The machine makes a grinding noise, but nothing happens. Perhaps it needs fuel."),t.addMessage(An.ALREADY_USED,"The machine has already been used."),t.addMessage(An.SUCCESS,"The machine comes to life with a deafening roar! The lid slams shut, and the sounds of immense pressure fill the room. After a moment, the lid opens to reveal that the coal has been transformed into a huge diamond!"),t.addMessage(ka.GENERIC_FAIL,"You can't put that under there."),t.addMessage(Xl.DOOR_LOCKED,"The door is locked, and there is no keyhole on this side."),t.addMessage(Rn.SUCCESS,"The boat inflates and rises to its full size."),t.addMessage(Rn.NO_PUMP,"You don't have anything to inflate it with."),t.addMessage(Rn.ALREADY_INFLATED,"The boat is already inflated."),t.addMessage(Rn.NOT_INFLATABLE,"That can't be inflated."),t.addMessage(Rn.CANT_REACH,"You can't reach the boat from here."),t.addMessage(Ri.SUCCESS,"The boat deflates."),t.addMessage(Ri.ALREADY_DEFLATED,"The boat is already deflated."),t.addMessage(Ri.NOT_DEFLATABLE,"That can't be deflated."),t.addMessage(Ri.CANT_REACH,"You can't reach the boat from here."),t.addMessage(Cr.SUCCESS,"You are now on the river."),t.addMessage(Cr.NOT_IN_BOAT,"You're not in a boat."),t.addMessage(Cr.NOT_AT_SHORE,"There's no water here to launch into."),t.addMessage(Cr.BOAT_NOT_INFLATED,"The boat must be inflated first."),t.addMessage(Cr.ALREADY_ON_RIVER,"You're already on the river."),t.addMessage(Sr.KNOCK_GENERIC,"You knock, but no one answers."),t.addMessage(Sr.KNOCK_DOOR,"You knock on the door."),t.addMessage(Sr.DM_APPEARS,'The barred panel in the door slides open, revealing a strange old man with a long, flowing beard. He speaks: "I am the Dungeon Master. To prove yourself worthy of entry, you must answer my questions correctly. Three correct answers will grant you passage; five wrong answers will seal your fate."'),t.addMessage(Sr.DM_ALREADY_APPEARED,"The Dungeon Master waits for your answer."),t.addMessage(Sr.TRIVIA_ALREADY_PASSED,"The door is already open. You may proceed."),t.addMessage(Sr.TRIVIA_ALREADY_FAILED,"The door remains sealed. You have already failed the challenge."),t.addMessage(Sr.NOTHING_TO_KNOCK,"There is nothing here to knock on."),t.addMessage(Gn.NO_QUESTION,"There is no question to answer."),t.addMessage(Gn.NO_ANSWER_GIVEN,"Answer what?"),t.addMessage(Gn.TRIVIA_NOT_STARTED,"You must first knock on the door to begin the challenge."),t.addMessage(Gn.TRIVIA_ALREADY_PASSED,"You have already passed the challenge."),t.addMessage(Gn.TRIVIA_ALREADY_FAILED,"You have already failed the challenge. There are no more questions."),t.addMessage(fo.SET_DIAL,"You turn the dial to {dialValue}."),t.addMessage(fo.DIAL_MUST_BE_1_TO_8,"The dial only has numbers one through eight."),t.addMessage(fo.NOT_AT_PARAPET,"There is no dial here."),t.addMessage(fo.NO_DIAL_HERE,"There is no dial here."),t.addMessage(Ii.PUSH_BUTTON,"You push the button in the center of the dial."),t.addMessage(Ii.MACHINERY_SOUNDS,"You hear grinding machinery somewhere below, as the cells around the pit rotate."),t.addMessage(Ii.CELL_ROTATES,"Cell {dialSetting} is now in position."),t.addMessage(Ii.NOT_AT_PARAPET,"There is no button here to push."),t.addMessage(Ii.NO_BUTTON,"There is no button here."),t.addMessage(Ce.PERFECT_HEALTH,"You are in perfect health."),t.addMessage(Ce.LIGHT_WOUND,"You have a light wound,"),t.addMessage(Ce.SERIOUS_WOUND,"You have a serious wound,"),t.addMessage(Ce.SEVERAL_WOUNDS,"You have several wounds,"),t.addMessage(Ce.WOUNDS_CURE," which will be cured after {turns} moves."),t.addMessage(Ce.LIGHT_WOUND_CURE,"You have a light wound, which will be cured after {turns} moves."),t.addMessage(Ce.SERIOUS_WOUND_CURE,"You have a serious wound, which will be cured after {turns} moves."),t.addMessage(Ce.SEVERAL_WOUNDS_CURE,"You have several wounds, which will be cured after {turns} moves."),t.addMessage(Ce.SERIOUS_WOUNDS_CURE,"You have serious wounds, which will be cured after {turns} moves."),t.addMessage(Ce.DEATHS_DOOR,"You are at death's door."),t.addMessage(Ce.ONE_MORE_WOUND,"You can be killed by one more light wound."),t.addMessage(Ce.SERIOUS_WOUND_KILL,"You can be killed by a serious wound."),t.addMessage(Ce.SURVIVE_SERIOUS,"You can survive one serious wound."),t.addMessage(Ce.STRONG,"You are strong enough to take several wounds."),t.addMessage(Ce.KILLED_ONCE,"You have been killed once."),t.addMessage(Ce.KILLED_TWICE,"You have been killed twice."),t.addMessage(Ce.KILLED_MANY,"You have been killed {count} times."),t.addMessage(_L.NO_OBJECTS,"There is nothing here."),t.addMessage(Ed.WALKED_INTO_GRUE,`Oh, no! You have walked into the slavering fangs of a lurking grue!

    **** You have died ****`),t.addMessage(Ed.SLITHERED_INTO_ROOM,`Oh, no! A lurking grue slithered into the room and devoured you!

    **** You have died ****`),t.addMessage(To.TOO_MUCH_BAGGAGE,"The chimney is too narrow for you and all of your baggage."),t.addMessage(To.EMPTY_HANDED,"Going up empty-handed is a bad idea.")}var PL=_(E()),oc={ATTACKS:"dungeo.bat.attacks",CARRIES_AWAY:"dungeo.bat.carries_away",COWERS:"dungeo.bat.cowers",DROPPED:"dungeo.bat.dropped"},ML="dungeo.bat.acted",cb="dungeo.bat.prevLocation",fde=0;function db(){return`bat-${Date.now()}-${++fde}`}function gde(t){let e=t.get(PL.IdentityTrait);if(!e)return!1;let r=e.name?.toLowerCase()||"",n=e.aliases||[];return r.includes("garlic")||n.some(i=>i.toLowerCase().includes("garlic"))}function hde(t,e){let r=n=>t.getContents(n).some(o=>gde(o)?!0:r(o.id));return r(e)}function yde(t,e){let r=t.filter(i=>i!==e);if(r.length===0)return e;let n=Math.floor(Math.random()*r.length);return r[n]}function KY(t,e,r){let n={id:"dungeo-bat",name:"Vampire Bat",priority:50,condition:o=>o.playerLocation===e,run:o=>{let{world:a,playerId:s,playerLocation:c}=o,d=[];if(a.getStateValue(ML)||a.getStateValue(cb)===e)return d;if(a.setStateValue(ML,!0),a.setStateValue(cb,e),hde(a,s))d.push({id:db(),type:"npc.emoted",timestamp:Date.now(),entities:{},data:{messageId:oc.COWERS},narrate:!0});else{d.push({id:db(),type:"npc.emoted",timestamp:Date.now(),entities:{},data:{messageId:oc.ATTACKS},narrate:!0});let m=yde(r,e);d.push({id:db(),type:"npc.emoted",timestamp:Date.now(),entities:{},data:{messageId:oc.CARRIES_AWAY},narrate:!0}),a.moveEntity(s,m),a.setStateValue(cb,m);let g=a.getEntity(m)?.get(PL.IdentityTrait);d.push({id:db(),type:"if.event.room.description",timestamp:Date.now(),entities:{},data:{roomId:m,roomName:g?.name||"somewhere",roomDescription:g?.description||"",includeContents:!0,verbose:!0},narrate:!0})}return d}},i={id:"dungeo-bat-reset",name:"Bat State Reset",priority:-100,condition:o=>!0,run:o=>(o.world.setStateValue(ML,!1),o.world.setStateValue(cb,o.playerLocation),[])};t.registerDaemon(n),t.registerDaemon(i)}var sc=_(E());var ac={SPIRITS_BLOCK:"dungeo.exorcism.spirits_block",SPIRITS_VANISH:"dungeo.exorcism.spirits_vanish",PASSAGE_OPENS:"dungeo.exorcism.passage_opens",BELL_ECHOES:"dungeo.exorcism.bell_echoes",RITUAL_PROGRESS:"dungeo.exorcism.ritual_progress"},lb="dungeo.exorcism.",kL=`${lb}bell_rung`,BL=`${lb}book_read`,xL=`${lb}candles_lit`,jL=`${lb}spirits_banished`;function Tde(t){return t?.attributes?.exorcismRole==="bell"}function Ede(t){return t?.attributes?.exorcismRole==="book"}function vde(t){return t?.attributes?.exorcismRole==="candles"}function _de(t){let e={};for(let r of t.getAllEntities())Tde(r)&&(e.bell=r.id),Ede(r)&&(e.book=r.id),vde(r)&&(e.candles=r.id);return e}function bde(t,e){return t.getStateValue(kL)===!0&&t.getStateValue(BL)===!0&&t.getStateValue(xL)===!0}function Ide(t,e,r){let n=[];t.setStateValue(jL,!0);let i=t.getEntity(e);if(i){let o=i.get($c);o&&(o.spiritsBlocking=!1),sc.RoomBehavior.unblockExit(i,sc.Direction.EAST);let a=i.get(sc.IdentityTrait);a&&(a.description="You are at the entrance to Hades, the land of the dead. An eerie mist swirls around you. A passage leads east into darkness, and a corridor leads north.")}return n.push({id:`exorcism-spirits-vanish-${Date.now()}`,type:"npc.emoted",timestamp:Date.now(),entities:{},data:{messageId:ac.SPIRITS_VANISH},narrate:!0}),n.push({id:`exorcism-passage-opens-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:ac.PASSAGE_OPENS}}),n}function $Y(t,e,r,n){let i=_de(e);e.setStateValue(kL,!1),e.setStateValue(BL,!1),e.setStateValue(xL,!1),e.setStateValue(jL,!1),e.registerEventHandler("game.message",(a,s)=>{let c=a.data,d=c?.messageId,u=c?.location;d==="dungeo.ring.bell"&&u===r&&s.setStateValue(kL,!0)}),e.registerEventHandler("if.event.read",(a,s)=>{let c=a.data,d=c?.target||c?.targetId;if(d&&i.book&&d===i.book){let u=s.getPlayer();u&&s.getLocation(u.id)===r&&s.setStateValue(BL,!0)}}),e.registerEventHandler("if.event.switched_on",(a,s)=>{let d=a.data?.target;if(d&&i.candles&&d===i.candles){let u=s.getPlayer();u&&s.getLocation(u.id)===r&&s.setStateValue(xL,!0)}});let o={id:"dungeo-exorcism-check",name:"Exorcism Ritual Check",priority:40,condition:a=>a.world.getStateValue(jL)?!1:a.playerLocation===r,run:a=>{let{world:s}=a;return bde(s,r)?Ide(s,r,n):[]}};t.registerDaemon(o)}var mb=_(E());var WL={COMPASS_SPINNING:"dungeo.round_room.compass_spinning",DISORIENTED:"dungeo.round_room.disoriented",ROOM_FIXED:"dungeo.round_room.fixed"},UL="dungeo.round_room.prevLocation",Ode=0;function ub(){return`round-room-${Date.now()}-${++Ode}`}function Sde(t,e){let r=t.getEntity(e);if(!r)return[];let n=r.get(mb.RoomTrait);if(!n||!n.exits)return[];let i=[];for(let o of Object.values(n.exits))o&&typeof o=="object"&&"destination"in o&&i.push(o.destination);return i}function Ade(t,e,r){let n=Sde(t,e),i=r?n.filter(a=>a!==r):n;if(i.length===0)return n.length>0?n[0]:null;let o=Math.floor(Math.random()*i.length);return i[o]}function Rde(t,e){let r=t.getEntity(e);return r?r.get(Ia)?.isFixed===!0:!0}function QY(t,e){let r={id:"dungeo-round-room",name:"Round Room Carousel",priority:60,condition:i=>i.world.getStateValue(UL)===e&&i.playerLocation!==e,run:i=>{let{world:o,playerId:a,playerLocation:s}=i,c=[];if(Rde(o,e))return c;let d=s,u=Ade(o,e,d);if(!u||u===d)return c.push({id:ub(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:WL.COMPASS_SPINNING},narrate:!0}),c;c.push({id:ub(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:WL.COMPASS_SPINNING},narrate:!0}),o.moveEntity(a,u),c.push({id:ub(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:WL.DISORIENTED},narrate:!0}),o.setStateValue(UL,u);let f=o.getEntity(u)?.get(mb.IdentityTrait);return c.push({id:ub(),type:"if.event.room.description",timestamp:Date.now(),entities:{},data:{roomId:u,roomName:f?.name||"somewhere",roomDescription:f?.description||"",includeContents:!0,verbose:!0},narrate:!0}),c}},n={id:"dungeo-round-room-tracking",name:"Round Room Location Tracking",priority:-100,condition:i=>!0,run:i=>(i.world.setStateValue(UL,i.playerLocation),[])};t.registerDaemon(r),t.registerDaemon(n)}var XY={REALITY_ALTERED:"dungeo.scoring.reality_altered"};var Oo=_(E()),Io={DARKNESS_DESCENDS:"dungeo.endgame.darkness_descends",CLOAKED_FIGURE:"dungeo.endgame.cloaked_figure",TELEPORT:"dungeo.endgame.teleport",ENDGAME_BEGINS:"dungeo.endgame.begins"},iu="dungeo.endgame.cryptWaitTurns",ZY="game.endgameStarted",Cde="game.savingDisabled",wde="scoring.endgameScore",Nde="scoring.endgameMaxScore",Dde=15;function Lde(t,e){let n=t.getAllEntities().find(o=>o.get(Oo.IdentityTrait)?.name==="crypt door");if(!n)return!1;let i=n.get(Oo.OpenableTrait);return i?!i.isOpen:!1}function Mde(t,e){let r=t.getPlayer();if(!r)return!0;let n=t.getEntity(e);if(!n)return!0;if(!n.get(Oo.RoomTrait)?.isDark)return!1;let o=t.getContents(r.id);for(let s of o)if(s.get(Oo.LightSourceTrait)?.isLit)return!1;let a=t.getContents(e);for(let s of a)if(s.get(Oo.LightSourceTrait)?.isLit)return!1;return!0}function Pde(t){return t.getAllEntities().find(n=>{let i=n.get(Oo.IdentityTrait);return i?.aliases?.includes("elvish sword")||i?.name==="elvish sword"})?.id}function kde(t,e){let r=[],n=t.getPlayer();if(!n)return r;t.setStateValue(ZY,!0),t.setStateValue(Cde,!0),t.setStateValue(wde,15),t.setStateValue(Nde,100),t.setStateValue(iu,0);let i=Pde(t);return i&&t.getLocation(i)!==n.id&&t.moveEntity(i,n.id),r.push({id:`endgame-cloaked-figure-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:Io.CLOAKED_FIGURE}}),t.moveEntity(n.id,e),r.push({id:`endgame-teleport-${Date.now()}`,type:"player.teleported",timestamp:Date.now(),entities:{actor:n.id,location:e},data:{messageId:Io.TELEPORT,destination:e}}),r.push({id:`endgame-begins-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:Io.ENDGAME_BEGINS,score:15,maxScore:100}}),r}function JY(t,e,r,n){e.setStateValue(iu,0);let i={id:"dungeo-endgame-trigger",name:"Endgame Crypt Trigger",priority:50,condition:o=>o.world.getStateValue(ZY)?!1:o.playerLocation===r,run:o=>{let{world:a}=o,s=[];if(!Lde(a,r)||!Mde(a,r))return a.setStateValue(iu,0),s;let d=(a.getStateValue(iu)||0)+1;return a.setStateValue(iu,d),d===5?s.push({id:`endgame-darkness-1-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:Io.DARKNESS_DESCENDS,turn:d}}):d===10&&s.push({id:`endgame-darkness-2-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:Io.DARKNESS_DESCENDS,turn:d}}),d>=Dde?kde(a,n):s}};t.registerDaemon(i)}var HL=_(E()),Di={BEAM_BROKEN:"dungeo.endgame.beam_broken",BEAM_ACTIVE:"dungeo.endgame.beam_active",BUTTON_LASER_ACTIVE:"dungeo.endgame.button_laser_active",BUTTON_PRESSED:"dungeo.endgame.button_pressed",BUTTON_ALREADY_PRESSED:"dungeo.endgame.button_already_pressed",LOOK_BEAM_ACTIVE:"dungeo.endgame.look_beam_active",LOOK_BEAM_BROKEN:"dungeo.endgame.look_beam_broken"},tz="endgame.laserBeamActive",rz="endgame.stoneButtonPressed",pb="endgame.beamJustBroken",fb="endgame.buttonJustPressed",gb="endgame.buttonBlocked";function ez(t){return t.getStateValue(tz)===!0}function Bde(t){return t.getStateValue(rz)===!0}function xde(t){return t.getAllEntities().find(n=>{let i=n.get(HL.IdentityTrait);return i?.aliases?.includes("elvish sword")||i?.name==="elvish sword"})?.id}function nz(t,e,r,n,i){if(e.registerEventHandler("if.event.dropped",o=>{if(!e.getPlayer())return;let s=o.data;if((s?.location||s?.locationId)!==r||!ez(e))return;let d=s?.itemId||o.entities?.target,u=xde(e);d===u&&(e.setStateValue(tz,!1),e.setStateValue(pb,!0))}),e.registerEventHandler("if.event.pushed",o=>{let a=e.getPlayer();if(!a||e.getLocation(a.id)!==n)return;let c=o.entities?.target;if(!c)return;let d=e.getEntity(c);if(!(!d||!d.get(HL.IdentityTrait)?.name?.includes("stone button"))){if(ez(e)){e.setStateValue(gb,!0);return}Bde(e)||(e.setStateValue(rz,!0),e.setStateValue(fb,!0))}}),i){let o={id:"dungeo-laser-feedback",name:"Laser Puzzle Feedback",priority:30,condition:a=>{let{world:s}=a;return s.getStateValue(pb)===!0||s.getStateValue(fb)===!0||s.getStateValue(gb)===!0},run:a=>{let{world:s}=a,c=[];return s.getStateValue(pb)&&(c.push({id:`laser-broken-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:Di.BEAM_BROKEN}}),s.setStateValue(pb,!1)),s.getStateValue(fb)&&(c.push({id:`button-pressed-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:Di.BUTTON_PRESSED}}),s.setStateValue(fb,!1)),s.getStateValue(gb)&&(c.push({id:`button-blocked-${Date.now()}`,type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:Di.BUTTON_LASER_ACTIVE}}),s.setStateValue(gb,!1)),c}};i.registerDaemon(o)}}var up={ENTER_TREASURY:"dungeo.victory.enter_treasury",VICTORY_TEXT:"dungeo.victory.text",FINAL_SCORE:"dungeo.victory.final_score",CONGRATULATIONS:"dungeo.victory.congratulations"};var iz=_(E()),jde="dungeo.rainbow.active";function Wde(t){let e=t.getPlayer();if(!e)return!1;let r=t.getLocation(e.id);if(!r)return!1;let n=t.getEntity(r);return n?(n.get(iz.IdentityTrait)?.name||"")==="Aragain Falls":!1}function Ude(t){return t.getStateValue(jde)||!1}function Hde(t){let e=t.action?.toLowerCase();if(e!=="go"&&e!=="going"&&e!=="if.action.going")return!1;let r;return t.extras?.direction?r=String(t.extras.direction).toLowerCase():t.structure?.directObject?.head&&(r=t.structure.directObject.head.toLowerCase()),r==="west"||r==="w"}function oz(){return(t,e)=>!Wde(e)||!Hde(t)||Ude(e)?t:{...t,action:"dungeo.rainbow.blocked",extras:{...t.extras,originalAction:t.action,isRainbowBlocked:!0}}}var ou=_(E());function qde(t){let e=t.getPlayer();if(!e)return!1;let r=t.getLocation(e.id);if(!r)return!1;let n=t.getEntity(r);return!n||!n.has(ou.TraitType.VEHICLE)?!1:n.get(ou.VehicleTrait)?.vehicleType==="watercraft"}function Gde(t,e){let r=t.getPlayer();if(!r)return null;let n=t.getContainingRoom(r.id);if(!n)return null;let i=n.get(ou.RoomTrait);if(!i)return null;let o=e.toUpperCase();return i.exits[o]?.destination||null}function Fde(t){return t.extras?.direction?String(t.extras.direction).toLowerCase():t.structure?.directObject?.head?t.structure.directObject.head.toLowerCase():null}function Vde(t){let e=t.getPlayer();if(!e)return!1;let r=t.getContainingRoom(e.id);return r?r.get(nt)?.isRainbowRoom===!0:!1}function az(){return(t,e)=>{let r=t.action?.toLowerCase();if(r!=="go"&&r!=="going"&&r!=="if.action.going")return t;let n=Fde(t);if(!n)return t;let i=Gde(e,n);if(!i)return t;let o=e.getEntity(i),a=o?.get(nt);return!o||!a?.isWaterRoom||qde(e)||Vde(e)?t:{...t,action:op,extras:{...t.extras,originalAction:t.action,isRiverBlocked:!0}}}}var sz={NO_BOAT:"dungeo.river.no_boat",NEED_INFLATED_BOAT:"dungeo.river.need_inflated_boat"};var cz=_(E()),qL=null,Yde="dungeo.action.falls_death",dz={DEATH:"dungeo.falls.death"};function zde(t){let e=t.getPlayer();if(!e)return null;let r=t.getLocation(e.id);return r?t.getEntity(r)?.has(cz.TraitType.VEHICLE)?t.getLocation(r)||null:r:null}function Kde(t){let e=t.action?.toLowerCase()||"";if(["look","looking","if.action.looking","examine","examining","if.action.examining","l"].includes(e)||e.includes("wave")||e==="dungeo.action.wave"||e.startsWith("dungeo.action.gdt")||e==="dungeo.rainbow.blocked")return!0;if(e==="if.action.going"||e==="going"){let n=t.extras?.direction?.toUpperCase()||"";return!(n==="SOUTH"||n==="S")}return!1}function lz(){return(t,e)=>!qL||zde(e)!==qL||Kde(t)?t:{...t,action:Yde,extras:{...t.extras,originalAction:t.action,isFallsDeath:!0}}}function uz(t){qL=t}var $de=_(E());var hb={PENALTY:"dungeo.death.penalty",GAME_OVER:"dungeo.death.game_over",DEATH_COUNT:"dungeo.death.count"};var yb=_(E()),mz={SLAMS_SHUT:"dungeo.trapdoor.slams_shut"};var GL=_(E());function Qde(t){let e=t.getPlayer();if(!e)return!1;let r=t.getLocation(e.id);if(!r)return!1;let n=t.getEntity(r);return n?(n.get(GL.IdentityTrait)?.name||"")==="Studio":!1}function Xde(t){let e=t.action?.toLowerCase();if(e!=="go"&&e!=="going"&&e!=="if.action.going")return!1;let r;return t.extras?.direction?r=String(t.extras.direction).toLowerCase():t.structure?.directObject?.head&&(r=t.structure.directObject.head.toLowerCase()),r==="up"||r==="u"}function Zde(t){let e=t.getAllEntities();for(let r of e){let n=r.get(GL.IdentityTrait);if(n){let i=n.name.toLowerCase(),o=n.aliases.map(a=>a.toLowerCase());if(i==="brass lantern"||i==="lantern"||i==="lamp"||o.includes("lamp")||o.includes("lantern")||o.includes("brass lantern"))return r.id}}return null}function pz(t){let e=t.getPlayer();return e?t.getContents(e.id).map(n=>n.id):[]}function Jde(t){let e=Zde(t);return e?pz(t).includes(e):!1}function fz(){return(t,e)=>{if(!Qde(e)||!Xde(t))return t;let n=pz(e).length;return n===0?{...t,action:rc,extras:{...t.extras,originalAction:t.action,chimneyBlockReason:"empty"}}:n>2?{...t,action:rc,extras:{...t.extras,originalAction:t.action,chimneyBlockReason:"baggage"}}:Jde(e)?t:{...t,action:rc,extras:{...t.extras,originalAction:t.action,chimneyBlockReason:"baggage"}}}}var Od=_(E());function ele(t){return Ns(t).immortal}function tle(t){let e=t.getPlayer();return e?t.getContainingRoom(e.id):null}function rle(t){return t.extras?.direction?String(t.extras.direction).toLowerCase():t.structure?.directObject?.head?t.structure.directObject.head.toLowerCase():null}function nle(t,e){let r=t.getPlayer();if(!r)return{destination:null,exitType:"invalid",isBlocked:!1};let n=t.getContainingRoom(r.id);if(!n)return{destination:null,exitType:"invalid",isBlocked:!1};let i=n.get(Od.RoomTrait);if(!i)return{destination:null,exitType:"invalid",isBlocked:!1};let o=e.toUpperCase(),a=i.exits[o];if(!a||!a.destination)return{destination:null,exitType:"invalid",isBlocked:!1};if(a.via){let s=t.getEntity(a.via);if(s){let c=s.getTrait(Od.TraitType.OPENABLE);if(c&&!c.isOpen)return{destination:a.destination,exitType:"door",isBlocked:!0,viaEntityId:a.via}}}return{destination:a.destination,exitType:"normal",isBlocked:!1,viaEntityId:a.via}}function ile(){return Math.random()<.25}function ole(t){let e=t.action?.toLowerCase()||"";return e==="go"||e==="going"||e==="if.action.going"}function gz(){return(t,e)=>{if(ele(e)||!ole(t))return t;let r=tle(e);if(!r||!Od.VisibilityBehavior.isDark(r,e)||ile())return t;let n=rle(t);if(!n)return t;let i=nle(e,n);if(i.exitType==="invalid"||!i.destination)return{...t,action:tc,extras:{...t.extras,originalAction:t.action,grueDeathType:"walked_into",reason:"invalid_exit"}};if(i.isBlocked)return{...t,action:tc,extras:{...t.extras,originalAction:t.action,grueDeathType:"slithered",reason:"blocked_exit"}};let o=e.getEntity(i.destination);return o?Od.VisibilityBehavior.isDark(o,e)?{...t,action:tc,extras:{...t.extras,originalAction:t.action,grueDeathType:"walked_into",reason:"dark_destination"}}:t:{...t,action:tc,extras:{...t.extras,originalAction:t.action,grueDeathType:"walked_into",reason:"no_destination"}}}}var mp=_(E()),Vt={EAT_ME_SHRINK:"dungeo.cake.eat_me.shrink",BLUE_ENLARGE:"dungeo.cake.blue.enlarge",BLUE_CRUSH:"dungeo.cake.blue.crush_death",ORANGE_EXPLODE:"dungeo.cake.orange.explode_death",RED_TERRIBLE:"dungeo.cake.red.terrible",RED_POOL_DISSOLVE:"dungeo.cake.red.pool_dissolve",SPICES_REVEALED:"dungeo.cake.spices_revealed",POOL_DISSOLVED_DESC:"dungeo.pool_room.dissolved"};function qa(t,e,r={}){return{id:`cake-${t}-${Date.now()}-${Math.random().toString(36).substr(2,6)}`,type:t,timestamp:Date.now(),entities:{},data:{messageId:e,...r}}}function hz(t){t.chainEvent("if.event.eaten",(e,r)=>{let n=e.data;if(!n||n.blocked)return null;let i=n.item;if(!i)return null;let o=r.getEntity(i);if(!o)return null;let a=o.attributes.cakeType;if(!a)return null;let s=r.getPlayer();if(!s)return null;let c=r.getLocation(s.id),d=r.getStateValue("dungeo.tea_room.id"),u=r.getStateValue("dungeo.posts_room.id");switch(a){case"eat-me":return c===d?(r.moveEntity(s.id,u),qa("dungeo.event.cake_effect",Vt.EAT_ME_SHRINK,{destination:"Posts Room",cakeType:"eat-me"})):null;case"blue-icing":return c===u?(r.moveEntity(s.id,d),qa("dungeo.event.cake_effect",Vt.BLUE_ENLARGE,{destination:"Tea Room",cakeType:"blue-icing"})):c===d?(r.setStateValue("dungeo.player.dead",!0),r.setStateValue("dungeo.player.death_cause","cake_crush"),[qa("dungeo.event.cake_effect",Vt.BLUE_CRUSH,{cakeType:"blue-icing",cause:"cake_crush"}),qa("if.event.player.died",Vt.BLUE_CRUSH,{cause:"cake_crush"})]):null;case"orange-icing":return r.setStateValue("dungeo.player.dead",!0),r.setStateValue("dungeo.player.death_cause","cake_explosion"),[qa("dungeo.event.cake_effect",Vt.ORANGE_EXPLODE,{cakeType:"orange-icing",cause:"cake_explosion"}),qa("if.event.player.died",Vt.ORANGE_EXPLODE,{cause:"cake_explosion"})];case"red-icing":return null;default:return null}},{key:"dungeo.chain.cake-eating",priority:100})}function yz(t){t.chainEvent("if.event.thrown",(e,r)=>{let n=e.data;if(!n)return null;let i=n.item;if(!i)return null;let o=r.getEntity(i);if(!o)return null;let a=o.attributes.cakeType,s=r.getPlayer();if(!s)return null;let c=r.getLocation(s.id),d=r.getStateValue("dungeo.pool_room.room_id");if(a==="red-icing"&&c===d&&!r.getStateValue("dungeo.pool.dissolved")){r.setStateValue("dungeo.pool.dissolved",!0);let m=r.getStateValue("dungeo.pool_room.pool_id");if(m){let h=r.getEntity(m);h&&mp.IdentityBehavior.conceal(h)}let f=r.getStateValue("dungeo.pool_room.spices_id");if(f){let h=r.getEntity(f);h&&mp.IdentityBehavior.reveal(h)}let g=r.getEntity(d);if(g){let h=g.get(mp.TraitType.IDENTITY);h&&(h.description="This is a large room, one half of which is depressed. The floor of the depression is covered with hardened calciumite. The only exit is to the west.")}return qa("dungeo.event.cake_effect",Vt.RED_POOL_DISSOLVE,{cakeType:"red-icing"})}return a==="orange-icing"?(r.setStateValue("dungeo.player.dead",!0),r.setStateValue("dungeo.player.death_cause","cake_explosion"),[qa("dungeo.event.cake_effect",Vt.ORANGE_EXPLODE,{cakeType:"orange-icing",cause:"cake_explosion"}),qa("if.event.player.died",Vt.ORANGE_EXPLODE,{cause:"cake_explosion"})]):null},{key:"dungeo.chain.cake-throwing",priority:100})}var Ez=_(E()),pp={COMPASS_SPINNING:"dungeo.carousel.compass_spinning",CANNOT_GET_BEARINGS:"dungeo.carousel.cannot_get_bearings"},ale="dungeo.carousel.active",Tb="dungeo.carousel.prevLocation",sle=0;function FL(){return`carousel-${Date.now()}-${++sle}`}function Tz(t){return t.getStateValue(ale)??!1}function cle(t,e){return Math.random()<.5?t:e}function vz(t,e,r,n){let i={id:"dungeo-carousel-exit",name:"Low Room Carousel Exit",priority:60,condition:s=>s.world.getStateValue(Tb)===e&&s.playerLocation!==e,run:s=>{let{world:c,playerId:d,playerLocation:u}=s;if(!Tz(c))return[];let m=[],f=cle(r,n);m.push({id:FL(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:pp.CANNOT_GET_BEARINGS},narrate:!0}),f!==u&&c.moveEntity(d,f);let h=c.getEntity(f)?.get(Ez.IdentityTrait);return m.push({id:FL(),type:"if.event.room.description",timestamp:Date.now(),entities:{},data:{roomId:f,roomName:h?.name||"somewhere",roomDescription:h?.description||"",includeContents:!0,verbose:!0},narrate:!0}),c.setStateValue(Tb,f),m}},o={id:"dungeo-carousel-entry",name:"Low Room Carousel Entry",priority:55,condition:s=>{let c=s.world.getStateValue(Tb);return s.playerLocation===e&&c!==e},run:s=>Tz(s.world)?[{id:FL(),type:"game.message",timestamp:Date.now(),entities:{},data:{messageId:pp.COMPASS_SPINNING},narrate:!0}]:[]},a={id:"dungeo-carousel-tracking",name:"Low Room Carousel Tracking",priority:-100,condition:()=>!0,run:s=>(s.world.setStateValue(Tb,s.playerLocation),[])};t.registerDaemon(i),t.registerDaemon(o),t.registerDaemon(a)}function VL(t){t.addMessage(st.ENTER_PUZZLE,"You squeeze through the narrow hole and find yourself in a confusing maze of sandstone walls."),t.addMessage(st.EXIT_PUZZLE,"You climb the ladder and squeeze back through the hole in the ceiling."),t.addMessage(st.CANT_EXIT,"There is no way to reach the hole in the ceiling."),t.addMessage(st.MOVE_BLOCKED,"You cannot go that way."),t.addMessage(st.MOVE_SUCCESS,"OK."),t.addMessage(st.ROOM_DESCRIPTION,"{text}"),t.addMessage(st.TAKE_CARD,"You carefully extract the gold card from its depression in the wall."),t.addMessage(st.CANT_TAKE_CARD,"You are not close enough to reach the card."),t.addMessage(st.PUSH_SUCCESS,"The sandstone wall slides into the space beyond."),t.addMessage(st.PUSH_NO_WALL,"There is no wall there."),t.addMessage(st.PUSH_IMMOVABLE,"The marble wall is unyielding."),t.addMessage(st.PUSH_NO_ROOM,"There is no room for the wall to slide."),t.addMessage(bL.ROOM_SHAKES,"There is a rumble from deep within the earth, and the room shakes."),t.addMessage(ac.SPIRITS_BLOCK,"Ghostly figures bar your way, their hollow eyes staring through you. They will not let you pass."),t.addMessage(ac.SPIRITS_VANISH,"The spirits shriek in terror and vanish in a blinding flash of light!"),t.addMessage(ac.PASSAGE_OPENS,"The way to the south is now clear."),t.addMessage(ac.BELL_ECHOES,"The bell echoes through the chamber."),t.addMessage(ac.RITUAL_PROGRESS,"You feel a strange energy building..."),t.addMessage(Cl.GHOST_APPEARS,`The fragrant smoke swirls around the basin. A spectral figure rises - the ghost of the thief! Dressed in adventurer's robes, he gestures toward the Gallery and speaks: "Well done, my friend. You are nearing the end game. Look to the Gallery for your reward." Then he fades away...`),t.addMessage(Cl.CANVAS_SPAWNS,"A magnificent rolled up canvas has appeared in the Gallery!"),t.addMessage(Cl.WRONG_ITEM,'The spirit laughs mockingly: "As we said, you have no rights here!" The item vanishes.'),t.addMessage(Cl.NOT_BLESSED,"Nothing happens. The basin remains still."),t.addMessage(XY.REALITY_ALTERED,"The death of the thief seems to alter reality in some subtle way..."),t.addMessage(Di.BEAM_BROKEN,"The sword falls through the beam of light, breaking it. The beam flickers and dies."),t.addMessage(Di.BEAM_ACTIVE,"A narrow red beam of light crosses the room at the north end."),t.addMessage(Di.BUTTON_LASER_ACTIVE,"You push the button, but nothing happens."),t.addMessage(Di.BUTTON_PRESSED,"There is a rumbling sound from the north."),t.addMessage(Di.BUTTON_ALREADY_PRESSED,"The button has already been pushed."),t.addMessage(Di.LOOK_BEAM_ACTIVE,"A narrow red beam of light crosses the room at the north end, inches above the floor."),t.addMessage(Di.LOOK_BEAM_BROKEN,"The beam of light is no longer visible."),t.addMessage(ge.POLE_RAISED,"You raise the short pole until it is almost touching the ceiling."),t.addMessage(ge.POLE_LOWERED_CHANNEL,"The short pole slides smoothly into the stone channel and clicks into place."),t.addMessage(ge.POLE_LOWERED_FLOOR,"The short pole falls to the floor with a clunk. It doesn't fit into the channel at this angle."),t.addMessage(ge.POLE_ALREADY_RAISED,"The pole is already raised."),t.addMessage(ge.POLE_ALREADY_LOWERED,"The pole is already lowered."),t.addMessage(ge.POLE_CANT_LOWER,"You can't lower the pole right now."),t.addMessage(ge.BOX_ROTATES,"The structure rotates with a grinding sound. The T-bar arrow now points {direction}."),t.addMessage(ge.BOX_MOVES,"The structure slides along the groove with a rumbling sound."),t.addMessage(ge.BOX_CANT_ROTATE,"The structure won't rotate. The pole is locking it in place."),t.addMessage(ge.BOX_CANT_MOVE_UNLOCKED,"The structure wobbles but doesn't move. The pole must be lowered into the channel first."),t.addMessage(ge.BOX_CANT_MOVE_ORIENTATION,"The structure is not aligned with the groove. It won't slide."),t.addMessage(ge.BOX_AT_END,"The structure has reached the end of the groove."),t.addMessage(ge.ENTER_MIRROR,"You step into the strange wooden structure."),t.addMessage(ge.EXIT_MIRROR,"You climb out of the structure to the north."),t.addMessage(ge.CANT_EXIT,"You can't exit that way. The structure is not properly positioned."),t.addMessage(ge.NO_MIRROR_HERE,"There is no structure here to enter."),t.addMessage(ge.TBAR_DIRECTION,"The arrow on the T-bar points {direction}."),t.addMessage(Io.DARKNESS_DESCENDS,"The darkness seems to press in around you. You sense a presence watching from the shadows..."),t.addMessage(Io.CLOAKED_FIGURE,'A cloaked figure appears from the shadows! "So, you have discovered the secret. Your quest is nearly at an end, but the final challenge awaits." The figure gestures, and reality dissolves around you...'),t.addMessage(Io.TELEPORT,"When your vision clears, you find yourself in a completely different place."),t.addMessage(Io.ENDGAME_BEGINS,"The endgame has begun. Your score is now 15 out of a possible 100."),t.addMessage(up.ENTER_TREASURY,"You have entered the Treasury of Zork!"),t.addMessage(up.VICTORY_TEXT,"Congratulations, brave adventurer! You have completed the greatest of all treasure hunts and discovered the legendary Treasury of Zork. The riches of the Great Underground Empire are yours!"),t.addMessage(up.FINAL_SCORE,`Your final score is {totalScore} points out of a possible 716 (616 main game + 100 endgame).
Endgame score: {endgameScore}/100
Main game score: {mainScore}/616`),t.addMessage(up.CONGRATULATIONS,`You have achieved the rank of MASTER ADVENTURER.

*** THE END ***`),t.addMessage(oc.ATTACKS,"A large vampire bat swoops down from the ceiling and grabs you!"),t.addMessage(oc.CARRIES_AWAY,"The bat carries you off into the darkness..."),t.addMessage(oc.COWERS,"The vampire bat cowers away from you, repelled by the smell of garlic!"),t.addMessage(oc.DROPPED,"The bat drops you unceremoniously."),t.addMessage(Hn.WALK_THROUGH,"You feel somewhat disoriented as you pass through..."),t.addMessage(Hn.NO_WALL,"I can't see any {direction} wall here."),t.addMessage(Hn.CANT_WALK_THROUGH,"You can't walk through that."),t.addMessage(pp.COMPASS_SPINNING,"As you enter, your compass starts spinning wildly."),t.addMessage(pp.CANNOT_GET_BEARINGS,"You cannot get your bearings...")}function YL(t){t.addMessage("dungeo.window.opened","With great effort, you open the window far enough to allow entry."),t.addMessage("dungeo.rug.moved.reveal_trapdoor","Moving the rug reveals a trap door."),t.addMessage("dungeo.trapdoor.opened","The door reluctantly opens to reveal a rickety staircase descending into darkness."),t.addMessage(mz.SLAMS_SHUT,"The door crashes shut, and you hear someone barring it."),t.addMessage("dungeo.treasure.scored","Your score just went up by {points} points!"),t.addMessage(Nm.ENTERED,"{message}"),t.addMessage(Nm.EXITED,"{message}"),t.addMessage(Nm.OUTPUT,"{output}"),t.addMessage(Nm.UNKNOWN_COMMAND,"{message}"),t.addMessage(jn.GLACIER_MELTS,"The torch hits the glacier and explodes into a great ball of flame, devouring the glacier. The water from the melting glacier rushes downstream, carrying the torch with it. In the place of the glacier, there is a passageway leading west."),t.addMessage(jn.THROW_COLD,"The torch bounces off the glacier harmlessly. Perhaps if it were lit, it might have more effect."),t.addMessage(jn.THROW_WRONG_ITEM,"The glacier is unmoved by your ridiculous attempt."),t.addMessage(jn.MELT_DEATH,"Part of the glacier melts, drowning you under a torrent of water."),t.addMessage(jn.MELT_NO_FLAME,"You certainly won't melt it with a {instrument}."),t.addMessage(jn.MELT_NOTHING,"You can't melt that."),t.addMessage(jn.MELT_NO_INSTRUMENT,"Melt it with what?"),t.addMessage(qv.PUNCTURED,"The sharp object you are carrying punctures the boat! The air rushes out and the boat deflates beneath you."),t.addMessage(qv.STICK_POKES,"The {item} punctures the boat! With a loud hiss, the boat deflates."),t.addMessage(sz.NO_BOAT,"The water is too cold and the current too strong to swim. You need a boat."),t.addMessage(dz.DEATH,`You tumble over Aragain Falls, plunging hundreds of feet to your doom in the mist below.

    **** You have died ****`),t.addMessage(Td.DEATH,`Oh dear, you seem to have let your open flame get too close to the gas. **BOOOOOM**

    **** You have died ****`),t.addMessage(Td.LIGHT_DEATH,`How sad for an adventurer of your caliber to perish by lighting a flame in a room full of gas. **BOOOOOM**

    **** You have died ****`),t.addMessage(he.MAT_PLACED,"You slide the mat under the door."),t.addMessage(he.MAT_NOT_HELD,"You don't have a mat."),t.addMessage(he.MAT_ALREADY_PLACED,"The mat is already under the door."),t.addMessage(he.NO_DOOR_HERE,"There's no door here to put anything under."),t.addMessage(he.KEY_PUSHED,"You insert the screwdriver in the keyhole and push. You hear a small clink as the key falls on the other side."),t.addMessage(he.KEY_PUSHED_NO_MAT,"You insert the screwdriver in the keyhole and push. You hear a small clink as the key falls... and then nothing. Without something to catch it, the key has slid away under the door, out of reach."),t.addMessage(he.KEY_ALREADY_PUSHED,"The keyhole is empty."),t.addMessage(he.NO_SCREWDRIVER,"You don't have anything suitable to push the key out."),t.addMessage(he.MAT_PULLED,"You pull the mat back from under the door."),t.addMessage(he.MAT_PULLED_WITH_KEY,"You pull the mat back from under the door. A small brass key comes with it!"),t.addMessage(he.MAT_NOT_UNDER_DOOR,"There's no mat under the door."),t.addMessage(he.DOOR_LOCKED,"The door is locked, and there is no keyhole on this side."),t.addMessage(he.DOOR_UNLOCKED,"The door is now unlocked."),t.addMessage(he.WRONG_KEY,"That key doesn't fit this lock."),t.addMessage(he.KEYHOLE_BLOCKED,"Something is blocking the keyhole from the other side."),t.addMessage(hb.PENALTY,"You have lost 10 points for dying."),t.addMessage(hb.GAME_OVER,`You have died too many times. The Great Underground Empire claims another victim.

    **** GAME OVER ****`),t.addMessage(hb.DEATH_COUNT,"Deaths: {deaths}"),t.addMessage(Vt.EAT_ME_SHRINK,"Suddenly the room seems to be getting much larger. Or maybe you are getting much smaller... In fact, you seem to have shrunk to the size of a mouse!"),t.addMessage(Vt.BLUE_ENLARGE,"Suddenly, the room around you seems to be getting much smaller. Or maybe you are getting much bigger... In fact, you seem to have grown back to your normal size!"),t.addMessage(Vt.BLUE_CRUSH,`You begin to grow at an alarming rate, but the room is too small to contain you! You are crushed to death.

    **** You have died ****`),t.addMessage(Vt.ORANGE_EXPLODE,`The cake suddenly explodes in a tremendous blast! You are killed instantly.

    **** You have died ****`),t.addMessage(Vt.RED_TERRIBLE,"What a terrible taste!"),t.addMessage(Vt.RED_POOL_DISSOLVE,"The red cake sails through the air and lands with a splash in the pool of goop. As it dissolves, the pool begins to evaporate! In a few moments, the pool is gone, revealing something on the floor."),t.addMessage(Vt.SPICES_REVEALED,"A tin of rare spices is now visible where the pool used to be."),t.addMessage("dungeo.safe.rusted_shut","The box is rusted and will not open."),t.addMessage("dungeo.safe.no_door","The box has no door!")}function _z(t){NL(t),DL(t),LL(t),VL(t),YL(t),dle(t)}function dle(t){t.addMessage("if.action.taking.taken_from","Taken."),t.addMessage("game.started.banner",`{title}

Story v{version} (built {buildDate})
Sharpee v{engineVersion}

A port of Mainframe Zork (1981)
By {author}
Ported by David Cornelson

Type HELP for instructions, ABOUT for credits.`),t.addMessage("if.action.version",`{title}

Story v{version} (built {buildDate})
Sharpee v{engineVersion}

A port of Mainframe Zork (1981)
By {author}
Ported by David Cornelson

Type HELP for instructions, ABOUT for credits.`)}var Kz=_(Sz()),$z=_(Rz()),Qz=_(Mz()),Xz=_(E());var Sle={SLAMS_SHUT:"dungeo.trapdoor.slams_shut"};function Pz(t,e){return{id:"dungeo.puzzle.trapdoor",description:"Trap door slams shut when player descends to cellar",initialState:"open",states:{open:{description:"Trap door is open, player can go up/down",transitions:[{target:"barred",trigger:{type:"event",eventId:"if.event.actor_moved",filter:{fromRoom:t,toRoom:e}},effects:[{type:"set_trait",entityRef:"$trapdoor",trait:"openable",property:"isOpen",value:!1},{type:"set_trait",entityRef:"$trapdoor",trait:"identity",property:"description",value:"The dusty cover of a closed trap door."},{type:"set_state",key:"dungeo.trapdoor.barred",value:!0},{type:"message",messageId:Sle.SLAMS_SHUT}]}]},barred:{description:"Trap door barred from above",terminal:!0}}}}var kz=_(E()),aM={PENALTY:"dungeo.death.penalty",GAME_OVER:"dungeo.death.game_over"},Ale=10;function Bz(){function t(e){return{type:"custom",execute:(r,n,i)=>{r.awardScore(`death-penalty-${e}`,-Ale,"Death penalty");let o=r.getCapability(kz.StandardCapabilities.SCORING);return o&&(o.deaths=e),{}}}}return{id:"dungeo.death_penalty",description:"Tracks player deaths, deducts 10 pts each, game over after 2",initialState:"alive",states:{alive:{description:"Player has not died",transitions:[{target:"one_death",trigger:{type:"event",eventId:"if.event.player.died"},effects:[t(1),{type:"message",messageId:aM.PENALTY,params:{deaths:1}}]}]},one_death:{description:"Player has died once",transitions:[{target:"game_over",trigger:{type:"event",eventId:"if.event.player.died"},effects:[t(2),{type:"set_state",key:"dungeo.game_over",value:!0},{type:"set_state",key:"dungeo.game_over_reason",value:"too_many_deaths"},{type:"message",messageId:aM.GAME_OVER,params:{deaths:2}},{type:"emit_event",eventType:"game.over",data:{messageId:aM.GAME_OVER,reason:"too_many_deaths",deaths:2}}]}]},game_over:{description:"Player has died twice \u2014 game over",terminal:!0}}}}var Rle={REALITY_ALTERED:"dungeo.scoring.reality_altered"};function Cle(){return{type:"custom",execute:(t,e,r)=>(t.getDataStore().state["dungeo.reality_altered_pending"]=!1,{messages:[{messageId:Rle.REALITY_ALTERED}]})}}function xz(){return{id:"dungeo.reality_altered",description:'Shows "reality altered" message after thief dies and player checks score (ADR-078)',initialState:"inactive",states:{inactive:{description:"Waiting for thief death + score check",transitions:[{target:"shown",trigger:{type:"event",eventId:"if.event.score_displayed"},guard:{type:"custom",evaluate:(t,e,r)=>t.getDataStore().state["dungeo.reality_altered_pending"]===!0},effects:[Cle()]}]},shown:{description:"Reality altered message has been displayed",terminal:!0}}}}var Nb={ENTER_TREASURY:"dungeo.victory.enter_treasury",VICTORY_TEXT:"dungeo.victory.text",FINAL_SCORE:"dungeo.victory.final_score",CONGRATULATIONS:"dungeo.victory.congratulations"};function wle(){return{type:"custom",execute:(t,e,r)=>{let i=(t.getStateValue("scoring.endgameScore")??65)+35;t.setStateValue("scoring.endgameScore",i),t.setStateValue("game.victory",!0),t.setStateValue("game.ended",!0);let o=t.getStateValue("scoring.score")??616,a=o+i;return{messages:[{messageId:Nb.ENTER_TREASURY},{messageId:Nb.VICTORY_TEXT},{messageId:Nb.FINAL_SCORE,params:{endgameScore:i,mainScore:o,totalScore:a}},{messageId:Nb.CONGRATULATIONS}],events:[{type:"game.victory",data:{totalScore:a,endgameScore:i,mainScore:o}}]}}}}function jz(t){return{id:"dungeo.victory",description:"Triggers victory when player enters Treasury of Zork during endgame",initialState:"playing",states:{playing:{description:"Game in progress",transitions:[{target:"victory",trigger:{type:"event",eventId:"if.event.actor_moved",filter:{toRoom:t}},guard:{type:"state",key:"game.endgameStarted",value:!0},effects:[wle()]}]},victory:{description:"Player has won the game",terminal:!0}}}}function Wz(t,e,r){t.registerParsedCommandTransformer((n,i)=>!Lm(i)||n.action!==vr&&n.action!==eo?n:{...n,structure:{...n.structure,directObject:void 0,indirectObject:void 0}}),t.registerParsedCommandTransformer((n,i)=>n.action!==bt?n:{...n,structure:{...n.structure,directObject:void 0,indirectObject:void 0}}),t.registerParsedCommandTransformer(p1()),t.registerParsedCommandTransformer(oz()),t.registerParsedCommandTransformer(x1()),t.registerParsedCommandTransformer(VF()),t.registerParsedCommandTransformer(YF()),t.registerParsedCommandTransformer(az()),t.registerParsedCommandTransformer(fz()),uz(r.aragainFallsId),t.registerParsedCommandTransformer(lz()),t.registerParsedCommandTransformer(gz())}var hp=_(E());function Uz(t,e,r){$1(t,e,r.forestIds,r.damIds,r.bankIds,r.balloonIds),RN(e,t);let n=[r.undergroundIds.cellar,r.undergroundIds.trollRoom,r.undergroundIds.eastWestPassage,r.roundRoomIds.roundRoom,r.undergroundIds.northSouthCrawlway,r.undergroundIds.gallery,r.undergroundIds.studio,r.templeIds.temple,r.endgameIds.narrowCorridor,r.damIds.damLobby,r.damIds.dam,r.mazeIds.maze1,r.mazeIds.maze5,r.mazeIds.maze11];if(KY(t,r.coalMineIds.squeakyRoom,n),$Y(t,e,r.endgameIds.entryToHades,r.endgameIds.landOfDead),QY(t,r.roundRoomIds.roundRoom),f1(t,r.royalPuzzleIds),hz(e),yz(e),wD(t,e,r.wellRoomIds.dingyCloset),vz(t,r.wellRoomIds.lowRoom,r.wellRoomIds.machineRoom,r.wellRoomIds.teaRoom),JY(t,e,r.endgameIds.tomb,r.endgameIds.topOfStairs),AD(t,r.undergroundIds.trollRoom),ND(t),V_(t,r.damIds.maintenanceRoom),r.volcanoIds){let i=e.getAllEntities().find(c=>c.get(hp.IdentityTrait)?.name==="brick"),o=e.getAllEntities().find(c=>c.get(hp.IdentityTrait)?.name==="shiny wire"),a=e.getAllEntities().find(c=>{let d=c.get(hp.IdentityTrait);return d?.name==="hole"&&d.aliases?.includes("slot")}),s=e.getAllEntities().find(c=>c.get(hp.IdentityTrait)?.name==="safe");i&&o&&a&&s&&BD(t,{brickId:i.id,fuseWireId:o.id,dustyRoomId:r.volcanoIds.dustyRoom,wideLedgeId:r.volcanoIds.wideLedge,slotId:a.id,safeId:s.id})}}function Hz(t,e,r,n){nz(t,e,r.endgameIds.smallRoom,r.endgameIds.stoneRoom,n),dF(t,e,r.endgameIds.hallway,r.endgameIds.insideMirror,r.endgameIds.dungeonEntrance,n)}function qz(t,e,r,n){AG(e,r,n.treasureRoomId,n.surfaceRoomIds),HY(e,r,n.cyclopsRoomId),AV(e),zY(e,r,n.dungeonEntranceId),BN(t)}var Yz=_(E());var Gz=_(E());function Fz(t,e){t.registerHandler("if.event.actor_moved",r=>{let n=r.data;if(!n?.fromRoom)return[];let i=e.getPlayer();if(!i)return[];if(e.getLocation(i.id)!==n.toRoom)return[];let a=e.getContents(n.fromRoom);for(let s of a){let c=s.get(Gz.CombatantTrait);if(!c||!c.isAlive||typeof s.attributes[pe.VILLAIN_OSTRENGTH]!="number")continue;let u=Pl(s);s.attributes[pe.VILLAIN_OSTRENGTH]=u,s.attributes[pe.VILLAIN_STAGGERED]=!1,s.attributes[pe.VILLAIN_UNCONSCIOUS]=!1,s.attributes.thiefEngrossed&&(s.attributes.thiefEngrossed=!1)}return i.attributes[pe.STAGGERED]=!1,[]})}var Db=_(E());function Vz(t,e,r){t.registerHandler("if.event.actor_moved",n=>{let i=n.data;if(!i?.toRoom||i.toRoom!==r)return[];let o=e.getPlayer();if(!o||i.actor?.id!==o.id)return[];let a=e.getAllEntities().find(d=>{let u=d.get(Db.IdentityTrait);return u?u.name==="seedy-looking thief"||u.aliases?.includes("thief"):!1});if(!a)return[];let s=a.get(Db.CombatantTrait);return!s||!s.isAlive?[]:e.getLocation(a.id)===r?[]:(e.moveEntity(a.id,r),s.hostile=!0,[{type:"message",id:"dungeo.treasure_room.thief_summoned"}])})}function zz(t,e,r){let n=t.getEventProcessor();if(r.mirrorConfig){let i=hV(r.mirrorConfig);n.registerHandler("if.event.touched",i)}Nle(n,e,r.bottomOfShaftId),r.roomVisitScoring&&Dle(n,e,r.roomVisitScoring),Fz(n,e),r.treasureRoomId&&Vz(n,e,r.treasureRoomId)}function Nle(t,e,r){t.registerHandler("if.event.actor_moved",n=>{let i=n.data;if(!i?.toRoom||i.toRoom!==r)return[];let o=e.getPlayer();if(!o||i.actor?.id!==o.id)return[];let a=e.getEntity(r);return a?(!Yz.VisibilityBehavior.isDark(a,e)&&e.awardScore("light-shaft",10,"LIGHT-SHAFT achievement"),[]):[]})}function Dle(t,e,r){t.registerHandler("if.event.actor_moved",n=>{let i=n.data;if(!i?.toRoom)return[];let o=e.getPlayer();if(!o||i.actor?.id!==o.id)return[];let a=r.get(i.toRoom);return a&&e.awardScore(`room:${i.toRoom}`,a,"Visited room"),[]})}function Zz(t,e,r){let n={aragainFallsId:r.frigidRiverIds.aragainFalls};Wz(t,e,n);let i=new Kz.SchedulerPlugin;t.getPluginRegistry().register(i);let o={forestIds:r.forestIds,damIds:r.damIds,bankIds:r.bankIds,balloonIds:r.balloonIds,undergroundIds:r.undergroundIds,roundRoomIds:r.roundRoomIds,coalMineIds:r.coalMineIds,templeIds:r.templeIds,endgameIds:r.endgameIds,mazeIds:r.mazeIds,houseInteriorIds:r.houseInteriorIds,royalPuzzleIds:r.royalPuzzleIds,wellRoomIds:r.wellRoomIds,volcanoIds:r.volcanoIds};Uz(i.getScheduler(),e,o);let a={endgameIds:{smallRoom:r.endgameIds.smallRoom,stoneRoom:r.endgameIds.stoneRoom,hallway:r.endgameIds.hallway,insideMirror:r.endgameIds.insideMirror,dungeonEntrance:r.endgameIds.dungeonEntrance}};Hz(t,e,a,i.getScheduler());let s=new $z.NpcPlugin;t.getPluginRegistry().register(s);let d={surfaceRoomIds:[...Object.values(r.whiteHouseIds),...Object.values(r.houseInteriorIds),...Object.values(r.forestIds)],treasureRoomId:r.mazeIds.treasureRoom,cyclopsRoomId:r.mazeIds.cyclopsRoom,dungeonEntranceId:r.endgameIds.dungeonEntrance};qz(t,s.getNpcService(),e,d);let u=new Qz.StateMachinePlugin;t.getPluginRegistry().register(u);let m=u.getRegistry(),f=Lle(e,"trap door");f&&m.register(Pz(r.houseInteriorIds.livingRoom,r.undergroundIds.cellar),{$trapdoor:f,$cellar:r.undergroundIds.cellar}),m.register(Bz()),m.register(IF(),{$aragainFalls:r.frigidRiverIds.aragainFalls,$onTheRainbow:r.frigidRiverIds.onTheRainbow}),m.register(xz()),m.register(jz(r.endgameIds.treasury));let g={mirrorConfig:r.mirrorConfig,bottomOfShaftId:r.coalMineIds.bottomOfShaft,balloonIds:r.balloonIds,treasureRoomId:r.mazeIds.treasureRoom,roomVisitScoring:r.roomVisitScoring};zz(t,e,g)}function Lle(t,e){for(let r of t.getAllEntities())if(r.get(Xz.IdentityTrait)?.name===e)return r.id;return null}var Dr={id:"dungeon",title:"DUNGEON",author:"Tim Anderson, Marc Blank, Bruce Daniels, and Dave Lebling",version:lp.version,buildDate:lp.buildDate,description:"A port of Mainframe Zork (1981)",custom:{portedBy:"David Cornelson"}},sM=class{constructor(){l(this,"config",Dr);l(this,"world");l(this,"whiteHouseIds",{});l(this,"houseInteriorIds",{});l(this,"forestIds",{});l(this,"undergroundIds",{});l(this,"damIds",{});l(this,"coalMineIds",{});l(this,"templeIds",{});l(this,"volcanoIds",{});l(this,"bankIds",{});l(this,"wellRoomIds",{});l(this,"frigidRiverIds",{});l(this,"mazeIds",{});l(this,"royalPuzzleIds",{});l(this,"endgameIds",{});l(this,"roundRoomIds",{});l(this,"balloonIds",null);l(this,"mirrorConfig",null);l(this,"roomVisitScoring",new Map)}initializeWorld(e){this.world=e,e.createEntity("story-info",$.EntityType.OBJECT).add(new $.StoryInfoTrait({title:Dr.title,author:Array.isArray(Dr.author)?Dr.author.join(", "):Dr.author,version:Dr.version,description:Dr.description,buildDate:lp.buildDate,engineVersion:lp.engineVersion,portedBy:Dr.custom?.portedBy})),Ga.MetaCommandRegistry.register(vd),Ga.MetaCommandRegistry.register(eo),Ga.MetaCommandRegistry.register(vr),Ga.MetaCommandRegistry.register(_d),Ga.MetaCommandRegistry.register(bd),Ga.MetaCommandRegistry.register(ic),e.registerCapability($.StandardCapabilities.SCORING,{initialData:{moves:0,deaths:0}}),(0,$.hasCapabilityBehavior)(_r.type,"if.action.lowering")||(0,$.registerCapabilityBehavior)(_r.type,"if.action.lowering",kw),(0,$.hasCapabilityBehavior)(_r.type,"if.action.raising")||(0,$.registerCapabilityBehavior)(_r.type,"if.action.raising",Bw),(0,$.hasActionInterceptor)(En.type,"if.action.taking")||(0,$.registerActionInterceptor)(En.type,"if.action.taking",jw),(0,$.hasCapabilityBehavior)(En.type,"if.scope.visible")||(0,$.registerCapabilityBehavior)(En.type,"if.scope.visible",Ww),(0,$.hasActionInterceptor)(vn.type,"if.action.taking")||(0,$.registerActionInterceptor)(vn.type,"if.action.taking",Hw),(0,$.hasActionInterceptor)(vn.type,"if.action.talking")||(0,$.registerActionInterceptor)(vn.type,"if.action.talking",qw),(0,$.hasCapabilityBehavior)(_n.type,"if.action.opening")||(0,$.registerCapabilityBehavior)(_n.type,"if.action.opening",Gw),this.whiteHouseIds=TV(e),this.houseInteriorIds=_V(e),this.forestIds=IV(e),this.undergroundIds=RV(e),this.damIds=NV(e),this.coalMineIds=PV(e),this.templeIds=xV(e),this.volcanoIds=GV(e),this.bankIds=zV(e),this.wellRoomIds=XV(e),this.frigidRiverIds=sY(e),this.mazeIds=uY(e),this.royalPuzzleIds=xG(e),this.endgameIds=yY(e),this.roundRoomIds=eY(e),this.houseInteriorIds,this.whiteHouseIds.behindHouse,OV(e,this.forestIds,this.whiteHouseIds.northOfHouse,this.whiteHouseIds.behindHouse),this.undergroundIds,this.houseInteriorIds.livingRoom,CV(e,this.undergroundIds,this.houseInteriorIds.kitchen),rY(e,this.roundRoomIds,this.undergroundIds.eastWestPassage),nY(e,this.roundRoomIds,{northSouthPassage:this.templeIds.northSouthPassage,grailRoom:this.templeIds.grailRoom,windingPassage:this.templeIds.windingPassage}),iY(e,this.roundRoomIds,this.wellRoomIds.engravingsCave),oY(e,this.roundRoomIds,this.damIds.deepCanyon),aY(e,this.roundRoomIds,this.mazeIds.maze1),jV(e,this.templeIds,this.undergroundIds.chasm),WV(e,this.templeIds,this.wellRoomIds.cave),HV(e,this.templeIds,this.frigidRiverIds.rockyShore),UV(e,this.templeIds,this.damIds.dam),FV(e,this.volcanoIds,this.undergroundIds.rockyCrawl),DV(e,this.damIds,this.frigidRiverIds.frigidRiver1),LV(e,this.damIds,this.volcanoIds.glacierRoom),KV(e,this.bankIds,this.undergroundIds.cellar,this.undergroundIds.gallery,this.undergroundIds.northSouthCrawlway),e.setStateValue("dungeo.bank.roomIds",this.bankIds),cY(e,this.frigidRiverIds,this.damIds.damBase),dY(e,this.frigidRiverIds,this.forestIds.canyonBottom),mY(e,this.mazeIds,this.forestIds.clearing),pY(e,this.mazeIds,this.houseInteriorIds.livingRoom),fY(e,this.mazeIds,this.undergroundIds.trollRoom),gY(e,this.mazeIds,this.roundRoomIds.roundRoom),jG(e,this.royalPuzzleIds,this.mazeIds.treasureRoom),g1(e,this.royalPuzzleIds),kV(e,this.coalMineIds,this.undergroundIds.cellar),ZV(e,this.wellRoomIds,this.endgameIds.entryToHades),EV(e,this.whiteHouseIds,this.houseInteriorIds.kitchen),bV(e,this.houseInteriorIds,this.undergroundIds.cellar),SV(e,this.forestIds),wV(e,this.undergroundIds),MV(e,this.damIds),BV(e,this.coalMineIds),qV(e,this.templeIds),this.balloonIds=VV(e,this.volcanoIds),$V(e,this.bankIds),JV(e,this.wellRoomIds),lY(e,this.frigidRiverIds),hY(e,this.mazeIds),tY(e,this.roundRoomIds),TY(e,{smallRoom:this.endgameIds.smallRoom,stoneRoom:this.endgameIds.stoneRoom,parapet:this.endgameIds.parapet,insideMirror:this.endgameIds.insideMirror,prisonCell:this.endgameIds.prisonCell}),this.initializeMirrorRoomHandler(e);let i=e.getContents(this.volcanoIds.glacierRoom).find(a=>a.get($.IdentityTrait)?.name==="glacier");i&&i.add(new Kr({glacierRoomId:this.volcanoIds.glacierRoom,westDestination:this.volcanoIds.rubyRoom,torchDestination:this.damIds.streamView})),(0,$.hasActionInterceptor)(Kr.type,"if.action.throwing")||(0,$.registerActionInterceptor)(Kr.type,"if.action.throwing",Yw),(0,$.hasActionInterceptor)(et.type,"if.action.entering")||(0,$.registerActionInterceptor)(et.type,"if.action.entering",Vw),(0,$.hasActionInterceptor)(to.type,"if.action.putting")||(0,$.registerActionInterceptor)(to.type,"if.action.putting",zw),(0,$.hasActionInterceptor)(Ps.type,"if.action.dropping")||(0,$.registerActionInterceptor)(Ps.type,"if.action.dropping",Qw),(0,$.hasActionInterceptor)(io.type,"if.action.taking")||(0,$.registerActionInterceptor)(io.type,"if.action.taking",Xw),(0,$.hasActionInterceptor)(Bs.type,"if.action.entering_room")||(0,$.registerActionInterceptor)(Bs.type,"if.action.entering_room",Zw),(0,$.hasActionInterceptor)(Ds.type,"if.action.putting")||(0,$.registerActionInterceptor)(Ds.type,"if.action.putting",Fw),(0,$.hasActionInterceptor)(oo.type,"if.action.opening")||(0,$.registerActionInterceptor)(oo.type,"if.action.opening",eN),(0,$.hasActionInterceptor)(oo.type,"if.action.closing")||(0,$.registerActionInterceptor)(oo.type,"if.action.closing",tN),(0,$.hasActionInterceptor)($.TraitType.COMBATANT,"if.action.attacking")||(0,$.registerActionInterceptor)($.TraitType.COMBATANT,"if.action.attacking",AY),(0,Ga.registerNpcCombatResolver)(NY),e.setStateValue("dungeo.ghost_ritual.basin_room_id",this.templeIds.basinRoom),e.setStateValue("dungeo.ghost_ritual.gallery_id",this.undergroundIds.gallery),jF({reservoirSouth:this.damIds.reservoirSouth,reservoir:this.damIds.reservoir,reservoirNorth:this.damIds.reservoirNorth}),oL(e),this.roomVisitScoring=new Map([[this.houseInteriorIds.kitchen,10],[this.undergroundIds.cellar,25],[this.mazeIds.strangePassage,10],[this.mazeIds.treasureRoom,25],[this.undergroundIds.eastWestPassage,5],[this.endgameIds.landOfDead,30],[this.wellRoomIds.topOfWell,10],[this.endgameIds.insideMirror,15],[this.endgameIds.tomb,5],[this.endgameIds.topOfStairs,10],[this.endgameIds.dungeonEntrance,20],[this.endgameIds.hallway,15],[this.endgameIds.treasury,35]]),e.setMaxScore(616);let o=e.getPlayer();o&&e.moveEntity(o.id,this.whiteHouseIds.westOfHouse)}initializeMirrorRoomHandler(e){if(!e.getEntity(this.templeIds.mirrorRoom))return;let i=e.getContents(this.templeIds.mirrorRoom).find(o=>o.get("identity")?.aliases?.includes("mirror"));if(!i){console.warn("Mirror not found in Mirror Room");return}this.mirrorConfig={mirrorRoomId:this.templeIds.mirrorRoom,mirrorId:i.id,stateA:{north:this.templeIds.narrowCrawlway,west:this.templeIds.windingPassage,east:this.wellRoomIds.cave},stateB:{north:this.coalMineIds.steepCrawlway,west:this.coalMineIds.coldPassage,east:this.templeIds.smallCave}},yV(e,this.mirrorConfig)}createPlayer(e){let r=e.getPlayer();if(r)return r.add(new $.IdentityTrait({name:"yourself",description:"A brave adventurer, ready to explore the Great Underground Empire.",aliases:["self","myself","me","yourself","adventurer"],properName:!0,article:""})),r.has("actor")||r.add(new $.ActorTrait({isPlayer:!0})),r.has("container")||r.add(new $.ContainerTrait({capacity:{maxItems:15,maxWeight:100}})),r.has("combatant")||r.add(new $.CombatantTrait({health:100,maxHealth:100,skill:50,baseDamage:1,armor:0,hostile:!1,canRetaliate:!1})),r;let n=e.createEntity("yourself",$.EntityType.ACTOR);return n.add(new $.IdentityTrait({name:"yourself",description:"A brave adventurer, ready to explore the Great Underground Empire.",aliases:["self","myself","me","yourself","adventurer"],properName:!0,article:""})),n.add(new $.ActorTrait({isPlayer:!0})),n.add(new $.ContainerTrait({capacity:{maxItems:15,maxWeight:100}})),n.add(new $.CombatantTrait({health:100,maxHealth:100,skill:50,baseDamage:1,armor:0,hostile:!1,canRetaliate:!1})),n}extendParser(e){WY(e)}extendLanguage(e){_z(e)}getCustomActions(){return gV}initialize(){}isComplete(){return!1}onEngineReady(e){Zz(e,this.world,{whiteHouseIds:this.whiteHouseIds,houseInteriorIds:this.houseInteriorIds,forestIds:this.forestIds,undergroundIds:this.undergroundIds,frigidRiverIds:this.frigidRiverIds,roundRoomIds:this.roundRoomIds,damIds:this.damIds,bankIds:this.bankIds,coalMineIds:this.coalMineIds,templeIds:this.templeIds,mazeIds:this.mazeIds,endgameIds:this.endgameIds,royalPuzzleIds:this.royalPuzzleIds,wellRoomIds:this.wellRoomIds,balloonIds:this.balloonIds||void 0,mirrorConfig:this.mirrorConfig||void 0,volcanoIds:this.volcanoIds,roomVisitScoring:this.roomVisitScoring})}},su=new sM;var Mle="dungeo-theme";Yc.applyEarlyTheme(Mle);var iK=Dr.title,oK=Dr.description||"",aK=Array.isArray(Dr.author)?Dr.author.join(", "):Dr.author,sK=Dr.custom?.portedBy||"";function Ple(){return`Commands to DUNGEO are simple sentences: <verb>, <verb> <object>,
and <verb> <object> <indirect object> are examples.

Some useful commands are:

<direction>     Walk in that direction. Common directions
                are N, S, E, W, NE, NW, SE, SW, U(p), and D(own).
AGAIN (G)       Repeat the last command.
LOOK (L)        Describe the surroundings.
ROOM            Print the verbose room description without objects.
RNAME           Print the short room name.
OBJECTS         Print the objects in the room.
INVENTORY (I)   Describe your possessions.
DIAGNOSE        Describe your state of health.
WAIT (Z)        Causes "time" to pass.
SCORE           Print your score and number of moves.
SAVE            Save the game to a named slot.
RESTORE         Restore a saved game.
RESTART         Start the game over.
QUIT (Q)        Leave the game.`}function kle(){return[iK,oK,`By ${aK}`,`Ported by ${sK}`,"",`Sharpee v${ob} | Game v${nb}`,`Built: ${ib}`].filter(Boolean).join(`
`)}function Ble(t){let e=t.hasItems,r=t.items,n=t.containerContents;if(!e||!r||r.length===0)return"There is nothing here.";let i=[];for(let o of r)i.push(`There is a ${o.name} here.`);if(n)for(let o of n){let a=o.items.map(c=>c.name).join(", "),s=o.preposition==="in"?"In":"On";i.push(`${s} the ${o.containerName}: ${a}`)}return i.join(`
`)}function xle(t,e){if(t.type==="dungeo.event.rname"){let r=t.data?.roomName;return e.displayText(r||"Unknown"),!0}return t.type==="dungeo.event.objects"?(e.displayText(Ble(t.data)),!0):!1}var Lb=new wm({storagePrefix:"dungeo-",defaultTheme:"dos-classic",themes:[{id:"dos-classic",name:"DOS Classic"},{id:"modern-dark",name:"Modern Dark"},{id:"retro-terminal",name:"Retro Terminal"},{id:"paper",name:"Paper"}],storyInfo:{title:iK,description:oK,authors:aK,portedBy:sK,version:nb,engineVersion:ob,buildDate:ib},callbacks:{getHelpText:Ple,getAboutText:kle,handleStoryEvent:xle}});async function Jz(){console.log("=== DUNGEO BROWSER START ==="),Lb.initialize({statusLocation:document.getElementById("location-name"),statusScore:document.getElementById("score-turns"),textContent:document.getElementById("text-content"),mainWindow:document.getElementById("main-window"),commandInput:document.getElementById("command-input"),modalOverlay:document.getElementById("modal-overlay"),saveDialog:document.getElementById("save-dialog"),restoreDialog:document.getElementById("restore-dialog"),startupDialog:document.getElementById("startup-dialog"),saveNameInput:document.getElementById("save-name-input"),saveSlotsListEl:document.getElementById("save-slots-list"),restoreSlotsListEl:document.getElementById("restore-slots-list"),noSavesMessage:document.getElementById("no-saves-message"),startupSaveInfo:document.getElementById("startup-save-info"),menuBar:document.getElementById("menu-bar")});let t=new Mb.WorldModel,e=t.createEntity("player",Mb.EntityType.ACTOR);t.setPlayer(e.id);let r=new rK.LanguageProvider,n=new tK.Parser(r);su.extendParser&&su.extendParser(n),su.extendLanguage&&su.extendLanguage(r);let i=new nK.PerceptionService,o=new eK.GameEngine({world:t,player:e,parser:n,language:r,perceptionService:i});Lb.connectEngine(o,t),o.setStory(su),o.registerSaveRestoreHooks(Lb.getSaveRestoreHooks()),await Lb.start()}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",Jz):Jz();})();
//# sourceMappingURL=dungeo.js.map
