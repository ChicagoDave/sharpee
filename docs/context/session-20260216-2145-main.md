# Session Summary: 2026-02-16 - main (CST)

## Status: Code Complete, Needs Build & Test

## Goals
- Audit scoring system against canonical FORTRAN source
- Remove non-canonical action bonuses that were added as Dungeo-specific content
- Fix room scoring map ID errors
- Create the missing Strange Passage room (FORTRAN: BLROO)

## Completed

### FORTRAN Score Audit

Audited the entire scoring system against the canonical MDL/FORTRAN source in `docs/internal/dungeon-81/original_source/`. Discovered that the FORTRAN has exactly 5 SCORE-UPD calls in the entire source:

1. `rooms.394:777` — SCORE-OBJ (awards OFVAL on take)
2. `rooms.394:783` — SCORE-ROOM (awards RVAL on room entry)
3. `rooms.394:1154` — Death penalty (-10)
4. `act2.92:168` — LIGHT-SHAFT (+10)
5. No other scoring mechanisms exist in the FORTRAN source

Confirmed the 616 max breaks down as: 115 (main room RVALs) + 260 (OFVAL totals) + 231 (OTVAL totals) + 10 (LIGHT-SHAFT) = 616.

### Removed 4 Non-Canonical Action Bonuses (55 pts total)

These bonuses existed in Dungeo but have no equivalent in the FORTRAN source:

| Bonus | Points | File |
|-------|--------|------|
| `thief-killed` | 25 | `melee-interceptor.ts` |
| `troll-killed` | 10 | `melee-interceptor.ts` |
| `cyclops-fled` | 10 | `cyclops-entity.ts` |
| `exorcism` | 10 | `exorcism-handler.ts` |

Only `light-shaft` (10 pts) remains as the sole canonical action bonus. The scoring call in `melee-interceptor.ts` was removed entirely for both troll and thief kills.

### Fixed Room Scoring Map in index.ts

Three room ID entries were pointing to wrong rooms:

| Old Entry | Pts | Fix | FORTRAN Room |
|-----------|-----|-----|--------------|
| `volcanoIds.volcanoBottom` | 10 | `mazeIds.strangePassage` | BLROO |
| `endgameIds.narrowCorridor` | 5 | `undergroundIds.eastWestPassage` | PASS1 |
| `undergroundIds.torchRoom` | 10 | `endgameIds.topOfStairs` | TSTRS |

Added inline comments to `index.ts` separating the two room groups and documenting their FORTRAN IDs.

### Created Strange Passage Room (BLROO)

The Strange Passage room was referenced in NPC messages and room connections but had never been created as an entity. In FORTRAN, BLROO (Blind Room / Strange Passage) is the intermediate room between Cyclops Room (CYCLO) and Living Room (LROOM).

Changes to `stories/dungeo/src/regions/maze.ts`:
- Added `strangePassage` field to `MazeRoomIds` interface
- Created room entity with FORTRAN-derived description ("You are in a small room with exits to the east and south.")
- Static exit: S → Cyclops Room
- Connected E → Living Room via the existing `connectCyclopsToLivingRoom()` connector
- Cyclops Room N exit now points to Strange Passage (blocked until cyclops flees, same as before)
- Updated `connectCyclopsToLivingRoom()` to route the connection through Strange Passage

Changes to `stories/dungeo/src/npcs/cyclops/cyclops-entity.ts`:
- `makeCyclopsFlee()` now creates the Living Room WEST → Strange Passage exit dynamically (represents the nailed-shut door breaking when cyclops crashes through it)
- Added `RoomTrait` import for the exit traversal

### Updated Three Walkthroughs

Walkthroughs that navigated Cyclops Room → Living Room directly needed an intermediate step through Strange Passage:

- `wt-03-maze-cyclops-goal.transcript`: Added `> north` expecting "Strange Passage", then `> east` to Living Room
- `wt-13-thief-fight.transcript`: Same intermediate step added
- `wt-14-royal-puzzle.transcript`: Same intermediate step added

## Key Decisions

### 1. Only Remove What Has No FORTRAN Equivalent
The audit was explicit: only bonuses with no SCORE-UPD call in FORTRAN source should be removed. The light-shaft bonus (`act2.92:168`) is canonical and was preserved. The four NPC-kill/exorcism bonuses were Dungeo-specific additions without FORTRAN backing.

### 2. Strange Passage as a Static Room
BLROO is not a puzzle room — it's simply an intermediate node. Created it as a minimal room with correct exits rather than adding complexity to the existing Cyclops Room / Living Room connector.

### 3. Living Room WEST Exit Created on Cyclops Flee
The door to Living Room is described as "nailed shut" until the cyclops crashes through it. The WEST exit on the Living Room side is created dynamically in `makeCyclopsFlee()` rather than existing at world init. This matches the FORTRAN behavior where the cyclops "opens" that connection.

## Open Items

### Short Term
- Run `./build.sh -s dungeo` to rebuild the bundle with all changes
- Run `node dist/cli/sharpee.js --test --chain stories/dungeo/walkthroughs/wt-*.transcript` to verify walkthroughs
- Confirm the three updated transcripts (wt-03, wt-13, wt-14) pass with the Strange Passage step

### Long Term
- Score still won't hit 616 exactly — the canvas painting situation creates a +34 bump when thief dies (OFVAL+OTVAL = 5+7 = 12, but the bump logic gives +34). This discrepancy is not yet understood.
- FORTRAN separates endgame scoring (EG-SCORE-MAX) from main game — functional difference only matters if endgame score display is implemented
- Verify final expected max score after bonus removal (~585/650 or ~616 if canvas/thief bump is resolved)

## Files Modified

**Scoring fixes** (4 files):
- `stories/dungeo/src/interceptors/melee-interceptor.ts` — Removed troll-killed (10 pts) and thief-killed (25 pts) scoring calls
- `stories/dungeo/src/npcs/cyclops/cyclops-entity.ts` — Removed cyclops-fled (10 pts) bonus; added Living Room WEST exit creation in `makeCyclopsFlee()`
- `stories/dungeo/src/handlers/exorcism-handler.ts` — Removed exorcism (10 pts) scoring call
- `stories/dungeo/src/index.ts` — Fixed 3 room ID mappings, added separating comments with FORTRAN IDs

**Strange Passage room** (1 file):
- `stories/dungeo/src/regions/maze.ts` — New `strangePassage` room entity, updated `MazeRoomIds` interface, updated `connectCyclopsToLivingRoom()`, updated Cyclops Room N exit

**Walkthroughs** (3 files):
- `stories/dungeo/walkthroughs/wt-03-maze-cyclops-goal.transcript` — Added Strange Passage intermediate step
- `stories/dungeo/walkthroughs/wt-13-thief-fight.transcript` — Added Strange Passage intermediate step
- `stories/dungeo/walkthroughs/wt-14-royal-puzzle.transcript` — Added Strange Passage intermediate step

## Architectural Notes

The FORTRAN scoring audit was straightforward once the source was located. The original SCORE-UPD calls are in `rooms.394` (room visiting and object taking) and `act2.92` (light shaft), with a single death penalty. Any scoring mechanism outside those three patterns is non-canonical.

The Strange Passage room follows the standard Dungeo one-room-per-file pattern but was added inline to `maze.ts` since it is a simple transit room with no objects or puzzles.

## Notes

**Session duration**: ~2 hours

**Approach**: Canonical source audit first, then surgical removal of non-canonical scoring; followed by the missing room discovery and creation.

---

**Progressive update**: Session completed 2026-02-16 21:45 CST
