# Session Summary: 2026-02-17 19:18 - main (stamp-fix)

## Status: Completed

## Goals
- Find the missing 1 point in score calculation (615 vs 616)
- Implement timed brochure delivery mechanism (Don Woods stamp)

## Completed

### Found the Missing Point: Don Woods Stamp is Canonical
- Previous session incorrectly flagged the Don Woods stamp (catalog #31, OTVAL=1) as "Zork I only" because it was checked against the **FORTRAN source** (docs/dungeon-ref/dindx.dat), which is the older 585-point version (v2.6, pre-puzzle room)
- The **MDL source** (docs/internal/dungeon-81/original_source/dung.355:6057) confirms OTVAL=1 for the stamp
- The FORTRAN source predates the MDL port; the MDL version (Jul 1981) is the authoritative 616-point version
- Score math: 615 (previously calculated) + 1 (stamp) = 616 confirmed

### Implemented Timed Brochure Delivery (MDL-Accurate)
Replaced the immediate-delivery send action with a proper timed mechanism matching the MDL source:

1. **SEND FOR BROCHURE** (act3.199:1436-1440) — sets `dungeo.brochure.ordered` flag, responds "Ok, but you know the postal service..."
2. **Kitchen entry trigger** (act1.254:60-61) — a daemon watches for player entering the kitchen; when detected and brochure is ordered, arms a 3-turn delivery fuse (`<CLOCK-INT ,BROIN 3>`)
3. **Delivery** — after 3 turns, "There is a knocking sound from the front of the house." Brochure with stamp placed in mailbox
4. **3-state send validation** (per MDL flag checks):
   - Not ordered → proceed with ordering
   - Ordered, not delivered (BRFLAG1) → "It's probably on the way."
   - Delivered (BRFLAG2) → "Why? Do you need another one?"

### Brochure & Stamp Content (MDL-Authentic)
- Brochure text references Alice in Wonderland's Mock Turtle curriculum ("Reeling and Writhing") and the Frobozz Magic Lamp Company — from dung.355:374-398
- Stamp features authentic ASCII art with "One Lousy Point" and "Donald Woods" — from dung.355:6058-6082
- Stamp: OFVAL=0 (no take points), OTVAL=1 (1 trophy case point)

### Updated Transcript Test
- Rewrote `mail-order-stamp.transcript` to test the full timed delivery flow
- Key discovery: GDT commands don't tick the scheduler — must use actual game movement to trigger the kitchen-entry daemon
- All 35 test assertions pass

## Key Decisions

### 1. MDL Source is Authoritative (Not FORTRAN)
The FORTRAN source (dindx.dat) is version 2.6 with only 585 max points. The MDL source (Jul 1981) is the 616-point version that includes the puzzle room, additional treasures, and the Don Woods stamp. Always use the MDL source (docs/internal/dungeon-81/) as the canonical reference for Dungeo implementation.

### 2. Kitchen-Entry Daemon Pattern
Used a daemon + fuse two-stage pattern (matching MDL exactly):
- **Daemon** (runs every turn): checks if player is in kitchen AND brochure ordered AND not yet armed → arms fuse, deactivates itself
- **Fuse** (3 turns): triggers delivery with knock message, creates brochure + stamp entities, places in mailbox

This follows the existing explosion-fuse pattern (daemon detects condition, arms a fuse for delayed effect).

### 3. Entity Creation in Fuse Triggers
The brochure and stamp entities are created dynamically when the fuse triggers (not at game init). This matches the MDL behavior where these objects don't exist until the delivery occurs. Uses `AuthorModel` to bypass validation when placing the brochure inside the closed mailbox.

## Open Items

### Short Term
- Canvas puzzle implementation (worth 34 points) — remaining gap to 650 max score
- Score now: 616/650 (was 615/650 before this session)

### Long Term
- Complete remaining Dungeo rooms toward 191-room goal

## Files Modified

**New file** (1):
- `stories/dungeo/src/scheduler/brochure-fuse.ts` — Kitchen-watch daemon + 3-turn delivery fuse + brochure/stamp entity creation

**Modified** (7):
- `stories/dungeo/src/actions/send/send-action.ts` — Removed immediate delivery; execute only sets ordered flag; added 3-state validation
- `stories/dungeo/src/actions/send/types.ts` — Replaced `ALREADY_SENT`/`BROCHURE_KNOCK` with `BROCHURE_ON_WAY`/`BROCHURE_ALREADY_RECEIVED`
- `stories/dungeo/src/messages/action-messages.ts` — Updated message text to match MDL dialog
- `stories/dungeo/src/messages/scheduler-messages.ts` — Added `BROCHURE_KNOCK` scheduler message
- `stories/dungeo/src/scheduler/index.ts` — Exported `registerBrochureDelivery`
- `stories/dungeo/src/orchestration/scheduler-setup.ts` — Wired brochure daemon with mailbox entity lookup and kitchen ID
- `docs/work/dungeo/dungeon-catalog.md` — Fixed Don Woods stamp: `--` → `0` for OFVAL column

**Updated test** (1):
- `stories/dungeo/tests/transcripts/mail-order-stamp.transcript` — Full timed delivery test flow (35 assertions)

## Architectural Notes

### Scheduler skipNextTick Behavior
When a daemon arms a fuse during the same tick cycle, the fuse gets `skipNextTick=true`. Since daemons run before fuses in the same tick, the skipNextTick is **cleared** (not decremented) on the creation tick. The fuse then starts decrementing on the next turn. So `turns=3` means the fuse triggers 3 turns after the creation turn — matching MDL's `<CLOCK-INT ,BROIN 3>`.

### GDT Does Not Tick Scheduler
GDT teleportation (debug mode) does not advance game turns or run the scheduler. Tests that need daemon/fuse behavior must use actual game movement commands, not GDT teleports.

## Test Status
- **Walkthrough chain**: 733 tests pass across 15 transcripts (was 727 before — 6 new turns from brochure delivery timing)
- **Unit test**: `mail-order-stamp.transcript` — 35/35 pass

## Additional Work: Walkthrough Integration & Alias Cleanup

### Added Brochure/Stamp to wt-04 Walkthrough
- Inserted mail order puzzle goal into `wt-04-dam-reservoir.transcript` after returning to Living Room
- Flow: read matchbook → send for brochure → walk to Kitchen → wait 3 turns → navigate to West of House → open mailbox → take brochure/stamp → return → put stamp in trophy case
- Natural navigation path: Kitchen → east → Behind House → south → South of House → west → West of House

### Fixed Entity Alias Overlaps (Parser Disambiguation Bug)
Three objects shared overlapping aliases causing false disambiguation prompts:
- **Guidebook** (`dam.ts`): removed `brochure`, `pamphlet` from aliases
- **Leaflet** (`white-house.ts`): removed `pamphlet` from aliases
- **Brochure** (`brochure-fuse.ts`): removed `pamphlet` from aliases

Each object now has distinct aliases — guidebook is "guide book/guide/book", leaflet is "paper/advertisement/ad", brochure is "brochure/MIT brochure/free brochure".

### Updated wt-05 Comment
- Added "brochure" to Living Room floor inventory comment in `wt-05-reservoir.transcript`

## Additional Files Modified
- `stories/dungeo/walkthroughs/wt-04-dam-reservoir.transcript` — Added mail order puzzle goal
- `stories/dungeo/walkthroughs/wt-05-reservoir.transcript` — Updated floor inventory comment
- `stories/dungeo/src/regions/dam.ts` — Removed overlapping guidebook aliases
- `stories/dungeo/src/regions/white-house.ts` — Removed overlapping leaflet aliases
- `stories/dungeo/src/scheduler/brochure-fuse.ts` — Removed overlapping brochure aliases

## Notes
- Session duration: ~1.5 hours
- Previous session's "Don Woods stamp is Zork I only" conclusion was wrong — it was only checked against the older FORTRAN source
- The stamp is a classic Infocom easter egg — worth exactly "One Lousy Point" with ASCII art of Donald Woods (Adventure co-author)
- Parser disambiguation is aggressive — synonym matches across all visible + inventory entities, so aliases must be carefully curated to avoid overlap
