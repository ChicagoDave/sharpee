# Session Summary: 2026-01-26 - main

## Status: Completed

## Goals
- Complete InflatableTrait migration to eliminate `(entity as any).isInflated` pattern
- Document architecture decision on Event Handlers vs Capability Behaviors vs Extensions
- Establish clear mutation patterns for the platform

## Completed

### 1. InflatableTrait Migration (Dungeo Story)

**Problem**: Boat and cloth bag used ad-hoc `(entity as any).isInflated` property pattern.

**Solution**: Created proper `InflatableTrait` with typed interface:
- `isInflated: boolean` - Current inflation state
- `canInflate: boolean` - Whether item can be inflated
- `canDeflate: boolean` - Whether item can be deflated

**Files Created**:
- `stories/dungeo/src/traits/inflatable-trait.ts` - New trait definition
- Updated `stories/dungeo/src/traits/index.ts` - Export new trait

**Files Modified**:
- `stories/dungeo/src/regions/dam.ts` - Migrated boat to use InflatableTrait
- `stories/dungeo/src/regions/volcano.ts` - Migrated cloth bag to use InflatableTrait
- `stories/dungeo/src/actions/inflate/inflate-action.ts` - Updated to check InflatableTrait
- `stories/dungeo/src/actions/deflate/deflate-action.ts` - Updated to check InflatableTrait
- `stories/dungeo/src/handlers/balloon-handler.ts` - Updated to use InflatableTrait for balloon
- `stories/dungeo/src/handlers/boat-puncture-handler.ts` - Updated to use InflatableTrait

**Validation**: All 148 walkthrough tests pass after migration.

### 2. ADR-117: Event Handlers vs Capability Behaviors vs Extensions

**Problem**: Unclear when to use event handlers vs capability behaviors. Many handlers were entity-specific logic that should be behaviors.

**Solution**: Wrote comprehensive ADR establishing three-tier architecture:

#### Core Principles Established

1. **Actions + Behaviors** → Mutate world (entity-specific)
2. **Scheduler (Daemons)** → Mutate world (time-based)
3. **NPC Turn Phase** → Mutate world (NPC decisions)
4. **Extensions** → Read-only observers (maintain own state only)

#### Key Insights

**Capability Behaviors are for**:
- Entity-specific action responses (balloon bursts when attacked, bag tears when overfilled)
- Object-specific state transitions (grating locks after first unlock)
- Item-specific validations (axe blocks taking while troll lives)

**Extensions are for**:
- Cross-cutting concerns that observe game state
- Systems that maintain their own state based on observations
- Read-only reactions (scoring, achievements, hints, analytics)
- Never mutate world directly - emit effects/messages only

**When to use Scheduler**:
- Time-based mutations (fuses, daemon timers)
- Recurring world changes (flood warnings, patrol movements)

#### Extension Interface Draft

```typescript
interface Extension {
  readonly id: string;

  initialize(world: ReadOnlyWorldModel): void;
  onEvent(event: GameEvent, world: ReadOnlyWorldModel): ExtensionEffect[];
  onTurnEnd(world: ReadOnlyWorldModel): ExtensionEffect[];

  getState(): unknown;
  setState(state: unknown): void;
}

interface ExtensionEffect {
  readonly type: 'message' | 'custom';
  readonly data: unknown;
}
```

**Deprecation Caveat**: Won't deprecate event handlers until validated across 5-10 diverse stories.

**Files Created**:
- `docs/architecture/adrs/adr-117-event-handlers-vs-capability-behaviors.md`

### 3. Supporting Documentation

Created comprehensive analysis documents:

**Handler Architecture Options** (`docs/work/platform/handler-options.md`):
- Analyzed 4 architectural options:
  1. Keep current system (status quo)
  2. Handlers become Extension objects (SELECTED)
  3. Merge handlers into scheduler (rejected - wrong abstraction)
  4. Handlers as NPC-like entities (rejected - overcomplicated)
- Established that Extension pattern is cleanest for cross-cutting concerns

**Handler Migration Plan** (`docs/work/dungeo/handler-to-behavior-migration.md`):
- Categorized all 11 Dungeo handlers into:
  - **Entity-Specific** (8) → Should become Capability Behaviors
  - **Cross-Cutting** (3) → Should become Extensions
- Provided migration examples for each category
- Established migration sequence: traits first, then behaviors, then extensions

## Key Decisions

### 1. Trait-First Migration Strategy

**Decision**: Complete all `(entity as any)` → Trait migrations before migrating handlers to behaviors.

**Rationale**:
- Behaviors depend on traits existing
- Cleaner to establish trait contracts first
- Reduces merge conflicts and rework
- Allows validation at each step

**Next Traits to Migrate**:
- `BurnableTrait` (torch, candles)
- `RiverRoomTrait` (stream, river)
- `EditableTrait` (document inscriptions)
- `SacrificeTrait` (chalice, bell, candles → rainbow)

### 2. Extension as Platform Concept

**Decision**: Introduce Extension interface as first-class platform concept alongside Actions, Behaviors, Scheduler, and NPC Turn Phase.

**Rationale**:
- Handlers were never meant for mutations - that's Actions/Behaviors
- Many "handlers" are actually cross-cutting observers (scoring, hints)
- Extensions make this pattern explicit and safe
- Read-only contract prevents architectural violations

**Impact**:
- Need to implement Extension interface in engine
- Scoring, trophy case tracking become Extensions
- Future: hints, achievements, analytics as Extensions
- Event handlers remain as lower-level primitive

### 3. Validation Before Deprecation

**Decision**: Won't deprecate event handlers until Extension pattern validated across 5-10 stories.

**Rationale**:
- Dungeo is first large-scale story - pattern needs broader validation
- Other stories may reveal edge cases or missing capabilities
- Better to have proven model before breaking existing code
- Coexistence during transition period is acceptable

## Open Items

### Short Term

1. **Continue Trait Migration**:
   - BurnableTrait (6 objects: torch, candles, etc.)
   - RiverRoomTrait (stream, river damage handling)
   - EditableTrait (inscribing on objects)
   - SacrificeTrait (altar ceremony mechanics)

2. **Handler to Behavior Migration** (after traits complete):
   - Glacier throwing mechanics → TrebuchetTrait behavior
   - Troll axe blocking → AxeTrait behavior
   - Grating one-time unlock → GratingTrait behavior
   - Boat puncture → BoatTrait behavior
   - Balloon inflation → BalloonTrait behavior
   - Coffin resurrection → CoffinTrait behavior
   - Cage safety → CageTrait behavior
   - Dam door flood → DoorTrait behavior

3. **Extension Implementation** (after behaviors complete):
   - Implement Extension interface in engine
   - Migrate scoring system to Extension
   - Migrate trophy case tracking to Extension
   - Migrate thief behavior to Extension (read-only observer)

### Long Term

1. **Platform Validation**:
   - Implement 5-10 diverse stories using new architecture
   - Validate Extension pattern handles all cross-cutting concerns
   - Document edge cases and limitations discovered
   - Refine Extension interface based on real-world usage

2. **Documentation Updates**:
   - Update CLAUDE.md with Extension guidelines
   - Update core-concepts.md with mutation responsibilities
   - Create Extension best practices guide
   - Document migration patterns for existing stories

3. **Deprecation Plan** (after validation):
   - Create deprecation warnings for direct handler usage
   - Provide automated migration tools
   - Update all example code and tutorials
   - Final removal in major version bump

## Files Modified

**Story Code** (6 files):
- `stories/dungeo/src/traits/inflatable-trait.ts` - New trait definition
- `stories/dungeo/src/traits/index.ts` - Export inflatable trait
- `stories/dungeo/src/regions/dam.ts` - Boat migration
- `stories/dungeo/src/regions/volcano.ts` - Cloth bag migration
- `stories/dungeo/src/actions/inflate/inflate-action.ts` - Use InflatableTrait
- `stories/dungeo/src/actions/deflate/deflate-action.ts` - Use InflatableTrait

**Event Handlers** (2 files):
- `stories/dungeo/src/handlers/balloon-handler.ts` - Use InflatableTrait
- `stories/dungeo/src/handlers/boat-puncture-handler.ts` - Use InflatableTrait

**Architecture Documentation** (3 files):
- `docs/architecture/adrs/adr-117-event-handlers-vs-capability-behaviors.md` - **NEW**
- `docs/work/platform/handler-options.md` - **NEW**
- `docs/work/dungeo/handler-to-behavior-migration.md` - **NEW**

## Architectural Notes

### The Three Mutation Channels

After this session, the platform has clear mutation responsibilities:

```
┌─────────────────────────────────────────────────────┐
│                    WORLD STATE                       │
└─────────────────────────────────────────────────────┘
     ▲              ▲                ▲
     │              │                │
     │              │                │
  Actions +      Scheduler        NPC Turn
  Behaviors      (Daemons)         Phase
     │              │                │
Entity-specific  Time-based      Agent-based
 mutations       mutations        mutations
```

**Extensions sit outside this diagram** - they observe but never mutate.

### Why Traits Before Behaviors

The migration sequence matters:

1. **Traits** establish data contracts
2. **Behaviors** implement logic using those contracts
3. **Extensions** observe events using stable trait interfaces

Jumping to behaviors first would mean refactoring them when traits change.

### Handler Migration Categories

**Entity-Specific → Behaviors**:
- Glacier throwing mechanics
- Troll axe blocking
- Grating unlock behavior
- Boat puncture mechanics
- Balloon inflation
- Coffin resurrection
- Cage protection
- Dam door flooding

**Cross-Cutting → Extensions**:
- Scoring system (observes take/put events)
- Trophy case tracking (observes container events)
- Thief behavior (observes player actions, maintains thief state)

### Extension Pattern Advantages

**Type Safety**:
- `ReadOnlyWorldModel` prevents mutations at compile time
- `ExtensionEffect` is explicit, typed return value
- No accidental world modifications

**Testability**:
- Extensions are pure: `(event, world) → effects`
- Easy to mock ReadOnlyWorldModel
- Effects are value objects (inspectable, comparable)

**Composability**:
- Multiple extensions can observe same event
- No execution order dependencies (read-only!)
- Easy to add/remove extensions

**Performance**:
- Engine can optimize read-only access patterns
- Potential for parallel execution (no mutations)
- Clear performance boundary (mutations vs observations)

## Notes

**Session duration**: ~3 hours

**Approach**: Iterative refinement with validation
1. Completed concrete migration (InflatableTrait) first
2. Used that experience to inform architecture decision
3. Analyzed multiple architectural options before deciding
4. Created comprehensive migration plan for remaining work
5. Established validation criteria before deprecation

**Testing**: All 148 walkthrough tests continue to pass after InflatableTrait migration.

**Architecture Confidence**: High. The three-tier mutation model (Actions/Behaviors, Scheduler, NPCs) + Extensions is clear, testable, and extensible.

---

**Progressive update**: Session completed 2026-01-26 15:29
