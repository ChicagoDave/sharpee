# Session Summary: 2026-02-09 - main (3:00 PM CST)

## Status: Completed

## Goals
- Investigate and fix the Cellar UP exit bug (previously believed to be a serialization/save-restore issue)
- Verify the fix with full walkthrough chain testing
- Update documentation to reflect the root cause discovery

## Completed

### Phase 1: Investigation and Root Cause Discovery

**Parallel Investigation Approach**
- Spawned 3 parallel Explore agents to investigate different hypotheses:
  1. Exit serialization code (trait instances vs POJOs)
  2. Rug push exit creation code (dynamic exit addition)
  3. Checkpoint save/restore mechanisms (JSON pipeline)
- Duration: ~2.5 minutes for parallel exploration

**Checkpoint Data Analysis**
- Examined `checkpoints/after-leaflet.json` and `stories/dungeo/saves/wt-01.json`
- Confirmed Cellar entity had only EAST and SOUTH exits (no UP exit in saved state)
- Living Room had DOWN exit to Cellar, but Cellar lacked reciprocal UP exit
- This confirmed the exit was missing in saves, but revealed it wasn't a serialization bug

**State Machine Discovery**
- Found `stories/dungeo/src/state-machines/trapdoor-machine.ts` deliberately deleting the UP exit
- Lines 43-56 contained a `CustomEffect` that executed `delete roomTrait.exits[Direction.UP]`
- This deletion was triggered when the trapdoor barred (player's first descent via rug push)

**MDL Source Verification**
- Consulted canonical Mainframe Zork source in `docs/dungeon-81/mdlzork_810722/`
- Original Zork keeps the UP exit and gates it through the closed/locked trapdoor
- Going UP in Cellar returns "The door is locked from above." (not "You can't go that way")
- Trapdoor can be reopened from Living Room side for subsequent trips

**Via Gate Mechanism Validation**
- Verified going action's `via` field handling in `packages/stdlib/src/actions/standard/going/going-action.ts`
- Going action checks `exitConfig.via` entity's open state before allowing passage
- When trapdoor is closed (`isOpen: false`), going action emits `door_closed` event
- Lang-en-us renders this as "The trap door is closed." (proper door-gated exit message)

### Phase 2: Fix Implementation

**Root Cause**
The "Cellar UP exit bug" was NOT a serialization bug. The trapdoor state machine intentionally deleted the exit from the Cellar when the trapdoor barred. This caused:
- Generic "You can't go that way" message (should reference the trapdoor)
- Exit data lost from save files (correctly reflecting the deleted state)
- Trapdoor could never be reopened for bidirectional travel (unlike original Zork)

**Fix Applied** (2 files modified):

1. `stories/dungeo/src/state-machines/trapdoor-machine.ts`:
   - Removed `CustomEffect` block (lines 43-56) that deleted `roomTrait.exits[Direction.UP]`
   - Removed unused imports: `CustomEffect`, `RoomTrait`, `Direction`
   - Added explanatory comment: "The UP exit from Cellar is gated by the trapdoor's via field. Closing the trapdoor (above) is sufficient — the going action checks the via entity's open state and blocks passage when closed."
   - Kept the `set_trait` effect that sets `isOpen: false` (the proper gate mechanism)

2. `stories/dungeo/tests/transcripts/rug-trapdoor.transcript`:
   - Line 64: Changed assertion from `[OK: contains "can't go that way"]` to `[OK: contains "closed"]`
   - Updated comment: "Cannot go back up - trap door is closed and barred from above"

### Phase 3: Verification and Testing

**Build Process**
- Ran `./build.sh -s dungeo` (background task, ~40 seconds)
- Clean build with no errors

**Test Results**

1. **Rug-Trapdoor Unit Test**:
   - File: `stories/dungeo/tests/transcripts/rug-trapdoor.transcript`
   - Result: 14/14 tests pass
   - Verified "The trap door is closed." message appears correctly

2. **Full Walkthrough Chain**:
   - Command: `node dist/cli/sharpee.js --test --chain stories/dungeo/walkthroughs/wt-*.transcript`
   - Result: 281 tests, 275 pass, 6 skip
   - Zero regressions from the fix

3. **Save File Verification**:
   ```json
   // stories/dungeo/saves/wt-01.json - Cellar exits
   {
     "EAST": { "destination": "r0g" },
     "SOUTH": { "destination": "r0i" },
     "UP": { "destination": "r06", "via": "y08" }  // Now present with via gate!
   }
   ```
   - Cellar now correctly has UP exit with `via` field pointing to trapdoor entity (y08)
   - Exit persists across save/restore operations

### Phase 4: Documentation Updates

**Memory Notes**
- Removed "Cellar UP exit bug" from serialization issues list
- Added root cause explanation: "Was NOT a serialization bug — trapdoor state machine was deleting the exit instead of letting the closed trapdoor gate it via `via` field"
- Noted the fix approach for future reference

## Key Decisions

### 1. Use Via Gate Instead of Exit Deletion

**Rationale**: Sharpee's going action already has a via gate mechanism that checks if a door/gate entity is open before allowing passage. Deleting the exit entirely loses semantic information (the exit exists but is blocked) and prevents the trapdoor from ever being reopened. Keeping the exit with a via gate preserves the original Zork behavior and provides better player feedback.

### 2. Keep $teleport in wt-10 Walkthrough

**Rationale**: The `$teleport "west of house"` in wt-10 line 226 is still needed, but NOT as a bug workaround. In original Zork, players can't open the trapdoor from the Cellar side (it's locked from above). The trapdoor entity lives in the Living Room, so "open trapdoor" from Cellar gives "I don't see that here." The $teleport is a routing convenience for the walkthrough, not a workaround for this bug.

### 3. Don't Touch trapdoor-handler.ts

**Rationale**: The file `stories/dungeo/src/handlers/trapdoor-handler.ts` imports but never calls `registerTrapdoorHandler()`. Only the state machine is active. Since the fix works correctly with just the state machine change, no need to modify or delete dead code.

## Open Items

### Short Term
- (Resolved) Cellar UP exit save/restore bug — this was item #1 from session-20260209-1345-main.md
- Implement shake message rendering in Mirror Room (RUB MIRROR should show "room shakes" message)
- Verify slide traversal mechanics match canonical Mainframe Zork behavior

### Long Term
- Bat behavior implementation (attack without garlic, random room transport)
- Slide Room mechanics (auto-descent vs manual descent decision)
- Mirror Room shake message visual feedback

## Files Modified

**Story code** (1 file):
- `stories/dungeo/src/state-machines/trapdoor-machine.ts` - removed exit deletion CustomEffect, kept via gate

**Test files** (1 file):
- `stories/dungeo/tests/transcripts/rug-trapdoor.transcript` - updated assertion to expect "closed" message

**Documentation** (1 file):
- `MEMORY.md` - removed serialization bug entry, added root cause note

## Architectural Notes

### Via Gate Pattern for Gated Exits

This fix demonstrates the proper Sharpee pattern for exits gated by doors/trapdoors:

1. **Define the exit** in the room's exits map with `via` field pointing to the gate entity
2. **Let the gate entity control access** via its OpenableTrait state (`isOpen: true/false`)
3. **Going action handles the rest** by checking via entity's open state and emitting appropriate events

**Anti-pattern**: Deleting exits dynamically. This loses semantic information and prevents reopening.

**Example**:
```typescript
// CORRECT - Exit with via gate
exits: {
  [Direction.UP]: {
    destination: livingRoomId,
    via: trapdoorId  // Gate via the trapdoor entity
  }
}

// The trapdoor's OpenableTrait.isOpen controls passage
// When closed: going action emits door_closed → "The trap door is closed."
// When open: going action allows passage normally
```

### State Machine Effects vs Going Action Gates

The trapdoor state machine correctly uses `set_trait` to close the trapdoor (`isOpen: false`). This is sufficient because:

1. The exit definition already has `via: trapdoorId`
2. The going action checks the via entity's open state
3. When closed, going action handles the blocked message
4. When reopened (from Living Room), the same via gate allows passage

No need for CustomEffect to delete exits — the going action's via gate is the proper abstraction.

### Investigation Pattern: Parallel Explore Agents

This session demonstrated effective use of parallel Explore agents for root cause investigation:

1. **Hypothesis Generation**: Identify 3-4 different potential causes
2. **Parallel Exploration**: Spawn agents to investigate each hypothesis simultaneously
3. **Data Verification**: After agents finish, verify findings against actual data (checkpoint JSON)
4. **Source Consultation**: Check canonical source (MDL Zork) to confirm expected behavior
5. **Mechanism Validation**: Verify the fix works with existing platform abstractions (via gate)

This approach found the root cause in ~10 minutes (including parallel exploration + verification).

## Test Results

**Before Fix**:
- Cellar has no UP exit in save files
- Going UP: "You can't go that way"
- Trapdoor permanently blocks passage

**After Fix**:
- Cellar has UP exit with via gate in save files
- Going UP: "The trap door is closed."
- Trapdoor can be reopened from Living Room for subsequent trips

**Regression Testing**:
- rug-trapdoor.transcript: 14/14 pass
- Full 10-walkthrough chain: 281 tests, 275 pass, 6 skip
- Zero regressions

## Notes

**Session duration**: ~22 minutes (2:45 PM - 3:07 PM CST)

**Approach**: Investigation-first strategy with parallel Explore agents. Verified hypotheses against actual checkpoint data before implementing fix. Consulted canonical MDL source to confirm expected behavior. One-line fix (remove exit deletion) + one test assertion update.

**Key Finding**: What appeared to be a complex serialization bug was actually a simple logic error — deleting an exit instead of using the existing via gate mechanism. This demonstrates the value of checking actual data (save files) and consulting canonical sources (MDL Zork) during debugging.

**Progress**: Resolved the #1 open item from the previous session (session-20260209-1345-main.md). Cellar UP exit now persists correctly across save/restore, providing proper door-gated passage semantics.

---

**Progressive update**: Session completed 2026-02-09 3:07 PM CST

## Work Log (auto-captured)
```
[07:24:52] WRITE: docs/context/session-20260209-0600-main.md
[07:36:33] WRITE: docs/architecture/adrs/adr-126-destination-interceptors-and-room-conditions.md
[07:36:42] EDIT: docs/work/platform/room-exit-entrance-conditions.md
[07:51:54] WRITE: docs/architecture/adrs/adr-126-destination-interceptors-and-room-conditions.md
[07:52:17] WRITE: docs/architecture/adrs/adr-127-location-scoped-interceptors.md
[07:56:11] WRITE: docs/context/session-20260209-0730-main.md
[08:03:23] EDIT: packages/stdlib/src/actions/constants.ts
[08:03:37] EDIT: packages/stdlib/src/actions/standard/going/going.ts
[08:03:51] EDIT: packages/stdlib/src/actions/standard/going/going.ts
[08:03:57] EDIT: packages/stdlib/src/actions/standard/going/going.ts
[08:04:04] EDIT: packages/stdlib/src/actions/standard/going/going.ts
[08:04:11] EDIT: packages/stdlib/src/actions/standard/going/going.ts
[08:04:25] EDIT: packages/stdlib/src/actions/standard/going/going.ts
[08:09:38] WRITE: stories/dungeo/src/traits/gas-room-trait.ts
[08:09:51] WRITE: stories/dungeo/src/interceptors/gas-room-entry-interceptor.ts
[08:09:58] EDIT: stories/dungeo/src/traits/index.ts
[08:10:06] EDIT: stories/dungeo/src/regions/coal-mine.ts
[08:10:16] EDIT: stories/dungeo/src/regions/coal-mine.ts
[08:10:33] EDIT: stories/dungeo/src/index.ts
[08:10:41] EDIT: stories/dungeo/src/index.ts
[08:11:17] EDIT: stories/dungeo/src/orchestration/command-transformers.ts
[08:11:21] EDIT: stories/dungeo/src/orchestration/command-transformers.ts
[08:11:27] EDIT: stories/dungeo/src/orchestration/command-transformers.ts
[08:11:36] EDIT: stories/dungeo/src/orchestration/index.ts
[08:11:56] EDIT: stories/dungeo/src/messages/object-messages.ts
[08:21:49] WRITE: stories/dungeo/tests/transcripts/debug-lantern.transcript
[08:22:39] WRITE: stories/dungeo/tests/transcripts/gas-room-safe-lantern.transcript
[12:10:21] EDIT: docs/architecture/adrs/adr-126-destination-interceptors-and-room-conditions.md
[12:11:24] WRITE: docs/context/session-20260209-1210-main.md
[12:16:41] GIT: git commit -m "$(cat <<'EOF'
feat: implement ADR-126 destination interceptors + 
[12:16:48] GIT: git push
[12:30:19] EDIT: docs/work/dungeo/coal-mine-plan.md
[12:41:11] EDIT: stories/dungeo/src/index.ts
[12:41:17] EDIT: stories/dungeo/src/index.ts
[12:47:09] WRITE: stories/dungeo/tests/transcripts/coal-mine-navigation.transcript
[12:52:16] WRITE: stories/dungeo/tests/transcripts/coal-mine-navigation.transcript
[12:54:10] WRITE: stories/dungeo/walkthroughs/wt-10-coal-mine.transcript
[12:55:51] EDIT: stories/dungeo/walkthroughs/wt-10-coal-mine.transcript
[12:57:15] EDIT: stories/dungeo/walkthroughs/wt-10-coal-mine.transcript
[12:58:31] EDIT: stories/dungeo/src/regions/coal-mine.ts
[12:58:36] EDIT: stories/dungeo/src/regions/well-room.ts
[12:58:43] EDIT: stories/dungeo/src/regions/underground.ts
[13:06:28] EDIT: docs/work/dungeo/score-accounting.md
[13:06:45] EDIT: docs/work/dungeo/score-accounting.md
[13:07:01] EDIT: docs/work/dungeo/score-accounting.md
[13:07:08] EDIT: docs/work/dungeo/score-accounting.md
[13:07:15] EDIT: docs/work/dungeo/score-accounting.md
[13:07:25] EDIT: docs/work/dungeo/score-accounting.md
[13:07:40] EDIT: docs/work/dungeo/coal-mine-plan.md
[13:07:51] EDIT: /home/dave/.claude/projects/-mnt-c-repotemp-sharpee/memory/MEMORY.md
[13:08:03] EDIT: /home/dave/.claude/projects/-mnt-c-repotemp-sharpee/memory/MEMORY.md
[13:47:54] WRITE: docs/context/session-20260209-1345-main.md
[13:56:19] TRANSCRIPT FAIL: grep -rn "chain" /mnt/c/repotemp/sharpee/packages/transcript-tester/src/ --inclu
[14:07:59] WRITE: /home/dave/.claude/plans/immutable-growing-taco.md
[15:04:45] EDIT: stories/dungeo/src/state-machines/trapdoor-machine.ts
[15:04:51] EDIT: stories/dungeo/src/state-machines/trapdoor-machine.ts
[15:05:00] EDIT: stories/dungeo/tests/transcripts/rug-trapdoor.transcript
[15:11:07] EDIT: /home/dave/.claude/projects/-mnt-c-repotemp-sharpee/memory/MEMORY.md
[15:32:42] WRITE: docs/context/session-20260209-1500-main.md
[16:34:17] WRITE: /home/dave/.claude/plans/linear-tinkering-flamingo.md
[16:34:48] WRITE: stories/dungeo/walkthroughs/wt-11-scattered-treasures.transcript
[16:40:23] EDIT: stories/dungeo/walkthroughs/wt-11-scattered-treasures.transcript
[16:41:32] EDIT: stories/dungeo/walkthroughs/wt-11-scattered-treasures.transcript
[16:42:26] EDIT: stories/dungeo/walkthroughs/wt-11-scattered-treasures.transcript
[16:42:30] EDIT: stories/dungeo/walkthroughs/wt-11-scattered-treasures.transcript
[16:43:46] WRITE: stories/dungeo/walkthroughs/wt-11-scattered-treasures.transcript
[16:44:45] EDIT: stories/dungeo/walkthroughs/wt-11-scattered-treasures.transcript
[16:46:02] EDIT: stories/dungeo/walkthroughs/wt-11-scattered-treasures.transcript
[16:47:17] EDIT: stories/dungeo/src/regions/house-interior.ts
[16:52:49] EDIT: stories/dungeo/walkthroughs/wt-11-scattered-treasures.transcript
[16:54:06] EDIT: stories/dungeo/walkthroughs/wt-11-scattered-treasures.transcript
[16:55:42] EDIT: stories/dungeo/walkthroughs/wt-11-scattered-treasures.transcript
[16:56:10] WRITE: docs/work/dungeo/score-accounting.md
```
