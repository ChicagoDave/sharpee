# Session Summary: 2026-02-12 - main (11:51 PM CST)

## Status: Partial Fix (Investigation Ongoing)

## Goals
- Fix NPC serialization bug causing thief to stop working after restore
- Clean up housekeeping items (debug transcripts, .gitignore, PR merge)
- Restore wt-12 walkthrough to passing state

## Completed

### 1. Housekeeping
- Deleted 9 debug transcript files (`debug-*.transcript`) from `stories/dungeo/tests/transcripts/` - throwaway debugging files with no regression value
- Added `.tsf-cache/` to `.gitignore`, cherry-picked to both `main` and `combat-refactor` branches
- Created PR #61 for `combat-refactor` â†’ `main` (combat system refactor + ADR-129 score ledger)
- Merged PR #61 and pulled latest main

### 2. NPC Serialization Bug - Root Cause Identified
**Problem**: After `world.loadJSON()` (triggered by `$restore` directives in walkthrough transcripts), NPC turns stop firing. The thief never deposits the egg in wt-12, causing 7 test failures in the egg/canary/bauble/chalice puzzle chain.

**Root Cause**: `NpcTrait.canAct` is a getter (`get canAct(): boolean { return this.isAlive && this.isConscious; }`). Getters and class methods don't survive JSON serialization/deserialization. After `loadJSON()`, traits become plain objects - `npcTrait.canAct` becomes `undefined` (falsy), so `getActiveNpcs()` filters out ALL NPCs.

**Similar issue**: `npcTrait.canEnterRoom(roomId)` is also a class method that doesn't survive deserialization.

**Fix Applied**:
- `packages/stdlib/src/npc/npc-service.ts` - Replaced all 6 occurrences of `npcTrait.canAct` with direct property access: `npcTrait.isAlive && npcTrait.isConscious`
- Replaced `npcTrait.canEnterRoom(dest)` with inlined logic checking `canMove`, `forbiddenRooms`, `allowedRooms` properties directly

**Immediate Result**: Thief NPC now fires turns after restore. Walkthrough chain improved from 334 pass to 337 pass, but 7 failures remain in wt-12.

### 3. Deeper Investigation - Plugin Framework Issue Discovered
Further debugging revealed the fix was necessary but insufficient:

**Debug logging added**:
- `packages/engine/src/game-engine.ts` line ~637: `[ENGINE-PLUGINS]` log showing plugin loop execution
- `packages/stdlib/src/npc/npc-service.ts` line ~173: `[NPC-TICK]` log inside tick() method

**Observation**:
- `[ENGINE-PLUGINS]` logs confirm plugin loop fires successfully (`pluginCount=3`, `result.success=true`)
- `[NPC-TICK]` log never appears, even though `NpcService.tick()` should be called
- This suggests the NPC plugin's `onAfterAction()` is invoked but somehow doesn't reach the service's `tick()` method

**Hypothesis**: Possible module boundary issue in webpack bundle - the plugin may be using a different instance of NpcService than expected, or there's a bundling issue with how the service is resolved.

## Key Decisions

### 1. Platform Rule: Never Use Trait Methods/Getters
This session reinforced the critical serialization constraint: **trait class methods and getters don't survive `loadJSON()`**. All trait interaction must use direct property access.

- The NPC service was the last major consumer of trait methods
- All other platform code already follows this pattern
- This should be documented as a platform-wide architectural rule

### 2. Debug Logging Left In Place (Temporary)
Debug logs remain in:
- `packages/engine/src/game-engine.ts` line ~637
- `packages/stdlib/src/npc/npc-service.ts` line ~173
- `stories/dungeo/src/npcs/thief/thief-behavior.ts` (existing logs)

These should be removed before committing the NPC fix.

## Open Items

### Short Term
- **CRITICAL**: Investigate why `NPC-TICK` log doesn't appear despite `ENGINE-PLUGINS` confirming plugin execution
  - Check if NpcService singleton is being shared correctly between plugin and service
  - Verify webpack bundle module resolution
  - Test with manual logging at plugin/service boundary
- Remove debug logging from engine and npc-service once investigation completes
- Resolve remaining 7 wt-12 failures (egg/canary/bauble/chalice sequence depends on thief deposit)
- Investigate user question: should `depositTreasures()` check `IdentityTrait.points` in addition to `TreasureTrait.trophyCaseValue`?

### Long Term
- Document trait serialization rules in platform documentation
- Consider creating linting rule to prevent trait methods/getters
- Evaluate if trait classes should be replaced with plain interfaces + static behavior methods (like CombatantBehavior pattern)

## Files Modified

**Platform** (2 files):
- `packages/engine/src/game-engine.ts` - Debug logging (temporary)
- `packages/stdlib/src/npc/npc-service.ts` - NPC serialization fix (replaced getter/method calls with property access)

**Project** (1 file):
- `.gitignore` - Added `.tsf-cache/`

**Deleted** (9 files):
- `stories/dungeo/tests/transcripts/debug-egg-deposit.transcript`
- `stories/dungeo/tests/transcripts/debug-thief-deposit.transcript`
- `stories/dungeo/tests/transcripts/debug-thief-egg.transcript`
- `stories/dungeo/tests/transcripts/debug-troll-combat.transcript`
- `stories/dungeo/tests/transcripts/debug-troll-simple.transcript`
- Plus 4 other debug transcript files

## Architectural Notes

### NPC Serialization Pattern
The NPC service fix establishes the correct pattern for all trait interactions:

**WRONG** (doesn't survive serialization):
```typescript
if (npcTrait.canAct) { ... }              // getter - becomes undefined
npcTrait.canEnterRoom(roomId)             // method - becomes undefined
```

**CORRECT** (survives serialization):
```typescript
if (npcTrait.isAlive && npcTrait.isConscious) { ... }  // direct properties
if (npcTrait.canMove && !npcTrait.forbiddenRooms?.includes(dest)) { ... }
```

### Plugin Service Resolution Mystery
The current investigation suggests a potential architectural issue with how plugins access services:
- Plugins are registered with service instances
- After bundling/loading, service method calls may not reach expected instance
- This could be a webpack module boundary issue or singleton pattern problem
- Needs deeper investigation with module resolution tracing

## Notes

**Session duration**: ~2 hours

**Approach**: Started with PR merge and cleanup, pivoted to critical NPC bug after walkthrough failures. Applied serialization fix based on previous trait method lessons (CombatantTrait.kill(), etc.). Fix was correct but revealed deeper plugin framework issue requiring further investigation.

**Test Results**:
- Before: 334 pass, 10 fail, 9 skip
- After NPC fix: 337 pass, 7 fail, 9 skip
- Remaining 7 failures all in wt-12 (egg/canary/bauble/chalice sequence)

**Context State**: Investigation incomplete - debug logging active, deeper plugin issue unresolved.

---

**Progressive update**: Session completed 2026-02-12 11:51 PM CST
