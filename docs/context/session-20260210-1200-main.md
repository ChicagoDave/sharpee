# Session Summary: 2026-02-10 - main (12:00 PM CST)

## Status: Complete (Planning)

## Goals
- Plan the extraction of CombatService from stdlib into a standalone extension package
- Design pluggable combat resolver for both PC→NPC and NPC→PC attack directions
- Ensure Dungeo's melee system is completely independent of CombatService

## Completed

### Combat System Refactor Planning

**Problem Identified:**
CombatService is baked into stdlib in two locations:
1. `attacking.ts` execute phase (lines 278-315) — fallback when no interceptor registered
2. `npc-service.ts` `executeAttack()` (lines 580-656) — ALL NPC counter-attacks, no interceptor support

Dungeo's melee interceptor replaces PC→NPC via ADR-118, but NPC→PC bypasses it entirely and uses CombatService, producing wrong combat results.

**Exploration Completed:**
- Full CombatService dependency graph (combat-service.ts, combat-messages.ts, attacking.ts, npc-service.ts)
- Existing extension package patterns (ext-testing as template)
- Interceptor registry system (world-model, globalThis-based)
- Guard behavior → npc-service → CombatService flow for NPC attacks
- Dungeo melee engine inventory (melee.ts, melee-tables.ts, melee-state.ts, melee-messages.ts)
- Build system (pnpm-workspace.yaml, build.sh PACKAGES array, esbuild aliases)

**Plan Created:** `docs/work/combat/refactor-plan.md` — 7-step plan:
1. Create `packages/extensions/basic-combat/` with CombatService, interceptor, NPC resolver
2. Add pluggable `NpcCombatResolver` to `npc-service.ts`
3. Remove CombatService fallback from `attacking.ts`, inline validation
4. Clean up stdlib combat module (keep only `findWieldedWeapon`)
5. Create Dungeo melee NPC resolver (`melee-npc-attack.ts`)
6. Register melee resolver in Dungeo init
7. Build system integration (workspace, build order, esbuild alias)

**Key Design Decisions:**
- Combat system owns BOTH directions (PC→NPC and NPC→PC), not just one
- `findWieldedWeapon()` stays in stdlib — general utility, not combat-specific
- NPC behaviors unchanged — still return `{ type: 'attack' }`, resolver handles resolution
- basic-combat registers via existing interceptor pattern (ADR-118) + new NpcCombatResolver
- No lang-en-us changes needed — message IDs are string conventions, not imports

## Files Created
- `docs/work/combat/refactor-plan.md` — Full implementation plan
- `docs/context/session-20260210-1200-main.md` — This session summary

## Next Steps
- Create `combat-refactor` branch
- Execute Steps 1-7 of the refactor plan
- Build and verify with walkthrough chain
