# Session Summary: 2026-02-14 03:27 CST - main

## Status: Plan Approved - Implementation Not Started

## Goals
- Diagnose balloon test failures (balloon-full-flight.transcript: 24 passed, 8 failed)
- Understand why balloon disappears from rooms after player exits
- Create refactor plan to fix balloon movement using proper VehicleTrait patterns

## Completed

### 1. Added STOP/No-Retry Rules to Project Instructions
**Context**: User reported Claude kept spawning builds after being asked to stop 10 times in previous session.

**Changes to CLAUDE.md MAJOR DIRECTIONS**:
- "STOP means STOP" - cease immediately when user says stop/wait/hold
- Never auto-retry failed builds/tests without explicit permission
- Never queue a build without asking first

**Changes to MEMORY.md**:
- Added matching CRITICAL section at top with same rules
- Ensures future sessions respect stop commands

### 2. Diagnosed Balloon Test Failures
**Analyzed**: `logs/balloon-test-2.log` (24 passed, 8 failed)

**Root Cause Discovered**: After tying balloon at Narrow Ledge, exiting, going south, and returning — the balloon entity was GONE from the room.

**Why This Happens**:
- Balloon daemon only updates `BalloonStateTrait.position` string field
- Never calls `world.moveEntity(balloonId, newRoomId)`
- Balloon entity stays in original room while trait says it's elsewhere
- Player leaves the balloon's actual location → can't see it anymore

### 3. Deep Investigation of Balloon Architecture

**Current Broken Pattern**:
```typescript
// balloon-daemon.ts — WRONG
const state = balloon.traits.find(t => t.type === 'dungeo.trait.balloon_state');
state.position = positionRooms[nextPosition]; // just updates string
// balloon entity never moves!
```

**Working Pattern (Boat on Frigid River)**:
```typescript
// going action — RIGHT
world.moveEntity(vehicleId, destinationId); // actually moves the entity
```

**Key Findings**:
1. Balloon has `VehicleTrait` but never uses `moveVehicle()` behavior
2. `BalloonStateTrait.position` is completely redundant with `VehicleTrait.currentPosition`
3. Daemon treats balloon like a state machine, not an entity in the world
4. Exit transformer adds balloon to room.contents list — but that's just a rendering hack

### 4. MDL Source Research (Volcano Rooms)

**Verified** all VAIR rooms from `docs/internal/dungeon-81/original_source/dung.355`:

| MDL Room | Description                   | Current Status             |
| -------- | ----------------------------- | -------------------------- |
| VAIR1    | Volcano Core                  | MISSING — needs creation   |
| VAIR2    | Volcano near small ledge      | EXISTS (volcanoNearSmallLedge, unused) |
| VAIR3    | Volcano near viewing ledge    | EXISTS (volcanoNearViewingLedge, unused) |
| VAIR4    | Volcano near wide ledge       | EXISTS (volcanoNearWideLedge, unused) |

**Found Broken Mappings** in `positionRooms`:
- `vair2` wrongly mapped to `narrowLedge.id` (should be `volcanoNearSmallLedge.id`)
- `vair4` wrongly mapped to `wideLedge.id` (should be `volcanoNearWideLedge.id`)
- `ledg3` wrongly mapped to `narrowLedge.id` (should be `volcanoView.id`)
- `vair1` and `vair3` completely missing from mapping

### 5. Created Refactor Plan

**Document**: `docs/work/dungeo/balloon-refactor.md`

**6-Step Plan**:
1. Create Volcano Core room, fix all 8 `positionRooms` mappings
2. Remove `position` field from BalloonStateTrait (redundant)
3. Refactor balloon-daemon.ts to use `moveVehicle()`
4. Update tie-action.ts to use VehicleTrait + moveVehicle for docking
5. Update balloon-handler.ts exit logic to use VehicleTrait
6. Remove thief debug console.log statements

**Status**: Plan approved by user, implementation not started.

## Key Decisions

### 1. Use VehicleTrait Properly for Balloon Movement
**Decision**: Every balloon position is a real room. Daemon calls `moveVehicle()` to physically move balloon entity between rooms.

**Rationale**:
- Matches working boat pattern (Frigid River)
- `VehicleTrait` already exists on balloon — just needs to be used
- `BalloonStateTrait.position` is redundant with `VehicleTrait.currentPosition`
- Fixes root cause: balloon disappearing when player leaves

**Implementation**: Balloon daemon becomes:
```typescript
// Step 3 in refactor plan
const vehicle = balloon.traits.find(t => t.type === 'if.trait.vehicle');
const nextRoomId = positionRooms[nextPosition];
moveVehicle(balloon, world, nextRoomId);
```

### 2. Create Missing Volcano Core Room
**Decision**: Add VAIR1 "Volcano Core" room to complete 8-position balloon flight path.

**Rationale**:
- MDL source has VAIR1
- Current code has `core` position in BalloonPosition enum but no matching room
- Needed for correct balloon flight sequence

## Open Items

### Short Term (Next Session)
- Implement Step 1: Create Volcano Core room, fix positionRooms mappings
- Implement Step 2: Remove BalloonStateTrait.position field
- Implement Step 3: Refactor balloon-daemon.ts to use moveVehicle()
- Implement Step 4: Update tie-action.ts
- Implement Step 5: Update balloon-handler.ts
- Implement Step 6: Remove thief debug console.log statements
- Rebuild and test: `balloon-full-flight.transcript` should go from 24/32 to 32/32

### Long Term
- After balloon tests pass, continue volcano plan (Step 8: glacier melting puzzle)

## Files Modified

**Project Instructions** (2 files):
- `CLAUDE.md` — Added 3 STOP rules to MAJOR DIRECTIONS
- `docs/work/dungeo/balloon-refactor.md` — NEW: 6-step refactor plan (approved)

**Files NOT Modified Yet** (planned for next session, 6 files):
- `stories/dungeo/src/regions/volcano.ts` — Create Volcano Core, fix positionRooms
- `stories/dungeo/src/traits/balloon-state-trait.ts` — Remove position field
- `stories/dungeo/src/scheduler/balloon-daemon.ts` — Use moveVehicle()
- `stories/dungeo/src/actions/tie/tie-action.ts` — Use VehicleTrait for docking
- `stories/dungeo/src/handlers/balloon-handler.ts` — Use VehicleTrait for exits
- `stories/dungeo/src/npcs/thief/thief-behavior.ts` — Remove console.log debug statements

## Architectural Notes

### Why Balloon Was Broken (Deep Dive)
The balloon has been treated as a **state machine with rendering tricks** rather than a **physical entity in the world**.

**Current Architecture** (broken):
1. Daemon updates `BalloonStateTrait.position` string
2. Exit transformer adds balloon to `room.contents` list (rendering hack)
3. Balloon entity never actually moves
4. Player leaves room → can't see balloon anymore (it's still at original location)

**Correct Architecture** (boat pattern):
1. Daemon calls `moveVehicle(balloon, world, newRoomId)`
2. Balloon entity physically moves to new room
3. `VehicleTrait.currentPosition` updated automatically
4. Player sees balloon in whatever room it's actually in (no rendering hacks)

### VehicleTrait vs BalloonStateTrait
- `VehicleTrait.currentPosition` — entity's actual location (authoritative)
- `BalloonStateTrait.position` — redundant string (to be deleted)
- `BalloonStateTrait.inflationState` — still needed (inflated, deflated)
- `BalloonStateTrait.isMoving` — still needed (daemon active/inactive)

### Lesson for Future Vehicle Puzzles
When creating vehicles (rope bridge, raft, etc.):
1. Add `VehicleTrait` to entity
2. Use `moveVehicle()` to change location
3. Never duplicate position tracking in custom traits
4. Trust the world model — entities should be where they actually are

## Notes

**Session duration**: ~1 hour

**Approach**: Diagnostic → Research → Plan

**User Request**: "STOP means STOP" — Claude must not auto-retry builds or ignore stop commands

**Next Session**: Implement 6-step refactor plan, get balloon tests to 32/32 passing

---

**Session completed**: 2026-02-14 03:27 CST
