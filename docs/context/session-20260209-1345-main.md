# Session Summary: 2026-02-09 - main (1:45 PM CST)

## Status: Completed

## Goals
- Complete wt-10 coal mine walkthrough (navigate coal mine, collect 3 treasures, store in trophy case)
- Verify all coal mine navigation routes and puzzle mechanics
- Validate treasure disambiguation (crystal spheres)
- Update score accounting and coal mine plan documentation

## Completed

### Phase 1: Coal Mine Research and Planning

**Coal Mine Plan Update**
- Updated `docs/work/dungeo/coal-mine-plan.md` with all prerequisites marked DONE
- Documented completion status: all 26 rooms built, gas room interceptor working, coal machine operational, basket elevator functional
- Added new open questions discovered during walkthrough creation (slide traversal, bat behavior, mirror room shake message)

**Mechanics Research**
- Slides: No auto-traversal, manual `down` command required at each step (Slide-1, Slide-2, Slide-3)
- Slide Ledge: Can go UP to Slide-2 but loops back, creating one-way descent. Only exit via Cellar
- Bat in Squeaky Room: Attacks players without garlic, carries to random room. Player has no garlic after wt-09, so Squeaky Room must be avoided
- Mirror Room: RUB MIRROR toggles State A ↔ B (known limitation: shake message not rendered)
- wt-09 final inventory: Torch + Lantern only (all other items in trophy case or consumed)

### Phase 2: Navigation Fixes and Verification

**Missing Connection Fix**
- Discovered `connectSlideToCellar()` function existed in coal-mine.ts but was never called
- Added import and function call in `stories/dungeo/src/index.ts` to connect Slide-3 DOWN to Cellar
- This completed the slide descent route (Mirror Room → Slide-1 → Slide-2 → Slide-3 → Cellar)

**Navigation Test Transcript**
- Created `stories/dungeo/tests/transcripts/coal-mine-navigation.transcript` (58 tests)
- Verified all navigation routes through coal mine:
  - Mirror Room → Cold Passage → Slide Room → Mine Entrance (standard entry)
  - Shaft Room → Wooden Tunnel → Smelly Room → Gas Room (bracelet collection with lantern off)
  - Mine maze shortest path to Ladder Top → Coal Mine Dead End (coal collection)
  - Deep mine → Machine Room (diamond via coal machine)
  - Sooty Room → Cellar (exit via slide)

### Phase 3: Crystal Sphere Disambiguation

**Adjective Addition**
- Added `adjectives: ['red']` to red crystal sphere in `stories/dungeo/src/regions/coal-mine.ts`
- Added `adjectives: ['white']` to white crystal sphere in `stories/dungeo/src/regions/well-room.ts`
- Added `adjectives: ['blue']` to blue crystal sphere in `stories/dungeo/src/regions/underground.ts`

**Problem Solved**
Without adjectives, command `put red crystal sphere in trophy case` failed when white sphere was already visible in open trophy case. Platform's `resolveAmbiguity()` now correctly infers modifiers from ref.text/ref.head (matching scoreEntities behavior).

### Phase 4: Walkthrough Creation

**wt-10 Coal Mine Walkthrough**
- Created `stories/dungeo/walkthroughs/wt-10-coal-mine.transcript` (59 tests)
- Restores from wt-09, teleports to Mirror Room, toggles mirror to State B
- Four treasure collection routes:
  1. Bracelet: Drop torch at Smelly Room, enter Gas Room with lantern only (unlit), take bracelet
  2. Coal + Diamond: Navigate mine maze to Dead End, take coal, return to Machine Room, put coal in machine, turn switch, take diamond
  3. Red Sphere: Slide down from Slide Room to Sooty Room (one-way descent), take red sphere, exit via Cellar
  4. Trunk: Already taken in wt-04, now placed in trophy case
- Store diamond, bracelet, red sphere, trunk in trophy case
- Workaround for Cellar bug: $teleport to West of House instead of using UP exit

### Phase 5: Score Accounting Update

**Score Update**
- Updated `docs/work/dungeo/score-accounting.md` from 281 to 328/616 (+47 points)
- Diamond: take 10 + case 6 = 16 points
- Bracelet: take 5 + case 3 = 8 points
- Red sphere: take 10 + case 5 = 15 points
- Trunk: case 8 (already taken in wt-04, now cased)
- Progress: 17 treasures collected (16 cased), 16 remaining

## Key Decisions

### 1. Avoid Squeaky Room Route

**Rationale**: Player has no garlic after wt-09 (consumed in well room). Bat in Squeaky Room attacks and carries player to random location, disrupting walkthrough flow. Route goes NE from Mine Entrance to Shaft Room instead.

### 2. Sooty Room Collection Last

**Rationale**: Slide is one-way down, exit only via Cellar. Do all other coal mine work (bracelet, coal, diamond) first, then slide down for red sphere as final collection before leaving mine.

### 3. $teleport from Cellar

**Rationale**: Cellar UP exit to Living Room (set dynamically when rug is pushed in wt-01) doesn't survive save/restore in chain mode. Workaround with `$teleport "west of house"` until bug is resolved.

### 4. Full Crystal Sphere Names

**Rationale**: Use `put red crystal sphere in trophy case` (with adjective fix) to disambiguate from white sphere already in case. Without adjectives, platform couldn't distinguish "red crystal sphere" from "white crystal sphere" when both were visible.

## Open Items

### Short Term
- Fix Cellar UP exit save/restore bug (dynamically-added exits don't persist in chain mode)
- Implement shake message rendering in Mirror Room (RUB MIRROR should show "room shakes" message)
- Verify slide traversal mechanics match canonical Mainframe Zork behavior

### Long Term
- Bat behavior implementation (attack without garlic, random room transport)
- Slide Room mechanics (auto-descent vs manual descent decision)
- Mirror Room shake message visual feedback

## Files Modified

**Story code** (4 files):
- `stories/dungeo/src/index.ts` - import + connectSlideToCellar() call
- `stories/dungeo/src/regions/coal-mine.ts` - red sphere adjective
- `stories/dungeo/src/regions/well-room.ts` - white sphere adjective
- `stories/dungeo/src/regions/underground.ts` - blue sphere adjective

**New test files** (2 files):
- `stories/dungeo/walkthroughs/wt-10-coal-mine.transcript` - walkthrough (59 tests)
- `stories/dungeo/tests/transcripts/coal-mine-navigation.transcript` - navigation verification (58 tests)

**Documentation** (2 files):
- `docs/work/dungeo/coal-mine-plan.md` - updated all steps to DONE, added open questions
- `docs/work/dungeo/score-accounting.md` - updated to 328/616 points

## Architectural Notes

### Crystal Sphere Disambiguation Pattern

The crystal sphere issue demonstrated the importance of adjectives on IdentityTrait for entities sharing head nouns. Platform's command resolver now correctly:
1. Uses head noun ("sphere") to find candidates (all 3 spheres)
2. Uses modifiers ("red") to score candidates via adjectives
3. Selects highest-scoring match

This pattern applies to all multi-word entities sharing head nouns (cakes, spheres, keys, etc.).

### Slide Descent as One-Way Navigation

The slide mechanic creates an interesting one-way navigation pattern:
- Entry: Mirror Room → Slide Room (down) → Slide-1 → Slide-2 → Slide-3 → Cellar
- Exit: Cellar (up) → Living Room OR $teleport elsewhere
- Slide Ledge loops back to Slide-2, preventing upward traversal

This forced the "collect Sooty Room items last" strategy in walkthroughs.

### Gas Room Entry Pattern

The gas room destination interceptor (ADR-126) cleanly handles the "drop torch, enter with unlit lantern" puzzle:
- Interceptor checks for lit flame sources on actor
- If lit, blocks entry with explosion message
- If unlit (or no flame source), allows entry
- This validates the destination interceptor pattern for entry conditions

## Test Results

**10-Walkthrough Chain**:
- 281 tests, 275 pass, 6 skip
- Duration: ~940ms
- Zero regressions from coal mine changes

**Coal Mine Unit Tests**:
- Navigation transcript: 58 tests, 58 pass
- Gas room transcripts: 10 tests, 8 pass, 2 skip
- Total: 112 tests, 110 pass, 2 skip

**Pre-existing Failures**:
- 28 unit test failures remain (unrelated to coal mine)
- All failures documented in previous sessions
- Cellar UP exit bug discovered (save/restore issue in chain mode)

## Bugs Discovered

### 1. Cellar UP Exit Save/Restore Bug

**Description**: The UP exit from Cellar → Living Room (set dynamically when rug is pushed in wt-01) doesn't survive save/restore in chain mode.

**Impact**: wt-10 cannot use natural exit from Cellar, must use $teleport workaround.

**Root Cause**: Dynamically-added exits may not be serialized/deserialized correctly.

### 2. Missing connectSlideToCellar Call

**Description**: Function existed but was never wired in index.ts.

**Impact**: Slide-3 had no DOWN exit to Cellar, breaking slide descent route.

**Resolution**: Added import and function call, now working correctly.

## Notes

**Session duration**: ~1 hour (12:45 PM - 1:45 PM CST)

**Approach**: Research-first strategy. Spent first 15 minutes researching coal mine mechanics (slides, bat, mirror) before writing walkthrough. Created navigation test first to verify all routes, then built walkthrough using verified paths.

**Verification**: Full 10-walkthrough chain passes with 275/281 tests (6 expected skips). Coal mine is fully navigable, all treasures collectible, scoring system working correctly. Ready for next region (wt-11).

**Progress**: 16 treasures in trophy case, 328/616 points (53% of total). Approximately halfway through Mainframe Zork implementation.

---

**Progressive update**: Session completed 2026-02-09 1:45 PM CST
