# Session Summary: 2026-02-16 05:30 CST - main

## Status: Research Complete

## Goals
- Investigate all 11 test failures in wt-13-volcano-balloon.transcript
- Identify root causes for each failure category
- Document findings for follow-up fixes

## Completed

### Full Root Cause Analysis of WT-13 Failures (74 pass, 11 fail)

Three distinct root causes identified, affecting 11 tests total.

---

### Root Cause 1: Explosion Fuse Timing Off-by-One (3 failures)

**Affected tests**: Lines 54 (wait → "explosion"), 60 (take crown), 81 (exit → "Volcano Bottom")

**Root cause**: The scheduler ticks fuses on the SAME TURN they're set, effectively making the countdown `turns - 1` instead of `turns`.

**Trace**:
```
burn wire     → fuse set with turns=2, scheduler ticks → 2→1
north         → scheduler ticks → 1→0 → TRIGGERS HERE (one turn early!)
wait          → fuse already triggered, output: "Time passes..."
```

The transcript expects the explosion on `wait` (2 turns after `burn wire`), but it fires on `north` (1 turn after). This is because:

1. `burn wire` execute phase calls `startExplosionCountdown()` → `scheduler.setFuse()` with `turnsRemaining: 2`
2. On the SAME turn, the scheduler plugin's `onAfterAction()` ticks all fuses, including the newly-set one: `2 → 1`
3. Next turn (`north`): tick `1 → 0` → trigger

The `brick-explosion.transcript` unit test has the same bug — it expects explosion 2 waits after `burn wire`, but it actually fires on the 1st wait.

**Evidence**: `logs/test-13.log` line 56 shows `north` PASSES (explosion output goes here), while `wait` FAILS because it only gets "Time passes...".

**Fix options**:
1. **Don't tick newly-set fuses on same turn** (cleanest): Add a `setTurn` field to `FuseState`, skip tick if `ctx.turn === fuse.setTurn`
2. **Adjust EXPLOSION_TURNS to 3**: Hacky, changes MDL semantics
3. **Have setFuse set turnsRemaining to turns + 1**: Also hacky

**Recommendation**: Option 1 — add same-turn skip to `scheduler-service.ts`. This affects all fuses, so verify other fuses (candle, incense, balloon) still work correctly.

**Files involved**:
- `packages/plugin-scheduler/src/scheduler-service.ts` — `setFuse()` and `tick()` methods
- `stories/dungeo/src/scheduler/explosion-fuse.ts` — `EXPLOSION_TURNS = 2`
- `stories/dungeo/src/actions/burn/burn-action.ts` — calls `startExplosionCountdown()`

---

### Root Cause 2: Runner $restore Doesn't Preserve Plugin State (7 failures)

**Affected tests**: Lines 95 (up → "Living Room"), 100-128 (trophy case operations), 131 (look → "Living Room")

**Root cause**: The transcript runner's `$restore` command only saves/restores `world.toJSON()` and `world.loadJSON()`, not plugin state (state machines, scheduler). After $restore, all plugins reset to their initial state.

**Mechanism** (trapdoor):
1. In the chain run: wt-01's state machine fires on first descent → trapdoor closed, state='barred' (terminal). In subsequent walkthroughs, state machine stays in 'barred', player can freely open/close trapdoor.
2. wt-12 opens trapdoor (`open trap door`), goes down, but state machine is already in 'barred' → doesn't re-fire → trapdoor stays open.
3. `$save wt-12` captures: trapdoor `isOpen: true`, world state `dungeo.trapdoor.barred: true`
4. wt-13 individual run: `$restore wt-12` loads world (trapdoor isOpen=true) but state machine resets to 'open'
5. Player goes DOWN: via check passes (isOpen=true), state machine fires again → sets isOpen=false
6. Later, player tries UP from Cellar → via check: trapdoor isOpen=false → **"The trap door is closed."**

**Evidence**:
- `wt-12.json` save: trapdoor entity `y08` has `"isOpen": true`, world state `dungeo.trapdoor.barred: true`
- Test log line 95-98: `go up` returns "The trap door is closed."
- `runner.ts` line 756: `(world as any).loadJSON(worldState)` — only world, no plugins
- `state-machine-plugin.ts` has `getState()`/`setState()` but runner doesn't call them
- Engine's `save-restore-service.ts` DOES handle plugin states (lines 150, 202) but runner bypasses it

**Fix options**:
1. **Fix runner to save/restore plugin state** (proper fix): Include plugin states in save file. The engine's `save-restore-service.ts` already has the pattern. The runner should call `pluginRegistry.getStates()` on save and `pluginRegistry.setStates()` on restore.
2. **Add guard to trapdoor state machine**: Check `dungeo.trapdoor.barred` world state value before allowing the 'open' → 'barred' transition. This is a band-aid.
3. **Fix wt-13 transcript**: Add `open trap door` before `go down`, and `open trap door` before `go up`. Doesn't fix the fundamental issue.

**Recommendation**: Option 1 — fix the runner. This is a systemic issue that will affect any plugin with state (state machines, scheduler fuses, NPC behavior). The engine already has the proper save/restore pattern.

**Files involved**:
- `packages/transcript-tester/src/runner.ts` — `$save` and `$restore` handlers (lines 700-769)
- `packages/plugin-state-machine/src/state-machine-plugin.ts` — `getState()`/`setState()`
- `packages/plugin-scheduler/src/scheduler-plugin.ts` — `getState()`/`setState()`
- `packages/engine/src/save-restore-service.ts` — Reference implementation for proper plugin state save/restore

---

### Root Cause 3: Balloon Exit Missing Room Name (1 failure)

**Affected test**: Line 81 (exit → "Volcano Bottom")

**Symptom**: After balloon descent (12 waits), `exit` from balloon outputs "You get out of balloon." without mentioning "Volcano Bottom".

**Status**: Not fully investigated. The balloon appears to be at the correct location (subsequent navigation `north → Lava Room → west → Ruby Room` matches Volcano Bottom's exits). The issue is likely that the exit action doesn't include the room description in its output, or the balloon's location entity name doesn't match.

**Note**: This may also be a cascade from Issue 1 (explosion timing) affecting the balloon descent sequence, though the descent commands all pass.

---

## Architecture Analysis

### Why the Runner Bypasses Plugin State

The transcript runner was designed before the plugin system (ADR-120) existed. It directly accesses `world.toJSON()`/`world.loadJSON()` as the simplest serialization mechanism. The engine's `SaveRestoreService` handles the full save envelope (world + plugins + metadata) but isn't accessible from the runner's context.

**The runner needs access to**:
- `PluginRegistry.getStates(): Record<string, unknown>` — for saving
- `PluginRegistry.setStates(states: Record<string, unknown>): void` — for restoring

The `TestableGame` interface (runner.ts:28-36) should be extended to include plugin state access.

### Scheduler Timing Model

The current model: fuses tick on the same turn they're set. This effectively means a fuse with `turns: N` fires after `N-1` player actions.

The MDL model: fuses set during an action don't tick until the NEXT turn. A fuse with `turns: N` fires after `N` player actions.

The engine's turn cycle (game-engine.ts:634-660):
```
1. Player action (validate/execute/report)
2. Plugin ticks (NPC → state machines → scheduler)
```

Fuses are registered during step 1. The scheduler ticks during step 2 of the SAME turn. To match MDL semantics, newly-set fuses should skip their first tick.

## Key Evidence

### Save File Analysis (wt-12.json)
- Trapdoor entity `y08`: `isOpen: true` (opened in wt-12, state machine didn't re-fire)
- World state `dungeo.trapdoor.barred`: `true` (set in wt-01, persists in world model)
- Living Room DOWN exit: `{ destination: "r0h", via: "y08" }`
- Cellar UP exit: `{ destination: "r06", via: "y08" }`

### Test Log Patterns
- `burn wire` PASSES → burn action works, message shown
- `north` PASSES → explosion fires HERE (output includes explosion + "Wide Ledge")
- `wait` FAILS → fuse already triggered, only "Time passes..."
- `down` PASSES → trapdoor was open in save
- `up` FAILS → state machine re-fired, closed trapdoor
- Trophy case operations all FAIL → player stuck in Cellar (cascade)

## Recommended Fix Priority

1. **Runner plugin state** (fixes 7 of 11 failures): Fix `$save`/`$restore` in runner.ts to include plugin state. This is a platform change (packages/) — requires discussion.
2. **Scheduler fuse timing** (fixes 3 of 11 failures): Add same-turn skip to scheduler-service.ts. This is also a platform change.
3. **Balloon exit message** (fixes 1 failure): Investigate whether exit action should include room description, or fix balloon location. Story-level fix.

## Files Referenced

**Platform**:
- `packages/transcript-tester/src/runner.ts` — $save/$restore handlers
- `packages/plugin-scheduler/src/scheduler-service.ts` — setFuse() and tick()
- `packages/plugin-scheduler/src/scheduler-plugin.ts` — getState()/setState()
- `packages/plugin-state-machine/src/state-machine-plugin.ts` — getState()/setState()
- `packages/engine/src/save-restore-service.ts` — Reference for proper plugin state handling
- `packages/engine/src/game-engine.ts` — Turn cycle (lines 634-660)

**Story**:
- `stories/dungeo/src/state-machines/trapdoor-machine.ts` — Trapdoor state machine definition
- `stories/dungeo/src/scheduler/explosion-fuse.ts` — Explosion fuse system
- `stories/dungeo/src/actions/burn/burn-action.ts` — Burn action (silent failure if refs null)
- `stories/dungeo/src/orchestration/scheduler-setup.ts` — Wiring of explosion config
- `stories/dungeo/walkthroughs/wt-13-volcano-balloon.transcript` — Failing walkthrough
- `stories/dungeo/tests/transcripts/brick-explosion.transcript` — Unit test (also affected by timing bug)
- `stories/dungeo/saves/wt-12.json` — Save file analyzed

---

**Session duration**: ~1 hour (research only, no code changes)
**Progressive update**: Completed 2026-02-16 05:30 CST
