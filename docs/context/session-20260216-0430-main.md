# Session Summary: 2026-02-16 - main (CST)

## Status: Completed

## Goals
- Debug the balloon tie-wire-to-hook puzzle (hook entities not resolving in commands)
- Restore debug tooling (TRACE/DEBUG commands) that were lost in bundle migration
- Add programmatic command execution capability for automated debugging

## Completed

### 1. Critical Bug Fix: entity.name Getter Priority

**Problem**: The `tie braided wire to hook` command was failing to resolve the hook entity, even though the hook was visible in the room listing. This bug had blocked the balloon puzzle for 6+ hours across multiple sessions.

**Root Cause**: The `entity.name` getter in `packages/world-model/src/entities/if-entity.ts` was checking `attributes.displayName` BEFORE `IdentityTrait.name`:

```typescript
// WRONG - was checking displayName first
get name(): string {
  return this.attributes.displayName || this.getIdentityTrait()?.name || this.id;
}
```

When entities are created with `world.createEntity('hook1', 'object', { name: 'hook' })`, the creation ID ('hook1') was being set as `displayName`, which shadowed the actual IdentityTrait name ('hook'). The command validator's entity search uses `entity.name`, so it was searching for 'hook1' instead of 'hook'.

**Fix**: Reversed the priority to check IdentityTrait.name first:

```typescript
// CORRECT - check IdentityTrait.name first
get name(): string {
  return this.getIdentityTrait()?.name || this.attributes.displayName || this.id;
}
```

**Impact**: This was NOT a serialization bug (happened even without save/restore). It affected any entity where the creation ID differed from the player-facing name. The balloon hook entities (`hook1`/`hook2`) both have IdentityTrait name "hook" but distinct creation IDs for technical tracking.

**Verification**: After fix, `tie braided wire to hook` successfully resolves both entities, anchors the balloon, and causes it to land at Narrow Ledge.

### 2. Restored REPL Debug Commands

**Context**: The migration from transcript-tester CLI to bundle-entry.js had lost all the TRACE/DEBUG commands that were essential for debugging command parsing and validation.

**Added to both `scripts/bundle-entry.js` and `packages/transcript-tester/src/fast-cli.ts`:**

- `/debug` - Toggle showing [Parsed], [Validated], and [Events] JSON after every command
- `/trace` - Toggle PARSER_DEBUG environment variable (shows grammar matching output)
- `/events` - One-time dump of events from last command with full data
- `/parsed` - One-time dump of parsedCommand from last turn
- `/validated` - One-time dump of validatedCommand from last turn

**Implementation Details:**
- Added `lastTurnResult` capture in `executeCommand()` to preserve TurnResult data
- Bundle's executeCommand was discarding the TurnResult, so one-shot dumps had no data
- Debug state persists across commands (sticky toggle for /debug and /trace)

**Key Lesson**: Always restore debug tooling FIRST before chasing bugs. The entity.name bug took 6 hours to find without JSON dumps but 5 minutes once TRACE/DEBUG were restored.

### 3. Added Non-Interactive `--exec` Mode

**Motivation**: Enable programmatic command execution for automated debugging and testing.

**Syntax**:
```bash
node dist/cli/sharpee.js --play --exec "look/inventory/north"
node dist/cli/sharpee.js --play --exec "look/take all" --debug
node dist/cli/sharpee.js --play --restore mysave --exec "inventory/score"
```

**Features**:
- Commands separated by `/` delimiter
- `--debug` flag shows parsed/validated/events JSON for each command
- Can combine with `--restore <name>` to start from a save file
- Exits after running all commands (non-interactive)

**Implementation**: Added to `scripts/bundle-entry.js` only (not fast-cli.ts, which is transcript-focused).

**Status**: Working but needs further testing with complex command chains.

### 4. Confirmed Balloon Tie Puzzle Works End-to-End

With the entity.name fix in place:

1. `tie braided wire to hook` successfully resolves wire and hook
2. Balloon state transitions to 'anchored'
3. Basket landing daemon fires after 1 turn
4. Balloon lands at Narrow Ledge (volcanoNarrowLedge)
5. Hook and zorkmid coin appear in the basket (confirmed by minimumScope)
6. Player can `take zorkmid` from the basket

**Remaining Work**: The balloon still needs:
- UNTIE command (disconnect from hook, balloon floats away)
- DEFLATE command (permanent deflation, basket becomes portable)
- Walkthrough transcript (wt-13a) to capture the full puzzle flow

## Key Decisions

### 1. entity.name Getter Priority

**Decision**: IdentityTrait.name takes precedence over attributes.displayName.

**Rationale**:
- `attributes.displayName` is a technical detail (often set from creation ID)
- `IdentityTrait.name` is the player-facing name that should be used for all interactions
- This matches how IdentityTrait.aliases works (player-facing vocabulary)
- The creation ID should only be used as a last resort if no other name is available

**Alternative Considered**: Keep displayName first, but fix all entity creation code to not set displayName when it differs from IdentityTrait.name. Rejected because it would require auditing hundreds of entity creations and would be fragile.

### 2. Dual Implementation of Debug Commands

**Decision**: Implemented debug commands in BOTH bundle-entry.js and fast-cli.ts.

**Rationale**:
- Bundle is used for interactive play (`node dist/cli/sharpee.js --play`)
- fast-cli is used for transcript testing (spawned by bundle when --test flag is used)
- Both contexts need debug tooling for different use cases
- Code duplication is acceptable here (small, stable surface area)

### 3. `/` as Command Delimiter for --exec

**Decision**: Use `/` instead of `;` or `|` to separate commands in --exec mode.

**Rationale**:
- Avoids shell quoting issues (`;` requires careful escaping)
- More visually distinct than comma or space
- Rare in actual IF commands (only appears in "PUT X IN/ON Y" which uses prepositions, not slash)
- Clear separation for multi-word commands: "look/go north/take all"

## Challenges Encountered

### Challenge 1: 6-Hour Bug Hunt Without Debug Tooling

**Problem**: Spent multiple sessions debugging why "hook" wasn't resolving in commands, exploring wrong paths:
- Serialization bugs (entity state corruption)
- minimumScope visibility issues (wrong hook being searched)
- Command validator scope resolution (correct, but couldn't see the data flow)

**Resolution**: Once `/debug` and `/parsed` commands were restored, the bug was visible immediately in the JSON output - `entity.name` was returning 'hook1' instead of 'hook'.

**Lesson**: Debug tooling is not optional. Restore it FIRST before investigating bugs, especially in complex systems like command resolution.

### Challenge 2: lastTurnResult Capture in Bundle

**Problem**: The bundle's executeCommand function was discarding the TurnResult, so one-shot debug commands (`/events`, `/parsed`) had no data to display.

**Resolution**: Modified executeCommand to capture and store TurnResult in `self.lastTurnResult`, allowing debug commands to access turn history.

**Note**: This pattern already existed in fast-cli.ts, so it was a matter of porting it to bundle-entry.js.

## Open Items

### Short Term
- Test `--exec` mode with complex command chains and error cases
- Add `UNTIE WIRE FROM HOOK` command (release balloon)
- Add `DEFLATE BALLOON` command (permanent deflation)
- Write wt-13a walkthrough transcript for full balloon puzzle

### Long Term
- Consider adding `--exec-file` flag to run commands from a file (alternative to transcripts)
- Add `/context` command to show full ActionContext dump (current state snapshot)
- Document debug command usage in `docs/reference/debugging.md`

## Files Modified

**Platform** (3 files):
- `scripts/bundle-entry.js` - Added REPL debug commands, --exec mode, lastTurnResult capture
- `packages/transcript-tester/src/fast-cli.ts` - Added REPL debug commands, lastTurnResult capture
- `packages/world-model/src/entities/if-entity.ts` - Fixed entity.name getter priority (IdentityTrait.name first)

## Architectural Notes

### Entity Naming Convention

The codebase uses three distinct name fields:

1. **Creation ID** (`entity.id`): Technical identifier, must be unique globally (e.g., 'hook1', 'hook2')
2. **IdentityTrait.name**: Player-facing name, shared by similar entities (e.g., 'hook')
3. **attributes.displayName**: Optional override, rarely used (legacy field)

The `entity.name` getter now returns them in priority order: IdentityTrait.name > displayName > id.

**Pattern**: When creating entities that share a name but need distinct IDs:

```typescript
// CORRECT - creation ID is technical, IdentityTrait.name is player-facing
const hook1 = world.createEntity('hook1', 'object', { name: 'hook' });
const hook2 = world.createEntity('hook2', 'object', { name: 'hook' });

// Both hooks have entity.name === 'hook' for player interactions
// But entity.id is unique for technical tracking
```

### Debug Command Architecture

The debug commands maintain state across REPL iterations:

```typescript
let debugMode = false;  // Sticky toggle for /debug
let lastTurnResult = null;  // Captured from executeCommand

// In REPL loop
if (input.startsWith('/')) {
  if (input === '/debug') {
    debugMode = !debugMode;
    continue;  // Don't execute as game command
  }
  if (input === '/events') {
    // One-shot dump from lastTurnResult
    console.log(JSON.stringify(lastTurnResult?.events, null, 2));
    continue;
  }
}

// After normal command execution
const result = await executeCommand(input, game);
lastTurnResult = result;  // Capture for one-shot dumps

if (debugMode) {
  // Show JSON automatically
  console.log('[Parsed]', JSON.stringify(result.parsed, null, 2));
}
```

This pattern allows both persistent debugging (toggle on/off) and one-shot inspection (specific dump on demand).

## Notes

**Session duration**: ~3 hours

**Approach**:
1. Started by implementing --exec mode for programmatic debugging
2. Realized debug tooling was missing from bundle-entry.js
3. Ported all debug commands from fast-cli.ts (TRACE, DEBUG, one-shot dumps)
4. Used `/debug` command to inspect "tie wire to hook" failure
5. Spotted entity.name returning 'hook1' instead of 'hook' in [Parsed] output
6. Fixed entity.name getter priority in if-entity.ts
7. Verified balloon tie puzzle works end-to-end

**Key Insight**: The bug was a single line in the wrong order, but finding it required the right tooling. Debug commands are not "nice to have" - they're essential infrastructure for complex command resolution systems.

---

**Progressive update**: Session completed 2026-02-16 04:30 CST
