# Session Summary: 2026-01-30 - main

## Status: In Progress

## Goals
- Create interactive design patterns visualization for Sharpee website
- Fix and expand npm build/publish pipeline for public package distribution
- Update website documentation to reflect current architecture and workflows
- Resolve build system conflicts between Zifmia and npm packages

## Completed

### 1. DSLM Design Patterns Interactive Visualization

Created a D3.js force-directed graph page showing all 124 Interactive Fiction design patterns from the sharpee-dslm repository.

**Pattern Extraction Pipeline:**
- Built `website/scripts/extract-patterns.mjs` to read pattern markdown files
- Parses YAML frontmatter for metadata (category, title, relationships)
- Extracts "Related Patterns" section to build graph edges
- Generates `website/src/data/patterns.json` with 124 nodes and 223 relationship edges

**Interactive Features:**
- Color-coded by category (Core Mechanics, World Building, Narrative, etc.)
- Force-directed layout with collision detection
- Hover highlighting shows related patterns
- Click to expand detail panel with description and relationships
- Search filter by pattern name
- Category filter to focus on specific domains
- Responsive design with legend

**Integration:**
- Added to website at `/design-patterns/`
- Integrated into sidebar navigation (`website/astro.config.mjs`)
- Provides visual entry point to pattern catalog

### 2. npm Build & Publish Pipeline Overhaul

Fixed and expanded the npm package publishing system to avoid conflicts with Zifmia's build infrastructure.

**Build System Separation (Option C: Permanent dist-npm):**
- All packages now use `build:npm` script instead of default `build`
- Output directory changed from `dist/` to `dist-npm/` to isolate npm builds
- Updated all 19 package.json files with new paths:
  - `main`: `dist-npm/index.js`
  - `types`: `dist-npm/index.d.ts`
  - `module`: `dist-npm/index.mjs`
  - `exports`: Points to `dist-npm/` subdirectories
  - `files`: Includes `dist-npm/` instead of `dist/`

**Package Count Expansion:**
- Fixed typo: `world=model` → `world-model`
- Expanded from 12 to 19 packages published to npm:
  - Core: engine, world-model, stdlib
  - Language: lang-en-us, parser-en-us
  - Plugins: plugin-npc, plugin-scheduler, plugin-state-machine, plugins
  - Platform: platform-browser, platform-node
  - Extensions: extension-testing, extensions
  - Utils: utils-common, utils-entity-factory
  - Client: client-browser
  - Meta: template, sharpee (umbrella package)

**Publishing Workflow:**
- `scripts/publish-npm.sh` now uses `pnpm -r build:npm` instead of `./build.sh`
- Changed publish tag from `--tag beta` to `--tag latest`
- Version set to `0.9.61-beta`
- Created `scripts/npm-latest.sh` for tagging existing versions as latest

**Rationale:** Documented in `docs/work/npm/build-options.md` - analyzed 4 approaches (clean script, dual build, dist-npm permanent, package filter). Selected Option C for reliability and CI/CD simplicity.

### 3. @sharpee/sharpee Package Updates

Enhanced the umbrella package to properly re-export plugin system.

**Dependencies Added:**
- `@sharpee/plugin-npc`
- `@sharpee/plugin-scheduler`
- `@sharpee/plugin-state-machine`
- `@sharpee/plugins`
- `@sharpee/platform-browser`

**TypeScript Configuration:**
- Added tsconfig.json project references for:
  - `plugins` package
  - `extensions/testing` package
- Ensures proper type checking and incremental builds

**Re-exports:**
- Added plugin system to `index.ts`:
  - `TurnPlugin` interface
  - `PluginRegistry` class
  - `NpcPlugin`, `SchedulerPlugin`, `StateMachinePlugin` implementations

**CLI Improvements:**
- Fixed version display: Now reads from `package.json` at runtime instead of hardcoded string
- Updated bin path to `dist-npm/cli/index.js`
- Template dependency updated to `^0.9.61-beta`

### 4. Website Documentation Updates

Revised getting-started documentation to reflect current architecture and best practices.

**installation.md:**
- Removed npm outage notice (packages now published)
- Emphasized `npx @sharpee/sharpee init` as primary workflow
- Added package table showing what's included in umbrella vs individual packages
- Updated project structure to show region-based organization:
  ```
  src/
    regions/
      house.ts       # All rooms + objects for house region
      garden.ts      # All rooms + objects for garden region
  ```
- Removed outdated separate `rooms/` and `objects/` folder structure

**quick-start.md:**
- Rewrote tutorial to use region-based pattern (single `house.ts` file)
- Demonstrated `AuthorModel` usage for setup (bypasses validation for placing items in closed containers)
- Added browser client section with build commands
- Added link to new design patterns visualization page
- Updated code samples to match current APIs

### 5. npm Publish Tag Management

Created tooling to manage npm dist-tags for published packages.

**scripts/npm-latest.sh:**
- Tags specified packages with `latest` dist-tag
- Supports `--otp` flag for two-factor authentication codes
- Supports `--dry-run` flag for verification before publishing
- Default: all 19 Sharpee packages
- Usage: `./scripts/npm-latest.sh --otp 123456`

**Publishing Tag Strategy:**
- Updated `scripts/publish-npm.sh` to use `--tag latest` instead of `--tag beta`
- Allows users to install with `npm install @sharpee/sharpee` without version suffix
- Version format remains `X.Y.Z-beta` to indicate pre-1.0 status

**npm Authentication Limitation Discovered:**
- npm no longer supports automation access tokens for publishing
- Web-based authentication requires per-command verification
- Publishing workflow requires manual OTP entry for each package
- Documented in script comments for future reference

### 6. Package Verification

Verified the `@sharpee/sharpee` umbrella package works end-to-end.

**Scaffolding Test:**
- Command: `npx @sharpee/sharpee init shut-up-wesley`
- Result: Successfully created new project with all templates
- Confirmed bin path (`dist-npm/cli/index.js`) is correct
- Confirmed template dependency version (`^0.9.61-beta`) is correct

**Package Contents:**
- Verified published package includes `dist-npm/` output
- CLI binary properly installed
- Template files properly included
- All dependencies correctly resolved

### 7. Website Documentation Deep Update

Audited and rewrote major portions of the author guide to match actual Sharpee APIs.

**API Drift Investigation:**
Found significant differences between documentation and actual codebase:
- No `world.createRoom()` or `world.createObject()` — everything uses `world.createEntity(name, EntityType.X)`
- No `world.addTrait()` — traits added via `entity.add(new SomeTrait())`
- No `world.connectRooms()` — manual `RoomTrait.exits` manipulation
- `initializeWorld()` returns `void`, not `IFEntity`
- Story uses class implementing `Story` interface, not object literal
- `createPlayer()` is a required method on Story interface

**creating-stories.md (Complete Rewrite):**
- Story interface requirements: `initializeWorld()`, `createPlayer()`, `extendParser()`
- Correct entity creation API: `world.createEntity(name, EntityType.Room)`
- Region-based organization pattern detailed
- Project size guidance:
  - Small (1-10 rooms): Inline in index.ts
  - Medium (10-50 rooms): Region files in src/regions/
  - Large (50+ rooms): Full structure with regions/npcs/actions/tests
- Removed all references to fictional convenience methods
- Added AuthorModel explanation for setup phase

**rooms.md (Complete Rewrite):**
- Correct room creation: `world.createEntity(name, EntityType.Room)`
- Manual exit manipulation: `const roomTrait = room.getTrait<RoomTrait>(RoomTrait.type)`
- Added `setExits` helper function for bidirectional connections
- Region pattern examples (West of House containing all rooms)
- Removed all fictional `world.connectRooms()` and `world.createRoom()` calls
- Added guidance on when to split regions vs keep together

**objects.md (Complete Rewrite):**
- Correct object creation: `world.createEntity(name, EntityType.Object)`
- Trait addition: `entity.add(new PortableTrait())`
- Comprehensive trait table showing all available traits:
  - PortableTrait, ContainerTrait, SupporterTrait, OpenableTrait
  - LockableTrait, SwitchableTrait, LightSourceTrait, EditableTrait
  - WearableTrait, EdibleTrait, ClimbableTrait, EnterableTrait
  - DestroyableTrait, SceneryTrait, WeaponTrait
- AuthorModel usage for placing items in closed containers during setup
- Region-based object organization examples
- Removed all fictional convenience methods

## Key Decisions

### 1. Build System Isolation: dist-npm Directory

**Decision:** Use permanent `dist-npm/` output directory for npm builds instead of trying to share `dist/` with other build targets.

**Rationale:**
- Avoids conflicts between Zifmia's `build.sh` (uses `dist/`) and npm publishing
- Eliminates need for cleanup scripts that might interfere with CI/CD
- Makes package.json paths explicit and permanent
- Simpler mental model: `dist/` for bundled apps, `dist-npm/` for published packages

**Alternatives Rejected:**
- Option A (cleanup script): Too fragile, CI/CD complexity
- Option B (dual build): Wasteful, still requires coordination
- Option D (package filter): Doesn't solve the core conflict

### 2. Publish Tag: latest vs beta

**Decision:** Changed npm publish tag from `--tag beta` to `--tag latest`.

**Rationale:**
- Sharpee is stable enough for public use (0.9.x series)
- Makes `npm install @sharpee/sharpee` work without `@beta` suffix
- Users expect `latest` tag by default
- Can still use version suffix (`0.9.61-beta`) to indicate pre-1.0 status

### 5. Documentation Accuracy: API Audit Before Writing

**Decision:** Performed comprehensive API audit before updating documentation, comparing docs to actual codebase.

**Rationale:**
- Previous documentation referenced non-existent convenience methods
- Authors would copy examples that don't compile
- Creates frustration and erodes trust in documentation
- Better to document actual APIs (even if verbose) than fictional nice-to-haves
- Can propose convenience APIs separately, but docs must reflect reality

**Pattern Established:**
- Always verify API signatures against actual code
- Test code examples in real projects before documenting
- Document workarounds (like `setExits` helper) for common patterns
- Note when APIs are verbose and could be improved

### 3. Region-Based Story Organization

**Decision:** Updated documentation to recommend single file per region instead of separate rooms/objects folders.

**Rationale:**
- Dungeo implementation proved this pattern scales well (~191 rooms)
- Reduces cognitive overhead (one file to open, not three)
- Still modular at region level for large stories
- Matches actual practice in codebase

### 4. Pattern Visualization as Website Feature

**Decision:** Build interactive pattern graph as part of website instead of standalone tool.

**Rationale:**
- Provides discoverable entry point for authors learning IF patterns
- Leverages existing website deployment infrastructure
- D3.js force-directed layout makes relationships visually obvious
- Can be updated automatically when pattern content changes

## Open Items

### Short Term
- Finish website documentation updates:
  - `author-guide/npcs.md` - Still has old API patterns
  - `developer-guide/project-structure.md` - Repository layout is stale
  - `developer-guide/build-system.md` - References old build.sh patterns
  - `tutorials/cloak-of-darkness.md` - Uses fictional convenience APIs
- Test website dev server to verify all pages render correctly
- Update tiered scaffolding: `sharpee init` should ask "small/medium/large?" and scaffold accordingly:
  - Small: Inline in index.ts (current behavior)
  - Medium: Create sample region file in `src/regions/`
  - Large: Full structure with regions/npcs/actions/tests folders
- Update init template to create region-based structure (not inline)

### Long Term
- DSLM pattern content updates: All 124 pattern files have "Sharpee Implementation" sections that reference old APIs (pre-ADR-087 grammar, pre-ADR-090 capability dispatch, etc.)
- Website author guide pages need API updates to match current architecture
- Consider adding pattern statistics to visualization (most connected, most referenced, etc.)
- Build pattern coverage report: which patterns are implemented in Dungeo?

## Files Created

**Website & Patterns** (3 files):
- `website/scripts/extract-patterns.mjs` - Pattern extraction from markdown to JSON
- `website/src/data/patterns.json` - 124 nodes, 223 edges for graph visualization
- `website/src/pages/design-patterns/index.astro` - Interactive D3.js force-directed graph

**Scripts** (2 files):
- `scripts/npm-latest.sh` - Tag existing npm versions as latest (supports --otp and --dry-run)
- `scripts/publish-npm.sh` - Modified to use --tag latest instead of --tag beta

**Documentation** (1 file):
- `docs/work/npm/build-options.md` - Build system analysis and decision rationale

## Files Modified

**Build & Publish Scripts** (1 file):
- `website/astro.config.mjs` - Added design patterns page to sidebar

**Documentation** (5 files):
- `website/src/content/docs/getting-started/installation.md` - Region-based structure, npm workflow
- `website/src/content/docs/getting-started/quick-start.md` - Region-based tutorial, AuthorModel, browser client
- `website/src/content/docs/author-guide/creating-stories.md` - Complete rewrite with correct APIs, Story interface, project size guidance
- `website/src/content/docs/author-guide/rooms.md` - Complete rewrite with correct room creation, exit manipulation, region pattern
- `website/src/content/docs/author-guide/objects.md` - Complete rewrite with correct trait classes, comprehensive trait table, AuthorModel usage

**@sharpee/sharpee Package** (4 files):
- `packages/sharpee/package.json` - Added 5 plugin dependencies, dist-npm paths, build:npm script
- `packages/sharpee/tsconfig.json` - Added project references for plugins and extensions
- `packages/sharpee/src/index.ts` - Re-exported plugin system
- `packages/sharpee/src/cli/index.ts` - Dynamic version from package.json

**Template** (1 file):
- `packages/sharpee/templates/story/package.json.template` - Updated to 0.9.61-beta

**All 19 Package Manifests** (19 files):
- Added `build:npm` script to all packages
- Changed all paths from `dist/` to `dist-npm/` in main/types/module/exports/files fields
- Packages: engine, world-model, stdlib, lang-en-us, parser-en-us, plugin-npc, plugin-scheduler, plugin-state-machine, plugins, platform-browser, platform-node, extension-testing, extensions, utils-common, utils-entity-factory, client-browser, template, sharpee, (19th is implied from context)

## Architectural Notes

### Build System Design Pattern

The separation of `dist/` and `dist-npm/` represents a clean architectural boundary:

```
dist/          → Bundled applications (CLI, browser clients, Zifmia)
dist-npm/      → Published npm packages (library distribution)
```

This mirrors the distinction between "application artifacts" and "library artifacts" in build systems. Applications need bundling, dead code elimination, and environment-specific optimization. Libraries need source maps, type definitions, and multiple output formats (CJS/ESM).

### Pattern Graph as Living Documentation

The design patterns visualization demonstrates "documentation as code" principles:
- Source of truth: markdown files in sharpee-dslm repo
- Build step: `extract-patterns.mjs` generates JSON
- Deployment: Astro static site generation
- Updates: Re-run extraction when patterns change

This ensures the graph stays synchronized with pattern content, unlike manually maintained diagrams.

### Region-Based Organization Scales

Dungeo's implementation with ~191 rooms proved that region-based organization (one file per region containing all rooms and objects) scales well:
- Typical region file: 200-400 lines
- Easy to navigate with TypeScript outline view
- Related content stays together (trap door and rug in same file)
- Still modular at region boundaries

This validates the architectural decision to recommend regions over rooms/objects folders.

### Documentation as Truth vs Fiction

The website documentation audit revealed a critical issue: previous docs documented "ideal" APIs that don't exist, rather than actual working code. This creates a poor first-time author experience:

1. Copy example from docs
2. Get compilation errors
3. Spend time debugging
4. Discover the API doesn't exist
5. Lose trust in documentation

The correct approach:
1. Document what actually exists in the codebase
2. Verify all code examples compile and run
3. Provide helper functions for common verbose patterns (like `setExits` for bidirectional connections)
4. Keep a separate wishlist of "nice-to-have" convenience APIs
5. Implement convenience APIs, then update docs — not the reverse

This is especially important for a new framework where authors haven't built muscle memory. Every friction point during onboarding compounds.

## Notes

**Session duration**: ~4.5 hours (two segments: 17:38 initial, 17:48 continuation)

**Approach**: Multi-threaded work across documentation, build system, and website features. Started with pattern visualization (high-impact feature), then addressed npm publishing blocker (build conflicts), then performed comprehensive documentation audit and rewrites.

**Key Insights**:
1. The build system conflict revealed a deeper architectural issue - Sharpee has two distinct build targets (applications vs libraries) that were sharing infrastructure. Separating them clarified the mental model and eliminated fragility.
2. Documentation drift is insidious - when docs describe an "ideal" API that doesn't exist, every new author hits the same frustrating onboarding experience. Auditing docs against actual codebase is essential before any public release.

**Tools Used**: D3.js for visualization, pnpm workspace for monorepo management, Astro for static site generation, madge for dependency analysis (mentioned in CLAUDE.md but not used this session).

---

**Progressive update**: Session continued 2026-01-30 17:48 - added npm tag management, package verification, and major documentation rewrites (creating-stories.md, rooms.md, objects.md)
