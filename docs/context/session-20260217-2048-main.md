# Session Summary: 2026-02-17 - main (CST)

## Status: Completed

## Goals
- Complete ADR-078 canvas puzzle mechanics for the Dungeo story
- Fix SceneryTrait cantTakeMessage not displaying on frame take attempt
- Fix break action entity resolution
- Fix painting/canvas alias disambiguation
- Achieve 650/650 perfect score with full end-to-end ghost ritual walkthrough

## Completed

### Bug Fix: SceneryTrait cantTakeMessage Not Displaying
- **Root cause**: The taking action's blocked phase (`taking.ts:440`) checks `error.includes('.')` to determine if a message is a fully-qualified ID. The literal string `"The frame is mounted on the wall."` contained a period, so it was treated as a message ID lookup — which failed silently with empty output.
- **Fix**: Changed `cantTakeMessage` in `thiefs-canvas-objects.ts` from literal text to the proper message ID `'dungeo.frame.cant_take'`, and registered the actual text string in `action-messages.ts`.
- **Lesson**: SceneryTrait `cantTakeMessage` values must always be message IDs, not literal English strings, because the blocked phase always treats dot-containing strings as IDs.

### Bug Fix: Break Action Entity Resolution
- **Root cause**: The break action's `getDirectObject()` function performed its own entity resolution by scanning `world.getAllEntities().find()` rather than using the parser-resolved entity from `context.command.directObject`. This fragile approach risked matching wrong entities.
- **Fix**: Rewrote `getDirectObject()` to use `context.command.directObject` — the standard pattern used by all stdlib actions.
- **Impact**: "break frame" now correctly resolves to the frame entity using the parser's disambiguation logic.

### Bug Fix: Painting/Canvas Alias Disambiguation
- **Root cause**: The painting entity (the non-portable framed painting in the underground) had "canvas" as one of its aliases. When the player had a rolled-up canvas in inventory and tried `put canvas in trophy case`, both the inventory canvas and the painting matched, triggering disambiguation.
- **Fix**: Removed "canvas" from the painting's aliases in `underground.ts`. The painting is still accessible as "painting" and by full name.

### New Walkthrough: wt-16-canvas-puzzle.transcript
- Created full end-to-end ghost ritual walkthrough covering:
  1. Pick up incense and frame piece from Living Room
  2. Navigate to Basin Room (Living Room → Cellar → Troll Room → E/W Passage → Deep Ravine → Chasm → N/S Passage → Loud Room → Ancient Chasm → Basin Room)
  3. Burn incense (disarms basin trap, state: normal → disarmed)
  4. Pray (blesses water, golden light, state: disarmed → blessed)
  5. Drop frame piece (ghost ritual triggers — thief's ghost appears, canvas spawns in Gallery, 10 pts awarded)
  6. Teleport to Gallery, take canvas (10 pts OFVAL)
  7. Teleport to Living Room, put canvas in trophy case (14 pts OTVAL)
  8. Score: 650/650 confirmed

### Updated Walkthrough: wt-13-thief-fight.transcript
- Added frame-breaking sequence after thief death: `break frame`, `take frame piece`
- Added `drop frame piece` at Living Room before save (sets up wt-16 starting state)
- Incense already present in Living Room from prior setup

### Test Results Confirmed
- All 771 tests across 16 walkthroughs pass
- Full chain run completes in approximately 7.5 seconds
- Perfect score: 650/650

## Key Decisions

### 1. Message IDs vs Literal Strings in Trait Properties
SceneryTrait's `cantTakeMessage` must always be a message ID. The taking action's blocked phase uses a simple heuristic — if the string contains a dot, it treats it as an ID. Literal English sentences that contain periods will be silently misrouted. This is a platform-level behavior that all story authors need to understand. Using a message ID is the correct pattern.

### 2. Standard Entity Resolution Pattern
All actions should use `context.command.directObject` for entity resolution, not ad-hoc `world.getAllEntities().find()` scans. The break action was an outlier that bypassed the parser's disambiguation system. The fix brings it in line with stdlib convention and makes it more robust.

### 3. Alias Minimalism
The painting entity's "canvas" alias was overly broad. Aliases should reflect what the player is likely to type for that specific object, not synonyms of the object's category. The rolled-up canvas is the only "canvas" the player should interact with as "canvas" in the late game.

### 4. Canvas Puzzle Final Scoring Split (10+10+14=34)
The 34-point canvas puzzle total is divided as:
- 10 pts: ghost ritual reveal (awarded by interceptor via `world.awardScore()`)
- 10 pts: taking the canvas (OFVAL in MDL source)
- 14 pts: placing canvas in trophy case (adjusted OTVAL — MDL had 24, minus 10 moved to ritual)

### 5. Three-Phase Basin Puzzle (normal → disarmed → blessed)
The ghost ritual requires both incense (disarm) AND prayer (bless). Burning incense alone is insufficient. This adds intentional depth: the player must perform the full ritual sequence to trigger the ghost's appearance.

## Open Items

### Short Term
- Verify incense fuse reset handles `blessed → normal` state correctly (sets `basinState = 'normal'` directly; untested with blessed state edge case)
- Pre-existing unrelated failure noted: blue crystal sphere in Dreary Room (thief stealing during wt-13) — this was noted as pre-existing before this session

### Long Term
- Full Dungeo completion: remaining rooms and puzzles beyond the canvas puzzle
- Consider documenting the "message ID vs literal string" pattern in CLAUDE.md or a story author guide to prevent future confusion

## Files Modified

**Story objects** (2 files):
- `stories/dungeo/src/objects/thiefs-canvas-objects.ts` — Changed `cantTakeMessage` from literal text `"The frame is mounted on the wall."` to message ID `'dungeo.frame.cant_take'`
- `stories/dungeo/src/regions/underground.ts` — Removed `"canvas"` from painting entity aliases to fix disambiguation

**Story actions** (1 file):
- `stories/dungeo/src/actions/break/break-action.ts` — Rewrote `getDirectObject()` to use `context.command.directObject` instead of `world.getAllEntities().find()` scan

**Story messages** (1 file):
- `stories/dungeo/src/messages/action-messages.ts` — Added `dungeo.frame.cant_take` message text registration

**Walkthroughs** (2 files):
- `stories/dungeo/walkthroughs/wt-13-thief-fight.transcript` — Added `break frame`, `take frame piece`, `drop frame piece` sequence after thief death
- `stories/dungeo/walkthroughs/wt-16-canvas-puzzle.transcript` — NEW: full ghost ritual walkthrough from Living Room to 650/650 score

**Architecture docs** (1 file):
- `docs/architecture/adrs/adr-078-magic-paper-puzzle.md` — Updated to reflect completed implementation

## Architectural Notes

The `cantTakeMessage` dot-heuristic in the taking action's blocked phase is a subtle footgun for story authors. The check `error.includes('.')` is designed to detect fully-qualified message IDs (e.g., `dungeo.frame.cant_take`), but any English sentence ending with a period will also pass this check and be treated as an ID. The fix — using a proper message ID — is also the architecturally correct pattern, since it keeps English prose out of entity definitions and in the language layer.

The break action's original `getDirectObject()` was an anomaly: it bypassed the parser entirely and did its own entity scan. This meant disambiguation prompts from the parser would have no effect on break-target resolution. The rewrite to use `context.command.directObject` restores correct behavior and aligns the action with the rest of stdlib.

The canvas puzzle is now complete. The 34-point arc (frame → ritual → canvas → trophy case) demonstrates the multi-step puzzle pattern working correctly across different sessions, save/restore cycles, and action types (scenery interaction, grammar extension, interceptor scoring, standard taking/dropping).

## Notes

**Session duration**: ~1.5 hours (continuation from previous session's 2.5-hour implementation)

**Approach**: Each bug was isolated through verbose transcript output, root-caused in source, fixed minimally, then re-tested. No speculative multi-file changes — one issue at a time per CLAUDE.md policy.

**Build status**: Build passes. All 771 tests pass across 16 walkthroughs.

**Score status**: 650/650 — perfect score achieved.

---

**Progressive update**: Session completed 2026-02-17 22:23 CST
