# Session Summary: 2026-02-18 - main (CST)

## Status: Completed (with open items)

## Goals
- Fix 4 critical endgame bugs blocking completion
- Implement missing Prison Cell → Treasury connection
- Begin wt-17 endgame walkthrough

## Completed

### Bug 1: Crypt Door Entity Missing — Endgame Trigger Never Fires
The endgame trigger daemon was searching for a non-existent 'crypt door' entity. The `isCryptDoorClosed()` function always returned false, causing the turn counter to reset on every turn, so the endgame could never be triggered naturally.

- Removed `isCryptDoorClosed()` function entirely
- Removed `OpenableTrait` import (no longer needed)
- Removed the door-check block from daemon's `run()` method
- Reduced `TURNS_REQUIRED` from 15 to 3 (matches FORTRAN clockr.for CEV20)
- Adjusted atmosphere message from turn 5 to turn 2 (fits 3-turn window)
- Result: Trigger is now FORTRAN-accurate — player in Tomb + room dark + 3 turns

### Bug 2: Stone Button Push Blocked by SceneryTrait — Laser Puzzle Broken
The stone button had `SceneryTrait` which prevented interaction, but lacked `PushableTrait` so the stdlib pushing action would not process it.

- Added `PushableTrait` import to `endgame.ts`
- Added `PushableTrait({ pushType: 'button' })` to the stone button entity
- Removed redundant `button.attributes.isPushable = true`
- Kept `SceneryTrait` to prevent taking the button
- Result: Stdlib pushing action now sees PushableTrait, emits `if.event.pushed`, and the laser handler fires

### Bug 3: 50 of 100 Endgame Points Never Awarded — Scoring Handlers Missing
The endgame has milestone points for reaching specific rooms (Inside Mirror, Dungeon Entrance, Narrow Corridor) that were never being awarded. The victory machine had `?? 65` and `?? 616` fallbacks that masked the missing points.

- Created new file `stories/dungeo/src/handlers/endgame-scoring-handler.ts`
  - Listens for `if.event.actor_moved` during endgame
  - Awards one-time milestone points to `scoring.endgameScore`:
    - Inside Mirror: +15 (cumulative total 30)
    - Dungeon Entrance: +15 (cumulative total 45)
    - Narrow Corridor: +20 (cumulative total 65)
  - Deduplicates via `endgame.scored.*` state flags
- Fixed `stories/dungeo/src/state-machines/victory-machine.ts`
  - Removed `?? 65` fallback on `scoring.endgameScore`
  - Removed `?? 616` fallback on `scoring.score`
  - Both now use `|| 0` to use actual accumulated scores
- Wired handler into `orchestration/event-handlers.ts` and `orchestration/index.ts`
  - Added `endgameScoringConfig` to `EventHandlerConfig`
  - Passes 3 milestone room IDs from endgame region

### Bug 4: Inventory Not Stripped on Endgame Entry
FORTRAN clockr.for CEV20 strips all player items before entering the endgame and gives the player a lit lamp (350 fuel) and the Elvish sword. This was not implemented.

- Added `stripPlayerInventory()` to `endgame-trigger-handler.ts`
  - Moves all player items to limbo (`null`)
- Added lamp handling
  - Finds 'brass lantern', moves to player
  - Resets `fuelRemaining` to 350
  - Sets `isLit` and `isOn` to true
- Added `SwitchableTrait` import
- Replaced `findElvishSword()` with general `findEntityByName()` (used for both sword and lantern)

### Feature: Prison Cell → Treasury Connection
When the bronze door is opened, a south exit must be created from Prison Cell to Treasury.

- Added `registerBronzeDoorHandler()` to `orchestration/puzzle-handlers.ts`
  - Listens for `if.event.opened` on bronze door (identified by `isTreasuryDoor` attribute)
  - Creates Prison Cell SOUTH → Treasury exit when door is opened
- Added `prisonCell` and `treasury` to the `PuzzleConfig` interface
- Wired into `orchestration/index.ts`
- Note: Parapet → Prison Cell connection was already implemented in `push-dial-button-action.ts`
- Note: Thief disable (originally planned as Feature 3) was skipped — thief is already dead by endgame

### Test Updates
- Updated `stories/dungeo/tests/transcripts/endgame-laser-puzzle.transcript`
  - Old assertions expected button push to fail (SceneryTrait was blocking)
  - New behavior correctly processes the push and fires the laser handler
- All 7 endgame unit tests pass (84/84 assertions)
- Build successful

## Key Decisions

### 1. Match FORTRAN for Crypt Door (Bug 1)
Rather than creating a new crypt door entity and implementing open/close logic, the fix matched the FORTRAN source exactly: no door check, 3-turn requirement. The original code appears to have been written anticipating a door entity that was never built.

### 2. Separate Endgame Scoring via State Flags (Bug 3)
Endgame milestone scoring uses dedicated `endgame.scored.*` state flags to prevent double-awarding. This keeps endgame scoring separate from main game treasure scoring, matching the FORTRAN design where endgame points are awarded in a separate scoring pass.

### 3. Remove Hardcoded Victory Machine Fallbacks (Bug 3)
The `?? 65` and `?? 616` fallbacks were masking bugs rather than providing safety. Removing them and using `|| 0` forces scores to be computed correctly from actual game state.

### 4. Skip Thief Disable Feature
The original plan listed "disable thief" as Feature 3. Verified thief is already dead before endgame is reachable (wt-16 kills the thief). No implementation needed.

### 5. wt-17 Trivia Randomness Problem
The endgame trivia quiz uses `Math.random()` to pick the starting question. With 8 possible starting positions and a 5-wrong limit, no fixed answer ordering in a transcript can handle all starting positions. The correct solution is to add an `output contains` condition to the transcript tester's condition evaluator, enabling IF blocks to pick answers based on what question text is shown.

## Open Items

### Short Term
- Implement `output contains` condition in `packages/transcript-tester/src/condition-evaluator.ts`
  - Enables: `[IF output contains "What is..."] > answer`
  - Required for wt-17 to handle randomized trivia question ordering
- Write `stories/dungeo/walkthroughs/wt-17-endgame.transcript`
  - Route: Living Room → East → Entrance → ... → Tomb
  - Must handle randomized trivia quiz
  - Must verify 650-point final score
- Run full walkthrough chain regression test (`wt-*.transcript`)
- Commit all changes from this session

### Long Term
- Full 650-point verification via complete walkthrough chain
- ADR for `output contains` condition syntax if adopted as a general pattern

## Files Modified

**Handlers** (2 files):
- `stories/dungeo/src/handlers/endgame-trigger-handler.ts` - Bug 1 (removed door check, 3-turn FORTRAN match) + Bug 4 (inventory strip, lamp setup)
- `stories/dungeo/src/handlers/endgame-scoring-handler.ts` - NEW: milestone scoring for 3 endgame rooms

**Regions** (1 file):
- `stories/dungeo/src/regions/endgame.ts` - Bug 2: added PushableTrait to stone button

**State Machines** (1 file):
- `stories/dungeo/src/state-machines/victory-machine.ts` - Bug 3: removed hardcoded score fallbacks

**Orchestration** (2 files):
- `stories/dungeo/src/orchestration/event-handlers.ts` - Wired endgame scoring handler
- `stories/dungeo/src/orchestration/index.ts` - Wired endgame scoring + bronze door handler
- `stories/dungeo/src/orchestration/puzzle-handlers.ts` - Added bronze door → Prison Cell exit handler

**Tests** (1 file):
- `stories/dungeo/tests/transcripts/endgame-laser-puzzle.transcript` - Updated for corrected push behavior

## Architectural Notes

**Endgame vs Main Game Scoring**: The FORTRAN source treats endgame scoring as a separate accumulator (`CEV20` = endgame score, separate from main `SCORE`). The implementation mirrors this with `scoring.endgameScore` vs `scoring.score`, combined at victory screen display. State flags (`endgame.scored.mirror`, etc.) prevent double-awarding on revisit.

**PushableTrait + SceneryTrait Coexistence**: SceneryTrait prevents taking/examining-as-takeable, while PushableTrait enables pushing. These are compatible on the same entity. This pattern is correct for fixed buttons, levers, and other interactive scenery.

**Trivia Randomness in Transcripts**: The transcript tester currently only supports deterministic command sequences. The `output contains` condition would be a significant but clean extension — evaluate the condition against the most recent output buffer, branching the transcript execution path. This is analogous to IF branches in scripting languages.

## Notes

**Session duration**: ~2 hours

**Approach**: Systematic bug-by-bug analysis against FORTRAN canonical source (clockr.for CEV20), then implementation. Each fix was verified with the existing endgame unit test suite before moving to the next bug.

**FORTRAN canonical reference**: `docs/dungeon-81/mdlzork_810722/clockr.for` CEV20 block is authoritative for endgame trigger timing, inventory strip behavior, and lamp initialization.

---

**Progressive update**: Session completed 2026-02-18 00:30 CST
