# Session Summary: 2026-02-08 - main (3:42 PM CST)

## Status: Completed

## Goals
- Complete Phase 6 of thief-fight-plan: DIAGNOSE Command Verification
- Verify DIAGNOSE output matches canonical MDL text (melee.137:302-324)
- Fix DIAGNOSE command producing no CLI output (browser-only rendering)
- Ensure both CLI and browser render through standard text pipeline

## Completed

### Phase 6: DIAGNOSE Command Verification

Fixed critical bug where DIAGNOSE command produced no output in CLI while working in browser, then verified all output text matches canonical MDL source.

#### 1. Bug Diagnosis and Root Cause

**Symptom**: DIAGNOSE command worked in browser but produced no output in CLI.

**Root cause**:
- Action emitted single `dungeo.event.diagnose` event with structured data
- Browser had custom `formatDiagnose()` function in browser-entry.ts to render it
- CLI text-service's generic handler dropped the event (no message registered for that event type)
- Event system split: browser had special rendering, CLI had nothing

**Why this happened**: Story-specific events need message registrations to work in CLI, OR need both clients to have custom formatters (fragile).

#### 2. Solution: Standard Text Pipeline

**Changed diagnose action to emit `game.message` events**:
- `report()` now emits multiple `game.message` events instead of single `dungeo.event.diagnose`
- Each message has a registered `DiagnoseMessages` ID in `action-messages.ts`
- Both CLI and browser render through standard text service (no custom formatters needed)
- Removed `formatDiagnose()` function from browser-entry.ts (now dead code)

**Combined message IDs** for canonical formatting:
- `LIGHT_WOUND_CURE` — "You have a light wound, which will take about N turns to heal."
- `SERIOUS_WOUND_CURE` — "You have a serious wound, which will require about N turns to heal."
- `SEVERAL_WOUNDS_CURE` — "You have several wounds, which will require about N turns to heal."
- `SERIOUS_WOUNDS_CURE` — "You have sustained serious wounds, which will take about N turns to heal."
- `KILLED_MANY` — "You have been killed N times."

**Why combined**: Separate `game.message` events render on separate lines, but canonical output is one sentence. Combined IDs allow functions that receive `{turns, wounds, deaths}` data.

#### 3. Canonical Text Verification

**All DIAGNOSE messages match MDL melee.137:302-324**:

| Condition | Canonical Text | Implementation |
|-----------|----------------|----------------|
| Perfect health | "You are in perfect health." | `PERFECT_HEALTH` |
| Light wound (WD=1) | "You have a light wound, which will take about N turns to heal." | `LIGHT_WOUND_CURE` |
| Serious wound (WD=2) | "You have a serious wound, which will require about N turns to heal." | `SERIOUS_WOUND_CURE` |
| Several wounds (WD=3) | "You have several wounds, which will require about N turns to heal." | `SEVERAL_WOUNDS_CURE` |
| Serious wounds (WD=4+) | "You have sustained serious wounds, which will take about N turns to heal." | `SERIOUS_WOUNDS_CURE` |
| Death count = 1 | "You have been killed once." | `KILLED_ONCE` |
| Death count = 2 | "You have been killed twice." | `KILLED_TWICE` |
| Death count ≥ 3 | "You have been killed N times." | `KILLED_MANY` |
| Strength status | "You are at death's door." through "You are strong enough to face a tiger." | `VERY_WEAK` through `VERY_STRONG` |

**Healing time formula** matches canonical `CURE-WAIT * (WD-1) + CTICK(CURIN)`:
```typescript
const healingTurns = (wounds - 1) * CURE_WAIT + cureTicksRemaining;
```

**Strength/resilience status** uses canonical thresholds:
- Death's door: strength ≤ 0
- Frail: strength ≤ 1
- Weak: strength ≤ 2
- Low: strength ≤ 3
- Average: strength ≤ 5
- Strong: strength > 5

#### 4. Transcript Updates

**Updated `help-commands.transcript`**:
- **Before**: `[EVENT: dungeo.event.diagnose]` (checked for event emission only)
- **After**: `[OK: contains "You are in perfect health"]` (checks actual output)
- Now verifies user-visible text, not internal events

**Updated `combat-disengagement.transcript`**:
- **Before**: `[EVENT: dungeo.event.diagnose]`
- **After**: `[OK: contains "light wound"]` (hero wounded after combat)
- Checks post-combat wound status is reported correctly

### Testing

**Test Results**:
- Full walkthrough chain: 216 pass / 6 skip (1462ms)
- No regressions from Phase 6 changes
- Build clean, bundle 2.1M

**Pre-existing issue found**: combat-disengagement.transcript is flaky (2/5 failures) because the troll can be one-shot killed by the sword's best-weapon bonus (DEF1 table with ATT=2 has 2/9 KILLED outcomes). Not related to Phase 6 changes.

## Key Decisions

### 1. Emit game.message Instead of dungeo.event.diagnose

**Decision**: Change diagnose action to emit multiple `game.message` events instead of single structured `dungeo.event.diagnose` event.

**Rationale**:
- Story-specific events require custom formatters in EVERY client (CLI, browser, future clients)
- `game.message` events use standard text pipeline (registered message IDs → strings)
- Reduces client coupling (browser no longer has story-specific rendering code)
- CLI and browser now render identically without special cases

**Trade-off**: Structured data (wound count, healing turns) is baked into message strings. If we need programmatic access to this data later (e.g., for accessibility), we'd need a different approach. For now, text rendering is the only requirement.

### 2. Combined Message IDs for Multi-Part Sentences

**Decision**: Create combined message IDs (`LIGHT_WOUND_CURE`, `SERIOUS_WOUND_CURE`, etc.) instead of separate `LIGHT_WOUND` + `CURE_TIME` messages.

**Rationale**:
- Each `game.message` event renders as a separate line in text service
- Canonical output is one sentence: "You have a light wound, which will take about 4 turns to heal."
- Separate events would render: "You have a light wound." / "It will take about 4 turns to heal." (wrong)
- Combined IDs allow message functions: `(data) => "You have a light wound, which will take about ${data.turns} turns to heal."`

**Alternative considered**: Emit single `game.message` with pre-formatted string from action. Rejected because it bypasses message registry (loses message ID tracking, harder to test/override).

### 3. Keep Original Uncombined Message IDs

**Decision**: Keep `LIGHT_WOUND`, `CURE_TIME`, etc. message IDs even though they're unused after the fix.

**Rationale**:
- No harm in having extra message IDs (just strings in a map)
- Might be useful for future message composition or testing
- Removing them is premature optimization (not worth the churn)

### 4. Remove formatDiagnose() from Browser

**Decision**: Delete `formatDiagnose()` function and `dungeo.event.diagnose` case from `handleStoryEvent()` in browser-entry.ts.

**Rationale**:
- Dead code after action change (diagnose no longer emits `dungeo.event.diagnose`)
- Browser now renders through standard text pipeline (same as CLI)
- Reduces browser-specific story code (better maintainability)

## Open Items

### Short Term

**Phase 7: Troll Integration** (next session)
- Verify troll uses canonical melee tables
- Test troll disengagement (player flees from troll room)
- Clean up troll capability declaration (ISSUE-051)

**ISSUE-051**: TrollTrait capability declaration stale
- Logged in `docs/work/issues/issues-list-03.md`
- Cosmetic stderr warning (functionality unaffected)
- Needs cleanup: remove stale capability declaration from troll-trait.ts

**combat-disengagement.transcript flakiness**
- Troll can be one-shot killed by sword (DEF1 table with ATT=2 has 2/9 KILLED outcomes)
- Test passes 60% of the time, fails 40%
- Options: Add [WHILE: not entity "troll" alive] loop, or increase OSTRENGTH, or accept flakiness
- Not blocking Phase 6/7 (pre-existing issue)

### Long Term

**Save Format Migration**
- Remove FLEEING state enum (dead code after Phase 5)
- Clean up deprecated CombatantTrait.currentHp (melee uses meleeWoundAdjust)
- Document save compatibility breakage window

**Villain Counterattack Routing**
- NPC behavior attacks currently go through CombatService (generic HP damage)
- Melee engine attacks go through interceptor (canonical OSTRENGTH tables)
- Should villain counterattacks use melee engine? (out of Phase 5 scope)

## Files Modified

### Modified Files (4 story + 2 transcripts):

**DIAGNOSE action**:
- `stories/dungeo/src/actions/diagnose/types.ts` — Add 5 combined message IDs (`LIGHT_WOUND_CURE`, `SERIOUS_WOUND_CURE`, `SEVERAL_WOUNDS_CURE`, `SERIOUS_WOUNDS_CURE`, `KILLED_MANY`)
- `stories/dungeo/src/messages/action-messages.ts` — Register 5 new combined message strings (wound + healing time as one sentence)
- `stories/dungeo/src/actions/diagnose/diagnose-action.ts` — Rewrite `report()` to emit `game.message` events instead of `dungeo.event.diagnose`
- `stories/dungeo/src/browser-entry.ts` — Remove `formatDiagnose()` function and `dungeo.event.diagnose` case from `handleStoryEvent()`

**Transcripts**:
- `stories/dungeo/tests/transcripts/help-commands.transcript` — Change EVENT assertion to content assertion (`[OK: contains "You are in perfect health"]`)
- `stories/dungeo/tests/transcripts/combat-disengagement.transcript` — Change EVENT assertion to content assertion (`[OK: contains "light wound"]`)

## Architectural Notes

### Story Events vs game.message Pattern

This fix highlights a critical pattern for story-specific commands:

**Anti-pattern (what DIAGNOSE was doing)**:
```typescript
// Action emits structured event
this.emitEffect({
  type: 'dungeo.event.diagnose',
  data: { wounds, healingTurns, deaths, strength }
});

// Each client needs custom formatter
function formatDiagnose(event) {
  return buildOutputFromData(event.data);
}
```

**Correct pattern (what DIAGNOSE does now)**:
```typescript
// Action emits game.message events with registered IDs
this.emitMessage('dungeo.message.light_wound_cure', { turns: 4 });

// Message registry maps IDs to strings/functions
DiagnoseMessages.set('dungeo.message.light_wound_cure',
  (data) => `You have a light wound, which will take about ${data.turns} turns to heal.`
);

// All clients render through standard text pipeline (no custom code)
```

**When to use each**:
- **game.message**: Commands that produce user-visible text (DIAGNOSE, LOOK, INVENTORY)
- **Story events**: State changes that affect game logic (dungeo.event.ate_cake, dungeo.event.troll_died)
- **Hybrid**: Commands that do both (ATTACK emits melee events AND game.message for narration)

### Message ID Composition Strategies

DIAGNOSE revealed three strategies for multi-part messages:

**Strategy 1: Separate messages** (wrong for DIAGNOSE)
```typescript
this.emitMessage('LIGHT_WOUND');  // "You have a light wound."
this.emitMessage('CURE_TIME', { turns: 4 });  // "It will take 4 turns to heal."
// Renders as two lines (not canonical)
```

**Strategy 2: Combined message ID** (correct for DIAGNOSE)
```typescript
this.emitMessage('LIGHT_WOUND_CURE', { turns: 4 });
// Message: "You have a light wound, which will take about 4 turns to heal."
// Renders as one line (canonical)
```

**Strategy 3: Pre-formatted string** (bypasses registry)
```typescript
const msg = `You have a light wound, which will take about ${turns} turns to heal.`;
this.emitMessage('CUSTOM', { text: msg });
// Loses message ID tracking, harder to test/override
```

**Guideline**: Use Strategy 2 when canonical output is a single sentence with dynamic data.

### Canonical Verification Checklist

Phase 6 established a pattern for verifying game output against MDL source:

1. **Locate canonical source**: Find exact MDL file + line numbers (melee.137:302-324)
2. **Create comparison table**: Map MDL conditions to implementation message IDs
3. **Verify formulas**: Ensure calculations match MDL exactly (CURE-WAIT * (WD-1) + CTICK(CURIN))
4. **Test edge cases**: Perfect health, fatal wounds, zero deaths, max deaths
5. **Document in transcript**: Add `[OK: contains ...]` assertions for user-visible text

This checklist applies to any command with canonical output (SCORE, INVENTORY, BRIEF/VERBOSE).

## Thief Fight Plan Progress

| Phase | Status | Description |
|-------|--------|-------------|
| Phase 1 | ✅ COMPLETE | Canonical melee engine (OSTRENGTH tables, stagger, unconscious, wounds) |
| Phase 2 | ✅ COMPLETE | Melee messages (villain attacks, stagger, unconscious, death) |
| Phase 3 | ✅ COMPLETE | Melee interceptor (attack action integration, turn-by-turn combat) |
| Phase 4 | ✅ COMPLETE | Disengagement + healing (flee-and-recover, CURE-CLOCK daemon) |
| Phase 5 | ✅ COMPLETE | Thief behavior (WINNING? function, engrossed flag, fight/flee AI) |
| Phase 6 | ✅ COMPLETE | DIAGNOSE command verification (canonical text, CLI/browser parity) |
| Phase 7 | ⏳ PENDING | Troll integration (canonical tables, disengagement testing) |

## Notes

**Session duration**: ~1 hour

**Approach**: Bug investigation and fix session. Started with "why is DIAGNOSE broken in CLI?", traced through event emission → text rendering pipeline, found structural issue (story event vs game.message), refactored action to use standard text pipeline, verified all output matches canonical MDL.

**Platform Changes**: Zero. All changes are story-level (Dungeo diagnose action + browser entry).

**Build Performance**: Bundle size 2.1M, load time ~117ms, 9-walkthrough chain completes in ~1462ms (no regressions).

**Next Steps**: Phase 7 (troll integration) is already mostly complete (troll uses melee interceptor from Phase 3). Just needs verification testing and capability declaration cleanup.

**Key Insight**: Story-specific events should only be used for game logic (state changes), not for user-facing text output. Text output should always go through `game.message` + message registry to ensure CLI/browser parity.

---

**Progressive update**: Session completed 2026-02-08 3:42 PM CST
