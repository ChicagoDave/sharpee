# Session Summary: 2026-02-10 - main (10:08 AM CST)

## Status: In Progress - Combat Refactor Planned

## Goals
- Verify full walkthrough chain passes
- Remove all regex assertions from transcripts (user mandate: no regex ever)
- Diagnose and plan fix for melee combat system not working

## Completed

### 1. Regex Assertion Removal (All Transcripts)
Removed every `[OK: matches /pattern/]` and `[OK: regex "pattern"]` assertion from all transcript files, replacing with `[OK: contains "text"]` assertions.

**21 transcript files modified:**
- 12 walkthrough transcripts (wt-01 through wt-12)
- 9 unit test transcripts (bank-puzzle, carousel, coal-mine-navigation, boat-stick-puncture, frigid-river-full, implicit-take-put, implicit-take-test, rope-puzzle, round-room-hub)

Key conversion patterns discovered:
- `contains` is case-insensitive (confirmed via transcript-tester source)
- "lit" doesn't appear in lantern output -> use "on" ("switches on")
- "trapdoor" is two words in game: "trap door"
- Items from containers: "You take X from Y" not "Taken."
- Torch is always lit (perpetual flame) - `turn on torch` is a no-op
- Score output: "scored" not "points"

### 2. Thief Death Handler + Circular Dependency Fix (from prior session)
Changes carried forward from previous session's unstaged work:
- Thief death handler rewrite in thief-entity.ts
- Circular dependency fix (thief-helpers.ts)
- wt-12 thief fight walkthrough
- wt-11 scattered treasures walkthrough
- Treasure room handler
- Event handler updates for combat disengagement

### 3. Combat System Root Cause Analysis
Discovered why the troll fight fails (survives 30+ attacks):

**Finding 1**: Hero attacks produce **zero text output**. Verbose testing confirmed every `> attack troll with sword` generates completely empty output - no combat messages at all.

**Finding 2**: NPC counter-attacks use `CombatService` (generic stdlib combat) instead of the canonical MDL melee system. The `npc-service.ts` `executeAttack()` method hardcodes `new CombatService()`.

**Finding 3**: The melee interceptor's message pipeline has an issue. `npc-messages.ts:227` registers `MeleeMessages.HERO_ATTACK` as empty string `''`. The `game.message` events from `postReport` should still render via `data.text` fallback, but attacks produce no visible output, suggesting a deeper issue (interceptor may not be executing at all).

**Finding 4**: `createSeededRandom()` in the melee interceptor used `Date.now()` per attack - attacks within the same millisecond got identical random seeds. Fixed with module-level random instance (but this alone didn't fix the real problem).

### 4. Combat System Refactor Plan
Wrote comprehensive plan: `docs/work/dungeo/combat-system-refactor.md`

**Approach** (all story-level, no platform changes):
1. Debug and fix empty hero attack output (remove empty message registrations, add tracing)
2. Create `resolveVillainAttackOnHero()` function using canonical melee engine
3. Update troll behavior: replace `{ type: 'attack' }` with `{ type: 'custom' }` using melee engine
4. Update thief behavior: same pattern
5. Verify and reduce attack counts in walkthroughs

The key insight: NPC behaviors already support `{ type: 'custom', handler: () => events }` actions, which bypass `executeAttack()` and CombatService entirely. This keeps all changes at the story level.

## Test Results
- Walkthrough chain: 321 passed, 1 failed (troll survives), 63 skipped
- All walkthroughs wt-02 through wt-12 pass cleanly
- wt-01 troll fight is the only failure

## Open Items (Next Session)
1. **Execute combat refactor plan** - Steps 1-6 in combat-system-refactor.md
2. **OVISON treasure concealment** - Carried from prior sessions
3. **Treasure reveal message on thief death** - Carried from prior sessions

## Files Changed This Session
- 12 walkthrough transcripts (regex -> contains conversion)
- 9 unit test transcripts (regex -> contains conversion)
- `stories/dungeo/src/interceptors/melee-interceptor.ts` (module-level random)
- `docs/work/dungeo/combat-system-refactor.md` (new - refactor plan)
- Multiple files from prior session's thief work (unstaged -> staged)

## Work Log (auto-captured)
```
[09:26:15] EDIT: stories/dungeo/walkthroughs/wt-01-get-torch-early.transcript
[09:34:46] EDIT: stories/dungeo/src/interceptors/melee-interceptor.ts
[09:34:52] EDIT: stories/dungeo/src/interceptors/melee-interceptor.ts
[10:06:30] WRITE: /home/dave/.claude/plans/sequential-snacking-knuth.md
[10:07:51] WRITE: docs/work/dungeo/combat-system-refactor.md
[10:10:07] WRITE: docs/context/session-20260210-1008-main.md
```
