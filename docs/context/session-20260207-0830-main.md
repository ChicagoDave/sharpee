# Session Summary: 2026-02-07 - main (08:30 CST)

## Status: Completed

## Goals
- Review Tea Room Phase 5 completion and walkthrough coverage
- Research canonical MDL combat system for Dungeo thief implementation
- Create comprehensive combat implementation plan
- Begin implementation of canonical melee engine

## Completed

### 1. Session Continuity and Testing Strategy

**Reviewed previous session** (`session-20260207-0454-main.md`) documenting Tea Room Phase 5 completion with claim of "212 pass / 6 skip" in full walkthrough chain.

**Clarified testing philosophy**: User confirmed that walkthrough transcripts (wt-\*.transcript) and unit transcripts (tests/transcripts/\*.transcript) serve different purposes:
- Walkthroughs: Play-testing complete puzzle sequences, validate game flow
- Unit transcripts: Implementation testing for specific mechanics
- No consolidation needed — both types have distinct value

**Analyzed walkthrough coverage gaps**: Mapped which regions can be tested with torch (available early) vs lantern (requires coal mine puzzle):
- **Torch-accessible**: Royal Puzzle, mirror toggle, key puzzle, ghost ritual, scoring mechanics
- **Lantern-required**: Coal mine Gas Room, volcano region via glacier
- Next logical walkthrough: `wt-10-royal-puzzle.transcript` (maze, sceptre, ghost, scarab)

### 2. Canonical MDL Combat System Research

**Deep dive into MDL source files** (`docs/dungeon-81/mdlzork_810722/`):

**File: `melee.137`** — Core combat mechanics:
- `FIGHT-STRENGTH` formula: Scales from 2 (score=0) to 7 (score=616), uses `<RANDOM 1 ,RMAX>` where RMAX varies by villain
- `VILLAIN-STRENGTH`: Thief OSTRENGTH=5, troll=2, cyclops=10000 (unbeatable)
- `BLOW` resolution: 9 outcome types (stagger, unconscious, light/serious wound, disarm, hesitate, miss, severed, killed)
- **Three result tables** (DEF1, DEF2, DEF3) with probability distributions based on strength differential
- `BEST-WEAPONS`: Sword +1 vs troll, knife +1 vs thief (reduces villain strength by 1)
- `WINNING?` function: Thief AI uses >3 light wounds or any serious wound as flee trigger

**File: `dung.355`** — Combat state management:
- Disengagement mechanics: Villain heals instantly, player wounds persist
- `CURE-CLOCK` daemon: Heals one wound point every 30 turns
- `DIAGNOSE` command: Maps wound state to descriptive messages

**Key canonical values extracted**:
- SCORE-MAX = 616 (thief death event transitions to 669)
- Thief OSTRENGTH = 5
- Troll OSTRENGTH = 2
- RMAX for thief = 8 (used in FIGHT-STRENGTH random roll)
- CURE-CLOCK interval = 30 turns per wound point

### 3. Thief Combat Implementation Plan

**Created comprehensive 7-phase plan** (`docs/work/dungeo/thief-fight-plan.md`):

**Phase 1: Canonical Melee Engine (Story-Level)**
- Implement raw MDL combat logic in `stories/dungeo/src/combat/`
- No platform changes — pure story-specific code
- SeededRandom support for future `$seed` transcript testing
- Functions: `fightStrength()`, `villainStrength()`, `resolveBlow()`, wound tracking, disengagement, diagnosis

**Phase 2: Melee Messages**
- Map 9 MDL outcome types to English prose
- Separate files for hero vs villain blow messages
- Story-specific messages in `stories/dungeo/src/messages/combat-messages.ts`

**Phase 3: Attacking Action Integration**
- Intercept stdlib attacking action for NPCs with `VillainCombatTrait`
- Replace generic action with canonical melee engine
- Return custom effects with melee messages

**Phase 4: Combat Disengagement + Wound Healing**
- Daemon to detect combat end conditions (villain flees/dies, player leaves)
- Instant villain heal on disengagement
- CURE-CLOCK daemon for player wound healing (30 turns per wound)

**Phase 5: Thief Behavior Updates**
- Implement WINNING? AI (flee logic)
- Thief wandering patterns
- Thief combat follow/pursue mechanics

**Phase 6: DIAGNOSE Command**
- New story-specific action
- Maps wound state to prose descriptions
- Grammar extension for "diagnose" command

**Phase 7: Troll Integration**
- Apply same VillainCombatTrait to troll
- OSTRENGTH=2, defeated easily
- Guards axe + passageway in Round Room region

**Updated plan after user feedback**: Added detailed flee-and-recover cycle mechanics (thief heals instantly but returns with full strength).

### 4. Phase 1 Implementation — Canonical Melee Engine

**Created `stories/dungeo/src/combat/` directory** with three files:

**File: `melee-tables.ts`** (189 lines)
- Six raw result arrays matching MDL source:
  - `DEF1_RESULTS` (20 entries) — Even strength match
  - `DEF2A_RESULTS` (20 entries) — Hero advantage
  - `DEF2B_RESULTS` (20 entries) — Hero advantage (alternate)
  - `DEF3A_RESULTS` (20 entries) — Villain advantage (light)
  - `DEF3B_RESULTS` (20 entries) — Villain advantage (medium)
  - `DEF3C_RESULTS` (20 entries) — Villain advantage (heavy)
- Three indexed table sets (DEF1_TABLE, DEF2_TABLE, DEF3_TABLE) for fast lookup
- `getResultTable()` function for table selection based on strength delta

**File: `melee.ts`** (390 lines)
- Complete canonical melee engine matching MDL behavior:
  - `fightStrength()` — Hero strength calculation with score scaling (2→7)
  - `villainStrength()` — Villain strength with best-weapon penalty
  - `resolveBlow()` — Core combat resolution using result tables
  - `applyHeroBlowToVillain()` — Wound tracking for villains
  - `applyVillainBlowToHero()` — Wound tracking for hero
  - `isHeroDeadFromWounds()` — Death condition check
  - `healOneWound()` — CURE-CLOCK wound healing
  - `getDiagnosis()` — Wound state to prose mapping
  - `isVillainWinning()` — Thief AI flee logic
  - `disengageCombat()` — End combat, instant villain heal
  - `getBestWeaponPenalty()` — Weapon effectiveness (sword vs troll, knife vs thief)
- Full TypeScript type safety with interfaces for combat state
- SeededRandom support throughout for transcript testing

**File: `index.ts`**
- Barrel exports for clean imports

**Build verification**: Type-checks clean, no platform modifications.

### 5. Discovered Pre-Existing wt-09 Test Failure

**Investigation**: The `wt-09-tea-room.transcript` was claimed to pass in the previous session (212 pass / 6 skip). Actual testing reveals **8 failures** in wt-09, all occurring after `$teleport carousel machine room`.

**Failure pattern**:
```
> $teleport carousel machine room
[OK]
> tell robot to push button
[FAIL] Expected output to match: /starting to move/i
       Actual output: You can't see any such thing.
```

**Verification**: Confirmed this failure exists at commit `71cc739` (before any current session changes). The previous session's "212 pass / 6 skip" claim was incorrect — the test likely wasn't run or was run differently.

**Actual results**:
- wt-01 through wt-08: Clean pass (168 tests pass, 6 skip)
- wt-09: 8 failures (scope resolution after $teleport)

**Root cause unknown**: The `$teleport` command may not be properly updating command scope, or "carousel machine room" alias disambiguation isn't working correctly in the testing extension. Requires investigation but is a **separate issue from combat implementation**.

## Key Decisions

### 1. Combat System is Story-Level Only

**Decision**: Implement entire thief/troll combat system as story-specific code in `stories/dungeo/src/combat/`. Zero platform changes needed.

**Rationale**: Combat with strength scaling, wound tracking, and villain AI is unique to Dungeo. Stdlib attacking action will be intercepted via action interceptor pattern (already exists). No need to add combat mechanics to stdlib or world-model.

**Impact**: Clean separation of concerns. Future games can implement different combat systems without platform baggage.

### 2. SCORE-MAX = 616 for Strength Scaling

**Decision**: Use 616 as maximum score for FIGHT-STRENGTH calculation (not 669 which includes thief death bonus).

**Rationale**: MDL source shows FIGHT-STRENGTH function scales 2→7 based on score 0→616. The 669 score is post-thief-death, but the thief fight happens before that bonus. Using 616 ensures hero strength caps at 7 (same as villain max normal strength).

**Impact**: Accurate canonical behavior. Hero starts weak (strength 2) and grows stronger as treasures are collected.

### 3. Villain Instant Heal on Disengagement

**Decision**: Villains (thief/troll) heal all wounds instantly when combat ends (player leaves, villain flees). Player wounds persist and heal slowly (30 turns per wound point).

**Rationale**: Direct from MDL source. Creates strategic tension — you can't "wear down" the thief over multiple encounters. Each fight must be winnable in one session.

**Impact**: Forces player to prepare for combat (get strong enough before engaging). Encourages fleeing if losing (come back stronger later).

### 4. SeededRandom Throughout Melee Engine

**Decision**: Pass `SeededRandom` instance to all melee functions for combat resolution.

**Rationale**: Enables future `$seed N` transcript testing for deterministic combat outcomes. Critical for testing since combat is inherently probabilistic.

**Impact**: All combat transcripts will be able to use `$seed` to get reproducible results. Makes testing thief AI and wound states tractable.

## Open Items

### Short Term

**wt-09 Failure Investigation**: The `$teleport carousel machine room` → `tell robot to push button` scope issue needs root cause analysis. This is a **separate bug** unrelated to combat work. Possible causes:
- Testing extension `$teleport` not updating command resolution scope
- Room disambiguation for "carousel machine room" alias not working
- NPC scope after teleport not matching normal scope

**Combat Implementation**: Continue with Phases 2-7 of thief-fight-plan.md:
- Phase 2: Melee messages (9 outcome types × 2 perspectives)
- Phase 3: Attacking action interceptor
- Phase 4: Combat disengagement + CURE-CLOCK daemon
- Phase 5: Thief behavior (WINNING? AI, wandering, pursuit)
- Phase 6: DIAGNOSE command
- Phase 7: Troll integration

**Build Completion**: The build was interrupted mid-session. Need to run `./build.sh -s dungeo` to complete compilation.

### Long Term

**Walkthrough Coverage**: After thief combat is complete, create walkthroughs for:
- Royal Puzzle region (maze, sceptre, ghost, scarab)
- Mirror pole toggle puzzle
- Key puzzle (brass lantern)
- Thief encounters and combat
- Scoring mechanics (trophy case)

**Combat Testing**: Create unit transcripts for:
- Strength calculation edge cases
- Each of 9 outcome types
- Wound accumulation and healing
- Best weapon bonuses
- Villain AI flee conditions
- Disengagement mechanics

## Files Created

**Combat system** (3 files, ~600 lines):
- `stories/dungeo/src/combat/melee-tables.ts` — Six canonical MDL result tables
- `stories/dungeo/src/combat/melee.ts` — Full melee engine (strength, blow resolution, wounds, healing, diagnosis)
- `stories/dungeo/src/combat/index.ts` — Barrel exports

**Documentation** (1 file):
- `docs/work/dungeo/thief-fight-plan.md` — Comprehensive 7-phase combat implementation plan

## Files Modified

**Build system**:
- `version.ts` — Version bump from build script (routine)

## Architectural Notes

### Canonical MDL Combat Mechanics

The MDL melee system is remarkably sophisticated for 1982:

**Strength-Based Probability**: Combat outcomes aren't deterministic — they use probability tables (DEF1/DEF2/DEF3) selected by strength differential. Even a strong hero can lose to the thief with bad rolls. This creates genuine tension.

**Asymmetric Healing**: The instant villain heal on disengagement is a brilliant design choice. It prevents "hit and run" tactics and forces commitment. Player must win in one encounter or start over.

**Progressive Difficulty**: Hero strength scales with score (treasure collection). Early thief encounters are nearly impossible (strength 2 vs 5). Late game with most treasures, hero is formidable (strength 6-7 vs 5). This naturally gates combat behind exploration.

**Weapon Effectiveness**: The "best weapon" system is subtle — only +1 strength bonus for correct weapon (sword vs troll, knife vs thief). Not game-breaking, but meaningful. Wrong weapon is still viable with high score.

**Wound Granularity**: Three wound types (light/serious/fatal) with different recovery times creates strategic depth. Multiple light wounds can be as dangerous as one serious wound. The 30-turn healing rate means wounds matter across multiple game sessions.

**Thief AI**: The WINNING? function (flee if >3 light wounds OR any serious wound) gives the thief human-like behavior. He's opportunistic but not suicidal. Creates emergent narrative — thief flees wounded, comes back later healed, escalating the rivalry.

### Serialization Pattern

This session reinforced a critical pattern discovered in Phase 5: **Never use `(entity as any).prop` for state that must survive save/restore**. Custom entity properties must go in `entity.attributes.*` to be serialized.

This is now a documented pitfall in MEMORY.md but bears repeating: The platform's JSON serialization only captures `attributes`, traits, and standard IFEntity fields. Bare runtime properties are invisible to serialization.

### Testing Extension Scope Model

The wt-09 failure reveals a potential gap in the testing extension's scope model after `$teleport`. When the player is teleported, command resolution scope may not be updating correctly. This warrants investigation of:

1. How `$teleport` updates player location
2. How command resolution builds entity scope
3. Whether NPC scope (for `tell robot`) is location-dependent

The fact that this worked in standalone cage-puzzle.transcript but fails in chain mode suggests the issue may be related to state deserialization, not $teleport itself.

## Notes

**Session duration**: ~2.5 hours

**Approach**: Research-driven implementation. Spent significant time reading MDL source to ensure canonical accuracy before writing any code. The result is a melee engine that should behave identically to 1982 Zork I combat.

**Next session should start with**: Run `./build.sh -s dungeo` to complete build, then investigate wt-09 failure OR continue with Phase 2 of combat implementation (melee messages).

---

**Progressive update**: Session completed 2026-02-07 08:30 CST
