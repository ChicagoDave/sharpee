# Session Summary: 2026-02-15 - main (CST)

## Status: Completed

## Goals
- Debug and fix wt-06 exorcism transcript failures (spirits still blocking exit after ritual)
- Comprehensive audit of `(entity as any).prop` serialization bugs across entire dungeo story
- Rewrite wt-07 river & rainbow walkthrough to remove all $teleport and $take meta-commands

## Completed

### 1. Exorcism Handler Serialization Bug (Root Cause of wt-06 Failures)

**Problem**: After performing the bell/book/candle ritual in wt-06, spirits still blocked the east exit to Land of the Dead. The `dungeo.exorcism.spirits_block` message appeared instead of allowing passage.

**Root Cause Discovery**:
- The exorcism items (bell, book, candles) had `exorcismRole` set via `(entity as any).exorcismRole = 'bell'`
- This is a direct property on the entity object that does NOT survive serialization
- After save/restore in chain tests, `ring-action.ts` checked `(target as any).exorcismRole === 'bell'` which returned `undefined`
- The action emitted `RingMessages.RING_SUCCESS` instead of `RingMessages.RING_BELL`
- The exorcism handler (listening for `dungeo.ring.bell`) never triggered
- Result: `BELL_RUNG_KEY` was never set to true and the ritual never completed

**Fix**:
- Changed all `(entity as any).prop` to `entity.attributes.prop` for exorcism items
- Updated temple.ts, exorcism-handler.ts, and ring-action.ts
- Now `exorcismRole`, `isExorcismItem`, and `customId` properties survive serialization

**Files**:
- `stories/dungeo/src/regions/temple.ts`
- `stories/dungeo/src/handlers/exorcism-handler.ts`
- `stories/dungeo/src/actions/ring/ring-action.ts`

### 2. Comprehensive `(entity as any)` Audit and Fix

After fixing the exorcism bug, performed a full audit of ALL `(entity as any).prop = value` patterns across the entire dungeo story codebase. Found approximately 50 instances across 15+ files where entity properties were set directly on the object instead of through `.attributes`.

**Files Fixed (Setter Side — changed to `entity.attributes.prop`)**:

| File | Properties Fixed |
|------|------------------|
| `regions/temple.ts` | exorcismRole, isExorcismItem (x3), customId, isRitualBasin |
| `objects/thiefs-canvas-objects.ts` | isEmptyFrame, isBreakable, backDescription |
| `regions/dam.ts` | isPointy, puncturesBoat, isSceptre, isWaterBody |
| `regions/frigid-river.ts` | isWaterBody, displayName |
| `regions/endgame.ts` | 20 properties (poles, panels, buttons, beam, treasury, etc.) |
| `regions/maze.ts` | unlocksId |
| `regions/coal-mine.ts` | repelledBy |
| `regions/bank-of-zork.ts` | isPassable |
| `regions/well-room.ts` | readText |
| `actions/turn-bolt/turn-bolt-action.ts` | revealed (x2) |
| `scheduler/maintenance-room-fuse.ts` | isHidden |

**Files Fixed (Reader Side — changed to `entity.attributes?.prop`)**:

| File | Properties Fixed |
|------|------------------|
| `handlers/exorcism-handler.ts` | exorcismRole (x3) |
| `actions/ring/ring-action.ts` | exorcismRole |
| `actions/break/break-action.ts` | isBreakable, isEmptyFrame |
| `actions/wave/wave-action.ts` | isSceptre |
| `actions/lift/lift-action.ts` | poleType |
| `actions/lower/lower-action.ts` | poleType |
| `actions/push-panel/push-panel-action.ts` | isPanel, panelType |
| `interceptors/inflatable-entering-interceptor.ts` | puncturesBoat, isPointy |

**Intentionally NOT Changed**:
- Trait file comments documenting old anti-patterns
- `(troll as any).on` — dead code (.on handlers never fire)
- `(openable as any).isOpen` — trait property mutation (survives serialization)
- `(npcTrait as any).customProperties` — NPC trait mutation
- `(context.sharedData as any)` — runtime-only, no serialization
- GDT debugging commands — introspection tool

### 3. wt-07 River & Rainbow Walkthrough Rewrite

Completely rewrote the wt-07 transcript to replace all `$teleport` and `$take` meta-commands with real game navigation and mechanics, matching the pattern of wt-01 through wt-06.

**Old Approach**:
- Used 6 `$teleport` commands
- Used 3 `$take` commands
- Used `$restore`/`$save` for state management
- Skipped boat mechanics entirely

**New Approach**: Full walking navigation with boat mechanics

**Navigation Plan**:
1. **Prepare**: Drop lantern + exorcism items, take pump from Living Room floor
2. **Walk to Small Cave for shovel**: Living Room → Cellar → Troll Room → E-W Passage → Deep Ravine → Chasm → N/S Passage → Loud Room → Ancient Chasm → Small Cave
3. **Walk to Dam Base**: Small Cave → Ancient Chasm → Loud Room → Damp Cave → Dam → Dam Base
4. **Boat prep**: Inflate boat, board WITHOUT stick (avoids puncture interceptor), take stick from inside boat, launch
5. **Ride river**: FR-1 → FR-2 (take buoy, open, take emerald, drop buoy) → FR-3 → FR-4
6. **Land at Sandy Beach** (FR-4 WEST), exit boat, dig x4 for statue
7. **Walk to Aragain Falls** (Sandy Beach → Shore → Falls), wave stick for rainbow
8. **Cross rainbow** east x2, take pot of gold at End of Rainbow
9. **Return via forest**: Canyon Bottom → Rocky Ledge → Canyon View → Forest → Forest → South of House → Behind House → Kitchen → Living Room
10. **Store treasures**: emerald, statue, pot of gold in trophy case

**Key Design Decisions**:
- **Board boat first, THEN take stick from inside** — bypasses the `inflatable-entering-interceptor` puncture check
- **Get shovel via Ancient Chasm** (E of Loud Room), not via Rocky Shore — avoids needing to re-launch boat later
- **Drop pump at Dam Base, drop shovel at Sandy Beach** — manage carry weight
- **Return via forest path** from Canyon Bottom, avoiding river reversal complexity

**File**:
- `stories/dungeo/walkthroughs/wt-07-river-rainbow.transcript`

## Key Decisions

### 1. Entity Properties Must Use `.attributes` for Serialization
**Decision**: Always use `entity.attributes.customProp` for story-specific entity properties, never `(entity as any).customProp`.

**Rationale**:
- Direct entity properties do NOT survive `world.saveJSON()` / `world.loadJSON()` cycles
- The `.attributes` object is explicitly serialized and restored
- Chain tests use save/restore between transcripts, so serialization bugs are common
- This bug pattern caused wt-06 failures and likely affects other puzzles

**Pattern**:
```typescript
// WRONG - Lost after serialization
(bell as any).exorcismRole = 'bell';
if ((target as any).exorcismRole === 'bell') { /* ... */ }

// CORRECT - Survives serialization
bell.attributes.exorcismRole = 'bell';
if (target.attributes?.exorcismRole === 'bell') { /* ... */ }
```

### 2. Boat Boarding Order Matters
**Decision**: Board the inflatable boat BEFORE taking the stick, even though stick is already inside boat.

**Rationale**:
- The `inflatable-entering-interceptor` checks if player is carrying any "pointy" items (`attributes.isPointy`)
- If you take the stick first, then try to board, the interceptor blocks entry and punctures the boat
- By boarding first, player enters boat without carrying any pointy items
- Then take the stick from inside the boat (no puncture check)
- This matches the original Zork puzzle design

### 3. Route Optimization: Ancient Chasm vs Rocky Shore
**Decision**: Get shovel from Small Cave (via Ancient Chasm) before going to Dam, not from Rocky Shore after landing.

**Rationale**:
- Rocky Shore is on the river, but you can't reverse direction on the river
- If you skip the shovel and land at Sandy Beach, you'd need to walk all the way back to Small Cave
- Getting shovel first means you have it when you need it at Sandy Beach
- Eliminates need for backtracking or boat re-launches

## Open Items

### Short Term
- **Build and Test**: Rebuild platform + story and run full walkthrough chain (wt-01 through wt-07)
- **Verify exorcism fix**: Confirm spirits no longer block after ritual completes
- **Test boat mechanics**: Verify inflatable-entering-interceptor works correctly with board-then-take-stick pattern
- **wt-08 through wt-13**: Still need `$teleport` removal from remaining walkthroughs

### Long Term
- Consider adding linter rule to detect `(entity as any).customProp =` patterns (prevent future serialization bugs)
- Document the boat boarding pattern in CLAUDE.md or ADR

## Files Modified

**Story Code** (15 files):
- `stories/dungeo/src/regions/temple.ts` — exorcismRole, isExorcismItem, customId, isRitualBasin
- `stories/dungeo/src/regions/dam.ts` — isPointy, puncturesBoat, isSceptre, isWaterBody
- `stories/dungeo/src/regions/frigid-river.ts` — isWaterBody, displayName
- `stories/dungeo/src/regions/endgame.ts` — 20 properties (poles, panels, buttons, beam, treasury)
- `stories/dungeo/src/regions/maze.ts` — unlocksId
- `stories/dungeo/src/regions/coal-mine.ts` — repelledBy
- `stories/dungeo/src/regions/bank-of-zork.ts` — isPassable
- `stories/dungeo/src/regions/well-room.ts` — readText
- `stories/dungeo/src/objects/thiefs-canvas-objects.ts` — isEmptyFrame, isBreakable, backDescription
- `stories/dungeo/src/handlers/exorcism-handler.ts` — exorcismRole reads
- `stories/dungeo/src/actions/ring/ring-action.ts` — exorcismRole reads
- `stories/dungeo/src/actions/break/break-action.ts` — isBreakable, isEmptyFrame reads
- `stories/dungeo/src/actions/wave/wave-action.ts` — isSceptre read
- `stories/dungeo/src/actions/lift/lift-action.ts` — poleType read
- `stories/dungeo/src/actions/lower/lower-action.ts` — poleType read
- `stories/dungeo/src/actions/push-panel/push-panel-action.ts` — isPanel, panelType reads
- `stories/dungeo/src/actions/turn-bolt/turn-bolt-action.ts` — revealed writes
- `stories/dungeo/src/scheduler/maintenance-room-fuse.ts` — isHidden write
- `stories/dungeo/src/interceptors/inflatable-entering-interceptor.ts` — puncturesBoat, isPointy reads

**Walkthrough Transcripts** (1 file):
- `stories/dungeo/walkthroughs/wt-07-river-rainbow.transcript` — Complete rewrite with real navigation

## Architectural Notes

### Entity Property Serialization Patterns

The WorldModel serialization system has specific rules for what survives save/restore:

**Survives Serialization**:
- `entity.id`, `entity.name`, `entity.entityType`
- `entity.traits` (all trait objects)
- `entity.attributes` (custom properties object)
- Trait properties like `openable.isOpen`, `lockable.isLocked`

**Does NOT Survive Serialization**:
- Direct properties set via `(entity as any).customProp = value`
- Class methods on traits (traits become plain objects after `loadJSON()`)
- Event handlers in `entity.on` (these never fire anyway — dead code)

**Best Practices**:
1. Always use `entity.attributes.customProp` for story-specific properties
2. Never rely on direct entity properties for state that matters across turns
3. Use optional chaining for reads: `entity.attributes?.customProp`
4. Consider creating custom traits for complex entity behaviors (better than ad-hoc attributes)

### Interceptor Order and Entry Conditions

The `inflatable-entering-interceptor` demonstrates an important puzzle pattern:
- Interceptors can check both **entering entity** and **items being carried**
- Order matters: check conditions BEFORE allowing entry
- Once inside, different rules apply (can take items that would have blocked entry)

This creates the classic "can't board boat with pointy stick" puzzle:
1. Take stick → Try to board → Blocked (punctures boat)
2. Board boat → Take stick from inside → Allowed (already aboard)

The pattern generalizes to other entry restrictions (can't enter with torch lit, can't enter while wearing armor, etc.)

## Notes

**Session duration**: ~1.5 hours

**Approach**: Diagnostic debugging (found exorcism root cause), systematic audit (found ~50 similar bugs), complete rewrite (wt-07 now follows best practices). Each phase built on discoveries from the previous.

**Testing Status**: Changes made but not yet validated with full build + chain test. Next session should start with build and verification of both the exorcism fix and the boat mechanics.

**Scope**: This was the most comprehensive serialization audit of the dungeo story to date. The `(entity as any)` pattern was pervasive, and likely caused subtle bugs in other puzzles. This fix should improve overall stability of chain tests.

---

**Progressive update**: Session completed 2026-02-15 04:00 CST
