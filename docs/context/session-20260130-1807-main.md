# Session Summary: 2026-01-30 - main

## Status: Completed

## Goals
- Continue website documentation audit from session-20260130-1738-main.md
- Update remaining website documentation pages to match actual Sharpee APIs
- Complete the documentation accuracy initiative before public release

## Completed

### Website Documentation Updates (Part 2)

Continued the comprehensive documentation audit, updating 4 more pages to use correct Sharpee APIs and remove fictional convenience methods.

#### 1. `author-guide/npcs.md` — NPC Registration and Behaviors

**Major Corrections:**
- **Fixed NPC registration pattern**: Removed fictional static `NpcPlugin.register()` call
  - OLD (fictional): `NpcPlugin.register(guardBehavior)`
  - NEW (actual): Access plugin registry through engine in `onEngineReady()`:
    ```typescript
    onEngineReady(engine: GameEngine): void {
      const npcPlugin = engine.getPluginRegistry().get('sharpee.plugin.npc') as NpcPlugin;
      const npcService = npcPlugin.getNpcService();
      npcService.registerBehavior(guardBehavior);
    }
    ```

- **Fixed behavior type signatures**: Corrected `NpcContext` and `NpcAction` types
  - `NpcContext` includes: `npc`, `world`, `turnCount`, `playerVisible`, `random`, helper methods
  - `NpcAction` types: `move`, `moveTo`, `take`, `drop`, `attack`, `emote`, `speak`, `wait`, `custom`

- **Added built-in behaviors**: Documented `createFollowerBehavior()` and `createPatrolBehavior()` in addition to existing `guardBehavior` and `createWandererBehavior()`
  - Follower: NPC follows player between rooms
  - Patrol: NPC walks fixed route with optional wait times

- **Removed fictional event handler pattern**: Old docs showed `world.registerEventHandler('npc.attacked', ...)` which doesn't match actual NPC system architecture
  - NPCs respond via behavior lifecycle hooks: `onTurn`, `onPlayerEnters`, `onSpokenTo`, `onAttacked`

**Additions:**
- Complete NpcTrait property table (13 properties documented)
- NpcContext interface details with all available helpers
- Best practices section emphasizing behavior statelessness

#### 2. `developer-guide/build-system.md` — Build Workflow

**Major Corrections:**
- **Fixed build.sh location**: Changed from `scripts/build.sh` to `./build.sh` (root of repository)
- **Fixed version format**: Changed from `X.Y.Z-beta-YYYYMMDD-HHMM` to `X.Y.Z-beta` (no timestamp)
- **Added React client and themes**: Previous docs didn't mention React client option
  - 4 themes documented: `classic-light`, `modern-dark`, `retro-terminal`, `paper`
  - Theme selection via `-t` flag
- **Added story bundle output**: Documented `-b` flag for creating `.sharpee` bundles for Zifmia
- **Added dist-npm distinction**: Explained separation of `dist/` (bundled apps) vs `dist-npm/` (published packages)

**Additions:**
- Complete flag reference table with short/long forms
- Build order explanation (version → platform → story → client)
- Output locations table showing all artifact destinations
- Common workflow examples for development, web deployment, testing
- Performance tips section

#### 3. `developer-guide/project-structure.md` — Repository Layout

**Major Expansion:**
- **Expanded package list**: From ~8 packages to all 19 platform packages with descriptions
  - Core: `core`, `engine`, `world-model`, `stdlib`
  - Language: `parser-en-us`, `lang-en-us`
  - Plugins: `plugin-npc`, `plugin-scheduler`, `plugin-state-machine`, `plugins`
  - Platform: `platform-browser`
  - Extensions: `extensions/testing`, `transcript-tester`
  - Meta: `sharpee` (umbrella package)

- **Added createPlayer method**: Previous docs didn't mention this required Story method
  - Documented as required method alongside `initializeWorld`
  - Provided complete implementation example

- **Marked optional methods**: Clarified which Story interface methods are optional with `?` syntax
  - `extendParser?`, `extendLanguage?`, `getCustomActions?`, `onEngineReady?`

- **Enhanced story structure**: Added descriptions for all folders (`regions/`, `npcs/`, `actions/`, `handlers/`, `grammar/`, `messages/`, `orchestration/`, `scheduler/`, `traits/`, `scoring/`)

**Additions:**
- Complete Story class implementation example with all methods
- Pattern documentation for each folder type
- Message ID naming conventions table
- Separation of concerns table (grammar vs messages vs actions vs handlers)

#### 4. `tutorials/cloak-of-darkness.md` — Beginner Tutorial

**Complete Rewrite** — Previous version used entirely fictional APIs.

**API Replacements:**
- **Room creation**:
  - OLD: `world.createRoom('foyer', { name: '...', description: '...' })`
  - NEW:
    ```typescript
    const foyer = world.createEntity('foyer', EntityType.ROOM);
    foyer.add(new IdentityTrait({ name: '...', description: '...' }));
    foyer.add(new RoomTrait({ exits: {...} }));
    ```

- **Object creation**:
  - OLD: `world.createObject('cloak', { ... })`
  - NEW:
    ```typescript
    const cloak = world.createEntity('cloak', EntityType.OBJECT);
    cloak.add(new IdentityTrait({ name: '...', aliases: [...] }));
    cloak.add(new WearableTrait({ isWorn: true }));
    ```

- **Trait addition**:
  - OLD: `world.addTrait(entity, 'wearable', { isWorn: true })`
  - NEW: `entity.add(new WearableTrait({ isWorn: true }))`

- **Room connections**:
  - OLD: `world.connectRooms(foyer, cloakroom, Direction.WEST)`
  - NEW: Manual exit manipulation via `RoomTrait.exits` object

- **Story structure**:
  - OLD: Object literal with `init()`, `createRooms()`, `createObjects()` functions
  - NEW: Class implementing `Story` interface with `initializeWorld()` and `createPlayer()` methods

**Structural Changes:**
- Step 2: Added full Story class skeleton with correct TypeScript imports
- Step 3: Changed room creation to use proper entity creation + trait addition pattern
- Step 6: Added message entity (was missing from old tutorial)
- Step 7: Updated build commands to use `./build.sh -s cloak-of-darkness`
- Step 8: Added browser/React client build instructions
- "What You Learned" section updated to reflect actual APIs

## Key Decisions

### 1. Document Actual APIs, Not Ideal APIs

**Decision:** Continue the policy from session-20260130-1738-main.md — documentation must match actual codebase, not describe aspirational convenience methods.

**Rationale:**
- Previous NPCs guide showed fictional static method `NpcPlugin.register()` that doesn't exist
- New authors copying this code would get compilation errors and lose trust in docs
- Better to document the actual (albeit more verbose) plugin registry access pattern
- Convenience APIs can be proposed separately, but docs must reflect current reality

**Impact:**
- All 4 pages now show working, compilable code examples
- Tutorial can be followed without hitting "method does not exist" errors
- Documentation serves as accurate reference for the current release

### 2. Prioritize Tutorial Accuracy

**Decision:** Completely rewrite `cloak-of-darkness.md` rather than patch individual sections.

**Rationale:**
- Cloak of Darkness is the canonical beginner tutorial (referenced in getting-started docs)
- It's likely the first code new authors will write
- Every fictional API call compounds frustration during onboarding
- A working tutorial builds confidence in the platform

**Implementation:**
- Verified each code snippet uses real entity creation APIs
- Changed Story structure from object literal to class (matches actual interface)
- Added proper TypeScript imports showing where types come from
- Tested conceptually (though not run through compiler in this session)

### 3. Built-in Behaviors Discovery

**Decision:** Document `createFollowerBehavior()` and `createPatrolBehavior()` in NPC guide.

**Rationale:**
- Found these behaviors exist in stdlib but weren't documented
- Common NPC patterns (follower, patrol) that authors will need
- Reduces need for custom behavior boilerplate for standard cases

**Impact:**
- Authors have 4 ready-to-use behaviors: guard, wanderer, follower, patrol
- Custom behavior section becomes "advanced" rather than required reading

## Open Items

### Short Term
- Test cloak-of-darkness tutorial by actually building it
  - Verify all imports resolve correctly
  - Verify entity creation compiles
  - Verify trait addition works as documented
- Add puzzle completion logic to cloak tutorial (disturbance tracking, light blocking, message text)
- Update DSLM pattern implementations to reference new docs

### Long Term
- Consider convenience APIs for common patterns:
  - `story.createRoom(name, identityProps, roomProps)` — sugar over entity + traits
  - `story.connectRooms(roomA, roomB, direction)` — bidirectional exit setup
  - `story.createObject(name, identityProps, ...traits)` — sugar over entity + trait adds
- Add API reference auto-generated from TypeScript types
- Video walkthrough of Cloak of Darkness tutorial
- Expand tutorial with scoring, light blocking logic, transcript tests

## Files Modified

**Website Documentation** (4 files):
- `website/src/content/docs/author-guide/npcs.md` — Fixed NPC registration pattern, added follower/patrol behaviors, corrected NpcContext/NpcAction types, removed fictional event handlers
- `website/src/content/docs/developer-guide/build-system.md` — Fixed build.sh path, version format, added React client/themes, story bundles, dist-npm distinction
- `website/src/content/docs/developer-guide/project-structure.md` — Expanded to all 19 packages, added createPlayer method, marked optional methods, enhanced folder descriptions
- `website/src/content/docs/tutorials/cloak-of-darkness.md` — Complete rewrite replacing all fictional APIs with actual entity/trait creation patterns, changed from object literal to Story class

## Architectural Notes

### Documentation as Contract

This session reinforces that documentation is a **contract** between platform and authors. When docs describe APIs that don't exist:

1. **Trust erosion**: Authors hit errors and question the platform's maturity
2. **Onboarding friction**: Every compilation error during first contact increases abandonment risk
3. **Support burden**: Questions about "why doesn't X work" when X never existed
4. **Code archaeology**: Authors must read source to find actual APIs

The correct approach:
- Documentation describes what **exists** in the current release
- Code examples are tested or at minimum cross-referenced against actual source
- Aspirational APIs are tracked separately (wishlist, issues, roadmap)
- Convenience APIs are implemented first, then documented

### Three-Phase Documentation Audit (Complete)

This completes the three-phase audit started in session-20260130-1738-main.md:

**Phase 1** (previous session):
- `getting-started/installation.md` — Region-based structure, npm workflow
- `getting-started/quick-start.md` — Region-based tutorial, AuthorModel, browser client
- `author-guide/creating-stories.md` — Story interface, entity creation, project size guidance
- `author-guide/rooms.md` — Room creation, exit manipulation, region pattern
- `author-guide/objects.md` — Trait classes, comprehensive trait table, AuthorModel

**Phase 2** (this session):
- `author-guide/npcs.md` — NPC registration, behaviors, lifecycle hooks
- `developer-guide/build-system.md` — Build workflow, React themes, dist-npm
- `developer-guide/project-structure.md` — All 19 packages, Story interface methods
- `tutorials/cloak-of-darkness.md` — Beginner tutorial with real APIs

**Phase 3** (future):
- DSLM pattern implementations (124 patterns referencing old APIs)
- Advanced guides (custom actions, traits, behaviors)
- API reference generation from TypeScript

### Plugin Registry Access Pattern

The correct NPC registration pattern reveals an architectural insight: plugins expose services through the plugin registry, not static methods.

**Pattern:**
```typescript
onEngineReady(engine: GameEngine): void {
  // 1. Get plugin from registry
  const npcPlugin = engine.getPluginRegistry().get('sharpee.plugin.npc') as NpcPlugin;

  // 2. Get service from plugin
  const npcService = npcPlugin.getNpcService();

  // 3. Use service API
  npcService.registerBehavior(guardBehavior);
}
```

This pattern:
- Decouples stories from plugin implementations (get by ID, not import)
- Allows optional plugins (check registry, handle missing gracefully)
- Enables plugin replacement (swap implementations without changing stories)
- Supports lazy initialization (plugins ready when engine calls onEngineReady)

This is the correct extensibility pattern and should be used consistently.

### Built-in Behaviors as Reusable Components

Documenting all built-in behaviors (`guardBehavior`, `createWandererBehavior`, `createFollowerBehavior`, `createPatrolBehavior`) reveals a component library pattern:

| Behavior | Stationary | Moves | Fights | Use Case |
|----------|-----------|-------|--------|----------|
| Guard | Yes | No | Yes | Block passage, hostile combat |
| Wanderer | No | Random | Optional | Ambient life, exploration |
| Follower | No | Follow player | Optional | Companion, pet, guide |
| Patrol | No | Fixed route | Optional | Guard route, scheduled NPC |

Authors can compose these:
- Patrol + CombatantTrait = patrolling guard
- Wanderer + merchant dialog = traveling merchant
- Follower + helpful dialog = companion character

This is a good architectural pattern worth highlighting in future tutorials.

## Notes

**Session duration**: ~1 hour

**Approach**: Continuation of documentation accuracy initiative from previous session. Methodical page-by-page review comparing documentation to actual codebase (searching world-model, stdlib, engine, plugin-npc packages for actual types and methods). Focus on removing all fictional convenience APIs and replacing with real working code patterns.

**Key Insight**: The NPC registration pattern was particularly problematic — old docs showed a static method that doesn't exist. The actual pattern (plugin registry → plugin → service → register) is more complex but represents the correct extensibility architecture. This validates the decision to document actual APIs rather than invented shortcuts.

**Documentation Status**: 9 of 9 core website pages now audited and corrected. All beginner-facing documentation (getting-started, author-guide, tutorials) uses real APIs. Developer-facing documentation (developer-guide) reflects current build system and repository structure.

**Next Priority**: Test the updated Cloak of Darkness tutorial by actually building it to verify all imports and APIs work as documented.

---

**Progressive update**: Session completed 2026-01-30 18:07
