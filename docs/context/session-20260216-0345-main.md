# Session Summary: 2026-02-16 - main (CST 3:45 AM)

## Status: Completed

## Goals
- Apply the adjective fix identified in the previous session (braided wire / shiny wire disambiguation)
- Debug why `tie braided wire to hook` still fails with ENTITY_NOT_FOUND after applying the fix

## Completed

### 1. Wire Adjective Disambiguation Fix
- **Applied**: Added `adjectives: ['braided']` to braided wire in `volcano.ts:576`
- **Applied**: Added `adjectives: ['shiny']` to shiny wire in `house-interior.ts:403`
- **Verified**: Adjectives appear in compiled output (`dist/regions/volcano.js:451`)
- **Verified**: Adjectives survive serialization (checked wt-01.json, wt-12.json)
- **Confirmed**: Existing adjectives (cakes, buttons, spheres) all work correctly in saves
- **Result**: Wire disambiguation now works correctly

### 2. Build Order Fix (build.sh)
- **Discovered**: Bundle was being created BEFORE story compilation (platform → bundle → story)
- **Fixed**: Corrected order to platform → story → bundle (swapped lines 801 and 803-805)
- **Rationale**: While the bundle loads story code dynamically via `require()` at runtime (so build order doesn't affect story code inclusion), the correct conceptual order is still story-before-bundle

### 3. Root Cause Analysis - Hook Scope Problem
Previous session's analysis was PARTIALLY correct:
- ✅ Wire disambiguation WAS broken (now fixed)
- ❌ ENTITY_NOT_FOUND is actually about the **hook**, not the wire

**Hook Configuration**:
- hook1 (y0u) in Narrow Ledge with `minimumScope(3, [r2o])`
- hook2 (y0v) in Wide Ledge with `minimumScope(3, [r2m])`
- Both have identical names ("hook"), same aliases, NO adjectives
- Balloon daemon shows "You can see a hook" as flavor text
- Balloon IS physically moved to correct room by `moveVehicle()` (vair2 → volcanoNearSmallLedge r2o)
- Scope resolver's `getContainingRoom()` should traverse player → balloon → room
- Hook1's minimumScope should make it REACHABLE — but something prevents resolution

**Evidence**:
- Balloon position changes correctly (daemon logs show vair2 move)
- Hook flavor text appears in room description
- Command validator still returns ENTITY_NOT_FOUND for "hook"

### 4. Debugging Infrastructure Work
- **Created**: `wt-13a-volcano-balloon-setup.transcript` (split from wt-13)
- **Purpose**: Runs everything up to `tie braided wire to hook`, saves as wt-13a
- **Enables**: `--play --restore wt-13a` for interactive debugging
- **Discovered**: CLI --play mode lacks GDT/TRACE support (only works in --test mode)
- **Gap**: Interactive REPL in bundle-entry.js doesn't route GDT commands through testing extension

## Key Decisions

### 1. Wire Disambiguation Fix is Correct but Insufficient
The adjective fix works correctly — adjectives survive creation, serialization, and restoration. However, it only solves half the problem. The hook entity also needs to be resolvable by the command validator when the player is in the balloon at the appropriate position.

### 2. Build Order Fix was Cosmetic for This Issue
The bundle loads story code dynamically via `require()`, so bundle build order doesn't affect story code inclusion. However, fixing the order (story before bundle) is still correct for conceptual clarity and potential future issues.

### 3. Need Interactive Debugging Capability
The lack of GDT/TRACE in --play mode is a significant gap for debugging scope resolution issues. Either need to wire it up or create diagnostic scripts.

## Open Items

### Short Term
- **CRITICAL**: Debug hook scope resolution — why does command validator return ENTITY_NOT_FOUND for "hook" when player is in balloon at vair2?
  - Hook1's minimumScope(3, [r2o]) should make it reachable
  - Balloon daemon correctly moves balloon to r2o
  - Need to trace scope resolution logic
- **BUG**: `exit` command goes to wrong room ("Volcano Near Small Ledge" instead of "Narrow Ledge")
- Consider creating diagnostic script if GDT wiring is too complex

### Long Term
- Wire GDT/TRACE commands into CLI --play mode for interactive debugging
- Consider if command validator should be more lenient with name-embedded modifiers
- Review minimumScope implementation for vehicle scenarios

## Files Modified

**Story - Entities** (2 files):
- `stories/dungeo/src/regions/volcano.ts` - Added `adjectives: ['braided']` to braided wire (line 576)
- `stories/dungeo/src/regions/house-interior.ts` - Added `adjectives: ['shiny']` to shiny wire (line 403)

**Build** (1 file):
- `build.sh` - Fixed build order: platform → story → bundle (was platform → bundle → story)

**Testing** (1 file):
- `stories/dungeo/walkthroughs/wt-13a-volcano-balloon-setup.transcript` - NEW, split from wt-13 for debugging

## Files Examined (Not Modified)

**Platform - Scope & Validation**:
- `packages/stdlib/src/scope/scope-resolver.ts` - getScope, getContainingRoom, minimumScope
- `packages/stdlib/src/validation/command-validator.ts` - Entity resolution, disambiguation, adjective matching

**Platform - World Model**:
- `packages/world-model/src/traits/identity/identityTrait.ts` - Constructor, adjectives field
- `packages/world-model/src/entities/if-entity.ts` - toJSON/loadJSON serialization
- `packages/world-model/src/traits/vehicle/vehicleBehavior.ts` - moveVehicle

**Story - Balloon System**:
- `stories/dungeo/src/scheduler/balloon-daemon.ts` - Balloon movement, hook_visible, moveVehicle calls
- `stories/dungeo/src/handlers/balloon-handler.ts` - Balloon exit action, position mapping
- `stories/dungeo/src/grammar/liquid-grammar.ts` - tie/untie grammar patterns

**Testing Infrastructure**:
- `scripts/bundle-entry.js` - CLI entry point, story loading, interactive mode
- `packages/transcript-tester/src/runner.ts` - $save/$restore implementation
- `packages/extensions/testing/src/extension.ts` - GDT debug mode

**Logs**:
- `logs/test-13.log` - Test output showing ENTITY_NOT_FOUND
- `logs/dungeo-tests.log` - Full chain test results (644 pass, 46 fail in wt-13)

**Save Files** (for adjective verification):
- `stories/dungeo/saves/wt-01.json` through `wt-12.json`

## Architectural Notes

### Bundle vs Story Loading Architecture
The CLI bundle (`dist/cli/sharpee.js`) contains only platform packages. Story code is loaded at runtime via `require(stories/dungeo/dist/index.js)`. This means:
- Bundle build order doesn't affect story code content
- Story changes only need story recompilation, not rebundling (though rebuild.sh rebuilds both anyway)
- Save/restore uses WorldModel.toJSON()/loadJSON() which serializes traits as plain objects
- Adjectives are preserved through the serialization cycle

### Hook Scope Resolution Architecture
- Hooks use `setMinimumScope(distance, [roomId])` to be reachable from specific rooms
- Balloon daemon uses `moveVehicle()` to physically relocate balloon to position rooms (vair1-vair6)
- Position rooms (r2o, r2m) are the actual physical locations referenced by minimumScope
- Scope resolver traverses containment hierarchy (player → vehicle → room) via `getContainingRoom()`
- Both hooks are identical (name, aliases) — disambiguation relies on only one being in scope at a time
- **Gap**: Something in the scope resolution chain is preventing hook1 from being found when player is in balloon at vair2

### Debugging Infrastructure Gap
The testing extension provides GDT commands (TRACE, DEBUG, SCENE, etc.) that work in `--test` mode (transcript tester) but are not wired into `--play` mode (interactive REPL). This limits debugging capabilities for interactive sessions. The bundle-entry.js REPL would need to:
1. Detect GDT commands
2. Route them through the testing extension
3. Return results to the REPL output

## Notes

**Session duration**: ~2 hours

**Approach**: Methodical debugging — applied fix from previous session, verified serialization behavior, traced scope architecture, created debugging infrastructure. Identified that the real problem is hook scope resolution, not wire disambiguation.

**Next Session Priority**: Debug hook scope resolution with either GDT wiring or diagnostic script. The balloon is moving to the correct room (r2o), the hook has the correct minimumScope configuration (3, [r2o]), but the command validator still can't find it.

---

**Progressive update**: Session completed 2026-02-16 03:45 AM CST
