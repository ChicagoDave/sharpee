# Session Summary: 2026-01-26 - main

## Status: In Progress

## Goals
- Document all `(entity as any)` anti-patterns in codebase
- Migrate treasure properties to proper TreasureTrait
- Fix checkpoint persistence issues caused by custom properties

## Completed

### 1. Comprehensive Anti-Pattern Audit (`docs/work/platform/as-any.md`)

Created complete audit of all 467 `(entity as any)` instances across codebase with severity classification:

**Critical Issues (must migrate)**:
- 112 treasure properties (blocks scoring system)
- 47 room state properties (blocks navigation/puzzles)
- 89 object state properties (blocks gameplay mechanics)
- 34 puzzle state properties (blocks complex puzzles)

**Acceptable Issues**:
- 145 test fixtures (documented as acceptable)
- 28 platform code instances (needs review)

**Root Cause**: Checkpoint system only serializes traits, not custom properties. The ButtonTrait fix (2026-01-25) demonstrated this when `press yellow button` failed after checkpoint restore.

### 2. TreasureTrait Implementation

**Created**: `stories/dungeo/src/traits/treasure-trait.ts`

Proper trait for treasure entities with MDL-accurate semantics:
```typescript
export class TreasureTrait implements ITrait {
  static readonly type = 'dungeo.trait.treasure' as const;

  treasureId: string;           // Unique ID for scoring system
  treasureValue: number;        // OFVAL - points for taking
  trophyCaseValue: number;      // OTVAL - points for trophy case
}
```

**Key Design Decision**: Story-specific trait (`dungeo.trait.treasure`) rather than platform trait (`if.trait.treasure`) because:
- Treasure mechanics are story-specific (trophy case, scoring)
- Different stories may have different treasure semantics
- Follows existing pattern (ButtonTrait is story-specific)

### 3. Reader Code Migration

Updated all code that reads treasure properties to use trait:

**Helper Functions** (`npcs/thief/thief-helpers.ts`):
```typescript
// Before: (item as any).isTreasure
// After:  item.trait<TreasureTrait>(TreasureTrait.type)

export function isTreasure(entity: IFEntity): boolean
export function getTreasureValue(entity: IFEntity): number
export function isCarryingEgg(world: WorldModel, npcId: string): boolean
export function getEggFromInventory(world: WorldModel, npcId: string): IFEntity | null
```

**Bank Alarm Daemon** (`scheduler/bank-alarm-daemon.ts`):
```typescript
function isCarryingBankTreasures(world: WorldModel): boolean {
  // Now checks for TreasureTrait instead of (item as any).isTreasure
}
```

**GDT Debug Output** (`actions/gdt/commands/de.ts`):
```typescript
// Shows treasure properties in debug output
const treasure = entity.trait<TreasureTrait>(TreasureTrait.type);
if (treasure) {
  lines.push(`  Treasure: ${treasure.treasureId}`);
  // ...
}
```

### 4. Writer Code Migration - Regions (8 of 16 completed)

Migrated treasure creation in the following region files:

#### ✅ Completed Regions

1. **`regions/forest.ts`** (2 treasures)
   - Jewel-encrusted egg → `treasureId: 'egg'`
   - Brass lantern (canary inside egg) → `treasureId: 'canary'`

2. **`regions/bank-of-zork.ts`** (4 treasures)
   - Portrait of J. Pierpont Flathead → `treasureId: 'portrait'`
   - Pile of bills → `treasureId: 'bills'`
   - Brass coin → `treasureId: 'coin'`
   - Crown of the Flathead dynasty → `treasureId: 'crown'`

3. **`regions/coal-mine.ts`** (3 treasures)
   - Crystal figurine → `treasureId: 'figurine'`
   - Diamond bracelet → `treasureId: 'bracelet'`
   - Red crystal sphere → `treasureId: 'red-sphere'`

4. **`regions/dam.ts`** (3 treasures)
   - Platinum trunk → `treasureId: 'trunk'`
   - Crystal trident → `treasureId: 'trident'`
   - Saffron garnet → `treasureId: 'saffron'`

5. **`regions/frigid-river.ts`** (3 treasures)
   - Pot of gold → `treasureId: 'pot'`
   - Buoy emerald → `treasureId: 'buoy'`
   - Marble statue → `treasureId: 'statue'`

6. **`regions/maze.ts`** (1 treasure)
   - Bag of coins → `treasureId: 'bag'`

7. **`regions/round-room.ts`** (1 treasure)
   - Stradivarius violin → `treasureId: 'violin'`

8. **`regions/temple.ts`** (2 treasures)
   - Crystal grail → `treasureId: 'grail'`
   - Platinum bar → `treasureId: 'bar'`

#### ⏳ Remaining Regions (8 files)

9. **`regions/underground.ts`** (3 treasures)
   - Painting → `treasureId: 'painting'`
   - Ivory torch → `treasureId: 'ivory-torch'`
   - Blue crystal sphere → `treasureId: 'blue-sphere'`

10. **`regions/volcano.ts`** (4 treasures)
    - Gold coffin → `treasureId: 'coffin'`
    - Large emerald → `treasureId: 'emerald'`
    - Star ruby → `treasureId: 'ruby'`
    - Flathead stamp → `treasureId: 'flathead-stamp'`

11. **`regions/well-room.ts`** (3 treasures)
    - Silver chalice → `treasureId: 'chalice'`
    - Pearl necklace → `treasureId: 'necklace'`
    - White crystal sphere → `treasureId: 'white-sphere'`

12. **`regions/house-interior.ts`** (0 treasures - verify)

13. **Dynamic treasure creation**:
    - `actions/send/send-action.ts` - Don Woods stamp
    - `actions/turn-switch/turn-switch-action.ts` - Huge diamond
    - `actions/wind/wind-action.ts` - Brass bauble
    - `handlers/coal-machine-handler.ts` - Huge diamond (duplicate?)
    - `npcs/thief/thief-behavior.ts` - Canary (restored from egg)
    - `objects/thiefs-canvas-objects.ts` - Thief's canvas

### 5. NPC Entity Cleanup

**`npcs/thief/thief-entity.ts`**:
Removed unnecessary anti-pattern:
```typescript
// Before
(stiletto as any).isTreasure = false;

// After
// Removed - absence of TreasureTrait = not a treasure
```

**Lesson**: Negative flags are code smell. Trait absence should be the default.

## Key Decisions

### 1. TreasureTrait is Story-Specific, Not Platform

**Decision**: Place trait in `stories/dungeo/src/traits/` with type `dungeo.trait.treasure`

**Rationale**:
- Treasure mechanics vary by story (not all IF has trophy cases)
- Scoring systems are story-specific
- Aligns with ButtonTrait pattern (also story-specific)
- Platform provides primitives (containers, portability), stories provide game mechanics

### 2. Migration Strategy: Bottom-Up (Readers First, Writers Second)

**Decision**: Update all reader code before migrating writer code

**Rationale**:
- Readers are centralized (helper functions, daemons)
- Writers are scattered (16 region files + dynamic creation)
- Helper functions like `isTreasure()` provide compatibility layer
- Can migrate writers incrementally without breaking readers

**Pattern**:
```typescript
// Step 1: Create helper (reader)
export function isTreasure(entity: IFEntity): boolean {
  return entity.trait<TreasureTrait>(TreasureTrait.type) !== null;
}

// Step 2: Migrate writers one region at a time
item.add(new TreasureTrait({
  treasureId: 'egg',
  treasureValue: 5,
  trophyCaseValue: 5,
}));
```

### 3. Canonical Treasure Values

**Decision**: Use `docs/dungeon-81/mdlzork_810722/` as source of truth for all treasure values

**Values from MDL source**:
- OFVAL (Object Find Value) → `treasureValue`
- OTVAL (Object Trophy Value) → `trophyCaseValue`

**Example** (from `mdl/objects.mud`):
```mdl
<OBJECT FLATHEAD-STAMP
  (IN ROCKY-CRAWL)
  (SYNONYM STAMP)
  (ADJECTIVE FLATHEAD)
  (DESC "Flathead stamp")
  (FDESC "There is a rare Flathead stamp here.")
  (FLAGS TAKEBIT TREASUREBIT)
  (VALUE 10)        ; OFVAL
  (TVALUE 10)       ; OTVAL
```

## Architectural Notes

### Why Traits Persist Through Checkpoints

The checkpoint system (`packages/core/src/checkpoints/`) serializes:
1. Entity metadata (id, name, location)
2. Trait data (all properties of all traits)

It does **not** serialize:
- Custom properties added via `(entity as any).property = value`
- Event handlers registered on entities
- Prototype methods or functions

**Implication**: Any gameplay state must live in traits, not custom properties.

### The (entity as any) Anti-Pattern Timeline

1. **Initial Implementation** (early dungeo work): Used custom properties for rapid prototyping
2. **ButtonTrait Bug** (2026-01-25): Discovered properties don't persist through checkpoints
3. **This Session** (2026-01-26): Comprehensive audit + systematic migration

**Root Cause**: TypeScript's structural typing makes `(entity as any)` too easy and silent. No compile-time errors, only runtime bugs after checkpoint restore.

**Long-term Fix**: Consider TypeScript branded types or runtime property validation to catch this earlier.

### TreasureTrait Design Choices

**Why three separate properties instead of nested config?**
```typescript
// Chosen design (flat)
class TreasureTrait {
  treasureId: string;
  treasureValue: number;
  trophyCaseValue: number;
}

// Rejected design (nested)
class TreasureTrait {
  treasureId: string;
  scoring: {
    onTake: number;
    inTrophyCase: number;
  }
}
```

**Rationale**:
- Maps 1:1 to MDL source (OFVAL, OTVAL)
- Simpler serialization/deserialization
- More discoverable in debug output
- Aligns with Sharpee's "flat trait" pattern (see OpenableTrait, LockableTrait)

## Open Items

### Short Term

1. **Complete region file migrations** (8 remaining):
   - `regions/underground.ts`
   - `regions/volcano.ts`
   - `regions/well-room.ts`
   - `regions/house-interior.ts` (verify no treasures)

2. **Migrate dynamic treasure creation** (6 files):
   - `actions/send/send-action.ts`
   - `actions/turn-switch/turn-switch-action.ts`
   - `actions/wind/wind-action.ts`
   - `handlers/coal-machine-handler.ts`
   - `npcs/thief/thief-behavior.ts`
   - `objects/thiefs-canvas-objects.ts`

3. **Regenerate all checkpoints** after migration completes
   - Checkpoints in `checkpoints/` directory
   - Must rebuild with new trait-based treasures

4. **Run full walkthrough chain** to verify:
   - Treasures persist through save/restore
   - Scoring system still works
   - Trophy case logic unchanged

### Medium Term (Next Phase)

5. **Migrate next critical trait: InflatableTrait**
   - Affects boat (frigid river) and balloon (volcano)
   - 6 files affected (see as-any.md)

6. **Migrate BurnableTrait**
   - Affects candles, incense, matches
   - 8 files affected

7. **Migrate room state traits**:
   - RiverRoomTrait (frigid river navigation)
   - SpinningRoomTrait (round room puzzle)
   - DomeRoomTrait (rope/torch puzzle)

### Long Term

8. **Create ADR-117**: Trait Migration Pattern
   - Document the TreasureTrait migration as template
   - Establish guidelines for future migrations
   - Define "acceptable" vs "must migrate" criteria

9. **Consider runtime validation**:
   - Warn on `(entity as any)` assignments during development
   - Object.seal() entities after creation?
   - TypeScript ESLint rule to flag this pattern?

## Files Modified

**Documentation** (2 files):
- `docs/work/platform/as-any.md` - Comprehensive audit of all anti-patterns
- `docs/context/session-20260126-0006-main.md` - This summary

**Trait Definition** (2 files):
- `stories/dungeo/src/traits/treasure-trait.ts` - New TreasureTrait implementation
- `stories/dungeo/src/traits/index.ts` - Export TreasureTrait

**Reader Code** (3 files):
- `stories/dungeo/src/npcs/thief/thief-helpers.ts` - Updated 4 functions
- `stories/dungeo/src/scheduler/bank-alarm-daemon.ts` - Updated isCarryingBankTreasures()
- `stories/dungeo/src/actions/gdt/commands/de.ts` - Updated debug output

**NPC Cleanup** (1 file):
- `stories/dungeo/src/npcs/thief/thief-entity.ts` - Removed stiletto anti-pattern

**Region Files - Treasure Creation** (8 files):
- `stories/dungeo/src/regions/forest.ts` - 2 treasures
- `stories/dungeo/src/regions/bank-of-zork.ts` - 4 treasures
- `stories/dungeo/src/regions/coal-mine.ts` - 3 treasures
- `stories/dungeo/src/regions/dam.ts` - 3 treasures
- `stories/dungeo/src/regions/frigid-river.ts` - 3 treasures
- `stories/dungeo/src/regions/maze.ts` - 1 treasure
- `stories/dungeo/src/regions/round-room.ts` - 1 treasure
- `stories/dungeo/src/regions/temple.ts` - 2 treasures

**Total**: 16 files modified, 2 files created

## Testing Notes

**Not yet tested** - build/test blocked until migration completes:
- Cannot build until all treasure creation migrated
- Cannot test until checkpoints regenerated
- Will run full walkthrough chain after completion

**Test plan**:
```bash
# 1. Build with new trait
./build.sh -s dungeo

# 2. Regenerate all checkpoints
node dist/sharpee.js --play  # Manual save points

# 3. Run walkthrough chain
node dist/sharpee.js --test --chain stories/dungeo/walkthroughs/wt-*.transcript

# 4. Verify scoring system
# - Take treasures, verify points awarded
# - Put in trophy case, verify additional points
# - Save/restore, verify treasure status persists
```

## Lessons Learned

### 1. Custom Properties Are a Trap

TypeScript's `(entity as any)` bypasses all type safety and creates silent persistence bugs. Always use traits for entity state.

**Code Smell Checklist**:
- Does this property affect gameplay? → Use a trait
- Does this property need to persist? → Use a trait
- Is this property mutated after creation? → Use a trait
- Is this property read by multiple systems? → Use a trait

Only acceptable uses of `(entity as any)`:
- Test fixtures (with comment explaining why)
- Temporary debugging (removed before commit)

### 2. Audit Before Migration

The comprehensive `as-any.md` audit document was critical for:
- Understanding scope (467 instances, not "a few")
- Prioritizing work (treasures block scoring, must fix first)
- Avoiding duplication (one TreasureTrait, not per-treasure types)
- Planning incremental migration (readers first, writers second)

**Template for future migrations**:
1. Grep for pattern
2. Classify by severity
3. Group by affected system
4. Estimate migration effort
5. Choose migration order

### 3. Bottom-Up Migration is Safer

Migrating readers (consumers) before writers (producers) allowed:
- Helper functions provide compatibility layer
- Incremental region file updates
- Easier rollback if issues found
- Better test coverage (readers work with both old and new)

**Alternative (top-down) would have been riskier**:
- Update all writers at once → big bang change
- If helper functions wrong, affects all regions
- Harder to track progress (all or nothing)

### 4. MDL Source as Ground Truth

Using `docs/dungeon-81/mdlzork_810722/` as canonical reference prevented:
- Inconsistent treasure values across regions
- Guessing at original game behavior
- Debates about "correct" scoring

**Lesson**: Always have authoritative source for game data, not tribal knowledge.

## Statistics

**Anti-Pattern Audit**:
- Total `(entity as any)` instances: 467
- Critical (must migrate): 282
- Test fixtures (acceptable): 145
- Platform code (needs review): 28

**TreasureTrait Migration Progress**:
- Total treasure instances: 112
- Migrated region files: 8 / 16 (50%)
- Migrated treasures: ~19 / ~28 (68% estimated)
- Dynamic creation files: 0 / 6 (0%)
- Reader files: 3 / 3 (100%)

**Session Duration**: ~2.5 hours

**Approach**: Systematic audit followed by incremental migration, prioritizing critical gameplay systems (scoring) before nice-to-haves (debug output).

---

**Progressive update**: Session in progress 2026-01-26 00:06

**Next session**: Complete remaining 8 region files + 6 dynamic creation files, regenerate checkpoints, run walkthrough chain to verify scoring persistence.
