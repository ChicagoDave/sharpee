# Session Summary: 2026-01-26 - ADR-118 Phase 1 & 2 Implementation

## Status: Completed

## Goals
- Implement ADR-118 Phase 1: Action Interceptor Core Infrastructure
- Implement ADR-118 Phase 2: Prototype with ENTERING action + boat puncture

## Completed

### Phase 1: Core Infrastructure

Created the action interceptor system in `packages/world-model/src/capabilities/`:

**New Files:**
- `action-interceptor.ts` - ActionInterceptor interface with hooks:
  - `preValidate` - Block action early (before standard validation)
  - `postValidate` - Add entity-specific conditions after standard validation
  - `postExecute` - Additional mutations after standard execution
  - `postReport` - Additional effects after standard report
  - `onBlocked` - Custom blocked handling

- `interceptor-registry.ts` - Registry for trait-interceptor bindings:
  - `registerActionInterceptor(traitType, actionId, interceptor)`
  - `getInterceptorForAction(entity, actionId)` - finds interceptor by trait type
  - Uses `globalThis` to share registry across module boundaries

- `interceptor-helpers.ts` - Helper functions:
  - `findTraitWithInterceptor(entity, actionId)`
  - `hasInterceptor(entity, actionId)`
  - `getEntityInterceptors(entity)`

**Modified Files:**
- `packages/world-model/src/traits/trait.ts` - Added `interceptors` to ITraitConstructor
- `packages/world-model/src/capabilities/index.ts` - Exports for all new types

### Phase 2: ENTERING Action + Boat Puncture Migration

**Modified stdlib:**
- `packages/stdlib/src/actions/standard/entering/entering.ts` - Added interceptor hooks:
  - Calls `getInterceptorForAction()` in validate
  - Runs preValidate/postValidate hooks around standard validation
  - Runs postExecute hook after standard execution
  - Runs postReport hook to add additional effects
  - Runs onBlocked hook for custom blocked handling

**New story files:**
- `stories/dungeo/src/interceptors/inflatable-entering-interceptor.ts` - Boat puncture interceptor:
  - `postValidate`: Detects sharp objects in player inventory
  - `postExecute`: Deflates boat, ejects player, updates traits
  - `postReport`: Adds puncture message

**Modified story files:**
- `stories/dungeo/src/traits/inflatable-trait.ts` - Added `static interceptors` declaration
- `stories/dungeo/src/traits/index.ts` - Exports interceptor
- `stories/dungeo/src/index.ts` - Registers interceptor, removed old handler import

### Key Discovery: Module Boundary Issue

The interceptor registry wasn't working initially because:
- The platform bundle (dist/sharpee.js) has one instance of world-model
- The story (stories/dungeo/dist) imports from @sharpee/world-model (packages)
- These are different module instances with separate registries

**Solution:** Used `globalThis` to share the registry across module boundaries:
```typescript
const INTERCEPTOR_REGISTRY_KEY = '__sharpee_interceptor_registry__';
function getInterceptorRegistry(): Map<string, TraitInterceptorBinding> {
  const global = globalThis as Record<string, unknown>;
  if (!global[INTERCEPTOR_REGISTRY_KEY]) {
    global[INTERCEPTOR_REGISTRY_KEY] = new Map();
  }
  return global[INTERCEPTOR_REGISTRY_KEY];
}
```

## Test Results

Boat stick puncture test passes (16/16 assertions):
- Player can inflate boat
- Entering boat with sharp stick punctures it
- Boat becomes "pile of plastic"
- Player can still put stick in boat first, then enter safely

## Key Decisions

### 1. Interceptors vs Capability Behaviors
**Decision:** Keep them separate - interceptors are hooks, behaviors are full delegation.
**Rationale:** Matches Inform 7's Before/After vs Instead pattern.

### 2. Registry Lookup by Trait Type String
**Decision:** Look up interceptors by `trait.type` string, not by static `interceptors` array.
**Rationale:** More reliable across module boundaries where static properties may not be accessible.

### 3. globalThis for Registry Sharing
**Decision:** Use globalThis to ensure registry is shared across module instances.
**Rationale:** The bundle and story are separate module instances; globalThis is the cleanest way to share state.

## Files Changed

**Platform (packages/):**
- `packages/world-model/src/capabilities/action-interceptor.ts` (new)
- `packages/world-model/src/capabilities/interceptor-registry.ts` (new)
- `packages/world-model/src/capabilities/interceptor-helpers.ts` (new)
- `packages/world-model/src/capabilities/index.ts` (modified)
- `packages/world-model/src/traits/trait.ts` (modified)
- `packages/stdlib/src/actions/standard/entering/entering.ts` (modified)

**Story (stories/dungeo/):**
- `stories/dungeo/src/interceptors/inflatable-entering-interceptor.ts` (new)
- `stories/dungeo/src/traits/inflatable-trait.ts` (modified)
- `stories/dungeo/src/traits/index.ts` (modified)
- `stories/dungeo/src/index.ts` (modified)

## Open Items

### Short Term
- Remove old `boat-puncture-handler.ts` file (now replaced by interceptor)
- Add interceptor support to THROWING action (for glacier puzzle)
- Add interceptor support to GOING action (for troll guardian)
- Add interceptor support to PUTTING action (for trophy case)

### Long Term
- Migrate remaining handlers to interceptors
- Document interceptor pattern in core-concepts.md
- Consider using globalThis for capability behaviors too (same module boundary issue likely exists)

## Notes

**Session duration**: ~2 hours

**Key insight**: Module boundary issues in bundled code require careful registry design. The globalThis pattern ensures registries work correctly regardless of how modules are loaded.

---

**Progressive update**: Session completed 2026-01-26 21:00
