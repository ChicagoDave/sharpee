# Session Summary: 2026-01-28 - main

## Status: Completed

## Goals
- Debug CLI hang issue affecting play mode and all transcript test modes
- Identify and fix root cause of startup deadlock
- Restore full functionality to bundled CLI

## Completed

### Root Cause Analysis: CLI Startup Hang

**Problem**: All CLI modes (play, test, test --chain) were hanging on startup with no output. The hang occurred during story module loading, not during engine initialization.

**Investigation path**:
1. Added extensive debug logging to `scripts/bundle-entry.js` to trace execution
2. Traced through: CLI arg parsing → engine creation → story module require()
3. Identified hang was in `require('../../stories/dungeo/dist/index.js')`, not in state machine plugin
4. Used `npx madge --circular stories/dungeo/dist/index.js` to detect circular dependencies

**Discovery**: Two circular dependency cycles in story code causing require() deadlock:

**Cycle 1: Barrel Import Pattern**
```
traits/index.ts →
  interceptors/ghost-ritual-dropping-interceptor.ts →
    objects/thiefs-canvas-objects.ts →
      traits/index.ts (CYCLE)
```

**Cycle 2: Action Module Pattern**
```
actions/pull-mat/index.ts →
  pull-mat-action.ts →
    handlers/tiny-room-handler.ts →
      actions/pull-mat/index.ts (CYCLE)
```

### Circular Dependency Fixes

**Fix 1: Thief's Canvas Objects** (`stories/dungeo/src/objects/thiefs-canvas-objects.ts`)

Changed from barrel import:
```typescript
import { TreasureTrait, BurnableTrait, FramePieceTrait } from '../traits';
```

To direct file imports:
```typescript
import { TreasureTrait } from '../traits/treasure-trait';
import { BurnableTrait } from '../traits/burnable-trait';
import { FramePieceTrait } from '../traits/frame-piece-trait';
```

**Fix 2: Tiny Room Handler** (`stories/dungeo/src/handlers/tiny-room-handler.ts`)

Changed from barrel import:
```typescript
import { PULL_MAT_ACTION_ID } from '../actions/pull-mat';
```

To direct type import:
```typescript
import { PULL_MAT_ACTION_ID } from '../actions/pull-mat/types';
```

### Cleanup and Documentation

**Removed debug logging** from `scripts/bundle-entry.js`:
- Removed 8 console.log statements added during investigation
- Restored clean production bundle entry point

**Added madge documentation** to CLAUDE.md:
- New "Circular Dependency Detection" section under Testing Commands
- Documents `npx madge --circular` usage for detecting cycles
- Provides guidance on fixing barrel import patterns

### Verification

**All 148 walkthrough tests passing** after fixes:
```bash
node dist/sharpee.js --test --chain stories/dungeo/walkthroughs/wt-*.transcript
```

CLI now works correctly in all modes:
- `--play` - Interactive REPL
- `--test` - Single transcript
- `--test --chain` - Walkthrough chains

## Key Decisions

### 1. Prefer Direct Imports Over Barrel Imports in Cycles

**Rationale**: Barrel imports (index.ts re-exports) are convenient but create circular dependency risks. When a cycle is detected involving a barrel import, break it by importing directly from the source file.

**Pattern**:
- Keep barrel imports for external consumers (other packages, stories)
- Use direct imports within the same package when involved in a cycle
- Document madge in CLAUDE.md for future detection

### 2. Separate Action Types from Action Implementation

**Rationale**: Action constants (like `PULL_MAT_ACTION_ID`) should live in a separate `types.ts` file to avoid circular dependencies when handlers need to reference actions that reference handlers.

**Pattern**:
```
actions/
  pull-mat/
    types.ts         # Action ID constants, interfaces
    pull-mat-action.ts  # Action implementation
    index.ts         # Barrel export (external API)
```

This allows handlers to import just the type/constant without pulling in the full action implementation.

## Architectural Notes

### Circular Dependencies in Node.js Module System

Node.js handles circular dependencies by returning a **partially constructed module** during the cycle. This works for most code but fails catastrophically with:

1. **Re-export patterns** (barrel imports)
2. **Initialization-time code** (top-level function calls, class definitions)
3. **Deep chains** (A → B → C → A)

**Detection**: `npx madge --circular <entry-point>` is essential for finding these before they cause runtime deadlocks.

**Prevention patterns**:
- Avoid barrel imports within the same package (use direct imports)
- Separate type definitions from implementations
- Use dependency injection instead of top-level requires
- Keep action constants in separate type files

### Story Code Organization Learnings

The circular dependencies revealed areas where story organization could improve:

**Traits**: Should be self-contained with minimal cross-references. If a trait needs another trait's type, use direct imports not barrel.

**Interceptors**: Should import traits directly, not through barrel exports. Interceptors are edge-case handlers and shouldn't force coupling through index.ts.

**Actions**: Should have a three-file structure when they reference handlers:
- `types.ts` - Constants, interfaces (for handlers to import)
- `{action}-action.ts` - Implementation
- `index.ts` - Barrel export

## Files Modified

**Story Code** (3 files):
- `stories/dungeo/src/objects/thiefs-canvas-objects.ts` - Changed to direct trait imports
- `stories/dungeo/src/handlers/tiny-room-handler.ts` - Changed to direct type import
- `scripts/bundle-entry.js` - Removed debug logging

**Documentation** (1 file):
- `CLAUDE.md` - Added madge circular dependency detection section

## Open Items

### Short Term
- None - CLI fully functional, all tests passing

### Long Term
- **Audit all barrel imports** in story code for potential circular dependency risks
- **Consider madge in CI/CD** to catch circular dependencies before they reach main branch
- **Evaluate story organization patterns** to minimize cross-references between traits/interceptors/handlers

## Notes

**Session duration**: ~2.5 hours

**Approach**: Systematic debugging from CLI entry point through bundle initialization to module loading. Used strategic console.log placement to narrow down hang location, then applied static analysis (madge) to identify root cause.

**Context**: This session also includes uncommitted work from previous sessions:
- ADR-121/122: Client package renaming (client-react → zifmia, deletion of client-core and clients packages)
- ADR-120 Phase 4: State machine plugin, trapdoor migration

**Key insight**: The hang appeared to be a state machine plugin issue but was actually a circular dependency in story code. Always verify assumptions with tools (madge) rather than guessing based on symptoms.

---

**Progressive update**: Session completed 2026-01-28 18:53
