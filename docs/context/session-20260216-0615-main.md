# Session Summary: 2026-02-16 - main (6:15 AM CST)

## Status: In Progress

## Goals
- Fix all 11 remaining failures in wt-13-volcano-balloon.transcript
- Complete volcano/balloon puzzle implementation
- Reach clean walkthrough chain run (all 13 walkthroughs passing)

## Completed

### Root Cause Analysis (Research Phase)
Identified 3 distinct bugs causing 11 test failures in wt-13:

**1. Scheduler Fuse Timing Off-by-One Bug (3 failures)**
- Discovered scheduler ticks fuses on the SAME TURN they're registered via `setFuse()`
- Result: Explosion fuse with `EXPLOSION_TURNS = 2` fires after 1 player action instead of 2
- Traced execution flow: `burn wire` â†’ `startExplosionCountdown()` â†’ `scheduler.setFuse()` â†’ immediate `tick()` â†’ decrement
- Also affects `brick-explosion.transcript` unit test
- **Fix implemented**: Added `setOnTurn` field to `FuseState`, skip tick when `turn === state.setOnTurn`

**2. Runner $save/$restore Missing Plugin State (7 failures)**
- `runner.ts` only saves/restores `world.toJSON()`/`world.loadJSON()` â€” doesn't preserve plugin state
- State machine plugin resets to initial state after `$restore`
- Trapdoor state machine resets from 'barred' (terminal) to 'open', re-fires on descent, closes trapdoor
- Confirmed by inspecting wt-12.json: trapdoor has `isOpen: true` + `dungeo.trapdoor.barred: true`
- Engine's `save-restore-service.ts` has proper handling but runner bypasses it
- **Fix partial**: Added `getPluginRegistry()` to GameEngine interface, started envelope format

**3. Balloon Exit at Volcano Bottom Missing Room Name (1 failure)**
- `createBalloonExitTransformer()` has early return for `vlbot` position (line 242-244)
- Lets stdlib exiting action run â†’ "You get out of balloon." without room name
- For ledge positions, redirects to `BALLOON_EXIT_ACTION_ID` which includes room name
- **Fix implemented**: Removed early return, all positions now redirect to custom action

### Implementation Phase (2 of 3 fixes complete)

**Fix 1: Scheduler Fuse Same-Turn Skip** âœ…
Modified `packages/plugin-scheduler/`:
- `src/types.ts`: Added `setOnTurn?: number` field to `FuseState` interface
- `src/scheduler-service.ts`:
  - `setFuse()`: Records `setOnTurn: this.currentTurn` when registering fuse
  - `tick()`: Skips fuses where `turn === state.setOnTurn` (same-turn guard)
- Serialization auto-handled via spread in getState/setState

**Fix 3: Balloon Exit at Volcano Bottom** âœ…
Modified `stories/dungeo/src/handlers/balloon-handler.ts`:
- Removed early return for `vlbot` in `createBalloonExitTransformer()`
- All positions (ground + ledge) now redirect to `BALLOON_EXIT_ACTION_ID`
- `positionRooms` already has `vlbot: volcanoBottom` mapping

**Fix 2: Runner Plugin State Save/Restore** ðŸš§
Partially modified `packages/transcript-tester/src/runner.ts`:
- Added `getPluginRegistry?()` to `GameEngine` interface
- Started $save handler modification (needs envelope format)
- $restore handler not yet modified

## Key Decisions

### 1. Fuse Timing: Same-Turn Skip vs Adjust Constants
**Decision**: Add `setOnTurn` field + skip logic rather than adjusting EXPLOSION_TURNS/etc constants
**Rationale**:
- Preserves MDL semantics (FUSIN=2 means 2 turns in source)
- Fixes bug at platform level for all future fuses
- Timing constants remain readable/accurate

### 2. Runner Save Format: Envelope with Plugin States
**Decision**: Wrap world state + plugin states in envelope `{ worldState, pluginStates }`
**Rationale**:
- Backward compatible (detect envelope vs raw JSON)
- Matches engine's save-restore-service.ts pattern
- Enables any plugin to preserve state across test sessions

### 3. Balloon Exit: Custom Action Redirect vs Stdlib Override
**Decision**: Redirect all positions to custom balloon exit action
**Rationale**:
- Consistent behavior for ground and ledge positions
- Avoids modifying stdlib exiting action
- Room name display already implemented in custom action

## Open Items

### Immediate (This Session)
- [ ] Complete Fix 2: Finish $save/$restore envelope format
- [ ] Build with `./build.sh -s dungeo`
- [ ] Run `brick-explosion.transcript` to verify fuse timing fix
- [ ] Run full walkthrough chain to regenerate all saves with plugin state
- [ ] Run wt-13 individually to verify all 11 failures resolved

### Short Term
- [ ] Commit all fixes with message "fix: scheduler fuse same-turn tick, balloon exit room name, runner plugin state save/restore"
- [ ] Document scheduler same-turn behavior in ADR-071 (Daemons and Fuses)
- [ ] Consider adding warning if setFuse() called with turns=1 (will fire immediately)

### Long Term
- [ ] Review other places where turn timing assumptions might be fragile
- [ ] Add integration test for plugin state save/restore
- [ ] Consider whether daemons have same-turn tick issue

## Files Modified

**Platform - Plugin Scheduler** (2 files):
- `packages/plugin-scheduler/src/types.ts` - Added setOnTurn to FuseState
- `packages/plugin-scheduler/src/scheduler-service.ts` - Same-turn skip in setFuse/tick

**Platform - Transcript Tester** (1 file):
- `packages/transcript-tester/src/runner.ts` - Added getPluginRegistry to GameEngine interface (partial)

**Story - Balloon Handler** (1 file):
- `stories/dungeo/src/handlers/balloon-handler.ts` - Removed vlbot early return, redirect all exits

## Architectural Notes

### Scheduler Same-Turn Tick Pattern
The scheduler has an implicit turn structure:
1. Action executes â†’ world state changes
2. Scheduler tick runs â†’ daemons fire, fuses decrement
3. Turn counter increments

When `setFuse(id, turns, callback)` is called DURING an action, the scheduler immediately ticks in step 2, causing the fuse to start at `turns - 1` effectively. The `setOnTurn` field + skip logic ensures fuses don't tick on the same turn they're registered.

This is similar to how daemon registration works â€” if you register a daemon mid-turn, it shouldn't fire until the NEXT turn's tick phase.

### Runner vs Engine Save/Restore
Two parallel implementations exist:
- **Engine**: `packages/engine/src/services/save-restore-service.ts` - Full save/restore with plugin state
- **Runner**: `packages/transcript-tester/src/runner.ts` - Simplified save/restore for testing

The runner was bypassing plugin state to keep test saves simple, but this breaks state machine scenarios. The fix unifies both paths by using the same envelope format.

### Balloon Position Exit Consistency
The balloon handler now treats all positions uniformly:
- Ground positions (vlbot, vair1-3): Redirect to custom exit action
- Ledge positions (ldg1-4): Redirect to custom exit action

Previously `vlbot` had special handling (early return) which broke the room name display. The `positionRooms` map already encoded the destination logic, so the transformer just needs to redirect consistently.

## Notes

**Session duration**: ~1.5 hours (continued from earlier session)

**Approach**: Research-first debugging to identify all root causes before implementing fixes. Prevented whack-a-mole pattern where fixing one symptom reveals another.

**Commit History**:
- a0bf925 - Session summary documenting research findings

**Testing Strategy**: Will verify fixes in stages:
1. Unit test (brick-explosion.transcript) for fuse timing
2. Full chain regeneration for save file format
3. Individual wt-13 run for balloon exit + integration

---

**Progressive update**: Session in progress 2026-02-16 06:15 AM CST
