# Session Summary: 2026-01-28 - main

## Status: Completed

## Goals
- Explore distribution options for Sharpee (Glulx, Electron alternatives)
- Design story runner architecture for desktop distribution
- Define rich media and styling capabilities
- Create lean story runner implementation (Zifmia)

## Completed

### ADR-121: Story Runner Architecture
- Defined separation between runner (Zifmia) and story bundles (.sharpee files)
- Story bundles are zip archives containing:
  - `story.js` - compiled TypeScript story
  - `meta.json` - metadata (title, author, IFID, version)
  - `theme.css` - optional story-specific styling
  - `assets/` - optional images, fonts, etc.
- Runner handles:
  - Loading .sharpee bundles
  - Managing save/restore via browser localStorage
  - Rendering game interface (status line, transcript, command input)
  - Coordinating story JS execution
- Modeled after IF community's Frotz/Gargoyle pattern
- Decided to always use zip format (not bare JS files)
- Selected Tauri over Electron (~10MB vs ~150MB, uses OS webview)

### ADR-122: Rich Media and Story Styling
- **Inline Illustrations**:
  - `IllustrationTrait` on entities with image path and display settings
  - Illustration events separate from narrative text events
  - Language layer remains unaware of illustrations
  - CSS float rendering (right-aligned by default)
- **Story Styling**:
  - Real CSS scoped to game content area (not HTML root)
  - No abstraction layer - authors write actual CSS
  - Stories bundle `theme.css` and `assets/` in .sharpee archive
  - Runner provides default baseline styles

### Zifmia Package Creation
Created `packages/zifmia/` as the story runner client:

**Removed components** (archived to `docs/archive/react-bits/`):
- TabPanel system (TabPanel.tsx, TabButton.tsx)
- MapPanel.tsx and useMap.ts
- NotesPanel.tsx and useNotes.ts
- ProgressPanel.tsx and useProgress.ts
- CommentaryPanel.tsx and useCommentary.ts

**Simplified architecture**:
- GameShell now full-width layout (no sidebars)
- Three core components: StatusLine + Transcript + CommandInput
- Package renamed from `@sharpee/client-react` to `@sharpee/zifmia`

**Key files retained**:
- `src/components/GameShell.tsx` - main layout container
- `src/components/StatusLine.tsx` - location/score display
- `src/components/Transcript.tsx` - game output
- `src/components/CommandInput.tsx` - player input
- `src/hooks/useGameEngine.ts` - engine integration
- `src/hooks/useTranscript.ts` - output management
- `src/hooks/useCommandHistory.ts` - input history
- `src/App.tsx` - root component

### Cleanup and Migration
**Deleted obsolete packages**:
- `packages/client-react/` - replaced by zifmia
- `packages/client-core/` - old unmaintained code
- `packages/clients/` - old stub implementations

**Updated build references**:
- `build.sh` - three occurrences of `client-react` → `zifmia`
- `package.json` - workspace list updated
- `stories/dungeo/src/react-entry.tsx` - imports updated to `@sharpee/zifmia`
- `pnpm-workspace.yaml` - already excluded client-core

### IFWiki Documentation
Drafted comprehensive Sharpee description covering:
- Parser-based TypeScript IF authoring system
- Four-phase action architecture
- Entity-trait-behavior model
- Distribution via .sharpee bundles
- Zifmia runner for desktop
- Browser clients for web distribution
- Current status (beta, Dungeo implementation in progress)

## Key Decisions

### 1. Glulx Conversion is Impractical
**Rationale**: Paradigm gap between runtime-driven (Sharpee's TypeScript entities/traits/actions) and compilation-driven (Inform's world model compiled to bytecode) systems. Glulx expects complete game state in bytecode; Sharpee's game state emerges from TypeScript execution. Would require writing a TypeScript-to-Inform transpiler that preserves semantic equivalence - effectively reimplementing both systems.

**Implication**: Sharpee will distribute via web (browser clients) and desktop (Tauri runner), not traditional IF interpreters.

### 2. Tauri Over Electron
**Rationale**:
- Size: ~10MB vs ~150MB (bundles OS webview instead of Chromium)
- Sharpee already has browser clients - just need webview host
- Active development, good Rust/JS bridge
- Security model aligns with story sandbox needs

**Implication**: Runner implementation will use Tauri for desktop distribution.

### 3. Story Bundles Always Use Zip Format
**Rationale**: Consistency, forward compatibility, and asset support. Even minimal stories without illustrations/CSS benefit from standard format. Zip overhead is negligible (~1KB).

**Implication**: `.sharpee` extension always means zip archive, simplifies runner loading logic.

### 4. Zifmia is THE Runner (Not Just "Lean Client")
**Rationale**: Name confusion and scope creep avoided by being explicit - Zifmia is the canonical story runner that will support all runtime features (rich media, custom styling, future extensions). It starts lean but grows as story capabilities expand.

**Implication**: React panel code is archived (not deleted) for potential future use in author-defined custom panels. Zifmia's current simplicity is intentional starting point, not permanent limitation.

### 5. Illustrations as Separate Event Stream
**Rationale**: Language layer should stay language - adding illustration awareness would pollute message definitions. Illustrations are presentation layer concerns, triggered by game state but rendered independently from narrative text.

**Implication**:
- `IllustrationTrait` on entities declares images
- `if.event.illustration` events emitted separately from text events
- Transcript component coordinates rendering (CSS float)
- Language layer remains pure text generation

### 6. Real CSS, No Abstraction Layer
**Rationale**: CSS is already a well-designed styling language. Creating an abstraction would add complexity without benefit. Story authors who want custom styling already understand CSS. Those who don't can use runner defaults.

**Implication**:
- Stories bundle `theme.css` with actual CSS rules
- Runner scopes CSS to game content area (prevents global pollution)
- No "style configuration object" or CSS-in-JS abstractions

## Open Items

### Short Term
- Implement Tauri shell for Zifmia runner
- Define .sharpee bundle loading mechanism
- Add illustration event handling to Transcript component
- Test story CSS scoping and asset loading
- Update build.sh to generate .sharpee bundles
- Create sample story with illustrations

### Long Term
- Sound/music event system (ADR needed)
- Custom story panels API (author-defined React components)
- Bundle signing and verification for story distribution
- Zifmia plugin system for runner extensions
- IF Archive integration for .sharpee discovery
- Multiplayer/cloud save coordination

## Files Modified

**New Package** (1):
- `packages/zifmia/` - Story runner client (copied from client-react, simplified)

**Deleted Packages** (3):
- `packages/client-react/` - replaced by zifmia
- `packages/client-core/` - obsolete
- `packages/clients/` - old stubs

**Build Configuration** (3 files):
- `build.sh` - Updated client-react → zifmia (3 occurrences)
- `package.json` - Workspace list updated
- `stories/dungeo/src/react-entry.tsx` - Import path updated to @sharpee/zifmia

**Documentation** (2 files):
- `docs/architecture/adrs/ADR-121-story-runner-architecture.md` - New
- `docs/architecture/adrs/ADR-122-rich-media-and-styling.md` - New

**Archived** (1 directory):
- `docs/archive/react-bits/` - Preserved panel components for future reference

## Architectural Notes

### Story Bundle Security Model
The .sharpee bundle format assumes stories are trusted code (TypeScript compiled to JS). Security relies on:
- Tauri's webview sandbox (OS-level isolation)
- Scoped CSS (prevents global style pollution)
- Asset path restrictions (images/fonts from bundle only)
- No direct filesystem access from story code

This is consistent with IF community norms (story files are executable code, not data).

### Illustration Rendering Pattern
Illustrations use CSS float to integrate with text flow:
```
[Image floated right]
Text wraps around the image naturally...
More text continues below...
```

This differs from "full-width illustration breaks" common in Choice-based IF. The pattern suits parser IF's continuous narrative flow. Stories can override via CSS for different layouts.

### Panel Architecture Evolution
The removed panel system (map, notes, progress, commentary) represents experimental UI that didn't align with core runner goals. Key insights:
- **Map panel**: Story-specific, not generalizable (Dungeo's 191 rooms != every story)
- **Notes panel**: Player responsibility, not runner feature (use actual notepad)
- **Progress panel**: Assumes linear progression (not all IF works this way)
- **Commentary panel**: Author-specific feature (should be opt-in via story)

Future custom panel API should:
- Be opt-in via story bundle
- Use story-provided React components
- Coordinate through story event system
- Support arbitrary panel layouts (not hardcoded tabs)

### TypeScript as Story Language
Sharpee differs from traditional IF by using TypeScript as the authoring language (not a DSL). This choice:
- Leverages existing tooling (VS Code, ESLint, TypeScript compiler)
- Provides type safety and autocomplete during authoring
- Enables sophisticated game logic without interpreter limitations
- Requires compilation step (not interpreted at runtime)

The .sharpee bundle contains compiled JavaScript, not source TypeScript. This is analogous to distributing compiled Inform .z8 files rather than source .inf files.

## Notes

**Session duration**: ~2.5 hours

**Approach**: Architecture-first design session. Explored distribution options (Glulx conversion deemed impractical), designed story runner architecture (ADR-121), defined rich media system (ADR-122), then implemented Zifmia package by simplifying client-react. Focused on clean separation of concerns (runner vs story, structure vs presentation, events vs rendering).

**Naming**: "Zifmia" reclaimed from prior unused FyreVM project. Infocom spell meaning "summon a being" - appropriate metaphor for summoning story worlds into existence.

**Next Session**: Focus should be on Tauri implementation - creating the desktop shell, loading .sharpee bundles, coordinating with Zifmia React components. The architecture is defined; time to build the actual runner.

---

**Progressive update**: Session completed 2026-01-28 22:59
