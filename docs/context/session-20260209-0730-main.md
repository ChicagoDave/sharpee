# Session Summary: 2026-02-09 - main (07:30-07:54 AM CST)

## Status: Completed

## Goals
- Convert raw session log from previous gas room work into proper work summary
- Resolve architectural question: how should room entry conditions work in Sharpee?
- Create ADR for destination interceptors pattern

## Completed

### 1. Previous Session Documentation
- Read raw session log `docs/context/room-consitions.txt` from gas room explosion handler attempt
- Created formal work summary: `docs/context/session-20260209-0600-main.md`
- Documented the architectural rejection of command transformer approach
- Captured key finding: going action needs to check destination room, not just source room

### 2. ADR-126: Destination Interceptors for Room Entry Conditions
- Read and analyzed ADR-118 (Stdlib Action Interceptors) in detail
- Used Explore agents to research existing interceptor implementations:
  - All 9 stdlib actions supporting interceptors
  - 6 story-level interceptors in dungeo (troll, exorcist, thief, rug, glacier, etc.)
- Identified architectural gap: ADR-118 only checks source room interceptors, never destination
- Converted `docs/work/platform/room-exit-entrance-conditions.md` assessment into proper ADR
- Key insight: This isn't a new mechanism — it's completing ADR-118's vision

**ADR-126 Key Decisions:**
- Uses dedicated `if.action.entering_room` action ID (separate from `if.action.going`)
- Going action checks BOTH:
  - Source room interceptors for `if.action.going`
  - Destination room interceptors for `if.action.entering_room`
- No utility function for non-going movement paths (author handles conditions in their handlers)
- Stays in stdlib + story code, no world-model changes
- Rejected all 5 options from previous assessment in favor of extending interceptor pattern

**User Feedback Incorporated:**
- Q1: "Different action ID for destination?" → YES, changed to `if.action.entering_room`
- Q2: "Lighting torch IN gas room?" → Recognized as location-scoped interceptors (ADR-127)
- Q3: "Why utility function?" → Agreed, dropped entirely. Non-going paths are author responsibility.

### 3. ADR-127: Location-Scoped Interceptors (stub)
- Created stub ADR for fourth interceptor scope: rooms intercepting actions within them
- Maps to Inform 7's `Before [action] in [Room]` pattern
- Status: PROPOSED (deferred until concrete need arises)
- Notes daemon as simpler alternative for gas room flame-lighting scenario

### 4. Updated Assessment Document
- Marked `docs/work/platform/room-exit-entrance-conditions.md` as SUPERSEDED by ADR-126
- Document preserved for historical context

## Key Decisions

### 1. Destination Interceptors Use Dedicated Action ID
**Rationale**: Using `if.action.entering_room` instead of reusing `if.action.going` provides:
- Clear semantic separation (leaving vs entering)
- Different validation contexts (source room state vs destination room requirements)
- Easier debugging and logging
- Future flexibility for destination-specific behavior

**Implications**: Story code registers two interceptors for room transitions:
- Source room registers for `if.action.going`
- Destination room registers for `if.action.entering_room`

### 2. No Utility Function for Non-Going Movement
**Rationale**: Utility function would:
- Add complexity for rare edge cases
- Obscure author intent (conditions buried in utility call)
- Create consistency issues (when to use vs when to inline)

**Better approach**: Author handles destination checks in their handlers for non-going movement:
```typescript
// In glacier handler for THROW
if (destination === gasRoomId) {
  const hasFlame = hasActiveFlameSource(world, actorId);
  if (hasFlame) return kaboom();
}
```

### 3. Location-Scoped Interceptors Deferred (ADR-127)
**Rationale**: Gas room flame-lighting is better solved by daemon:
- Simpler implementation (no new interceptor scope)
- More appropriate for environmental hazards
- Daemon already handles turn-by-turn state checks

**When ADR-127 becomes needed**: Complex rooms with many action restrictions (like Inform 7's theatrical stage rooms)

## Architectural Notes

### Interceptor Taxonomy (Complete)

Four scopes of action interception:

1. **Direct Object** (ADR-118) — Target of the action
   - Example: Troll's axe blocks TAKE while guardian alive
   - Pattern: `TrollAxeTrait` + `TrollAxeInterceptor`

2. **Source Room** (ADR-118) — Room being left
   - Example: Troll blocks passage through Troll Room
   - Pattern: `TrollRoomTrait` + `TrollInterceptor`

3. **Destination Room** (ADR-126, NEW) — Room being entered
   - Example: Gas Room blocks entry with active flame source
   - Pattern: `GasRoomTrait` + `GasRoomEntryInterceptor`

4. **Location** (ADR-127, PROPOSED) — Room where action happens
   - Example: Gas Room blocks lighting torch inside room
   - Pattern: `GasRoomTrait` + `GasRoomLocationInterceptor`
   - Alternative: Use daemon for environmental hazards

### Implementation Path Forward

**Phase 1: Platform Support** (stdlib/going.ts)
```typescript
// In going action execute phase, check BOTH:
const sourceInterceptor = findTraitWithCapability(sourceRoom, 'if.action.going');
const destInterceptor = findTraitWithCapability(destRoom, 'if.action.entering_room');

if (sourceInterceptor) { /* check source */ }
if (destInterceptor) { /* check destination */ }
```

**Phase 2: Story Implementation** (dungeo/gas-room)
```typescript
// Gas room trait declares capability
class GasRoomTrait implements ITrait {
  static readonly capabilities = ['if.action.entering_room'];
  // ...
}

// Interceptor checks for flame sources
const GasRoomEntryInterceptor: InterceptorBehavior = {
  canIntercept(entity, world, actionId, actorId) {
    return hasActiveFlameSource(world, actorId);
  },
  intercept(entity, world, actionId, actorId, sharedData) {
    return kaboom(world, actorId);
  }
};
```

**Phase 3: Cleanup**
- Remove defunct `gas-room-handler.ts` command transformer
- Remove `applyGasRoomFlameTransform` from orchestration
- Update gas room tests to use natural GOING command

## Open Items

### Short Term
- [ ] Implement ADR-126 Phase 1: Add destination interceptor check to going.ts
- [ ] Implement ADR-126 Phase 2: Gas room using GasRoomTrait + interceptor
- [ ] Remove defunct gas-room-handler.ts transformer
- [ ] Update gas room transcripts to use natural commands
- [ ] Write wt-10 coal mine walkthrough

### Long Term
- [ ] Monitor for need to implement ADR-127 (location-scoped interceptors)
- [ ] Consider other room entry conditions in Zork (sacred ground, underwater rooms, etc.)
- [ ] Document interceptor patterns in core-concepts.md

## Files Modified

**Documentation** (4 files):
- `docs/context/session-20260209-0600-main.md` — NEW: Previous session summary (gas room rejection)
- `docs/architecture/adrs/adr-126-destination-interceptors-and-room-conditions.md` — NEW: Destination interceptors
- `docs/architecture/adrs/adr-127-location-scoped-interceptors.md` — NEW: Location-scoped interceptors stub
- `docs/work/platform/room-exit-entrance-conditions.md` — MODIFIED: Marked as superseded by ADR-126

**Code**: None (pure architecture session)

## Notes

**Session duration**: ~24 minutes

**Approach**:
- Used Explore agents for comprehensive codebase research (interceptor patterns)
- Analyzed existing ADR-118 to identify gap rather than inventing new mechanism
- Incorporated user feedback iteratively to refine decisions
- Created stub ADR-127 to document future option without committing to implementation

**Key realization**: The "missing pattern" wasn't a new feature — it was completing the interceptor model from ADR-118. The going action simply forgot to check the destination room. This is a classic example of "Always Trust the Architecture" — the platform already had the right abstraction, just incomplete coverage.

**Research quality**: Explore agents found all 9 stdlib actions with interceptor support and 6 story interceptors, giving high confidence in the pattern's maturity and consistency.

---

**Progressive update**: Session completed 2026-02-09 07:54 AM CST
