# Session Summary: 2026-02-13 - main (09:14 CST)

## Status: Completed

## Goals
- Fix ISSUE-052: Capability registry behaviors not shared across require() boundaries in CLI bundle

## Completed

### ISSUE-052: Capability Registry Global State Fix

**Problem Identified:**
- `capability-registry.ts` used module-level `const Map` for storing capability behaviors
- When CLI bundle loads a story via `require()`, the story gets its own copy of `@sharpee/world-model`
- Result: Capability behaviors registered by story code were invisible to platform dispatch code
- This broke entity-specific actions like LOWER/RAISE basket, despite registration code running

**Root Cause:**
- Module-level Maps don't survive across require() boundaries in bundled scenarios
- Story code and platform code get separate instances of the same module
- Each instance has its own Map, so registrations in one aren't visible to lookups in the other

**Solution Applied:**
- Changed `capability-registry.ts` to use `globalThis` for storage, matching the proven pattern from `interceptor-registry.ts`
- Added proxy object for backwards compatibility with existing code
- Fixed `getAllCapabilityBindings()` to copy from real Map instead of proxy

**Files Modified:**
- `packages/world-model/src/capabilities/capability-registry.ts` - Switch to globalThis-backed registry
- `docs/work/issues/issues-list-03.md` - Mark ISSUE-052 as fixed (2026-02-13)

### wt-12 Dark Room Failure Fix

**Problem Identified:**
- After thief fight in Treasure Room, going "down" resulted in pitch dark error
- Root cause: Thief steals the ivory torch (player's active light source) during walkthrough chain
- After killing thief, transcript picks up canary, egg, chalice but not the torch
- Result: No light source when navigating underground

**Solution Applied:**
- Added `turn on lantern` before heading underground (reliable light source thief can't steal)
- Added IF-gated `take torch` after fight to recover torch if stolen
- Pattern: `[IF: entity "torch" location "Treasure Room"]` â†’ guards torch pickup

**Files Modified:**
- `stories/dungeo/walkthroughs/wt-12-thief-fight.transcript` - Use lantern for underground navigation, IF-gate torch recovery

**Result:** wt-12 now passes cleanly (49 passed, 5 skipped, 0 failures)

## Key Decisions

### 1. Use Existing GlobalThis Pattern
**Decision:** Used exact same `globalThis` pattern already proven in `interceptor-registry.ts`

**Rationale:**
- Pattern already validated and working in production
- Minimal risk - no new architectural patterns introduced
- Consistency across codebase for registry implementations
- Simple to understand and maintain

### 2. Add Proxy for Backwards Compatibility
**Decision:** Kept `capabilityBehaviors` export as proxy object

**Rationale:**
- Allows existing code using `capabilityBehaviors.get()` or `.set()` to continue working
- Zero breaking changes for consumers
- Clean migration path if direct Map access was used anywhere

## Test Results

**Full Walkthrough Chain (after wt-12 fix):**
```
358 tests total
345 passed
12 skipped
1 pre-existing failure (troll combat randomness in earlier walkthrough)
```

**Build Status:** Clean build, no errors

**Verification:**
- Capability dispatch now works correctly in CLI bundle mode
- wt-12 passes cleanly (49 passed, 5 skipped, 0 failures)

## Files Modified

**Platform** (2 files):
- `packages/world-model/src/capabilities/capability-registry.ts` - GlobalThis-backed registry implementation
- `docs/work/issues/issues-list-03.md` - Issue tracking update

**Story** (1 file):
- `stories/dungeo/walkthroughs/wt-12-thief-fight.transcript` - Fix dark room issue with lantern strategy, IF-gate torch recovery

## Architectural Notes

### Module Boundaries and Bundled Code

This fix reveals an important pattern for **global registries in bundled JavaScript**:

**Problem:** Module-level `const` variables don't survive `require()` boundaries when code is bundled. Each `require()` gets a fresh module instance with its own variables.

**Solution:** Use `globalThis` for truly global state that must be shared across all require() contexts:

```typescript
// WRONG - breaks in bundles
const myRegistry = new Map();
export function register(k, v) { myRegistry.set(k, v); }

// RIGHT - survives require() boundaries
const GLOBAL_KEY = Symbol.for('@my-package/registry');
globalThis[GLOBAL_KEY] = globalThis[GLOBAL_KEY] || new Map();
export function register(k, v) {
  globalThis[GLOBAL_KEY].set(k, v);
}
```

**When to Use:**
- Event handlers (interceptor-registry.ts)
- Capability behaviors (capability-registry.ts)
- Plugin registrations
- Any state that MUST be shared between platform and story code in bundled scenarios

**When NOT to Use:**
- State that should be scoped to a single module
- Data that should be isolated per-instance
- Anything that doesn't need to cross require() boundaries

### Registry Patterns in Sharpee

All Sharpee registries now follow this pattern:
1. **interceptor-registry.ts** - Event handler registration (original globalThis pattern)
2. **capability-registry.ts** - Capability behavior registration (fixed in this session)

If adding new registries, use this same pattern for consistency.

### IF-Gated Transcript Commands

The wt-12 fix demonstrates the power of IF-gated commands for handling state variation:

```
[IF: entity "torch" location "Treasure Room"]
> take torch
You take the ivory torch.
[ENDIF]
```

**Use Cases:**
- Recover items that may or may not be present depending on earlier actions
- Handle random combat outcomes (enemy drops, item destruction)
- Adapt to NPC behaviors (theft, movement, dialogue choices)

**Pattern:** Always provide fallback light source before relying on potentially-stolen items.

## Open Items

### Short Term
- Pre-existing troll combat randomness failure in earlier walkthrough (1/358 tests)
- Continue walkthrough development and testing

### Long Term
- Full Mainframe Zork implementation (Project Dungeo)
- Additional treasure rooms and puzzle mechanics

## Notes

**Session duration**: ~1 hour

**Approach**: Bug investigation, minimal platform fix using proven pattern, then walkthrough debugging

**Impact**:
- ISSUE-052 fix was critical - would have blocked all capability dispatch in production use
- wt-12 fix demonstrates importance of light source management when thief can steal items
- GlobalThis pattern ensures story-registered behaviors are visible to platform code regardless of bundling

---

**Progressive update**: Session updated 2026-02-13 09:43 CST
