# Session: 2026-02-11 20:37 CST — combat-refactor branch

## Summary

Canonical egg/canary puzzle implementation + CLI `--restore` flag + ADR-128 Walkthrough Panel.

## Changes Made

### 1. Canonical Egg-Opening (Lair Deposit)
**File**: `stories/dungeo/src/npcs/thief/thief-behavior.ts`
- Replaced timer-based `checkEggOpening` (3-turn timer, duplicate canary creation) with `handleLairDeposit`
- Canonical MDL behavior: thief opens egg when depositing treasures at his lair (Treasure Room) with player absent
- No duplicate canary — just opens the existing egg from forest.ts setup
- Lair deposit promoted to **Priority 1** (above FIGHTING state check) — the thief deposits regardless of combat state when at lair and player is absent
- Removed `EGG_OPEN_TURNS` constant, simplified `handleReturningState`

### 2. Thief Death Handler (melee-interceptor.ts)
**File**: `stories/dungeo/src/interceptors/melee-interceptor.ts`
- Added `case 'thief'` to `handleVillainDeath` with canonical death logic:
  - Drop all inventory except stiletto to floor
  - Award 25 points, set `thiefDead = true`, `maxScore = 650`
  - Spawn empty frame in lair via `createEmptyFrame()`
  - Disable thief daemon permanently
  - Remove stiletto + thief entity
  - Store death messages in `sharedData.deathMessages` for postReport
- Added `sharedData` parameter to `handleVillainDeath` signature
- Updated `postReport` to emit `deathMessages` as additional `game.message` effects
- Fixed TS error: `villainRoomId ?? null` for `moveEntity` call

### 3. Removed Dead `.on` Handler
**File**: `stories/dungeo/src/npcs/thief/thief-entity.ts`
- Removed dead `.on` event handler (pub/sub anti-pattern — events are messages, not pub/sub)
- Death logic now lives in `handleVillainDeath` in melee-interceptor.ts
- Removed unused imports

### 4. wt-12 Walkthrough Transcript
**File**: `stories/dungeo/walkthroughs/wt-12-thief-fight.transcript`
- Full rewrite: Get knife, take egg from trophy case, navigate to Treasure Room, give egg to thief, leave room, wait for lair deposit, return and kill thief, collect canary/egg/chalice, wind canary in forest for bauble, store treasures
- RETRY/DO/UNTIL for thief fight
- **Status**: `take canary` still failing — scope resolution can't find canary inside open egg on floor. Needs further debugging.

### 5. CLI `--restore` Flag
**Files**: `scripts/bundle-entry.js`, `packages/transcript-tester/src/fast-cli.ts`
- Added `--restore <name>` flag that loads a save file and enters interactive play mode
- Usage: `node dist/cli/sharpee.js --restore wt-11`
- Lists available saves if requested save not found
- Save files generated by `--chain` walkthroughs in `stories/dungeo/saves/`

### 6. ADR-128: Walkthrough Panel for Zifmia
**File**: `docs/architecture/adrs/adr-128-walkthrough-panel.md`
- Proposed Zifmia panel add-on for interactive walkthrough debugging
- Transport controls: Rewind, Step Back, Step Forward, Fast Forward, Branch
- State snapshots for instant rewind, chain navigation between segments
- Inspired by Inform 7 Skein but interactive (can branch into free play)

## Test Results
- wt-01 through wt-11: all pass (329 pass, 8 skip)
- wt-12: `take canary` fails — "You can't see any such thing." (scope resolution issue)
- Troll combat: passes (16/16)

## Known Issue
The `take canary` command can't find the canary inside the opened egg on the Treasure Room floor. The lair deposit correctly opens the egg and drops it, but scope resolution may not traverse into open containers sitting in the room. This needs investigation in the stdlib scope resolver.

## Next Steps
- Debug scope resolution for items inside open containers on the room floor
- Fix `take canary` and complete wt-12 walkthrough
- Verify full 12-walkthrough chain passes
