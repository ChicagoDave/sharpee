# Session Summary: 2026-01-27 - main

## Status: Completed

## Goals
- Audit all handler files in `stories/dungeo/src/handlers/` for mutation violations
- Classify each handler as daemon (mutations allowed), NPC, regular event handler (mutations forbidden), command transformer, or utility module
- Determine which handlers require migration vs. which are architecturally correct
- Write comprehensive assessment document for migration planning

## Completed

### Handler Mutation Audit (Full Inventory)

Conducted comprehensive audit of all 25 handler files in the Dungeo story, classifying each by architectural role and mutation behavior.

**Key finding**: Previous session (2026-01-26) incorrectly declared handler migration "complete" after migrating only 3 handlers to interceptors. The audit revealed **5 regular event handlers still containing direct world mutations**, violating the architectural rule that only daemons and NPCs may mutate state.

### Classification Results

**Daemons (mutations allowed)**: 8 handlers
- `bat-handler.ts` - Random room teleportation on turn tick
- `endgame-trigger-handler.ts` - Crypt turn counter, endgame trigger
- `round-room-handler.ts` - Randomized exit destinations
- `trapdoor-handler.ts` - Auto-close mechanism (needs cleanup)
- `royal-puzzle/puzzle-handler.ts` - Sliding room puzzle state machine
- `exorcism-handler.ts` - Ritual completion checker (hybrid, mostly correct)
- `inside-mirror-handler.ts` - Mirror dimension feedback system
- `endgame-laser-handler.ts` - Laser puzzle (hybrid, mild violation)

**Already migrated to interceptors**: 3 handlers
- `boat-puncture-handler.ts` → `InflatableEnteringInterceptor`
- `glacier-handler.ts` → `GlacierThrowingInterceptor`
- `balloon-handler.ts` (PUT portion) → `ReceptaclePuttingInterceptor`

**Non-mutating handlers (compliant)**: 9 handlers
- Command transformers: rainbow, falls-death, chimney, grue
- Event handlers: mirror-room, death-penalty, reality-altered, victory
- Utility module: basket (exports helpers only)

**VIOLATING: Regular handlers with mutations**: 5 handlers
1. `coal-machine-handler.ts` - Entity creation/destruction in SWITCHING_ON event
2. `ghost-ritual-handler.ts` - Entity lifecycle in DROPPED event
3. `dam-handler.ts` - Multi-room exit blocking and description updates
4. `river-handler.ts` - Boat movement following player
5. `tiny-room-handler.ts` - Misclassified utility (mutations should be in story actions)

**Previously flagged, actually clean**: 1 handler
- `balloon-handler.ts` (remaining code is daemon + story action, both architecturally correct)

### Violation Analysis and Migration Strategies

#### 1. coal-machine-handler.ts
- **Violation**: `world.removeEntity()`, `world.createEntity()`, trait mutations in SWITCHING_ON event
- **Migration**: Interceptor on SWITCHING_ON action (not yet supported)
- **Complexity**: Medium - entity lifecycle in interceptor is new pattern
- **Blocks**: Need to add interceptor hooks to SWITCHING_ON stdlib action

#### 2. ghost-ritual-handler.ts
- **Violation**: Entity creation/destruction in DROPPED event
- **Migration**: Interceptor on DROPPING action (not yet supported)
- **Complexity**: Medium - clear pattern once DROPPING hooks exist
- **Blocks**: Need to add interceptor hooks to DROPPING stdlib action

#### 3. dam-handler.ts
- **Violation**: Direct room exit blocking and description mutations in custom domain events
- **Migration**: Move mutations into bolt-turning capability behavior (owns the transformation)
- **Complexity**: High - coordinates 4 reservoir rooms, architectural decision needed
- **Notes**: Most complex case; handler reacts to custom events rather than stdlib actions

#### 4. river-handler.ts
- **Violation**: `world.moveEntity()` calls in ACTOR_MOVED event
- **Migration**: Interceptor on GOING action (already supported)
- **Complexity**: Low-Medium - straightforward, may need to coordinate with existing boat interceptor
- **Priority**: Migrate first (simplest case)

#### 5. tiny-room-handler.ts
- **Violation**: Misclassified - exports utility functions called from story actions
- **Migration**: Refactor mutations into story action execute phases (where they belong)
- **Complexity**: Medium - 4 puzzle steps (PUT MAT, PUSH KEY, PULL MAT, UNLOCK)
- **Notes**: Not really a handler violation - mutations just need to move from utility to actions

### Assessment Document

Created comprehensive migration planning document at `docs/work/dungeo/handler-assessment.md` covering:
- Full handler inventory with architectural classifications
- Detailed violation analysis for each of the 5 offending handlers
- Migration strategy and complexity assessment for each
- Identification of 2 stdlib actions needing interceptor support (SWITCHING_ON, DROPPING)
- Priority ordering for migration work
- Daemon cleanup track for quality improvements (trapdoor, exorcism direct trait assignments)

## Key Decisions

### 1. The Architectural Rule
**Only daemons and NPCs may mutate world state.** Event handlers must return effects, not call `world.moveEntity()`, `world.createEntity()`, `world.removeEntity()`, `world.setStateValue()`, or directly assign trait properties.

### 2. Balloon Handler is Clean
Previous session flagged `balloon-handler.ts` as needing migration. Audit revealed remaining code is daemon (burn timer) + story action (balloon exit), both of which are architecturally permitted to mutate. No further migration needed.

### 3. Previous "Complete" Claim Was Premature
Session 2026-01-26 claimed handler migration was complete after migrating 3 handlers. Audit found 5 additional handlers requiring migration, representing ~60% of the work remaining.

### 4. Two New Stdlib Actions Need Interceptor Support
SWITCHING_ON and DROPPING actions don't yet have interceptor hooks. These need to be added before coal-machine and ghost-ritual handlers can be migrated.

### 5. Dam Handler Requires Architectural Decision
Unlike other violations (clear action→interceptor migrations), the dam handler reacts to custom domain events and coordinates 4 rooms. Recommended approach: move mutations into the bolt-turning capability behavior that emits the events (behavior owns the full transformation).

## Open Items

### Short Term
- Migrate river-handler (simplest case, GOING interceptor already supported)
- Add interceptor support to SWITCHING_ON stdlib action
- Add interceptor support to DROPPING stdlib action
- Migrate coal-machine-handler (after SWITCHING_ON hooks ready)
- Migrate ghost-ritual-handler (after DROPPING hooks ready)

### Long Term
- Refactor tiny-room utility mutations into story action execute phases
- Migrate dam-handler (architectural decision, coordinates 4 rooms)
- Cleanup daemon direct trait assignments (trapdoor, exorcism) for future change tracking
- Review endgame-laser-handler hybrid pattern (mild violation in event handler portions)

## Files Modified

**Documentation** (1 file):
- `docs/work/dungeo/handler-assessment.md` - Comprehensive audit results, violation analysis, migration strategies

## Architectural Notes

### Handler Classification Taxonomy

This audit refined the handler classification system:

1. **Daemons** - Turn-based logic registered via `scheduler.registerDaemon()`, mutations allowed
2. **NPCs** - Entity-specific behaviors registered via NPC system, mutations allowed
3. **Event Handlers** - React to game events, must return effects only, NO mutations
4. **Command Transformers** - Pre-process commands, read-only, registered via command pipeline
5. **Utility Modules** - Export helpers called from actions/behaviors, classification depends on usage

### Hybrid Pattern Discovery

Found several "hybrid" handlers that blur the lines:
- **endgame-laser-handler**: Registered as both event handlers AND daemon; event portions do mild mutations (state flags only)
- **exorcism-handler**: Event handlers track ritual steps (state flags), daemon performs actual mutations; correctly structured
- **inside-mirror-handler**: Exports helpers called from actions, also has daemon for feedback; mutations are in daemon

These hybrids are mostly correct but could be cleaner with stricter separation of concerns.

### Interceptor Pattern Evolution

The migration work has revealed a progression:
1. **Phase 1** (complete): Simple cases - THROWING, GOING, PUTTING, PUSHING actions
2. **Phase 2** (current): Entity lifecycle cases requiring SWITCHING_ON, DROPPING hooks
3. **Phase 3** (future): Complex multi-entity coordination (dam handler)

The interceptor pattern is proving robust for single-entity, single-action cases. Multi-room coordination (dam) may need a different pattern or enhanced interceptor chaining.

### Misclassification Pattern

`tiny-room-handler.ts` revealed a misclassification issue: code that exports utility functions called from story actions was categorized as a "handler" due to location and filename. The mutations are correct (actions can mutate in execute phase), but the indirection through utility functions obscures this. **Lesson**: Mutations belong in action execute phases, not in separate utility modules.

## Notes

**Session duration**: ~1.5 hours

**Approach**: Systematic file-by-file audit with classification, mutation detection, and migration planning. Created comprehensive assessment document as artifact for future migration work.

**Context**: This corrects the premature "complete" status from session 2026-01-26. The actual remaining work is 5 handler migrations + 2 stdlib action enhancements, representing significant scope.

**Next session should**: Start with river-handler migration (simplest case) to establish pattern, then add SWITCHING_ON/DROPPING interceptor support to enable coal-machine and ghost-ritual migrations.

---

**Progressive update**: Session completed 2026-01-27 00:32
