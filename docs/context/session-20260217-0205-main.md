# Session Summary: 2026-02-17 - main (CST)

## Status: Completed (with open items)

## Goals
- Fix the royal puzzle card detection logic to match MDL canonical source
- Rewrite the wt-14 walkthrough using the correct puzzle mechanics
- Verify the solution passes the full walkthrough chain

## Completed

### Royal Puzzle Plan
- Created plan at `docs/work/dungeo/royal-plan.md`
- Researched MDL source: CPOBJS[37] (1-based) = position 36 (0-based) is the card location
- Clarified that the -3 grid value means "bad ladder" (pushable wall type), NOT a card marker

### Code Changes — Card Detection Rewrite
- Renamed `CARD_BLOCK` to `BAD_LADDER` throughout to accurately name the wall type
- Added `CARD_POSITION = 36` constant representing the canonical card location
- Renamed `isAdjacentToCard` to `isAtCardPosition` — changed from adjacency check to simple equality check
- Simplified `takeCard` so it no longer modifies the grid
- Updated `getPuzzleDescription` to show "depressed floor" text when player is at position 36
- Updated `puzzle-messages.ts` TAKE_CARD message from "wall" to "depression in the floor"
- Updated GDT `pz.ts` command: grid display label changed from `C` to `B` for bad ladder, removed grid modification from CARD subcommand

### Walkthrough Rewrite (wt-14)
- Rewrote `wt-14-royal-puzzle.transcript` with a clean 48-move canonical solution (19 pushes)
- Removed all GDT debugging commands (gdt, pz exit, ex)
- Solution path: entry at top-left → push walls to reach position 36 → take card → reposition ladder to position 10 → exit

### Commit
- `b04a30d` - fix: royal puzzle card detection — position-based at pos 36 per MDL source

## Key Decisions

### 1. Position-Based vs. Adjacency-Based Card Detection
The original code used `isAdjacentToCard` which checked if the player was adjacent to a -3 grid value (misinterpreted as a card marker). The MDL source shows the card is always at CPOBJS[37] (position 36 in 0-based), regardless of grid values. The fix changes detection to a direct position equality check: `currentPosition === CARD_POSITION`.

### 2. No Grid Modification on Take
The original `takeCard` modified the grid when the card was taken. The simplified version removes this — the grid represents the physical puzzle structure (walls), not item presence. Card presence is tracked by the trait's `cardTaken` flag.

### 3. Walkthrough Without GDT
The rewritten walkthrough uses only player-visible commands. The 48-move solution was verified by a subagent tracing all moves against the 6x6 grid manually.

## Open Items

### Short Term (next session)
1. **Fix `{text}` template rendering** — The push-wall action emits a room description via a messageId template containing `{text}`, but the output renders the literal string `{text}` instead of interpolating the event data. This causes the `[OK: contains "depressed"]` assertion to fail at position 36. Likely fix: use the `message` field directly instead of a messageId template wrapper.
2. **Debug command transformer interception** — The `dungeo.puzzle.take_card` command transformer should intercept "take card" before entity validation, but validation fires with ENTITY_NOT_FOUND. Possible causes: parser action ID mismatch, transformer exception silently caught, or `findPuzzleController` returning undefined after save/restore. Add console.log to transformer to trace execution path.
3. Run full walkthrough chain after both fixes are applied.

### Long Term
- Continue remaining Dungeo regions per implementation plan

## Files Modified

**Royal Puzzle Logic** (6 files):
- `stories/dungeo/src/regions/royal-puzzle.ts` - Renamed constants, changed card detection to position-based, simplified takeCard
- `stories/dungeo/src/traits/royal-puzzle-trait.ts` - Renamed CARD_BLOCK to BAD_LADDER in constants and comments
- `stories/dungeo/src/handlers/royal-puzzle/puzzle-handler.ts` - Updated imports and references from isAdjacentToCard to isAtCardPosition
- `stories/dungeo/src/actions/push-wall/push-wall-action.ts` - Updated import reference
- `stories/dungeo/src/actions/puzzle-take-card/puzzle-take-card-action.ts` - Updated comments
- `stories/dungeo/src/actions/puzzle-take-card-blocked/puzzle-take-card-blocked-action.ts` - Updated comments

**Messages** (1 file):
- `stories/dungeo/src/messages/puzzle-messages.ts` - Updated TAKE_CARD message text

**GDT Debugger** (1 file):
- `stories/dungeo/src/actions/gdt/commands/pz.ts` - Grid label C→B, removed grid modification from CARD subcommand

**Walkthrough** (1 file):
- `stories/dungeo/walkthroughs/wt-14-royal-puzzle.transcript` - Full rewrite with clean 48-move canonical solution

**Planning** (1 file):
- `docs/work/dungeo/royal-plan.md` - Created plan with MDL source research and solution derivation

## Architectural Notes

The royal puzzle uses a 6x6 grid of wall values. Grid values encode wall types (-3 = bad ladder / pushable, -1 = normal wall, 0 = open). The card is not encoded in the grid at all — its position is a fixed game constant (CPOBJS[37] = 36 in 0-based indexing) defined in the MDL source. This is a data-driven approach where the puzzle object list and grid are separate arrays.

The command transformer pipeline runs before entity validation in `command-executor.ts` (lines 141-146), so the transformer SHOULD intercept "take card" before ENTITY_NOT_FOUND fires. The failure suggests either the transformer is not being reached or `findPuzzleController` is returning undefined during the wt-14 chain (after save/restore from earlier walkthroughs).

## Notes

**Session duration**: ~2 hours

**Approach**: Research-first (MDL source canonical reference), then systematic rename/refactor, then walkthrough verification via subagent grid trace.

---

**Progressive update**: Session completed 2026-02-17 02:05 CST
