# Session Summary: 2026-02-16 00:00 - main (CST)

## Status: In Progress (awaiting build)

## Goals
- Remove `$teleport` commands from wt-13 (volcano balloon walkthrough)
- Fix disambiguation `{options}` rendering bug discovered during testing

## Completed

### wt-13: Removed Both `$teleport` Commands

Replaced both testing shortcuts with real navigation:

**Forward route** (`$teleport Egyptian Room` → 6 real commands):
```
Living Room → DOWN → Cellar → EAST → Troll Room → NORTH → E/W Passage
→ NORTH → Deep Ravine → WEST → Rocky Crawl → NORTHWEST → Egyptian Room
```
Route verified from existing wt-05 walkthrough.

**Return route** (`$teleport Living Room` → 25 real commands):

The return from Wide Ledge is complex because Wide Ledge is a dead end on foot — the balloon is required.

Key discovery: **guidebook burns for 200 turns** (`size: 10 × 20`). After ~30 turns of volcano activity, it's still burning. Must **close the receptacle** before untying the balloon wire, or the balloon rises and crashes.

Descent sequence:
1. Enter balloon, close receptacle (removes heat source)
2. Untie wire → balloon descends (no heat = gravity)
3. 12 wait commands through 4 air levels (vair4→vair3→vair2→vair1→vlbot)
4. Exit balloon at Volcano Bottom

Walk back (10 steps):
```
Volcano Bottom → N → Lava Room → W → Ruby Room → S → Glacier Room
→ E → Egyptian Room → E → Rocky Crawl → W → Deep Ravine
→ S → E/W Passage → W → Troll Room → W → Cellar → UP → Living Room
```

**Also fixed**: Missing `[OK: contains "open"]` assertion on `open trophy case`.

### Platform Bug Fix: Disambiguation `{options}` Not Interpolated

**Symptom**: `tie wire` (with braided wire + shiny wire both visible) outputs literal `Which do you mean: {options}?` instead of showing actual entity names.

**Root cause**: ADR-097's `tryProcessDomainEventMessage()` in `text-service.ts` intercepts ALL events with a `messageId` field before the switch/case routing. The `client.query` disambiguation event has `messageId: 'core.disambiguation_prompt'`, so it was intercepted. But `tryProcessDomainEventMessage` calls `getMessage(messageId, data.params)` — and `data.params` is `undefined` (the candidates are on `data.candidates`, not `data.params`). So `{options}` was never substituted.

The specialized `handleClientQuery` handler (which correctly extracts candidates, formats them into an options string, and passes `{ options }` to `getMessage`) never ran.

**Fix**: Added skip for `client.query` events in `tryProcessDomainEventMessage`, same pattern as the existing `action.*` skip:
```typescript
// Skip client.query - needs specialized handling
if (event.type === 'client.query') {
  return null;
}
```

**File**: `packages/text-service/src/text-service.ts` (line ~189)

## Key Decisions

### Balloon Descent Requires Closing Receptacle
The guidebook has 200 burn turns. With only ~30 turns elapsed during the volcano sequence, it's still burning when the player returns to Wide Ledge. Closing the receptacle removes the heat source, enabling descent instead of a fatal rise-and-crash.

### Non-Euclidean Volcano Connections
Several volcano rooms have non-symmetric connections (common in Zork):
- Ruby Room → W → Lava Room, AND Lava Room → W → Ruby Room
- Glacier Room → E → Egyptian Room (not DOWN, even though Egyptian Room → UP → Glacier Room)

## Open Items
- **Build needed**: Platform fix requires `./build.sh -s dungeo` before testing
- **wt-13 testing**: Run full chain after build to verify balloon descent timing and route
- **Wire disambiguation**: Even after the platform fix, `tie wire` will still need disambiguation — may need to use `tie braided wire` in the transcript, or the game may auto-resolve based on context (the braided wire is the one that makes sense for tying)

## Files Modified

**Platform** (1 file):
- `packages/text-service/src/text-service.ts` — Skip `client.query` events in `tryProcessDomainEventMessage` to fix disambiguation rendering

**Walkthroughs** (1 file):
- `stories/dungeo/walkthroughs/wt-13-volcano-balloon.transcript` — Replaced 2 `$teleport` commands with real navigation (6 + 25 commands), added missing assertion

## Notes

**Balloon daemon timing**: Daemon fires every 3 turns. After untying, the first level change happens on the same turn (ledg4→vair4). Then every 3 waits triggers the next descent. 4 remaining levels × 3 waits = 12 wait commands total.

**Descent messages**: "The balloon sinks slowly." for mid-air, "The balloon settles to the ground." for landing at Volcano Bottom.

---

**Progressive update**: 2026-02-16 ~00:15 CST
