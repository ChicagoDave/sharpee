# Session Summary: 2026-02-17 - main (CST)

## Status: Research & Planning Complete

## Goals
- Audit the existing endgame implementation for correctness and completeness
- Cross-reference against FORTRAN source to identify deviations and bugs
- Produce a comprehensive integration and completion plan for the endgame

---

## Completed

### Endgame Implementation Audit

Reviewed approximately 15 source files to assess the current state of the Dungeo endgame:

- `stories/dungeo/src/regions/endgame.ts` — 14 rooms, all objects
- `stories/dungeo/src/handlers/endgame-trigger-handler.ts` — Crypt darkness trigger
- `stories/dungeo/src/handlers/endgame-laser-handler.ts` — Laser beam break mechanic
- `stories/dungeo/src/handlers/inside-mirror-handler.ts` — Mirror box puzzle
- `stories/dungeo/src/state-machines/victory-machine.ts` — Victory scoring
- `stories/dungeo/src/npcs/dungeon-master/` — DM NPC behavior, trivia, set dial
- `stories/dungeo/src/actions/` — KNOCK, ANSWER, SET DIAL, PUSH DIAL BUTTON, LIFT/LOWER/PUSH PANEL
- `stories/dungeo/tests/transcripts/endgame-*.transcript` — 7 unit tests
- `stories/dungeo/tests/transcripts/tomb-crypt-navigation.transcript` — Tomb nav test

### FORTRAN Source Cross-Reference

Consulted the canonical FORTRAN source in `docs/dungeon-81/mdlzork_810722/`:

- `clockr.for` — CEV20 (endgame trigger daemon), CEV12 (lamp timer)
- `nrooms.for` — Room topology, Parapet/Prison/Treasury connections
- `sverbs.for` — GDT commands (TQ, DL, etc.)
- `actors.for` — Thief daemon, THFACT flag
- `objects.for` / `dinit.for` — Initial object state including mirror direction (MDIR=270)

### Endgame Plan Document Written

Authored `docs/work/dungeo/endgame-plan.md` — a complete integration and completion plan. This replaces the old design document (which was written before implementation). The new plan focuses on:

- Current state: 7 unit tests passing in isolation
- 4 critical bugs blocking end-to-end play
- 3 missing room connections
- FORTRAN accuracy improvements (optional)
- wt-17 walkthrough route with step-by-step commands
- 4-phase implementation order
- Scoring reference and discrepancy analysis
- File impact summary and risk assessment

---

## Key Decisions

### 1. Bug Prioritization Order

Bugs are ordered by walkthrough impact: trigger (entry) → button (laser) → scoring (points) → inventory (FORTRAN fidelity). The first two are absolute blockers; the second two affect score correctness.

### 2. Crypt Trigger Fix: Option A (FORTRAN-Accurate)

Recommendation is to remove the missing `crypt door` entity check entirely rather than creating a new entity. The FORTRAN source (`clockr.for` CEV20) has no door condition — only player-in-Tomb + darkness + 3 wait turns. This simplifies the fix and matches canonical behavior.

### 3. Scoring Discrepancy Flagged

The plan notes an unresolved question: the victory handler has a `?? 616` hardcoded default for main score. The actual max is 650 (616 FORTRAN base + 34 canvas puzzle points from ADR-078). This needs verification during integration testing rather than guessing now.

### 4. Trivia Walkthrough Strategy

Noted that trivia questions are random, making a deterministic transcript tricky. The plan identifies the GDT `tq reset` command as the mechanism for forcing a known question state during walkthrough recording.

---

## Critical Bugs Identified

| # | Bug | Severity | Root Cause |
|---|-----|----------|-----------|
| 1 | Crypt door entity missing — endgame trigger never fires naturally | Critical | `isCryptDoorClosed()` searches for non-existent entity; always returns false; INCANT cheat bypasses this |
| 2 | Stone button push blocked by SceneryTrait — laser puzzle incomplete | High | `SceneryTrait` blocks stdlib push action before `if.event.pushed` is emitted |
| 3 | 50 of 100 endgame points never awarded | High | Three milestone rooms have no scoring handler; victory handler uses `?? 65` default masking the gap |
| 4 | Inventory not stripped on endgame entry | Medium | `triggerEndgame()` only gives sword; doesn't strip inventory, give lamp, or reset lamp timer |

## Missing Features Identified

| # | Missing Feature | Impact |
|---|----------------|--------|
| 1 | Parapet → Prison Cell DOWN exit not created on dial button push | Walkthrough blocked |
| 2 | Prison Cell → Treasury SOUTH exit not created when bronze door opens | Walkthrough blocked |
| 3 | Thief not disabled when endgame starts (FORTRAN: `THFACT=.FALSE.`) | Interference during endgame |

---

## Open Items

### Short Term (next session — implementation)
- Fix Bug 1: Remove crypt door check from `endgame-trigger-handler.ts`, reduce TURNS_REQUIRED from 15 to 3
- Fix Bug 2: Remove `SceneryTrait` from stone button OR add custom push handler
- Fix Bug 3: Create `src/handlers/endgame-scoring-handler.ts` for room-entry milestone scoring
- Fix Bug 4: Strip inventory and give lamp + sword with 350-turn reset in `triggerEndgame()`
- Feature 1+2: Create exits from Parapet → Prison Cell and Prison Cell → Treasury at correct trigger points
- Feature 3: Add endgame guard to thief daemon
- Build and run all 7 unit transcripts to verify no regressions
- Interactive play-through via `--play` to test full sequence
- Write `walkthroughs/wt-17-endgame.transcript`

### Long Term (optional polish)
- Match FORTRAN initial mirror state (MDIR=270/West, position=1)
- Implement pine door mechanic (timed, guardian room danger)
- Reduce endgame trigger to 3 turns (currently 15)
- DM multi-hop following behavior

---

## Files Modified

**Documentation only** (1 file):
- `docs/work/dungeo/endgame-plan.md` — New comprehensive integration/completion plan (replaces old design doc)

No code changes this session.

---

## Architectural Notes

### Why 7 Unit Tests Pass But End-to-End Is Broken

Each unit test uses the `GDT` cheat system (INCANT or direct teleport) to set up isolated puzzle state. This bypasses the endgame trigger entirely. The bugs in the trigger, scoring pipeline, and room connections are invisible to unit tests but break the natural play path.

This is a good reminder: unit tests passing in isolation does not guarantee integration correctness. The wt-17 walkthrough will be the first true end-to-end test of the endgame.

### Scoring Pipeline Architecture

Endgame scoring uses a two-layer design:
1. `scoring.endgameScore` — accumulated in state as player hits milestones
2. `victory-machine.ts` — reads `scoring.endgameScore` and `scoring.score` at victory to compute final total

The bug is that three milestone rooms have no handler writing to `scoring.endgameScore`. The victory machine's `?? 65` fallback is masking this — the real value is 15 (only the trigger entry point is awarded), not 65.

### Stone Button and SceneryTrait Interaction

`SceneryTrait` causes the stdlib push action to short-circuit with "fixed in place" before emitting `if.event.pushed`. Any handler listening for that event never fires. The fix must either (a) remove SceneryTrait from pushable scenery items that are puzzle-interactive, or (b) make the push action emit the event before or independent of the SceneryTrait block.

---

## Notes

**Session duration**: ~2-3 hours

**Approach**: Read-only research. Traced code paths from game entry (Tomb darkness) through each puzzle stage to Treasury. Cross-referenced implementation against FORTRAN canonical source. No code was written or modified — the entire session produced one planning document.

**Artifacts**:
- `docs/work/dungeo/endgame-plan.md` — Primary output; actionable plan with specific file changes needed

---

**Progressive update**: Session completed 2026-02-17 ~21:00 CST
