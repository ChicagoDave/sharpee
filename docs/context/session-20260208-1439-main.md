# Session Summary: 2026-02-08 - main (2:39 PM CST)

## Status: Completed

## Goals
- Complete Phase 5 of thief-fight-plan: Thief Behavior Updates
- Replace ad-hoc combat AI with canonical MDL WINNING? function
- Implement fight/flee decision logic based on strength comparison
- Add thiefEngrossed attribute during egg opening (vulnerability window)

## Completed

### Phase 5: Thief Behavior Updates

Replaced ad-hoc thief combat AI with canonical MDL WINNING? function (melee.137:287-293) for accurate villain combat decisions.

#### 1. Canonical WINNING? Implementation

**Created `getThiefCombatDecision()` helper** in `thief-helpers.ts`:
- Replaces old `shouldEscalateToCombat()` function (was: score ≥ 150 + 30% chance)
- Uses `isVillainWinning()` from canonical melee engine
- Compares thief OSTRENGTH (5) vs hero fight-strength (2-7 based on weapons/wounds)
- Returns `{shouldAttack, shouldStay}` matching MDL probability tables:
  - **Early game** (hero 2-3 vs thief 5): PS > 0 → 75% attack, 85% stay (aggressive)
  - **Mid game** (hero 5 vs thief 5): PS = 0 → 50% attack, 30% stay (even match)
  - **Late game** (hero 6-7 vs thief 5): PS < 0, VS > 1 → 25% attack, 0% stay (cautious)

**Behavioral implications**:
- Thief correctly assesses fight-worthiness based on actual strength, not player score
- Probability-based decisions create dynamic combat (not deterministic)
- Thief will flee when outmatched (PS < 0, VS > 1) and stay away (shouldStay = 0%)

#### 2. Engrossed Attribute During Egg Opening

**Added `thiefEngrossed` flag** in `checkEggOpening()`:
- Set to `true` when thief is carrying the jeweled egg
- Cleared when egg is opened or thief no longer has egg
- Melee interceptor already reads this flag (caps thief strength at 2)
- Disengagement handler already clears it on combat exit

**Vulnerability window**:
- Thief OSTRENGTH drops from 5 → 2 while engrossed (hero 2-3 vs thief 2)
- Creates PS > 0 scenario where hero is dominant
- WINNING? decision will flip: thief now likely to flee (was aggressive)

#### 3. WINNING?-Based Fight/Flee in Combat

**Updated `handleFightingState()`** to use canonical decision logic:
- **Removed**:
  - `shouldFlee()` function (was: flee at 30% CombatantTrait health)
  - `FLEE_HEALTH_THRESHOLD` constant
  - Priority 2 flee check in `onTurn()` (was checking every turn regardless of state)
- **New logic**: Each turn in FIGHTING state:
  - Call `getThiefCombatDecision()` to get {shouldAttack, shouldStay}
  - `!shouldStay` → emit flee message + leave room (prefer lair exit) + transition to WANDERING
  - `shouldAttack` → attack player
  - `!shouldAttack && shouldStay` → hesitate (stay but don't attack)

**Combat dynamics**:
- Thief evaluates fight each turn (not just on HP threshold)
- Flee destination prefers lair exit (canonical hiding behavior)
- WANDERING state after flee (was: FLEEING state, now dead code)
- FLEEING state kept for save-game compatibility but never entered

#### 4. Fixed `getPlayerScore()` API Usage

**Corrected scoring capability access**:
- **Before**: `(world as any).getCapability?.('scoring')`
- **After**: `world.getCapability(StandardCapabilities.SCORING)`
- Uses proper typed API from `@sharpee/engine`
- No functional change, just cleaner code

### Testing

**Test Results**:
- Full walkthrough chain: 216 pass / 6 skip (1103ms)
- No regressions from Phase 5 changes
- Build clean, bundle 2.1M

**Note**: No new transcript for Phase 5 (behavior changes probabilistic, hard to test deterministically). Existing walkthroughs exercise thief combat (wt-05-thief-fight.transcript).

## Key Decisions

### 1. Canonical WINNING? Over HP Threshold

**Decision**: Replace HP-based flee logic with canonical WINNING? strength comparison.

**Rationale**:
- MDL Zork uses WINNING? (melee.137:287-293) for all villain combat decisions
- HP-based threshold (30%) was arbitrary and didn't account for player strength
- WINNING? creates dynamic combat: thief flees when outmatched, not just when wounded
- Engrossed vulnerability window now properly affects fight/flee decision

### 2. Remove Priority 2 Flee Check

**Decision**: Delete the Priority 2 flee check in `onTurn()` that ran every turn.

**Rationale**:
- Was checking `shouldFlee()` every turn regardless of thief state
- Redundant with FIGHTING state's flee check
- Created potential double-flee (once from Priority 2, once from handleFightingState)
- FIGHTING state is the correct place for combat decisions

### 3. Keep FLEEING State for Save Compatibility

**Decision**: Keep FLEEING state enum value but never enter it.

**Rationale**:
- Old save games may have thief in FLEEING state
- Removing enum would break save deserialization
- State is now dead code (thief goes FIGHTING → WANDERING on flee)
- Will clean up in future save format migration

### 4. Engrossed Flag in Attributes

**Decision**: Store `thiefEngrossed` in `npc.attributes` (not trait).

**Rationale**:
- Short-lived flag (only during egg opening)
- No need for trait infrastructure (behaviors, serialization)
- Melee interceptor and disengagement handler already read from attributes
- Consistent with other temporary combat flags

## Open Items

### Short Term

**Phase 6: DIAGNOSE Command Verification** (next session)
- Compare DIAGNOSE output against canonical MDL text
- Verify wound severity thresholds match original game
- Test edge cases (zero wounds, fatal wounds, partial healing)

**Phase 7: Troll Integration**
- Verify troll uses canonical melee tables
- Test troll disengagement (player flees from troll room)
- Clean up troll capability declaration (ISSUE-051)

**ISSUE-051**: TrollTrait capability declaration stale
- Logged in `docs/work/issues/issues-list-03.md`
- Cosmetic stderr warning (functionality unaffected)
- Needs cleanup: remove stale capability declaration from troll-trait.ts

### Long Term

**Villain Counterattack Routing**
- NPC behavior attacks currently go through CombatService (generic HP damage)
- Melee engine attacks go through interceptor (canonical OSTRENGTH tables)
- Should villain counterattacks use melee engine? (out of Phase 5 scope)

**Save Format Migration**
- Remove FLEEING state enum (dead code after Phase 5)
- Clean up deprecated CombatantTrait.currentHp (melee uses meleeWoundAdjust)
- Document save compatibility breakage window

## Files Modified

### Modified Files (2 + 1 issues):

**Thief behavior**:
- `stories/dungeo/src/npcs/thief/thief-helpers.ts` — Replace `shouldEscalateToCombat()` with `getThiefCombatDecision()`, add `getThiefOstrength()`, `getHeroFightStrength()`, fix `getPlayerScore()` API
- `stories/dungeo/src/npcs/thief/thief-behavior.ts` — Add `thiefEngrossed` flag in `checkEggOpening()`, use WINNING? fight/flee in `handleFightingState()`, remove `shouldFlee()` + `FLEE_HEALTH_THRESHOLD`, remove Priority 2 flee check

**Issue tracking**:
- `docs/work/issues/issues-list-03.md` — Add ISSUE-051 (TrollTrait capability declaration stale)

## Architectural Notes

### WINNING? Decision Pattern

The canonical WINNING? function (melee.137:287-293) provides a clean pattern for villain combat AI:

```typescript
// Get relative strength comparison
const decision = getThiefCombatDecision(world, playerId, thiefId);

// Three outcomes based on WINNING? probabilities
if (!decision.shouldStay) {
  // Outmatched → flee
} else if (decision.shouldAttack) {
  // Confident → attack
} else {
  // Uncertain → hesitate
}
```

**Key insight**: Combat decisions are based on **strength comparison** (hero fight-strength vs villain OSTRENGTH), not HP/damage taken. This creates more realistic combat where villains flee when facing superior opponents, not just when wounded.

### Engrossed Vulnerability Window

The thiefEngrossed flag demonstrates how temporary combat modifiers integrate with melee system:

1. **Story sets flag**: `npc.attributes.thiefEngrossed = true` (egg opening)
2. **Interceptor applies modifier**: Caps thief strength at 2 (vs base 5)
3. **WINNING? reacts**: Strength comparison flips, thief likely to flee
4. **Cleanup**: Disengagement handler clears flag on combat exit

This pattern is reusable for other temporary debuffs (poison, exhaustion, distraction).

### Fight/Flee State Machine

Thief combat now follows a cleaner state machine:

```
WANDERING → [sees player with treasure] → FIGHTING
FIGHTING → [WINNING? says flee] → WANDERING (+ move to new room)
FIGHTING → [player defeated] → WANDERING (+ thief has treasure)
```

**Removed dead path**:
```
FIGHTING → [HP < 30%] → FLEEING
FLEEING → [HP > 80%] → WANDERING (re-engage)
```

FLEEING state is now unreachable (kept for save compatibility).

## Thief Fight Plan Progress

| Phase | Status | Description |
|-------|--------|-------------|
| Phase 1 | ✅ COMPLETE | Canonical melee engine (OSTRENGTH tables, stagger, unconscious, wounds) |
| Phase 2 | ✅ COMPLETE | Melee messages (villain attacks, stagger, unconscious, death) |
| Phase 3 | ✅ COMPLETE | Melee interceptor (attack action integration, turn-by-turn combat) |
| Phase 4 | ✅ COMPLETE | Disengagement + healing (flee-and-recover, CURE-CLOCK daemon) |
| Phase 5 | ✅ COMPLETE | Thief behavior (WINNING? function, engrossed flag, fight/flee AI) |
| Phase 6 | ⏳ PENDING | DIAGNOSE command verification (canonical text, edge cases) |
| Phase 7 | ⏳ PENDING | Troll integration (canonical tables, disengagement testing) |

## Notes

**Session duration**: ~1 hour

**Approach**: Focused refactoring session replacing ad-hoc combat AI with canonical WINNING? logic. Kept changes minimal (2 files + 1 issue) to avoid regression risk. Dead code (FLEEING state, Priority 2 flee check) identified but kept for save compatibility.

**Platform Changes**: Zero. All changes are story-level (Dungeo thief behavior).

**Build Performance**: Bundle size 2.1M, load time ~182ms, 9-walkthrough chain completes in ~1103ms (no regressions).

**Next Steps**: Phase 6 (DIAGNOSE verification) can be done independently. Phase 7 (troll integration) is already partially complete (troll uses melee interceptor from Phase 3).

---

**Progressive update**: Session completed 2026-02-08 2:39 PM CST
