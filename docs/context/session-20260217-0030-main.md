# Session Summary: 2026-02-17 - main (CST)

## Status: In Progress (context getting low)

## Goals
- Fix wt-14-royal-puzzle.transcript errors (missing assertions in IF blocks)
- Remove GDT (Game Debugging Tool) cheating from walkthrough — walkthroughs are play-testing, not developer shortcuts
- Investigate thief forbidden rooms in MDL source
- Investigate gold card take failure (ENTITY_NOT_FOUND)

## Completed

### Fixed Missing Assertions in wt-14 IF Blocks

Lines 59 and 101 had commands inside `[IF]` blocks without `[OK: ...]` assertions, which is a transcript syntax error. Added `[OK: contains "gold card"]` and `[OK: contains "card"]` respectively to satisfy the transcript tester.

### MDL Source Research: Thief Movement Mechanism

Researched thief movement in `act1.mud:1233-1246`.

Key finding: **The thief does NOT wander randomly**. In MDL, the thief cycles through ALL rooms in a fixed order (the global `,ROOMS` list). Rooms are skipped if they have `RSACREDBIT`, `RENDGAME`, or lack `RLANDBIT`.

Puzzle room analysis:
- CP (Room in a Puzzle) has `RLANDBIT + RLIGHTBIT`, no `RSACREDBIT` — thief CAN enter
- CPOUT (Side Room) has no `RLANDBIT` — thief SKIPS this room

Initially added puzzle rooms to `forbiddenRooms` in `orchestration/index.ts` based on incorrect assumption. User correctly flagged this as "GenAI making an assumption." The change was reverted immediately after confirming against MDL source.

Our implementation uses random wandering via `getAvailableExits()` — this is a significant behavioral difference from MDL's fixed room-list cycling. Not fixed this session but documented.

### CRITICAL BUG FOUND: Card Detection Logic is Wrong

Compared our royal puzzle implementation against MDL source (`dung.mud:3110-3188`) and found a fundamental error in card placement and detection.

**What MDL actually does:**
- Grid value `-3` = "bad ladder" (a pushable wall that looks like a ladder but cannot be climbed). Documented at `dung.mud:3186-3188`.
- The gold card entity lives at `CPOBJS[37]` (1-based) = **position 36 (0-based)**, which is the grid cell with value `-1` (movable sandstone wall).
- When the player pushes the wall at position 36 aside and moves into that position, `CPGOTO` loads the card from `CPOBJS` into the current room.
- The card is takeable when the player **is standing at position 36**, not when they are adjacent to position 33.
- `CPOBJS` is a separate 64-element array tracking which objects exist at each grid position — completely independent of the grid values in `CPUVEC`.

**Our implementation errors:**
- We treat grid value `-3` as `CARD_BLOCK` at position 33 — it should be `BAD_LADDER` (just a wall type, not a card marker).
- We detect the card by adjacency to the `-3` cell at position 33 — should detect by player being at position 36.
- The `isAdjacentToCard()` function is wrong — should be `isAtCardPosition()`.
- The `takeCard()` function converts `CARD_BLOCK` to `SANDSTONE` — unnecessary since -3 is just a wall type.
- The command transformer intercepts TAKE CARD based on adjacency — wrong trigger condition entirely.

**Why the walkthrough fails:**
- The canonical solution (from published walkthrough guides) expects the card to appear when player is at position 36.
- After "Push south wall" from position 28, the sandstone at 36 slides to 44, and the player steps to 36.
- At position 36, the card should appear — but our code checks adjacency to position 33 instead.
- Additionally, when the thief steals the card entity, command validation (ENTITY_NOT_FOUND) fires before the puzzle command transformer can intercept — a command pipeline ordering problem.

### Also Discovered: Missing Second Exit Path

MDL source has a second exit from the puzzle that we do not implement at all:
- Position 52 (1-based) / 51 (0-based) has a slot (`CPSLT`) and steel door (`CPDOR`).
- Player can insert the gold card into the slot to open the steel door.
- Going west from position 52 exits to CPOUT (Side Room) when door is open.

## Key Decisions

### 1. Don't Assume — Check MDL Source First

The thief forbidden-rooms change was reverted after user correctly pointed out it was an assumption without MDL backing. The correct workflow is: read the MDL source, then implement. Not: implement what seems logical, then check.

### 2. Thief Path is Fixed, Not Random

MDL thief cycles through the room list sequentially. Our random wandering is a known behavioral divergence. The right fix is to reorder the thief daemon to follow the MDL room list — noted for future work, not attempted this session.

## Open Items

### Short Term (blocks walkthrough)
1. Fix card detection logic in `royal-puzzle.ts`: change from adjacency-based (checking position 33) to position-based (checking position 36)
2. Rename `CARD_BLOCK` constant to `BAD_LADDER` — -3 is "bad ladder", not a card marker
3. Add `CARD_POSITION` constant (value 36, 0-based) where the card entity should appear
4. Fix puzzle handler command transformer: intercept TAKE CARD when player is at card position, not adjacent to -3 cell
5. Rewrite wt-14 walkthrough: replace GDT commands with canonical puzzle solution (49 commands from published walkthrough guides)
6. Fix command pipeline ordering: entity validation fires before puzzle command transformer — TAKE CARD fails with ENTITY_NOT_FOUND when card entity has been stolen by thief

### Future Work
- Implement `CPOBJS` dual-array system: MDL tracks per-position objects separately from grid values
- Implement second exit: slot at position 51, steel door, card insertion mechanism
- Fix thief movement: change from random wandering to fixed room-list cycling (matches MDL)
- Bad ladder interaction: position 33 should have "bad ladder" behavior (can push, but climbing attempt produces a failure message)

## Files Modified

**Walkthrough** (1 file):
- `stories/dungeo/walkthroughs/wt-14-royal-puzzle.transcript` — Added missing `[OK: ...]` assertions in two IF blocks (lines 59 and 101)

**Reverted (no net change)**:
- `stories/dungeo/src/orchestration/index.ts` — Briefly added puzzle rooms to forbidden list, then reverted after MDL source confirmed thief is allowed in puzzle rooms

## Architectural Notes

### MDL Dual Data Structure for the Royal Puzzle

The MDL puzzle uses two parallel 64-element arrays:
- `CPUVEC`: grid values (wall types: 0=empty, 1=fixed wall, -1=movable sandstone, -2=working ladder, -3=bad ladder)
- `CPOBJS`: object entities at each grid position

When `CPGOTO` moves the player to a new grid position, the room's object list is swapped with `CPOBJS[position]`. Objects are position-specific and appear/disappear as the player moves through the grid. Our implementation places the card entity directly in the room and uses adjacency detection — a simpler but incorrect model.

The canonical solution path enters at position 9 (0-based) and navigates to position 36 to pick up the card:
```
Down, Push east wall, South, Southwest, Push south wall, East, East,
Push south wall, North, North, East, Push south wall, Take card,
Push south wall, East, Northeast, Push west wall (x4), Northeast (x2),
North, Push east wall, Southwest, South, Southeast, Northeast, North,
Push west wall, Northwest, Push south wall (x2), West, Northwest (x2),
Push south wall, Southeast (x3), Northeast, Push west wall (x2),
Southwest, Push north wall (x3), Northwest, Up
```

### Grid Reference Confirmed Correct

The `INITIAL_GRID` array in our implementation matches the MDL `CPUVEC` exactly after 1-based to 0-based conversion. Only the interpretation of `-3` and the card placement logic are wrong — the grid data itself is faithful to the source.

## Notes

**Session duration**: ~2 hours

**Approach**: Transcript error triage first; then MDL source research to understand the correct mechanics before touching implementation code. Reverted one incorrect change that was made before checking source.

---

**Progressive update**: Session in progress, 2026-02-17 00:30 CST
