# Session Summary: 2026-01-30 - main

## Status: Complete

## Goals
- Fix Zifmia runner's platform.js to produce real ESM named exports (browser import map compatibility)
- Establish dual build system supporting both CJS (CLI/tests) and ESM (browser/Tauri) from same TypeScript source
- Prerequisites for Tauri desktop client (priority #1) and web runner (priority #2)

## Completed

### 1. Root Cause Analysis
**Problem**: platform.js (runner's ESM bundle) had 0 `export` statements despite `--format=esm` flag
- **Cause**: `tsconfig.base.json` had `"module": "commonjs"` — tsc emits CJS, esbuild just wraps it
- **Discovery**: Changing base to `"module": "ES2022"` fixed ESM exports but broke Node.js CLI (ESM doesn't allow directory imports like `export * from './entities'` without `/index.js`)

### 2. Dual TSConfig Architecture
Created parallel build system allowing CJS and ESM from same source:

**New Configuration Files** (19 total):
- `tsconfig.base-esm.json` — ES2022/bundler module settings (mirrors base but ESM)
- 13 platform packages: `packages/{core,if-domain,world-model,event-processor,lang-en-us,parser-en-us,if-services,text-blocks,text-service,stdlib,engine,sharpee,transcript-tester}/tsconfig.esm.json`
- 4 plugin packages: `packages/{plugins,plugin-npc,plugin-scheduler,plugin-state-machine}/tsconfig.esm.json`
- 1 story: `stories/dungeo/tsconfig.esm.json`

**Each ESM tsconfig**:
```json
{
  "extends": "../../tsconfig.base-esm.json",
  "compilerOptions": {
    "outDir": "./dist-esm",
    "rootDir": "./src"
  },
  "include": ["src/**/*"]
}
```

### 3. Build System Updates
**Modified `build.sh`**:
- Added conditional ESM build pass after CJS build (only runs when `--runner`, `--client`, or story bundle requested)
- Added plugin packages to ESM build sequence
- Changed platform.js entry to use direct `dist-esm/` paths instead of bare `@sharpee/*` specifiers
  - Reason: pnpm's `.pnpm/` store contains package copies without `dist-esm/` folders, breaking conditional exports

**Platform.js entry point** (direct paths bypass pnpm resolution):
```typescript
// Before (bare specifiers failed)
import { WorldModel } from '@sharpee/world-model';

// After (absolute dist-esm paths work)
import { WorldModel } from '/abs/path/packages/world-model/dist-esm/index.js';
```

### 4. Package.json Conditional Exports
Updated 13 platform packages with conditional exports:
```json
{
  "main": "./dist/index.js",
  "types": "./dist/index.d.ts",
  "exports": {
    ".": {
      "import": "./dist-esm/index.js",
      "require": "./dist/index.js",
      "types": "./dist/index.d.ts"
    }
  }
}
```

### 5. Successful Builds
- ✅ `./build.sh -s dungeo` — CJS-only build passes, CLI works (34/35 walkthrough success)
- ✅ `./build.sh --runner -s dungeo` — Full build with ESM pass succeeds
- ✅ All 17 ESM tsconfigs compile without errors
- ✅ platform.js built: 761KB (down from 1.3MB — ESM tree-shakes better)
- ✅ runner.js built: 854KB

## Key Decisions

### 1. Two TSConfigs Per Package, Not Dual Compilation by Default
**Decision**: ESM build only runs when browser targets requested via `--runner`, `--client`, or story bundle flags.

**Rationale**:
- CJS is sufficient for CLI/testing (90% of current dev workflow)
- ESM compilation adds ~30% to build time
- Explicit flags align with priority: Tauri > Web > CLI

**Alternative Considered**: Always run dual build — rejected due to unnecessary overhead for CLI-only work.

### 2. Direct Paths in Platform Entry, Not Bare Specifiers
**Decision**: platform.js uses absolute `/path/to/packages/*/dist-esm/index.js` instead of `@sharpee/*`.

**Rationale**:
- pnpm's `.pnpm/` store contains package copies without `dist-esm/` folders
- Conditional exports fail because symlinks resolve to store copies, not workspace originals
- Direct paths bypass package resolution entirely

**Alternative Considered**: Post-install script to copy `dist-esm/` to store — rejected as too invasive.

### 3. Reverted All Single-TSConfig Attempts
**Decision**: Started fresh from CJS baseline, layered ESM on top.

**Rationale**:
- Attempted hacks (bundle story as .cjs, change distPath references) created whack-a-mole issues
- Clean separation of concerns: CJS for Node.js, ESM for browsers
- Easier to debug when builds are independent

## Challenges Encountered

### 1. ESM Directory Import Restrictions
**Problem**: ESM requires explicit `/index.js` in imports; CJS allows directory imports.
```typescript
// CJS (works)
export * from './entities';

// ESM (fails)
export * from './entities';  // Error: must be './entities/index.js'
```

**Resolution**: Dual tsconfigs — CJS config keeps directory imports, ESM config uses bundler mode (esbuild resolves at bundle time).

### 2. pnpm Store Doesn't Contain dist-esm
**Problem**: Conditional exports in package.json don't work because pnpm's `.pnpm/` symlinks point to copies without `dist-esm/`.

**Resolution**: Platform.js uses direct file paths, bypassing package resolution entirely. Future enhancement: explore pnpm workspace: protocol.

### 3. Build System Complexity
**Problem**: Need to coordinate 17+ packages, some with circular refs, in correct order for ESM.

**Resolution**: Used same dependency order as CJS build; esbuild bundles handle circular refs at bundle time.

## Test Coverage

### All Verification Complete ✅
- ✅ CLI functionality: `node dist/sharpee.js --play` works
- ✅ Walkthrough tests: 34/35 passing (1 failure is pre-existing combat randomness)
- ✅ Build reproducibility: Clean rebuild produces identical output
- ✅ **platform.js ESM exports**: Verified hundreds of named exports (WorldModel, EventProcessor, Parser, etc.)
  - Output: `export{da as ActionContext, dt as ActionPhase, ... }` (real ESM, not CJS wrapper)
- ✅ **Browser runner**: Successfully loads and runs dungeo.sharpee bundle
  - Served via `python -m http.server` from dist/
  - Runner loaded platform.js, resolved import map, instantiated game
- ✅ **Import map resolution**: dungeo.sharpee successfully resolves all `@sharpee/*` imports via platform.js
  - Verified: @sharpee/world-model, @sharpee/engine, @sharpee/stdlib, etc.
- ✅ **Story bundle format**: dungeo.sharpee correctly packaged with metadata and importmap

## Open Items

### Short Term (Next Session - Unblocked!)
1. **Tauri desktop client** — Priority #1 now unblocked by working ESM platform.js
2. **Web runner UI** — Priority #2 (browser runner works, needs UI polish)
3. **Document dual-build pattern** — ADR explaining when/why to use ESM vs CJS

### Medium Term (This Sprint)
4. **Optimize build performance** — Investigate parallel tsc compilation for ESM packages
5. **Story bundle versioning** — Add version compatibility checks to .sharpee format
6. **Runner state persistence** — Save/restore game state in browser

### Long Term (Future Sprints)
7. **pnpm workspace: protocol** — Investigate cleaner solution than direct paths
8. **Unified package.json exports** — When Node.js ESM adoption is complete
9. **Incremental ESM builds** — Only rebuild changed packages

## Files Modified

### Configuration (20 files)
**New**:
- `tsconfig.base-esm.json` — ESM base configuration
- `packages/*/tsconfig.esm.json` (17 files) — Per-package ESM configs
  - Platform: core, if-domain, world-model, event-processor, lang-en-us, parser-en-us, if-services, text-blocks, text-service, stdlib, engine, sharpee, transcript-tester
  - Plugins: plugins, plugin-npc, plugin-scheduler, plugin-state-machine
- `stories/dungeo/tsconfig.esm.json` — Story ESM config

**Modified**:
- `build.sh` — Added ESM build pass, plugin packages, direct paths in platform entry
- `.gitignore` — Added `dist-esm/` exclusion
- `packages/*/package.json` (13 files) — Added conditional exports

### Build Outputs (not committed)
- `packages/*/dist-esm/` — ESM-compiled TypeScript
- `dist/platform.js` — 761KB ESM bundle (down from 1.3MB)
- `dist/runner.js` — 854KB runner bundle

## Architectural Notes

### Build System Flow
```
CJS Build (always):
  tsconfig.base.json (module: commonjs)
    ↓
  packages/*/tsconfig.json
    ↓
  packages/*/dist/ (CJS + .d.ts)
    ↓
  esbuild (CLI bundle) → dist/sharpee.js

ESM Build (when --runner/--client/story):
  tsconfig.base-esm.json (module: ES2022, moduleResolution: bundler)
    ↓
  packages/*/tsconfig.esm.json
    ↓
  packages/*/dist-esm/ (ESM .js, no .d.ts needed)
    ↓
  esbuild (browser bundles) → dist/platform.js, dist/runner.js
```

### Module Resolution Strategy
- **CJS (Node.js)**: Uses `node` resolution, allows directory imports
- **ESM (Browser)**: Uses `bundler` resolution, esbuild resolves at bundle time
- **Direct paths in entry**: Bypass package.json resolution issues with pnpm store

### Why Not Single Module Format?
- **ESM everywhere**: Breaks Node.js CLI (directory import restrictions, dynamic require issues)
- **CJS everywhere**: esbuild can't tree-shake, produces import shims instead of real exports
- **Dual build**: Best of both — native CJS for Node.js, native ESM for browsers

## Notes

**Session duration**: ~4.5 hours

**Approach**: Methodical refactoring from CJS baseline, adding ESM as parallel track. Avoided premature optimization; focused on correctness first. Continued through verification to ensure all components working end-to-end.

**Build size improvements**: Platform bundle 43% smaller (1.3MB → 761KB) due to ESM tree-shaking.

**Priority alignment**: This work directly unblocks Tauri desktop client (priority #1) and web runner (priority #2). Zifmia Phases 1-3 are now functionally complete.

**Completion status**: All verification steps completed successfully. Browser runner confirmed working with dungeo.sharpee bundle. ESM exports validated. CLI/walkthroughs passing.

## Summary

This session successfully established dual-build CJS/ESM architecture for Sharpee, solving the root cause of platform.js having zero ESM exports. The fix required:

1. **Root cause**: tsconfig.base.json forced CJS output; esbuild wrapped it instead of producing real ESM
2. **Solution**: Created 19 tsconfig.esm.json files enabling true ESM output alongside CJS
3. **Results**:
   - platform.js now exports hundreds of named symbols (WorldModel, EventProcessor, Parser, etc.)
   - 43% smaller bundle (761KB vs 1.3MB) via ESM tree-shaking
   - Browser runner successfully loads and runs dungeo.sharpee
   - Import map resolution confirmed working
   - CLI/tests unaffected (34/35 walkthroughs passing)

This completes **Zifmia Phases 1-3** (story bundle format, runner, import map resolution) and directly unblocks:
- **Priority #1**: Tauri desktop client (needs working ESM platform.js)
- **Priority #2**: Web runner (browser loading now verified)

---

**Progressive update**: Session completed 2026-01-30 ~07:00 UTC
