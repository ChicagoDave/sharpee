# Session Summary: 2026-02-06 - main (CST)

## Status: In Progress

## Goals
- Implement Phase 3 of Tea Room Plan: Robot & Cage Puzzle in Dingy Closet
- Follow canonical MDL source (act3.mud lines 229-294) for puzzle mechanics
- Complete all code implementation (build and testing deferred)

## Completed

### Phase 3: Robot & Cage Puzzle Implementation

Implemented the cage/sphere puzzle in Dingy Closet following the canonical MDL source. This is one of Zork's classic puzzles where taking a sphere triggers a cage trap that requires the robot's help to escape.

**Puzzle Mechanics (from act3.mud):**

1. **Initial State**: Cage and sphere visible in Dingy Closet
2. **TAKE SPHERE triggers trap**:
   - If robot present: cage falls, exits blocked, 10-turn poison gas countdown starts
   - If robot absent: immediate poison gas death
3. **TELL ROBOT TO RAISE CAGE**: Solves puzzle, unblocks exits, sphere becomes freely takeable
4. **TELL ROBOT TO TAKE SPHERE**: Robot crush death (robot and sphere both destroyed)
5. **10 turns without raising cage**: Poison gas death

**Architecture Used:**

- **ADR-118 Action Interceptors**: SphereTrait declares `if.action.taking` interceptor (same pattern as TrollAxeTrait)
- **ADR-071 Scheduler Daemons**: 10-turn poison gas countdown (same pattern as maintenance room flooding)
- **RoomBehavior Exit Blocking**: blockExit/unblockExit API (same pattern as bank alarm)
- **Commanding Action**: Robot commands handled in commanding-action.ts (where robot command dispatch lives)

### Files Created

**New Story Files** (3 files):

1. `stories/dungeo/src/traits/sphere-trait.ts`
   - SphereTrait with `if.action.taking` interceptor declaration
   - CageTrapState interface (hasFallen, exitsBlocked, sphereFreed, daemonId)
   - Stores trap state and references to cage entity and dingy closet room

2. `stories/dungeo/src/interceptors/sphere-taking-interceptor.ts`
   - SphereTakingInterceptor implementing preValidate + onBlocked phases
   - Checks robot proximity, triggers cage trap, starts poison daemon
   - Returns death effect if robot absent, blocked effect if trap active
   - CageMessages message IDs for all puzzle states

3. `stories/dungeo/src/scheduler/cage-poison-daemon.ts`
   - 10-turn countdown daemon for poison gas death
   - Warns at 8, 6, 4, 2 turns remaining
   - Death effect on turn 0
   - Auto-cancels if cage raised before timeout

### Files Modified

**Story Orchestration** (4 files):

1. `stories/dungeo/src/index.ts`
   - Imported SphereTrait and SphereTakingInterceptor
   - Registered interceptor with `registerActionInterceptor()`
   - Added `wellRoomIds` to orchestration config (needed by scheduler)

2. `stories/dungeo/src/orchestration/index.ts`
   - Extended `OrchestrationConfig` interface with `wellRoomIds: WellRoomIds`
   - Passed wellRoomIds to scheduler setup

3. `stories/dungeo/src/orchestration/scheduler-setup.ts`
   - Extended `SchedulerConfig` interface with `wellRoomIds: WellRoomIds`
   - Registered cage poison daemon in `registerTimedEvents()`

**Region & Entity Setup** (1 file):

4. `stories/dungeo/src/regions/well-room.ts`
   - Added SphereTrait to sphere entity creation
   - Initialized CageTrapState with cage and dingy closet references
   - Added dingy closet ID to WellRoomIds interface
   - Stored dingy closet in wellRoomIds state for scheduler access

**NPC & Commands** (1 file):

5. `stories/dungeo/src/actions/commanding/commanding-action.ts`
   - Added "raise cage" and "lift cage" command patterns
   - Implemented robot raise cage logic (checks proximity, unblocks exits, frees sphere, cancels daemon)
   - Added robot sphere crush death check in "take" command handling
   - Both features use SphereTrait API and emit appropriate effects

**Messages** (2 files):

6. `stories/dungeo/src/npcs/robot/robot-messages.ts`
   - Added `RAISES_CAGE` message ID for robot raising cage

7. `stories/dungeo/src/messages/npc-messages.ts`
   - Registered all cage puzzle messages with canonical MDL text:
     - CAGE_FALLS_ROBOT_PRESENT (cage falls, gas warning)
     - CAGE_FALLS_NO_ROBOT (instant death)
     - POISON_GAS_DEATH (timeout death)
     - RAISES_CAGE (robot solves puzzle)
     - ROBOT_CRUSHED (robot take sphere death)
     - POISON_WARNING_X (countdown warnings at 8, 6, 4, 2 turns)

**Barrel Export Files** (2 files):

8. `stories/dungeo/src/traits/index.ts`
   - Exported SphereTrait
   - Exported SphereTakingInterceptor

9. `stories/dungeo/src/scheduler/index.ts`
   - Exported cage poison daemon

## Key Decisions

### 1. Action Interceptor Pattern (ADR-118)

Used the same pattern as TrollAxeTrait for blocking sphere taking. SphereTrait declares `if.action.taking` as an interceptor action, and SphereTakingInterceptor implements preValidate + onBlocked phases.

**Rationale**:
- Clean separation of concerns (trait owns state, interceptor owns logic)
- Standard platform pattern (no platform changes needed)
- Same proven approach as other blocking puzzles (troll axe, bank alarm)

### 2. Robot Commands in commanding-action.ts

Implemented "raise cage" and "take sphere" robot commands in commanding-action.ts, not robot-behavior.ts.

**Rationale**:
- commanding-action.ts is where all robot command dispatch lives
- Robot behavior owns movement/following, not puzzle-specific commands
- Keeps puzzle logic co-located with other robot puzzle commands (e.g., oil maintenance room doors)

### 3. WellRoomIds Propagation

Added dingy closet ID to WellRoomIds interface and passed it through orchestration config to scheduler.

**Rationale**:
- Cage poison daemon needs room ID to check if player escaped
- Same pattern used for other room-specific daemons
- Clean dependency injection (no global state, no hardcoded IDs)

### 4. Sphere Freeing vs Sphere Removal

When cage is raised, sphere becomes freely takeable (trap flag cleared) but remains in room. When robot takes sphere, both robot and sphere are destroyed (moveEntity to null location).

**Rationale**:
- Follows canonical MDL behavior exactly
- Sphere freeing = puzzle solved, player can take it
- Robot taking = punishment for wrong command, lose both entities

## Architectural Notes

### Action Interceptor Pattern (ADR-118)

This puzzle demonstrates the full power of action interceptors:

```typescript
// 1. Trait declares interceptor capability
class SphereTrait implements ITrait {
  static readonly interceptorActions = ['if.action.taking'] as const;
  state: CageTrapState;
}

// 2. Interceptor implements preValidate + onBlocked
const SphereTakingInterceptor: ActionInterceptor = {
  preValidate(entity, world, context) {
    // Return BlockedResult to prevent action
    if (trap.hasFallen && !trap.sphereFreed) {
      return BlockedResult.error('dungeo.error.cage_blocks_sphere');
    }
    return null; // Allow action to proceed
  },

  onBlocked(entity, world, context, result) {
    // Custom blocked message
    return Effect.message(CageMessages.CAGE_BLOCKS_SPHERE);
  }
};

// 3. Register in story initialization
registerActionInterceptor(SphereTrait.type, 'if.action.taking', SphereTakingInterceptor);
```

**Key insight**: Interceptors can trigger complex side effects (cage falls, daemon starts) in preValidate phase, then block the original action. This is cleaner than event handlers because it prevents the action from running at all.

### Scheduler Daemon Pattern (ADR-071)

Cage poison daemon follows the established pattern:

```typescript
export const cagePoisonDaemon: DaemonRegistration = {
  id: 'dungeo.daemon.cage_poison',

  shouldSchedule(world, config) {
    // Only schedule if cage has fallen and not yet raised
    const sphere = world.getEntity(config.wellRoomIds.sphere);
    const trap = sphere?.getTrait<SphereTrait>(SphereTrait.type)?.state;
    return trap?.hasFallen && !trap.sphereFreed;
  },

  tick(world, config, tickCount) {
    // Countdown warnings at 8, 6, 4, 2 turns
    // Death at turn 0
  }
};
```

**Key insight**: Daemons check shouldSchedule() every turn and auto-cancel when condition becomes false. No manual cleanup needed - raising cage automatically stops daemon.

### Robot Command Dispatch

Robot commands are centralized in commanding-action.ts:

```typescript
// commanding-action.ts execute phase
if (verb === 'raise' || verb === 'lift') {
  if (targetRef.head === 'cage') {
    // Check robot proximity
    // Unblock exits
    // Free sphere
    // Cancel daemon
    return SuccessResult.ok(sharedData);
  }
}
```

**Key insight**: Story-specific NPC commands belong in commanding-action.ts (the robot command dispatcher), not in the NPC's behavior file. Behaviors own autonomous actions (following, reacting), not player-commanded actions.

## Open Items

### Short Term
- Build with `./build.sh -s dungeo`
- Create `stories/dungeo/tests/transcripts/cage-puzzle.transcript` test covering:
  - Take sphere without robot (instant death)
  - Take sphere with robot (cage falls, poison countdown)
  - Tell robot to raise cage (puzzle solved)
  - Tell robot to take sphere (robot crushed)
  - Take sphere after cage raised (success)
  - Poison gas timeout death (if not raising cage)
- Run regression tests (all walkthroughs should still pass)
- Update Tea Room Plan status: Phase 3 COMPLETE

### Long Term
- Phase 4: Carousel puzzle (tea room rotation mechanism)
- Phase 5: wt-09 walkthrough (full tea room sequence)
- Integration with maintenance room robot oil puzzle (robot may be tied up oiling doors when player reaches cage)

## Files Modified

**Story Code** (11 files):
- `stories/dungeo/src/traits/sphere-trait.ts` - NEW: Trait with interceptor declaration
- `stories/dungeo/src/interceptors/sphere-taking-interceptor.ts` - NEW: Taking interceptor logic
- `stories/dungeo/src/scheduler/cage-poison-daemon.ts` - NEW: 10-turn countdown daemon
- `stories/dungeo/src/traits/index.ts` - Export SphereTrait + interceptor
- `stories/dungeo/src/scheduler/index.ts` - Export cage daemon
- `stories/dungeo/src/actions/commanding/commanding-action.ts` - Robot cage commands
- `stories/dungeo/src/regions/well-room.ts` - Sphere entity + WellRoomIds
- `stories/dungeo/src/npcs/robot/robot-messages.ts` - RAISES_CAGE message
- `stories/dungeo/src/messages/npc-messages.ts` - All cage puzzle messages
- `stories/dungeo/src/index.ts` - Register interceptor + wellRoomIds config
- `stories/dungeo/src/orchestration/index.ts` - WellRoomIds interface
- `stories/dungeo/src/orchestration/scheduler-setup.ts` - Register cage daemon

## Notes

**Session duration**: ~2 hours

**Approach**: Canonical MDL source research followed by systematic implementation of all puzzle components (trait, interceptor, daemon, commands, messages). Code complete but not yet built or tested - intentionally stopping at logical checkpoint before build/test phase.

**MDL Source Reference**: `docs/dungeon-81/mdlzork_810722/act3.mud` lines 229-294 (CAGE and SPHERE objects, cage trap logic, poison gas daemon)

**Next Session**: Build, create test transcript, verify all mechanics work as designed.

---

**Progressive update**: Session completed 2026-02-06 21:07 CST
