# Session Summary: 2026-02-08 - main (12:59 AM CST)

## Status: Completed

## Goals
- Complete Phase 4 of thief-fight-plan: Combat Disengagement & Wound Healing
- Implement canonical MDL flee-and-recover mechanics
- Add CURE-CLOCK daemon for passive wound healing
- Update DIAGNOSE action to use canonical melee wound state

## Completed

### Phase 4a: Combat Disengagement Handler
Implemented event-driven villain recovery when player flees combat:

**Implementation**:
- Created `stories/dungeo/src/handlers/combat-disengagement-handler.ts`
- Event handler registered on `if.event.actor_moved`
- When player leaves a room containing an alive villain with active melee state:
  - Villain fully heals (OSTRENGTH restored to base from `getBaseOstrength()`)
  - Both stagger flags cleared (hero and villain)
  - Villain unconscious flag cleared
  - Thief engrossed flag cleared (`villainEngrossed`)
  - **Player wounds persist** — canonical asymmetric pressure design
- **Silent operation** — no message emitted (matches canonical MDL FLEE-FCN behavior)

**Key Design Decision**: Disengagement is asymmetric. Villains recover instantly and completely when player leaves the room, but player wounds persist and heal slowly via CURE-CLOCK. This creates the canonical "wounded player fleeing to heal" dynamic from Zork.

### Phase 4b: Cure Daemon (CURE-CLOCK)
Implemented passive wound healing daemon matching canonical MDL CURE-WAIT mechanics:

**Implementation**:
- Created `stories/dungeo/src/scheduler/cure-daemon.ts`
- Daemon ID: `dungeo.cure.daemon`, priority 5
- Heals 1 wound point per CURE_WAIT (30) turns
- Condition: only active when `meleeWoundAdjust < 0` (player is wounded)
- Tick counter stored in world state (`dungeo.cure.ticks`) for save/restore persistence
- Uses `healOneWound()` from canonical melee engine
- **Silent operation** — player checks status via DIAGNOSE command

**Technical Details**:
- Uses daemon (not fuse) for simpler re-arming across multiple healing cycles
- Tick counter in world state enables save/restore without re-triggering from zero
- Registered in `scheduler-setup.ts` during world initialization

### Shared State Extraction
Eliminated code duplication by extracting shared constants:

**Implementation**:
- Created `stories/dungeo/src/combat/melee-state.ts`
- Extracted from `melee-interceptor.ts`:
  - `MELEE_STATE` constants (flags, wound adjust, unconscious ticks)
  - `CURE_STATE` constants (tick counter)
  - `getBaseOstrength()` utility function
- Updated imports in:
  - `melee-interceptor.ts` — now imports shared constants
  - `combat-disengagement-handler.ts` — imports MELEE_STATE + getBaseOstrength()
  - `cure-daemon.ts` — imports MELEE_STATE + CURE_STATE
- Exported via `stories/dungeo/src/combat/index.ts`

**Rationale**: Three modules (interceptor, disengagement handler, cure daemon) all need access to the same world state keys and base strength calculation. Single source of truth prevents desync bugs.

### Diagnose Action Update
Replaced ad-hoc CombatantTrait HP logic with canonical melee wound state:

**Before**:
- Used CombatantTrait.currentHp / maxHp percentage ranges
- Generic "excellent/good/fair/poor" descriptions
- No connection to actual melee wound state

**After**:
- Uses `getDiagnosis()` from `melee.ts` with `meleeWoundAdjust`
- Reads cure daemon tick counter to calculate turns-to-heal
- Canonical MDL-style output:
  - "You have no wounds" (meleeWoundAdjust === 0)
  - "You have a light wound that will be cured in X turns"
  - "You have a serious wound that will be cured in X turns"
  - "You are in danger of dying from your injuries"

**Technical Details**:
- Wound depth calculated from `meleeWoundAdjust` (0, -1, -2, -3+)
- Turns-to-heal accounts for partial cure progress via `CURE_STATE.TICKS`
- Formula: `totalWounds - woundsHealed` where each wound = 30 turns

### Testing
Created comprehensive disengagement test transcript:

**File**: `stories/dungeo/src/tests/transcripts/combat-disengagement.transcript`

**Test Coverage**:
- Player enters room, engages troll in combat
- Player receives wounds (meleeWoundAdjust < 0)
- Player flees (GO NORTH)
- Verify player still wounded (via DIAGNOSE)
- Player re-enters room
- Verify troll is fully healed (can stagger player again)

**Test Results**:
- combat-disengagement.transcript: PASS
- Full walkthrough chain: 216 pass / 6 skip (no regressions)
- Build clean, bundle 2.1M, load time ~182ms

## Key Decisions

### 1. Silent Disengagement (No Message)
**Decision**: Combat disengagement handler emits no message when villain heals.

**Rationale**: Matches canonical MDL FLEE-FCN behavior. Villain recovery is "silent world state update" that player discovers upon re-entering the room. Message would be redundant (player already knows they fled) and breaks immersion (player isn't in the room to witness recovery).

### 2. Daemon vs Fuse for Cure
**Decision**: Use daemon (not fuse) for wound healing.

**Rationale**:
- Multiple wounds require multiple healing cycles
- Daemon with tick counter is simpler to re-arm than scheduling new fuses
- Tick counter in world state enables save/restore without losing healing progress
- Daemon condition (`meleeWoundAdjust < 0`) provides automatic activation/deactivation

### 3. Shared Constants Module
**Decision**: Extract MELEE_STATE/CURE_STATE to `melee-state.ts`.

**Rationale**:
- Three modules (interceptor, disengagement handler, cure daemon) need same world state keys
- String literal duplication risks typos and desync bugs
- Single source of truth makes key changes safer (compile-time errors vs runtime bugs)
- `getBaseOstrength()` logic shared between interceptor and disengagement handler

### 4. Canonical Diagnose Integration
**Decision**: Replace CombatantTrait HP logic with canonical melee wound state.

**Rationale**:
- CombatantTrait.currentHp is now deprecated (melee uses `meleeWoundAdjust`)
- Generic percentage-based descriptions don't match MDL Zork output
- `getDiagnosis()` from melee.ts provides canonical wound severity + healing time
- Cure daemon tick counter enables accurate "X turns to heal" calculation

## Open Items

### Short Term
**Phase 5: Thief Behavior Updates** (next session)
- Implement WINNING? function (check if thief can defeat player)
- Add fight/flee AI (flee when wounded, return when healed)
- Thief roaming behavior (re-enter room after fleeing)

**Phase 6: DIAGNOSE Command Verification**
- Compare DIAGNOSE output against canonical MDL text
- Verify wound severity thresholds match original game
- Test edge cases (zero wounds, fatal wounds, partial healing)

**Phase 7: Troll Integration**
- Verify troll uses canonical melee tables
- Test troll disengagement (player flees from troll room)
- Investigate troll `meleeOstrength` initialization (pre-existing from Phase 3)

### Long Term
**Melee System Completion**
- Add remaining villains (thief, cyclops) with canonical tables
- Implement weapon damage modifiers
- Add combat victory/defeat messages

**Save/Restore Testing**
- Verify cure daemon tick counter persists across save/restore
- Test disengagement state after restore (villain healed, player wounded)
- Verify melee state keys survive serialization

## Files Modified

### New Files (4):
- `stories/dungeo/src/combat/melee-state.ts` — Shared MELEE_STATE/CURE_STATE constants, getBaseOstrength()
- `stories/dungeo/src/handlers/combat-disengagement-handler.ts` — Event handler for villain recovery on flee
- `stories/dungeo/src/scheduler/cure-daemon.ts` — CURE-CLOCK wound healing daemon (30 turns/wound)
- `stories/dungeo/tests/transcripts/combat-disengagement.transcript` — Flee/re-enter test (player wounded, troll healed)

### Modified Files (6):
- `stories/dungeo/src/interceptors/melee-interceptor.ts` — Import from shared melee-state module (eliminate duplication)
- `stories/dungeo/src/combat/index.ts` — Export melee-state module
- `stories/dungeo/src/scheduler/index.ts` — Export cure daemon
- `stories/dungeo/src/orchestration/event-handlers.ts` — Register disengagement handler on if.event.actor_moved
- `stories/dungeo/src/orchestration/scheduler-setup.ts` — Register cure daemon (priority 5)
- `stories/dungeo/src/actions/diagnose/diagnose-action.ts` — Use canonical getDiagnosis() with meleeWoundAdjust

## Architectural Notes

### Combat Disengagement Pattern
The disengagement handler demonstrates a clean event-driven approach to cross-room combat state management:

1. **Event Source**: `if.event.actor_moved` (emitted by going action)
2. **Condition Check**: Old location contains alive villain with melee state
3. **State Mutation**: Reset villain state (full heal + clear flags)
4. **Silent Operation**: No message (player not present to witness)

This pattern is reusable for other "room exit triggers" (e.g., gas room, flood room).

### Daemon Tick Counter Pattern
The cure daemon uses a persistent tick counter in world state instead of fuse re-triggering:

```typescript
// Read tick counter from world state
const ticks = world.state.get(CURE_STATE.TICKS) ?? 0;

// Increment and check threshold
const newTicks = ticks + 1;
if (newTicks >= CURE_WAIT) {
  healOneWound(world, actorId);
  world.state.set(CURE_STATE.TICKS, 0); // Reset counter
} else {
  world.state.set(CURE_STATE.TICKS, newTicks); // Persist progress
}
```

**Benefits**:
- Survives save/restore without losing partial progress
- Simpler than fuse chain (no need to schedule new fuses)
- Daemon condition (`meleeWoundAdjust < 0`) provides automatic activation

### Shared State Module Pattern
Extract common world state keys to prevent string literal duplication:

```typescript
// melee-state.ts
export const MELEE_STATE = {
  WOUND_ADJUST: 'dungeo.melee.woundAdjust',
  HERO_STAGGER: 'dungeo.melee.heroStagger',
  // ... etc
} as const;

// Multiple modules import from single source
import { MELEE_STATE, getBaseOstrength } from '../combat/melee-state';
```

This pattern prevents desync bugs and makes refactoring safer (compile-time errors vs runtime failures).

### Canonical MDL Integration
The diagnose action now uses the canonical `getDiagnosis()` function from melee.ts, which maps `meleeWoundAdjust` to MDL-style wound descriptions:

- `meleeWoundAdjust === 0` → "You have no wounds"
- `meleeWoundAdjust === -1` → "You have a light wound"
- `meleeWoundAdjust === -2` → "You have a serious wound"
- `meleeWoundAdjust <= -3` → "You are in danger of dying"

This ensures combat feedback matches the original Zork experience.

## Thief Fight Plan Progress

| Phase | Status | Description |
|-------|--------|-------------|
| Phase 1 | ✅ COMPLETE | Canonical melee engine (OSTRENGTH tables, stagger, unconscious, wounds) |
| Phase 2 | ✅ COMPLETE | Melee messages (villain attacks, stagger, unconscious, death) |
| Phase 3 | ✅ COMPLETE | Melee interceptor (attack action integration, turn-by-turn combat) |
| Phase 4 | ✅ COMPLETE | Disengagement + healing (flee-and-recover, CURE-CLOCK daemon) |
| Phase 5 | ⏳ PENDING | Thief behavior (WINNING? function, fight/flee AI, roaming) |
| Phase 6 | ⏳ PENDING | DIAGNOSE command verification (canonical text, edge cases) |
| Phase 7 | ⏳ PENDING | Troll integration (canonical tables, disengagement testing) |

## Notes

**Session duration**: ~2 hours

**Approach**: Incremental implementation with transcript testing at each step. Started with disengagement handler (silent villain recovery), added cure daemon (30-turn healing), then updated diagnose action to use canonical melee state. Extracted shared constants last to eliminate duplication across all three modules.

**Platform Changes**: Zero. All changes are story-level (Dungeo combat system).

**Build Performance**: Bundle size 2.1M, load time ~182ms, 9-walkthrough chain completes in ~940ms.

**Pre-existing Issue**: Troll `meleeOstrength` initialization may need investigation (noted in Phase 3). Interceptor ordering with CombatService may cause base strength to override initial value.

---

**Progressive update**: Session completed 2026-02-08 12:59 AM CST
