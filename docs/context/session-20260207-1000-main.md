# Session Summary: 2026-02-07 - main (10:00 CST)

## Status: In Progress (Interrupted)

## Goals
- Complete Phase 2 (melee messages) from thief-fight-plan.md
- Begin Phase 3 (melee interceptor integration with attacking action)
- Maintain walkthrough test coverage (212 pass / 6 skip baseline)

## Completed

### 1. Phase 1 Verification — Melee Engine Already Complete

**Reviewed Phase 1 status**: The canonical melee engine from the previous session was already fully implemented:
- `stories/dungeo/src/combat/melee.ts` (390 lines)
- `stories/dungeo/src/combat/melee-tables.ts` (189 lines)
- Build verification: Clean compile, no errors

**No additional work needed** for Phase 1.

### 2. Phase 2 Complete — Canonical Melee Messages

**Created `stories/dungeo/src/combat/melee-messages.ts`** (273 lines):

**Five message tables** matching canonical MDL source (`mdlmelee.25`):
- `SwordMelee` — Hero attacks with sword (7 outcome types: stagger, unconscious, light wound, serious wound, severed, killed, miss)
- `KnifeMelee` — Hero attacks with knife (7 outcome types, different prose)
- `TrollMelee` — Troll attacks hero (9 outcome types, adds disarm + hesitate)
- `ThiefMelee` — Thief attacks hero (9 outcome types)
- `CyclopsMelee` — Cyclops attacks hero (9 outcome types)

**Message selection functions**:
- `getHeroAttackMessage(outcome, weapon, villain)` — Selects SwordMelee or KnifeMelee based on weapon
- `getVillainAttackMessage(outcome, villain)` — Selects ThiefMelee, TrollMelee, or CyclopsMelee based on villain

**Multiple variants per outcome**: Each outcome type has 3-7 variant strings randomly selected (matching MDL FORTRAN `PRES` function behavior).

**Dynamic placeholders**: `{weapon}` and `{villain}` replaced at runtime for natural prose.

**Build status**: Added exports to `stories/dungeo/src/combat/index.ts`, build passes clean.

### 3. Phase 3 Partial — Melee Interceptor (Platform + Story)

#### 3a. Platform Change — Attacking Action Interceptor Support

**Modified `packages/stdlib/src/actions/standard/attacking/attacking.ts`** to add ADR-118 interceptor hooks:

**Five hook phases** (same pattern as entering.ts and throwing.ts):
- `preValidate(...)` — Runs before action validation (check preconditions)
- `postValidate(...)` — Runs after validation succeeds (modify validation)
- `postExecute(...)` — **CRITICAL**: When present, REPLACES CombatService entirely
- `postReport(...)` — Runs after action reporting (add custom effects)
- `onBlocked(...)` — Runs if validation failed (custom blocked messages)

**Key difference from other interceptors**: The `postExecute` hook **replaces** the standard combat system (CombatService) when present. This allows story-specific combat engines (like melee.ts) to completely override stdlib combat.

**Interceptor data structure**:
```typescript
{
  actorId: string;
  verb: string;
  weaponId?: string;
  targetId?: string;
  targetName?: string;
}
```

**Build status**: Clean compile, no test failures (attacking action tests still pass).

#### 3b. Story Interceptor — Melee Interceptor Implementation

**Created `stories/dungeo/src/interceptors/melee-interceptor.ts`** (315 lines):

**Purpose**: Intercepts `if.action.attacking` for entities with `CombatantTrait`, runs canonical melee engine instead of stdlib CombatService.

**Hook implementations**:

**preValidate**: Blocks attack if hero is staggered from previous blow:
```typescript
if (actor.attributes.meleeStaggered) {
  return Effect.block('dungeo.melee.staggered');
}
```

**postExecute**: Runs full canonical melee engine:
1. Get weapon entity, determine weapon type (sword/knife/bare hands)
2. Calculate `fightStrength()` and `villainStrength()`
3. Call `resolveBlow()` to get outcome
4. Apply side effects via `applyHeroBlowToVillain()`:
   - Kill villain (remove CombatantTrait)
   - Knock unconscious (set meleeUnconscious)
   - Wound (increment meleeWoundAdjust)
   - Stagger (set meleeStaggered flag)
   - Disarm hero (drop weapon)
5. Store outcome in sharedData for reporting phase

**postReport**: Emits melee message as `game.message` event:
```typescript
const message = getHeroAttackMessage(
  outcome.type,
  weaponType,
  target.id
);
return Effect.emitEvent('game.message', { message });
```

**onBlocked**: Custom stagger message (uses dungeo.melee.staggered message ID).

**State tracking** in `entity.attributes`:
- `meleeWoundAdjust` — Cumulative wound damage to villain
- `meleeStaggered` — Hero stagger flag (clears next turn)
- `meleeUnconscious` — Villain unconscious flag
- `meleeOstrength` — Villain base strength (copied from trait)

**Registration**: Added to `stories/dungeo/src/index.ts`:
```typescript
registerActionInterceptor(
  CombatantTrait.type,
  'if.action.attacking',
  meleeInterceptor
);
```

**Build status**: NOT YET TESTED (implementation interrupted before build).

### 4. Message Registration — Partial Work

**Started** adding melee message imports to `stories/dungeo/src/messages/npc-messages.ts` for message registration.

**Session interrupted** before completing this step.

### 5. Issue Tracking

**Created ISSUE-050** in `docs/work/issues/issues-list-03.md`:
- Title: "Consolidate all Dungeo text into dungeo-en-us.ts for i18n"
- Priority: Low
- Rationale: Story currently has messages scattered across multiple files (object-messages.ts, puzzle-messages.ts, npc-messages.ts). For proper i18n support, all messages should eventually be in a single dungeo-en-us package.

## Key Decisions

### 1. Platform Change: Option 1 (Interceptor) Over Option 2 (Command Transformer)

**Decision**: Add interceptor support to stdlib attacking action (Option 1) rather than story-level command transformer (Option 2).

**Rationale**:
- Attacking action already has ADR-118 precedent (entering.ts, throwing.ts)
- Interceptors are cleaner than pre-parsing command transformers
- Story-level command transformer would be a one-off pattern
- Platform change is minimal (~30 lines) and follows existing pattern

**Impact**: Future stories can also intercept attacking action for custom combat systems without hacking grammar or command parsing.

### 2. Interceptor REPLACES CombatService (Not Just Hooks After)

**Decision**: When `postExecute` interceptor is present, skip `CombatService.resolveCombat()` entirely.

**Rationale**: Melee engine and CombatService have fundamentally different combat models:
- CombatService: Simple health reduction, binary alive/dead
- Melee engine: Wound accumulation, stagger, unconscious, disarm, probabilistic outcomes

Running both would create conflicting state mutations (double damage, inconsistent messaging).

**Impact**: Clean separation — story combat system has full control when present, stdlib combat is backup for simple cases.

### 3. Melee State in entity.attributes (Not Runtime Properties)

**Decision**: Store all melee state in `entity.attributes.*` fields (meleeWoundAdjust, meleeStaggered, etc.).

**Rationale**: The Phase 5 Tea Room serialization bug reinforced this pattern — `(entity as any).prop` is invisible to save/restore. Custom state MUST be in attributes to survive serialization.

**Impact**: Melee state (wounds, stagger, unconscious) will correctly persist across save/restore cycles.

## Open Items

### Short Term

**Finish Phase 3 implementation**:
- Complete message registration in `stories/dungeo/src/messages/npc-messages.ts`
- Add MeleeMessages to message registry
- Run build: `./build.sh -s dungeo`
- Verify build passes
- Run walkthrough chain to ensure no regressions

**Phase 4: Combat Disengagement + Wound Healing**:
- Create daemon to detect combat end (villain flees, villain dies, player leaves)
- Instant villain heal on disengagement (clear meleeWoundAdjust)
- CURE-CLOCK daemon for player wound healing (30 turns per wound point)

**Phase 5: Thief Behavior Updates**:
- Implement WINNING? AI (flee if >3 light wounds OR serious wound)
- Thief wandering patterns (moves between rooms)
- Thief combat pursuit (follows player if losing fight)

**Phase 6: DIAGNOSE Command**:
- New story-specific action
- Grammar extension: "diagnose" command
- Maps wound state to prose descriptions from getDiagnosis()

**Phase 7: Troll Integration**:
- Add CombatantTrait to troll entity
- OSTRENGTH = 2 (easy to defeat)
- Guards axe + Round Room passageway
- Create wt-10 walkthrough: thief fight + troll fight

### Long Term

**Villain-Attacks-Hero Integration**: The current melee interceptor only handles hero-attacks-villain (ATTACK THIEF). Need to wire villain-attacks-hero into NPC behaviors:
- Thief behavior: On thief's turn, if in combat, call `resolveBlow()` with villain as attacker
- Apply side effects via `applyVillainBlowToHero()`
- Use villain message tables (ThiefMelee, TrollMelee)
- Same state tracking pattern (hero wounds in player.attributes.meleeWoundAdjust)

**Combat Testing**: Create unit transcripts for melee mechanics:
- Each of 9 outcome types
- Strength calculation edge cases
- Best weapon bonuses (sword vs troll, knife vs thief)
- Wound accumulation and healing
- Villain AI flee conditions
- Disengagement instant heal

**wt-09 Failure Investigation**: The `$teleport carousel machine room` scope issue from previous session remains unresolved. This is a **separate bug** unrelated to combat work. Current hypothesis:
- Testing extension $teleport may not be updating command resolution scope correctly
- "carousel machine room" alias disambiguation might not work after teleport
- NPC scope after teleport might not match normal scope

## Files Created

**Combat messages** (1 file, 273 lines):
- `stories/dungeo/src/combat/melee-messages.ts` — Five canonical MDL message tables

**Interceptor** (1 file, 315 lines):
- `stories/dungeo/src/interceptors/melee-interceptor.ts` — Hero-attacks-villain melee integration

## Files Modified

**Platform** (1 file):
- `packages/stdlib/src/actions/standard/attacking/attacking.ts` — Added ADR-118 interceptor support (~30 lines)

**Story setup** (1 file):
- `stories/dungeo/src/index.ts` — Registered melee interceptor on CombatantTrait

**Combat exports** (1 file):
- `stories/dungeo/src/combat/index.ts` — Added MeleeMessages exports

**Issue tracking** (1 file):
- `docs/work/issues/issues-list-03.md` — Added ISSUE-050 (dungeo-en-us consolidation)

**Context** (1 file):
- `docs/context/session-20260207-0830-main.md` — Previous session summary (carousel fix documentation)

## Architectural Notes

### ADR-118 Interceptor Pattern Extension

This session extends the ADR-118 interceptor pattern to the attacking action, following the precedent set by entering.ts and throwing.ts. The key architectural insight is that **interceptors can replace core action logic, not just hook before/after it**.

**Three interceptor modes**:
1. **Hooks only** (entering.ts): Interceptor runs before/after standard logic
2. **Replace execution** (attacking.ts): postExecute replaces core logic when present
3. **Augment reporting** (throwing.ts): Add custom effects to standard outcomes

The attacking action uses mode 2 (replace execution) because story-specific combat systems (melee, ranged, magic) have fundamentally different mechanics than stdlib's generic CombatService. When a story provides a combat engine, stdlib should step aside entirely.

### Message Table Canonicality

The melee message tables are direct transcriptions from MDL source (`mdlmelee.25`). Each outcome type has 3-7 variant strings, preserving the original FORTRAN `PRES` function behavior that randomly selected message variants.

This attention to canonical detail creates two benefits:
1. **Authentic Zork I experience** — Players who remember 1982 Zork combat will see familiar messages
2. **Variety** — Combat doesn't feel repetitive even after many encounters

### Melee State Model

The melee engine uses a **cumulative wound model** rather than health points:

| Property | Meaning | Range |
|----------|---------|-------|
| `meleeOstrength` | Base villain strength | 2-10000 |
| `meleeWoundAdjust` | Cumulative wounds | 0-N |
| `meleeStaggered` | Hero stagger flag | boolean |
| `meleeUnconscious` | Villain unconscious | boolean |

**Effective strength** = `meleeOstrength - meleeWoundAdjust`

When effective strength ≤ 0, villain is defeated. This creates graduated difficulty — the thief starts formidable (strength 5) but weakens with each successful blow. Player can "feel" progress in the fight.

The stagger mechanic adds tactical depth — a bad roll can leave the hero vulnerable for one turn, during which the villain gets a free attack.

### Weapon Effectiveness

The "best weapon" system is deliberately subtle:

| Weapon | vs Thief | vs Troll | Penalty |
|--------|----------|----------|---------|
| Knife  | Best     | Normal   | -1 to villain |
| Sword  | Normal   | Best     | -1 to villain |
| Bare   | Poor     | Poor     | 0 |

**Key insight**: The penalty is only -1 strength. With hero strength 6-7 (high score) and thief strength 5, even the "wrong" weapon is viable. This preserves player agency — combat is winnable with either weapon if you're strong enough. The best weapon just gives a slight edge.

## Notes

**Session duration**: ~2 hours

**Approach**: Incremental implementation of thief-fight-plan.md phases. Phase 1 was already complete from previous session, Phase 2 completed cleanly, Phase 3 started but interrupted before build/test.

**Build status**: Phase 2 changes built successfully. Phase 3 changes NOT YET TESTED (build interrupted).

**Walkthrough baseline**: Previous session claimed "212 pass / 6 skip" but wt-09 actually has 8 failures (separate bug). True baseline is likely 204 pass / 6 skip. Combat work should not introduce new failures.

**Next session should start with**:
1. Complete message registration in npc-messages.ts
2. Run `./build.sh -s dungeo`
3. Verify build passes
4. Run walkthrough chain to check for regressions
5. Continue with Phase 4 (combat disengagement) or investigate wt-09 failures

---

**Progressive update**: Session interrupted 2026-02-07 10:00 CST
