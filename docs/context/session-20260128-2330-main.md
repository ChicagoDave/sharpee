# Session Summary: 2026-01-28 23:30 - main

## Status: Completed

## Goals
- Migrate a second handler to declarative state machine pattern (ADR-119/120)

## Completed

### Death Penalty Handler → State Machine Migration

Migrated the death penalty handler from imperative event handler to declarative state machine.

**New file**: `stories/dungeo/src/state-machines/death-penalty-machine.ts`

**States**:
- `alive` → initial, no deaths yet
- `one_death` → player died once, -10 pts deducted
- `game_over` → player died twice, -10 pts + game ends (terminal)

**Transitions**: Both triggered by `if.event.player.died` event.

**Design choices**:
- Used `CustomEffect` for scoring service calls (addPoints, death count update) since scoring isn't available declaratively yet
- Scoring service captured via closure in factory function `createDeathPenaltyMachine(scoringService)`
- No entity bindings needed — this machine operates on global game state, not specific entities
- Explicit states (alive/one_death/game_over) replace implicit counter tracking

**Files modified**:
- `stories/dungeo/src/state-machines/death-penalty-machine.ts` — New state machine definition
- `stories/dungeo/src/orchestration/index.ts` — Import + register death penalty machine
- `stories/dungeo/src/orchestration/event-handlers.ts` — Removed old handler registration and import

**Old handler** (`stories/dungeo/src/handlers/death-penalty-handler.ts`) left in place for reference but no longer wired up.

### Test Results
- **Walkthroughs**: 148/148 pass
- **Unit transcripts**: 1290/1333 pass (30 pre-existing failures, 10 expected failures — no new regressions)

## Architectural Notes

### State Machines Without Entity Bindings
The death penalty machine demonstrates that not all state machines need entity bindings. It operates on global scoring state rather than specific world entities. The `register()` call passes no bindings:
```typescript
smRegistry.register(createDeathPenaltyMachine(scoringService));
```

### CustomEffect for Service Dependencies
When state machine effects need services (scoring, scheduler), capture them in closures via the factory function. This maintains the declarative structure while allowing imperative service calls. Future work could add a `ScoreEffect` type to make scoring fully declarative.

## Next Steps
- Migrate additional handlers (reality-altered, rainbow, victory are good next candidates)
- Consider adding `ScoreEffect` type to plugin-state-machine to reduce CustomEffect usage
- Phase 5: Final engine cleanup after all handler migrations
