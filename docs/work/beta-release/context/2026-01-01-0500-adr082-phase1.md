# Work Summary: ADR-082 Typed Event System - Phase 1

**Date:** 2026-01-01 05:00
**Branch:** `beta-release`

## Problem

The monorepo refactor (workspace:* + project references) exposed type safety issues:
- `ISemanticEvent.data` is typed as `unknown`
- Packages accessed `event.data.property` without type assertions
- Build failed in `text-service-template` and `text-service-browser`

Error example:
```
error TS2339: Property 'message' does not exist on type '{}'.
```

## Solution

Created ADR-082: Typed Event System with a central event data registry.

### Files Created

**`packages/core/src/events/event-registry.ts`**
- Central `EventDataRegistry` interface mapping event types to data shapes
- 25+ event data interfaces (query, message, game lifecycle, platform, turn)
- Extensible via TypeScript declaration merging

**`packages/core/src/events/typed-event.ts`**
- `TypedSemanticEvent<T>` - generic event with typed data
- `KnownSemanticEvent` - union of all typed events

**`packages/core/src/events/event-factory.ts`**
- `createTypedEvent()` - type-safe event creation
- `createMessageEvent()` - convenience for message events
- `createEmptyEvent()` - for events with no data

**`packages/core/src/events/event-helpers.ts`**
- `isEventType()` - type guard for narrowing
- `getEventData()` - safe typed data extraction
- `getEventDataWithDefaults()` - with fallback values
- `getUntypedEventData()` - migration path for untyped events

### Packages Fixed

1. **text-service-template** - Full typed approach using `isEventType()`, `getEventData()`, `getEventDataWithDefaults()`

2. **text-service-browser** - Uses `getUntypedEventData()` for gradual migration (many custom event types)

## API Examples

```typescript
// Type-safe event creation
const event = createTypedEvent('query.invalid', {
  message: 'Invalid input',
  hint: 'Try again'
});

// Type guards narrow the type
if (isEventType(event, 'quit.confirmed')) {
  console.log(event.data.finalScore);  // TypeScript knows this exists
}

// Safe data extraction with defaults
const { message, hint } = getEventDataWithDefaults(event, 'query.invalid', {
  message: 'Invalid response.',
  hint: undefined
});

// For untyped events (migration)
const data = getUntypedEventData(event);
if (typeof data.customField === 'string') {
  // Safe access
}
```

## Remaining Phases

- **Phase 2:** Add stdlib action event types to registry
- **Phase 3:** Migrate all `as any` casts to typed helpers
- **Phase 4:** Documentation updates

## Build Status

All 17 packages build successfully.
