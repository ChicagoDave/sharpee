# Work Summary: ADR-080 Grammar Enhancements - Complete

**Date**: 2025-12-31 21:30
**Branch**: `adr-080-grammar-enhancements`
**ADR**: `docs/architecture/adrs/adr-080-raw-text-grammar-slots.md`

## Objective

Complete ADR-080: Grammar Enhancements for Classic IF Patterns, adding support for text slots, multi-object commands, instrument handling, and command chaining.

## All Phases Complete

| Phase | Description | Status |
|-------|-------------|--------|
| Phase 1 | Grammar Builder (SlotType, .text(), .instrument()) | ✅ |
| Phase 2 | Pattern Compiler (:slot... syntax) | ✅ |
| Phase 3 | Grammar Engine (all/but/and, consecutive slots) | ✅ |
| Phase 4 | Command Chaining (period splitting) | ✅ |
| Phase 5 | Parsed Command Structure | ✅ |
| Phase 6 | Action Updates | ✅ |
| Phase 7 | Core Grammar Updates | ✅ |

## Phase 6 Summary (Final Phase)

### Multi-Object Support

Added to these actions with consistent pattern:
- **taking** - `take all`, `take all but X`, `take X and Y`
- **dropping** - `drop all`, `drop all but X`, `drop X and Y`
- **putting** - `put all in/on X`, `put all but Y in X`
- **inserting** - delegates to putting
- **removing** - `remove all from X`, `remove all but Y from X`

Pattern applied to each:
1. `*-types.ts` with `*ItemResult` interface and `multiObjectResults` field
2. `NOTHING_TO_*` message for empty "all" commands
3. Standalone helper functions: validateSingleEntity, validateMultiObject, executeSingleEntity, reportSingleSuccess, reportSingleBlocked
4. Partial success handling (process what works, report what failed)

### Instrument Handling

Added instrument resolution to validation chain:
- `IValidatedCommand.instrument` field in world-model
- `CommandValidator` resolves `parsed.instrument` to entity
- Actions check `context.command.instrument?.entity` first, fall back to `indirectObject`

Actions updated:
- **attacking** - weapon for combat
- **locking** - key for locks
- **unlocking** - key for locks

## Files Changed

### world-model
- `packages/world-model/src/commands/validated-command.ts` - Added instrument field

### stdlib
- `packages/stdlib/src/validation/types.ts` - Added instrument to scopeInfo
- `packages/stdlib/src/validation/command-validator.ts` - Instrument resolution
- `packages/stdlib/src/actions/standard/removing/removing-types.ts` (NEW)
- `packages/stdlib/src/actions/standard/removing/removing-messages.ts`
- `packages/stdlib/src/actions/standard/removing/removing.ts`
- `packages/stdlib/src/actions/standard/attacking/attacking.ts`
- `packages/stdlib/src/actions/standard/attacking/attacking-data.ts`
- `packages/stdlib/src/actions/standard/locking/locking.ts`
- `packages/stdlib/src/actions/standard/unlocking/unlocking.ts`

### docs
- `docs/architecture/adrs/adr-080-raw-text-grammar-slots.md` - Status → Complete
- `docs/design/grammar-table.md` - Added ADR-080 sections

## Test Results

- Parser ADR-080 tests: 28 passed
- Locking/Unlocking: 32 passed
- Removing: 20 passed
- Taking/Dropping/Putting: All pass

## New Capabilities

### For Players
```
> take all
You take the sword, the lamp, and the key.

> drop all but lamp
You drop the sword and the key.

> put all in chest
You put the lamp in the chest.

> remove all from chest
You take the lamp from the chest.

> take sword. go north.
You take the sword.
You go north.
```

### For Story Authors
```typescript
// Text slots for arbitrary input
grammar.define('incant :word1 :word2')
  .text('word1')
  .text('word2')
  .mapsTo('story:incant')
  .build();

// Greedy text capture
grammar.define('say :message...')
  .mapsTo('story:say')
  .build();

// Instrument slots
grammar.define('pry :target with :tool')
  .instrument('tool')
  .mapsTo('story:pry')
  .build();

// Access in action
const tool = context.command.instrument?.entity;
const message = context.command.parsed.textSlots?.get('message');
```
