# Work Summary: ADR-082 Grammar Enhancements Complete

**Date:** 2026-01-02 00:00
**Branch:** vocabulary-slots → merged to main → merged to dungeo
**PR:** https://github.com/ChicagoDave/sharpee/pull/39

## What Was Accomplished

### 1. GrammarVocabularyProvider (if-domain)

Created context-aware vocabulary system for grammar pattern matching:

**File:** `packages/if-domain/src/grammar/vocabulary-provider.ts`

```typescript
interface IGrammarVocabularyProvider {
  define(category: string, config: GrammarVocabularyConfig): void;
  extend(category: string, words: string[]): void;
  match(category: string, word: string, ctx: GrammarContext): boolean;
  getWords(category: string): Set<string>;
  isActive(category: string, ctx: GrammarContext): boolean;
  hasCategory(category: string): boolean;
  getCategories(): string[];
  removeCategory(category: string): boolean;
  clear(): void;
}
```

Key features:
- Named vocabulary categories
- Context predicates (`when` function) for location/state scoping
- Case-insensitive word matching
- Stories can extend categories dynamically

### 2. VOCABULARY Slot Type (parser-en-us)

Added `consumeVocabularySlot()` to `english-grammar-engine.ts`:
- Checks `world.getGrammarVocabularyProvider().match()`
- Only matches when category is active in context
- Returns `category` and `matchedWord` in SlotMatch

Usage:
```typescript
vocab.define('panel-colors', {
  words: ['red', 'yellow', 'mahogany', 'pine'],
  when: (ctx) => ctx.currentLocation === insideMirrorId
});

grammar.define('push :color panel')
  .fromVocabulary('color', 'panel-colors')
  .mapsTo('push_panel')
  .build();
```

### 3. MANNER Slot Type (parser-en-us)

Added `consumeMannerSlot()` with 16 built-in adverbs:
- carefully, quietly, quickly, slowly
- forcefully, gently, loudly, softly
- cautiously, boldly, stealthily, silently
- hastily, deliberately, violently, tenderly

Also checks story-extended manner vocabulary via `vocab.define('manner', {...})`.

Usage:
```typescript
grammar.define(':manner open :target')
  .manner('manner')
  .mapsTo('open')
  .build();

// "carefully open door" → command.manner === 'carefully'
```

### 4. IParsedCommand Extensions (world-model)

Added to `parsed-command.ts`:
```typescript
interface IParsedCommand {
  // ... existing fields
  vocabularySlots?: Map<string, { word: string; category: string }>;
  manner?: string;
}
```

### 5. WorldModel Integration

- Added `grammarVocabularyProvider` private field
- Added `getGrammarVocabularyProvider()` method
- Clears vocabulary on `world.clear()`

### 6. ADR-083: Spirit PC Paradigm

Created design document for "Aspect of God" game concept:
- Non-physical player character (spirit)
- Alternate verb set (COMFORT, EVOKE, STIR, SOOTHE, APPARATE)
- Entity knowledge states (unknown/obscured/known/resonating)
- Emotional/memory layer for NPCs
- "CONSIDERING X, DO Y" grammar pattern

**File:** `docs/architecture/adrs/adr-083-spirit-pc-paradigm.md`

## Files Modified/Created

### if-domain
- `src/grammar/vocabulary-provider.ts` - NEW (253 lines)
- `src/grammar/grammar-builder.ts` - Added SlotType.VOCABULARY, MANNER, SlotMatch fields
- `src/grammar/grammar-engine.ts` - Added builder methods
- `src/grammar/index.ts` - Added export
- `tests/vocabulary-provider.test.ts` - NEW (25 tests)

### parser-en-us
- `src/english-grammar-engine.ts` - Added consumeVocabularySlot, consumeMannerSlot
- `src/english-parser.ts` - Wire vocabularySlots and manner to IParsedCommand
- `tests/adr-080-grammar-enhancements.test.ts` - Added 8 ADR-082 tests

### world-model
- `src/world/WorldModel.ts` - Added grammarVocabularyProvider field and getter
- `src/world/index.ts` - Export Grammar* types
- `src/commands/parsed-command.ts` - Added vocabularySlots, manner fields

### docs
- `docs/architecture/adrs/adr-082-vocabulary-constrained-slots.md` - Revised
- `docs/architecture/adrs/adr-083-spirit-pc-paradigm.md` - NEW

## Test Results

- 25 unit tests for GrammarVocabularyProvider - PASS
- 8 grammar engine tests for VOCABULARY/MANNER - PASS
- All existing parser tests - PASS

## ADR-082 Implementation Status

| Feature | Status |
|---------|--------|
| Text slots (`.text()`) | ✓ Complete |
| Greedy text (`:slot...`) | ✓ Complete |
| Instrument slots | ✓ Complete |
| Multi-object ("take all") | ✓ Complete |
| NUMBER/ORDINAL/TIME/DIRECTION | ✓ Complete |
| QUOTED_TEXT/TOPIC | ✓ Complete |
| GrammarVocabularyProvider | ✓ Complete |
| VOCABULARY slots | ✓ Complete |
| MANNER slots | ✓ Complete |
| Command chaining | Deferred |

## Next Steps

1. Use vocabulary slots for Inside Mirror "push :color panel" pattern
2. Use manner slots for combat/stealth actions if needed
3. Continue endgame implementation (Crypt, Tomb, trivia system)
4. INCANT command still blocked on text slot parser issue

## Key Design Decisions

1. **Named categories over global pools** - Vocabulary is organized by named categories, not generic adjective/noun pools
2. **Context predicates at vocabulary level** - The `when` function scopes vocabulary to locations/states
3. **Parser evaluates context** - Actions don't need to re-check location if pattern matched
4. **Separate from VocabularyRegistry** - GrammarVocabularyProvider is for pattern matching, not entity vocabulary
5. **Built-in manner adverbs** - Common adverbs are built-in, stories can extend
