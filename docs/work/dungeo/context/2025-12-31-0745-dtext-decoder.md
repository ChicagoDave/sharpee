# Dungeon Text Database Decoder - Work Summary

**Date**: 2025-12-31
**Duration**: ~30 minutes
**Result**: Successfully decoded all 1191 messages from Dungeon FORTRAN source

## Problem

The previous session downloaded the Dungeon 3.0A FORTRAN source but couldn't fully decode the text database (dtext.dat). The initial decoder attempt assumed dindx.dat was binary and guessed at the index structure.

## Solution

Analyzed the FORTRAN source more carefully:

1. **Discovered dindx.dat is text format** - FORTRAN I8 format (8-char integers), one per line
2. **Found RTEXT array location** - Starts at line 6425 (0-indexed: 6424)
3. **Decoded the encryption** - Simple XOR with position-dependent key:
   ```javascript
   char[i] = encrypted[i] XOR ((recordNum & 31) + (i + 1))
   ```

4. **Understood record structure**:
   - 80 bytes per record (20 longwords Ã— 4 bytes)
   - Bytes 0-3: Group number (uint32 LE) for continuation detection
   - Bytes 4-79: Encrypted text (76 characters)

## Files Modified

| File | Change |
|------|--------|
| `docs/dungeon-ref/decode-text.js` | Complete rewrite with working decoder |
| `docs/dungeon-ref/dungeon-messages.txt` | Exported all 1191 messages (4282 lines) |
| `docs/work/dungeo/endgame-plan.md` | Added decoder documentation |

## Key Discoveries

### dindx.dat Structure
```
Line 1-3: Version (major=3, minor=0, edit='A')
Line 4-6: MXSCOR=616, STRBIT=210, EGMXSC=100
Line 7+: Room arrays, exit arrays, object arrays...
Line 6423: MBASE=1054
Line 6424: MLNT=1191 (message count)
Line 6425+: RTEXT[1..1191] - record numbers for each message
```

### Trivia Questions (Decoded!)

| Q# | Question | Answer(s) |
|----|----------|-----------|
| 0 | Room to thief's lair without cyclops? | TEMPLE |
| 1 | Where from Altar besides Temple? | FOREST |
| 2 | Minimum zorkmid treasure value? | 30003 |
| 3 | Object for iced cake function? | FLASK |
| 4 | What to do with mirror? | RUB |
| 5 | What offends ghosts? | BONES/BODY/SKELETON |
| 6 | What object is haunted? | RUSTY KNIFE |
| 7 | Is "Hello sailor" useful? | NONE/NOWHERE |

### Inside Mirror Messages (688-700)

Complete description of the box puzzle including:
- Wall colors (mahogany, pine, red, yellow, white, black)
- Pole positions and states
- Compass rose directions

## Usage

```bash
# Export all messages
node docs/dungeon-ref/decode-text.js --export

# Show endgame-related messages
node docs/dungeon-ref/decode-text.js --endgame

# Get specific message by number
node docs/dungeon-ref/decode-text.js 770
```

## Impact

This decoder provides access to all original Dungeon text, enabling:
- Accurate room descriptions for endgame implementation
- Correct trivia questions and answers
- Panel/pole/dial messages for Inside Mirror puzzle
- Victory and defeat messages for proper game feel

## Technical Notes

- dindx.dat uses FORTRAN list-directed I/O with FORMAT(I8)
- Multi-line messages share a group number in dtext.dat
- Negative RTEXT values indicate something internal (absolute value used)
- docs/dungeon-ref/ is gitignored (reference material, not shipped)
